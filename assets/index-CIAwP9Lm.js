var ss=Object.defineProperty;var os=(t,e,n)=>e in t?ss(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var Pa=(t,e,n)=>os(t,typeof e!="symbol"?e+"":e,n);import ls from"leaflet";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();const o={isInitialized:!1,coordsControl:null,lastMouseLatLng:null,landingWindDir:null,cutAwayMarker:null,cutAwayLat:null,cutAwayLng:null,cutAwayCircle:null,isJumperSeparationManual:!1,weatherData:null,lastModelRun:null,gpxLayer:null,gpxPoints:[],isLoadingGpx:!1,isTrackLoaded:!1,liveMarker:null,jumpMasterLine:null,isPlacingHarp:!1,harpMarker:null,watchId:null,prevLat:null,prevLng:null,prevTime:null,livePositionControl:null,lastLatitude:null,lastLongitude:null,lastDeviceAltitude:null,lastAltitudeAccuracy:null,lastAccuracy:null,lastSpeed:"N/A",lastEffectiveWindUnit:"kt",lastDirection:"N/A",lastTerrainAltitude:"N/A",lastSmoothedSpeedMs:0,map:null,baseMaps:{},lastLat:null,lastLng:null,lastAltitude:null,currentMarker:null,isManualPanning:!1,autoupdateInterval:null,accuracyCircle:null,ensembleModelsData:null,selectedEnsembleModels:[],currentEnsembleScenario:"all_models",ensembleLayerGroup:null,ensembleScenarioCircles:{},heatmapLayer:null,ismapInitialized:!1,hasTileErrorSwitched:!1,isCachingCancelled:!1,jumpVisualizationLayerGroup:null,landingPatternLayerGroup:null,jumpRunTrackLayerGroup:null,labelZoomListener:null},cs="skydiver2025",Ia={135:5,130:5,125:5,120:5,115:5,110:5,105:5,100:6,95:7,90:7,85:7,80:8,75:8,70:9,65:10,60:10,55:11,50:12,45:14,40:15,35:17,30:20,25:24,20:30,15:40,10:60,5:119},yi={LIST:["icon_seamless","icon_global","icon_eu","icon_d2","ecmwf_ifs025","ecmwf_aifs025_single","gfs_seamless","gfs_global","gfs_hrrr","arome_france","gem_hrdps_continental","gem_regional"],API_MAP:{icon_seamless:"dwd_icon",icon_global:"dwd_icon",icon_eu:"dwd_icon_eu",icon_d2:"dwd_icon_d2",ecmwf_ifs025:"ecmwf_ifs025",ecmwf_aifs025_single:"ecmwf_aifs025_single",gfs_seamless:"ncep_gfs013",gfs_global:"ncep_gfs025",gfs_hrrr:"ncep_hrrr_conus",arome_france:"meteofrance_arome_france0025",gem_hrdps_continental:"cmc_gem_hrdps",gem_regional:"cmc_gem_rdps"}},ie={METERS_TO_FEET:3.28084,FEET_TO_METERS:.3048,KNOTS_TO_MPS:.514444,KNOTS_TO_KMH:1.852,CELSIUS_TO_KELVIN:273.15},Da={MOLAR_MASS_AIR:.0289644,UNIVERSAL_GAS_CONSTANT:8.31446261815324},rt={LAPSE_RATE:.0065,SEA_LEVEL_TEMP_KELVIN:288.15,GRAVITY:9.80665,GAS_CONSTANT_AIR:287.05},Qt={A_LIQUID:17.27,B_LIQUID:237.7,A_ICE:21.87,B_ICE:265.5},us=6371e3,Na={KNOT_THRESHOLDS:[1,4,7,11,17,22,28,34,41,48,56,64],BEAUFORT_THRESHOLDS:[0,1,3,6,10,16,21,27,33,40,47,55,63]},Rt={FORECAST:"https://api.open-meteo.com/v1/forecast",HISTORICAL:"https://historical-forecast-api.open-meteo.com/v1/forecast"},be={SCENARIO_COLORS:{MIN_WIND:"rgba(0, 0, 255, 0.7)",MEAN_WIND:"rgba(0, 255, 0, 0.7)",MAX_WIND:"rgba(255, 0, 0, 0.7)"},HEATMAP_MIN_RADIUS_PX:5,HEATMAP_MAX_RADIUS_PX:50,HEATMAP_SCALING_BASE:1.42,HEATMAP_BASE_RADIUS:20,HEATMAP_REFERENCE_ZOOM:13},ds=[1e3,950,925,900,850,800,700,600,500,400,300,250,200],Fe=200,An={OPEN:4.1,PARTIALLY:12.8,COLLAPSED:39.2},hs=150,en={DEFAULT_AREA_VERTICAL:.5,DEFAULT_AREA_HORIZONTAL:.5,DEFAULT_MASS_KG:80,DEFAULT_DRAG_COEFFICIENT:1},dt={MIN_TRACK_LENGTH_M:100,MAX_TRACK_LENGTH_M:1e4,MIN_APPROACH_LENGTH_M:100,MAX_APPROACH_LENGTH_M:2e4,APPROACH_TIME_SECONDS:120},Te={MESSAGE_TIMEOUT_MS:3e3,MOBILE_BREAKPOINT_PX:768,DEFAULT_MAP_CENTER:[48.0179,11.1923],DEFAULT_MAP_ZOOM:11,GEOLOCATION_TIMEOUT_MS:2e4,GEOLOCATION_ACCURACY_THRESHOLD_M:100,MIN_ZOOM:11,MAX_ZOOM:14,LANDING_PATTERN_MIN_ZOOM:14},tn={MIN_TIME_DIFF_FOR_SPEED_CALC_S:.5,SPEED_SMOOTHING_LOW:.5,SPEED_SMOOTHING_HIGH:.2,SPEED_SMOOTHING_TRESHOLD:25},Bt={TILE_MAX_AGE_DAYS:7,FETCH_TIMEOUT_MS:15e3,SIZE_LIMIT_MB_WARNING:500},ca={DEFAULT_MARKER:"favicon.ico",CUTAWAY_MARKER:"schere_purple.png",AIRPLANE_MARKER:"airplane_orange.png"},wi=()=>h.getValue("interpStepSelect","select",200),h={FEATURE_PASSWORD:"skydiver2025",defaultSettings:{model:"icon_global",refLevel:"AGL",heightUnit:"m",temperatureUnit:"C",windUnit:"kt",timeZone:"Z",coordFormat:"Decimal",downloadFormat:"HEIDIS",showTable:!1,canopySpeed:20,descentRate:3.5,showLandingPattern:!1,landingDirection:"LL",customLandingDirectionLL:"",customLandingDirectionRR:"",legHeightDownwind:300,legHeightBase:200,legHeightFinal:100,interpStep:"200",lowerLimit:0,upperLimit:3e3,baseMaps:"Esri Street",calculateJump:!0,openingAltitude:1200,exitAltitude:3e3,showJumpRunTrack:!1,showExitArea:!1,showCanopyArea:!1,jumpRunTrackOffset:0,jumpRunTrackForwardOffset:0,aircraftSpeedKt:90,jumperSeparation:5,numberOfJumpers:5,cutAwayAltitude:1e3,cutAwayState:"Partially",trackPosition:!1,showJumpMasterLine:!1,jumpMasterLineTarget:"DIP",harpLat:null,harpLng:null,cacheRadiusKm:10,cacheZoomLevels:[11,12,13,14],autoupdate:!1,selectedEnsembleModels:[],currentEnsembleScenario:"all_models"},state:{userSettings:null,unlockedFeatures:{landingPattern:!1,calculateJump:!1},isJumperSeparationManual:!1,isLandingPatternUnlocked:!1,isCalculateJumpUnlocked:!1},initialize(){let t={},e={landingPattern:!1,calculateJump:!1};try{const a=localStorage.getItem("upperWindsSettings");a?(t=JSON.parse(a),console.log("Loaded settings from localStorage:",t)):console.log("No settings found in localStorage, using defaults")}catch(a){this.handleError(a,"Failed to load settings. Using defaults.")}try{const a=localStorage.getItem("unlockedFeatures");a?(e=JSON.parse(a),console.log("Loaded unlocked features from localStorage:",e)):console.log("No unlocked features found in localStorage, using defaults")}catch(a){this.handleError(a,"Failed to load unlocked features. Using defaults.")}this.state.userSettings={...this.defaultSettings,...t},console.log("Initialized userSettings:",this.state.userSettings),this.state.userSettings.harpLat=null,this.state.userSettings.harpLng=null,console.log("Reset HARP coordinates to null at startup"),this.state.userSettings.jumpMasterLineTarget==="HARP"&&(console.log("Reset jumpMasterLineTarget to DIP due to cleared HARP coordinates"),this.state.userSettings.jumpMasterLineTarget="DIP"),this.state.userSettings.selectedEnsembleModels=[...this.defaultSettings.selectedEnsembleModels],this.state.userSettings.currentEnsembleScenario=this.defaultSettings.currentEnsembleScenario,this.state.unlockedFeatures={landingPattern:e.landingPattern||!1,calculateJump:e.calculateJump||!1},["OpenStreetMap","OpenTopoMap","Esri Satellite","Esri Street","Esri Topo","Esri Satellite + OSM"].includes(this.state.userSettings.baseMaps)||(console.warn(`Invalid baseMaps setting: ${this.state.userSettings.baseMaps}, resetting to default`),this.state.userSettings.baseMaps=this.defaultSettings.baseMaps)},save(){const t={...this.state.userSettings};delete t.customJumpRunDirection;try{localStorage.setItem("upperWindsSettings",JSON.stringify(t)),console.log("Settings saved to localStorage:",t)}catch(e){console.error("Failed to save settings to localStorage:",e)}},saveUnlockStatus(t,e){try{t==="landingPattern"?(this.state.unlockedFeatures.landingPattern=e,this.state.isLandingPatternUnlocked=e):t==="calculateJump"&&(this.state.unlockedFeatures.calculateJump=e,this.state.isCalculateJumpUnlocked=e),this.saveUnlockedFeatures(),console.log("Saved unlock status:",{landingPattern:this.state.isLandingPatternUnlocked,calculateJump:this.state.isCalculateJumpUnlocked})}catch{Utils.handleError("Failed to save unlock status.")}},showPasswordModal(t,e,n){console.log("Entering showPasswordModal for feature:",t);const a=document.getElementById("passwordModal"),i=document.getElementById("passwordInput"),s=document.getElementById("passwordError"),r=document.getElementById("passwordSubmit"),l=document.getElementById("passwordCancel"),c=document.getElementById("modalHeader"),u=document.getElementById("modalMessage");if(!a||!i||!r||!l||!c||!u){console.error("Modal elements not found:",{modal:a,input:i,submitBtn:r,cancelBtn:l,header:c,message:u});return}const d=t==="landingPattern"?"Landing Pattern":"Calculate Jump";c.textContent=`${d} Access`,u.textContent=`Please enter the password to enable ${d.toLowerCase()}:`,i.value="",s.style.display="none",a.style.display="flex",console.log("Password modal should now be visible:",{modalDisplay:a.style.display});const m=()=>{if(console.log("Password modal submit clicked, entered value:",i.value),i.value===cs){if(a.style.display="none",this.saveUnlockStatus(t,!0),t==="landingPattern"){const p=document.getElementById("showLandingPattern");p&&(p.style.opacity="1",p.title="")}else if(t==="calculateJump"){const p=document.querySelector('.menu-label[data-label="calculateJump"]');p&&(p.style.opacity="1",p.title="")}console.log("Feature unlocked:",t),e()}else s.textContent="Incorrect password",s.style.display="block",console.log("Incorrect password entered")};r.onclick=m,i.onkeypress=p=>{p.key==="Enter"&&m()},l.onclick=()=>{a.style.display="none",console.log("Password modal cancelled"),n()}},saveUnlockedFeatures(){try{const t=JSON.stringify(this.state.unlockedFeatures);localStorage.setItem("unlockedFeatures",t),console.log("Unlocked features saved:",JSON.parse(t))}catch(t){this.handleError(t,"Failed to save unlocked features to localStorage.")}},getValue(t,e="radio",n){const a=e==="radio"?`input[name="${t}"]:checked`:`#${t}`,i=document.querySelector(a);if(!i)return console.warn(`Setting element not found: ${a}`),n;const s=i.value;return console.log(`Retrieved setting ${t}: ${s}`),s},updateUnitLabels(){const t=this.getValue("heightUnit","radio","m"),e=this.getValue("windUnit","radio","kt"),n=this.getValue("refLevel","radio","AGL"),a=document.querySelector('#controls-row label[for="interpStepSelect"]');a&&(a.textContent=`Step (${t}):`,console.log(`Updated step label to: Step (${t})`));const i=document.querySelector('label[for="lowerLimit"]'),s=document.querySelector('label[for="upperLimit"]');i&&(i.textContent=`Lower Limit (${t}):`,console.log(`Updated lower limit label to: Lower Limit (${t})`)),s&&(s.textContent=`Upper Limit (${t}):`,console.log(`Updated upper limit label to: Upper Limit (${t})`));const r=document.getElementById("meanWindResult");if(r!=null&&r.innerHTML){let l=r.innerHTML;const c=/\((\d+)-(\d+) m\b[^)]*\)/;if(c.test(l)){const[d,m,p]=l.match(c),f=this.convertHeight(parseFloat(m),t),y=this.convertHeight(parseFloat(p),t);l=l.replace(c,`(${Math.round(f)}-${Math.round(y)} ${t} ${n})`),console.log(`Updated mean wind height: (${Math.round(f)}-${Math.round(y)} ${t} ${n})`)}const u=/: (\d+(?:\.\d+)?)\s*([a-zA-Z\/]+)$/;if(u.test(l)){const[d,m,p]=l.match(u),f=parseFloat(m);if(!isNaN(f)){const y=this.convertWind(f,e,p),v=y==="N/A"?"N/A":e==="bft"?Math.round(y):y.toFixed(1);l=l.replace(u,`: ${v} ${e}`),console.log(`Updated mean wind speed: ${v} ${e}`)}}r.innerHTML=l}},updateModelRunInfo(t,e,n){const a=document.getElementById("modelLabel"),i=document.getElementById("modelSelect");if(!a||!i){console.warn("Model run info elements missing:",{modelLabel:a,modelSelect:i,lastModelRun:t,lastLat:e,lastLng:n});return}if(!t){console.log("lastModelRun is falsy, setting default model run info:",{lastModelRun:t,lastLat:e,lastLng:n}),a.title=`Model: ${i.value.replace("_"," ").toUpperCase()}
Run: Not available`;return}const s=i.value,r=`Model: ${s.replace("_"," ").toUpperCase()}
Run: ${t}`;a.title=r,console.log(`Updated model run info: ${r}`,{lastModelRun:t,model:s,lastLat:e,lastLng:n})},handleError(t,e="An error occurred. Please try again."){console.error("Settings Error:",t),Utils.handleError(e)},convertHeight(t,e){return isNaN(t)?t:e==="ft"?t*3.28084:t},convertWind(t,e,n){var i,s;return isNaN(t)?"N/A":((s=(i={kt:{"m/s":r=>r*.514444,"km/h":r=>r*1.852,mph:r=>r*1.15078,bft:r=>this.ktToBeaufort(r)},"m/s":{kt:r=>r/.514444,"km/h":r=>r*3.6,mph:r=>r*2.23694,bft:r=>this.ktToBeaufort(r/.514444)}}[n])==null?void 0:i[e])==null?void 0:s.call(i,t))||t},ktToBeaufort(t){return t<1?0:t<=3?1:t<=6?2:t<=10?3:t<=16?4:t<=21?5:t<=27?6:t<=33?7:t<=40?8:t<=47?9:t<=55?10:t<=63?11:12},isFeatureUnlocked(t){return!!this.state.unlockedFeatures[t]}};function _i(t){const e=h.state.userSettings.exitAltitude*ie.METERS_TO_FEET,n=g.calculateTAS(t,e);if(n==="N/A")return console.warn("TAS calculation failed, using default separation"),h.defaultSettings.jumperSeparation;const a=Object.keys(Ia).map(Number).sort((r,l)=>l-r);let i=a[0];for(const r of a)if(n<=r)i=r;else break;return Ia[i]||7}function vi(t,e,n,a,i,s,r){if(!t||!t.time||!a||a.length===0||!Number.isFinite(i)||!Number.isFinite(s)||!Number.isFinite(r))return null;const l=r+e,c=r+n-Fe,u=_n(a),d=u?u.direction:0,m=h.state.userSettings.aircraftSpeedKt,p=e/.3048,f=g.calculateTAS(m,p);let y=f==="N/A"?m*ie.KNOTS_TO_MPS:f*ie.KNOTS_TO_MPS;const v=Math.cos(d*Math.PI/180)*y,w=Math.sin(d*Math.PI/180)*y,_=a.map(P=>P.height),M=a.map(P=>Number.isFinite(P.dir)?parseFloat(P.dir):0),b=a.map(P=>g.convertWind(parseFloat(P.spd)||0,"m/s","km/h")),S=a.map(P=>P.temp),T=[{time:0,height:l,vz:0,vxGround:v,vyGround:w,x:0,y:0}],E=t.surface_pressure[0]||1013.25;let k=T[0];for(;k.height>c;){const P=g.linearInterpolate(_,M,k.height),I=g.linearInterpolate(_,b,k.height),U=g.linearInterpolate(_,S,k.height)+ie.CELSIUS_TO_KELVIN,q=rt.GAS_CONSTANT_AIR,R=.5,te=E*100*Math.exp(-9.80665*(k.height-r)/(q*U))/(q*U),ne=(P+180)%360,K=I*Math.cos(ne*Math.PI/180),de=I*Math.sin(ne*Math.PI/180),J=k.vxGround-K,fe=k.vyGround-de,Ce=Math.sqrt(J*J+fe*fe),Be=1,Y=en.DEFAULT_AREA_VERTICAL,B=en.DEFAULT_MASS_KG,X=en.DEFAULT_DRAG_COEFFICIENT,G=en.DEFAULT_AREA_HORIZONTAL,ge=.5*Be*Y*te/B,Ae=.5*X*G*te/B,_e=-9.80665-ge*k.vz*Math.abs(k.vz),tt=-Ae*Ce*J,$e=-Ae*Ce*fe;let le=k.height+k.vz*R,ve=k.vz+_e*R,Ge=k.time+R;if(le<=c){const qt=(k.height-c)/(k.height-le);Ge=k.time+R*qt,le=c,ve=k.vz+_e*R*qt}const Ct={time:Ge,height:le,vz:ve,vxGround:v===0?K:k.vxGround+tt*R,vyGround:w===0?de:k.vyGround+$e*R,x:k.x+(v===0?K:k.vxGround)*R,y:k.y+(w===0?de:k.vyGround)*R};if(T.push(Ct),k=Ct,Ct.height===c)break}const C=T[T.length-1],N=Math.sqrt(C.x*C.x+C.y*C.y);let F=Math.atan2(C.y,C.x)*180/Math.PI;return F=(F+360)%360,{time:C.time,distance:N,directionDeg:F,path:T.map(P=>({latLng:g.calculateNewCenter(i,s,Math.sqrt(P.x*P.x+P.y*P.y),Math.atan2(P.y,P.x)*180/Math.PI),height:P.height,time:P.time}))}}function Li(t){var N,F,P,I,x;if(!h.state.userSettings.showExitArea||!h.state.userSettings.calculateJump||!o.weatherData||!o.lastLat||!o.lastLng||!t||t.length===0)return null;const e=parseInt((N=document.getElementById("exitAltitude"))==null?void 0:N.value)||3e3,n=parseInt((F=document.getElementById("openingAltitude"))==null?void 0:F.value)||1200,a=parseInt((P=document.getElementById("legHeightDownwind"))==null?void 0:P.value)||300,i=parseFloat((I=document.getElementById("descentRate"))==null?void 0:I.value)||3.5,s=(parseFloat((x=document.getElementById("canopySpeed"))==null?void 0:x.value)||20)*ie.KNOTS_TO_MPS,r=t.map(U=>U.height),l=t.map(U=>-g.convertWind(U.spd,"m/s","km/h")*Math.sin(U.dir*Math.PI/180)),c=t.map(U=>-g.convertWind(U.spd,"m/s","km/h")*Math.cos(U.dir*Math.PI/180)),u=Math.round(o.lastAltitude),d=(n-Fe-a)/i,m=d*s,p=(n-Fe)/i,f=p*s,y=g.calculateMeanWind(r,l,c,u+a,u+n-Fe),v=g.calculateMeanWind(r,l,c,u,u+n-Fe),w=Mi(o.lastLat,o.lastLng,t);let{downwindLat:_,downwindLng:M}=w;Number.isFinite(_)||(_=o.lastLat,M=o.lastLng);const b=g.calculateNewCenter(_,M,y[1]*d,y[0]),S=g.calculateNewCenter(o.lastLat,o.lastLng,v[1]*p,v[0]),T=vi(o.weatherData,e,n,t,o.lastLat,o.lastLng,u);if(!T)return null;const E=(T.directionDeg+180)%360,k=g.calculateNewCenter(S[0],S[1],T.distance,E),C=g.calculateNewCenter(b[0],b[1],T.distance,E);return{greenLat:k[0],greenLng:k[1],darkGreenLat:C[0],darkGreenLng:C[1],greenRadius:f,darkGreenRadius:m,freeFallDirection:T.directionDeg,freeFallDistance:T.distance,freeFallTime:T.time}}function Ue(t){if(!o.map||o.cutAwayLat===null||o.cutAwayLng===null||!o.weatherData||o.lastAltitude==="N/A"||!t||t.length===0)return null;const e=Math.round(o.lastAltitude),n=h.state.userSettings.cutAwayAltitude,a=e,i=e+n,s=t.map(S=>S.height),r=t.map(S=>-g.convertWind(S.spd,"m/s","km/h")*Math.sin(S.dir*Math.PI/180)),l=t.map(S=>-g.convertWind(S.spd,"m/s","km/h")*Math.cos(S.dir*Math.PI/180)),c=g.calculateMeanWind(s,r,l,a,i);if(!c)return null;const[u,d]=c,m={Open:An.OPEN,Partially:An.PARTIALLY,Collapsed:An.COLLAPSED},p=m[h.state.userSettings.cutAwayState]||m.Partially,f=n/p,y=d*f,v=(u+180)%360,[w,_]=g.calculateNewCenter(o.cutAwayLat,o.cutAwayLng,y,v),b=`<b>Cut-Away (${h.state.userSettings.cutAwayState.replace(/([A-Z])/g," $1").trim()})</b><br>Cut-Away Altitude: ${n} m<br>Displacement: ${u.toFixed(0)}°, ${y.toFixed(0)} m<br>Descent Time/Speed: ${f.toFixed(0)} s at ${p.toFixed(1)} m/s<br>`;return{center:[w,_],radius:hs,tooltipContent:b}}function ms(t){var P,I,x,U,q;if(!h.state.userSettings.showCanopyArea||!h.state.userSettings.calculateJump||!o.weatherData||!o.lastLat||!o.lastLng||!t||t.length===0)return null;const e=parseInt((P=document.getElementById("exitAltitude"))==null?void 0:P.value)||3e3,n=parseInt((I=document.getElementById("openingAltitude"))==null?void 0:I.value)||1200,a=parseInt((x=document.getElementById("legHeightDownwind"))==null?void 0:x.value)||300,i=parseFloat((U=document.getElementById("descentRate"))==null?void 0:U.value)||3.5,s=(parseFloat((q=document.getElementById("canopySpeed"))==null?void 0:q.value)||20)*ie.KNOTS_TO_MPS,r=t.map(R=>R.height),l=t.map(R=>-g.convertWind(R.spd,"m/s","km/h")*Math.sin(R.dir*Math.PI/180)),c=t.map(R=>-g.convertWind(R.spd,"m/s","km/h")*Math.cos(R.dir*Math.PI/180)),u=Math.round(o.lastAltitude),d=(n-Fe-a)/i,m=d*s,p=(n-Fe)/i,f=p*s,y=g.calculateMeanWind(r,l,c,u+a,u+n-Fe),v=g.calculateMeanWind(r,l,c,u,u+n-Fe),w=vi(o.weatherData,e,n,t,o.lastLat,o.lastLng,u);if(!w)return null;const _=Mi(o.lastLat,o.lastLng,t);let{downwindLat:M,downwindLng:b}=_;Number.isFinite(M)||(M=o.lastLat,b=o.lastLng);const S=u+n-Fe,T=u+a,E=[],k=[],C=[],N=[];let F=S-T<=1e3?200:500;for(let R=S;R>=T+200;R-=F){const te=(R-T)/i,ne=te*s;if(ne>0){const K=g.calculateMeanWind(r,l,c,T,R);E.push(ne),k.push(K[1]*te),C.push(K[0]),N.push(R-u)}}return{blueLat:M,blueLng:b,redLat:o.lastLat,redLng:o.lastLng,radius:m,radiusFull:f,additionalBlueRadii:E,additionalBlueDisplacements:k,additionalBlueDirections:C,additionalBlueUpperLimits:N,displacement:y[1]*d,direction:y[0],displacementFull:v[1]*p,directionFull:v[0],meanWindForFullCanopyDir:v[0],meanWindForFullCanopySpeedMps:v[1],freeFallDirection:w.directionDeg,freeFallDistance:w.distance,freeFallTime:w.time}}function _n(t){var F,P;if(!o.weatherData||!o.lastLat||!o.lastLng||o.lastAltitude==="N/A"||!t||t.length===0)return null;const e=parseInt((F=document.getElementById("openingAltitude"))==null?void 0:F.value)||1e3,n=Math.round(o.lastAltitude),a=t.map(I=>I.height),i=t.map(I=>-g.convertWind(I.spd,"m/s","km/h")*Math.sin(I.dir*Math.PI/180)),s=t.map(I=>-g.convertWind(I.spd,"m/s","km/h")*Math.cos(I.dir*Math.PI/180)),r=g.calculateMeanWind(a,i,s,n,n+e);if(!r)return null;let l=Math.round(r[0]);const c=parseFloat(h.state.userSettings.customJumpRunDirection);Number.isFinite(c)&&c>=0&&c<=359&&(l=c);const u=parseInt((P=document.getElementById("exitAltitude"))==null?void 0:P.value)||3e3,d=n+u,m=g.calculateTAS(h.state.userSettings.aircraftSpeedKt||90,d/.3048);let p=null,f=2e3,y=2e3,v=null;if(m!=="N/A"&&Number.isFinite(m)){const I=g.linearInterpolate(a.map(J=>J-n),t.map(J=>J.dir),u),x=g.linearInterpolate(a.map(J=>J-n),t.map(J=>g.convertWind(J.spd,"m/s","km/h")),u),U=m*ie.KNOTS_TO_MPS,q=(I+180)*Math.PI/180,R=x*Math.sin(q),te=x*Math.cos(q),ne=l*Math.PI/180,K=U*Math.sin(ne),de=U*Math.cos(ne);p=Math.sqrt(Math.pow(K+R,2)+Math.pow(de+te,2)),f=Math.max(dt.MIN_TRACK_LENGTH_M,Math.min(dt.MAX_TRACK_LENGTH_M,Math.round((h.state.userSettings.numberOfJumpers||10)*(h.state.userSettings.jumperSeparation||5)*p))),y=Math.max(dt.MIN_APPROACH_LENGTH_M,Math.min(dt.MAX_APPROACH_LENGTH_M,Math.round(p*dt.APPROACH_TIME_SECONDS)))}const w=h.state.userSettings.jumpRunTrackOffset||0,_=h.state.userSettings.jumpRunTrackForwardOffset||0,M=(Math.atan2(w,_)*180/Math.PI+360)%360,b=Math.sqrt(w**2+_**2),S=(l+M+360)%360,[T,E]=g.calculateNewCenter(o.lastLat,o.lastLng,b,S),k=f/2,C=g.calculateNewCenter(T,E,k,(l+180)%360),N=g.calculateNewCenter(T,E,k,l);if(p){const I=g.calculateNewCenter(C[0],C[1],y,(l+180)%360);v=[C,I]}return{direction:l,trackLength:f,meanWindDirection:r[0],meanWindSpeed:r[1],latlngs:[C,N],approachLatLngs:v,approachLength:y,approachTime:dt.APPROACH_TIME_SECONDS}}function Mi(t,e,n){var P,I;if(!n||n.length===0)return{downwindLat:t,downwindLng:e};const a=parseInt(document.getElementById("canopySpeed").value)||20,i=parseFloat(document.getElementById("descentRate").value)||3.5,s=parseInt(document.getElementById("legHeightFinal").value)||100,r=parseInt(document.getElementById("legHeightBase").value)||200,l=parseInt(document.getElementById("legHeightDownwind").value)||300,c=Math.round(o.lastAltitude),u=n.map(x=>x.height),d=n.map(x=>-g.convertWind(x.spd,"kt","km/h")*Math.sin(x.dir*Math.PI/180)),m=n.map(x=>-g.convertWind(x.spd,"kt","km/h")*Math.cos(x.dir*Math.PI/180)),p=((P=document.querySelector('input[name="landingDirection"]:checked'))==null?void 0:P.value)||"LL",f=parseInt((I=document.getElementById(p==="LL"?"customLandingDirectionLL":"customLandingDirectionRR"))==null?void 0:I.value,10);let y=Number.isFinite(f)?f:Number.isFinite(o.landingWindDir)?o.landingWindDir:n[0].dir;const v=(x,U,q,R,te)=>{const K=R*ie.KNOTS_TO_MPS*te,[de,J]=g.calculateNewCenter(x,U,K,q);return[de,J]},w=g.calculateMeanWind(u,d,m,c,c+s),_=(y+180)%360,M=g.calculateGroundSpeed(a,g.calculateWindComponents(w[1],g.calculateWindAngle(_,w[0])).headwind),b=v(t,e,_,M,s/i),S=g.calculateMeanWind(u,d,m,c+s,c+r),T=(y+(p==="LL"?90:-90)+360)%360,E=g.calculateCourseFromHeading(T,S[0],S[1],a),k=v(b[0],b[1],(E.trueCourse+180)%360,E.groundSpeed,(r-s)/i),C=g.calculateMeanWind(u,d,m,c+r,c+l),N=g.calculateGroundSpeed(a,g.calculateWindComponents(C[1],g.calculateWindAngle(y,C[0])).headwind),F=v(k[0],k[1],y,N,(l-r)/i);return{downwindLat:F[0],downwindLng:F[1]}}class lt extends Error{}class ps extends lt{constructor(e){super(`Invalid DateTime: ${e.toMessage()}`)}}class fs extends lt{constructor(e){super(`Invalid Interval: ${e.toMessage()}`)}}class gs extends lt{constructor(e){super(`Invalid Duration: ${e.toMessage()}`)}}class yt extends lt{}class Si extends lt{constructor(e){super(`Invalid unit ${e}`)}}class re extends lt{}class Ze extends lt{constructor(){super("Zone is an abstract class")}}const A="numeric",Ne="short",ye="long",mn={year:A,month:A,day:A},bi={year:A,month:Ne,day:A},ys={year:A,month:Ne,day:A,weekday:Ne},Ti={year:A,month:ye,day:A},ki={year:A,month:ye,day:A,weekday:ye},Ei={hour:A,minute:A},Ci={hour:A,minute:A,second:A},Ai={hour:A,minute:A,second:A,timeZoneName:Ne},Pi={hour:A,minute:A,second:A,timeZoneName:ye},Ii={hour:A,minute:A,hourCycle:"h23"},Di={hour:A,minute:A,second:A,hourCycle:"h23"},Ni={hour:A,minute:A,second:A,hourCycle:"h23",timeZoneName:Ne},Fi={hour:A,minute:A,second:A,hourCycle:"h23",timeZoneName:ye},xi={year:A,month:A,day:A,hour:A,minute:A},Oi={year:A,month:A,day:A,hour:A,minute:A,second:A},$i={year:A,month:Ne,day:A,hour:A,minute:A},Ri={year:A,month:Ne,day:A,hour:A,minute:A,second:A},ws={year:A,month:Ne,day:A,weekday:Ne,hour:A,minute:A},Ui={year:A,month:ye,day:A,hour:A,minute:A,timeZoneName:Ne},Hi={year:A,month:ye,day:A,hour:A,minute:A,second:A,timeZoneName:Ne},Wi={year:A,month:ye,day:A,weekday:ye,hour:A,minute:A,timeZoneName:ye},zi={year:A,month:ye,day:A,weekday:ye,hour:A,minute:A,second:A,timeZoneName:ye};class Gt{get type(){throw new Ze}get name(){throw new Ze}get ianaName(){return this.name}get isUniversal(){throw new Ze}offsetName(e,n){throw new Ze}formatOffset(e,n){throw new Ze}offset(e){throw new Ze}equals(e){throw new Ze}get isValid(){throw new Ze}}let Pn=null;class vn extends Gt{static get instance(){return Pn===null&&(Pn=new vn),Pn}get type(){return"system"}get name(){return new Intl.DateTimeFormat().resolvedOptions().timeZone}get isUniversal(){return!1}offsetName(e,{format:n,locale:a}){return Qi(e,n,a)}formatOffset(e,n){return $t(this.offset(e),n)}offset(e){return-new Date(e).getTimezoneOffset()}equals(e){return e.type==="system"}get isValid(){return!0}}const Zn=new Map;function _s(t){let e=Zn.get(t);return e===void 0&&(e=new Intl.DateTimeFormat("en-US",{hour12:!1,timeZone:t,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",era:"short"}),Zn.set(t,e)),e}const vs={year:0,month:1,day:2,era:3,hour:4,minute:5,second:6};function Ls(t,e){const n=t.format(e).replace(/\u200E/g,""),a=/(\d+)\/(\d+)\/(\d+) (AD|BC),? (\d+):(\d+):(\d+)/.exec(n),[,i,s,r,l,c,u,d]=a;return[r,i,s,l,c,u,d]}function Ms(t,e){const n=t.formatToParts(e),a=[];for(let i=0;i<n.length;i++){const{type:s,value:r}=n[i],l=vs[s];s==="era"?a[l]=r:O(l)||(a[l]=parseInt(r,10))}return a}const In=new Map;class ze extends Gt{static create(e){let n=In.get(e);return n===void 0&&In.set(e,n=new ze(e)),n}static resetCache(){In.clear(),Zn.clear()}static isValidSpecifier(e){return this.isValidZone(e)}static isValidZone(e){if(!e)return!1;try{return new Intl.DateTimeFormat("en-US",{timeZone:e}).format(),!0}catch{return!1}}constructor(e){super(),this.zoneName=e,this.valid=ze.isValidZone(e)}get type(){return"iana"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(e,{format:n,locale:a}){return Qi(e,n,a,this.name)}formatOffset(e,n){return $t(this.offset(e),n)}offset(e){if(!this.valid)return NaN;const n=new Date(e);if(isNaN(n))return NaN;const a=_s(this.name);let[i,s,r,l,c,u,d]=a.formatToParts?Ms(a,n):Ls(a,n);l==="BC"&&(i=-Math.abs(i)+1);const p=Mn({year:i,month:s,day:r,hour:c===24?0:c,minute:u,second:d,millisecond:0});let f=+n;const y=f%1e3;return f-=y>=0?y:1e3+y,(p-f)/(60*1e3)}equals(e){return e.type==="iana"&&e.name===this.name}get isValid(){return this.valid}}let Fa={};function Ss(t,e={}){const n=JSON.stringify([t,e]);let a=Fa[n];return a||(a=new Intl.ListFormat(t,e),Fa[n]=a),a}const jn=new Map;function qn(t,e={}){const n=JSON.stringify([t,e]);let a=jn.get(n);return a===void 0&&(a=new Intl.DateTimeFormat(t,e),jn.set(n,a)),a}const Kn=new Map;function bs(t,e={}){const n=JSON.stringify([t,e]);let a=Kn.get(n);return a===void 0&&(a=new Intl.NumberFormat(t,e),Kn.set(n,a)),a}const Yn=new Map;function Ts(t,e={}){const{base:n,...a}=e,i=JSON.stringify([t,a]);let s=Yn.get(i);return s===void 0&&(s=new Intl.RelativeTimeFormat(t,e),Yn.set(i,s)),s}let Dt=null;function ks(){return Dt||(Dt=new Intl.DateTimeFormat().resolvedOptions().locale,Dt)}const Xn=new Map;function Bi(t){let e=Xn.get(t);return e===void 0&&(e=new Intl.DateTimeFormat(t).resolvedOptions(),Xn.set(t,e)),e}const Qn=new Map;function Es(t){let e=Qn.get(t);if(!e){const n=new Intl.Locale(t);e="getWeekInfo"in n?n.getWeekInfo():n.weekInfo,"minimalDays"in e||(e={...Gi,...e}),Qn.set(t,e)}return e}function Cs(t){const e=t.indexOf("-x-");e!==-1&&(t=t.substring(0,e));const n=t.indexOf("-u-");if(n===-1)return[t];{let a,i;try{a=qn(t).resolvedOptions(),i=t}catch{const c=t.substring(0,n);a=qn(c).resolvedOptions(),i=c}const{numberingSystem:s,calendar:r}=a;return[i,s,r]}}function As(t,e,n){return(n||e)&&(t.includes("-u-")||(t+="-u"),n&&(t+=`-ca-${n}`),e&&(t+=`-nu-${e}`)),t}function Ps(t){const e=[];for(let n=1;n<=12;n++){const a=D.utc(2009,n,1);e.push(t(a))}return e}function Is(t){const e=[];for(let n=1;n<=7;n++){const a=D.utc(2016,11,13+n);e.push(t(a))}return e}function nn(t,e,n,a){const i=t.listingMode();return i==="error"?null:i==="en"?n(e):a(e)}function Ds(t){return t.numberingSystem&&t.numberingSystem!=="latn"?!1:t.numberingSystem==="latn"||!t.locale||t.locale.startsWith("en")||Bi(t.locale).numberingSystem==="latn"}class Ns{constructor(e,n,a){this.padTo=a.padTo||0,this.floor=a.floor||!1;const{padTo:i,floor:s,...r}=a;if(!n||Object.keys(r).length>0){const l={useGrouping:!1,...a};a.padTo>0&&(l.minimumIntegerDigits=a.padTo),this.inf=bs(e,l)}}format(e){if(this.inf){const n=this.floor?Math.floor(e):e;return this.inf.format(n)}else{const n=this.floor?Math.floor(e):pa(e,3);return Q(n,this.padTo)}}}class Fs{constructor(e,n,a){this.opts=a,this.originalZone=void 0;let i;if(this.opts.timeZone)this.dt=e;else if(e.zone.type==="fixed"){const r=-1*(e.offset/60),l=r>=0?`Etc/GMT+${r}`:`Etc/GMT${r}`;e.offset!==0&&ze.create(l).valid?(i=l,this.dt=e):(i="UTC",this.dt=e.offset===0?e:e.setZone("UTC").plus({minutes:e.offset}),this.originalZone=e.zone)}else e.zone.type==="system"?this.dt=e:e.zone.type==="iana"?(this.dt=e,i=e.zone.name):(i="UTC",this.dt=e.setZone("UTC").plus({minutes:e.offset}),this.originalZone=e.zone);const s={...this.opts};s.timeZone=s.timeZone||i,this.dtf=qn(n,s)}format(){return this.originalZone?this.formatToParts().map(({value:e})=>e).join(""):this.dtf.format(this.dt.toJSDate())}formatToParts(){const e=this.dtf.formatToParts(this.dt.toJSDate());return this.originalZone?e.map(n=>{if(n.type==="timeZoneName"){const a=this.originalZone.offsetName(this.dt.ts,{locale:this.dt.locale,format:this.opts.timeZoneName});return{...n,value:a}}else return n}):e}resolvedOptions(){return this.dtf.resolvedOptions()}}class xs{constructor(e,n,a){this.opts={style:"long",...a},!n&&Yi()&&(this.rtf=Ts(e,a))}format(e,n){return this.rtf?this.rtf.format(e,n):ao(n,e,this.opts.numeric,this.opts.style!=="long")}formatToParts(e,n){return this.rtf?this.rtf.formatToParts(e,n):[]}}const Gi={firstDay:1,minimalDays:4,weekend:[6,7]};class z{static fromOpts(e){return z.create(e.locale,e.numberingSystem,e.outputCalendar,e.weekSettings,e.defaultToEN)}static create(e,n,a,i,s=!1){const r=e||j.defaultLocale,l=r||(s?"en-US":ks()),c=n||j.defaultNumberingSystem,u=a||j.defaultOutputCalendar,d=ta(i)||j.defaultWeekSettings;return new z(l,c,u,d,r)}static resetCache(){Dt=null,jn.clear(),Kn.clear(),Yn.clear(),Xn.clear(),Qn.clear()}static fromObject({locale:e,numberingSystem:n,outputCalendar:a,weekSettings:i}={}){return z.create(e,n,a,i)}constructor(e,n,a,i,s){const[r,l,c]=Cs(e);this.locale=r,this.numberingSystem=n||l||null,this.outputCalendar=a||c||null,this.weekSettings=i,this.intl=As(this.locale,this.numberingSystem,this.outputCalendar),this.weekdaysCache={format:{},standalone:{}},this.monthsCache={format:{},standalone:{}},this.meridiemCache=null,this.eraCache={},this.specifiedLocale=s,this.fastNumbersCached=null}get fastNumbers(){return this.fastNumbersCached==null&&(this.fastNumbersCached=Ds(this)),this.fastNumbersCached}listingMode(){const e=this.isEnglish(),n=(this.numberingSystem===null||this.numberingSystem==="latn")&&(this.outputCalendar===null||this.outputCalendar==="gregory");return e&&n?"en":"intl"}clone(e){return!e||Object.getOwnPropertyNames(e).length===0?this:z.create(e.locale||this.specifiedLocale,e.numberingSystem||this.numberingSystem,e.outputCalendar||this.outputCalendar,ta(e.weekSettings)||this.weekSettings,e.defaultToEN||!1)}redefaultToEN(e={}){return this.clone({...e,defaultToEN:!0})}redefaultToSystem(e={}){return this.clone({...e,defaultToEN:!1})}months(e,n=!1){return nn(this,e,nr,()=>{const a=n?{month:e,day:"numeric"}:{month:e},i=n?"format":"standalone";return this.monthsCache[i][e]||(this.monthsCache[i][e]=Ps(s=>this.extract(s,a,"month"))),this.monthsCache[i][e]})}weekdays(e,n=!1){return nn(this,e,rr,()=>{const a=n?{weekday:e,year:"numeric",month:"long",day:"numeric"}:{weekday:e},i=n?"format":"standalone";return this.weekdaysCache[i][e]||(this.weekdaysCache[i][e]=Is(s=>this.extract(s,a,"weekday"))),this.weekdaysCache[i][e]})}meridiems(){return nn(this,void 0,()=>sr,()=>{if(!this.meridiemCache){const e={hour:"numeric",hourCycle:"h12"};this.meridiemCache=[D.utc(2016,11,13,9),D.utc(2016,11,13,19)].map(n=>this.extract(n,e,"dayperiod"))}return this.meridiemCache})}eras(e){return nn(this,e,or,()=>{const n={era:e};return this.eraCache[e]||(this.eraCache[e]=[D.utc(-40,1,1),D.utc(2017,1,1)].map(a=>this.extract(a,n,"era"))),this.eraCache[e]})}extract(e,n,a){const i=this.dtFormatter(e,n),s=i.formatToParts(),r=s.find(l=>l.type.toLowerCase()===a);return r?r.value:null}numberFormatter(e={}){return new Ns(this.intl,e.forceSimple||this.fastNumbers,e)}dtFormatter(e,n={}){return new Fs(e,this.intl,n)}relFormatter(e={}){return new xs(this.intl,this.isEnglish(),e)}listFormatter(e={}){return Ss(this.intl,e)}isEnglish(){return this.locale==="en"||this.locale.toLowerCase()==="en-us"||Bi(this.intl).locale.startsWith("en-us")}getWeekSettings(){return this.weekSettings?this.weekSettings:Xi()?Es(this.locale):Gi}getStartOfWeek(){return this.getWeekSettings().firstDay}getMinDaysInFirstWeek(){return this.getWeekSettings().minimalDays}getWeekendDays(){return this.getWeekSettings().weekend}equals(e){return this.locale===e.locale&&this.numberingSystem===e.numberingSystem&&this.outputCalendar===e.outputCalendar}toString(){return`Locale(${this.locale}, ${this.numberingSystem}, ${this.outputCalendar})`}}let Dn=null;class ue extends Gt{static get utcInstance(){return Dn===null&&(Dn=new ue(0)),Dn}static instance(e){return e===0?ue.utcInstance:new ue(e)}static parseSpecifier(e){if(e){const n=e.match(/^utc(?:([+-]\d{1,2})(?::(\d{2}))?)?$/i);if(n)return new ue(Sn(n[1],n[2]))}return null}constructor(e){super(),this.fixed=e}get type(){return"fixed"}get name(){return this.fixed===0?"UTC":`UTC${$t(this.fixed,"narrow")}`}get ianaName(){return this.fixed===0?"Etc/UTC":`Etc/GMT${$t(-this.fixed,"narrow")}`}offsetName(){return this.name}formatOffset(e,n){return $t(this.fixed,n)}get isUniversal(){return!0}offset(){return this.fixed}equals(e){return e.type==="fixed"&&e.fixed===this.fixed}get isValid(){return!0}}class Os extends Gt{constructor(e){super(),this.zoneName=e}get type(){return"invalid"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(){return null}formatOffset(){return""}offset(){return NaN}equals(){return!1}get isValid(){return!1}}function Xe(t,e){if(O(t)||t===null)return e;if(t instanceof Gt)return t;if(zs(t)){const n=t.toLowerCase();return n==="default"?e:n==="local"||n==="system"?vn.instance:n==="utc"||n==="gmt"?ue.utcInstance:ue.parseSpecifier(n)||ze.create(t)}else return Qe(t)?ue.instance(t):typeof t=="object"&&"offset"in t&&typeof t.offset=="function"?t:new Os(t)}const ua={arab:"[٠-٩]",arabext:"[۰-۹]",bali:"[᭐-᭙]",beng:"[০-৯]",deva:"[०-९]",fullwide:"[０-９]",gujr:"[૦-૯]",hanidec:"[〇|一|二|三|四|五|六|七|八|九]",khmr:"[០-៩]",knda:"[೦-೯]",laoo:"[໐-໙]",limb:"[᥆-᥏]",mlym:"[൦-൯]",mong:"[᠐-᠙]",mymr:"[၀-၉]",orya:"[୦-୯]",tamldec:"[௦-௯]",telu:"[౦-౯]",thai:"[๐-๙]",tibt:"[༠-༩]",latn:"\\d"},xa={arab:[1632,1641],arabext:[1776,1785],bali:[6992,7001],beng:[2534,2543],deva:[2406,2415],fullwide:[65296,65303],gujr:[2790,2799],khmr:[6112,6121],knda:[3302,3311],laoo:[3792,3801],limb:[6470,6479],mlym:[3430,3439],mong:[6160,6169],mymr:[4160,4169],orya:[2918,2927],tamldec:[3046,3055],telu:[3174,3183],thai:[3664,3673],tibt:[3872,3881]},$s=ua.hanidec.replace(/[\[|\]]/g,"").split("");function Rs(t){let e=parseInt(t,10);if(isNaN(e)){e="";for(let n=0;n<t.length;n++){const a=t.charCodeAt(n);if(t[n].search(ua.hanidec)!==-1)e+=$s.indexOf(t[n]);else for(const i in xa){const[s,r]=xa[i];a>=s&&a<=r&&(e+=a-s)}}return parseInt(e,10)}else return e}const ea=new Map;function Us(){ea.clear()}function Pe({numberingSystem:t},e=""){const n=t||"latn";let a=ea.get(n);a===void 0&&(a=new Map,ea.set(n,a));let i=a.get(e);return i===void 0&&(i=new RegExp(`${ua[n]}${e}`),a.set(e,i)),i}let Oa=()=>Date.now(),$a="system",Ra=null,Ua=null,Ha=null,Wa=60,za,Ba=null;class j{static get now(){return Oa}static set now(e){Oa=e}static set defaultZone(e){$a=e}static get defaultZone(){return Xe($a,vn.instance)}static get defaultLocale(){return Ra}static set defaultLocale(e){Ra=e}static get defaultNumberingSystem(){return Ua}static set defaultNumberingSystem(e){Ua=e}static get defaultOutputCalendar(){return Ha}static set defaultOutputCalendar(e){Ha=e}static get defaultWeekSettings(){return Ba}static set defaultWeekSettings(e){Ba=ta(e)}static get twoDigitCutoffYear(){return Wa}static set twoDigitCutoffYear(e){Wa=e%100}static get throwOnInvalid(){return za}static set throwOnInvalid(e){za=e}static resetCaches(){z.resetCache(),ze.resetCache(),D.resetCache(),Us()}}class De{constructor(e,n){this.reason=e,this.explanation=n}toMessage(){return this.explanation?`${this.reason}: ${this.explanation}`:this.reason}}const Vi=[0,31,59,90,120,151,181,212,243,273,304,334],Ji=[0,31,60,91,121,152,182,213,244,274,305,335];function ke(t,e){return new De("unit out of range",`you specified ${e} (of type ${typeof e}) as a ${t}, which is invalid`)}function da(t,e,n){const a=new Date(Date.UTC(t,e-1,n));t<100&&t>=0&&a.setUTCFullYear(a.getUTCFullYear()-1900);const i=a.getUTCDay();return i===0?7:i}function Zi(t,e,n){return n+(Vt(t)?Ji:Vi)[e-1]}function ji(t,e){const n=Vt(t)?Ji:Vi,a=n.findIndex(s=>s<e),i=e-n[a];return{month:a+1,day:i}}function ha(t,e){return(t-e+7)%7+1}function pn(t,e=4,n=1){const{year:a,month:i,day:s}=t,r=Zi(a,i,s),l=ha(da(a,i,s),n);let c=Math.floor((r-l+14-e)/7),u;return c<1?(u=a-1,c=Ut(u,e,n)):c>Ut(a,e,n)?(u=a+1,c=1):u=a,{weekYear:u,weekNumber:c,weekday:l,...bn(t)}}function Ga(t,e=4,n=1){const{weekYear:a,weekNumber:i,weekday:s}=t,r=ha(da(a,1,e),n),l=_t(a);let c=i*7+s-r-7+e,u;c<1?(u=a-1,c+=_t(u)):c>l?(u=a+1,c-=_t(a)):u=a;const{month:d,day:m}=ji(u,c);return{year:u,month:d,day:m,...bn(t)}}function Nn(t){const{year:e,month:n,day:a}=t,i=Zi(e,n,a);return{year:e,ordinal:i,...bn(t)}}function Va(t){const{year:e,ordinal:n}=t,{month:a,day:i}=ji(e,n);return{year:e,month:a,day:i,...bn(t)}}function Ja(t,e){if(!O(t.localWeekday)||!O(t.localWeekNumber)||!O(t.localWeekYear)){if(!O(t.weekday)||!O(t.weekNumber)||!O(t.weekYear))throw new yt("Cannot mix locale-based week fields with ISO-based week fields");return O(t.localWeekday)||(t.weekday=t.localWeekday),O(t.localWeekNumber)||(t.weekNumber=t.localWeekNumber),O(t.localWeekYear)||(t.weekYear=t.localWeekYear),delete t.localWeekday,delete t.localWeekNumber,delete t.localWeekYear,{minDaysInFirstWeek:e.getMinDaysInFirstWeek(),startOfWeek:e.getStartOfWeek()}}else return{minDaysInFirstWeek:4,startOfWeek:1}}function Hs(t,e=4,n=1){const a=Ln(t.weekYear),i=Ee(t.weekNumber,1,Ut(t.weekYear,e,n)),s=Ee(t.weekday,1,7);return a?i?s?!1:ke("weekday",t.weekday):ke("week",t.weekNumber):ke("weekYear",t.weekYear)}function Ws(t){const e=Ln(t.year),n=Ee(t.ordinal,1,_t(t.year));return e?n?!1:ke("ordinal",t.ordinal):ke("year",t.year)}function qi(t){const e=Ln(t.year),n=Ee(t.month,1,12),a=Ee(t.day,1,fn(t.year,t.month));return e?n?a?!1:ke("day",t.day):ke("month",t.month):ke("year",t.year)}function Ki(t){const{hour:e,minute:n,second:a,millisecond:i}=t,s=Ee(e,0,23)||e===24&&n===0&&a===0&&i===0,r=Ee(n,0,59),l=Ee(a,0,59),c=Ee(i,0,999);return s?r?l?c?!1:ke("millisecond",i):ke("second",a):ke("minute",n):ke("hour",e)}function O(t){return typeof t>"u"}function Qe(t){return typeof t=="number"}function Ln(t){return typeof t=="number"&&t%1===0}function zs(t){return typeof t=="string"}function Bs(t){return Object.prototype.toString.call(t)==="[object Date]"}function Yi(){try{return typeof Intl<"u"&&!!Intl.RelativeTimeFormat}catch{return!1}}function Xi(){try{return typeof Intl<"u"&&!!Intl.Locale&&("weekInfo"in Intl.Locale.prototype||"getWeekInfo"in Intl.Locale.prototype)}catch{return!1}}function Gs(t){return Array.isArray(t)?t:[t]}function Za(t,e,n){if(t.length!==0)return t.reduce((a,i)=>{const s=[e(i),i];return a&&n(a[0],s[0])===a[0]?a:s},null)[1]}function Vs(t,e){return e.reduce((n,a)=>(n[a]=t[a],n),{})}function Lt(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function ta(t){if(t==null)return null;if(typeof t!="object")throw new re("Week settings must be an object");if(!Ee(t.firstDay,1,7)||!Ee(t.minimalDays,1,7)||!Array.isArray(t.weekend)||t.weekend.some(e=>!Ee(e,1,7)))throw new re("Invalid week settings");return{firstDay:t.firstDay,minimalDays:t.minimalDays,weekend:Array.from(t.weekend)}}function Ee(t,e,n){return Ln(t)&&t>=e&&t<=n}function Js(t,e){return t-e*Math.floor(t/e)}function Q(t,e=2){const n=t<0;let a;return n?a="-"+(""+-t).padStart(e,"0"):a=(""+t).padStart(e,"0"),a}function Ke(t){if(!(O(t)||t===null||t===""))return parseInt(t,10)}function at(t){if(!(O(t)||t===null||t===""))return parseFloat(t)}function ma(t){if(!(O(t)||t===null||t==="")){const e=parseFloat("0."+t)*1e3;return Math.floor(e)}}function pa(t,e,n=!1){const a=10**e;return(n?Math.trunc:Math.round)(t*a)/a}function Vt(t){return t%4===0&&(t%100!==0||t%400===0)}function _t(t){return Vt(t)?366:365}function fn(t,e){const n=Js(e-1,12)+1,a=t+(e-n)/12;return n===2?Vt(a)?29:28:[31,null,31,30,31,30,31,31,30,31,30,31][n-1]}function Mn(t){let e=Date.UTC(t.year,t.month-1,t.day,t.hour,t.minute,t.second,t.millisecond);return t.year<100&&t.year>=0&&(e=new Date(e),e.setUTCFullYear(t.year,t.month-1,t.day)),+e}function ja(t,e,n){return-ha(da(t,1,e),n)+e-1}function Ut(t,e=4,n=1){const a=ja(t,e,n),i=ja(t+1,e,n);return(_t(t)-a+i)/7}function na(t){return t>99?t:t>j.twoDigitCutoffYear?1900+t:2e3+t}function Qi(t,e,n,a=null){const i=new Date(t),s={hourCycle:"h23",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"};a&&(s.timeZone=a);const r={timeZoneName:e,...s},l=new Intl.DateTimeFormat(n,r).formatToParts(i).find(c=>c.type.toLowerCase()==="timezonename");return l?l.value:null}function Sn(t,e){let n=parseInt(t,10);Number.isNaN(n)&&(n=0);const a=parseInt(e,10)||0,i=n<0||Object.is(n,-0)?-a:a;return n*60+i}function er(t){const e=Number(t);if(typeof t=="boolean"||t===""||Number.isNaN(e))throw new re(`Invalid unit value ${t}`);return e}function gn(t,e){const n={};for(const a in t)if(Lt(t,a)){const i=t[a];if(i==null)continue;n[e(a)]=er(i)}return n}function $t(t,e){const n=Math.trunc(Math.abs(t/60)),a=Math.trunc(Math.abs(t%60)),i=t>=0?"+":"-";switch(e){case"short":return`${i}${Q(n,2)}:${Q(a,2)}`;case"narrow":return`${i}${n}${a>0?`:${a}`:""}`;case"techie":return`${i}${Q(n,2)}${Q(a,2)}`;default:throw new RangeError(`Value format ${e} is out of range for property format`)}}function bn(t){return Vs(t,["hour","minute","second","millisecond"])}const Zs=["January","February","March","April","May","June","July","August","September","October","November","December"],tr=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],js=["J","F","M","A","M","J","J","A","S","O","N","D"];function nr(t){switch(t){case"narrow":return[...js];case"short":return[...tr];case"long":return[...Zs];case"numeric":return["1","2","3","4","5","6","7","8","9","10","11","12"];case"2-digit":return["01","02","03","04","05","06","07","08","09","10","11","12"];default:return null}}const ar=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],ir=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],qs=["M","T","W","T","F","S","S"];function rr(t){switch(t){case"narrow":return[...qs];case"short":return[...ir];case"long":return[...ar];case"numeric":return["1","2","3","4","5","6","7"];default:return null}}const sr=["AM","PM"],Ks=["Before Christ","Anno Domini"],Ys=["BC","AD"],Xs=["B","A"];function or(t){switch(t){case"narrow":return[...Xs];case"short":return[...Ys];case"long":return[...Ks];default:return null}}function Qs(t){return sr[t.hour<12?0:1]}function eo(t,e){return rr(e)[t.weekday-1]}function to(t,e){return nr(e)[t.month-1]}function no(t,e){return or(e)[t.year<0?0:1]}function ao(t,e,n="always",a=!1){const i={years:["year","yr."],quarters:["quarter","qtr."],months:["month","mo."],weeks:["week","wk."],days:["day","day","days"],hours:["hour","hr."],minutes:["minute","min."],seconds:["second","sec."]},s=["hours","minutes","seconds"].indexOf(t)===-1;if(n==="auto"&&s){const m=t==="days";switch(e){case 1:return m?"tomorrow":`next ${i[t][0]}`;case-1:return m?"yesterday":`last ${i[t][0]}`;case 0:return m?"today":`this ${i[t][0]}`}}const r=Object.is(e,-0)||e<0,l=Math.abs(e),c=l===1,u=i[t],d=a?c?u[1]:u[2]||u[1]:c?i[t][0]:t;return r?`${l} ${d} ago`:`in ${l} ${d}`}function qa(t,e){let n="";for(const a of t)a.literal?n+=a.val:n+=e(a.val);return n}const io={D:mn,DD:bi,DDD:Ti,DDDD:ki,t:Ei,tt:Ci,ttt:Ai,tttt:Pi,T:Ii,TT:Di,TTT:Ni,TTTT:Fi,f:xi,ff:$i,fff:Ui,ffff:Wi,F:Oi,FF:Ri,FFF:Hi,FFFF:zi};class se{static create(e,n={}){return new se(e,n)}static parseFormat(e){let n=null,a="",i=!1;const s=[];for(let r=0;r<e.length;r++){const l=e.charAt(r);l==="'"?(a.length>0&&s.push({literal:i||/^\s+$/.test(a),val:a}),n=null,a="",i=!i):i||l===n?a+=l:(a.length>0&&s.push({literal:/^\s+$/.test(a),val:a}),a=l,n=l)}return a.length>0&&s.push({literal:i||/^\s+$/.test(a),val:a}),s}static macroTokenToFormatOpts(e){return io[e]}constructor(e,n){this.opts=n,this.loc=e,this.systemLoc=null}formatWithSystemDefault(e,n){return this.systemLoc===null&&(this.systemLoc=this.loc.redefaultToSystem()),this.systemLoc.dtFormatter(e,{...this.opts,...n}).format()}dtFormatter(e,n={}){return this.loc.dtFormatter(e,{...this.opts,...n})}formatDateTime(e,n){return this.dtFormatter(e,n).format()}formatDateTimeParts(e,n){return this.dtFormatter(e,n).formatToParts()}formatInterval(e,n){return this.dtFormatter(e.start,n).dtf.formatRange(e.start.toJSDate(),e.end.toJSDate())}resolvedOptions(e,n){return this.dtFormatter(e,n).resolvedOptions()}num(e,n=0){if(this.opts.forceSimple)return Q(e,n);const a={...this.opts};return n>0&&(a.padTo=n),this.loc.numberFormatter(a).format(e)}formatDateTimeFromString(e,n){const a=this.loc.listingMode()==="en",i=this.loc.outputCalendar&&this.loc.outputCalendar!=="gregory",s=(f,y)=>this.loc.extract(e,f,y),r=f=>e.isOffsetFixed&&e.offset===0&&f.allowZ?"Z":e.isValid?e.zone.formatOffset(e.ts,f.format):"",l=()=>a?Qs(e):s({hour:"numeric",hourCycle:"h12"},"dayperiod"),c=(f,y)=>a?to(e,f):s(y?{month:f}:{month:f,day:"numeric"},"month"),u=(f,y)=>a?eo(e,f):s(y?{weekday:f}:{weekday:f,month:"long",day:"numeric"},"weekday"),d=f=>{const y=se.macroTokenToFormatOpts(f);return y?this.formatWithSystemDefault(e,y):f},m=f=>a?no(e,f):s({era:f},"era"),p=f=>{switch(f){case"S":return this.num(e.millisecond);case"u":case"SSS":return this.num(e.millisecond,3);case"s":return this.num(e.second);case"ss":return this.num(e.second,2);case"uu":return this.num(Math.floor(e.millisecond/10),2);case"uuu":return this.num(Math.floor(e.millisecond/100));case"m":return this.num(e.minute);case"mm":return this.num(e.minute,2);case"h":return this.num(e.hour%12===0?12:e.hour%12);case"hh":return this.num(e.hour%12===0?12:e.hour%12,2);case"H":return this.num(e.hour);case"HH":return this.num(e.hour,2);case"Z":return r({format:"narrow",allowZ:this.opts.allowZ});case"ZZ":return r({format:"short",allowZ:this.opts.allowZ});case"ZZZ":return r({format:"techie",allowZ:this.opts.allowZ});case"ZZZZ":return e.zone.offsetName(e.ts,{format:"short",locale:this.loc.locale});case"ZZZZZ":return e.zone.offsetName(e.ts,{format:"long",locale:this.loc.locale});case"z":return e.zoneName;case"a":return l();case"d":return i?s({day:"numeric"},"day"):this.num(e.day);case"dd":return i?s({day:"2-digit"},"day"):this.num(e.day,2);case"c":return this.num(e.weekday);case"ccc":return u("short",!0);case"cccc":return u("long",!0);case"ccccc":return u("narrow",!0);case"E":return this.num(e.weekday);case"EEE":return u("short",!1);case"EEEE":return u("long",!1);case"EEEEE":return u("narrow",!1);case"L":return i?s({month:"numeric",day:"numeric"},"month"):this.num(e.month);case"LL":return i?s({month:"2-digit",day:"numeric"},"month"):this.num(e.month,2);case"LLL":return c("short",!0);case"LLLL":return c("long",!0);case"LLLLL":return c("narrow",!0);case"M":return i?s({month:"numeric"},"month"):this.num(e.month);case"MM":return i?s({month:"2-digit"},"month"):this.num(e.month,2);case"MMM":return c("short",!1);case"MMMM":return c("long",!1);case"MMMMM":return c("narrow",!1);case"y":return i?s({year:"numeric"},"year"):this.num(e.year);case"yy":return i?s({year:"2-digit"},"year"):this.num(e.year.toString().slice(-2),2);case"yyyy":return i?s({year:"numeric"},"year"):this.num(e.year,4);case"yyyyyy":return i?s({year:"numeric"},"year"):this.num(e.year,6);case"G":return m("short");case"GG":return m("long");case"GGGGG":return m("narrow");case"kk":return this.num(e.weekYear.toString().slice(-2),2);case"kkkk":return this.num(e.weekYear,4);case"W":return this.num(e.weekNumber);case"WW":return this.num(e.weekNumber,2);case"n":return this.num(e.localWeekNumber);case"nn":return this.num(e.localWeekNumber,2);case"ii":return this.num(e.localWeekYear.toString().slice(-2),2);case"iiii":return this.num(e.localWeekYear,4);case"o":return this.num(e.ordinal);case"ooo":return this.num(e.ordinal,3);case"q":return this.num(e.quarter);case"qq":return this.num(e.quarter,2);case"X":return this.num(Math.floor(e.ts/1e3));case"x":return this.num(e.ts);default:return d(f)}};return qa(se.parseFormat(n),p)}formatDurationFromString(e,n){const a=c=>{switch(c[0]){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":return"hour";case"d":return"day";case"w":return"week";case"M":return"month";case"y":return"year";default:return null}},i=c=>u=>{const d=a(u);return d?this.num(c.get(d),u.length):u},s=se.parseFormat(n),r=s.reduce((c,{literal:u,val:d})=>u?c:c.concat(d),[]),l=e.shiftTo(...r.map(a).filter(c=>c));return qa(s,i(l))}}const lr=/[A-Za-z_+-]{1,256}(?::?\/[A-Za-z0-9_+-]{1,256}(?:\/[A-Za-z0-9_+-]{1,256})?)?/;function bt(...t){const e=t.reduce((n,a)=>n+a.source,"");return RegExp(`^${e}$`)}function Tt(...t){return e=>t.reduce(([n,a,i],s)=>{const[r,l,c]=s(e,i);return[{...n,...r},l||a,c]},[{},null,1]).slice(0,2)}function kt(t,...e){if(t==null)return[null,null];for(const[n,a]of e){const i=n.exec(t);if(i)return a(i)}return[null,null]}function cr(...t){return(e,n)=>{const a={};let i;for(i=0;i<t.length;i++)a[t[i]]=Ke(e[n+i]);return[a,null,n+i]}}const ur=/(?:(Z)|([+-]\d\d)(?::?(\d\d))?)/,ro=`(?:${ur.source}?(?:\\[(${lr.source})\\])?)?`,fa=/(\d\d)(?::?(\d\d)(?::?(\d\d)(?:[.,](\d{1,30}))?)?)?/,dr=RegExp(`${fa.source}${ro}`),ga=RegExp(`(?:T${dr.source})?`),so=/([+-]\d{6}|\d{4})(?:-?(\d\d)(?:-?(\d\d))?)?/,oo=/(\d{4})-?W(\d\d)(?:-?(\d))?/,lo=/(\d{4})-?(\d{3})/,co=cr("weekYear","weekNumber","weekDay"),uo=cr("year","ordinal"),ho=/(\d{4})-(\d\d)-(\d\d)/,hr=RegExp(`${fa.source} ?(?:${ur.source}|(${lr.source}))?`),mo=RegExp(`(?: ${hr.source})?`);function vt(t,e,n){const a=t[e];return O(a)?n:Ke(a)}function po(t,e){return[{year:vt(t,e),month:vt(t,e+1,1),day:vt(t,e+2,1)},null,e+3]}function Et(t,e){return[{hours:vt(t,e,0),minutes:vt(t,e+1,0),seconds:vt(t,e+2,0),milliseconds:ma(t[e+3])},null,e+4]}function Jt(t,e){const n=!t[e]&&!t[e+1],a=Sn(t[e+1],t[e+2]),i=n?null:ue.instance(a);return[{},i,e+3]}function Zt(t,e){const n=t[e]?ze.create(t[e]):null;return[{},n,e+1]}const fo=RegExp(`^T?${fa.source}$`),go=/^-?P(?:(?:(-?\d{1,20}(?:\.\d{1,20})?)Y)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20}(?:\.\d{1,20})?)W)?(?:(-?\d{1,20}(?:\.\d{1,20})?)D)?(?:T(?:(-?\d{1,20}(?:\.\d{1,20})?)H)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20})(?:[.,](-?\d{1,20}))?S)?)?)$/;function yo(t){const[e,n,a,i,s,r,l,c,u]=t,d=e[0]==="-",m=c&&c[0]==="-",p=(f,y=!1)=>f!==void 0&&(y||f&&d)?-f:f;return[{years:p(at(n)),months:p(at(a)),weeks:p(at(i)),days:p(at(s)),hours:p(at(r)),minutes:p(at(l)),seconds:p(at(c),c==="-0"),milliseconds:p(ma(u),m)}]}const wo={GMT:0,EDT:-4*60,EST:-5*60,CDT:-5*60,CST:-6*60,MDT:-6*60,MST:-7*60,PDT:-7*60,PST:-8*60};function ya(t,e,n,a,i,s,r){const l={year:e.length===2?na(Ke(e)):Ke(e),month:tr.indexOf(n)+1,day:Ke(a),hour:Ke(i),minute:Ke(s)};return r&&(l.second=Ke(r)),t&&(l.weekday=t.length>3?ar.indexOf(t)+1:ir.indexOf(t)+1),l}const _o=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|(?:([+-]\d\d)(\d\d)))$/;function vo(t){const[,e,n,a,i,s,r,l,c,u,d,m]=t,p=ya(e,i,a,n,s,r,l);let f;return c?f=wo[c]:u?f=0:f=Sn(d,m),[p,new ue(f)]}function Lo(t){return t.replace(/\([^()]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").trim()}const Mo=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun), (\d\d) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) (\d{4}) (\d\d):(\d\d):(\d\d) GMT$/,So=/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday), (\d\d)-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-(\d\d) (\d\d):(\d\d):(\d\d) GMT$/,bo=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) ( \d|\d\d) (\d\d):(\d\d):(\d\d) (\d{4})$/;function Ka(t){const[,e,n,a,i,s,r,l]=t;return[ya(e,i,a,n,s,r,l),ue.utcInstance]}function To(t){const[,e,n,a,i,s,r,l]=t;return[ya(e,l,n,a,i,s,r),ue.utcInstance]}const ko=bt(so,ga),Eo=bt(oo,ga),Co=bt(lo,ga),Ao=bt(dr),mr=Tt(po,Et,Jt,Zt),Po=Tt(co,Et,Jt,Zt),Io=Tt(uo,Et,Jt,Zt),Do=Tt(Et,Jt,Zt);function No(t){return kt(t,[ko,mr],[Eo,Po],[Co,Io],[Ao,Do])}function Fo(t){return kt(Lo(t),[_o,vo])}function xo(t){return kt(t,[Mo,Ka],[So,Ka],[bo,To])}function Oo(t){return kt(t,[go,yo])}const $o=Tt(Et);function Ro(t){return kt(t,[fo,$o])}const Uo=bt(ho,mo),Ho=bt(hr),Wo=Tt(Et,Jt,Zt);function zo(t){return kt(t,[Uo,mr],[Ho,Wo])}const Ya="Invalid Duration",pr={weeks:{days:7,hours:7*24,minutes:7*24*60,seconds:7*24*60*60,milliseconds:7*24*60*60*1e3},days:{hours:24,minutes:24*60,seconds:24*60*60,milliseconds:24*60*60*1e3},hours:{minutes:60,seconds:60*60,milliseconds:60*60*1e3},minutes:{seconds:60,milliseconds:60*1e3},seconds:{milliseconds:1e3}},Bo={years:{quarters:4,months:12,weeks:52,days:365,hours:365*24,minutes:365*24*60,seconds:365*24*60*60,milliseconds:365*24*60*60*1e3},quarters:{months:3,weeks:13,days:91,hours:91*24,minutes:91*24*60,seconds:91*24*60*60,milliseconds:91*24*60*60*1e3},months:{weeks:4,days:30,hours:30*24,minutes:30*24*60,seconds:30*24*60*60,milliseconds:30*24*60*60*1e3},...pr},Le=146097/400,ht=146097/4800,Go={years:{quarters:4,months:12,weeks:Le/7,days:Le,hours:Le*24,minutes:Le*24*60,seconds:Le*24*60*60,milliseconds:Le*24*60*60*1e3},quarters:{months:3,weeks:Le/28,days:Le/4,hours:Le*24/4,minutes:Le*24*60/4,seconds:Le*24*60*60/4,milliseconds:Le*24*60*60*1e3/4},months:{weeks:ht/7,days:ht,hours:ht*24,minutes:ht*24*60,seconds:ht*24*60*60,milliseconds:ht*24*60*60*1e3},...pr},st=["years","quarters","months","weeks","days","hours","minutes","seconds","milliseconds"],Vo=st.slice(0).reverse();function je(t,e,n=!1){const a={values:n?e.values:{...t.values,...e.values||{}},loc:t.loc.clone(e.loc),conversionAccuracy:e.conversionAccuracy||t.conversionAccuracy,matrix:e.matrix||t.matrix};return new H(a)}function fr(t,e){let n=e.milliseconds??0;for(const a of Vo.slice(1))e[a]&&(n+=e[a]*t[a].milliseconds);return n}function Xa(t,e){const n=fr(t,e)<0?-1:1;st.reduceRight((a,i)=>{if(O(e[i]))return a;if(a){const s=e[a]*n,r=t[i][a],l=Math.floor(s/r);e[i]+=l*n,e[a]-=l*r*n}return i},null),st.reduce((a,i)=>{if(O(e[i]))return a;if(a){const s=e[a]%1;e[a]-=s,e[i]+=s*t[a][i]}return i},null)}function Jo(t){const e={};for(const[n,a]of Object.entries(t))a!==0&&(e[n]=a);return e}class H{constructor(e){const n=e.conversionAccuracy==="longterm"||!1;let a=n?Go:Bo;e.matrix&&(a=e.matrix),this.values=e.values,this.loc=e.loc||z.create(),this.conversionAccuracy=n?"longterm":"casual",this.invalid=e.invalid||null,this.matrix=a,this.isLuxonDuration=!0}static fromMillis(e,n){return H.fromObject({milliseconds:e},n)}static fromObject(e,n={}){if(e==null||typeof e!="object")throw new re(`Duration.fromObject: argument expected to be an object, got ${e===null?"null":typeof e}`);return new H({values:gn(e,H.normalizeUnit),loc:z.fromObject(n),conversionAccuracy:n.conversionAccuracy,matrix:n.matrix})}static fromDurationLike(e){if(Qe(e))return H.fromMillis(e);if(H.isDuration(e))return e;if(typeof e=="object")return H.fromObject(e);throw new re(`Unknown duration argument ${e} of type ${typeof e}`)}static fromISO(e,n){const[a]=Oo(e);return a?H.fromObject(a,n):H.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static fromISOTime(e,n){const[a]=Ro(e);return a?H.fromObject(a,n):H.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static invalid(e,n=null){if(!e)throw new re("need to specify a reason the Duration is invalid");const a=e instanceof De?e:new De(e,n);if(j.throwOnInvalid)throw new gs(a);return new H({invalid:a})}static normalizeUnit(e){const n={year:"years",years:"years",quarter:"quarters",quarters:"quarters",month:"months",months:"months",week:"weeks",weeks:"weeks",day:"days",days:"days",hour:"hours",hours:"hours",minute:"minutes",minutes:"minutes",second:"seconds",seconds:"seconds",millisecond:"milliseconds",milliseconds:"milliseconds"}[e&&e.toLowerCase()];if(!n)throw new Si(e);return n}static isDuration(e){return e&&e.isLuxonDuration||!1}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}toFormat(e,n={}){const a={...n,floor:n.round!==!1&&n.floor!==!1};return this.isValid?se.create(this.loc,a).formatDurationFromString(this,e):Ya}toHuman(e={}){if(!this.isValid)return Ya;const n=st.map(a=>{const i=this.values[a];return O(i)?null:this.loc.numberFormatter({style:"unit",unitDisplay:"long",...e,unit:a.slice(0,-1)}).format(i)}).filter(a=>a);return this.loc.listFormatter({type:"conjunction",style:e.listStyle||"narrow",...e}).format(n)}toObject(){return this.isValid?{...this.values}:{}}toISO(){if(!this.isValid)return null;let e="P";return this.years!==0&&(e+=this.years+"Y"),(this.months!==0||this.quarters!==0)&&(e+=this.months+this.quarters*3+"M"),this.weeks!==0&&(e+=this.weeks+"W"),this.days!==0&&(e+=this.days+"D"),(this.hours!==0||this.minutes!==0||this.seconds!==0||this.milliseconds!==0)&&(e+="T"),this.hours!==0&&(e+=this.hours+"H"),this.minutes!==0&&(e+=this.minutes+"M"),(this.seconds!==0||this.milliseconds!==0)&&(e+=pa(this.seconds+this.milliseconds/1e3,3)+"S"),e==="P"&&(e+="T0S"),e}toISOTime(e={}){if(!this.isValid)return null;const n=this.toMillis();return n<0||n>=864e5?null:(e={suppressMilliseconds:!1,suppressSeconds:!1,includePrefix:!1,format:"extended",...e,includeOffset:!1},D.fromMillis(n,{zone:"UTC"}).toISOTime(e))}toJSON(){return this.toISO()}toString(){return this.toISO()}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`Duration { values: ${JSON.stringify(this.values)} }`:`Duration { Invalid, reason: ${this.invalidReason} }`}toMillis(){return this.isValid?fr(this.matrix,this.values):NaN}valueOf(){return this.toMillis()}plus(e){if(!this.isValid)return this;const n=H.fromDurationLike(e),a={};for(const i of st)(Lt(n.values,i)||Lt(this.values,i))&&(a[i]=n.get(i)+this.get(i));return je(this,{values:a},!0)}minus(e){if(!this.isValid)return this;const n=H.fromDurationLike(e);return this.plus(n.negate())}mapUnits(e){if(!this.isValid)return this;const n={};for(const a of Object.keys(this.values))n[a]=er(e(this.values[a],a));return je(this,{values:n},!0)}get(e){return this[H.normalizeUnit(e)]}set(e){if(!this.isValid)return this;const n={...this.values,...gn(e,H.normalizeUnit)};return je(this,{values:n})}reconfigure({locale:e,numberingSystem:n,conversionAccuracy:a,matrix:i}={}){const r={loc:this.loc.clone({locale:e,numberingSystem:n}),matrix:i,conversionAccuracy:a};return je(this,r)}as(e){return this.isValid?this.shiftTo(e).get(e):NaN}normalize(){if(!this.isValid)return this;const e=this.toObject();return Xa(this.matrix,e),je(this,{values:e},!0)}rescale(){if(!this.isValid)return this;const e=Jo(this.normalize().shiftToAll().toObject());return je(this,{values:e},!0)}shiftTo(...e){if(!this.isValid)return this;if(e.length===0)return this;e=e.map(r=>H.normalizeUnit(r));const n={},a={},i=this.toObject();let s;for(const r of st)if(e.indexOf(r)>=0){s=r;let l=0;for(const u in a)l+=this.matrix[u][r]*a[u],a[u]=0;Qe(i[r])&&(l+=i[r]);const c=Math.trunc(l);n[r]=c,a[r]=(l*1e3-c*1e3)/1e3}else Qe(i[r])&&(a[r]=i[r]);for(const r in a)a[r]!==0&&(n[s]+=r===s?a[r]:a[r]/this.matrix[s][r]);return Xa(this.matrix,n),je(this,{values:n},!0)}shiftToAll(){return this.isValid?this.shiftTo("years","months","weeks","days","hours","minutes","seconds","milliseconds"):this}negate(){if(!this.isValid)return this;const e={};for(const n of Object.keys(this.values))e[n]=this.values[n]===0?0:-this.values[n];return je(this,{values:e},!0)}get years(){return this.isValid?this.values.years||0:NaN}get quarters(){return this.isValid?this.values.quarters||0:NaN}get months(){return this.isValid?this.values.months||0:NaN}get weeks(){return this.isValid?this.values.weeks||0:NaN}get days(){return this.isValid?this.values.days||0:NaN}get hours(){return this.isValid?this.values.hours||0:NaN}get minutes(){return this.isValid?this.values.minutes||0:NaN}get seconds(){return this.isValid?this.values.seconds||0:NaN}get milliseconds(){return this.isValid?this.values.milliseconds||0:NaN}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}equals(e){if(!this.isValid||!e.isValid||!this.loc.equals(e.loc))return!1;function n(a,i){return a===void 0||a===0?i===void 0||i===0:a===i}for(const a of st)if(!n(this.values[a],e.values[a]))return!1;return!0}}const mt="Invalid Interval";function Zo(t,e){return!t||!t.isValid?Z.invalid("missing or invalid start"):!e||!e.isValid?Z.invalid("missing or invalid end"):e<t?Z.invalid("end before start",`The end of an interval must be after its start, but you had start=${t.toISO()} and end=${e.toISO()}`):null}class Z{constructor(e){this.s=e.start,this.e=e.end,this.invalid=e.invalid||null,this.isLuxonInterval=!0}static invalid(e,n=null){if(!e)throw new re("need to specify a reason the Interval is invalid");const a=e instanceof De?e:new De(e,n);if(j.throwOnInvalid)throw new fs(a);return new Z({invalid:a})}static fromDateTimes(e,n){const a=It(e),i=It(n),s=Zo(a,i);return s??new Z({start:a,end:i})}static after(e,n){const a=H.fromDurationLike(n),i=It(e);return Z.fromDateTimes(i,i.plus(a))}static before(e,n){const a=H.fromDurationLike(n),i=It(e);return Z.fromDateTimes(i.minus(a),i)}static fromISO(e,n){const[a,i]=(e||"").split("/",2);if(a&&i){let s,r;try{s=D.fromISO(a,n),r=s.isValid}catch{r=!1}let l,c;try{l=D.fromISO(i,n),c=l.isValid}catch{c=!1}if(r&&c)return Z.fromDateTimes(s,l);if(r){const u=H.fromISO(i,n);if(u.isValid)return Z.after(s,u)}else if(c){const u=H.fromISO(a,n);if(u.isValid)return Z.before(l,u)}}return Z.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static isInterval(e){return e&&e.isLuxonInterval||!1}get start(){return this.isValid?this.s:null}get end(){return this.isValid?this.e:null}get lastDateTime(){return this.isValid&&this.e?this.e.minus(1):null}get isValid(){return this.invalidReason===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}length(e="milliseconds"){return this.isValid?this.toDuration(e).get(e):NaN}count(e="milliseconds",n){if(!this.isValid)return NaN;const a=this.start.startOf(e,n);let i;return n!=null&&n.useLocaleWeeks?i=this.end.reconfigure({locale:a.locale}):i=this.end,i=i.startOf(e,n),Math.floor(i.diff(a,e).get(e))+(i.valueOf()!==this.end.valueOf())}hasSame(e){return this.isValid?this.isEmpty()||this.e.minus(1).hasSame(this.s,e):!1}isEmpty(){return this.s.valueOf()===this.e.valueOf()}isAfter(e){return this.isValid?this.s>e:!1}isBefore(e){return this.isValid?this.e<=e:!1}contains(e){return this.isValid?this.s<=e&&this.e>e:!1}set({start:e,end:n}={}){return this.isValid?Z.fromDateTimes(e||this.s,n||this.e):this}splitAt(...e){if(!this.isValid)return[];const n=e.map(It).filter(r=>this.contains(r)).sort((r,l)=>r.toMillis()-l.toMillis()),a=[];let{s:i}=this,s=0;for(;i<this.e;){const r=n[s]||this.e,l=+r>+this.e?this.e:r;a.push(Z.fromDateTimes(i,l)),i=l,s+=1}return a}splitBy(e){const n=H.fromDurationLike(e);if(!this.isValid||!n.isValid||n.as("milliseconds")===0)return[];let{s:a}=this,i=1,s;const r=[];for(;a<this.e;){const l=this.start.plus(n.mapUnits(c=>c*i));s=+l>+this.e?this.e:l,r.push(Z.fromDateTimes(a,s)),a=s,i+=1}return r}divideEqually(e){return this.isValid?this.splitBy(this.length()/e).slice(0,e):[]}overlaps(e){return this.e>e.s&&this.s<e.e}abutsStart(e){return this.isValid?+this.e==+e.s:!1}abutsEnd(e){return this.isValid?+e.e==+this.s:!1}engulfs(e){return this.isValid?this.s<=e.s&&this.e>=e.e:!1}equals(e){return!this.isValid||!e.isValid?!1:this.s.equals(e.s)&&this.e.equals(e.e)}intersection(e){if(!this.isValid)return this;const n=this.s>e.s?this.s:e.s,a=this.e<e.e?this.e:e.e;return n>=a?null:Z.fromDateTimes(n,a)}union(e){if(!this.isValid)return this;const n=this.s<e.s?this.s:e.s,a=this.e>e.e?this.e:e.e;return Z.fromDateTimes(n,a)}static merge(e){const[n,a]=e.sort((i,s)=>i.s-s.s).reduce(([i,s],r)=>s?s.overlaps(r)||s.abutsStart(r)?[i,s.union(r)]:[i.concat([s]),r]:[i,r],[[],null]);return a&&n.push(a),n}static xor(e){let n=null,a=0;const i=[],s=e.map(c=>[{time:c.s,type:"s"},{time:c.e,type:"e"}]),r=Array.prototype.concat(...s),l=r.sort((c,u)=>c.time-u.time);for(const c of l)a+=c.type==="s"?1:-1,a===1?n=c.time:(n&&+n!=+c.time&&i.push(Z.fromDateTimes(n,c.time)),n=null);return Z.merge(i)}difference(...e){return Z.xor([this].concat(e)).map(n=>this.intersection(n)).filter(n=>n&&!n.isEmpty())}toString(){return this.isValid?`[${this.s.toISO()} – ${this.e.toISO()})`:mt}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`Interval { start: ${this.s.toISO()}, end: ${this.e.toISO()} }`:`Interval { Invalid, reason: ${this.invalidReason} }`}toLocaleString(e=mn,n={}){return this.isValid?se.create(this.s.loc.clone(n),e).formatInterval(this):mt}toISO(e){return this.isValid?`${this.s.toISO(e)}/${this.e.toISO(e)}`:mt}toISODate(){return this.isValid?`${this.s.toISODate()}/${this.e.toISODate()}`:mt}toISOTime(e){return this.isValid?`${this.s.toISOTime(e)}/${this.e.toISOTime(e)}`:mt}toFormat(e,{separator:n=" – "}={}){return this.isValid?`${this.s.toFormat(e)}${n}${this.e.toFormat(e)}`:mt}toDuration(e,n){return this.isValid?this.e.diff(this.s,e,n):H.invalid(this.invalidReason)}mapEndpoints(e){return Z.fromDateTimes(e(this.s),e(this.e))}}class an{static hasDST(e=j.defaultZone){const n=D.now().setZone(e).set({month:12});return!e.isUniversal&&n.offset!==n.set({month:6}).offset}static isValidIANAZone(e){return ze.isValidZone(e)}static normalizeZone(e){return Xe(e,j.defaultZone)}static getStartOfWeek({locale:e=null,locObj:n=null}={}){return(n||z.create(e)).getStartOfWeek()}static getMinimumDaysInFirstWeek({locale:e=null,locObj:n=null}={}){return(n||z.create(e)).getMinDaysInFirstWeek()}static getWeekendWeekdays({locale:e=null,locObj:n=null}={}){return(n||z.create(e)).getWeekendDays().slice()}static months(e="long",{locale:n=null,numberingSystem:a=null,locObj:i=null,outputCalendar:s="gregory"}={}){return(i||z.create(n,a,s)).months(e)}static monthsFormat(e="long",{locale:n=null,numberingSystem:a=null,locObj:i=null,outputCalendar:s="gregory"}={}){return(i||z.create(n,a,s)).months(e,!0)}static weekdays(e="long",{locale:n=null,numberingSystem:a=null,locObj:i=null}={}){return(i||z.create(n,a,null)).weekdays(e)}static weekdaysFormat(e="long",{locale:n=null,numberingSystem:a=null,locObj:i=null}={}){return(i||z.create(n,a,null)).weekdays(e,!0)}static meridiems({locale:e=null}={}){return z.create(e).meridiems()}static eras(e="short",{locale:n=null}={}){return z.create(n,null,"gregory").eras(e)}static features(){return{relative:Yi(),localeWeek:Xi()}}}function Qa(t,e){const n=i=>i.toUTC(0,{keepLocalTime:!0}).startOf("day").valueOf(),a=n(e)-n(t);return Math.floor(H.fromMillis(a).as("days"))}function jo(t,e,n){const a=[["years",(c,u)=>u.year-c.year],["quarters",(c,u)=>u.quarter-c.quarter+(u.year-c.year)*4],["months",(c,u)=>u.month-c.month+(u.year-c.year)*12],["weeks",(c,u)=>{const d=Qa(c,u);return(d-d%7)/7}],["days",Qa]],i={},s=t;let r,l;for(const[c,u]of a)n.indexOf(c)>=0&&(r=c,i[c]=u(t,e),l=s.plus(i),l>e?(i[c]--,t=s.plus(i),t>e&&(l=t,i[c]--,t=s.plus(i))):t=l);return[t,i,l,r]}function qo(t,e,n,a){let[i,s,r,l]=jo(t,e,n);const c=e-i,u=n.filter(m=>["hours","minutes","seconds","milliseconds"].indexOf(m)>=0);u.length===0&&(r<e&&(r=i.plus({[l]:1})),r!==i&&(s[l]=(s[l]||0)+c/(r-i)));const d=H.fromObject(s,a);return u.length>0?H.fromMillis(c,a).shiftTo(...u).plus(d):d}const Ko="missing Intl.DateTimeFormat.formatToParts support";function W(t,e=n=>n){return{regex:t,deser:([n])=>e(Rs(n))}}const Yo=" ",gr=`[ ${Yo}]`,yr=new RegExp(gr,"g");function Xo(t){return t.replace(/\./g,"\\.?").replace(yr,gr)}function ei(t){return t.replace(/\./g,"").replace(yr," ").toLowerCase()}function Ie(t,e){return t===null?null:{regex:RegExp(t.map(Xo).join("|")),deser:([n])=>t.findIndex(a=>ei(n)===ei(a))+e}}function ti(t,e){return{regex:t,deser:([,n,a])=>Sn(n,a),groups:e}}function rn(t){return{regex:t,deser:([e])=>e}}function Qo(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function el(t,e){const n=Pe(e),a=Pe(e,"{2}"),i=Pe(e,"{3}"),s=Pe(e,"{4}"),r=Pe(e,"{6}"),l=Pe(e,"{1,2}"),c=Pe(e,"{1,3}"),u=Pe(e,"{1,6}"),d=Pe(e,"{1,9}"),m=Pe(e,"{2,4}"),p=Pe(e,"{4,6}"),f=w=>({regex:RegExp(Qo(w.val)),deser:([_])=>_,literal:!0}),v=(w=>{if(t.literal)return f(w);switch(w.val){case"G":return Ie(e.eras("short"),0);case"GG":return Ie(e.eras("long"),0);case"y":return W(u);case"yy":return W(m,na);case"yyyy":return W(s);case"yyyyy":return W(p);case"yyyyyy":return W(r);case"M":return W(l);case"MM":return W(a);case"MMM":return Ie(e.months("short",!0),1);case"MMMM":return Ie(e.months("long",!0),1);case"L":return W(l);case"LL":return W(a);case"LLL":return Ie(e.months("short",!1),1);case"LLLL":return Ie(e.months("long",!1),1);case"d":return W(l);case"dd":return W(a);case"o":return W(c);case"ooo":return W(i);case"HH":return W(a);case"H":return W(l);case"hh":return W(a);case"h":return W(l);case"mm":return W(a);case"m":return W(l);case"q":return W(l);case"qq":return W(a);case"s":return W(l);case"ss":return W(a);case"S":return W(c);case"SSS":return W(i);case"u":return rn(d);case"uu":return rn(l);case"uuu":return W(n);case"a":return Ie(e.meridiems(),0);case"kkkk":return W(s);case"kk":return W(m,na);case"W":return W(l);case"WW":return W(a);case"E":case"c":return W(n);case"EEE":return Ie(e.weekdays("short",!1),1);case"EEEE":return Ie(e.weekdays("long",!1),1);case"ccc":return Ie(e.weekdays("short",!0),1);case"cccc":return Ie(e.weekdays("long",!0),1);case"Z":case"ZZ":return ti(new RegExp(`([+-]${l.source})(?::(${a.source}))?`),2);case"ZZZ":return ti(new RegExp(`([+-]${l.source})(${a.source})?`),2);case"z":return rn(/[a-z_+-/]{1,256}?/i);case" ":return rn(/[^\S\n\r]/);default:return f(w)}})(t)||{invalidReason:Ko};return v.token=t,v}const tl={year:{"2-digit":"yy",numeric:"yyyyy"},month:{numeric:"M","2-digit":"MM",short:"MMM",long:"MMMM"},day:{numeric:"d","2-digit":"dd"},weekday:{short:"EEE",long:"EEEE"},dayperiod:"a",dayPeriod:"a",hour12:{numeric:"h","2-digit":"hh"},hour24:{numeric:"H","2-digit":"HH"},minute:{numeric:"m","2-digit":"mm"},second:{numeric:"s","2-digit":"ss"},timeZoneName:{long:"ZZZZZ",short:"ZZZ"}};function nl(t,e,n){const{type:a,value:i}=t;if(a==="literal"){const c=/^\s+$/.test(i);return{literal:!c,val:c?" ":i}}const s=e[a];let r=a;a==="hour"&&(e.hour12!=null?r=e.hour12?"hour12":"hour24":e.hourCycle!=null?e.hourCycle==="h11"||e.hourCycle==="h12"?r="hour12":r="hour24":r=n.hour12?"hour12":"hour24");let l=tl[r];if(typeof l=="object"&&(l=l[s]),l)return{literal:!1,val:l}}function al(t){return[`^${t.map(n=>n.regex).reduce((n,a)=>`${n}(${a.source})`,"")}$`,t]}function il(t,e,n){const a=t.match(e);if(a){const i={};let s=1;for(const r in n)if(Lt(n,r)){const l=n[r],c=l.groups?l.groups+1:1;!l.literal&&l.token&&(i[l.token.val[0]]=l.deser(a.slice(s,s+c))),s+=c}return[a,i]}else return[a,{}]}function rl(t){const e=s=>{switch(s){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":case"H":return"hour";case"d":return"day";case"o":return"ordinal";case"L":case"M":return"month";case"y":return"year";case"E":case"c":return"weekday";case"W":return"weekNumber";case"k":return"weekYear";case"q":return"quarter";default:return null}};let n=null,a;return O(t.z)||(n=ze.create(t.z)),O(t.Z)||(n||(n=new ue(t.Z)),a=t.Z),O(t.q)||(t.M=(t.q-1)*3+1),O(t.h)||(t.h<12&&t.a===1?t.h+=12:t.h===12&&t.a===0&&(t.h=0)),t.G===0&&t.y&&(t.y=-t.y),O(t.u)||(t.S=ma(t.u)),[Object.keys(t).reduce((s,r)=>{const l=e(r);return l&&(s[l]=t[r]),s},{}),n,a]}let Fn=null;function sl(){return Fn||(Fn=D.fromMillis(1555555555555)),Fn}function ol(t,e){if(t.literal)return t;const n=se.macroTokenToFormatOpts(t.val),a=Lr(n,e);return a==null||a.includes(void 0)?t:a}function wr(t,e){return Array.prototype.concat(...t.map(n=>ol(n,e)))}class _r{constructor(e,n){if(this.locale=e,this.format=n,this.tokens=wr(se.parseFormat(n),e),this.units=this.tokens.map(a=>el(a,e)),this.disqualifyingUnit=this.units.find(a=>a.invalidReason),!this.disqualifyingUnit){const[a,i]=al(this.units);this.regex=RegExp(a,"i"),this.handlers=i}}explainFromTokens(e){if(this.isValid){const[n,a]=il(e,this.regex,this.handlers),[i,s,r]=a?rl(a):[null,null,void 0];if(Lt(a,"a")&&Lt(a,"H"))throw new yt("Can't include meridiem when specifying 24-hour format");return{input:e,tokens:this.tokens,regex:this.regex,rawMatches:n,matches:a,result:i,zone:s,specificOffset:r}}else return{input:e,tokens:this.tokens,invalidReason:this.invalidReason}}get isValid(){return!this.disqualifyingUnit}get invalidReason(){return this.disqualifyingUnit?this.disqualifyingUnit.invalidReason:null}}function vr(t,e,n){return new _r(t,n).explainFromTokens(e)}function ll(t,e,n){const{result:a,zone:i,specificOffset:s,invalidReason:r}=vr(t,e,n);return[a,i,s,r]}function Lr(t,e){if(!t)return null;const a=se.create(e,t).dtFormatter(sl()),i=a.formatToParts(),s=a.resolvedOptions();return i.map(r=>nl(r,t,s))}const xn="Invalid DateTime",ni=864e13;function Nt(t){return new De("unsupported zone",`the zone "${t.name}" is not supported`)}function On(t){return t.weekData===null&&(t.weekData=pn(t.c)),t.weekData}function $n(t){return t.localWeekData===null&&(t.localWeekData=pn(t.c,t.loc.getMinDaysInFirstWeek(),t.loc.getStartOfWeek())),t.localWeekData}function it(t,e){const n={ts:t.ts,zone:t.zone,c:t.c,o:t.o,loc:t.loc,invalid:t.invalid};return new D({...n,...e,old:n})}function Mr(t,e,n){let a=t-e*60*1e3;const i=n.offset(a);if(e===i)return[a,e];a-=(i-e)*60*1e3;const s=n.offset(a);return i===s?[a,i]:[t-Math.min(i,s)*60*1e3,Math.max(i,s)]}function sn(t,e){t+=e*60*1e3;const n=new Date(t);return{year:n.getUTCFullYear(),month:n.getUTCMonth()+1,day:n.getUTCDate(),hour:n.getUTCHours(),minute:n.getUTCMinutes(),second:n.getUTCSeconds(),millisecond:n.getUTCMilliseconds()}}function cn(t,e,n){return Mr(Mn(t),e,n)}function ai(t,e){const n=t.o,a=t.c.year+Math.trunc(e.years),i=t.c.month+Math.trunc(e.months)+Math.trunc(e.quarters)*3,s={...t.c,year:a,month:i,day:Math.min(t.c.day,fn(a,i))+Math.trunc(e.days)+Math.trunc(e.weeks)*7},r=H.fromObject({years:e.years-Math.trunc(e.years),quarters:e.quarters-Math.trunc(e.quarters),months:e.months-Math.trunc(e.months),weeks:e.weeks-Math.trunc(e.weeks),days:e.days-Math.trunc(e.days),hours:e.hours,minutes:e.minutes,seconds:e.seconds,milliseconds:e.milliseconds}).as("milliseconds"),l=Mn(s);let[c,u]=Mr(l,n,t.zone);return r!==0&&(c+=r,u=t.zone.offset(c)),{ts:c,o:u}}function pt(t,e,n,a,i,s){const{setZone:r,zone:l}=n;if(t&&Object.keys(t).length!==0||e){const c=e||l,u=D.fromObject(t,{...n,zone:c,specificOffset:s});return r?u:u.setZone(l)}else return D.invalid(new De("unparsable",`the input "${i}" can't be parsed as ${a}`))}function on(t,e,n=!0){return t.isValid?se.create(z.create("en-US"),{allowZ:n,forceSimple:!0}).formatDateTimeFromString(t,e):null}function Rn(t,e){const n=t.c.year>9999||t.c.year<0;let a="";return n&&t.c.year>=0&&(a+="+"),a+=Q(t.c.year,n?6:4),e?(a+="-",a+=Q(t.c.month),a+="-",a+=Q(t.c.day)):(a+=Q(t.c.month),a+=Q(t.c.day)),a}function ii(t,e,n,a,i,s){let r=Q(t.c.hour);return e?(r+=":",r+=Q(t.c.minute),(t.c.millisecond!==0||t.c.second!==0||!n)&&(r+=":")):r+=Q(t.c.minute),(t.c.millisecond!==0||t.c.second!==0||!n)&&(r+=Q(t.c.second),(t.c.millisecond!==0||!a)&&(r+=".",r+=Q(t.c.millisecond,3))),i&&(t.isOffsetFixed&&t.offset===0&&!s?r+="Z":t.o<0?(r+="-",r+=Q(Math.trunc(-t.o/60)),r+=":",r+=Q(Math.trunc(-t.o%60))):(r+="+",r+=Q(Math.trunc(t.o/60)),r+=":",r+=Q(Math.trunc(t.o%60)))),s&&(r+="["+t.zone.ianaName+"]"),r}const Sr={month:1,day:1,hour:0,minute:0,second:0,millisecond:0},cl={weekNumber:1,weekday:1,hour:0,minute:0,second:0,millisecond:0},ul={ordinal:1,hour:0,minute:0,second:0,millisecond:0},br=["year","month","day","hour","minute","second","millisecond"],dl=["weekYear","weekNumber","weekday","hour","minute","second","millisecond"],hl=["year","ordinal","hour","minute","second","millisecond"];function ml(t){const e={year:"year",years:"year",month:"month",months:"month",day:"day",days:"day",hour:"hour",hours:"hour",minute:"minute",minutes:"minute",quarter:"quarter",quarters:"quarter",second:"second",seconds:"second",millisecond:"millisecond",milliseconds:"millisecond",weekday:"weekday",weekdays:"weekday",weeknumber:"weekNumber",weeksnumber:"weekNumber",weeknumbers:"weekNumber",weekyear:"weekYear",weekyears:"weekYear",ordinal:"ordinal"}[t.toLowerCase()];if(!e)throw new Si(t);return e}function ri(t){switch(t.toLowerCase()){case"localweekday":case"localweekdays":return"localWeekday";case"localweeknumber":case"localweeknumbers":return"localWeekNumber";case"localweekyear":case"localweekyears":return"localWeekYear";default:return ml(t)}}function pl(t){if(Ft===void 0&&(Ft=j.now()),t.type!=="iana")return t.offset(Ft);const e=t.name;let n=aa.get(e);return n===void 0&&(n=t.offset(Ft),aa.set(e,n)),n}function si(t,e){const n=Xe(e.zone,j.defaultZone);if(!n.isValid)return D.invalid(Nt(n));const a=z.fromObject(e);let i,s;if(O(t.year))i=j.now();else{for(const c of br)O(t[c])&&(t[c]=Sr[c]);const r=qi(t)||Ki(t);if(r)return D.invalid(r);const l=pl(n);[i,s]=cn(t,l,n)}return new D({ts:i,zone:n,loc:a,o:s})}function oi(t,e,n){const a=O(n.round)?!0:n.round,i=(r,l)=>(r=pa(r,a||n.calendary?0:2,!0),e.loc.clone(n).relFormatter(n).format(r,l)),s=r=>n.calendary?e.hasSame(t,r)?0:e.startOf(r).diff(t.startOf(r),r).get(r):e.diff(t,r).get(r);if(n.unit)return i(s(n.unit),n.unit);for(const r of n.units){const l=s(r);if(Math.abs(l)>=1)return i(l,r)}return i(t>e?-0:0,n.units[n.units.length-1])}function li(t){let e={},n;return t.length>0&&typeof t[t.length-1]=="object"?(e=t[t.length-1],n=Array.from(t).slice(0,t.length-1)):n=Array.from(t),[e,n]}let Ft;const aa=new Map;class D{constructor(e){const n=e.zone||j.defaultZone;let a=e.invalid||(Number.isNaN(e.ts)?new De("invalid input"):null)||(n.isValid?null:Nt(n));this.ts=O(e.ts)?j.now():e.ts;let i=null,s=null;if(!a)if(e.old&&e.old.ts===this.ts&&e.old.zone.equals(n))[i,s]=[e.old.c,e.old.o];else{const l=Qe(e.o)&&!e.old?e.o:n.offset(this.ts);i=sn(this.ts,l),a=Number.isNaN(i.year)?new De("invalid input"):null,i=a?null:i,s=a?null:l}this._zone=n,this.loc=e.loc||z.create(),this.invalid=a,this.weekData=null,this.localWeekData=null,this.c=i,this.o=s,this.isLuxonDateTime=!0}static now(){return new D({})}static local(){const[e,n]=li(arguments),[a,i,s,r,l,c,u]=n;return si({year:a,month:i,day:s,hour:r,minute:l,second:c,millisecond:u},e)}static utc(){const[e,n]=li(arguments),[a,i,s,r,l,c,u]=n;return e.zone=ue.utcInstance,si({year:a,month:i,day:s,hour:r,minute:l,second:c,millisecond:u},e)}static fromJSDate(e,n={}){const a=Bs(e)?e.valueOf():NaN;if(Number.isNaN(a))return D.invalid("invalid input");const i=Xe(n.zone,j.defaultZone);return i.isValid?new D({ts:a,zone:i,loc:z.fromObject(n)}):D.invalid(Nt(i))}static fromMillis(e,n={}){if(Qe(e))return e<-ni||e>ni?D.invalid("Timestamp out of range"):new D({ts:e,zone:Xe(n.zone,j.defaultZone),loc:z.fromObject(n)});throw new re(`fromMillis requires a numerical input, but received a ${typeof e} with value ${e}`)}static fromSeconds(e,n={}){if(Qe(e))return new D({ts:e*1e3,zone:Xe(n.zone,j.defaultZone),loc:z.fromObject(n)});throw new re("fromSeconds requires a numerical input")}static fromObject(e,n={}){e=e||{};const a=Xe(n.zone,j.defaultZone);if(!a.isValid)return D.invalid(Nt(a));const i=z.fromObject(n),s=gn(e,ri),{minDaysInFirstWeek:r,startOfWeek:l}=Ja(s,i),c=j.now(),u=O(n.specificOffset)?a.offset(c):n.specificOffset,d=!O(s.ordinal),m=!O(s.year),p=!O(s.month)||!O(s.day),f=m||p,y=s.weekYear||s.weekNumber;if((f||d)&&y)throw new yt("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(p&&d)throw new yt("Can't mix ordinal dates with month/day");const v=y||s.weekday&&!f;let w,_,M=sn(c,u);v?(w=dl,_=cl,M=pn(M,r,l)):d?(w=hl,_=ul,M=Nn(M)):(w=br,_=Sr);let b=!1;for(const F of w){const P=s[F];O(P)?b?s[F]=_[F]:s[F]=M[F]:b=!0}const S=v?Hs(s,r,l):d?Ws(s):qi(s),T=S||Ki(s);if(T)return D.invalid(T);const E=v?Ga(s,r,l):d?Va(s):s,[k,C]=cn(E,u,a),N=new D({ts:k,zone:a,o:C,loc:i});return s.weekday&&f&&e.weekday!==N.weekday?D.invalid("mismatched weekday",`you can't specify both a weekday of ${s.weekday} and a date of ${N.toISO()}`):N.isValid?N:D.invalid(N.invalid)}static fromISO(e,n={}){const[a,i]=No(e);return pt(a,i,n,"ISO 8601",e)}static fromRFC2822(e,n={}){const[a,i]=Fo(e);return pt(a,i,n,"RFC 2822",e)}static fromHTTP(e,n={}){const[a,i]=xo(e);return pt(a,i,n,"HTTP",n)}static fromFormat(e,n,a={}){if(O(e)||O(n))throw new re("fromFormat requires an input string and a format");const{locale:i=null,numberingSystem:s=null}=a,r=z.fromOpts({locale:i,numberingSystem:s,defaultToEN:!0}),[l,c,u,d]=ll(r,e,n);return d?D.invalid(d):pt(l,c,a,`format ${n}`,e,u)}static fromString(e,n,a={}){return D.fromFormat(e,n,a)}static fromSQL(e,n={}){const[a,i]=zo(e);return pt(a,i,n,"SQL",e)}static invalid(e,n=null){if(!e)throw new re("need to specify a reason the DateTime is invalid");const a=e instanceof De?e:new De(e,n);if(j.throwOnInvalid)throw new ps(a);return new D({invalid:a})}static isDateTime(e){return e&&e.isLuxonDateTime||!1}static parseFormatForOpts(e,n={}){const a=Lr(e,z.fromObject(n));return a?a.map(i=>i?i.val:null).join(""):null}static expandFormat(e,n={}){return wr(se.parseFormat(e),z.fromObject(n)).map(i=>i.val).join("")}static resetCache(){Ft=void 0,aa.clear()}get(e){return this[e]}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}get outputCalendar(){return this.isValid?this.loc.outputCalendar:null}get zone(){return this._zone}get zoneName(){return this.isValid?this.zone.name:null}get year(){return this.isValid?this.c.year:NaN}get quarter(){return this.isValid?Math.ceil(this.c.month/3):NaN}get month(){return this.isValid?this.c.month:NaN}get day(){return this.isValid?this.c.day:NaN}get hour(){return this.isValid?this.c.hour:NaN}get minute(){return this.isValid?this.c.minute:NaN}get second(){return this.isValid?this.c.second:NaN}get millisecond(){return this.isValid?this.c.millisecond:NaN}get weekYear(){return this.isValid?On(this).weekYear:NaN}get weekNumber(){return this.isValid?On(this).weekNumber:NaN}get weekday(){return this.isValid?On(this).weekday:NaN}get isWeekend(){return this.isValid&&this.loc.getWeekendDays().includes(this.weekday)}get localWeekday(){return this.isValid?$n(this).weekday:NaN}get localWeekNumber(){return this.isValid?$n(this).weekNumber:NaN}get localWeekYear(){return this.isValid?$n(this).weekYear:NaN}get ordinal(){return this.isValid?Nn(this.c).ordinal:NaN}get monthShort(){return this.isValid?an.months("short",{locObj:this.loc})[this.month-1]:null}get monthLong(){return this.isValid?an.months("long",{locObj:this.loc})[this.month-1]:null}get weekdayShort(){return this.isValid?an.weekdays("short",{locObj:this.loc})[this.weekday-1]:null}get weekdayLong(){return this.isValid?an.weekdays("long",{locObj:this.loc})[this.weekday-1]:null}get offset(){return this.isValid?+this.o:NaN}get offsetNameShort(){return this.isValid?this.zone.offsetName(this.ts,{format:"short",locale:this.locale}):null}get offsetNameLong(){return this.isValid?this.zone.offsetName(this.ts,{format:"long",locale:this.locale}):null}get isOffsetFixed(){return this.isValid?this.zone.isUniversal:null}get isInDST(){return this.isOffsetFixed?!1:this.offset>this.set({month:1,day:1}).offset||this.offset>this.set({month:5}).offset}getPossibleOffsets(){if(!this.isValid||this.isOffsetFixed)return[this];const e=864e5,n=6e4,a=Mn(this.c),i=this.zone.offset(a-e),s=this.zone.offset(a+e),r=this.zone.offset(a-i*n),l=this.zone.offset(a-s*n);if(r===l)return[this];const c=a-r*n,u=a-l*n,d=sn(c,r),m=sn(u,l);return d.hour===m.hour&&d.minute===m.minute&&d.second===m.second&&d.millisecond===m.millisecond?[it(this,{ts:c}),it(this,{ts:u})]:[this]}get isInLeapYear(){return Vt(this.year)}get daysInMonth(){return fn(this.year,this.month)}get daysInYear(){return this.isValid?_t(this.year):NaN}get weeksInWeekYear(){return this.isValid?Ut(this.weekYear):NaN}get weeksInLocalWeekYear(){return this.isValid?Ut(this.localWeekYear,this.loc.getMinDaysInFirstWeek(),this.loc.getStartOfWeek()):NaN}resolvedLocaleOptions(e={}){const{locale:n,numberingSystem:a,calendar:i}=se.create(this.loc.clone(e),e).resolvedOptions(this);return{locale:n,numberingSystem:a,outputCalendar:i}}toUTC(e=0,n={}){return this.setZone(ue.instance(e),n)}toLocal(){return this.setZone(j.defaultZone)}setZone(e,{keepLocalTime:n=!1,keepCalendarTime:a=!1}={}){if(e=Xe(e,j.defaultZone),e.equals(this.zone))return this;if(e.isValid){let i=this.ts;if(n||a){const s=e.offset(this.ts),r=this.toObject();[i]=cn(r,s,e)}return it(this,{ts:i,zone:e})}else return D.invalid(Nt(e))}reconfigure({locale:e,numberingSystem:n,outputCalendar:a}={}){const i=this.loc.clone({locale:e,numberingSystem:n,outputCalendar:a});return it(this,{loc:i})}setLocale(e){return this.reconfigure({locale:e})}set(e){if(!this.isValid)return this;const n=gn(e,ri),{minDaysInFirstWeek:a,startOfWeek:i}=Ja(n,this.loc),s=!O(n.weekYear)||!O(n.weekNumber)||!O(n.weekday),r=!O(n.ordinal),l=!O(n.year),c=!O(n.month)||!O(n.day),u=l||c,d=n.weekYear||n.weekNumber;if((u||r)&&d)throw new yt("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(c&&r)throw new yt("Can't mix ordinal dates with month/day");let m;s?m=Ga({...pn(this.c,a,i),...n},a,i):O(n.ordinal)?(m={...this.toObject(),...n},O(n.day)&&(m.day=Math.min(fn(m.year,m.month),m.day))):m=Va({...Nn(this.c),...n});const[p,f]=cn(m,this.o,this.zone);return it(this,{ts:p,o:f})}plus(e){if(!this.isValid)return this;const n=H.fromDurationLike(e);return it(this,ai(this,n))}minus(e){if(!this.isValid)return this;const n=H.fromDurationLike(e).negate();return it(this,ai(this,n))}startOf(e,{useLocaleWeeks:n=!1}={}){if(!this.isValid)return this;const a={},i=H.normalizeUnit(e);switch(i){case"years":a.month=1;case"quarters":case"months":a.day=1;case"weeks":case"days":a.hour=0;case"hours":a.minute=0;case"minutes":a.second=0;case"seconds":a.millisecond=0;break}if(i==="weeks")if(n){const s=this.loc.getStartOfWeek(),{weekday:r}=this;r<s&&(a.weekNumber=this.weekNumber-1),a.weekday=s}else a.weekday=1;if(i==="quarters"){const s=Math.ceil(this.month/3);a.month=(s-1)*3+1}return this.set(a)}endOf(e,n){return this.isValid?this.plus({[e]:1}).startOf(e,n).minus(1):this}toFormat(e,n={}){return this.isValid?se.create(this.loc.redefaultToEN(n)).formatDateTimeFromString(this,e):xn}toLocaleString(e=mn,n={}){return this.isValid?se.create(this.loc.clone(n),e).formatDateTime(this):xn}toLocaleParts(e={}){return this.isValid?se.create(this.loc.clone(e),e).formatDateTimeParts(this):[]}toISO({format:e="extended",suppressSeconds:n=!1,suppressMilliseconds:a=!1,includeOffset:i=!0,extendedZone:s=!1}={}){if(!this.isValid)return null;const r=e==="extended";let l=Rn(this,r);return l+="T",l+=ii(this,r,n,a,i,s),l}toISODate({format:e="extended"}={}){return this.isValid?Rn(this,e==="extended"):null}toISOWeekDate(){return on(this,"kkkk-'W'WW-c")}toISOTime({suppressMilliseconds:e=!1,suppressSeconds:n=!1,includeOffset:a=!0,includePrefix:i=!1,extendedZone:s=!1,format:r="extended"}={}){return this.isValid?(i?"T":"")+ii(this,r==="extended",n,e,a,s):null}toRFC2822(){return on(this,"EEE, dd LLL yyyy HH:mm:ss ZZZ",!1)}toHTTP(){return on(this.toUTC(),"EEE, dd LLL yyyy HH:mm:ss 'GMT'")}toSQLDate(){return this.isValid?Rn(this,!0):null}toSQLTime({includeOffset:e=!0,includeZone:n=!1,includeOffsetSpace:a=!0}={}){let i="HH:mm:ss.SSS";return(n||e)&&(a&&(i+=" "),n?i+="z":e&&(i+="ZZ")),on(this,i,!0)}toSQL(e={}){return this.isValid?`${this.toSQLDate()} ${this.toSQLTime(e)}`:null}toString(){return this.isValid?this.toISO():xn}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`DateTime { ts: ${this.toISO()}, zone: ${this.zone.name}, locale: ${this.locale} }`:`DateTime { Invalid, reason: ${this.invalidReason} }`}valueOf(){return this.toMillis()}toMillis(){return this.isValid?this.ts:NaN}toSeconds(){return this.isValid?this.ts/1e3:NaN}toUnixInteger(){return this.isValid?Math.floor(this.ts/1e3):NaN}toJSON(){return this.toISO()}toBSON(){return this.toJSDate()}toObject(e={}){if(!this.isValid)return{};const n={...this.c};return e.includeConfig&&(n.outputCalendar=this.outputCalendar,n.numberingSystem=this.loc.numberingSystem,n.locale=this.loc.locale),n}toJSDate(){return new Date(this.isValid?this.ts:NaN)}diff(e,n="milliseconds",a={}){if(!this.isValid||!e.isValid)return H.invalid("created by diffing an invalid DateTime");const i={locale:this.locale,numberingSystem:this.numberingSystem,...a},s=Gs(n).map(H.normalizeUnit),r=e.valueOf()>this.valueOf(),l=r?this:e,c=r?e:this,u=qo(l,c,s,i);return r?u.negate():u}diffNow(e="milliseconds",n={}){return this.diff(D.now(),e,n)}until(e){return this.isValid?Z.fromDateTimes(this,e):this}hasSame(e,n,a){if(!this.isValid)return!1;const i=e.valueOf(),s=this.setZone(e.zone,{keepLocalTime:!0});return s.startOf(n,a)<=i&&i<=s.endOf(n,a)}equals(e){return this.isValid&&e.isValid&&this.valueOf()===e.valueOf()&&this.zone.equals(e.zone)&&this.loc.equals(e.loc)}toRelative(e={}){if(!this.isValid)return null;const n=e.base||D.fromObject({},{zone:this.zone}),a=e.padding?this<n?-e.padding:e.padding:0;let i=["years","months","days","hours","minutes","seconds"],s=e.unit;return Array.isArray(e.unit)&&(i=e.unit,s=void 0),oi(n,this.plus(a),{...e,numeric:"always",units:i,unit:s})}toRelativeCalendar(e={}){return this.isValid?oi(e.base||D.fromObject({},{zone:this.zone}),this,{...e,numeric:"auto",units:["years","months","days"],calendary:!0}):null}static min(...e){if(!e.every(D.isDateTime))throw new re("min requires all arguments be DateTimes");return Za(e,n=>n.valueOf(),Math.min)}static max(...e){if(!e.every(D.isDateTime))throw new re("max requires all arguments be DateTimes");return Za(e,n=>n.valueOf(),Math.max)}static fromFormatExplain(e,n,a={}){const{locale:i=null,numberingSystem:s=null}=a,r=z.fromOpts({locale:i,numberingSystem:s,defaultToEN:!0});return vr(r,e,n)}static fromStringExplain(e,n,a={}){return D.fromFormatExplain(e,n,a)}static buildFormatParser(e,n={}){const{locale:a=null,numberingSystem:i=null}=n,s=z.fromOpts({locale:a,numberingSystem:i,defaultToEN:!0});return new _r(s,e)}static fromFormatParser(e,n,a={}){if(O(e)||O(n))throw new re("fromFormatParser requires an input string and a format parser");const{locale:i=null,numberingSystem:s=null}=a,r=z.fromOpts({locale:i,numberingSystem:s,defaultToEN:!0});if(!r.equals(n.locale))throw new re(`fromFormatParser called with a locale of ${r}, but the format parser was created for ${n.locale}`);const{result:l,zone:c,specificOffset:u,invalidReason:d}=n.explainFromTokens(e);return d?D.invalid(d):pt(l,c,a,`format ${n.format}`,e,u)}static get DATE_SHORT(){return mn}static get DATE_MED(){return bi}static get DATE_MED_WITH_WEEKDAY(){return ys}static get DATE_FULL(){return Ti}static get DATE_HUGE(){return ki}static get TIME_SIMPLE(){return Ei}static get TIME_WITH_SECONDS(){return Ci}static get TIME_WITH_SHORT_OFFSET(){return Ai}static get TIME_WITH_LONG_OFFSET(){return Pi}static get TIME_24_SIMPLE(){return Ii}static get TIME_24_WITH_SECONDS(){return Di}static get TIME_24_WITH_SHORT_OFFSET(){return Ni}static get TIME_24_WITH_LONG_OFFSET(){return Fi}static get DATETIME_SHORT(){return xi}static get DATETIME_SHORT_WITH_SECONDS(){return Oi}static get DATETIME_MED(){return $i}static get DATETIME_MED_WITH_SECONDS(){return Ri}static get DATETIME_MED_WITH_WEEKDAY(){return ws}static get DATETIME_FULL(){return Ui}static get DATETIME_FULL_WITH_SECONDS(){return Hi}static get DATETIME_HUGE(){return Wi}static get DATETIME_HUGE_WITH_SECONDS(){return zi}}function It(t){if(D.isDateTime(t))return t;if(t&&t.valueOf&&Qe(t.valueOf()))return D.fromJSDate(t);if(t&&typeof t=="object")return D.fromObject(t);throw new re(`Unknown datetime argument: ${t}, of type ${typeof t}`)}async function ct(t,e,n=null){return console.log("[weatherManager] Starting full weather fetch for location:",{lat:t,lng:e}),await gl(t,e),await fl(t,e,n)}async function fl(t,e,n=null){var i,s;const a=document.getElementById("loading");a&&(a.style.display="block");try{const r=((i=document.getElementById("modelSelect"))==null?void 0:i.value)||h.defaultSettings.model;if(!r)throw new Error("No weather model selected.");const c=yi.API_MAP[r]||r;let u=!1,d,m;const p=D.utc().startOf("day");let f=null;if(n){let b=D.fromISO(n,{zone:"utc"});b.isValid&&(f=b.startOf("day"),f<p&&(u=!0))}else{const b=(s=document.getElementById("historicalDatePicker"))==null?void 0:s.value;if(b){let S=D.fromISO(b,{zone:"utc"}).startOf("day");S<p&&(u=!0,f=S)}}let y=Rt.FORECAST;if(u&&f)y=Rt.HISTORICAL,d=m=f.toFormat("yyyy-MM-dd"),o.lastModelRun="N/A (Historical Data)";else{let b;try{const E=`https://api.open-meteo.com/data/${c}/static/meta.json`,C=await(await fetch(E)).json();b=new Date(C.last_run_initialisation_time*1e3),o.lastModelRun=b.toISOString().replace("T"," ").substring(0,17)+"Z"}catch{b=new Date,o.lastModelRun="N/A"}let S=D.fromJSDate(b).setZone("utc").plus({hours:6});S>D.utc()&&(S=D.utc()),d=S.toFormat("yyyy-MM-dd");const T=r.includes("_d2")?2:7;m=S.plus({days:T}).toFormat("yyyy-MM-dd")}const w=`${y}?latitude=${t}&longitude=${e}&hourly=surface_pressure,temperature_2m,relative_humidity_2m,wind_speed_10m,wind_direction_10m,wind_gusts_10m,temperature_1000hPa,relative_humidity_1000hPa,wind_speed_1000hPa,wind_direction_1000hPa,geopotential_height_1000hPa,temperature_950hPa,relative_humidity_950hPa,wind_speed_950hPa,wind_direction_950hPa,geopotential_height_950hPa,temperature_925hPa,relative_humidity_925hPa,wind_speed_925hPa,wind_direction_925hPa,geopotential_height_925hPa,temperature_900hPa,relative_humidity_900hPa,wind_speed_900hPa,wind_direction_900hPa,geopotential_height_900hPa,temperature_850hPa,relative_humidity_850hPa,wind_speed_850hPa,wind_direction_850hPa,geopotential_height_850hPa,temperature_800hPa,relative_humidity_800hPa,wind_speed_800hPa,wind_direction_800hPa,geopotential_height_800hPa,temperature_700hPa,relative_humidity_700hPa,wind_speed_700hPa,wind_direction_700hPa,geopotential_height_700hPa,temperature_600hPa,relative_humidity_600hPa,wind_speed_600hPa,wind_direction_600hPa,geopotential_height_600hPa,temperature_500hPa,relative_humidity_500hPa,wind_speed_500hPa,wind_direction_500hPa,geopotential_height_500hPa,temperature_400hPa,relative_humidity_400hPa,wind_speed_400hPa,wind_direction_400hPa,geopotential_height_400hPa,temperature_300hPa,relative_humidity_300hPa,wind_speed_300hPa,wind_direction_300hPa,geopotential_height_300hPa,temperature_250hPa,relative_humidity_250hPa,wind_speed_250hPa,wind_direction_250hPa,geopotential_height_250hPa,temperature_200hPa,relative_humidity_200hPa,wind_speed_200hPa,wind_direction_200hPa,geopotential_height_200hPa&models=${r}&start_date=${d}&end_date=${m}`,_=await fetch(w);if(!_.ok)throw new Error(`HTTP error! Status: ${_.status}`);const M=await _.json();if(!M.hourly||!M.hourly.time||!M.hourly.time.length)throw new Error("No hourly data in API response.");return M.hourly}catch(r){return console.error("[fetchWeather] Error:",r),Mt(`Failed to fetch weather: ${r.message}`),null}finally{a&&(a.style.display="none")}}async function gl(t,e){const n=yi.LIST;let a=[];for(const i of n)try{const s=await fetch(`${Rt.FORECAST}?latitude=${t}&longitude=${e}&hourly=temperature_2m&models=${i}`);if(s.ok){const r=await s.json();r.hourly&&r.hourly.temperature_2m&&r.hourly.temperature_2m.some(l=>l!==null)&&a.push(i)}else console.warn(`Modell '${i}' ist nicht verfügbar (Server-Antwort: ${s.status})`)}catch(s){console.error(`Netzwerkfehler beim Abruf von Modell '${i}':`,s)}return Ll(a),Ml(a),Sl(a),a}function ut(t){if(!o.weatherData||!o.weatherData.time||t>=o.weatherData.time.length)return console.warn("No weather data available for interpolation"),[];const e=Math.round(o.lastAltitude),n=parseInt(wi())||100,a=h.getValue("heightUnit","radio","m"),s=ds.filter(k=>{var N;const C=(N=o.weatherData[`geopotential_height_${k}hPa`])==null?void 0:N[t];return C!=null});if(s.length<2)return console.warn("Insufficient valid pressure level data for interpolation:",s),[];let r=s.map(k=>o.weatherData[`geopotential_height_${k}hPa`][t]),l=s.map(k=>o.weatherData[`temperature_${k}hPa`][t]),c=s.map(k=>o.weatherData[`relative_humidity_${k}hPa`][t]),u=s.map(k=>o.weatherData[`wind_speed_${k}hPa`][t]),d=s.map(k=>o.weatherData[`wind_direction_${k}hPa`][t]);const m=o.weatherData.surface_pressure[t];if(m==null)return console.warn("Surface pressure missing"),[];let p=u.map((k,C)=>-k*Math.sin(d[C]*Math.PI/180)),f=u.map((k,C)=>-k*Math.cos(d[C]*Math.PI/180));const y=Math.max(...s),v=o.weatherData[`geopotential_height_${y}hPa`][t];if(m>y&&Number.isFinite(v)&&v>e){const k=Math.floor((v-e)/n),C=-o.weatherData.wind_speed_10m[t]*Math.sin(o.weatherData.wind_direction_10m[t]*Math.PI/180),N=-o.weatherData.wind_speed_10m[t]*Math.cos(o.weatherData.wind_direction_10m[t]*Math.PI/180),F=p[s.indexOf(y)],P=f[s.indexOf(y)];for(let I=k-1;I>=1;I--){const x=e+I*n;if(x>=v)continue;const U=(x-e)/(v-e),q=Math.log(m),R=Math.log(y),te=q+U*(R-q),ne=Math.exp(te),K=Math.log(x-e+1),de=Math.log(1),J=Math.log(v-e),fe=g.linearInterpolate([de,J],[C,F],K),Ce=g.linearInterpolate([de,J],[N,P],K),Be=g.windSpeed(fe,Ce),Y=g.windDirection(fe,Ce);r.unshift(x),s.unshift(ne),l.unshift(g.linearInterpolate([e,v],[o.weatherData.temperature_2m[t],o.weatherData[`temperature_${y}hPa`][t]],x)),c.unshift(g.linearInterpolate([e,v],[o.weatherData.relative_humidity_2m[t],o.weatherData[`relative_humidity_${y}hPa`][t]],x)),u.unshift(Be),d.unshift(Y),p.unshift(fe),f.unshift(Ce)}r.unshift(e),s.unshift(m),l.unshift(o.weatherData.temperature_2m[t]),c.unshift(o.weatherData.relative_humidity_2m[t]),u.unshift(o.weatherData.wind_speed_10m[t]),d.unshift(o.weatherData.wind_direction_10m[t]),p.unshift(C),f.unshift(N)}const w=s.indexOf(Math.min(...s)),_=r[w],M=_-e;if(M<=0||isNaN(M))return console.warn("Invalid max height at lowest pressure level:",{maxHeightASL:_,baseHeight:e,minPressure:s[w]}),[];const b=a==="ft"?M*3.28084:M,S=Math.floor(b/n),T=Array.from({length:S+1},(k,C)=>C*n);console.log("Interpolating up to lowest pressure level:",{maxHeightAGL:M,minPressure:s[w],interpStep:n});const E=[];return T.forEach(k=>{const C=a==="ft"?k/3.28084:k,N=e+C;let F;if(C===0)F={height:N,pressure:m,temp:o.weatherData.temperature_2m[t],rh:o.weatherData.relative_humidity_2m[t],spd:o.weatherData.wind_speed_10m[t],dir:o.weatherData.wind_direction_10m[t],dew:g.calculateDewpoint(o.weatherData.temperature_2m[t],o.weatherData.relative_humidity_2m[t])};else{const P=g.interpolatePressure(N,s,r),I=g.interpolateWindAtAltitude(N,s,r,p,f),x=g.windSpeed(I.u,I.v),U=g.windDirection(I.u,I.v),q=g.linearInterpolate(r,l,N),R=g.linearInterpolate(r,c,N),te=g.calculateDewpoint(q,R);F={height:N,pressure:P==="N/A"?"N/A":Number(P.toFixed(1)),temp:Number(q.toFixed(1)),rh:Number(R.toFixed(0)),spd:Number(x.toFixed(1)),dir:Number(U.toFixed(0)),dew:Number(te.toFixed(1))}}F.displayHeight=k,E.push(F)}),console.log("Interpolated data length:",E.length,"Max height:",E[E.length-1].displayHeight),E}async function wa(){if(!o.lastLat||!o.lastLng){g.handleMessage("Please select a location first.");return}if(!h.state.userSettings.selectedEnsembleModels||h.state.userSettings.selectedEnsembleModels.length===0){o.ensembleModelsData=null,ot(),console.log("No ensemble models selected. Cleared ensemble data and visualizations.");return}const t=o.lastLat,e=o.lastLng,n=h.state.userSettings.selectedEnsembleModels;console.log(`Fetching ensemble weather data for models: ${n.join(", ")} at ${t}, ${e}`);const a=document.getElementById("loading");a&&(a.style.display="block");const i=n.join(","),s=["surface_pressure","temperature_2m","relative_humidity_2m","wind_speed_10m","wind_direction_10m","geopotential_height_1000hPa","temperature_1000hPa","relative_humidity_1000hPa","wind_speed_1000hPa","wind_direction_1000hPa","geopotential_height_950hPa","temperature_950hPa","relative_humidity_950hPa","wind_speed_950hPa","wind_direction_950hPa","geopotential_height_925hPa","temperature_925hPa","relative_humidity_925hPa","wind_speed_925hPa","wind_direction_925hPa","geopotential_height_900hPa","temperature_900hPa","relative_humidity_900hPa","wind_speed_900hPa","wind_direction_900hPa","geopotential_height_850hPa","temperature_850hPa","relative_humidity_850hPa","wind_speed_850hPa","wind_direction_850hPa","geopotential_height_800hPa","temperature_800hPa","relative_humidity_800hPa","wind_speed_800hPa","wind_direction_800hPa","geopotential_height_700hPa","temperature_700hPa","relative_humidity_700hPa","wind_speed_700hPa","wind_direction_700hPa","geopotential_height_600hPa","temperature_600hPa","relative_humidity_600hPa","wind_speed_600hPa","wind_direction_600hPa","geopotential_height_500hPa","temperature_500hPa","relative_humidity_500hPa","wind_speed_500hPa","wind_direction_500hPa","geopotential_height_400hPa","temperature_400hPa","relative_humidity_400hPa","wind_speed_400hPa","wind_direction_400hPa","geopotential_height_300hPa","temperature_300hPa","relative_humidity_300hPa","wind_speed_300hPa","wind_direction_300hPa","geopotential_height_250hPa","temperature_250hPa","relative_humidity_250hPa","wind_speed_250hPa","wind_direction_250hPa","geopotential_height_200hPa","temperature_200hPa","relative_humidity_200hPa","wind_speed_200hPa","wind_direction_200hPa"],r=s.join(","),l=document.getElementById("historicalDatePicker"),c=l?l.value:null,u=c?D.fromISO(c,{zone:"utc"}):null,d=D.utc().startOf("day"),m=u&&u<d;let p,f,y=Rt.FORECAST;if(m)y=Rt.HISTORICAL,p=u.toFormat("yyyy-MM-dd"),f=p;else{const w=D.utc();p=w.toFormat("yyyy-MM-dd"),f=w.plus({days:7}).toFormat("yyyy-MM-dd")}const v=`${y}?latitude=${t}&longitude=${e}&hourly=${r}&models=${i}&start_date=${p}&end_date=${f}`;console.log("Constructed ensemble URL:",v);try{const w=await fetch(v);if(!w.ok){const b=await w.text();throw new Error(`API request failed: ${w.status} - ${b}`)}const _=await w.json();if(console.log("Raw data from OpenMeteo for ensemble request:",JSON.stringify(_,null,2)),console.log("Models requested:",n),o.ensembleModelsData={},_.error&&_.reason)throw new Error(`API Error: ${_.reason}`);if(!_.hourly){let b='Unexpected data format: "hourly" field missing in API response.';throw _&&typeof _.latitude<"u"&&(b="Received metadata but no 'hourly' data for any requested ensemble model."),console.error(b,_),new Error(b)}const M=_.hourly.time;if(!M)throw new Error("Shared 'time' array missing in hourly data.");if(n.forEach(b=>{const S={time:[...M]};let T=!1;s.forEach(E=>{const k=`${E}_${b}`;_.hourly[k]?(S[E]=_.hourly[k],T=!0):n.length===1&&_.hourly[E]?(S[E]=_.hourly[E],T=!0):S[E]=null}),T?(o.ensembleModelsData[b]=S,console.log(`Successfully processed and stored data for model: ${b}`)):console.warn(`No data found for model ${b} with suffixed keys in the 'hourly' object. Available keys for this model might be missing or the model is unavailable for this specific request. Hourly keys in response:`,Object.keys(_.hourly))}),Object.keys(o.ensembleModelsData).length===0&&n.length>0){const b="Could not retrieve and process data for any of the selected ensemble models. They might be unavailable or the API response structure was not as expected for these models.";console.warn(b,"Original API response:",_),g.handleMessage(b)}else console.log("Ensemble weather data processed and stored in AppState.ensembleModelsData:",o.ensembleModelsData);yn()}catch(w){console.error("Error in fetchEnsembleWeatherData:",w),g.handleError(`Failed to fetch ensemble weather data: ${w.message}`),o.ensembleModelsData=null,ot()}finally{a&&(a.style.display="none")}}function ot(){o.ensembleLayerGroup&&o.map.removeLayer(o.ensembleLayerGroup),o.heatmapLayer&&o.map.removeLayer(o.heatmapLayer),o.heatmapLayer=null,o.ensembleScenarioCircles={},o.ensembleLayerGroup=L.layerGroup().addTo(o.map),console.log("Ensemble visualizations cleared and a new, clean layer group was created.")}function yn(){if(ot(),!o.ensembleModelsData||Object.keys(o.ensembleModelsData).length===0){console.log("No ensemble data to process."),h.state.userSettings.selectedEnsembleModels.length>0&&h.state.userSettings.currentEnsembleScenario!=="all_models"&&(g.handleMessage("Data for selected ensemble models not yet available. Fetching..."),wa());return}const t=h.state.userSettings.currentEnsembleScenario,e=Oe();if(console.log(`Processing ensemble scenario: ${t} for slider index: ${e}`),t==="heatmap")vl();else if(t==="all_models"){for(const n in o.ensembleModelsData)if(Object.hasOwnProperty.call(o.ensembleModelsData,n)){const i={hourly:o.ensembleModelsData[n]},s=ia(n,i);if(s){const r=yl(n);ci(s,r,n)}}}else{const n=_l(t);if(n){const a=ia(t,n);if(a){const i=wl(t);ci(a,i,t.replace("_"," "))}}else console.warn(`Could not calculate profile for scenario: ${t}`),g.handleMessage(`Could not generate '${t.replace("_"," ")}' profile. Not enough data?`)}}function yl(t){let e=0;for(let a=0;a<t.length;a++)e=t.charCodeAt(a)+((e<<5)-e),e=e&e;return`hsl(${e%360}, 70%, 60%)`}function wl(t){return t==="min_wind"?be.SCENARIO_COLORS.MIN_WIND:t==="mean_wind"?be.SCENARIO_COLORS.MEAN_WIND:t==="max_wind"?be.SCENARIO_COLORS.MAX_WIND:"rgba(128, 128, 128, 0.7)"}function ci(t,e,n){var v,w;if(!o.map||!t||!o.ensembleLayerGroup)return;const a=[t.centerLat,t.centerLng],i=L.circle(a,{radius:t.radius,color:e,fillColor:e,fillOpacity:.15,weight:2,dashArray:"5, 10"}).addTo(o.ensembleLayerGroup),s=h.getValue("windUnit","radio","kt");let r="N/A";if(t.meanWindSpeedMps!=="N/A"&&Number.isFinite(t.meanWindSpeedMps)){const _=g.convertWind(t.meanWindSpeedMps,s,"m/s");_!=="N/A"&&Number.isFinite(_)&&(r=s==="bft"?Math.round(_):_.toFixed(1))}const l=parseInt((v=document.getElementById("openingAltitude"))==null?void 0:v.value)||h.state.userSettings.openingAltitude||1200,c=parseInt((w=document.getElementById("legHeightDownwind"))==null?void 0:w.value)||h.state.userSettings.legHeightDownwind||0,u=l-200,d=h.getValue("heightUnit","radio","m"),m=Math.round(g.convertHeight(c,d)),p=Math.round(g.convertHeight(u,d)),f=t.meanWindDir!=="N/A"&&Number.isFinite(t.meanWindDir)?g.roundToTens(t.meanWindDir):"N/A",y=`<strong>${n}</strong><br>Mean Wind ${m}-${p} ${d} AGL:<br>${f}° ${r} ${s}`;i.bindTooltip(y,{permanent:!1,direction:"top",className:"wind-tooltip",opacity:.9}),o.ensembleScenarioCircles[n]=i,console.log(`Drew ensemble circle for ${n} at [${a.join(", ")}], radius ${t.radius}`)}function _l(t){var u;if(!o.ensembleModelsData||Object.keys(o.ensembleModelsData).length===0)return console.warn("No ensemble data available for profile calculation."),null;if(Object.keys(o.ensembleModelsData).length===0)return null;console.log(`Calculating full time-series ensemble profile for: ${t}`);const n={},a=Object.keys(o.ensembleModelsData)[0],i=(u=o.ensembleModelsData[a])==null?void 0:u.time;if(!i||i.length===0)return console.error("Time data missing or empty in the first ensemble model for profile calculation."),null;n.time=[...i];const s=n.time.length,r=["surface_pressure","temperature_2m","relative_humidity_2m","geopotential_height_1000hPa","temperature_1000hPa","relative_humidity_1000hPa","geopotential_height_950hPa","temperature_950hPa","relative_humidity_950hPa","geopotential_height_925hPa","temperature_925hPa","relative_humidity_925hPa","geopotential_height_900hPa","temperature_900hPa","relative_humidity_900hPa","geopotential_height_850hPa","temperature_850hPa","relative_humidity_850hPa","geopotential_height_800hPa","temperature_800hPa","relative_humidity_800hPa","geopotential_height_700hPa","temperature_700hPa","relative_humidity_700hPa","geopotential_height_600hPa","temperature_600hPa","relative_humidity_600hPa","geopotential_height_500hPa","temperature_500hPa","relative_humidity_500hPa","geopotential_height_400hPa","temperature_400hPa","relative_humidity_400hPa","geopotential_height_300hPa","temperature_300hPa","relative_humidity_300hPa","geopotential_height_250hPa","temperature_250hPa","relative_humidity_250hPa","geopotential_height_200hPa","temperature_200hPa","relative_humidity_200hPa"],l=[["wind_speed_10m","wind_direction_10m"]];[1e3,950,925,900,850,800,700,600,500,400,300,250,200].forEach(d=>{l.push([`wind_speed_${d}hPa`,`wind_direction_${d}hPa`])}),r.forEach(d=>{n[d]=new Array(s).fill(null)}),l.forEach(d=>{n[d[0]]=new Array(s).fill(null),n[d[1]]=new Array(s).fill(null)});for(let d=0;d<s;d++)r.forEach(m=>{const p=[];for(const f in o.ensembleModelsData){const y=o.ensembleModelsData[f];if(y&&y[m]){const v=y[m][d];v!=null&&!isNaN(v)&&p.push(v)}}p.length>0&&(t==="min_wind"?n[m][d]=Math.min(...p):t==="max_wind"?n[m][d]=Math.max(...p):n[m][d]=p.reduce((f,y)=>f+y,0)/p.length)}),l.forEach(m=>{const p=m[0],f=m[1];let y=[],v=[],w=[],_=[];for(const M in o.ensembleModelsData){const b=o.ensembleModelsData[M];if(b&&b[p]&&b[f]){const S=b[p][d],T=b[f][d];S!=null&&!isNaN(S)&&T!==null&&T!==void 0&&!isNaN(T)&&(w.push(S),_.push(T),y.push(-S*Math.sin(T*Math.PI/180)),v.push(-S*Math.cos(T*Math.PI/180)))}}if(w.length>0)if(t==="min_wind"){const M=Math.min(...w),b=w.indexOf(M);n[p][d]=M,n[f][d]=_[b]}else if(t==="max_wind"){const M=Math.max(...w),b=w.indexOf(M);n[p][d]=M,n[f][d]=_[b]}else{const M=y.reduce((S,T)=>S+T,0)/y.length,b=v.reduce((S,T)=>S+T,0)/v.length;n[p][d]=g.windSpeed(M,b),n[f][d]=g.windDirection(M,b)}});return{hourly:n}}function ia(t,e=null){var r,l;console.log(`Calculating exit circle for ensemble profile/model: ${t}`);let n;if(e)n=e;else if(o.ensembleModelsData&&o.ensembleModelsData[t])n={hourly:o.ensembleModelsData[t]};else return console.warn(`No data for profile/model ${t} in calculateExitCircleForEnsemble found.`),null;if(!n.hourly||!o.lastLat||!o.lastLng||o.lastAltitude==="N/A")return console.warn(`Incomplete data for calculateExitCircleForEnsemble: ${t}`),null;const a=o.weatherData;o.weatherData=n.hourly;let i=null,s={meanWindDir:"N/A",meanWindSpeedMps:"N/A"};try{const c=h.state.userSettings.calculateJump,u=h.state.userSettings.showExitArea;h.state.userSettings.calculateJump=!0,h.state.userSettings.showExitArea=!0;const d=Oe(),m=ut(d);if(i=Li(m),m&&m.length>0){const p=m.map(T=>T.height),f=m.map(T=>-g.convertWind(T.spd,"m/s","km/h")*Math.sin(T.dir*Math.PI/180)),y=m.map(T=>-g.convertWind(T.spd,"m/s","km/h")*Math.cos(T.dir*Math.PI/180)),v=parseInt((r=document.getElementById("openingAltitude"))==null?void 0:r.value)||1200,w=parseInt((l=document.getElementById("legHeightDownwind"))==null?void 0:l.value)||0,_=Math.round(o.lastAltitude),M=_+v-200,b=_+w,S=g.calculateMeanWind(p,f,y,b,M);S&&Number.isFinite(S[0])&&Number.isFinite(S[1])&&(s={meanWindDir:S[0],meanWindSpeedMps:S[1]})}h.state.userSettings.calculateJump=c,h.state.userSettings.showExitArea=u}catch(c){console.error(`Error in calculateExitCircle for profile ${t}:`,c),i=null}finally{o.weatherData=a}return i?{centerLat:i.darkGreenLat,centerLng:i.darkGreenLng,radius:i.darkGreenRadius,freeFallDirection:i.freeFallDirection,freeFallDistance:i.freeFallDistance,freeFallTime:i.freeFallTime,meanWindDir:s.meanWindDir,meanWindSpeedMps:s.meanWindSpeedMps,profileIdentifier:t}:(console.warn(`calculateExitCircle returned null for profile ${t}`),null)}function vl(){if(ot(),o.heatmapLayer&&(o.map.removeLayer(o.heatmapLayer),o.heatmapLayer=null),!o.ensembleModelsData||Object.keys(o.ensembleModelsData).length<2){g.handleMessage("Please select at least two ensemble models to generate a heatmap.");return}const t=[];for(const u in o.ensembleModelsData)if(Object.hasOwnProperty.call(o.ensembleModelsData,u)){const d=o.ensembleModelsData[u],m=ia(u,{hourly:d});m&&t.push({centerLat:m.centerLat,centerLng:m.centerLng,radius:m.radius})}if(t.length===0){console.warn("Could not calculate any circles for the heatmap.");return}console.log(`[Heatmap] Calculated ${t.length} model circles.`);let e=90,n=-90,a=180,i=-180;const s=111320;t.forEach(u=>{const d=u.radius/s,m=u.radius/(s*Math.cos(u.centerLat*Math.PI/180));e=Math.min(e,u.centerLat-d),n=Math.max(n,u.centerLat+d),a=Math.min(a,u.centerLng-m),i=Math.max(i,u.centerLng+m)});const r=40,l=r/s,c=[];console.log("[Heatmap] Starting grid calculation...");for(let u=e;u<=n;u+=l){const d=r/(s*Math.cos(u*Math.PI/180));for(let m=a;m<=i;m+=d){let p=0;const f=L.latLng(u,m);t.forEach(y=>{const v=L.latLng(y.centerLat,y.centerLng);o.map.distance(f,v)<=y.radius&&p++}),p>0&&c.push([u,m,p])}}if(console.log(`[Heatmap] Finished grid calculation. Generated ${c.length} heatmap points.`),c.length>0){const u=t.length,d={};if(u===1)d[1]="lime";else for(let p=1;p<=u;p++){const f=p/u;p===1?d[f]="red":p<u?d[f]="yellow":d[f]="lime"}console.log("[Heatmap] Using gradient:",d),o.heatmapLayer&&o.map.removeLayer(o.heatmapLayer);const m=g.calculateDynamicRadius(be.HEATMAP_BASE_RADIUS,be.HEATMAP_REFERENCE_ZOOM);o.heatmapLayer=L.heatLayer(c,{radius:m,blur:10,max:u,minOpacity:.01,gradient:d}).addTo(o.map)}else g.handleMessage("No overlapping landing areas found for the selected models.")}function Ht(){const t=window.innerWidth<Te.MOBILE_BREAKPOINT_PX;return console.log(`isMobileDevice check: window.innerWidth=${window.innerWidth}, isMobile=${t}`),t}function Se(t){console.log("displayMessage called with:",t);let e=document.getElementById("message");e||(e=document.createElement("div"),e.id="message",e.style.position="fixed",e.style.top="5px",e.style.right="5px",e.style.width=Ht()?"70%":"30%",e.style.backgroundColor="#ccffcc",e.style.borderRadius="5px 5px 5px 5px",e.style.color="#000000",e.style.padding="6px",e.style.zIndex="9998",e.style.textAlign="center",document.body.appendChild(e),window.addEventListener("resize",()=>{e.style.width=Ht()?"70%":"30%"})),e.textContent=t,e.style.display="block",clearTimeout(window.messageTimeout),window.messageTimeout=setTimeout(()=>{e.style.display="none"},Te.MESSAGE_TIMEOUT_MS)}function wn(t,e,n){const a=Math.round(t/e*100);let i=document.getElementById("progress");i||(i=document.createElement("div"),i.id="progress",i.style.position="fixed",i.style.top="5px",i.style.right="5px",i.style.width=Ht()?"70%":"30%",i.style.backgroundColor="#ccffcc",i.style.borderRadius="5px 5px 5px 5px",i.style.color="#000000",i.style.padding="6px",i.style.zIndex="9998",i.style.display="flex",i.style.alignItems="center",i.style.gap="10px",document.body.appendChild(i),window.addEventListener("resize",()=>{i.style.width=Ht()?"70%":"30%"}));const s=document.createElement("div");s.style.flex="1",s.style.display="flex",s.style.flexDirection="column",s.style.gap="3px";const r=document.createElement("div");r.textContent=`Caching (${t}/${e}, ${a}%)`,r.style.fontSize="12px",r.style.textAlign="center";const l=document.createElement("div");l.style.width="100%",l.style.height="8px",l.style.backgroundColor="#e0e0e0",l.style.borderRadius="3px",l.style.overflow="hidden";const c=document.createElement("div");c.style.width=`${a}%`,c.style.height="100%",c.style.backgroundColor="#4caf50",c.style.transition="width 0.3s ease-in-out",l.appendChild(c),s.appendChild(r),s.appendChild(l);let u=document.getElementById("cancel-caching");u||(u=document.createElement("button"),u.id="cancel-caching",u.textContent="Cancel",u.style.backgroundColor="#ff4444",u.style.color="#ffffff",u.style.border="none",u.style.borderRadius="3px",u.style.padding="5px 3px",u.style.cursor="pointer",u.style.fontSize="12px",u.addEventListener("click",()=>{n(),i.style.display="none",g.handleMessage("Caching cancelled.")})),i.innerHTML="",i.appendChild(s),i.appendChild(u),i.style.display="flex"}function Tr(){const t=document.getElementById("progress");t&&(t.style.display="none")}function ra(){console.log("updateOfflineIndicator called, navigator.onLine:",navigator.onLine);let t=document.getElementById("offline-indicator");t||(t=document.createElement("div"),t.id="offline-indicator",document.body.appendChild(t),console.log("Offline indicator created and appended")),t.style.display=navigator.onLine?"none":"block",t.textContent="Offline Mode"}function Mt(t){console.log("displayError called with:",t);let e=document.getElementById("error-message");e||(e=document.createElement("div"),e.id="error-message",document.body.appendChild(e),window.addEventListener("resize",()=>{e.style.width=Ht()?"70%":"30%"})),e.textContent=t,e.style.display="block",console.log("Error element state:",{display:e.style.display,text:e.textContent,position:e.style.position,zIndex:e.style.zIndex}),clearTimeout(window.errorTimeout),window.errorTimeout=setTimeout(()=>{e.style.display="none",console.log("Error hidden after 3s")},Te.MESSAGE_TIMEOUT_MS)}function Oe(){var t;return parseInt((t=document.getElementById("timeSlider"))==null?void 0:t.value)||0}function Ll(t){const e=document.getElementById("modelSelect");if(!e)return;const n=e.value;e.innerHTML="",t.forEach(a=>{const i=document.createElement("option");i.value=a,i.textContent=a.replace(/_/g," ").toUpperCase(),e.appendChild(i)}),t.includes(h.state.userSettings.model)?e.value=h.state.userSettings.model:t.includes(n)?e.value=n:t.length>0&&(e.value=t[0])}function Ml(t){const e=document.getElementById("ensembleModelsSubmenu");e&&(e.innerHTML="",t.forEach(n=>{const a=document.createElement("li"),i=document.createElement("label");i.className="radio-label";const s=document.createElement("input");s.type="checkbox",s.name="ensembleModel",s.value=n,s.checked=h.state.userSettings.selectedEnsembleModels.includes(n),s.addEventListener("change",()=>{const r=Array.from(e.querySelectorAll("input:checked")).map(l=>l.value);h.state.userSettings.selectedEnsembleModels=r,h.save(),wa()}),i.append(s,` ${n.replace(/_/g," ").toUpperCase()}`),a.appendChild(i),e.appendChild(a)}))}function Sl(t){let e=h.state.userSettings.selectedEnsembleModels||[],n=e.filter(a=>t.includes(a));e.length!==n.length&&(h.state.userSettings.selectedEnsembleModels=n,h.save())}const wt=65,me=73,Me=79;function kr(t,e){if(e=typeof e=="number"?e:5,!Array.isArray(t))throw new TypeError("forward did not receive an array");if(typeof t[0]=="string"||typeof t[1]=="string")throw new TypeError("forward received an array of strings, but it only accepts an array of numbers.");const[n,a]=t;if(n<-180||n>180)throw new TypeError("forward received an invalid longitude of "+n);if(a<-90||a>90)throw new TypeError("forward received an invalid latitude of "+a);if(a<-80||a>84)throw new TypeError(`forward received a latitude of ${a}, but this library does not support conversions of points in polar regions below 80°S and above 84°N`);return function(i,s){const r="00000"+i.easting,l="00000"+i.northing;return i.zoneNumber+i.zoneLetter+function(c,u,d){const m=Cr(d),p=Math.floor(c/1e5),f=Math.floor(u/1e5)%20;return function(y,v,w){const _=w-1,M="AJSAJS".charCodeAt(_),b="AFAFAF".charCodeAt(_);let S=M+y-1,T=b+v,E=!1;return S>90&&(S=S-90+wt-1,E=!0),(S===me||M<me&&S>me||(S>me||M<me)&&E)&&S++,(S===Me||M<Me&&S>Me||(S>Me||M<Me)&&E)&&(S++,S===me&&S++),S>90&&(S=S-90+wt-1),T>86?(T=T-86+wt-1,E=!0):E=!1,(T===me||b<me&&T>me||(T>me||b<me)&&E)&&T++,(T===Me||b<Me&&T>Me||(T>Me||b<Me)&&E)&&(T++,T===me&&T++),T>86&&(T=T-86+wt-1),String.fromCharCode(S)+String.fromCharCode(T)}(p,f,m)}(i.easting,i.northing,i.zoneNumber)+r.substr(r.length-5,s)+l.substr(l.length-5,s)}(function(i){const s=i.lat,r=i.lon,l=6378137,c=Un(s),u=Un(r);let d;d=Math.floor((r+180)/6)+1,r===180&&(d=60),s>=56&&s<64&&r>=3&&r<12&&(d=32),s>=72&&s<84&&(r>=0&&r<9?d=31:r>=9&&r<21?d=33:r>=21&&r<33?d=35:r>=33&&r<42&&(d=37));const m=Un(6*(d-1)-180+3),p=l/Math.sqrt(1-.00669438*Math.sin(c)*Math.sin(c)),f=Math.tan(c)*Math.tan(c),y=.006739496752268451*Math.cos(c)*Math.cos(c),v=Math.cos(c)*(u-m),w=l*(.9983242984503243*c-.002514607064228144*Math.sin(2*c)+2639046602129982e-21*Math.sin(4*c)-3418046101696858e-24*Math.sin(6*c)),_=.9996*p*(v+(1-f+y)*v*v*v/6+(5-18*f+f*f+72*y-.39089081163157013)*v*v*v*v*v/120)+5e5;let M=.9996*(w+p*Math.tan(c)*(v*v/2+(5-f+9*y+4*y*y)*v*v*v*v/24+(61-58*f+f*f+600*y-2.2240339282485886)*v*v*v*v*v*v/720));return s<0&&(M+=1e7),{northing:Math.trunc(M),easting:Math.trunc(_),zoneNumber:d,zoneLetter:Er(s)}}({lat:a,lon:n}),e)}function bl(t){const e=va(Ar(t.toUpperCase()));return typeof e.lat=="number"&&typeof e.lon=="number"?[e.lon,e.lat,e.lon,e.lat]:[e.left,e.bottom,e.right,e.top]}function _a(t){if(t==="")throw new TypeError("toPoint received a blank string");const e=va(Ar(t.toUpperCase()));return typeof e.lat=="number"&&typeof e.lon=="number"?[e.lon,e.lat]:[(e.left+e.right)/2,(e.top+e.bottom)/2]}function Un(t){return t*(Math.PI/180)}function ui(t){return t/Math.PI*180}function va(t){const e=t.northing,n=t.easting,{zoneLetter:a,zoneNumber:i}=t;if(i<0||i>60)return null;const s=6378137,r=(1-Math.sqrt(.99330562))/(1+Math.sqrt(.99330562)),l=n-5e5;let c=e;a<"N"&&(c-=1e7);const u=6*(i-1)-180+3,d=c/.9996/6367449145945056e-9,m=d+(3*r/2-27*r*r*r/32)*Math.sin(2*d)+(21*r*r/16-55*r*r*r*r/32)*Math.sin(4*d)+151*r*r*r/96*Math.sin(6*d),p=s/Math.sqrt(1-.00669438*Math.sin(m)*Math.sin(m)),f=Math.tan(m)*Math.tan(m),y=.006739496752268451*Math.cos(m)*Math.cos(m),v=.99330562*s/Math.pow(1-.00669438*Math.sin(m)*Math.sin(m),1.5),w=l/(.9996*p);let _=m-p*Math.tan(m)/v*(w*w/2-(5+3*f+10*y-4*y*y-.06065547077041606)*w*w*w*w/24+(61+90*f+298*y+45*f*f-1.6983531815716497-3*y*y)*w*w*w*w*w*w/720);_=ui(_);let M,b=(w-(1+2*f+y)*w*w*w/6+(5-2*y+28*f-3*y*y+.05391597401814761+24*f*f)*w*w*w*w*w/120)/Math.cos(m);if(b=u+ui(b),typeof t.accuracy=="number"){const S=va({northing:t.northing+t.accuracy,easting:t.easting+t.accuracy,zoneLetter:t.zoneLetter,zoneNumber:t.zoneNumber});M={top:S.lat,right:S.lon,bottom:_,left:b}}else M={lat:_,lon:b};return M}function Er(t){return t<=84&&t>=72?"X":t<72&&t>=-80?"CDEFGHJKLMNPQRSTUVWX"[Math.floor((t- -80)/8)]:t>84||t<-80?"Z":void 0}function Cr(t){let e=t%6;return e===0&&(e=6),e}function Ar(t){if(t&&t.length===0)throw new TypeError("MGRSPoint coverting from nothing");t=t.replace(/ /g,"");const{length:e}=t;let n,a=null,i="",s=0;for(;!/[A-Z]/.test(n=t.charAt(s));){if(s>=2)throw new Error("MGRSPoint bad conversion from: "+t);i+=n,s++}const r=parseInt(i,10);if(s===0||s+3>e)throw new Error("MGRSPoint bad conversion from "+t);const l=t.charAt(s++);if(l<="A"||l==="B"||l==="Y"||l>="Z"||l==="I"||l==="O")throw new Error(`MGRSPoint zone letter ${l} not handled: ${t}`);a=t.substring(s,s+=2);const c=Cr(r),u=function(M,b){let S="AJSAJS".charCodeAt(b-1),T=1e5,E=!1;for(;S!==M.charCodeAt(0);){if(S++,S===me&&S++,S===Me&&S++,S>90){if(E)throw new Error("Bad character: "+M);S=wt,E=!0}T+=1e5}return T}(a.charAt(0),c);let d=function(M,b){if(M>"V")throw new TypeError("MGRSPoint given invalid Northing "+M);let S="AFAFAF".charCodeAt(b-1),T=0,E=!1;for(;S!==M.charCodeAt(0);){if(S++,S===me&&S++,S===Me&&S++,S>86){if(E)throw new Error("Bad character: "+M);S=wt,E=!0}T+=1e5}return T}(a.charAt(1),c);for(;d<Tl(l);)d+=2e6;const m=e-s;if(m%2!=0)throw new Error(`MGRSPoint has to have an even number
of digits after the zone letter and two 100km letters - front
half for easting meters, second half for
northing meters `+t);const p=m/2;let f,y,v,w=0,_=0;return p>0&&(f=1e5/Math.pow(10,p),y=t.substring(s,s+p),w=parseFloat(y)*f,v=t.substring(s+p),_=parseFloat(v)*f),{easting:w+u,northing:_+d,zoneLetter:l,zoneNumber:r,accuracy:f}}function Tl(t){let e;switch(t){case"C":e=11e5;break;case"D":e=2e6;break;case"E":e=28e5;break;case"F":e=37e5;break;case"G":e=46e5;break;case"H":e=55e5;break;case"J":e=64e5;break;case"K":e=73e5;break;case"L":e=82e5;break;case"M":e=91e5;break;case"N":e=0;break;case"P":e=8e5;break;case"Q":e=17e5;break;case"R":e=26e5;break;case"S":e=35e5;break;case"T":e=44e5;break;case"U":e=53e5;break;case"V":e=62e5;break;case"W":e=7e6;break;case"X":e=79e5;break;default:e=-1}if(e>=0)return e;throw new TypeError("Invalid zone letter: "+t)}const kl=Object.freeze(Object.defineProperty({__proto__:null,forward:kr,getLetterDesignator:Er,inverse:bl,toPoint:_a},Symbol.toStringTag,{value:"Module"}));var $;let g=($=class{static formatTime(e){return D.fromISO(e,{zone:"UTC"}).toFormat("yyyy-MM-dd HHmm")+"Z"}static roundToTens(e){return Math.round(e/10)*10}static convertTemperature(e,n){const a=parseFloat(e);return isNaN(a)?"N/A":n==="°F"?a*9/5+32:a}static convertHeight(e,n){const a=parseFloat(e);return isNaN(a)?"N/A":n==="ft"?parseFloat((e*ie.METERS_TO_FEET).toFixed(0)):e}static convertWind(e,n,a="km/h"){if(e==null||isNaN(e))return"N/A";let i;switch(a){case"km/h":i=e;break;case"m/s":i=e*3.6;break;case"kt":i=e*ie.KNOTS_TO_KMH;break;case"mph":i=e*1.60934;break;case"bft":i=$.beaufortToKnots(e)*ie.KNOTS_TO_KMH;break;default:i=e;break}switch(n){case"km/h":return i;case"m/s":return i/3.6;case"kt":return i/ie.KNOTS_TO_KMH;case"mph":return i/1.60934;case"bft":return $.knotsToBeaufort(i/ie.KNOTS_TO_KMH);default:return i/ie.KNOTS_TO_KMH}}static knotsToBeaufort(e){const n=Na.KNOT_THRESHOLDS.findIndex(a=>e<a);return n===-1?12:n}static beaufortToKnots(e){return Na.BEAUFORT_THRESHOLDS[e]||63}static calculateDewpoint(e,n){const a=Qt.A_LIQUID,i=Qt.B_LIQUID,s=Qt.A_ICE,r=Qt.B_ICE;let l,c;return e>=0?(l=a*e/(i+e)+Math.log(n/100),c=i*l/(a-l)):(l=s*e/(r+e)+Math.log(n/100),c=r*l/(s-l)),isNaN(c)?null:c}static gaussianInterpolation(e,n,a,i,s){if(a===s)return e;if(i===s)return n;let r=1/Math.abs(a-s),l=1/Math.abs(i-s);return(r*e+l*n)/(r+l)}static interpolateWindAtAltitude(e,n,a,i,s){if(n.length!=a.length||n.length!=i.length||n.length!=s.length)return{u:"Invalid input",v:"Invalid input"};const r=n.map(m=>Math.log(m)),l=$.linearInterpolate(a,r,e);if(typeof l=="string"&&l.includes("error"))return{u:"Interpolation error",v:"Interpolation error"};const c=Math.exp(l),u=$.linearInterpolate(r,i,Math.log(c)),d=$.linearInterpolate(r,s,Math.log(c));return typeof u=="string"&&u.includes("error")||typeof d=="string"&&d.includes("error")?{u:"Interpolation error",v:"Interpolation error"}:{u,v:d}}static interpolatePressure(e,n,a){if(!n||!a||n.length!==a.length||n.length<2||e<a[0]||e>a[a.length-1])return"N/A";for(let i=0;i<a.length-1;i++)if(e>=a[i]&&e<=a[i+1]){const s=a[i],r=a[i+1],l=n[i],c=n[i+1];return l+(c-l)*(e-s)/(r-s)}return"N/A"}static linearInterpolate(e,n,a){if(!(e!=null&&e.length)||!(n!=null&&n.length)||e.length!==n.length)return"invalid input for linearInterpolate";let i=!1;e[1]>e[0]&&(n=[...n].reverse(),e=[...e].reverse(),i=!0);const s=e.length-1;try{if(a>e[0]||a<e[s]){let r,l;return a>e[0]?(r=(n[1]-n[0])/(e[1]-e[0]),l=n[1]-r*e[1]):(r=(n[s]-n[s-1])/(e[s]-e[s-1]),l=n[s]-r*e[s]),r*a+l}else{let r;for(r=1;r<=s&&!(a>=e[r]);r++);const l=(n[r]-n[r-1])/(e[r]-e[r-1]),c=n[r]-l*e[r];return l*a+c}}catch{return"interpolation error"}finally{i&&(n.reverse(),e.reverse())}}static windSpeed(e,n){return Math.sqrt(e*e+n*n)}static windDirection(e,n){return(Math.atan2(-e,-n)*180/Math.PI+360)%360}static calculateMeanWind(e,n,a,i,s){try{if(!e||!n||!a||e.length<2)throw new Error("Invalid input data for calculateMeanWind");const r=new Array(4);let l=[s],c=[Number($.linearInterpolate(e,n,s))],u=[Number($.linearInterpolate(e,a,s))];const d=Number($.linearInterpolate(e,n,i)),m=Number($.linearInterpolate(e,a,i));for(let _=0;_<e.length;_++)e[_]<s&&e[_]>i&&(l.push(e[_]),c.push(n[_]),u.push(a[_]));l.push(i),c.push(d),u.push(m);const p=l.map((_,M)=>M);p.sort((_,M)=>l[M]-l[_]),l=p.map(_=>l[_]),c=p.map(_=>c[_]),u=p.map(_=>u[_]);let f=0,y=0;for(let _=0;_<l.length-1;_++)f+=.5*(c[_]+c[_+1])*(l[_]-l[_+1]),y+=.5*(u[_]+u[_+1])*(l[_]-l[_+1]);const v=f/(l[0]-l[l.length-1]),w=y/(l[0]-l[l.length-1]);return r[2]=v,r[3]=w,r[1]=$.windSpeed(v,w),r[0]=$.windDirection(v,w),r}catch(r){return console.error("Error in calculateMeanWind:",r,{heights:e,xComponents:n,yComponents:a,lowerLimit:i,upperLimit:s}),$.handleError("Failed to calculate mean wind: "+r.message),null}}static async getLocationData(e,n){const a=`${e.toFixed(4)},${n.toFixed(4)}`;if($.locationCache.has(a))return $.locationCache.get(a);try{const i=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${e}&longitude=${n}&timezone=auto`);if(!i.ok)throw new Error(`Open-Meteo fetch failed: ${i.status}`);const s=await i.json(),r={timezone:s.timezone||"GMT",timezone_abbreviation:s.timezone_abbreviation||"GMT",elevation:s.elevation!==void 0?s.elevation:"N/A"};return $.locationCache.set(a,r),console.log(`Fetched location data for ${a}:`,r),r}catch(i){return console.error("Error fetching location data:",i.message),{timezone:"UTC",elevation:"N/A"}}}static async formatLocalTime(e,n,a){const{timezone:i,timezone_abbreviation:s}=await $.getLocationData(n,a);return D.fromISO(e,{zone:"UTC"}).setZone(i).toFormat("yyyy-MM-dd HHmm")+` ${s}`}static normalizeAngle(e){return(e%360+360)%360}static calculateWindAngle(e,n){let a=$.normalizeAngle(n-e);return a>180&&(a-=360),a}static calculateWindComponents(e,n){const a=n*(Math.PI/180),i=e*Math.sin(a),s=e*Math.cos(a);return{crosswind:i,headwind:s}}static calculateWCA(e,n){const i=Math.abs(Math.asin(e/n))*(180/Math.PI);return isNaN(i)?0:i}static calculateGroundSpeed(e,n){return e-n}static calculateCourseFromHeading(e,n,a,i){const s=$.calculateWindAngle(e,n),{crosswind:r,headwind:l}=$.calculateWindComponents(a,s),c=i*Math.sin(e*Math.PI/180),u=i*Math.cos(e*Math.PI/180),d=(n+180)%360,m=a*Math.sin(d*Math.PI/180),p=a*Math.cos(d*Math.PI/180),f=c+m,y=u+p,v=Math.atan2(f,y)*(180/Math.PI),w=$.normalizeAngle(v),_=Math.sqrt(f*f+y*y),M=$.calculateWCA(r,i)*(r<0?-1:1);return{trueCourse:Number(w.toFixed(2)),groundSpeed:Number(_.toFixed(2)),wca:Number(M.toFixed(2)),crosswind:Number(r.toFixed(2)),headwind:Number(l.toFixed(2))}}static calculateFlightParameters(e,n,a,i){const s=$.calculateWindAngle(e,n),{crosswind:r,headwind:l}=$.calculateWindComponents(a,s),c=$.calculateWCA(r,i),u=$.calculateGroundSpeed(i,l);return{crosswind:Number(r.toFixed(2)),headwind:Number(l.toFixed(2)),wca:Number(c.toFixed(2)),groundSpeed:Number(u.toFixed(2))}}static handleError(e,n=!0){n&&console.error(e),typeof Mt=="function"?Mt(e):(console.warn("Utils.js: displayError function is not available, logging to console only."),console.error("Error message:",e))}static dmsToDecimal(e,n,a,i){if(isNaN(e)||isNaN(n)||isNaN(a)||!i)throw console.warn("Invalid DMS inputs:",{deg:e,min:n,sec:a,dir:i}),new Error("Invalid DMS values");let s=e+n/60+a/3600;if((i==="S"||i==="W")&&(s=-s),isNaN(s))throw console.warn("DMS to decimal conversion failed:",{deg:e,min:n,sec:a,dir:i}),new Error("Failed to convert DMS to decimal");return s}static decimalToDms(e,n){if(isNaN(e)||e===null||e===void 0)throw console.warn("Invalid decimal value for DMS conversion:",e),new Error("Invalid coordinate for DMS conversion");const a=Math.abs(e),i=Math.floor(a),s=Math.floor((a-i)*60),r=(a-i)*3600-s*60,l=n?e>=0?"N":"S":e>=0?"E":"W";if(isNaN(i)||isNaN(s)||isNaN(r))throw console.warn("DMS calculation resulted in invalid values:",{deg:i,min:s,sec:r}),new Error("Failed to convert to DMS");return{deg:i,min:s,sec:r,dir:l}}static decimalToMgrs(e,n){try{return kr([n,e])}catch(a){return console.error("Error converting to MGRS:",a),"Invalid MGRS"}}static mgrsToDecimal(e){try{const[n,a]=_a(e);return{lat:a,lng:n}}catch(n){return console.error("Error converting MGRS to decimal:",n),null}}static convertCoords(e,n,a="Decimal"){if(e===null||n===null||e===void 0||n===void 0)return{lat:"N/A",lng:"N/A"};const i={Decimal:{lat:e.toFixed(6),lng:n.toFixed(6)},DMS:{lat:$.decimalToDms(e,!0),lng:$.decimalToDms(n,!1)},MGRS:$.decimalToMgrs(e,n)};switch(a){case"DMS":return i.DMS;case"MGRS":return{lat:i.MGRS,lng:i.MGRS};case"Decimal":default:return i.Decimal}}static calculateTAS(e,n){if(isNaN(e)||isNaN(n)||e<0||n<0)return console.warn("Invalid inputs for calculateTAS:",{ias:e,heightFt:n}),"N/A";const a=rt.LAPSE_RATE,i=rt.SEA_LEVEL_TEMP_KELVIN,s=rt.GRAVITY,r=rt.GAS_CONSTANT_AIR,l=ie.FEET_TO_METERS,c=n*l,u=i-a*c,d=u/i,m=1-a*c/i,p=s/(a*r)-1,f=Math.pow(m,p),y=e/Math.sqrt(f);return console.log("calculateTAS debug:",{ias:e,heightFt:n,heightM:c,tempAtAltitude:u,tempRatio:d,base:m,exponent:p,densityRatio:f,tas:y,tasRounded:Number(y.toFixed(2))}),Number(y.toFixed(2))}static calculateTASFromGroundSpeed(e,n,a,i,s){if(isNaN(e)||isNaN(n)||isNaN(a)||isNaN(i))return"N/A";const r=$.convertWind(e,"kt","m/s"),l=$.convertWind(n,"kt","m/s"),c=$.calculateWindAngle(i,a),{crosswind:u,headwind:d}=$.calculateWindComponents(l,c),m=r+d,p=$.calculateTAS(m,s);return Number(p.toFixed(1))}static handleMessage(e){const n=document.getElementById("info");n?(n.textContent=e,n.style.display="block",setTimeout(()=>{n.style.display="none"},3e3),console.log("Displayed message:",e)):(console.warn("Info div not found for handleMessage, using alert"),alert(e))}static calculateQFE(e,n,a,i=15){if(!e||n==="N/A"||a==="N/A"||isNaN(e)||isNaN(n)||isNaN(a))return"N/A";console.log("QFE reference elevation: ",a);const s=rt.GRAVITY,r=Da.MOLAR_MASS_AIR,l=Da.UNIVERSAL_GAS_CONSTANT,c=i+ie.CELSIUS_TO_KELVIN,u=rt.LAPSE_RATE,d=e*100,m=n-a,p=s*r/(l*u),f=d*Math.pow(1-u*m/c,p);console.log(e,n,a);const y=Math.round(f/100);return isNaN(y)?"N/A":y}static calculateNewCenter(e,n,a,i){const s=us,r=e*Math.PI/180,l=n*Math.PI/180,c=i*Math.PI/180,u=a/s,d=Math.asin(Math.sin(r)*Math.cos(u)+Math.cos(r)*Math.sin(u)*Math.cos(c)),m=l+Math.atan2(Math.sin(c)*Math.sin(u)*Math.cos(r),Math.cos(u)-Math.sin(r)*Math.sin(d)),p=d*180/Math.PI,y=(m*180/Math.PI+540)%360-180;return[p,y]}static debounce(e,n){let a;return function(...i){clearTimeout(a),a=setTimeout(()=>e.apply(this,i),n)}}static calculateBearing(e,n,a,i){const s=m=>m*Math.PI/180,r=m=>m*180/Math.PI,l=s(i-n),c=Math.sin(l)*Math.cos(s(a)),u=Math.cos(s(e))*Math.sin(s(a))-Math.sin(s(e))*Math.cos(s(a))*Math.cos(l);let d=r(Math.atan2(c,u));return d=(d+360)%360,d}static async getAltitude(e,n){const{elevation:a}=await $.getLocationData(e,n);return console.log("Fetched elevation from Open-Meteo:",a),a!=="N/A"?a:"N/A"}static getLastFullHourUTC(){const e=new Date,n=e.getUTCFullYear(),a=e.getUTCMonth(),i=e.getUTCDate(),s=e.getUTCHours(),r=new Date(Date.UTC(n,a,i,s,0,0));return console.log("Last full hour UTC:",r.toISOString()),r}static async getDisplayTime(e,n,a){var s;return(((s=document.querySelector('input[name="timeZone"]:checked'))==null?void 0:s.value)||"Z")==="Z"||!n||!a?$.formatTime(e):await $.formatLocalTime(e,n,a)}static calculateDynamicRadius(e=be.HEATMAP_SCALING_BASE,n=be.HEATMAP_REFERENCE_ZOOM){const a=o.map.getZoom(),i=be.HEATMAP_SCALING_BASE,s=Math.pow(i,a-n),r=e*s,l=be.HEATMAP_MIN_RADIUS_PX,c=be.HEATMAP_MAX_RADIUS_PX,u=Math.max(l,Math.min(c,r));return console.log("[calculateDynamicRadius] Calculated dynamic radius:",{currentZoom:a,baseRadius:e,scaleFactor:s,dynamicRadius:r,adjustedRadius:u}),u}static interpolateColor(e,n=0,a=3e3){const i=Math.min(Math.max((e-n)/(a-n),0),1);return e<0||isNaN(e)?"#808080":i<=.5?`rgb(255, ${Math.round(255*(i*2))}, 0)`:`rgb(${Math.round(255*(1-(i-.5)*2))}, 255, 0)`}static generateWindBarb(e,n,a=null){const i=Math.round(n),s=40,r=40,l=s/2,c=r/2,u=20,m=(typeof a=="number"&&!isNaN(a)?a>=0:!0)?-1:1;let p=Math.floor(i/50),f=i%50,y=Math.floor(f/10),v=Math.floor(f%10/5);i<5?(y=0,v=0):i<10&&v>0&&(v=1);let w=`<svg width="${s}" height="${r}" viewBox="0 0 ${s} ${r}">`;const _=e+180;w+=`<g transform="translate(${l}, ${c}) rotate(${_})">`,w+=`<line x1="0" y1="${u/2}" x2="0" y2="${-u/2}" stroke="black" stroke-width="1"/>`;let M=u/2;const b=4;for(let S=0;S<p;S++)w+=`<polygon points="0,${M-5} 0,${M+5} ${10*m},${M}" fill="black"/>`,M-=b+5;for(let S=0;S<y;S++)w+=`<line x1="0" y1="${M}" x2="${10*m}" y2="${M}" stroke="black" stroke-width="1"/>`,M-=b;return v>0&&(w+=`<line x1="0" y1="${M}" x2="${5*m}" y2="${M}" stroke="black" stroke-width="1"/>`),i<5&&(w+='<circle cx="0" cy="0" r="3" fill="none" stroke="black" stroke-width="1"/>'),w+="</g></svg>",w}},Pa($,"locationCache",new Map),$);window.Utils=g;const oe={dbName:"SkydivingTileCache",storeName:"tiles",db:null,async init(){return new Promise((t,e)=>{const n=indexedDB.open(this.dbName,1);n.onupgradeneeded=a=>{a.target.result.createObjectStore(this.storeName,{keyPath:"url"})},n.onsuccess=a=>{this.db=a.target.result,t()},n.onerror=a=>{console.error("IndexedDB initialization failed:",a),e(a)}})},async storeTile(t,e){return this.db||await this.init(),new Promise((n,a)=>{const r=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).put({url:t,blob:e,timestamp:Date.now()});r.onsuccess=()=>{console.log(`Stored tile: ${t}`),n(!0)},r.onerror=l=>{console.warn(`Failed to store tile: ${t}`,l),g.handleError("Failed to store some tiles. Try clearing cache."),a(l)}})},async getTile(t){return this.db||await this.init(),new Promise((e,n)=>{const i=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName),s=i.get(t);s.onsuccess=r=>{const l=r.target.result;if(l)e(l.blob);else{const c=[t.replace("https://tile.opentopomap.org","https://a.tile.opentopomap.org"),t.replace("https://tile.opentopomap.org","https://b.tile.opentopomap.org"),t.replace("https://tile.opentopomap.org","https://c.tile.opentopomap.org"),t.replace("https://tile.openstreetmap.org","https://a.tile.openstreetmap.org"),t.replace("https://tile.openstreetmap.org","https://b.tile.openstreetmap.org"),t.replace("https://tile.openstreetmap.org","https://c.tile.openstreetmap.org"),t.replace("https://basemaps.cartocdn.com","https://a.basemaps.cartocdn.com"),t.replace("https://basemaps.cartocdn.com","https://b.basemaps.cartocdn.com"),t.replace("https://basemaps.cartocdn.com","https://c.basemaps.cartocdn.com"),t.replace("https://basemaps.cartocdn.com","https://d.basemaps.cartocdn.com")];let u=null;for(const d of c){if(d===t)continue;const m=i.get(d);m.onsuccess=p=>{const f=p.target.result;f&&(u=f.blob,e(u))},m.onerror=()=>{}}setTimeout(()=>{u||e(null)},100)}},s.onerror=r=>{console.warn(`Failed to retrieve tile: ${t}`,r),n(r)}})},async clearCache(){return this.db||await this.init(),new Promise((t,e)=>{const i=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();i.onsuccess=()=>{console.log("Tile cache cleared"),t()},i.onerror=s=>{console.error("Failed to clear cache:",s),e(s)}})},async clearOldTiles(t=Bt.MAX_AGE_DAYS){this.db||await this.init();const e=t*24*60*60*1e3;return new Promise((n,a)=>{const r=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).openCursor();let l=0,c=0;r.onsuccess=u=>{const d=u.target.result;if(d)Date.now()-d.value.timestamp>e&&(c+=d.value.blob.size||0,d.delete(),l++),d.continue();else{const m=c/1048576;console.log(`Cleared ${l} old tiles, freed ${m.toFixed(2)} MB`),n({deletedCount:l,deletedSizeMB:m})}},r.onerror=u=>{console.error("Failed to clear old tiles:",u),a(u)}})},async getCacheSize(){return this.db||await this.init(),new Promise((t,e)=>{const i=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).openCursor();let s=0,r=0;i.onsuccess=l=>{var u;const c=l.target.result;if(c)try{const d=((u=c.value.blob)==null?void 0:u.size)||0;typeof d!="number"||isNaN(d)?console.warn(`Invalid blob size for tile: ${c.value.url}, size: ${d}`):(s+=d,r++),c.continue()}catch(d){console.warn(`Error processing tile during size calculation: ${c.value.url}`,d),c.continue()}else{const d=s/1048576;console.log(`Cache size calculation completed: ${d.toFixed(2)} MB, ${r} tiles`),t(d)}},i.onerror=l=>{console.error("Failed to calculate cache size:",l),e(l)}})},async migrateTiles(){return this.db||await this.init(),new Promise((t,e)=>{const a=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName),i=a.openCursor();let s=0;i.onsuccess=r=>{const l=r.target.result;if(l){const{url:c,blob:u,timestamp:d}=l.value,m=c.replace(/^(https?:\/\/[a-c]\.tile\.openstreetmap\.org)/,"https://tile.openstreetmap.org").replace(/^(https?:\/\/[a-d]\.basemaps\.cartocdn\.com)/,"https://basemaps.cartocdn.com").replace(/^(https?:\/\/[a-c]\.tile\.opentopomap\.org)/,"https://tile.opentopomap.org");c!==m&&(l.delete(),a.put({url:m,blob:u,timestamp:d}),s++),l.continue()}else console.log(`Migrated ${s} tiles to normalized URLs`),t()},i.onerror=r=>{console.error("Failed to migrate tiles:",r),e(r)}})}};L.TileLayer.Cached=L.TileLayer.extend({createTile(t,e){const n=document.createElement("img");L.DomEvent.on(n,"load",()=>{console.log("Tile loaded:",this.getTileUrl(t)),e(null,n)}),L.DomEvent.on(n,"error",()=>{console.warn("Tile error:",this.getTileUrl(t)),e(new Error("Failed to load tile"),n)});const a=this.getTileUrl(t);n.setAttribute("role","presentation");const i=a.replace(/^(https?:\/\/[a-c]\.tile\.openstreetmap\.org)/,"https://tile.openstreetmap.org").replace(/^(https?:\/\/[a-d]\.basemaps\.cartocdn\.com)/,"https://basemaps.cartocdn.com").replace(/^(https?:\/\/[a-c]\.tile\.opentopomap\.org)/,"https://tile.opentopomap.org");return!navigator.onLine&&(t.z<11||t.z>14)?(console.log(`Skipping tile request outside cached zoom levels (11–14): ${a}`),g.handleError("Offline: Zoom restricted to levels 11–14 for cached tiles."),e(new Error("Zoom level not cached"),n),n):(navigator.onLine?(n.src=a,fetch(a,{signal:AbortSignal.timeout(Bt.FETCH_TIMEOUT_MS)}).then(s=>{if(!s.ok)throw new Error(`HTTP ${s.status}`);return s.blob()}).then(s=>{oe.storeTile(i,s).catch(r=>console.warn("Failed to cache tile during rendering:",i,r))}).catch(s=>{console.warn("Fetch error for tile during rendering:",a,s),oe.getTile(i).then(r=>{r?(n.src=URL.createObjectURL(r),console.log(`Tile loaded from cache (fallback): ${i}`)):e(s,n)}).catch(r=>{console.warn("Cache fallback error:",i,r),e(r,n)})})):oe.getTile(i).then(s=>{s?(n.src=URL.createObjectURL(s),console.log(`Tile loaded from cache: ${i}`)):(console.warn(`Tile not in cache: ${i}`),g.handleError("This area is not cached. Please cache more tiles while online."),e(new Error("Tile not in cache"),n))}).catch(s=>{console.warn("Cache error for offline tile:",i,s),g.handleError("This area is not cached. Please cache more tiles while online."),e(s,n)}),n)}});L.tileLayer.cached=function(t,e){return new L.TileLayer.Cached(t,e)};function El(t,e,n,a,i){if(!i)return console.warn("Map not initialized, cannot calculate tiles"),[];const s=new Set,r=40075016686e-3,l=n*1e3;return a.forEach(c=>{const u=i.project([t,e],c),d=256,m=u.x/d,p=u.y/d,f=t*Math.PI/180,y=r*Math.cos(f)/(d*Math.pow(2,c)),v=Math.ceil(l/(y*d))+1,w=Math.pow(2,c);for(let _=Math.floor(m-v);_<=Math.ceil(m+v);_++)for(let M=Math.floor(p-v);M<=Math.ceil(p+v);M++)_>=0&&_<w&&M>=0&&M<w&&s.add(`${c}/${_}/${M}`)}),Array.from(s).map(c=>{const[u,d,m]=c.split("/").map(Number);return{zoom:u,x:d,y:m}})}async function Pr(t,e=3){let n=null;for(let a=1;a<=e;a++){try{const i=new AbortController,s=setTimeout(()=>i.abort(),Bt.FETCH_TIMEOUT_MS),r=await fetch(t,{signal:i.signal});if(clearTimeout(s),r.ok)return{success:!0,blob:await r.blob()};console.warn(`Attempt ${a} failed for ${t}: HTTP ${r.status}`),n=new Error(`HTTP ${r.status}`)}catch(i){console.warn(`Attempt ${a} error for ${t}: ${i.message}`),n=i,i.name==="AbortError"&&console.warn(`Fetch timeout after 15s for ${t}`)}a<e&&await new Promise(i=>setTimeout(i,1e3))}return{success:!1,error:n}}async function Cl({map:t,lastLat:e,lastLng:n,baseMaps:a}){if(!t){console.warn("Map not initialized, cannot cache tiles"),Se("Map not initialized, cannot cache tiles.");return}if(console.log("cacheTilesForDIP called with:",{lastLat:e,lastLng:n,cacheRadiusKm:h.state.userSettings.cacheRadiusKm,cacheZoomLevels:h.state.userSettings.cacheZoomLevels}),!e||!n){console.warn("No DIP coordinates for caching, skipping"),Se("Please select a location to cache map tiles.");return}if(!h.state.userSettings.baseMaps||!a[h.state.userSettings.baseMaps]){console.warn(`Base map ${h.state.userSettings.baseMaps} not found, skipping caching`),Se("Selected base map not available for caching.");return}const i=h.state.userSettings.cacheRadiusKm||h.defaultSettings.cacheRadiusKm,s=h.state.userSettings.cacheZoomLevels||h.defaultSettings.cacheZoomLevels,r=El(e,n,i,s,t);console.log(`Caching ${r.length} tiles for DIP:`,{lat:e,lng:n,radiusKm:i,zoomLevels:s,baseMap:h.state.userSettings.baseMaps});const l=[];if(h.state.userSettings.baseMaps==="Esri Satellite + OSM")l.push({name:"Esri Satellite",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",normalizedUrl:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"},{name:"OSM Overlay",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",subdomains:["a","b","c"],normalizedUrl:"https://tile.openstreetmap.org/{z}/{x}/{y}.png"});else{const p=a[h.state.userSettings.baseMaps];l.push({name:h.state.userSettings.baseMaps,url:p.options.url||p._url,subdomains:p.options.subdomains,normalizedUrl:(p.options.url||p._url).replace(/{s}\./,"")})}let c=0,u=0;const d=r.length*l.length,m=[];o.isCachingCancelled=!1,console.log("Calling displayProgress with initial values:",{cachedCount:c,failedCount:u,totalTiles:d}),wn(c+u,d,()=>{o.isCachingCancelled=!0});try{for(const p of l){if(console.log("Processing layer:",p.name),o.isCachingCancelled){console.log("Caching cancelled by user");break}const f=r.map(async(y,v)=>{if(o.isCachingCancelled){console.log("Caching cancelled during tile processing");return}const w=p.url.replace("{z}",y.zoom).replace("{x}",y.x).replace("{y}",y.y).replace("{s}",p.subdomains?p.subdomains[Math.floor(Math.random()*p.subdomains.length)]:""),_=p.normalizedUrl.replace("{z}",y.zoom).replace("{x}",y.x).replace("{y}",y.y);if(console.log(`Processing tile ${v+1}/${r.length} for layer ${p.name}:`,{url:w,normalizedUrl:_}),await oe.getTile(_).catch(S=>(console.error(`Error retrieving tile from cache: ${_}`,S),null)))c++,console.log(`Tile ${v+1} already in cache`);else{const S=await Pr(w);S.success?await oe.storeTile(_,S.blob).catch(E=>(console.error(`Error storing tile: ${_}`,E),!1))?(c++,console.log(`Tile ${v+1} cached successfully`)):(u++,m.push(w),console.log(`Tile ${v+1} failed to store`)):(u++,m.push(w),console.log(`Tile ${v+1} failed to fetch:`,S.error.message))}const b=c+u;((v+1)%10===0||v===r.length-1)&&(console.log("Updating progress:",{currentCount:b,totalTiles:d}),wn(b,d,()=>{o.isCachingCancelled=!0}))});console.log(`Processing batch of ${r.length} tiles for layer ${p.name}`);for(let y=0;y<f.length;y+=20){if(o.isCachingCancelled){console.log("Caching cancelled during batch processing");break}const v=f.slice(y,y+20);await Promise.all(v).catch(w=>{console.error("Error processing batch of tiles:",w)}),console.log(`Completed batch ${y/20+1} for layer ${p.name}`)}}}catch(p){console.error("Unexpected error in cacheTilesForDIP:",p),g.handleError("Failed to cache map tiles: "+p.message)}finally{console.log("Hiding progress bar"),Tr()}m.length>0&&console.warn(`Failed to cache ${m.length} tiles:`,m),console.log(`DIP caching complete: ${c} tiles cached, ${u} failed`),o.isCachingCancelled?Se(`Caching cancelled: ${c} tiles cached, ${u} failed.`):u>0?Se(`Cached ${c} tiles around DIP (${u} failed). Pan or zoom to cache more tiles.`):Se(`Cached ${c} tiles around DIP successfully.`);try{const p=await oe.getCacheSize();console.log(`Cache size after DIP caching: ${p.toFixed(2)} MB`),p>Bt.SIZE_LIMIT_MB_WARNING&&g.handleError(`Cache size large (${p.toFixed(2)} MB). Consider clearing cache to free up space.`)}catch(p){console.error("Failed to check cache size after DIP caching:",p),g.handleError("Unable to check cache size. Consider clearing cache to free up space.")}}g.debounce(async({map:t,baseMaps:e})=>{if(!t||!navigator.onLine){console.log("Skipping visible tile caching: offline or map not initialized");return}const n=t.getBounds(),a=t.getZoom(),i=h.state.userSettings.cacheZoomLevels||h.defaultSettings.cacheZoomLevels;if(!i.includes(a)){console.log(`Skipping caching: zoom ${a} not in cacheZoomLevels`,i);return}const s=256,r=t.project(n.getSouthWest(),a),l=t.project(n.getNorthEast(),a),c=Math.floor(r.x/s),u=Math.floor(l.x/s),d=Math.floor(l.y/s),m=Math.floor(r.y/s),p=[];for(let M=c;M<=u;M++)for(let b=d;b<=m;b++){const S=2**a;M>=0&&M<S&&b>=0&&b<S&&p.push({zoom:a,x:M,y:b})}console.log(`Caching ${p.length} visible tiles at zoom ${a} for ${h.state.userSettings.baseMaps}`);const f=[];if(!e[h.state.userSettings.baseMaps]){console.warn(`Base map ${h.state.userSettings.baseMaps} not found, skipping caching`),Se("Selected base map not available for caching.");return}if(h.state.userSettings.baseMaps==="Esri Satellite + OSM")f.push({name:"Esri Satellite",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",normalizedUrl:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"},{name:"OSM Overlay",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",subdomains:["a","b","c"],normalizedUrl:"https://tile.openstreetmap.org/{z}/{x}/{y}.png"});else{const M=e[h.state.userSettings.baseMaps];f.push({name:h.state.userSettings.baseMaps,url:M.options.url||M._url,subdomains:M.options.subdomains,normalizedUrl:(M.options.url||M._url).replace(/{s}\./,"")})}let y=0,v=0;const w=p.length*f.length,_=[];o.isCachingCancelled=!1,wn(y+v,w,()=>{o.isCachingCancelled=!0});for(const M of f){if(o.isCachingCancelled){console.log("Visible tile caching cancelled by user");break}const b=p.map(async(S,T)=>{if(o.isCachingCancelled)return;const E=M.url.replace("{z}",S.zoom).replace("{x}",S.x).replace("{y}",S.y).replace("{s}",M.subdomains?M.subdomains[Math.floor(Math.random()*M.subdomains.length)]:""),k=M.normalizedUrl.replace("{z}",S.zoom).replace("{x}",S.x).replace("{y}",S.y);if(await oe.getTile(k).catch(()=>null))y++;else{const F=await Pr(E);F.success&&await oe.storeTile(k,F.blob).catch(()=>!1)?y++:(v++,_.push(E))}const N=y+v;((T+1)%10===0||T===p.length-1)&&wn(N,w,()=>{o.isCachingCancelled=!0})});for(let S=0;S<b.length&&!o.isCachingCancelled;S+=20){const T=b.slice(S,S+20);await Promise.all(T)}}Tr(),_.length>0&&console.warn(`Failed to cache ${_.length} visible tiles:`,_),o.isCachingCancelled?Se(`Visible tile caching cancelled: ${y} tiles cached.`):Se("Visible map tiles cached.");try{const M=await oe.getCacheSize();console.log(`Cache size after visible tiles caching: ${M.toFixed(2)} MB`),M>Bt.SIZE_LIMIT_MB_WARNING&&g.handleError(`Cache size large (${M.toFixed(2)} MB). Consider clearing cache to free up space.`)}catch(M){console.error("Failed to check cache size after visible tiles caching:",M),g.handleError("Unable to check cache size. Consider clearing cache to free up space.")}},1e3);var Hn={exports:{}},di;function Al(){return di||(di=1,function(t){(function(e){t.exports=e(ls)})(function(e){var n="polyline-measure-control",a="polyline-measure-unicode-icon",i=navigator.platform==="MacIntel";return e.Control.PolylineMeasure=e.Control.extend({options:{position:"topleft",unit:"kilometres",useSubunits:!0,clearMeasurementsOnStop:!0,showBearings:!1,bearingTextIn:"In",bearingTextOut:"Out",tooltipTextFinish:"Click to <b>finish line</b><br>",tooltipTextDelete:"Press SHIFT-key and click to <b>delete point</b>",tooltipTextMove:"Click and drag to <b>move point</b><br>",tooltipTextResume:"<br>Press "+(i?"⌘":"CTRL-key")+" and click to <b>resume line</b>",tooltipTextAdd:"Press "+(i?"⌘":"CTRL-key")+" and click to <b>add point</b>",measureControlTitleOn:"Turn on PolylineMeasure",measureControlTitleOff:"Turn off PolylineMeasure",measureControlLabel:"&#8614;",measureControlClasses:[],showClearControl:!1,clearControlTitle:"Clear Measurements",clearControlLabel:"&times;",clearControlClasses:[],showUnitControl:!1,unitControlUnits:["kilometres","landmiles","nauticalmiles"],unitControlTitle:{text:"Change Units",kilometres:"kilometres",landmiles:"land miles",nauticalmiles:"nautical miles"},unitControlLabel:{metres:"m",kilometres:"km",feet:"ft",landmiles:"mi",nauticalmiles:"nm"},unitControlClasses:[],tempLine:{color:"#00f",weight:2},fixedLine:{color:"#006",weight:2},arrow:{color:"#000"},startCircle:{color:"#000",weight:1,fillColor:"#0f0",fillOpacity:1,radius:3},intermedCircle:{color:"#000",weight:1,fillColor:"#ff0",fillOpacity:1,radius:3},currentCircle:{color:"#000",weight:1,fillColor:"#f0f",fillOpacity:1,radius:6},endCircle:{color:"#000",weight:1,fillColor:"#f00",fillOpacity:1,radius:3}},_arcpoints:99,_circleNr:-1,_lineNr:-1,_createControl:function(s,r,l,c,u,d){var m=document.createElement("a");return m.innerHTML=s,m.setAttribute("title",r),l.forEach(function(p){m.classList.add(p)}),e.DomEvent.on(m,"click",u,d),c.appendChild(m),m},onAdd:function(s){var r=this;s.on("movestart ",function(){r._mapdragging=!0}),this._container=document.createElement("div"),this._container.classList.add("leaflet-bar"),e.DomEvent.disableClickPropagation(this._container);var l=this.options.measureControlTitleOn,c=this.options.measureControlLabel,u=this.options.measureControlClasses;if(c.indexOf("&")!=-1&&u.push(a),this._arrPolylines=[],this._measureControl=this._createControl(c,l,u,this._container,this._toggleMeasure,this),this._defaultControlBgColor=this._measureControl.style.backgroundColor,this._measureControl.setAttribute("id",n),this.options.showClearControl){var l=this.options.clearControlTitle,c=this.options.clearControlLabel,u=this.options.clearControlClasses;c.indexOf("&")!=-1&&u.push(a),this._clearMeasureControl=this._createControl(c,l,u,this._container,this._clearAllMeasurements,this),this._clearMeasureControl.classList.add("polyline-measure-clearControl")}if(this.options.showUnitControl&&this.options.unitControlUnits.length>1){var c=this.options.unitControlLabel[this.options.unit],l=this.options.unitControlTitle.text+" ["+this.options.unitControlTitle[this.options.unit]+"]",u=this.options.unitControlClasses;this._unitControl=this._createControl(c,l,u,this._container,this._changeUnit,this),this._unitControl.setAttribute("id","unitControlId")}return this._container},onRemove:function(){this._measuring&&this._toggleMeasure()},_saveNonpolylineEvents:function(){this._nonpolylineTargets=this._map._targets,typeof this._polylineTargets<"u"?this._map._targets=this._polylineTargets:this._map._targets={}},_savePolylineEvents:function(){this._polylineTargets=this._map._targets,this._map._targets=this._nonpolylineTargets},_toggleMeasure:function(){this._measuring=!this._measuring,this._measuring?(this._mapdragging=!1,this._saveNonpolylineEvents(),this._measureControl.classList.add("polyline-measure-controlOnBgColor"),this._measureControl.style.backgroundColor=this.options.backgroundColor,this._measureControl.title=this.options.measureControlTitleOff,this._oldCursor=this._map._container.style.cursor,this._map._container.style.cursor="crosshair",this._doubleClickZoom=this._map.doubleClickZoom.enabled(),this._map.doubleClickZoom.disable(),this._layerPaint||(this._layerPaint=e.layerGroup().addTo(this._map)),this._map.on("mousemove",this._mouseMove,this),this._map.on("click",this._mouseClick,this),e.DomEvent.on(document,"keydown",this._onKeyDown,this),this._resetPathVariables()):(this._savePolylineEvents(),this._measureControl.classList.remove("polyline-measure-controlOnBgColor"),this._measureControl.style.backgroundColor=this._defaultControlBgColor,this._measureControl.title=this.options.measureControlTitleOn,this._map._container.style.cursor=this._oldCursor,this._map.off("mousemove",this._mouseMove,this),this._map.off("click",this._mouseClick,this),this._map.off("mousemove",this._resumeFirstpointMousemove,this),this._map.off("click",this._resumeFirstpointClick,this),this._map.off("mousemove",this._dragCircleMousemove,this),this._map.off("mouseup",this._dragCircleMouseup,this),e.DomEvent.off(document,"keydown",this._onKeyDown,this),this._doubleClickZoom&&this._map.doubleClickZoom.enable(),this.options.clearMeasurementsOnStop&&this._layerPaint&&this._clearAllMeasurements(),this._cntCircle!==0&&this._finishPolylinePath()),this._map.fire("polylinemeasure:toggle",{status:this._measuring})},_clearAllMeasurements:function(){this._cntCircle!==void 0&&this._cntCircle!==0&&this._finishPolylinePath(),this._layerPaint&&this._layerPaint.clearLayers(),this._arrPolylines=[],this._map.fire("polylinemeasure:clear")},_changeUnit:function(){let r=(this.options.unitControlUnits.indexOf(this.options.unit)+1)%this.options.unitControlUnits.length;this.options.unit=this.options.unitControlUnits[r],this._unitControl.innerHTML=this.options.unitControlLabel[this.options.unit],this._unitControl.title=this.options.unitControlTitle.text+" ["+this.options.unitControlTitle[this.options.unit]+"]",this._currentLine&&this._computeDistance(this._currentLine),this._arrPolylines.map(this._computeDistance.bind(this))},_computeDistance:function(s){var r=0;s.circleCoords.map((function(l,c){if(c>=1){var u=s.circleCoords[c-1].distanceTo(s.circleCoords[c]);r+=u,this._updateTooltip(s.tooltips[c],s.tooltips[c-1],r,u,s.circleCoords[c-1],s.circleCoords[c])}}).bind(this))},_onKeyDown:function(s){if(s.keyCode===27){if(this._resumeFirstpointFlag===!0){this._resumeFirstpointFlag=!1;var r=this._lineNr;this._map.off("mousemove",this._resumeFirstpointMousemove,this),this._map.off("click",this._resumeFirstpointClick,this),this._layerPaint.removeLayer(this._rubberlinePath2),this._layerPaint.removeLayer(this._tooltipNew),this._arrPolylines[r].circleMarkers[0].setStyle(this.options.startCircle);var l="",c=0;this.options.showBearings===!0&&(l=this.options.bearingTextIn+":---°<br>"+this.options.bearingTextOut+":---°"),l=l+'<div class="polyline-measure-tooltip-difference">+0</div>',l=l+'<div class="polyline-measure-tooltip-total">0</div>',this._arrPolylines[r].tooltips[0]._icon.innerHTML=l,this._arrPolylines[r].tooltips.map((function(u,d){if(d>=1){var m=this._arrPolylines[r].circleCoords[d-1].distanceTo(this._arrPolylines[r].circleCoords[d]),p=this._arrPolylines[r].circleCoords[d-1],f=this._arrPolylines[r].circleCoords[d];c+=m;var y=this._arrPolylines[r].tooltips[d-1];this._updateTooltip(u,y,c,m,p,f)}}).bind(this)),this._map.on("mousemove",this._mouseMove,this);return}this._currentLine?this._finishPolylinePath(s):this._toggleMeasure()}},_getDistance:function(s){var r=s,l;return this.options.unit==="nauticalmiles"?(l=this.options.unitControlLabel.nauticalmiles,r>=185200?r=(r/1852).toFixed(0):r>=18520?r=(r/1852).toFixed(1):r>=1852?r=(r/1852).toFixed(2):r=(r/1852).toFixed(3)):this.options.unit==="landmiles"?(l=this.options.unitControlLabel.landmiles,r>=160934.4?r=(r/1609.344).toFixed(0):r>=16093.44?r=(r/1609.344).toFixed(1):r>=1609.344?r=(r/1609.344).toFixed(2):this.options.useSubunits?(r=(r/.3048).toFixed(0),l=this.options.unitControlLabel.feet):r=(r/1609.344).toFixed(4)):(l=this.options.unitControlLabel.kilometres,r>=1e5?r=(r/1e3).toFixed(0):r>=1e4?r=(r/1e3).toFixed(1):r>=1e3?r=(r/1e3).toFixed(2):this.options.useSubunits?(r=r.toFixed(1),l=this.options.unitControlLabel.metres):r=(r/1e3).toFixed(4)),{value:r,unit:l}},_polylineArc:function(s,r){function l(v){var w=Math.sin((1-v)*f)/Math.sin(f),_=Math.sin(v*f)/Math.sin(f),M=w*Math.cos(u)*Math.cos(d)+_*Math.cos(m)*Math.cos(p),b=w*Math.cos(u)*Math.sin(d)+_*Math.cos(m)*Math.sin(p),S=w*Math.sin(u)+_*Math.sin(m),T=180/Math.PI*Math.atan2(S,Math.sqrt(Math.pow(M,2)+Math.pow(b,2))),E=180/Math.PI*Math.atan2(b,M),k=E-d*180/Math.PI;function C(N){return Math[N>0?"floor":"ceil"](N)}return k<0?E=E-C((k-180)/360)*360:E=E-C((k+180)/360)*360,[T,E]}function c(v){for(var w=[],_=1/(v-1),M=0;M<v;M++){var b=_*M,S=l(b);w.push(S)}return w}var u=s.lat,d=s.lng,m=r.lat,p=r.lng;u=u*Math.PI/180,d=d*Math.PI/180,m=m*Math.PI/180,p=p*Math.PI/180;var f=2*Math.asin(Math.sqrt(Math.pow(Math.sin((u-m)/2),2)+Math.cos(u)*Math.cos(m)*Math.pow(Math.sin((d-p)/2),2))),y;return f===0?y=[[u,d]]:y=c(this._arcpoints),y},_updateTooltip:function(s,r,l,c,u,d){var m=function(S,T,E){var k=S.lat/180*Math.PI,C=T.lat/180*Math.PI,N=S.lng/180*Math.PI,F=T.lng/180*Math.PI,P=Math.sin(F-N)*Math.cos(C),I=Math.cos(k)*Math.sin(C)-Math.sin(k)*Math.cos(C)*Math.cos(F-N);if(E==="inbound")var x=(Math.atan2(P,I)*180/Math.PI+180).toFixed(0);else var x=(Math.atan2(P,I)*180/Math.PI+360).toFixed(0);return x%360},p=m(d,u,"inbound"),f=m(u,d,"outbound"),y=this._getDistance(l),v=this._getDistance(c),w="";if(v.value>0&&(this.options.showBearings===!0&&(w=this.options.bearingTextIn+": "+p+"°<br>"+this.options.bearingTextOut+":---°"),w+='<div class="polyline-measure-tooltip-difference">+'+v.value+"&nbsp;"+v.unit+"</div>"),w+='<div class="polyline-measure-tooltip-total">'+y.value+"&nbsp;"+y.unit+"</div>",s._icon.innerHTML=w,this.options.showBearings===!0&&r){var _=r._icon.innerHTML,M=new RegExp(this.options.bearingTextOut+".*°"),b=_.replace(M,this.options.bearingTextOut+": "+f+"°");r._icon.innerHTML=b}},_drawArrow:function(s){var r=Math.trunc(s.length/2);if(s.length%2==0)var l=s[r-1],c=s[r],u=c[1]-l[1],d=c[0]-l[0],m=[l[0]+d/2,l[1]+u/2];else var l=s[r-1],c=s[r+1],u=c[1]-l[1],d=c[0]-l[0],m=s[r];var p=-Math.atan2(d,u)*57.29578,f=e.divIcon({className:"",iconSize:[16,16],iconAnchor:[8,8],html:"<div style = 'color:"+this.options.arrow.color+"; font-size: 16px; line-height: 16px; vertical-align:top; transform: rotate("+p+"deg)'>&#x27a4;</div>"}),y=e.marker(m,{icon:f,zIndexOffset:-50}).addTo(this._layerPaint);return this._currentLine||y.bindTooltip(this.options.tooltipTextAdd,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),y.on("click",this._clickedArrow,this),y},_mouseMove:function(s){var r=s.latlng;if(this._map.on("click",this._mouseClick,this),!(!r||!this._currentLine)){var l=this._currentLine.circleCoords.last();this._rubberlinePath.setLatLngs(this._polylineArc(l,r));var c=this._currentLine.tooltips.last(),u=this._currentLine.tooltips.slice(-2,-1)[0];c.setLatLng(r);var d=r.distanceTo(l);this._updateTooltip(c,u,this._currentLine.distance+d,d,l,r)}},_startLine:function(s){var r=e.divIcon({className:"polyline-measure-tooltip",iconAnchor:[-4,-4]}),l=function(){return this.slice(-1)[0]};this._rubberlinePath=e.polyline([],{color:this.options.tempLine.color,weight:this.options.tempLine.weight,interactive:!1,dashArray:"8,8"}).addTo(this._layerPaint).bringToBack();var c=this;this._currentLine={id:0,circleCoords:[],circleMarkers:[],arrowMarkers:[],tooltips:[],distance:0,polylinePath:e.polyline([],{color:this.options.fixedLine.color,weight:this.options.fixedLine.weight,interactive:!1}).addTo(this._layerPaint).bringToBack(),handleMarkers:function(m){var p=this.circleMarkers.last();p&&(p.bindTooltip(c.options.tooltipTextDelete,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),p.off("click",c._finishPolylinePath,c),this.circleMarkers.length===1?p.setStyle(c.options.startCircle):p.setStyle(c.options.intermedCircle));var f=new e.CircleMarker(m,c.options.currentCircle).addTo(c._layerPaint);f.bindTooltip(c.options.tooltipTextFinish+c.options.tooltipTextDelete,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),f.cntLine=c._currentLine.id,f.cntCircle=c._cntCircle,c._cntCircle++,f.on("mousedown",c._dragCircle,c),f.on("click",c._finishPolylinePath,c),this.circleMarkers.push(f)},getNewToolTip:function(m){return e.marker(m,{icon:r,interactive:!1})},addPoint:function(m){var p=this.circleCoords.last();if(!(p&&p.equals(m))){if(this.circleCoords.push(m),this.circleCoords.length>1){var f=c._polylineArc(p,m),y=c._drawArrow(f);this.circleCoords.length>2&&f.shift(),this.polylinePath.setLatLngs(this.polylinePath.getLatLngs().concat(f)),y.cntLine=c._currentLine.id,y.cntArrow=c._cntCircle-1,c._currentLine.arrowMarkers.push(y);var v=p.distanceTo(m);this.distance+=v;var w=c._currentLine.tooltips.last(),_=c._currentLine.tooltips.slice(-1,-2)[0];c._updateTooltip(w,_,this.distance,v,p,m)}w&&w.setLatLng(m);var M=this.getNewToolTip(m);M.addTo(c._layerPaint),this.tooltips.push(M),this.handleMarkers(m)}},finalize:function(){if(c._layerPaint.removeLayer(this.tooltips.last()),this.tooltips.pop(),c._layerPaint.removeLayer(c._rubberlinePath),this.circleCoords.length>1){this.tooltips.last()._icon.classList.add("polyline-measure-tooltip-end");var m=this.circleMarkers.last();m.setStyle(c.options.endCircle),m.unbindTooltip(),c._currentLine.circleMarkers.map(function(p){p.bindTooltip(c.options.tooltipTextMove+c.options.tooltipTextDelete,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"})}),c._currentLine.circleMarkers[0].bindTooltip(c.options.tooltipTextMove+c.options.tooltipTextDelete+c.options.tooltipTextResume,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),m.bindTooltip(c.options.tooltipTextMove+c.options.tooltipTextDelete+c.options.tooltipTextResume,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),c._currentLine.arrowMarkers.map(function(p){p.bindTooltip(c.options.tooltipTextAdd,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"})}),m.off("click",c._finishPolylinePath,c),m.on("click",c._resumePolylinePath,c),c._arrPolylines[this.id]=this}else c._layerPaint.removeLayer(this.circleMarkers.last()),c._layerPaint.removeLayer(this.tooltips.last());c._resetPathVariables()}};var u=e.marker(s,{icon:r,interactive:!1});u.addTo(this._layerPaint);var d="";this.options.showBearings===!0&&(d=this.options.bearingTextIn+":---°<br>"+this.options.bearingTextOut+":---°"),d=d+'<div class="polyline-measure-tooltip-difference">+0</div>',d=d+'<div class="polyline-measure-tooltip-total">0</div>',u._icon.innerHTML=d,this._currentLine.tooltips.push(u),this._currentLine.circleCoords.last=l,this._currentLine.tooltips.last=l,this._currentLine.circleMarkers.last=l,this._currentLine.id=this._arrPolylines.length},_mouseClick:function(s){!s.latlng||this._finishCircleScreencoords&&this._finishCircleScreencoords.equals(s.containerPoint)||(!this._currentLine&&!this._mapdragging&&(this._startLine(s.latlng),this._map.fire("polylinemeasure:start",this._currentLine)),this._mapdragging?this._mapdragging=!1:(this._currentLine.addPoint(s.latlng),this._map.fire("polylinemeasure:add",s),this._map.fire("polylinemeasure:change",this._currentLine)))},_finishPolylinePath:function(s){this._map.fire("polylinemeasure:finish",this._currentLine),this._currentLine.finalize(),s&&(this._finishCircleScreencoords=s.containerPoint)},_resumePolylinePath:function(s){if(s.originalEvent.ctrlKey===!0||s.originalEvent.metaKey===!0){this._currentLine=this._arrPolylines[s.target.cntLine],this._rubberlinePath=e.polyline([],{color:this.options.tempLine.color,weight:this.options.tempLine.weight,interactive:!1,dashArray:"8,8"}).addTo(this._layerPaint).bringToBack(),this._currentLine.tooltips.last()._icon.classList.remove("polyline-measure-tooltip-end");var r=this._currentLine.getNewToolTip(s.latlng);r.addTo(this._layerPaint),this._currentLine.tooltips.push(r),this._currentLine.circleMarkers.last().unbindTooltip(),this._currentLine.circleMarkers.last().bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),this._currentLine.circleMarkers.last().setStyle(this.options.currentCircle),this._cntCircle=this._currentLine.circleCoords.length,this._map.fire("polylinemeasure:resume",this._currentLine)}},_resetPathVariables:function(){this._cntCircle=0,this._currentLine=null},_clickedArrow:function(s){if(s.originalEvent.ctrlKey||s.originalEvent.metaKey){var r=s.target.cntLine,l=s.target.cntArrow;this._arrPolylines[r].arrowMarkers[l].removeFrom(this._layerPaint);var c=new e.CircleMarker(s.latlng,this.options.intermedCircle).addTo(this._layerPaint);c.cntLine=r,c.on("mousedown",this._dragCircle,this),c.bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),this._arrPolylines[r].circleMarkers.splice(l+1,0,c),this._arrPolylines[r].circleMarkers.map(function(y,v){y.cntCircle=v}),this._arrPolylines[r].circleCoords.splice(l+1,0,s.latlng);var u=this._arrPolylines[r].polylinePath.getLatLngs(),d=this._polylineArc(this._arrPolylines[r].circleCoords[l],s.latlng);d.pop();var m=this._polylineArc(s.latlng,this._arrPolylines[r].circleCoords[l+2]);Array.prototype.splice.apply(u,[l*(this._arcpoints-1),this._arcpoints].concat(d,m)),this._arrPolylines[r].polylinePath.setLatLngs(u);var p=this._drawArrow(d);this._arrPolylines[r].arrowMarkers[l]=p,p=this._drawArrow(m),this._arrPolylines[r].arrowMarkers.splice(l+1,0,p),this._arrPolylines[r].arrowMarkers.map(function(y,v){y.cntLine=r,y.cntArrow=v}),this._tooltipNew=e.marker(s.latlng,{icon:e.divIcon({className:"polyline-measure-tooltip",iconAnchor:[-4,-4]}),interactive:!1}),this._tooltipNew.addTo(this._layerPaint),this._arrPolylines[r].tooltips.splice(l+1,0,this._tooltipNew);var f=0;this._arrPolylines[r].tooltips.map((function(y,v){if(v>=1){var w=this._arrPolylines[r].circleCoords[v-1].distanceTo(this._arrPolylines[r].circleCoords[v]),_=this._arrPolylines[r].circleCoords[v-1],M=this._arrPolylines[r].circleCoords[v];f+=w;var b=this._arrPolylines[r].tooltips[v-1];this._updateTooltip(y,b,f,w,_,M)}}).bind(this)),this._map.fire("polylinemeasure:insert",s),this._map.fire("polylinemeasure:change",this._arrPolylines[this._lineNr])}},_dragCircleMouseup:function(){this._circleNr===0||this._circleNr===this._arrPolylines[this._lineNr].circleCoords.length-1?this._e1.target.bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete+this.options.tooltipTextResume,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}):this._e1.target.bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),this._resetPathVariables(),this._map.off("mousemove",this._dragCircleMousemove,this),this._map.dragging.enable(),this._map.on("mousemove",this._mouseMove,this),this._map.off("mouseup",this._dragCircleMouseup,this),this._map.fire("polylinemeasure:move",this._e1),this._map.fire("polylinemeasure:change",this._arrPolylines[this._lineNr])},_dragCircleMousemove:function(s){var r=s.latlng.lat,l=s.latlng.lng,c=r-this._mouseStartingLat,u=l-this._mouseStartingLng,d=e.latLng(this._circleStartingLat+c,this._circleStartingLng+u),m=this._arcpoints,p=this._e1.target.cntLine;this._lineNr=p;var f=this._e1.target.cntCircle;this._circleNr=f,this._e1.target.setLatLng(d),this._e1.target.unbindTooltip(),this._arrPolylines[p].circleCoords[f]=d;var y=this._arrPolylines[p].polylinePath.getLatLngs();if(f>=1){var v=this._polylineArc(this._arrPolylines[p].circleCoords[f-1],d);Array.prototype.splice.apply(y,[(f-1)*(m-1),m].concat(v));var w=this._drawArrow(v);w.cntLine=p,w.cntArrow=f-1,this._arrPolylines[p].arrowMarkers[f-1].removeFrom(this._layerPaint),this._arrPolylines[p].arrowMarkers[f-1]=w}if(f<this._arrPolylines[p].circleCoords.length-1){var _=this._polylineArc(d,this._arrPolylines[p].circleCoords[f+1]);Array.prototype.splice.apply(y,[f*(m-1),m].concat(_)),w=this._drawArrow(_),w.cntLine=p,w.cntArrow=f,this._arrPolylines[p].arrowMarkers[f].removeFrom(this._layerPaint),this._arrPolylines[p].arrowMarkers[f]=w}this._arrPolylines[p].polylinePath.setLatLngs(y),f>=0&&this._arrPolylines[p].tooltips[f].setLatLng(d);var M=0;this._arrPolylines[p].tooltips.map((function(b,S){if(S>=1){var T=this._arrPolylines[p].circleCoords[S-1].distanceTo(this._arrPolylines[p].circleCoords[S]),E=this._arrPolylines[p].circleCoords[S-1],k=this._arrPolylines[p].circleCoords[S];M+=T,this._arrPolylines[p].distance=M;var C=this._arrPolylines[p].tooltips[S-1];this._updateTooltip(b,C,M,T,E,k)}}).bind(this)),this._map.on("mouseup",this._dragCircleMouseup,this)},_resumeFirstpointMousemove:function(s){var r=this._lineNr;this._map.on("click",this._resumeFirstpointClick,this);var l=s.latlng;this._rubberlinePath2.setLatLngs(this._polylineArc(l,currentCircleCoords)),this._tooltipNew.setLatLng(l);var c=0,u=l.distanceTo(this._arrPolylines[r].circleCoords[0]),d=l,m=this._arrPolylines[r].circleCoords[0];c+=u;var p=this._tooltipNew,f=this._arrPolylines[r].tooltips[0];this._updateTooltip(f,p,c,u,d,m),this._arrPolylines[r].tooltips.map((function(y,v){if(v>=1){var w=this._arrPolylines[r].circleCoords[v-1].distanceTo(this._arrPolylines[r].circleCoords[v]),_=this._arrPolylines[r].circleCoords[v-1],M=this._arrPolylines[r].circleCoords[v];c+=w;var b=this._arrPolylines[r].tooltips[v-1];this._updateTooltip(y,b,c,w,_,M)}}).bind(this))},_resumeFirstpointClick:function(s){var r=this._lineNr;this._resumeFirstpointFlag=!1,this._map.off("mousemove",this._resumeFirstpointMousemove,this),this._map.off("click",this._resumeFirstpointClick,this),this._layerPaint.removeLayer(this._rubberlinePath2),this._arrPolylines[r].circleMarkers[0].setStyle(this.options.intermedCircle),this._arrPolylines[r].circleMarkers[0].unbindTooltip(),this._arrPolylines[r].circleMarkers[0].bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"});var l=new e.CircleMarker(s.latlng,this.options.startCircle).addTo(this._layerPaint);l.cntLine=r,l.cntCircle=0,l.on("mousedown",this._dragCircle,this),l.bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete+this.options.tooltipTextResume,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),this._arrPolylines[r].circleMarkers.unshift(l),this._arrPolylines[r].circleMarkers.map(function(d,m){d.cntCircle=m}),this._arrPolylines[r].circleCoords.unshift(s.latlng);var c=this._polylineArc(s.latlng,currentCircleCoords),u=this._drawArrow(c);this._arrPolylines[r].arrowMarkers.unshift(u),this._arrPolylines[r].arrowMarkers.map(function(d,m){d.cntLine=r,d.cntArrow=m}),c.pop(),this._arrPolylines[r].polylinePath.setLatLngs(c.concat(this._arrPolylines[r].polylinePath.getLatLngs())),this._arrPolylines[r].tooltips.unshift(this._tooltipNew),this._map.on("mousemove",this._mouseMove,this)},_dragCircle:function(s){var r=this._arcpoints;if(s.originalEvent.ctrlKey||s.originalEvent.metaKey){if(this._map.off("click",this._mouseClick,this),s.target.cntCircle===0){this._resumeFirstpointFlag=!0,this._lineNr=s.target.cntLine;var l=this._lineNr;this._circleNr=s.target.cntCircle,currentCircleCoords=s.latlng,this._arrPolylines[l].circleMarkers[0].setStyle(this.options.currentCircle),this._rubberlinePath2=e.polyline([],{color:this.options.tempLine.color,weight:this.options.tempLine.weight,interactive:!1,dashArray:"8,8"}).addTo(this._layerPaint).bringToBack(),this._tooltipNew=e.marker(currentCircleCoords,{icon:e.divIcon({className:"polyline-measure-tooltip",iconAnchor:[-4,-4]}),interactive:!1}),this._tooltipNew.addTo(this._layerPaint);var c="";this.options.showBearings===!0&&(c=c+this.options.bearingTextIn+":---°<br>"+this.options.bearingTextOut+":---°"),c=c+'<div class="polyline-measure-tooltip-difference">+0</div>',c=c+'<div class="polyline-measure-tooltip-total">0</div>',this._tooltipNew._icon.innerHTML=c,this._map.off("mousemove",this._mouseMove,this),this._map.on("mousemove",this._resumeFirstpointMousemove,this)}return}if(s.originalEvent.shiftKey){this._lineNr=s.target.cntLine;var l=this._lineNr;this._circleNr=s.target.cntCircle;var u=this._circleNr;if(this._layerPaint.hasLayer(this._rubberlinePath)&&l===this._currentLine.id){if(this._cntCircle--,this._currentLine.circleMarkers.length===1){this._currentLine.finalize();return}if(this._currentLine.circleCoords.splice(u,1),this._currentLine.circleMarkers[u].removeFrom(this._layerPaint),this._currentLine.circleMarkers.splice(u,1),this._currentLine.circleMarkers.map(function(w,_){w.cntCircle=_}),m=this._currentLine.polylinePath.getLatLngs(),this._currentLine.tooltips[u].removeFrom(this._layerPaint),this._currentLine.tooltips.splice(u,1),u===0){this._currentLine.circleMarkers.length===1?this._currentLine.circleMarkers[0].setStyle(this.options.currentCircle):this._currentLine.circleMarkers[0].setStyle(this.options.startCircle),m.splice(0,r-1),this._currentLine.circleMarkers[0].bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete+this.options.tooltipTextResume,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),this._currentLine.arrowMarkers[u].removeFrom(this._layerPaint),this._currentLine.arrowMarkers.splice(0,1);var c="";this.options.showBearings===!0&&(c=this.options.bearingTextIn+":---°<br>"+this.options.bearingTextOut+":---°"),c=c+'<div class="polyline-measure-tooltip-difference">+0</div>',c=c+'<div class="polyline-measure-tooltip-total">0</div>',this._currentLine.tooltips[0]._icon.innerHTML=c}else u===this._currentLine.circleCoords.length?(this._currentLine.circleMarkers[u-1].on("click",this._resumePolylinePath,this),this._currentLine.circleMarkers[u-1].bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete+this.options.tooltipTextResume,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),this._currentLine.circleMarkers.slice(-1)[0].setStyle(this.options.currentCircle),m.splice(-(r-1),r-1),this._currentLine.arrowMarkers[u-1].removeFrom(this._layerPaint),this._currentLine.arrowMarkers.splice(-1,1)):(p=this._polylineArc(this._currentLine.circleCoords[u-1],this._currentLine.circleCoords[u]),Array.prototype.splice.apply(m,[(u-1)*(r-1),2*r-1].concat(p)),this._currentLine.arrowMarkers[u-1].removeFrom(this._layerPaint),this._currentLine.arrowMarkers[u].removeFrom(this._layerPaint),f=this._drawArrow(p),this._currentLine.arrowMarkers.splice(u-1,2,f));this._currentLine.polylinePath.setLatLngs(m),this._currentLine.arrowMarkers.map(function(w,_){w.cntLine=l,w.cntArrow=_});var d=0;this._currentLine.tooltips.map((function(w,_,M){if(_>=1){var b,S,T=this._currentLine.tooltips[_-1],E=this._currentLine.circleCoords[_-1];_===M.length-1?(b=this._currentLine.circleCoords[_-1].distanceTo(s.latlng),S=s.latlng,this._updateTooltip(w,T,d+b,b,E,S)):(b=this._currentLine.circleCoords[_-1].distanceTo(this._currentLine.circleCoords[_]),S=this._currentLine.circleCoords[_],d+=b,this._updateTooltip(w,T,d,b,E,S))}}).bind(this)),this._currentLine.distance=d}else{if(this._arrPolylines[l].circleMarkers.length===2){this._layerPaint.removeLayer(this._arrPolylines[l].circleMarkers[1]),this._layerPaint.removeLayer(this._arrPolylines[l].tooltips[1]),this._layerPaint.removeLayer(this._arrPolylines[l].circleMarkers[0]),this._layerPaint.removeLayer(this._arrPolylines[l].tooltips[0]),this._layerPaint.removeLayer(this._arrPolylines[l].arrowMarkers[0]),this._layerPaint.removeLayer(this._arrPolylines[l].polylinePath),this._map.fire("polylinemeasure:remove",s),this._map.fire("polylinemeasure:change",this._arrPolylines[this._lineNr]);return}this._arrPolylines[l].circleCoords.splice(u,1),this._arrPolylines[l].circleMarkers[u].removeFrom(this._layerPaint),this._arrPolylines[l].circleMarkers.splice(u,1),this._arrPolylines[l].circleMarkers.map(function(w,_){w.cntCircle=_});var m=this._arrPolylines[l].polylinePath.getLatLngs();if(this._arrPolylines[l].tooltips[u].removeFrom(this._layerPaint),this._arrPolylines[l].tooltips.splice(u,1),!this._arrPolylines[l].circleMarkers.length){this._arrPolylines.splice(l,1),this._arrPolylines.forEach(function(w,_){w.circleMarkers.map(function(M){M.cntLine=_}),w.arrowMarkers.map(function(M){M.cntLine=_})});return}if(u===0){this._arrPolylines[l].circleMarkers[0].setStyle(this.options.startCircle),m.splice(0,r-1),this._arrPolylines[l].circleMarkers[0].bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete+this.options.tooltipTextResume,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),this._arrPolylines[l].arrowMarkers[u].removeFrom(this._layerPaint),this._arrPolylines[l].arrowMarkers.splice(0,1);var c="";this.options.showBearings===!0&&(c=this.options.bearingTextIn+":---°<br>"+this.options.bearingTextOut+":---°"),c=c+'<div class="polyline-measure-tooltip-difference">+0</div>',c=c+'<div class="polyline-measure-tooltip-total">0</div>',this._arrPolylines[l].tooltips[0]._icon.innerHTML=c}else if(u===this._arrPolylines[l].circleCoords.length)this._arrPolylines[l].circleMarkers[u-1].on("click",this._resumePolylinePath,this),this._arrPolylines[l].circleMarkers[u-1].bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete+this.options.tooltipTextResume,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),this._arrPolylines[l].circleMarkers.slice(-1)[0].setStyle(this.options.endCircle),this._arrPolylines[l].tooltips.slice(-1)[0]._icon.classList.add("polyline-measure-tooltip-end"),m.splice(-(r-1),r-1),this._arrPolylines[l].arrowMarkers[u-1].removeFrom(this._layerPaint),this._arrPolylines[l].arrowMarkers.splice(-1,1);else{var p=this._polylineArc(this._arrPolylines[l].circleCoords[u-1],this._arrPolylines[l].circleCoords[u]);Array.prototype.splice.apply(m,[(u-1)*(r-1),2*r-1].concat(p)),this._arrPolylines[l].arrowMarkers[u-1].removeFrom(this._layerPaint),this._arrPolylines[l].arrowMarkers[u].removeFrom(this._layerPaint);var f=this._drawArrow(p);this._arrPolylines[l].arrowMarkers.splice(u-1,2,f)}this._arrPolylines[l].polylinePath.setLatLngs(m),this._arrPolylines[l].arrowMarkers.map(function(w,_){w.cntLine=l,w.cntArrow=_});var y=0;this._arrPolylines[l].tooltips.map((function(w,_){if(_>=1){var M=this._arrPolylines[l].circleCoords[_-1].distanceTo(this._arrPolylines[l].circleCoords[_]),b=this._arrPolylines[l].circleCoords[_-1],S=this._arrPolylines[l].circleCoords[_];y+=M,this._arrPolylines[l].distance=y;var T=this._arrPolylines[l].tooltips[_-1];this._updateTooltip(w,T,y,M,b,S)}}).bind(this))}this._map.fire("polylinemeasure:remove",s),this._map.fire("polylinemeasure:change",this._arrPolylines[this._lineNr]);return}this._e1=s,this._measuring&&this._cntCircle===0&&(this._map.dragging.disable(),this._map.off("mousemove",this._mouseMove,this),this._map.off("click",this._mouseClick,this),this._mouseStartingLat=s.latlng.lat,this._mouseStartingLng=s.latlng.lng,this._circleStartingLat=s.target._latlng.lat,this._circleStartingLng=s.target._latlng.lng,this._map.on("mousemove",this._dragCircleMousemove,this))},seed:function(s){s.forEach(r=>{this._toggleMeasure(),this._startLine(r[0]),r.forEach((l,c)=>{const u=e.latLng(l);this._mouseMove({latLng:u}),this._currentLine.addPoint(u),c===r.length-1&&(this._finishPolylinePath(),this._toggleMeasure())})})}}),e.Map.mergeOptions({PolylineMeasureControl:!1}),e.Map.addInitHook(function(){this.options.polylineMeasureControl&&(this.PMControl=new e.Control.PolylineMeasure,this.addControl(this.PMControl))}),e.control.polylineMeasure=function(s){return new e.Control.PolylineMeasure(s)},e.Control.PolylineMeasure})}(Hn)),Hn.exports}Al();async function Pl(){return console.log("MapManager: Starte Karteninitialisierung..."),await Il(),console.log("MapManager: Karteninitialisierung abgeschlossen."),o.map}async function Il(){if(o.ismapInitialized||o.map){console.warn("Map already initialized or init in progress.");return}o.ismapInitialized=!0,console.log("initMap started...");const t=Te.DEFAULT_MAP_CENTER,e=Te.DEFAULT_MAP_ZOOM;Dl(t,e),o.jumpVisualizationLayerGroup=L.layerGroup().addTo(o.map),o.landingPatternLayerGroup=L.layerGroup().addTo(o.map),o.jumpRunTrackLayerGroup=L.layerGroup().addTo(o.map),Nl(),Fl(),xl(),Ol(),$l(t),zl(),Promise.all([Rl(),Hl(t,e)]).then(()=>{console.log("Initial tile caching and geolocation promise resolved.")}).catch(n=>{console.error("Error during parallel initialization of cache/geolocation:",n)}),ra(),console.log("initMap finished.")}function Dl(t,e){o.lastLat=o.lastLat||t[0],o.lastLng=o.lastLng||t[1],o.map=L.map("map",{center:t,zoom:e,zoomControl:!1,doubleClickZoom:!1,maxZoom:19,minZoom:navigator.onLine?6:11}),console.log("Map instance created.")}function Nl(){o.baseMaps={OpenStreetMap:L.tileLayer.cached("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:["a","b","c"]}),OpenTopoMap:L.tileLayer.cached("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{maxZoom:17,attribution:'© <a href="https://www.openstreetmap.org/copyright">OSM</a>, <a href="https://opentopomap.org">OpenTopoMap</a> (CC-BY-SA)',subdomains:["a","b","c"]}),"Esri Satellite":L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USDA, USGS"}),"Esri Street":L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USGS"}),"Esri Topo":L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USGS"}),"Esri Satellite + OSM":L.layerGroup([L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USDA, USGS",zIndex:1}),L.tileLayer.cached("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',opacity:.5,zIndex:2,updateWhenIdle:!0,keepBuffer:2,subdomains:["a","b","c"]})],{attribution:'© Esri, USDA, USGS | © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'})},o.map&&o.map.attributionControl&&o.map.attributionControl.addAttribution('Weather data by <a href="https://open-meteo.com">Open-Meteo</a>');const e=h.state.userSettings.baseMaps in o.baseMaps?h.state.userSettings.baseMaps:"Esri Street",n=o.baseMaps[e];n&&typeof n.on=="function"?(n.on("tileerror",()=>{if(!navigator.onLine){o.hasTileErrorSwitched||(console.warn(`${e} tiles unavailable offline. Zoom restricted.`),g.handleMessage("Offline: Zoom restricted to levels 11–14 for cached tiles."),o.hasTileErrorSwitched=!0);return}if(!o.hasTileErrorSwitched&&o.map.hasLayer(n)){const a="OpenStreetMap";console.warn(`${e} tiles unavailable, switching to ${a}`),o.map.removeLayer(n),o.baseMaps[a].addTo(o.map),h.state.userSettings.baseMaps=a,h.save(),g.handleMessage(`${e} tiles unavailable. Switched to ${a}.`),o.hasTileErrorSwitched=!0}else o.hasTileErrorSwitched||console.warn(`Tile error in ${e}, attempting to continue.`)}),n.addTo(o.map)):(console.error(`Default base map "${e}" could not be added.`),o.baseMaps.OpenStreetMap.addTo(o.map)),o.map&&o.map.invalidateSize(),window.addEventListener("online",()=>{o.hasTileErrorSwitched=!1,o.map&&(o.map.options.minZoom=6),ra()}),window.addEventListener("offline",()=>{o.map&&(o.map.options.minZoom=9),ra()}),console.log("Base layers and online/offline handlers set up.")}function Fl(){if(!o.map){console.error("Karte nicht initialisiert, bevor Controls hinzugefügt werden können.");return}L.control.layers(o.baseMaps,null,{position:"topright"}).addTo(o.map),o.map.on("baselayerchange",function(t){console.log(`Base map changed to: ${t.name}`),h&&h.state&&h.state.userSettings?(h.state.userSettings.baseMaps=t.name,h.save(),console.log(`Saved selected base map "${t.name}" to settings.`)):console.error("Settings object not properly available to save base map choice."),o.hasTileErrorSwitched=!1,o.lastLat&&o.lastLng&&typeof cacheTilesForDIP=="function"&&cacheTilesForDIP({map:o.map,lastLat:o.lastLat,lastLng:o.lastLng,baseMaps:o.baseMaps})}),L.control.zoom({position:"topright"}).addTo(o.map),L.control.polylineMeasure({position:"topright",unit:"kilometres",showBearings:!0,clearMeasurementsOnStop:!1,showClearControl:!0,showUnitControl:!0,tooltipTextFinish:"Click to finish the line<br>",tooltipTextDelete:"Shift-click to delete point",tooltipTextMove:"Drag to move point<br>",tooltipTextResume:"Click to resume line<br>",tooltipTextAdd:"Click to add point<br>",measureControlTitleOn:"Start measuring distance and bearing",measureControlTitleOff:"Stop measuring"}).addTo(o.map),L.control.scale({position:"bottomleft",metric:!0,imperial:!1,maxWidth:100}).addTo(o.map),console.log("Standard map controls and baselayerchange handler added.")}function xl(){o.map.createPane("gpxTrackPane"),o.map.getPane("gpxTrackPane").style.zIndex=650,o.map.getPane("tooltipPane").style.zIndex=700,o.map.getPane("popupPane").style.zIndex=700,console.log("Custom map panes created.")}function Ol(){o.livePositionControl=new Xl({position:"bottomright"}).addTo(o.map),console.log("Initialized livePositionControl and hid by default")}async function $l(t,e){console.log("MapManager: Initialisiere den Standard-Marker..."),await Tn(t[0],t[1]),o.isManualPanning=!1,console.log("Default marker initialized using the new standard method.")}async function Rl(){try{if(await oe.init(),await oe.migrateTiles(),await oe.getCacheSize()>500){const e=await oe.clearOldTiles(3);g.handleMessage(`Cleared ${e.deletedCount} old tiles: ${e.deletedSizeMB.toFixed(2)} MB freed.`)}else await oe.clearOldTiles()}catch(t){console.error("Failed to initialize or manage tile cache:",t),g.handleError("Tile caching setup failed.")}console.log("Tile cache logic initialized.")}async function Ul(t,e){const{latitude:n,longitude:a}=t.coords;console.log("MapManager: Geolocation erfolgreich. Sende Event."),o.lastLat=n,o.lastLng=a,o.lastAltitude=await g.getAltitude(n,a),o.map.setView([n,a],e);const i=new CustomEvent("location:selected",{detail:{lat:n,lng:a,source:"geolocation"},bubbles:!0,cancelable:!0});o.map.getContainer().dispatchEvent(i)}async function hi(t,e,n){console.warn(`Geolocation error: ${t.message}`),g.handleMessage("Unable to retrieve your location. Using default location."),await Tn(e[0],e[1]),o.map.setView(e,n),St(!0),o.isManualPanning=!1;const a=new CustomEvent("location:selected",{detail:{lat:e[0],lng:e[1],source:"geolocation_fallback"},bubbles:!0,cancelable:!0});o.map.getContainer().dispatchEvent(a),console.log("Dispatched 'location:selected' event from geolocation fallback.")}async function Hl(t,e){navigator.geolocation?navigator.geolocation.getCurrentPosition(n=>Ul(n,e),n=>hi(n,t,e),{enableHighAccuracy:!0,timeout:Te.GEOLOCATION_TIMEOUT_MS,maximumAge:0}):(console.warn("Geolocation not supported."),await hi({message:"Geolocation not supported by this browser."},t,e))}function Wl(t){const{lat:e,lng:n}=t.latlng,a=new CustomEvent("map:mousemove",{detail:{lat:e,lng:n},bubbles:!0,cancelable:!0});o.map.getContainer().dispatchEvent(a)}function zl(){if(!o.map){console.error("Karte nicht initialisiert in _setupCoreMapEventHandlers");return}o.coordsControl||(o.coordsControl=new L.Control.Coordinates,o.coordsControl.addTo(o.map),console.log("CoordsControl initialized in _setupCoreMapEventHandlers.")),o.map.on("mousemove",Wl),o.map.on("mouseout",function(){o.coordsControl&&o.coordsControl.getContainer()&&(o.coordsControl.getContainer().innerHTML="Move mouse over map")}),o.map.on("dblclick",mi),o.map.on("zoomstart",e=>{if(!navigator.onLine){const n=e.target._zoom||o.map.getZoom();n<11?(e.target._zoom=11,o.map.setZoom(11),g.handleMessage("Offline: Zoom restricted to levels 11–14 for cached tiles.")):n>14&&(e.target._zoom=14,o.map.setZoom(14),g.handleMessage("Offline: Zoom restricted to levels 11–14 for cached tiles."))}}),o.map.on("zoomend",()=>{const e=o.map.getZoom(),n=new CustomEvent("map:zoomend",{detail:{zoom:e},bubbles:!0,cancelable:!0});if(o.map.getContainer().dispatchEvent(n),o.jumpRunTrackLayer&&h.state.userSettings.showJumpRunTrack){const a=o.jumpRunTrackLayer.getLayers().find(i=>{var s;return((s=i.options.icon)==null?void 0:s.options.className)==="jrt-anchor-marker"});if(a){const i=e<=11?10:e<=12?12:e<=13?14:16;a.setIcon(L.divIcon({className:"jrt-anchor-marker",html:`<div style="background-color: orange; width: ${i}px; height: ${i}px; border-radius: 50%; border: 2px solid white; opacity: 0.8;"></div>`,iconSize:[i,i],iconAnchor:[i/2,i/2],tooltipAnchor:[0,-(i/2+5)]}))}}if(o.heatmapLayer){const a=g.calculateDynamicRadius(be.HEATMAP_BASE_RADIUS,be.HEATMAP_REFERENCE_ZOOM);o.heatmapLayer.setOptions({radius:a}),console.log("Heatmap radius updated on zoom:",{currentZoom:o.map.getZoom(),newRadius:a})}}),o.map.on("movestart",e=>{e.target===o.map&&(!e.originalEvent||e.originalEvent.target===o.map.getContainer())&&(o.isManualPanning=!0,console.log("Manual map panning detected."))}),o.map.on("contextmenu",e=>{if(!h.state.userSettings.showCutAwayFinder||!h.state.userSettings.calculateJump)return;const{lat:n,lng:a}=e.latlng;o.cutAwayMarker?o.cutAwayMarker.setLatLng([n,a]):(o.cutAwayMarker=Zl(n,a).addTo(o.map),jl(o.cutAwayMarker)),o.cutAwayLat=n,o.cutAwayLng=a,Ir(o.cutAwayMarker,n,a);const i=new CustomEvent("cutaway:marker_placed",{bubbles:!0});o.map.getContainer().dispatchEvent(i)});const t=o.map.getContainer();t.addEventListener("touchstart",async e=>{if(e.touches.length!==1||e.target.closest(".leaflet-marker-icon"))return;const n=new Date().getTime(),a=n-lastTapTime;if(a<300&&a>0){e.preventDefault();const s=t.getBoundingClientRect(),r=e.touches[0].clientX-s.left,l=e.touches[0].clientY-s.top,c=o.map.containerPointToLatLng([r,l]);await mi({latlng:c,containerPoint:L.point(r,l),layerPoint:o.map.latLngToLayerPoint(c)})}lastTapTime=n},{passive:!1}),o.map.on("click",e=>{}),o.map.on("mousedown",e=>{}),console.log("All core map event handlers have been set up.")}function mi(t){const{lat:e,lng:n}=t.latlng;console.log('MapManager: Doppelklick erkannt. Sende "location:selected"-Event.');const a=new CustomEvent("location:selected",{detail:{lat:e,lng:n,source:"dblclick"},bubbles:!0,cancelable:!0});o.map.getContainer().dispatchEvent(a)}function un(t){if(Bl(),o.labelZoomListener&&o.map&&(o.map.off("zoomend",o.labelZoomListener),o.labelZoomListener=null),!t||!o.jumpVisualizationLayerGroup)return;const e=[];t.exitCircles&&t.exitCircles.forEach(a=>{const i=L.circle(a.center,{radius:a.radius,color:a.color,fillColor:a.fillColor,fillOpacity:a.fillOpacity,weight:a.weight||2}).addTo(o.jumpVisualizationLayerGroup);a.tooltip&&i.bindTooltip(a.tooltip,{direction:"top",offset:[0,0],className:"wind-tooltip"})}),t.canopyCircles&&t.canopyCircles.forEach(a=>{L.circle(a.center,a).addTo(o.jumpVisualizationLayerGroup)});function n(a,i){const s=L.latLng(a[0],a[1]),l=i/6378137*(180/Math.PI),c=L.latLng(a[0]+l,a[1]),u=o.map.latLngToLayerPoint(s),d=o.map.latLngToLayerPoint(c);return[25,u.y-d.y+10]}if(t.canopyLabels){const a=o.map.getZoom();t.canopyLabels.forEach(i=>{const s=a<=11,r=L.marker(i.center,{icon:L.divIcon({className:`isoline-label ${s?"isoline-label-small":"isoline-label-large"}`,html:`<span style="font-size: ${s?"8px":"10px"}">${i.text}</span>`,iconSize:s?[50,12]:[60,14],iconAnchor:n(i.center,i.radius)}),zIndexOffset:2100}).addTo(o.jumpVisualizationLayerGroup);e.push({marker:r,center:i.center,radius:i.radius,text:i.text})})}e.length>0&&(o.labelZoomListener=function(){const i=o.map.getZoom()<=11;e.forEach(s=>{s.marker.setIcon(L.divIcon({className:`isoline-label ${i?"isoline-label-small":"isoline-label-large"}`,html:`<span style="font-size: ${i?"8px":"10px"}">${s.text}</span>`,iconSize:i?[50,12]:[60,14],iconAnchor:n(s.center,s.radius)}))})},o.map.on("zoomend",o.labelZoomListener))}function Bl(){o.map&&o.jumpVisualizationLayerGroup&&o.map.removeLayer(o.jumpVisualizationLayerGroup),o.jumpVisualizationLayerGroup=L.layerGroup().addTo(o.map)}function Gl(){o.landingPatternLayerGroup&&o.landingPatternLayerGroup.clearLayers()}function xt(t){Gl(),t&&(t.legs.forEach(e=>{L.polyline(e.path,{color:"red",weight:3,opacity:.8,dashArray:"5, 10"}).addTo(o.landingPatternLayerGroup)}),t.arrows.forEach(e=>{const n=Vl(e.position[0],e.position[1],e.bearing,e.color);L.marker(e.position,{icon:n}).addTo(o.landingPatternLayerGroup).bindTooltip(e.tooltipText,{offset:[10,0],direction:"right",className:"wind-tooltip"})}))}function Vl(t,e,n,a){const i=(n+360)%360,s=`
        <svg width="40" height="20" viewBox="0 0 40 20" xmlns="http://www.w3.org/2000/svg">
            <line x1="0" y1="10" x2="30" y2="10" stroke="${a}" stroke-width="4" />
            <polygon points="30,5 40,10 30,15" fill="${a}" />
        </svg>
    `;return L.divIcon({html:`<div style="transform: rotate(${i}deg); ...">${s}</div>`,className:"wind-arrow-icon",iconSize:[40,20],iconAnchor:[20,10]})}function Jl(){o.map&&o.jumpRunTrackLayerGroup&&o.map.removeLayer(o.jumpRunTrackLayerGroup),o.jumpRunTrackLayerGroup=L.layerGroup().addTo(o.map)}function Zl(t,e){const n=L.icon({iconUrl:ca.CUTAWAY_MARKER,iconSize:[25,25],iconAnchor:[12,12],popupAnchor:[0,-12],shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",shadowSize:[41,41],shadowAnchor:[13,41]});return L.marker([t,e],{icon:n,draggable:!0})}function jl(t){t.on("dragend",e=>{const n=t.getLatLng();o.cutAwayLat=n.lat,o.cutAwayLng=n.lng,console.log("Cut-away marker dragged to:",{lat:o.cutAwayLat,lng:o.cutAwayLng}),Ir(t,o.cutAwayLat,o.cutAwayLng);const a=new CustomEvent("cutaway:marker_placed",{bubbles:!0});o.map.getContainer().dispatchEvent(a)})}function Ir(t,e,n,a=!1){const i=h.getValue("coordFormat","radio","Decimal"),s=g.convertCoords(e,n,i);let r="<b>Cut-Away Start</b><br>";if(i==="MGRS")r+=`MGRS: ${s.lat}`;else{const l=c=>`${c.deg}°${c.min}'${c.sec.toFixed(0)}" ${c.dir}`;i==="DMS"?r+=`Lat: ${l(g.decimalToDms(e,!0))}<br>Lng: ${l(g.decimalToDms(n,!1))}`:r+=`Lat: ${e.toFixed(5)}<br>Lng: ${n.toFixed(5)}`}La(t,r,a)}function sa(t){o.cutAwayCircle&&(o.map.removeLayer(o.cutAwayCircle),o.cutAwayCircle=null),t&&(o.cutAwayCircle=L.circle(t.center,{radius:t.radius,color:"purple",fillColor:"purple",fillOpacity:.2,weight:2}).addTo(o.map),o.cutAwayCircle.bindTooltip(t.tooltipContent,{permanent:!1,direction:"center",className:"cutaway-tooltip"}))}function ql(){o.cutAwayMarker&&(o.map.removeLayer(o.cutAwayMarker),o.cutAwayMarker=null),sa(null)}function dn(t){var s,r,l,c;if(Jl(),!t||!o.jumpRunTrackLayerGroup){console.warn("No valid trackData or AppState.jumpRunTrackLayerGroup");return}if(!((r=(s=t.path)==null?void 0:s.latlngs)!=null&&r.length)||!((l=t.airplane)!=null&&l.position)){console.warn("Invalid trackData structure:",t);return}const e=L.polyline(t.path.latlngs,t.path.options).bindTooltip(t.path.tooltipText).addTo(o.jumpRunTrackLayerGroup);let n=null;(c=t.approachPath)!=null&&c.latlngs&&(n=L.polyline(t.approachPath.latlngs,t.approachPath.options).bindTooltip(t.approachPath.tooltipText).addTo(o.jumpRunTrackLayerGroup));const a=L.icon({iconUrl:ca.AIRPLANE_MARKER,iconSize:[32,32],iconAnchor:[16,16],shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",shadowSize:[41,41],shadowAnchor:[13,32]}),i=L.marker(t.airplane.position,{icon:a,rotationAngle:t.airplane.bearing,rotationOrigin:"center center",draggable:!0,zIndexOffset:2e3}).bindTooltip("Drag to move Jump Run Track").addTo(o.jumpRunTrackLayerGroup);i.on("mousedown",()=>o.map.dragging.disable()),i.on("mouseup",()=>o.map.dragging.enable()),i.on("drag",u=>{var v;const d=u.target.getLatLng(),m=t.airplane.originalPosition;if(!m||!Number.isFinite(m.lat)||!Number.isFinite(m.lng)){console.warn("Invalid originalPosition:",m);return}const p=d.lat-m.lat,f=d.lng-m.lng;if(!Number.isFinite(p)||!Number.isFinite(f)){console.warn("Invalid delta values:",{deltaLat:p,deltaLng:f});return}const y=t.path.originalLatLngs.map(w=>[Number.isFinite(w[0])?w[0]+p:w[0],Number.isFinite(w[1])?w[1]+f:w[1]]);if(e.setLatLngs(y),n&&((v=t.approachPath)!=null&&v.originalLatLngs)){const w=t.approachPath.originalLatLngs.map(_=>[Number.isFinite(_[0])?_[0]+p:_[0],Number.isFinite(_[1])?_[1]+f:_[1]]);n.setLatLngs(w)}}),i.on("dragend",u=>{const d=u.target.getLatLng();if(!Number.isFinite(d.lat)||!Number.isFinite(d.lng)){console.warn("Invalid new position in dragend:",d);return}const m=new CustomEvent("track:dragend",{detail:{newPosition:d,originalTrackData:t},bubbles:!0});o.map.getContainer().dispatchEvent(m)})}async function Tn(t,e){if(console.log("MapManager: Befehl erhalten, Marker zu erstellen/bewegen bei",t,e),typeof t!="number"||typeof e!="number"||t<-90||t>90||e<-180||e>180){console.error("MapManager: Ungültige Koordinaten:",{lat:t,lng:e});return}const n=await g.getAltitude(t,e);if(o.currentMarker)console.log("MapManager: Marker existiert, bewege ihn jetzt mit setLatLng."),o.currentMarker.setLatLng([t,e]);else{console.log("MapManager: Kein Marker vorhanden, erstelle einen neuen.");const i=Kl(t,e);Yl(i),o.currentMarker=i,o.currentMarker.addTo(o.map)}const a=`Lat: ${t.toFixed(5)}<br>Lng: ${e.toFixed(5)}<br>Alt: ${n} m`;La(o.currentMarker,a),o.lastLat=t,o.lastLng=e,o.lastAltitude=n,o.map.invalidateSize()}function Kl(t,e){const n=L.icon({iconUrl:ca.DEFAULT_MARKER,iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32],shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",shadowSize:[41,41],shadowAnchor:[13,32]});return L.marker([t,e],{icon:n,draggable:!0})}function Yl(t){t.on("dragend",e=>{const n=t.getLatLng(),a=new CustomEvent("location:selected",{detail:{lat:n.lat,lng:n.lng,source:"marker_drag"},bubbles:!0});o.map.getContainer().dispatchEvent(a)})}function La(t,e,n=!1){var i;if(!t)return;const a=((i=t.getPopup())==null?void 0:i.isOpen())||n;t.unbindPopup().bindPopup(e),a&&t.openPopup()}function St(t=!1){o.isManualPanning&&!t||o.map&&o.currentMarker&&o.map.panTo(o.currentMarker.getLatLng())}const Xl=L.Control.extend({options:{position:"bottomright"},onAdd:function(t){const e=L.DomUtil.create("div","leaflet-control-live-position");return e.style.display="none",e.style.background="rgba(255, 255, 255, 0.8)",e.style.padding="5px",e.style.borderRadius="4px",this._container=e,e},update:function(t){if(!t||t.latitude===null||t.latitude===void 0){this._container.style.display="none";return}const{latitude:e,longitude:n,deviceAltitude:a,altitudeAccuracy:i,accuracy:s,speedMs:r,direction:l,showJumpMasterLine:c,jumpMasterLineData:u,heightUnit:d,effectiveWindUnit:m,coordFormat:p,refLevel:f}=t,y=g.convertCoords(e,n,p),v=p==="MGRS"?`MGRS: ${y.lat}<br>`:`Lat: ${e.toFixed(5)}<br>Lng: ${n.toFixed(5)}<br>`;let w="Altitude: N/A<br>";if(a!==null){let T=f==="AGL"&&o.lastAltitude?a-parseFloat(o.lastAltitude):a,E=f==="AGL"&&o.lastAltitude?"abv DIP":f;const k=Math.round(g.convertHeight(T,d)),C=Math.round(g.convertHeight(i,d));w=`Altitude: ${k} ${d} ${E} (±${C||"N/A"} ${d})<br>`}const _=`Accuracy: ${Math.round(g.convertHeight(s,d))} ${d}<br>`,M=`Speed: ${g.convertWind(r,m,"m/s").toFixed(1)} ${m}<br>`,b=`Direction: ${l}°`;let S=`<span style="font-weight: bold;">Live Position</span><br>${v}${w}${_}${M}${b}`;if(c&&u){const T=Math.round(g.convertHeight(u.distance,d)),E=u.tot!=="N/A"&&u.tot<1200?`TOT: X - ${u.tot} s`:"TOT: N/A";S+=`<br><br><span style="font-weight: bold;">Jump Master Line to ${u.target}</span><br>`,S+=`Bearing: ${u.bearing}°<br>`,S+=`Distance: ${T} ${d}<br>`,S+=E}this._container.innerHTML=S,this._container.style.display="block"}});function Ql(t,e){const n=[[t.lat,t.lng],[e.lat,e.lng]];o.jumpMasterLine?o.jumpMasterLine.setLatLngs(n):o.jumpMasterLine=L.polyline(n,{color:"blue",weight:3,dashArray:"5, 5"}).addTo(o.map)}function pi(){o.jumpMasterLine&&(o.map.removeLayer(o.jumpMasterLine),o.jumpMasterLine=null)}function ec(){o.livePositionControl&&o.livePositionControl.update(null)}function tc(t){o.livePositionControl&&o.livePositionControl.update(t)}function Dr(t){if(!o.isPlacingHarp)return;const{lat:e,lng:n}=t.latlng;o.harpMarker?(o.harpMarker.setLatLng([e,n]),console.log("Updated HARP marker position:",{lat:e,lng:n})):(o.harpMarker=nc(e,n).addTo(o.map),console.log("Placed new HARP marker:",{lat:e,lng:n})),h.state.userSettings.harpLat=e,h.state.userSettings.harpLng=n,h.save(),o.isPlacingHarp=!1,o.map.off("click",Dr),console.log("HARP placement mode deactivated");const a=document.querySelector('input[name="jumpMasterLineTarget"][value="HARP"]');a&&(a.disabled=!1,console.log("Enabled HARP radio button"))}function nc(t,e){const n=L.marker([t,e],{icon:L.divIcon({className:"harp-marker",html:'<div style="background-color: green; width: 10px; height: 10px; border-radius: 50%;"></div>',iconSize:[10,10],iconAnchor:[5,5]}),pane:"markerPane"});return console.log("Created HARP marker at:",{latitude:t,longitude:e}),n}function ac(){if(!o.map){console.warn("Map not initialized, cannot clear HARP marker"),g.handleMessage("Map not initialized, cannot clear HARP marker.");return}o.harpMarker&&(o.map.removeLayer(o.harpMarker),o.harpMarker=null,console.log("Removed HARP marker")),h.state.userSettings.harpLat=null,h.state.userSettings.harpLng=null,h.save();const t=document.querySelector('input[name="jumpMasterLineTarget"][value="HARP"]');if(t&&(t.disabled=!0,console.log("Disabled HARP radio button")),h.state.userSettings.jumpMasterLineTarget==="HARP"&&h.state.userSettings.showJumpMasterLine){o.jumpMasterLine&&(o.map.removeLayer(o.jumpMasterLine),o.jumpMasterLine=null,console.log("Removed Jump Master Line: HARP marker cleared")),h.state.userSettings.jumpMasterLineTarget="DIP";const e=document.querySelector('input[name="jumpMasterLineTarget"][value="DIP"]');e&&(e.checked=!0,console.log("Switched Jump Master Line to DIP")),h.save(),o.liveMarker&&o.currentMarker&&o.lastLat!==null&&o.lastLng!==null&&debouncedPositionUpdate({coords:{latitude:o.lastLatitude,longitude:o.lastLongitude,accuracy:o.lastAccuracy,altitude:o.lastDeviceAltitude,altitudeAccuracy:o.lastAltitudeAccuracy}})}g.handleMessage("HARP marker cleared")}async function kn(){if(!o.currentMarker||o.lastLat===null)return;const t=o.lastLat,e=o.lastLng,n=o.lastAltitude,a=h.getValue("coordFormat","radio","Decimal"),i=Oe(),s=g.convertCoords(t,e,a);let r;if(a==="MGRS")r=`MGRS: ${s.lat}<br>Alt: ${n} m`;else{const l=c=>`${c.deg}°${c.min}'${c.sec.toFixed(0)}" ${c.dir}`;a==="DMS"?r=`Lat: ${l(g.decimalToDms(t,!0))}<br>Lng: ${l(g.decimalToDms(e,!1))}<br>Alt: ${n} m`:r=`Lat: ${t.toFixed(5)}<br>Lng: ${e.toFixed(5)}<br>Alt: ${n} m`}if(o.weatherData&&o.weatherData.surface_pressure){const l=o.weatherData.surface_pressure[i];l?r+=` QFE: ${l.toFixed(0)} hPa`:r+=" QFE: N/A"}else r+=" QFE: N/A";La(o.currentMarker,r)}async function En(t,e=null){var f;if(console.log(`updateWeatherDisplay called with index: ${t}, Time: ${o.weatherData.time[t]}`),!o.weatherData||!o.weatherData.time||t<0||t>=o.weatherData.time.length){console.error("No weather data available or index out of bounds:",t),document.getElementById("info").innerHTML="No weather data available",document.getElementById("selectedTime").innerHTML="Selected Time: ";const y=document.getElementById("timeSlider");y&&(y.value=0);return}o.landingWindDir=o.weatherData.wind_direction_10m[t]||null,console.log("landingWindDir updated to:",o.landingWindDir);const n=document.getElementById("customLandingDirectionLL"),a=document.getElementById("customLandingDirectionRR");n&&a&&o.landingWindDir!==null&&(n.value=Math.round(o.landingWindDir),a.value=Math.round(o.landingWindDir));const i=((f=document.querySelector('input[name="refLevel"]:checked'))==null?void 0:f.value)||"AGL",s=h.getValue("heightUnit","radio","m"),r=h.getValue("windUnit","radio","kt"),l=h.getValue("temperatureUnit","radio","C"),c=await g.getDisplayTime(o.weatherData.time[t],o.lastLat,o.lastLng),u=ut(t),d=i==="AMSL"&&o.lastAltitude!=="N/A"?Math.round(o.lastAltitude):0;if(!h.state.userSettings.showTable){document.getElementById("info").innerHTML="",document.getElementById("selectedTime").innerHTML=`Selected Time: ${c}`;return}const m=u.map(y=>{const v=parseFloat(y.spd);let w="";if(r==="bft"){const P=g.convertWind(v,"kt","km/h"),I=g.knotsToBeaufort(P);I<=1?w="wind-low":I<=3?w="wind-moderate":I<=4?w="wind-high":w="wind-very-high"}else{const P=g.convertWind(v,"kt","km/h");P<=3?w="wind-low":P<=10?w="wind-moderate":P<=16?w="wind-high":w="wind-very-high"}const _=y.rh;let M="";_!=="N/A"&&Number.isFinite(_)&&(_<65?M="humidity-low":_>=65&&_<=85?M="humidity-moderate":_>85&&_<100?M="humidity-high":_===100&&(M="humidity-saturated"));const b=i==="AMSL"?y.displayHeight+(s==="ft"?Math.round(d*3.28084):d):y.displayHeight,S=g.convertTemperature(y.temp,l==="C"?"°C":"°F"),T=S==="N/A"?"N/A":S.toFixed(0),E=g.convertWind(v,r,"km/h");let k;const C=i==="AMSL"?s==="ft"?Math.round(d*3.28084):d:0;if(Math.round(b)===C&&o.weatherData.wind_gusts_10m[t]!==void 0&&Number.isFinite(o.weatherData.wind_gusts_10m[t])){const P=o.weatherData.wind_gusts_10m[t],I=g.convertWind(P,r,"km/h"),x=r==="bft"?Math.round(E):E.toFixed(0),U=r==="bft"?Math.round(I):I.toFixed(0);k=`${x} G ${U}`}else k=E==="N/A"?"N/A":r==="bft"?Math.round(E):E.toFixed(0);const N=Math.round(g.convertWind(v,"kt","km/h")/5)*5,F=y.dir==="N/A"||isNaN(N)?"N/A":g.generateWindBarb(y.dir,N);return`<tr class="${w} ${M}">
                    <td>${Math.round(b)}</td>
                    <td>${g.roundToTens(y.dir)}</td>
                    <td>${k}</td>
                    <td>${F}</td>
                    <td>${T}</td>
                </tr>`}).join(""),p=`
        <table id="weatherTable">
            <thead>
                <tr>
                    <th>Height (${s} ${i})</th>
                    <th>Dir (deg)</th>
                    <th>Spd (${r})</th>
                    <th>Wind</th>
                    <th>T (${l==="C"?"°C":"°F"})</th>
                </tr>
            </thead>
            <tbody>
                ${m}
            </tbody>
        </table>`;document.getElementById("info").innerHTML=p,document.getElementById("selectedTime").innerHTML=`Selected Time: ${c}`}function et(){var Ea;if(!o.currentMarker||typeof o.currentMarker.getLatLng!="function"){console.warn("Landing pattern update skipped: AppState.currentMarker is not a valid marker object yet.",o.currentMarker);return}const t=o.currentMarker.getLatLng();if(!t){console.error("Could not get LatLng from the current marker. Aborting landing pattern update.",o.currentMarker);return}if(!h.state.isLandingPatternUnlocked||!h.state.userSettings.showLandingPattern){xt(null);return}if(!o.weatherData||!o.lastLat){xt(null);return}const e=o.map.getZoom();if(e<Te.LANDING_PATTERN_MIN_ZOOM){console.log("Landing pattern not displayed - zoom too low:",e),xt(null);return}const n=parseInt(document.getElementById("timeSlider").value)||0,a=((Ea=document.querySelector('input[name="landingDirection"]:checked'))==null?void 0:Ea.value)||"LL",i=document.getElementById("customLandingDirectionLL"),s=document.getElementById("customLandingDirectionRR"),r=i?parseInt(i.value,10):null,l=s?parseInt(s.value,10):null,c=parseInt(document.getElementById("canopySpeed").value)||20,u=parseFloat(document.getElementById("descentRate").value)||3.5,d=parseInt(document.getElementById("legHeightFinal").value)||100,m=parseInt(document.getElementById("legHeightBase").value)||200,p=parseInt(document.getElementById("legHeightDownwind").value)||300,f=t.lat,y=t.lng,v=Math.round(o.lastAltitude),w=ut(n);if(!w||w.length===0)return;const _=w.map(ce=>ce.height),M=w.map(ce=>Number.isFinite(ce.dir)?parseFloat(ce.dir):0),b=w.map(ce=>g.convertWind(parseFloat(ce.spd)||0,"kt","km/h")),S=b.map((ce,Je)=>-ce*Math.sin(M[Je]*Math.PI/180)),T=b.map((ce,Je)=>-ce*Math.cos(M[Je]*Math.PI/180));let E;if(a==="LL"&&Number.isFinite(r)&&r>=0&&r<=359?E=r:a==="RR"&&Number.isFinite(l)&&l>=0&&l<=359?E=l:E=Number.isFinite(o.landingWindDir)?o.landingWindDir:M[0],!Number.isFinite(E)){console.warn("Invalid landing wind direction:",E);return}function k(ce){const Je=h.getValue("windUnit","radio","kt"),Xt=g.convertWind(ce,Je,"kt");return Je==="bft"?Math.round(Xt):Xt.toFixed(1)}const C=(ce,Je,Xt,ns,as)=>{const Ca=ns*1.852/3.6*as/111e3,Aa=Xt*Math.PI/180,is=Ca*Math.cos(Aa),rs=Ca*Math.sin(Aa)/Math.cos(ce*Math.PI/180);return[ce+is,Je+rs]},N=[v,v+d];console.log("Final limits:",N);const F=g.calculateMeanWind(_,S,T,...N),P=F[0],I=F[1];if(!Number.isFinite(I)||!Number.isFinite(P)){console.warn("Invalid mean wind for final leg:",F);return}let x=null;I<=3?x="lightblue":I<=10?x="lightgreen":I<=16?x="#f5f34f":x="#ffcccc";const U=E,q=g.calculateWindAngle(U,P),{crosswind:R,headwind:te}=g.calculateWindComponents(I,q),ne=g.calculateWCA(R,c)*(R>=0?1:-1),K=g.normalizeAngle(U-ne),J=g.calculateCourseFromHeading(K,P,I,c).groundSpeed,fe=d/u,Ce=J*1.852/3.6*fe,Be=(E+180)%360,Y=C(f,y,Be,J,fe);(f+Y[0])/2,(y+Y[1])/2;const B=[v+d,v+m],X=g.calculateMeanWind(_,S,T,...B),G=X[0],ge=X[1];if(!Number.isFinite(ge)||!Number.isFinite(G)){console.warn("Invalid mean wind for base leg:",X);return}let Ae=null;ge<=3?Ae="lightblue":ge<=10?Ae="lightgreen":ge<=16?Ae="#f5f34f":Ae="#ffcccc",console.log("********* Landing Direction: ",a,"Effective Landing Wind Dir:",E);let _e=0;a==="LL"?(_e=(E+90)%360,console.log("Base Heading:",_e)):a==="RR"&&(_e=(E-90+360)%360,console.log("Base Heading:",_e));const tt=g.calculateCourseFromHeading(_e,G,ge,c),$e=tt.trueCourse,le=tt.groundSpeed;let ve=($e+180)%360;le<0&&(ve=(ve+180)%360,console.log("Base ground speed is negative:",le,"New course:",ve));const Ge=(m-d)/u,Ct=le*1.852/3.6*Ge;console.log("Base Course:",$e);const qt=g.calculateWindAngle($e,G),{crosswind:Sa,headwind:Gr}=g.calculateWindComponents(ge,qt),Vr=g.calculateWCA(Sa,c)*(Sa>=0?1:-1),he=C(Y[0],Y[1],ve,le,Ge);(Y[0]+he[0])/2,(Y[1]+he[1])/2;const Jr=[v+m,v+p],Kt=g.calculateMeanWind(_,S,T,...Jr),At=Kt[0],Ve=Kt[1];if(!Number.isFinite(Ve)||!Number.isFinite(At)){console.warn("Invalid mean wind for downwind leg:",Kt);return}let Pt=null;Ve<=3?Pt="lightblue":Ve<=10?Pt="lightgreen":Ve<=16?Pt="#f5f34f":Pt="#ffcccc";const Yt=E,Zr=g.calculateWindAngle(Yt,At),{crosswind:ba,headwind:jr}=g.calculateWindComponents(Ve,Zr),Ta=g.calculateWCA(ba,c)*(ba>=0?1:-1),qr=g.normalizeAngle((Yt-Ta+180)%360),Cn=g.calculateCourseFromHeading(qr,At,Ve,c).groundSpeed,ka=(p-m)/u,Kr=Cn*1.852/3.6*ka,nt=C(he[0],he[1],Yt,Cn,ka),Yr=[(f+Y[0])/2,(y+Y[1])/2],Xr=[(Y[0]+he[0])/2,(Y[1]+he[1])/2],Qr=[(he[0]+nt[0])/2,(he[1]+nt[1])/2];(he[0]+nt[0])/2,(he[1]+nt[1])/2,console.log(`Landing Pattern Updated:
        Final Leg: Wind: ${P.toFixed(1)}° @ ${I.toFixed(1)}kt, Course: ${U.toFixed(1)}°, WCA: ${ne.toFixed(1)}°, GS: ${J.toFixed(1)}kt, HW: ${te.toFixed(1)}kt, Length: ${Ce.toFixed(1)}m
        Base Leg: Wind: ${G.toFixed(1)}° @ ${ge.toFixed(1)}kt, Course: ${$e.toFixed(1)}°, WCA: ${Vr.toFixed(1)}°, GS: ${le.toFixed(1)}kt, HW: ${Gr.toFixed(1)}kt, Length: ${Ct.toFixed(1)}m
        Downwind Leg: Wind: ${At.toFixed(1)}° @ ${Ve.toFixed(1)}kt, Course: ${Yt.toFixed(1)}°, WCA: ${Ta.toFixed(1)}°, GS: ${Cn.toFixed(1)}kt, HW: ${jr.toFixed(1)}kt, Length: ${Kr.toFixed(1)}m`);const es=o.weatherData.time[n];console.log("+++++++++ Koordinaten Pattern:",es),console.log("Coordinates DIP: ",f,y,"Altitude DIP:",v),console.log("Coordinates final end: ",Y[0],Y[1],"Leg Height:",v+d),console.log("Coordinates base end: ",he[0],he[1],"Leg Height:",v+m),console.log("Coordinates downwind end: ",nt[0],nt[1],"Leg Height:",v+p);const ts={legs:[{path:[[f,y],Y],options:{color:"red",weight:3,opacity:.8,dashArray:"5, 10"}},{path:[Y,he],options:{color:"red",weight:3,opacity:.8,dashArray:"5, 10"}},{path:[he,nt],options:{color:"red",weight:3,opacity:.8,dashArray:"5, 10"}}],arrows:[{position:Yr,bearing:(P-90+180)%360,color:x,tooltipText:`${Math.round(P)}° ${k(I)}${h.getValue("windUnit","radio","kt")}`},{position:Xr,bearing:(X[0]-90+180)%360,color:Ae,tooltipText:`${Math.round(G)}° ${k(ge)}${h.getValue("windUnit","radio","kt")}`},{position:Qr,bearing:(Kt[0]-90+180)%360,color:Pt,tooltipText:`${Math.round(At)}° ${k(Ve)}${h.getValue("windUnit","radio","kt")}`}]};xt(ts)}function ee(){var i,s,r,l,c,u,d,m;if(console.log("updateJumpRunTrackDisplay called"),!o.map){console.warn("Map not initialized, cannot update jump run track display");return}if(!(h.state.userSettings.showJumpRunTrack&&o.weatherData&&o.lastLat&&o.lastLng&&h.state.isCalculateJumpUnlocked&&h.state.userSettings.calculateJump)){console.log("Conditions not met to show JRT, clearing display."),dn(null),o.lastTrackData=null;return}const e=Oe(),n=ut(e),a=_n(n);if(a&&((i=a.latlngs)==null?void 0:i.length)===2&&a.latlngs.every(p=>Number.isFinite(p[0])&&Number.isFinite(p[1]))){console.log("Drawing jump run track with data:",a);const p={path:{latlngs:a.latlngs,options:{color:"orange",weight:5,opacity:.8},tooltipText:`Jump Run Track: ${a.direction}°, Length: ${a.trackLength} m`,originalLatLngs:((r=(s=o.lastTrackData)==null?void 0:s.latlngs)==null?void 0:r.length)===2?o.lastTrackData.latlngs:a.latlngs},approachPath:((l=a.approachLatLngs)==null?void 0:l.length)===2&&a.approachLatLngs.every(f=>Number.isFinite(f[0])&&Number.isFinite(f[1]))?{latlngs:a.approachLatLngs,options:{color:"orange",weight:5,opacity:.8,dashArray:"5, 10"},tooltipText:`Approach Path: ${a.direction}°, Length: ${a.approachLength} m`,originalLatLngs:((u=(c=o.lastTrackData)==null?void 0:c.approachLatLngs)==null?void 0:u.length)===2?o.lastTrackData.approachLatLngs:a.approachLatLngs}:null,trackLength:a.trackLength,airplane:{position:L.latLng(a.latlngs[1][0],a.latlngs[1][1]),bearing:a.direction,originalPosition:(m=(d=o.lastTrackData)==null?void 0:d.latlngs)!=null&&m[1]&&Number.isFinite(o.lastTrackData.latlngs[1][0])?L.latLng(o.lastTrackData.latlngs[1][0],o.lastTrackData.latlngs[1][1]):L.latLng(a.latlngs[1][0],a.latlngs[1][1])}};dn(p),o.lastTrackData={latlngs:a.latlngs,approachLatLngs:a.approachLatLngs,direction:a.direction,trackLength:a.trackLength,approachLength:a.approachLength},console.log("Updated AppState.lastTrackData:",o.lastTrackData)}else console.warn("No valid track data to display:",a),dn(null),o.lastTrackData=null}let We=!1;function Nr(){const t=document.getElementById("locationSearchInput"),e=document.getElementById("locationResults"),n=document.getElementById("saveCurrentLocationBtn");if(!t||!e||!n){console.error("Einige UI-Elemente für die Ortssuche wurden nicht gefunden.");return}const a=g.debounce(ic,300);t.addEventListener("input",()=>{a(t.value)}),t.addEventListener("focus",()=>{t.value.trim()||xe(),e.style.display="block"}),t.addEventListener("blur",()=>{setTimeout(()=>{e.style.display="none"},200)}),n._clickHandler&&(n.removeEventListener("click",n._clickHandler),console.log("Entfernte bestehenden click-Listener für saveCurrentLocationBtn")),n._clickHandler=i=>{if(i.stopPropagation(),o.lastLat===null||o.lastLng===null){g.handleError("Please select a location on the map first.");return}if(We){console.log("saveFavoriteBtn Klick blockiert: Ein Favorit wird bereits hinzugefügt.");return}const s=`DIP at ${o.lastLat.toFixed(4)}, ${o.lastLng.toFixed(4)}`,r=prompt("Enter a name for this favorite:",s);if(r){We=!0;try{Fr(o.lastLat,o.lastLng,r),Ma(o.lastLat,o.lastLng,r,!0)}finally{We=!1,console.log("saveFavoriteBtn Aktion abgeschlossen, Sperre aufgehoben.")}}},n.addEventListener("click",n._clickHandler),console.log("Neuer click-Listener für saveCurrentLocationBtn hinzugefügt"),document.addEventListener("click",i=>{!t.contains(i.target)&&!e.contains(i.target)&&(e.style.display="none")})}async function ic(t){if(console.log("performSearch: Suche nach:",t),!t.trim()){console.log("performSearch: Leere Eingabe, zeige Favoriten/Verlauf."),xe();return}let e=[];const n=rc(t);if(n)console.log("performSearch: Koordinaten gefunden:",n),e.push({display_name:`Koordinate: ${n.lat.toFixed(5)}, ${n.lng.toFixed(5)}`,lat:n.lat,lon:n.lng,type:"coordinate"}),xe(e);else{console.log("performSearch: Keine Koordinaten, starte Nominatim-Suche.");try{const a=`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(t)}&format=json&limit=5&addressdetails=1`,i=await fetch(a,{method:"GET",headers:{"User-Agent":"Skydiving-Weather-App/1.0 (anonymous)"}});if(!i.ok)throw new Error(`Nominatim API Fehler: ${i.statusText}`);const s=await i.json();console.log("performSearch: Nominatim Ergebnisse:",s),e=s,xe(e)}catch(a){console.error("Fehler bei der Geocoding-Suche:",a),g.handleError("Could not find location."),xe([])}}}function rc(t){console.log("parseQueryAsCoordinates: Eingabe:",t);const e=t.trim(),a=e.replace(/[,;\t]+/," ").trim().match(/^(-?\d{1,3}(?:\.\d+)?)\s+(-?\d{1,3}(?:\.\d+)?)$/);if(a){const r=parseFloat(a[1]),l=parseFloat(a[3]);if(console.log("parseQueryAsCoordinates: Dezimalgraden erkannt:",{lat:r,lng:l}),r>=-90&&r<=90&&l>=-180&&l<=180)return{lat:r,lng:l};console.warn("parseQueryAsCoordinates: Ungültige Koordinatenbereiche:",{lat:r,lng:l})}const i=e.replace(/\s/g,"").toUpperCase(),s=/^[0-9]{1,2}[C-HJ-NP-X][A-HJ-NP-Z]{2}(\d{2}|\d{4}|\d{6}|\d{8}|\d{10})$/;if(typeof kl>"u")return console.warn("parseQueryAsCoordinates: MGRS-Bibliothek nicht geladen."),null;if(s.test(i))try{const[r,l]=_a(i);if(console.log("parseQueryAsCoordinates: MGRS erkannt:",{lat:l,lng:r}),!isNaN(l)&&!isNaN(r))return{lat:l,lng:r};console.warn("parseQueryAsCoordinates: Ungültige MGRS-Koordinaten:",{lat:l,lng:r})}catch(r){return console.warn("parseQueryAsCoordinates: MGRS-Parsing fehlgeschlagen:",r.message),null}return console.log("parseQueryAsCoordinates: Keine Koordinaten erkannt."),null}function xe(t=[]){const e=document.getElementById("locationResults");if(!e){console.error("resultsList nicht gefunden.");return}e.innerHTML="";const n=jt(),a=n.filter(r=>r.isFavorite),i=n.filter(r=>!r.isFavorite);console.log("renderResultsList: Favoriten:",a),console.log("renderResultsList: Verlauf (nicht Favoriten):",i),console.log("renderResultsList: Suchergebnisse:",t);const s=r=>{const l=document.createElement("li"),c=parseFloat(r.lat),u=parseFloat(r.lng||r.lon);if(isNaN(c)||isNaN(u))return console.error("Ungültige Koordinaten in createListItem:",r),null;console.log("createListItem: Verarbeite Eintrag:",{lat:c,lng:u,label:r.display_name||r.label}),l.dataset.lat=c,l.dataset.lon=u;const d=document.createElement("span");d.className="location-name",d.textContent=r.display_name||r.label,l.appendChild(d),d.addEventListener("mousedown",y=>{const v=new CustomEvent("location:selected",{detail:{lat:c,lng:u},bubbles:!0,cancelable:!0});l.dispatchEvent(v),Ma(c,u,r.display_name||r.label,r.isFavorite||!1),e.style.display="none"});const m=document.createElement("div");m.className="location-item-buttons";const p=document.createElement("button");p.className="favorite-toggle",p.innerHTML=r.isFavorite?"★":"☆",r.isFavorite&&p.classList.add("is-favorite"),p.title="Als Favorit markieren/entfernen",m.appendChild(p),p.addEventListener("click",y=>{y.stopPropagation(),console.log("favToggle Klick für:",{lat:c,lng:u,label:r.display_name||r.label}),sc(c,u,r.display_name||r.label)});const f=document.createElement("button");return f.className="delete-location-btn",f.textContent="×",f.title="Diesen Eintrag löschen",m.appendChild(f),f.addEventListener("click",y=>{y.stopPropagation(),confirm(`Möchten Sie "${r.display_name||r.label}" wirklich löschen?`)&&oc(c,u)}),l.appendChild(m),l};if(t.length>0){const r=document.createElement("li");r.className="results-heading",r.textContent="Results",r.style.fontWeight="bold",r.style.background="#f0f0f0",e.appendChild(r),t.forEach(l=>{const c=parseFloat(l.lat),u=parseFloat(l.lon),d=a.find(f=>Math.abs(f.lat-c)<.001&&Math.abs(f.lng-u)<.001);l.isFavorite=!!d,d&&(l.display_name=d.label);const m={lat:c,lng:u,display_name:l.display_name,isFavorite:l.isFavorite},p=s(m);p&&e.appendChild(p)})}if(a.length>0){const r=document.createElement("li");r.className="results-heading",r.textContent="Favorites",r.style.fontWeight="bold",r.style.background="#f0f0f0",e.appendChild(r),a.forEach(l=>{const c=s(l);c&&e.appendChild(c)})}if(i.length>0){const r=document.createElement("li");r.className="results-heading",r.textContent="Previous Locations",r.style.fontWeight="bold",r.style.background="#f0f0f0",e.appendChild(r),i.forEach(l=>{const c=s(l);c&&e.appendChild(c)})}console.log("renderResultsList: Liste gerendert.")}function jt(){try{return JSON.parse(localStorage.getItem("coordHistory"))||[]}catch{return[]}}function Wt(t){try{localStorage.setItem("coordHistory",JSON.stringify(t))}catch(e){console.error("Error saving history:",e)}}function Ma(t,e,n,a=!1){if(isNaN(t)||isNaN(e))return;let i=jt();const s=parseFloat(t.toFixed(5)),r=parseFloat(e.toFixed(5));i=i.filter(u=>Math.abs(u.lat-s)>1e-4||Math.abs(u.lng-r)>1e-4),i.unshift({lat:s,lng:r,label:n,isFavorite:a,timestamp:Date.now()});const l=i.filter(u=>u.isFavorite),c=i.filter(u=>!u.isFavorite).slice(0,5);Wt([...l,...c]),xe()}function Fr(t,e,n,a=!1){if(isNaN(t)||isNaN(e)){console.error("Ungültige Koordinaten in addOrUpdateFavorite:",{lat:t,lng:e});return}if(We){console.log("addOrUpdateFavorite blockiert.");return}We=!0;try{let i=jt();const s=parseFloat(t.toFixed(5)),r=parseFloat(e.toFixed(5));console.log("addOrUpdateFavorite: Verarbeite:",{newLat:s,newLng:r,name:n});const l=i.find(c=>Math.abs(c.lat-s)<1e-4&&Math.abs(c.lng-r)<1e-4);if(l)console.log("addOrUpdateFavorite: Aktualisiere bestehenden Eintrag:",l),l.isFavorite=!0,l.label=n;else{const c={lat:s,lng:r,label:n,isFavorite:!0,timestamp:Date.now()};console.log("addOrUpdateFavorite: Füge neuen Eintrag hinzu:",c),i.unshift(c)}Wt(i),console.log("addOrUpdateFavorite: Verlauf nach Speicherung:",JSON.stringify(i)),a||g.handleMessage(`"${n}" als Favorit gespeichert.`),xe()}catch(i){console.error("Fehler in addOrUpdateFavorite:",i)}finally{We=!1,console.log("addOrUpdateFavorite abgeschlossen.")}}function sc(t,e,n){if(isNaN(t)||isNaN(e)){console.error("Ungültige Koordinaten in toggleFavorite:",{lat:t,lng:e});return}if(We){console.log("toggleFavorite blockiert: Ein Favorit wird bereits hinzugefügt.");return}let a=jt();const i=parseFloat(t.toFixed(5)),s=parseFloat(e.toFixed(5));console.log("toggleFavorite: Suche nach Eintrag mit:",{newLat:i,newLng:s,label:n});const r=a.find(l=>{const c=parseFloat(l.lat),u=parseFloat(l.lng);return Math.abs(c-i)<1e-4&&Math.abs(u-s)<1e-4});if(r)if(console.log("toggleFavorite: Bestehender Eintrag gefunden:",r),r.isFavorite)r.isFavorite=!1,g.handleMessage(`"${r.label}" ist kein Favorit mehr.`),Wt(a),xe();else{We=!0;try{const l=prompt("Please enter a name for this favorite:",r.label||n);if(l)r.isFavorite=!0,r.label=l,g.handleMessage(`"${l}" als Favorit gespeichert.`),Wt(a),xe();else{r.isFavorite=!1;return}}finally{We=!1,console.log("toggleFavorite abgeschlossen, Sperre aufgehoben.")}}else{console.log("toggleFavorite: Kein bestehender Eintrag, füge neuen Favoriten hinzu.");const l=prompt("Please enter a name for this favorite:",n);l&&Fr(i,s,l)}}function oc(t,e){if(isNaN(t)||isNaN(e))return;const a=jt().filter(i=>{const s=parseFloat(i.lat),r=parseFloat(i.lng||i.lon);return Math.abs(s-t)>1e-4||Math.abs(r-e)>1e-4});Wt(a),g.handleMessage("Location deleted."),xe()}function lc(t,e,n,a){if(!o.map)return console.warn("Map not initialized for getTooltipContent"),"Map not initialized";const i=h.getValue("coordFormat","radio","Decimal"),s=h.getValue("windUnit","radio","kt"),r=h.getValue("heightUnit","radio","m"),l=g.convertCoords(t.lat,t.lng,i);let c=i==="MGRS"?`MGRS: ${l.lat}`:`Lat: ${l.lat}<br>Lng: ${l.lng}`;const u=t.ele;let d=u!==null&&a!==null?u-a:null;if(d!==null){const f=r||h.state.userSettings.heightUnit||"m";d=g.convertHeight(d,f),d=Math.round(d),c+=`<br>Altitude: ${d} ${f} AGL`}else c+="<br>Altitude: N/A";let m="N/A",p="N/A";if(e>0&&t.time&&n[e-1].time&&t.ele!==null&&n[e-1].ele!==null){const f=(t.time.toMillis()-n[e-1].time.toMillis())/1e3;if(f>0){const v=o.map.distance([n[e-1].lat,n[e-1].lng],[t.lat,t.lng])/f;m=g.convertWind(v,s,"m/s"),m=s==="bft"?Math.round(m):m.toFixed(1),p=((t.ele-n[e-1].ele)/f).toFixed(1)}}return c+=`<br>Speed: ${m} ${s}`,c+=`<br>Descent Rate: ${p} m/s`,c}async function cc(t){if(!o.map)return g.handleError("Map not initialized."),null;o.isLoadingGpx=!0;const e=new FileReader;return new Promise((n,a)=>{e.onload=async function(i){var s,r;try{const l=i.target.result,d=new DOMParser().parseFromString(l,"text/xml").getElementsByTagName("trkpt"),m=[];for(let f=0;f<d.length;f++){const y=parseFloat(d[f].getAttribute("lat")),v=parseFloat(d[f].getAttribute("lon"));if(isNaN(y)||isNaN(v))continue;const w=(s=d[f].getElementsByTagName("ele")[0])==null?void 0:s.textContent,_=(r=d[f].getElementsByTagName("time")[0])==null?void 0:r.textContent;m.push({lat:y,lng:v,ele:w?parseFloat(w):null,time:_?D.fromISO(_,{zone:"utc"}):null})}if(m.length<2)throw new Error("GPX track has insufficient points.");const p=await xr(m,t.name);n(p)}catch(l){console.error("[trackManager] Error in loadGpxTrack:",l),g.handleError("Error parsing GPX file: "+l.message),n(null)}finally{o.isLoadingGpx=!1}},e.onerror=()=>{g.handleError("Error reading GPX file."),o.isLoadingGpx=!1,a(new Error("Error reading GPX file."))},e.readAsText(t)})}async function uc(t){if(!o.map)return g.handleError("Map not initialized."),null;o.isLoadingGpx=!0;const e=new FileReader;return new Promise((n,a)=>{e.onload=async function(i){try{const s=i.target.result,r=[];Papa.parse(s,{skipEmptyLines:!0,step:function(l){const c=l.data;if(c[0]&&c[0].toUpperCase()==="$GNSS"&&c.length>=5){let u=c[1];const d=parseFloat(c[2]),m=parseFloat(c[3]),p=parseFloat(c[4]);if(isNaN(d)||isNaN(m)||isNaN(p))return;let f=null;try{f=D.fromISO(u,{setZone:!0}).toUTC(),f.isValid||(f=null)}catch{f=null}r.push({lat:d,lng:m,ele:p,time:f})}},complete:async function(){if(r.length<2)throw new Error("CSV track has insufficient points.");const l=await xr(r,t.name);n(l)},error:function(l){throw new Error("Error parsing CSV: "+l.message)}})}catch(s){console.error("[trackManager] Error in loadCsvTrackUTC:",s),g.handleError("Error parsing CSV file: "+s.message),n(null)}finally{o.isLoadingGpx=!1}},e.onerror=()=>{g.handleError("Error reading CSV file."),o.isLoadingGpx=!1,a(new Error("Error reading CSV file."))},e.readAsText(t)})}async function xr(t,e){try{if(console.log(`[trackManager] renderTrack called for ${e} with ${t.length} points.`),!o.map)return console.warn("[trackManager] Map object in AppState is not available in renderTrack."),g.handleError("Map not initialized. Cannot render track."),null;o.gpxLayer&&o.map.hasLayer(o.gpxLayer)&&o.map.removeLayer(o.gpxLayer),o.gpxLayer=null,o.gpxPoints=t,o.isTrackLoaded=!1;const n={finalPointData:null,timestampToUseForWeather:null,historicalDateString:null,summaryForInfoElement:"",success:!1};if(t.length>0){const i=t[t.length-1];if(o.lastLat=i.lat,o.lastLng=i.lng,o.lastAltitude=await g.getAltitude(o.lastLat,o.lastLng),n.finalPointData={lat:o.lastLat,lng:o.lastLng,altitude:o.lastAltitude},t[0].time&&t[0].time.isValid){const d=t[0].time,m=D.utc().startOf("day"),p=d.startOf("day");p<m&&(n.historicalDateString=p.toFormat("yyyy-MM-dd"));let f=d.startOf("hour");d.minute>=30&&(f=f.plus({hours:1})),n.timestampToUseForWeather=f.toISO()}const s=(t.reduce((d,m,p)=>{if(p===0||!o.map)return 0;const f=t[p-1];return d+o.map.distance([f.lat,f.lng],[m.lat,m.lng])},0)/1e3).toFixed(2),r=t.map(d=>d.ele).filter(d=>d!==null),l=r.length?Math.min(...r).toFixed(0):"N/A",c=r.length?Math.max(...r).toFixed(0):"N/A",u=new CustomEvent("track:loaded",{detail:{lat:o.lastLat,lng:o.lastLng,altitude:o.lastAltitude,timestamp:n.timestampToUseForWeather,historicalDate:n.historicalDateString,summary:`<br><strong>Track:</strong> Distance: ${s} km, Min Elevation: ${l} m, Max Elevation: ${c} m (Source: ${e})`},bubbles:!0,cancelable:!0});o.map.getContainer().dispatchEvent(u)}o.gpxLayer=L.layerGroup([],{pane:"gpxTrackPane"});const a=o.lastAltitude!=="N/A"&&!isNaN(o.lastAltitude)?parseFloat(o.lastAltitude):null;for(let i=0;i<t.length-1;i++){const s=t[i],r=t[i+1],l=s.ele,c=r.ele;let u="#808080";if(a!==null&&l!==null&&c!==null){const m=l-a,p=c-a,f=(m+p)/2;u=g.interpolateColor(f)}const d=L.polyline([[s.lat,s.lng],[r.lat,r.lng]],{color:u,weight:4,opacity:.75,pane:"gpxTrackPane"}).bindTooltip("",{sticky:!0});d.on("mousemove",function(m){const p=m.latlng;let f=t[0],y=1/0,v=0;t.forEach((w,_)=>{const M=Math.sqrt(Math.pow(w.lat-p.lat,2)+Math.pow(w.lng-p.lng,2));M<y&&(y=M,f=w,v=_)}),d.setTooltipContent(lc(f,v,t,a)).openTooltip(p)}),o.gpxLayer.addLayer(d)}if(o.map&&o.gpxLayer.addTo(o.map),o.isTrackLoaded=!0,t.length>0&&o.map){const i=L.latLngBounds(t.map(s=>[s.lat,s.lng]));i.isValid()?o.map.fitBounds(i,{padding:[50,50],maxZoom:o.map.getMaxZoom()||18}):g.handleError("Unable to display track: invalid coordinates.")}return n.success=!0,console.log("[trackManager] renderTrack finished successfully."),n}catch(n){return console.error("[trackManager] Error in renderTrack:",n),g.handleError("Error rendering track: "+n.message),o.gpxPoints=[],o.gpxLayer&&o.map&&o.map.hasLayer(o.gpxLayer)&&o.map.removeLayer(o.gpxLayer),o.gpxLayer=null,o.isTrackLoaded=!1,{success:!1,error:n.message}}}function dc(t,e){return L.marker([t,e],{icon:L.divIcon({className:"live-marker",html:'<div style="background-color: blue; width: 10px; height: 10px; border-radius: 50%;"></div>',iconSize:[10,10],iconAnchor:[5,5]}),zIndexOffset:1e3})}function hc(t,e,n){o.accuracyCircle&&o.map.removeLayer(o.accuracyCircle),o.accuracyCircle=L.circle([t,e],{radius:n,color:"blue",fillOpacity:.1,weight:1,dashArray:"5, 5"}).addTo(o.map)}const mc=g.debounce(async t=>{if(console.log("[LiveTrackingManager] Received position data:",t),!o.map){console.warn("[LiveTrackingManager] Map not initialized, skipping position update.");return}const{latitude:e,longitude:n,accuracy:a,altitude:i,altitudeAccuracy:s}=t.coords;if(console.log("[LiveTrackingManager] Position details:",{latitude:e,longitude:n,accuracy:a,deviceAltitude:i,altitudeAccuracy:s}),a>Te.GEOLOCATION_ACCURACY_THRESHOLD_M){console.log("[LiveTrackingManager] Skipping position update due to low accuracy:",a);return}const r=Date.now();let l=0,c="N/A";if(o.prevLat!==null&&o.prevLng!==null&&o.prevTime!==null){const m=o.map.distance([o.prevLat,o.prevLng],[e,n]),p=(r-o.prevTime)/1e3;p>tn.MIN_TIME_DIFF_FOR_SPEED_CALC_S&&(l=m/p,c=g.calculateBearing(o.prevLat,o.prevLng,e,n).toFixed(0))}const u=l<tn.SPEED_SMOOTHING_TRESHOLD?tn.SPEED_SMOOTHING_LOW:tn.SPEED_SMOOTHING_HIGH;o.lastSmoothedSpeedMs=u*l+(1-u)*o.lastSmoothedSpeedMs,o.liveMarker?o.liveMarker.setLatLng([e,n]):o.liveMarker=dc(e,n).addTo(o.map),a&&hc(e,n,a),o.prevLat=e,o.prevLng=n,o.prevTime=r;const d=new CustomEvent("tracking:positionUpdated",{detail:{latitude:e,longitude:n,deviceAltitude:i,altitudeAccuracy:s,accuracy:a,speedMs:o.lastSmoothedSpeedMs,direction:c},bubbles:!0,cancelable:!0});console.log("[LiveTrackingManager] Dispatching tracking:positionUpdated event:",d.detail),document.dispatchEvent(d)},300);function pc(){if(o.watchId===null){if(!navigator.geolocation){g.handleError("Geolocation is not supported by your browser."),document.dispatchEvent(new CustomEvent("tracking:stopped"));return}console.log("[LiveTrackingManager] Starting position tracking..."),o.watchId=navigator.geolocation.watchPosition(mc,t=>{g.handleError(`Geolocation error: ${t.message}`),Or()},{enableHighAccuracy:!0,maximumAge:0,timeout:1e4}),document.dispatchEvent(new CustomEvent("tracking:started"))}}function Or(){o.watchId!==null&&(navigator.geolocation.clearWatch(o.watchId),o.watchId=null),o.liveMarker&&o.map.removeLayer(o.liveMarker),o.accuracyCircle&&o.map.removeLayer(o.accuracyCircle),o.liveMarker=null,o.accuracyCircle=null,o.prevLat=null,o.prevLng=null,o.prevTime=null,o.lastSmoothedSpeedMs=0,document.dispatchEvent(new CustomEvent("tracking:stopped")),console.log("[LiveTrackingManager] Stopped position tracking and cleaned up.")}function fi(){if(o.autoupdateInterval){console.log("[AutoupdateManager] Autoupdate is already running.");return}if(!navigator.onLine){g.handleError("Cannot enable autoupdate while offline.");const t=document.getElementById("autoupdateCheckbox");t&&(t.checked=!1),h.state.userSettings.autoupdate=!1,h.save();return}console.log("[AutoupdateManager] Starting autoupdate interval."),document.dispatchEvent(new CustomEvent("autoupdate:tick",{detail:{isInitialTick:!0}})),o.autoupdateInterval=setInterval(()=>{console.log("[AutoupdateManager] Tick..."),document.dispatchEvent(new CustomEvent("autoupdate:tick",{detail:{isInitialTick:!1}}))},60*1e3),Se("Autoupdate enabled")}function $r(){o.autoupdateInterval&&(clearInterval(o.autoupdateInterval),o.autoupdateInterval=null,console.log("[AutoupdateManager] Stopped autoupdate interval."),Se("Autoupdate disabled"))}function fc(){var e;const t=document.getElementById("autoupdateCheckbox");if(!t){console.warn("[AutoupdateManager] Autoupdate checkbox not found.");return}t.checked=h.state.userSettings.autoupdate,t.addEventListener("change",()=>{h.state.userSettings.autoupdate=t.checked,h.save();const n=document.getElementById("historicalDatePicker");if(t.checked&&(n!=null&&n.value)){t.checked=!1,h.state.userSettings.autoupdate=!1,h.save(),Mt("Autoupdate cannot be enabled with a historical date set.");return}t.checked?fi():$r()}),h.state.userSettings.autoupdate&&!((e=document.getElementById("historicalDatePicker"))!=null&&e.value)&&fi()}var gc=15e3,oa=1e3,la=60*oa,hn=60*la,Wn=24*hn,yc="http://www.topografix.com/GPX/gpx_style/0/2",ln=new L.Icon.Default,wc={startIcon:ln,endIcon:ln,wptIcons:{"":ln},wptTypeIcons:{"":ln},pointMatchers:[]},_c={iconSize:[33,45],iconAnchor:[16,45],clickable:!1},vc={color:"blue"},Lc={parseElements:["track","route","waypoint"],joinTrackSegments:!0};L.GPX=L.FeatureGroup.extend({initialize:function(t,e){e.max_point_interval=e.max_point_interval||gc,e.markers=this._merge_objs(wc,e.markers||{}),e.marker_options=this._merge_objs(_c,e.marker_options||{}),e.polyline_options=e.polyline_options||[],e.gpx_options=this._merge_objs(Lc,e.gpx_options||{}),L.Util.setOptions(this,e),L.GPXTrackIcon=L.Icon.extend({options:e.marker_options}),this._gpx=t,this._layers={},this._prepare_markers(e.markers),this._init_info(),t&&this._parse(t,e,this.options.async)},get_duration_string:function(t,e){var n="";t>=Wn&&(n+=Math.floor(t/Wn)+"d ",t=t%Wn),t>=hn&&(n+=Math.floor(t/hn)+":",t=t%hn);var a=Math.floor(t/la);t=t%la,a<10&&(n+="0"),n+=a+"'";var i=Math.floor(t/oa);return t=t%oa,i<10&&(n+="0"),n+=i,!e&&t>0?n+="."+Math.round(Math.floor(t)*1e3)/1e3:n+='"',n},get_duration_string_iso:function(t,e){var n=this.get_duration_string(t,e);return n.replace("'",":").replace('"',"")},_toFixed_helper:function(t,e=0){return typeof t=="number"?t.toFixed(e):"?"},to_miles:function(t){return t/1.60934},to_ft:function(t){return t*3.28084},m_to_km:function(t){return t/1e3},m_to_mi:function(t){return t/1609.34},ms_to_kmh:function(t){return t*3.6},ms_to_mih:function(t){return t/1609.34*3600},get_name:function(){return this._info.name},get_desc:function(){return this._info.desc},get_author:function(){return this._info.author},get_copyright:function(){return this._info.copyright},get_distance:function(){return this._info.length},get_distance_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))},get_start_time:function(){return this._info.duration.start},get_end_time:function(){return this._info.duration.end},get_moving_time:function(){return this._info.duration.moving},get_total_time:function(){return this._info.duration.total},get_moving_pace:function(){return this.get_moving_time()/this.m_to_km(this.get_distance())},get_moving_pace_imp:function(){return this.get_moving_time()/this.get_distance_imp()},get_moving_speed:function(){return this.m_to_km(this.get_distance())/(this.get_moving_time()/(3600*1e3))},get_moving_speed_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))/(this.get_moving_time()/(3600*1e3))},get_total_speed:function(){return this.m_to_km(this.get_distance())/(this.get_total_time()/(3600*1e3))},get_total_speed_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))/(this.get_total_time()/(3600*1e3))},get_elevation_gain:function(){return this._info.elevation.gain},get_elevation_loss:function(){return this._info.elevation.loss},get_elevation_gain_imp:function(){return this.to_ft(this.get_elevation_gain())},get_elevation_loss_imp:function(){return this.to_ft(this.get_elevation_loss())},get_elevation_data:function(){var t=this;return this._info.elevation._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" m"})})},get_elevation_data_imp:function(){var t=this;return this._info.elevation._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,t.to_ft,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" ft"})})},get_elevation_max:function(){return this._info.elevation.max},get_elevation_min:function(){return this._info.elevation.min},get_elevation_max_imp:function(){return this.to_ft(this.get_elevation_max())},get_elevation_min_imp:function(){return this.to_ft(this.get_elevation_min())},get_speed_data:function(){var t=this;return this._info.speed._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,t.ms_to_kmh,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,2)+" km/h"})})},get_speed_data_imp:function(){var t=this;return this._info.speed._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,t.ms_to_mih,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,2)+" mi/h"})})},get_speed_max:function(){return this.m_to_km(this._info.speed.max)*3600},get_speed_max_imp:function(){return this.to_miles(this.get_speed_max())},get_average_hr:function(){return this._info.hr.avg},get_average_temp:function(){return this._info.atemp.avg},get_average_cadence:function(){return this._info.cad.avg},get_heartrate_data:function(){var t=this;return this._info.hr._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" bpm"})})},get_heartrate_data_imp:function(){var t=this;return this._info.hr._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,null,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" bpm"})})},get_cadence_data:function(){var t=this;return this._info.cad._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" rpm"})})},get_temp_data:function(){var t=this;return this._info.atemp._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" degrees"})})},get_cadence_data_imp:function(){var t=this;return this._info.cad._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,null,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" rpm"})})},get_temp_data_imp:function(){var t=this;return this._info.atemp._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,null,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" degrees"})})},reload:function(){this._init_info(),this.clearLayers(),this._parse(this._gpx,this.options,this.options.async)},_merge_objs:function(t,e){var n={};for(var a in t)n[a]=t[a];for(var a in e)n[a]=e[a];return n},_prepare_data_point:function(t,e,n,a){var i=[e&&e(t[0])||t[0],n&&n(t[1])||t[1]];return i.push(a&&a(i[0],i[1])||i[0]+": "+i[1]),i},_prepare_markers:function(t){function e(n){return new L.GPXTrackIcon({iconUrl:n})}return Object.entries(t).forEach(([n,a])=>{n==="wptIcons"||n==="wptTypeIcons"?t[n]=this._prepare_markers(a):n==="pointMatchers"?t[n]=a.map(i=>(typeof i.icon=="string"&&(i.icon=e(i.icon)),i)):typeof a=="string"?t[n]=e(a):typeof a=="object"&&a!==null&&(t[n]=a)}),t},_init_info:function(){this._info={name:null,length:0,elevation:{gain:0,loss:0,max:0,min:1/0,_points:[]},speed:{max:0,_points:[]},hr:{avg:0,_total:0,_points:[]},duration:{start:null,end:null,moving:0,total:0},atemp:{avg:0,_total:0,_points:[]},cad:{avg:0,_total:0,_points:[]}}},_load_xml:function(t,e,n,a){a==null&&(a=this.options.async),n==null&&(n=this.options);var i=this,s=new window.XMLHttpRequest;s.open("GET",t,a);try{s.overrideMimeType("text/xml")}catch{}s.onloadend=function(){s.status==200?e(s.responseXML,n):i.fire("error",{err:"Error fetching resource: "+t})},s.send(null)},_parse:function(t,e,n){var a=this,i=function(r,l){var c=a._parse_gpx_data(r,l);if(!c){a.fire("error",{err:"No parseable layers of type(s) "+JSON.stringify(l.gpx_options.parseElements)});return}a.addLayer(c),a.fire("loaded",{layers:c,element:r})};if(t.substr(0,1)==="<"){var s=new DOMParser;n?setTimeout(function(){i(s.parseFromString(t,"text/xml"),e)}):i(s.parseFromString(t,"text/xml"),e)}else this._load_xml(t,i,e,n)},_parse_gpx_data:function(t,e){var n,a,i=[],s=t.getElementsByTagName("name");s.length>0&&(this._info.name=s[0].textContent);var r=t.getElementsByTagName("desc");r.length>0&&(this._info.desc=r[0].textContent);var l=t.getElementsByTagName("author");l.length>0&&(this._info.author=l[0].textContent);var c=t.getElementsByTagName("copyright");c.length>0&&(this._info.copyright=c[0].textContent);var u=e.gpx_options.parseElements;if(u.indexOf("route")>-1){var d=t.getElementsByTagName("rte");for(n=0;n<d.length;n++){var m=d[n],p=this._extract_styling(m),f=this._get_polyline_options(e.polyline_options,n);i=i.concat(this._parse_segment(d[n],e,p,f,"rtept"))}}if(u.indexOf("track")>-1){var y=t.getElementsByTagName("trk");for(n=0;n<y.length;n++){var v=y[n],p=this._extract_styling(v),f=this._get_polyline_options(e.polyline_options,n);if(e.gpx_options.joinTrackSegments)i=i.concat(this._parse_segment(v,e,p,f,"trkpt"));else{var w=v.getElementsByTagName("trkseg");for(I=0;I<w.length;I++)i=i.concat(this._parse_segment(w[I],e,p,f,"trkpt"))}}}if(this._info.hr.avg=Math.round(this._info.hr._total/this._info.hr._points.length),this._info.cad.avg=Math.round(this._info.cad._total/this._info.cad._points.length),this._info.atemp.avg=Math.round(this._info.atemp._total/this._info.atemp._points.length),u.indexOf("waypoint")>-1)for(a=t.getElementsByTagName("wpt"),n=0;n<a.length;n++){var _=new L.LatLng(a[n].getAttribute("lat"),a[n].getAttribute("lon")),M=a[n].getElementsByTagName("name"),s=M.length>0?M[0].textContent:"",b=a[n].getElementsByTagName("desc"),r=b.length>0?b[0].textContent:"",S=a[n].getElementsByTagName("sym"),T=S.length>0?S[0].textContent:null,E=a[n].getElementsByTagName("type"),k=E.length>0?E[0].textContent:null,C=e.markers.wptIcons,N=e.markers.wptTypeIcons,F=e.markers.pointMatchers||[],P;if(C&&T&&C[T])P=C[T];else if(N&&k&&N[k])P=N[k];else if(F.length>0){for(var I=0;I<F.length;I++)if(F[I].regex.test(s)){P=F[I].icon;break}}else C&&C[""]&&(P=C[""]);if(!P){console.log("No waypoint icon could be matched for symKey=%s,typeKey=%s,name=%s on waypoint %o",T,k,s,a[n]);continue}var x=new L.Marker(_,{clickable:e.marker_options.clickable,title:s,icon:P,type:"waypoint"});x.bindPopup("<b>"+s+"</b>"+(r.length>0?"<br>"+r:"")).openPopup(),this.fire("addpoint",{point:x,point_type:"waypoint",element:a[n]}),i.push(x)}if(i.length>1)return new L.FeatureGroup(i);if(i.length==1)return i[0]},_parse_segment:function(t,e,n,a,i){var s=t.getElementsByTagName(i);if(!s.length)return[];for(var r=[],l=[],c=[],u=null,d=0;d<s.length;d++){var m,p=new L.LatLng(s[d].getAttribute("lat"),s[d].getAttribute("lon"));p.meta={time:null,ele:null,hr:null,cad:null,atemp:null,speed:null},m=s[d].getElementsByTagName("time"),m.length>0?p.meta.time=new Date(Date.parse(m[0].textContent)):p.meta.time=new Date("1970-01-01T00:00:00");var f=u!=null?Math.abs(p.meta.time-u.meta.time):0;m=s[d].getElementsByTagName("ele"),m.length>0?p.meta.ele=parseFloat(m[0].textContent):p.meta.ele=u!=null?u.meta.ele:null;var y=u!=null?p.meta.ele-u.meta.ele:0,v=u!=null?this._dist3d(u,p):0;if(m=s[d].getElementsByTagName("speed"),m.length>0?p.meta.speed=parseFloat(m[0].textContent):p.meta.speed=f>0?1e3*v/f:0,m=s[d].getElementsByTagName("name"),m.length>0){for(var w=m[0].textContent,_=e.markers.pointMatchers||[],M=0;M<_.length;M++)if(_[M].regex.test(w)){l.push({label:w,coords:p,icon:_[M].icon,element:s[d]});break}}this._info.length+=v,m=s[d].getElementsByTagNameNS("*","hr"),m.length>0&&(p.meta.hr=parseInt(m[0].textContent),this._info.hr._points.push([this._info.length,p.meta.hr]),this._info.hr._total+=p.meta.hr),m=s[d].getElementsByTagNameNS("*","cad"),m.length>0&&(p.meta.cad=parseInt(m[0].textContent),this._info.cad._points.push([this._info.length,p.meta.cad]),this._info.cad._total+=p.meta.cad),m=s[d].getElementsByTagNameNS("*","atemp"),m.length>0&&(p.meta.atemp=parseInt(m[0].textContent),this._info.atemp._points.push([this._info.length,p.meta.atemp]),this._info.atemp._total+=p.meta.atemp),p.meta.ele>this._info.elevation.max&&(this._info.elevation.max=p.meta.ele),p.meta.ele<this._info.elevation.min&&(this._info.elevation.min=p.meta.ele),this._info.elevation._points.push([this._info.length,p.meta.ele]),p.meta.speed>this._info.speed.max&&(this._info.speed.max=p.meta.speed),this._info.speed._points.push([this._info.length,p.meta.speed]),u==null&&this._info.duration.start==null&&(this._info.duration.start=p.meta.time),this._info.duration.end=p.meta.time,this._info.duration.total+=f,f<e.max_point_interval&&(this._info.duration.moving+=f),y>0?this._info.elevation.gain+=y:this._info.elevation.loss+=Math.abs(y),u=p,r.push(p)}var b=new L.Polyline(r,this._extract_styling(t,n,a));if(this.fire("addline",{line:b,element:t}),c.push(b),e.markers.startIcon){var S=new L.Marker(r[0],{clickable:e.marker_options.clickable,icon:e.markers.startIcon});this.fire("addpoint",{point:S,point_type:"start",element:s[0],line:t}),c.push(S)}if(e.markers.endIcon){var S=new L.Marker(r[r.length-1],{clickable:e.marker_options.clickable,icon:e.markers.endIcon});this.fire("addpoint",{point:S,point_type:"end",element:s[s.length-1],line:t}),c.push(S)}for(var d=0;d<l.length;d++){var S=new L.Marker(l[d].coords,{clickable:e.marker_options.clickable,title:l[d].label,icon:l[d].icon});this.fire("addpoint",{point:S,point_type:"label",element:l[d].element}),c.push(S)}return c},_get_polyline_options:function(t,e){return Array.isArray(t)?t[e]||{}:t},_extract_styling:function(t,e,n){var a=this._merge_objs(vc,e),i=t.getElementsByTagNameNS(yc,"line");if(i.length>0){var s=i[0].getElementsByTagName("color");s.length>0&&(a.color="#"+s[0].textContent);var s=i[0].getElementsByTagName("opacity");s.length>0&&(a.opacity=s[0].textContent);var s=i[0].getElementsByTagName("weight");s.length>0&&(a.weight=s[0].textContent);var s=i[0].getElementsByTagName("linecap");s.length>0&&(a.lineCap=s[0].textContent);var s=i[0].getElementsByTagName("linejoin");s.length>0&&(a.lineJoin=s[0].textContent);var s=i[0].getElementsByTagName("dasharray");s.length>0&&(a.dashArray=s[0].textContent);var s=i[0].getElementsByTagName("dashoffset");s.length>0&&(a.dashOffset=s[0].textContent)}return this._merge_objs(a,n)},_dist2d:function(t,e){var n=6371e3,a=this._deg2rad(e.lat-t.lat),i=this._deg2rad(e.lng-t.lng),s=Math.sin(a/2)*Math.sin(a/2)+Math.cos(this._deg2rad(t.lat))*Math.cos(this._deg2rad(e.lat))*Math.sin(i/2)*Math.sin(i/2),r=2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s)),l=n*r;return l},_dist3d:function(t,e){var n=this._dist2d(t,e),a=Math.abs(e.meta.ele-t.meta.ele);return Math.sqrt(Math.pow(n,2)+Math.pow(a,2))},_deg2rad:function(t){return t*Math.PI/180}});function Rr(t,e={}){console.log(`[EventManager] Dispatching event: ${t}`,e);const n=new CustomEvent(t,{detail:e,bubbles:!0,cancelable:!0});document.dispatchEvent(n)}const Ot=()=>h.getValue("heightUnit","radio","m"),zn=()=>h.getValue("windUnit","radio","kt"),Ur=()=>h.getValue("coordFormat","radio","Decimal");function ft(t,e,n){console.log(`setupCheckbox called for id: ${t}`);const a=document.getElementById(t);a?(a._changeHandler&&(a.removeEventListener("change",a._changeHandler),console.log(`Removed previous change listener for ${t}`)),a._changeHandler=i=>{console.log(`Change event fired for ${t}, checked: ${a.checked}, event:`,i),i.stopPropagation(),n(a)},a.addEventListener("change",a._changeHandler),a.addEventListener("click",i=>{console.log(`Click event on ${t}, checked: ${a.checked}, target:`,i.target)}),console.log(`Attached change and click listeners to ${t}`),t==="showLandingPattern"&&!(h.isFeatureUnlocked("landingPattern")&&h.state.isLandingPatternUnlocked)&&(a.style.opacity="0.5",a.title="Feature locked. Click to enter password.")):console.warn(`Checkbox ${t} not found`)}function Bn(t,e,n){if(console.log(`toggleSubmenu called for ${t.textContent||t.id}: ${n?"show":"hide"}`),e){e.classList.contains("submenu")||e.classList.add("submenu"),e.classList.toggle("hidden",!n),t.setAttribute("aria-expanded",n),console.log(`Submenu toggled for ${t.textContent||t.id}: ${n?"shown":"hidden"}`);let a=0;const i=5,s=()=>{const r={isHidden:e.classList.contains("hidden"),displayStyle:window.getComputedStyle(e).display};n&&(r.isHidden||r.displayStyle==="none")&&(console.warn(`Submenu for ${t.textContent||t.id} was hidden unexpectedly. Forcing it to be visible.`),e.classList.remove("hidden"),e.style.display="block",a++,a<i&&setTimeout(s,100))};setTimeout(s,100)}else console.warn(`Submenu for ${t.textContent||t.id} not found`)}function Re(t,e){document.querySelectorAll(`input[name="${t}"]`).forEach(a=>{a.addEventListener("change",()=>{const i=h.getValue(t,"radio",h.defaultSettings[t]);if(h.state.userSettings[t]=i,h.save(),console.log(`${t} changed to: ${i} and saved to localStorage`),t==="landingDirection"){const s=document.getElementById("customLandingDirectionLL"),r=document.getElementById("customLandingDirectionRR"),l=h.state.userSettings.landingDirection;s&&(s.disabled=l!=="LL"),r&&(r.disabled=l!=="RR"),l==="LL"&&s&&!s.value&&h.state.userSettings.customLandingDirectionLL===""&&(s.value=Math.round(o.landingWindDir||0),h.state.userSettings.customLandingDirectionLL=parseInt(s.value),h.save(),console.log(`Set customLandingDirectionLL to ${s.value}`)),l==="RR"&&r&&!r.value&&h.state.userSettings.customLandingDirectionRR===""&&(r.value=Math.round(o.landingWindDir||0),h.state.userSettings.customLandingDirectionRR=parseInt(r.value),h.save(),console.log(`Set customLandingDirectionRR to ${r.value}`))}e()})})}function ae(t,e,n,a){const i=document.getElementById(t);if(!i){console.warn(`Input element ${t} not found`);return}i.addEventListener(e,g.debounce(()=>{const s=i.type==="number"?parseFloat(i.value):i.value;h.state.userSettings[t]=s,h.save(),console.log(`${t} changed to: ${s} and saved to localStorage`),a(s)},n))}function Gn(t,e){const n=document.getElementById(t);if(!n){console.warn(`Input element ${t} not found`);return}n.addEventListener("blur",()=>{const a=parseInt(n.value)||e;console.log(`Attempting to update ${t} to ${a}`),h.state.userSettings[t]=a,h.save();const i=document.getElementById("legHeightFinal"),s=document.getElementById("legHeightBase"),r=document.getElementById("legHeightDownwind");if(!isNaN(a)&&a>=50&&a<=1e3&&Bc(i,s,r))console.log(`Valid ${t}: ${a}, updating displays`),pe(),o.weatherData&&o.lastLat&&o.lastLng&&t==="legHeightDownwind"&&h.state.userSettings.calculateJump&&Ye();else{let l=e;const c=parseInt(i==null?void 0:i.value)||100,u=parseInt(s==null?void 0:s.value)||200,d=parseInt(r==null?void 0:r.value)||300;t==="legHeightFinal"&&(l=Math.min(u-1,100)),t==="legHeightBase"&&(l=Math.max(c+1,Math.min(d-1,200))),t==="legHeightDownwind"&&(l=Math.max(u+1,300)),n.value=l,h.state.userSettings[t]=l,h.save(),console.log(`Adjusted ${t} to ${l} due to invalid input`),g.handleError(`Adjusted ${t} to ${l} to maintain valid leg order.`)}})}function Mc(){console.log("setupMenuEvents wird aufgerufen für allgemeine Menü-Logik.");const t=document.getElementById("hamburgerBtn"),e=document.getElementById("menu");!t||!e||(t.addEventListener("click",n=>{n.stopPropagation(),e.classList.toggle("hidden")}),document.addEventListener("click",n=>{!e.contains(n.target)&&!t.contains(n.target)&&e.classList.add("hidden")}),e.addEventListener("click",n=>{const a=n.target;if(a.matches("li > span")||a.matches("li > label")){n.preventDefault(),n.stopPropagation();const s=a.closest("li").querySelector("ul.submenu");s&&s.classList.toggle("hidden")}}))}function Sc(){if(!o.map){console.warn("Map not initialized, skipping setupCheckboxEvents");return}ft("showTableCheckbox","showTable",r=>{h.state.userSettings.showTable=r.checked,h.save(),console.log("showTableCheckbox changed:",r.checked);const l=document.getElementById("info");l&&(l.style.display=r.checked?"block":"none",console.log("Info display set to:",l.style.display)),r.checked&&o.weatherData&&o.lastLat&&o.lastLng&&En(Oe()),St()}),ft("showExitAreaCheckbox","showExitArea",r=>{h.state.userSettings.showExitArea=r.checked,h.save(),console.log("Show Exit Area set to:",h.state.userSettings.showExitArea),o.weatherData&&o.lastLat&&o.lastLng&&h.state.userSettings.calculateJump&&we()}),ft("showCanopyAreaCheckbox","showCanopyArea",r=>{h.state.userSettings.showCanopyArea=r.checked,h.save(),console.log("Show Canopy Area set to:",h.state.userSettings.showCanopyArea),o.weatherData&&o.lastLat&&o.lastLng&&h.state.userSettings.calculateJump&&we()}),ft("showJumpRunTrack","showJumpRunTrack",r=>{if(h.state.userSettings.showJumpRunTrack=r.checked,h.save(),r.checked=h.state.userSettings.showJumpRunTrack,console.log("showJumpRunTrack changed:",r.checked),r.checked&&o.weatherData&&o.lastLat&&o.lastLng&&h.state.isCalculateJumpUnlocked&&h.state.userSettings.calculateJump)zc();else{o.jumpRunTrackLayer&&(o.jumpRunTrackLayer.airplaneMarker&&o.map&&typeof o.map.removeLayer=="function"&&(o.map.removeLayer(o.jumpRunTrackLayer.airplaneMarker),o.jumpRunTrackLayer.airplaneMarker=null),o.jumpRunTrackLayer.approachLayer&&o.map&&typeof o.map.removeLayer=="function"&&(o.map.removeLayer(o.jumpRunTrackLayer.approachLayer),o.jumpRunTrackLayer.approachLayer=null),o.map&&typeof o.map.removeLayer=="function"&&o.map.removeLayer(o.jumpRunTrackLayer),o.jumpRunTrackLayer=null,console.log("Removed JRT polyline"));const l=document.getElementById("jumpRunTrackDirection");if(l){const c=_n();l.value=c?c.direction:"",console.log("Updated jumpRunTrackDirection value:",(c==null?void 0:c.direction)||"")}}}),ft("showCutAwayFinder","showCutAwayFinder",r=>{var c;h.state.userSettings.showCutAwayFinder=r.checked,h.save(),console.log("Show Cut Away Finder set to:",r.checked);const l=(c=r.closest("li"))==null?void 0:c.querySelector("ul.submenu");r.checked?l&&l.classList.remove("hidden"):(l&&l.classList.add("hidden"),ql(),o.cutAwayLat=null,o.cutAwayLng=null),o.weatherData&&o.lastLat&&o.lastLng&&h.state.userSettings.calculateJump&&we()}),ft("showLandingPattern","showLandingPattern",r=>{const l="landingPattern",c=()=>{var m;h.state.userSettings.showLandingPattern=!0,h.save();const d=(m=r.closest("li"))==null?void 0:m.querySelector("ul");Bn(r,d,!0),et()},u=()=>{var m;h.state.userSettings.showLandingPattern=!1,h.save(),r.checked=!1;const d=(m=r.closest("li"))==null?void 0:m.querySelector("ul");Bn(r,d,!1),xt(null)};r.checked?h.isFeatureUnlocked(l)?c():h.showPasswordModal(l,c,u):u()});const t=document.getElementById("showJumpMasterLine");t&&(t.disabled=!h.state.userSettings.trackPosition,t.style.opacity=t.disabled?"0.5":"1",t.addEventListener("change",()=>{var c;const r=t.checked;if(r&&t.disabled){t.checked=!1,g.handleError("Please start Live Tracking first.");return}h.state.userSettings.showJumpMasterLine=r,h.save(),Rr("ui:showJumpMasterLineChanged",{isChecked:r});const l=(c=t.closest("li"))==null?void 0:c.querySelector("ul.submenu");l&&Bn(t,l,r)}));const e=document.getElementById("trackPositionCheckbox");e&&e.addEventListener("change",()=>{const r=e.checked;h.state.userSettings.trackPosition=r,h.save(),r?pc():Or()});const n=document.querySelector('input[name="jumpMasterLineTarget"][value="HARP"]');n&&(n.disabled=!h.state.userSettings.harpLat||!h.state.userSettings.harpLng,console.log("HARP radio button initialized, disabled:",n.disabled));const a=document.getElementById("placeHarpButton");a&&a.addEventListener("click",()=>{o.isPlacingHarp=!0,console.log("HARP placement mode activated"),o.map.on("click",Dr),g.handleMessage("Click the map to place the HARP marker")});const i=document.getElementById("clearHarpButton");i&&i.addEventListener("click",ac);const s=document.querySelector(".hamburger-menu");s&&s.addEventListener("click",r=>{console.log("Menu click:",r.target,"class:",r.target.className,"id:",r.target.id)})}function bc(){const t=document.getElementById("timeSlider");if(!t){console.warn("Time slider not found:",{id:"timeSlider"});return}t.addEventListener("input",async()=>{var n,a,i;const e=parseInt(t.value)||0;if(console.log("Time slider moved to index:",e),o.weatherData&&o.lastLat&&o.lastLng)await En(e),await kn(),o.lastAltitude!=="N/A"&&zt(),h.state.userSettings.showLandingPattern&&(console.log("Updating landing pattern for slider index:",e),et()),h.state.userSettings.calculateJump&&(console.log("Recalculating jump for slider index:",e),we(),Ue()),h.state.userSettings.showJumpRunTrack&&(console.log("Updating jump run track for slider index:",e),ee()),He();else{let s="N/A";if((a=(n=o.weatherData)==null?void 0:n.time)!=null&&a[e])s=await g.getDisplayTime(o.weatherData.time[e],o.lastLat,o.lastLng);else if(o.ensembleModelsData&&Object.keys(o.ensembleModelsData).length>0){const l=Object.keys(o.ensembleModelsData)[0],c=(i=o.ensembleModelsData[l])==null?void 0:i.time;c!=null&&c[e]&&(s=await g.getDisplayTime(c[e],o.lastLat,o.lastLng))}const r=document.getElementById("selectedTime");r&&(r.innerHTML=`Selected Time: ${s}`)}h.state.userSettings.selectedEnsembleModels&&h.state.userSettings.selectedEnsembleModels.length>0&&(console.log("Time slider change triggering ensemble update for index:",e),o.ensembleModelsData&&Object.keys(o.ensembleModelsData).length>0?yn():console.warn("Ensemble update skipped: AppState.ensembleModelsData is not populated yet."))}),t.addEventListener("change",async()=>{var i,s,r;const e=parseInt(t.value)||0;let n="N/A";if((s=(i=o.weatherData)==null?void 0:i.time)!=null&&s[e])n=await g.getDisplayTime(o.weatherData.time[e],o.lastLat,o.lastLng);else if(o.ensembleModelsData&&Object.keys(o.ensembleModelsData).length>0){const l=Object.keys(o.ensembleModelsData)[0],c=(r=o.ensembleModelsData[l])==null?void 0:r.time;c!=null&&c[e]&&(n=await g.getDisplayTime(c[e],o.lastLat,o.lastLng))}const a=document.getElementById("selectedTime");a&&(a.innerHTML=`Selected Time: ${n}`,console.log("Time slider change event, updated selectedTime label to:",n))})}function Tc(){const t=document.getElementById("modelSelect");if(!t){console.warn("modelSelect element not found");return}t.addEventListener("change",async()=>{var e,n;if(console.log("Model select changed to:",t.value),h.state.userSettings.model=t.value,h.save(),o.lastLat&&o.lastLng){const a=Oe(),i=((n=(e=o.weatherData)==null?void 0:e.time)==null?void 0:n[a])||null,s=await ct(o.lastLat,o.lastLng,i);s&&await Br(s)}else g.handleError("Please select a position on the map first.")})}function kc(){if(Re("refLevel",()=>{h.updateUnitLabels(),pe()}),Re("heightUnit",()=>{if(h.updateUnitLabels(),pe(),He(),o.lastMouseLatLng&&o.coordsControl){const a=Ur(),i=o.lastMouseLatLng.lat,s=o.lastMouseLatLng.lng;let r;a==="MGRS"?r=`MGRS: ${g.decimalToMgrs(i,s)}`:r=`Lat: ${i.toFixed(5)}, Lng: ${s.toFixed(5)}`,Wr(i,s,{lat:i,lng:s},(l,c)=>{if(o.lastMouseLatLng){const u=Math.abs(o.lastMouseLatLng.lat-c.lat),d=Math.abs(o.lastMouseLatLng.lng-c.lng),m=.05;if(u<m&&d<m){const p=Ot();let f=l==="N/A"?"N/A":l;f!=="N/A"&&(f=g.convertHeight(f,p),f=Math.round(f)),console.log("Updating elevation display after heightUnit change:",{lat:i,lng:s,elevation:l,heightUnit:p,displayElevation:f}),o.coordsControl.update(`${r}<br>Elevation: ${f} ${f==="N/A"?"":p}`)}}})}if(o.gpxLayer&&o.gpxPoints.length>0){const a=o.lastAltitude!=="N/A"&&!isNaN(o.lastAltitude)?parseFloat(o.lastAltitude):null,i=zn(),s=Ot();o.gpxLayer.eachLayer(r=>{r instanceof L.Polyline&&r.on("mousemove",function(l){const c=l.latlng;let u=o.gpxPoints[0],d=1/0,m=0;o.gpxPoints.forEach((p,f)=>{const y=Math.sqrt(Math.pow(p.lat-c.lat,2)+Math.pow(p.lng-c.lng,2));y<d&&(d=y,u=p,m=f)}),r.setTooltipContent(getTooltipContent(u,m,o.gpxPoints,a,i,s)).openTooltip(c)})})}}),Re("temperatureUnit",()=>{pe()}),Re("windUnit",()=>{if(h.updateUnitLabels(),pe(),He(),o.gpxLayer&&o.gpxPoints.length>0){const a=o.lastAltitude!=="N/A"&&!isNaN(o.lastAltitude)?parseFloat(o.lastAltitude):null,i=zn(),s=Ot();o.gpxLayer.eachLayer(r=>{r instanceof L.Polyline&&r.on("mousemove",function(l){const c=l.latlng;let u=o.gpxPoints[0],d=1/0,m=0;o.gpxPoints.forEach((p,f)=>{const y=Math.sqrt(Math.pow(p.lat-c.lat,2)+Math.pow(p.lng-c.lng,2));y<d&&(d=y,u=p,m=f)}),r.setTooltipContent(getTooltipContent(u,m,o.gpxPoints,a,i,s)).openTooltip(c)})})}}),Re("timeZone",async()=>{pe()}),Re("coordFormat",()=>{o.lastLat&&o.lastLng&&kn(),He()}),Re("downloadFormat",()=>{console.log("Download format changed:",Hr())}),Re("landingDirection",()=>{const a=document.getElementById("customLandingDirectionLL"),i=document.getElementById("customLandingDirectionRR"),s=h.state.userSettings.landingDirection;console.log("landingDirection changed:",{landingDirection:s,customLL:a==null?void 0:a.value,customRR:i==null?void 0:i.value}),a&&(a.disabled=s!=="LL",s==="LL"&&!a.value&&o.landingWindDir!==null&&(a.value=Math.round(o.landingWindDir),h.state.userSettings.customLandingDirectionLL=parseInt(a.value),h.save())),i&&(i.disabled=s!=="RR",s==="RR"&&!i.value&&o.landingWindDir!==null&&(i.value=Math.round(o.landingWindDir),h.state.userSettings.customLandingDirectionRR=parseInt(i.value),h.save())),zr(),pe()}),Re("jumpMasterLineTarget",()=>{h.state.userSettings.jumpMasterLineTarget=h.getValue("jumpMasterLineTarget","radio","DIP"),h.save(),console.log("jumpMasterLineTarget changed:",h.state.userSettings.jumpMasterLineTarget),Rr("jml:targetChanged");const a=document.querySelector('input[name="jumpMasterLineTarget"][value="HARP"]');a&&(a.disabled=!o.harpMarker||h.state.userSettings.harpLat===null||h.state.userSettings.harpLng===null,console.log("HARP radio button disabled:",a.disabled))}),o.gpxLayer&&o.gpxPoints.length>0){const a=o.lastAltitude!=="N/A"&&!isNaN(o.lastAltitude)?parseFloat(o.lastAltitude):null,i=zn(),s=Ot();o.gpxLayer.eachLayer(r=>{r instanceof L.Polyline&&r.on("mousemove",function(l){const c=l.latlng;let u=o.gpxPoints[0],d=1/0,m=0;o.gpxPoints.forEach((p,f)=>{const y=Math.sqrt(Math.pow(p.lat-c.lat,2)+Math.pow(p.lng-c.lng,2));y<d&&(d=y,u=p,m=f)}),r.setTooltipContent(getTooltipContent(u,m,o.gpxPoints,a,i,s)).openTooltip(c)})})}document.querySelectorAll('input[name="ensembleScenario"]').forEach(a=>{a.addEventListener("change",()=>{if(a.checked)if(h.state.userSettings.currentEnsembleScenario=a.value,o.currentEnsembleScenario=a.value,h.save(),console.log("Ensemble scenario changed to:",a.value),h.state.userSettings.selectedEnsembleModels.length>0){const i=h.state.userSettings.selectedEnsembleModels.every(s=>o.ensembleModelsData&&o.ensembleModelsData[s]);!i&&a.value!=="all_models"?wa():!i&&a.value==="all_models"&&o.ensembleModelsData&&Object.keys(o.ensembleModelsData).length>0||i?yn():(g.handleMessage("Please select models and ensure data is fetched."),ot())}else a.value!=="all_models"&&g.handleMessage("Please select models from the 'Ensemble > Models' menu first."),ot()})});const e=h.state.userSettings.currentEnsembleScenario||"all_models",n=document.querySelector(`input[name="ensembleScenario"][value="${e}"]`);n&&(n.checked=!0,o.currentEnsembleScenario=e),o.map&&!o.ensembleLayerGroup&&(o.ensembleLayerGroup=L.layerGroup().addTo(o.map))}function Ec(){ae("lowerLimit","change",300,t=>{o.weatherData&&o.lastLat&&o.lastLng&&o.lastAltitude!=="N/A"&&zt()}),ae("upperLimit","change",300,t=>{o.weatherData&&o.lastLat&&o.lastLng&&o.lastAltitude!=="N/A"&&zt()}),ae("openingAltitude","change",300,t=>{!isNaN(t)&&t>=500&&t<=15e3?h.state.userSettings.calculateJump&&o.weatherData&&o.lastLat&&o.lastLng&&(Ye(),Ue()):(g.handleError("Opening altitude must be between 500 and 15000 meters."),V("openingAltitude",1200),h.state.userSettings.openingAltitude=1200,h.save())}),ae("exitAltitude","change",300,t=>{!isNaN(t)&&t>=500&&t<=15e3?h.state.userSettings.calculateJump&&o.weatherData&&o.lastLat&&o.lastLng&&Ye():(g.handleError("Exit altitude must be between 500 and 15000 meters."),V("exitAltitude",3e3),h.state.userSettings.exitAltitude=3e3,h.save())}),ae("canopySpeed","change",300,t=>{!isNaN(t)&&t>=5&&t<=50?pe():(g.handleError("Canopy speed must be between 5 and 50 kt."),V("canopySpeed",20),h.state.userSettings.canopySpeed=20,h.save())}),ae("descentRate","change",300,t=>{!isNaN(t)&&t>=1&&t<=10?pe():(g.handleError("Descent rate must be between 1 and 10 m/s."),V("descentRate",3),h.state.userSettings.descentRate=3,h.save())}),ae("interpStepSelect","change",300,t=>{pe()}),Gn("legHeightFinal",100),Gn("legHeightBase",200),Gn("legHeightDownwind",300),ae("customLandingDirectionLL","input",100,t=>{const e=parseInt(t,10);console.log("customLandingDirectionLL input:",{value:t,customDir:e}),!isNaN(e)&&e>=0&&e<=359?(h.state.userSettings.customLandingDirectionLL=e,h.save(),h.state.userSettings.landingDirection==="LL"&&o.weatherData&&o.lastLat&&o.lastLng&&(console.log("Updating landing pattern for LL:",e),et(),St())):(g.handleError("Landing direction must be between 0 and 359°."),V("customLandingDirectionLL",h.state.userSettings.customLandingDirectionLL||0))}),ae("customLandingDirectionRR","input",100,t=>{const e=parseInt(t,10);console.log("customLandingDirectionRR input:",{value:t,customDir:e}),!isNaN(e)&&e>=0&&e<=359?(h.state.userSettings.customLandingDirectionRR=e,h.save(),h.state.userSettings.landingDirection==="RR"&&o.weatherData&&o.lastLat&&o.lastLng&&(console.log("Updating landing pattern for RR:",e),et(),St())):(g.handleError("Landing direction must be between 0 and 359°."),V("customLandingDirectionRR",h.state.userSettings.customLandingDirectionRR||0))}),ae("jumpRunTrackDirection","change",0,t=>{const e=parseInt(t,10);if(console.log("jumpRunTrackDirection change event:",{value:t,customDir:e,jumpRunTrackOffset:h.state.userSettings.jumpRunTrackOffset}),!isNaN(e)&&e>=0&&e<=359)o.customJumpRunDirection=e,console.log("Set custom direction from input:",e),o.weatherData&&o.lastLat&&o.lastLng?(h.state.userSettings.showJumpRunTrack&&(console.log("Updating JRT for custom direction input"),ee()),h.state.userSettings.calculateJump&&(console.log("Recalculating jump for custom JRT direction"),Ye(),Ue())):console.warn("Cannot update JRT or jump: missing conditions",{weatherData:!!o.weatherData,lastLat:o.lastLat,lastLng:o.lastLng});else{console.log("Invalid direction input, resetting to calculated"),g.handleError("Jump run direction must be between 0 and 359°."),o.customJumpRunDirection=null;const n=document.getElementById("jumpRunTrackDirection");n&&n.addEventListener("change",()=>{const a=parseFloat(n.value);Number.isFinite(a)&&a>=0&&a<=359?(h.state.userSettings.customJumpRunDirection=a,console.log("Setting 'customJumpRunDirection' on change to:",a)):(h.state.userSettings.customJumpRunDirection=null,n.value="",console.log("Invalid direction, resetting to calculated.")),h.save(),ee()}),o.weatherData&&o.lastLat&&o.lastLng&&(h.state.userSettings.showJumpRunTrack&&(console.log("Updating JRT for invalid direction input"),ee()),h.state.userSettings.calculateJump&&(console.log("Recalculating jump for reset JRT direction"),Ye(),Ue()))}}),ae("jumpRunTrackOffset","change",0,t=>{const e=parseInt(t,10);if(console.log("jumpRunTrackOffset change event:",{value:t,offset:e}),!isNaN(e)&&e>=-5e4&&e<=5e4&&e%100===0)h.state.userSettings.jumpRunTrackOffset=e,h.save(),h.state.userSettings.calculateJump&&h.state.userSettings.showJumpRunTrack&&o.weatherData&&o.lastLat&&o.lastLng&&(console.log("Updating JRT for offset change"),ee());else{g.handleError("Offset must be between -50000 and 50000 in steps of 100.");const n=document.getElementById("jumpRunTrackOffset");n&&(n.value=0),h.state.userSettings.jumpRunTrackOffset=0,h.save(),h.state.userSettings.calculateJump&&h.state.userSettings.showJumpRunTrack&&(console.log("Resetting JRT for invalid offset"),ee())}}),ae("jumpRunTrackForwardOffset","change",0,t=>{const e=parseInt(t,10);if(console.log("jumpRunTrackForwardOffset change event:",{value:t,offset:e}),!isNaN(e)&&e>=-5e4&&e<=5e4&&e%100===0)h.state.userSettings.jumpRunTrackForwardOffset=e,h.save(),h.state.userSettings.calculateJump&&h.state.userSettings.showJumpRunTrack&&o.weatherData&&o.lastLat&&o.lastLng&&(console.log("Updating JRT for forward offset change"),ee());else{g.handleError("Forward offset must be between -50000 and 50000 in steps of 100.");const n=document.getElementById("jumpRunTrackForwardOffset");n&&(n.value=0),h.state.userSettings.jumpRunTrackForwardOffset=0,h.save(),h.state.userSettings.calculateJump&&h.state.userSettings.showJumpRunTrack&&(console.log("Resetting JRT for invalid forward offset"),ee())}}),ae("aircraftSpeedKt","change",300,t=>{const e=_i(t);document.getElementById("jumperSeparation").value=e,h.state.userSettings.jumperSeparation=e,h.state.userSettings.aircraftSpeedKt=parseFloat(t),h.save(),we(),ee()}),ae("numberOfJumpers","change",300,t=>{const e=parseFloat(t);!isNaN(e)&&e>=1&&e<=50?(h.state.userSettings.numberOfJumpers=e,h.save(),h.state.userSettings.calculateJump&&o.weatherData&&o.lastLat&&o.lastLng&&(console.log("Recalculating jump for jumper number change"),Ye(),Ue())):(g.handleError("Jumper number must be between 1 and 50."),V("numberOfJumpers",defaultSettings.numberOfJumpers),h.state.userSettings.numberOfJumpers=defaultSettings.numberOfJumpers,h.save())}),ae("jumperSeparation","change",300,t=>{const e=parseFloat(t);!isNaN(e)&&e>=1&&e<=50?(h.state.userSettings.jumperSeparation=e,o.isJumperSeparationManual=!0,h.save(),console.log(`jumperSeparation manually set to ${e}s`),h.state.userSettings.calculateJump&&o.weatherData&&o.lastLat&&o.lastLng&&(console.log("Recalculating jump for jumper separation change"),Ye(),Ue())):(g.handleError("Jumper separation must be between 1 and 50 seconds."),V("jumperSeparation",defaultSettings.jumperSeparation),h.state.userSettings.jumperSeparation=defaultSettings.jumperSeparation,o.isJumperSeparationManual=!1,h.save())}),ae("cutAwayAltitude","change",300,t=>{!isNaN(t)&&t>=400&&t<=15e3?(h.state.userSettings.cutAwayAltitude=t,h.save(),h.state.userSettings.showCutAwayFinder&&o.weatherData&&o.lastLat&&o.lastLng&&(console.log("Recalculating jump for cut-away altitude change"),we())):(g.handleError("Cut away altitude must be between 400 and 15000 meters."),V("cutAwayAltitude",1e3),h.state.userSettings.cutAwayAltitude=1e3,h.save())}),ae("historicalDatePicker","change",300,t=>{console.log("historicalDatePicker changed to:",t),o.lastLat&&o.lastLng?ct(o.lastLat,o.lastLng,t?`${t}T00:00:00Z`:null).then(e=>{e&&(o.weatherData=e,pe())}):g.handleError("Please select a position on the map first.")})}function Cc(){const t=document.getElementById("downloadButton");t&&t.addEventListener("click",()=>{const e=Hr();Hc(e)})}function Ac(){const t=document.getElementById("clearHistoricalDate");t&&t.addEventListener("click",()=>{const e=document.getElementById("historicalDatePicker");e&&(e.value="",console.log("Cleared historical date, refetching forecast data"),o.lastLat&&o.lastLng&&ct(o.lastLat,o.lastLng,null).then(n=>{n&&(o.weatherData=n,pe())}))})}function Pc(){Nr(),console.log("Coordinate events setup complete.")}function Ic(){const t=document.querySelectorAll('input[name="cutAwayState"]');if(t.length===0)return;const e=h.state.userSettings.cutAwayState||"Partially",n=document.querySelector(`input[name="cutAwayState"][value="${e}"]`);n&&(n.checked=!0),t.forEach(a=>{a.addEventListener("change",()=>{a.checked&&(console.log(`Cut Away State changed to: ${a.value}`),h.state.userSettings.cutAwayState=a.value,h.save(),o.weatherData&&o.lastLat&&o.lastLng&&h.state.userSettings.calculateJump&&we())})})}function Dc(){console.log("App: Richte Event-Listener für Track-Einstellungen ein.");const t=(a,i)=>{const s=document.getElementById(a);s&&(s.value=h.state.userSettings[i]||0,console.log(`Set ${a} to initial value:`,s.value),s.addEventListener("input",()=>{const r=parseFloat(s.value);isNaN(r)||(h.state.userSettings[i]=r,h.save(),ee())}))};t("numberOfJumpers","numberOfJumpers"),t("jumperSeparation","jumperSeparation"),t("jumpRunTrackOffset","jumpRunTrackOffset"),t("jumpRunTrackForwardOffset","jumpRunTrackForwardOffset");const e=document.getElementById("jumpRunTrackDirection");e&&(e.value=h.state.userSettings.customJumpRunDirection||"",e.addEventListener("change",()=>{const a=parseFloat(e.value);Number.isFinite(a)&&a>=0&&a<=359?(h.state.userSettings.customJumpRunDirection=a,console.log("Setting 'customJumpRunDirection' on change to:",a)):(h.state.userSettings.customJumpRunDirection=null,e.value="",console.log("Invalid direction, resetting to calculated.")),h.save(),ee()}));const n=document.getElementById("showJumpRunTrack");n&&n.addEventListener("change",a=>{h.state.userSettings.showJumpRunTrack=a.target.checked,h.save(),ee()})}function Nc(){console.log("App: Richte Event-Listener für Karten-Events ein."),document.addEventListener("map:location_selected",async t=>{const{lat:e,lng:n,source:a}=t.detail;console.log(`App: Event 'map:location_selected' von '${a}' empfangen.`),o.lastLat=e,o.lastLng=n,o.lastAltitude=await g.getAltitude(e,n),Ma(e,n),resetJumpRunDirection(!0),await ct(e,n),h.state.userSettings.calculateJump&&(we(),Ue()),St(!0),o.isManualPanning=!1,ee(),et()}),document.addEventListener("map:mousemove",t=>{const{lat:e,lng:n}=t.detail;o.lastMouseLatLng={lat:e,lng:n};const a=Ur();let i;if(a==="MGRS")i=`MGRS: ${g.decimalToMgrs(e,n)||"N/A"}`;else if(a==="DMS"){const s=r=>`${r.deg}°${r.min}'${r.sec.toFixed(0)}" ${r.dir}`;i=`Lat: ${s(g.decimalToDms(e,!0))}, Lng: ${s(g.decimalToDms(n,!1))}`}else i=`Lat: ${e.toFixed(5)}, Lng: ${n.toFixed(5)}`;o.coordsControl&&o.coordsControl.update(`${i}<br>Elevation: Fetching...<br>QFE: Fetching...`),Wr(e,n,{lat:e,lng:n},({elevation:s,qfe:r},l)=>{if(o.lastMouseLatLng&&o.coordsControl){const c=Math.abs(o.lastMouseLatLng.lat-l.lat),u=Math.abs(o.lastMouseLatLng.lng-l.lng),d=.05;if(c<d&&u<d){const m=Ot();let p=s==="N/A"?"N/A":s;p!=="N/A"&&(p=g.convertHeight(p,m),p=Math.round(p));const f=r==="N/A"?"N/A":`${r} hPa`;o.coordsControl.update(`${i}<br>Elevation: ${p} ${p==="N/A"?"":m}<br>QFE: ${f}`)}}})})}function Fc(){console.log("setupMenuItemEvents wird aufgerufen für 'Calculate Jump'.");const t=Array.from(document.querySelectorAll(".menu-label")).find(a=>a.textContent.trim()==="Calculate Jump");if(!t){console.error("Calculate Jump menu item not found");return}const e=t.closest("li").querySelector("ul.submenu"),n=()=>{h.isFeatureUnlocked("calculateJump")?(t.style.opacity="1",t.title="Click to open/close jump calculation settings"):(t.style.opacity="0.5",t.title="Feature locked. Click to enter password.",e&&e.classList.add("hidden"))};n(),t.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),h.isFeatureUnlocked("calculateJump")?e&&e.classList.toggle("hidden"):h.showPasswordModal("calculateJump",()=>{n(),e&&e.classList.remove("hidden")},()=>{n()})})}function xc(){const t=document.getElementById("resetCutAwayMarker");t&&t.addEventListener("click",()=>{if(!o.map){console.warn("Map not initialized, cannot reset cut-away marker");return}o.cutAwayMarker&&(o.map.removeLayer(o.cutAwayMarker),o.cutAwayMarker=null,o.cutAwayLat=null,o.cutAwayLng=null,console.log("Cut-away marker reset"),o.cutAwayCircle&&(o.map.removeLayer(o.cutAwayCircle),o.cutAwayCircle=null,console.log("Cleared cut-away circle")),document.getElementById("info").innerHTML="Right-click map to place cut-away marker")})}function Oc(){console.log("[app.js] Setting up track events");const t=document.getElementById("trackFileInput"),e=document.getElementById("loading");t&&t.addEventListener("change",async a=>{const i=a.target.files[0];if(e&&(e.style.display="block"),!i){g.handleError("No file selected."),e&&(e.style.display="none");return}const s=i.name.split(".").pop().toLowerCase();let r=null;try{s==="gpx"?r=await cc(i):s==="csv"?r=await uc(i):(g.handleError("Unsupported file type. Please upload a .gpx or .csv file."),e&&(e.style.display="none"))}catch(l){console.error("Error during track file processing:",l),g.handleError("Failed to process track file."),e&&(e.style.display="none")}});const n=document.getElementById("clearTrack");n&&n.addEventListener("click",()=>{if(!o.map){g.handleError("Cannot clear track: map not initialized.");return}if(o.gpxLayer)try{o.map.hasLayer(o.gpxLayer)&&o.map.removeLayer(o.gpxLayer),o.gpxLayer=null,o.gpxPoints=[],o.isTrackLoaded=!1;const a=document.getElementById("info");if(a){const i=/(<br><strong>Available Models:<\/strong><ul>.*?<\/ul>|<br><strong>Available Models:<\/strong> None)/s,r=a.innerHTML.match(i);a.innerHTML="Click on the map to fetch weather data."+(r?r[0]:"")}t&&(t.value="")}catch(a){g.handleError("Failed to clear track: "+a.message)}else g.handleMessage("No track to clear.")}),o.map&&o.map.getContainer().addEventListener("track:loaded",async a=>{try{const{lat:i,lng:s,timestamp:r,historicalDate:l,summary:c}=a.detail;if(console.log('Event "track:loaded" empfangen, starte Aktionen.'),l){console.log("Historischer Track geladen, deaktiviere Autoupdate.");const m=document.getElementById("autoupdateCheckbox");m&&(m.checked=!1),$r(),h.state.userSettings.autoupdate=!1,h.save(),g.handleMessage("Autoupdate disabled for historical track viewing.")}await Tn(i,s);const u=await ct(i,s,r);if(u){o.weatherData=u;const m=document.getElementById("timeSlider");if(m&&o.weatherData.time){m.max=o.weatherData.time.length-1,m.disabled=m.max<=0;const p=new Date(r).getTime();let f=0,y=1/0;o.weatherData.time.forEach((v,w)=>{const _=Math.abs(new Date(v).getTime()-p);_<y&&(y=_,f=w)}),m.value=f}}await pe(),h.state.isCalculateJumpUnlocked&&h.state.userSettings.calculateJump&&we(),h.state.isLandingPatternUnlocked&&h.state.userSettings.showLandingPattern&&et();const d=document.getElementById("info");if(d&&c){const m=/(<br><strong>Available Models:<\/strong><ul>.*?<\/ul>|<br><strong>Available Models:<\/strong> None)/s,p=d.innerHTML.match(m);d.innerHTML=c+(p?p[0]:"")}if(l){const m=document.getElementById("historicalDatePicker");m&&(m.value=l)}}catch(i){console.error("Fehler bei der Verarbeitung von track:loaded:",i),g.handleError("Konnte Track-Daten nicht vollständig verarbeiten.")}finally{e&&(e.style.display="none")}})}function $c(){const t=document.getElementById("bottom-container");if(!t){console.error("Bottom container not found; cannot create settings/cache buttons.");return}const e=document.createElement("div");e.id="settings-cache-buttons",e.className="button-wrapper";const n=document.createElement("button");n.id="resetButton",n.textContent="Reset Settings",n.title="Resets all settings to their default values and locks all features",n.addEventListener("click",()=>{confirm("Are you sure you want to reset all settings and lock all features?")&&(localStorage.removeItem("unlockedFeatures"),localStorage.removeItem("upperWindsSettings"),window.location.reload())}),e.appendChild(n);const a=document.createElement("button");a.id="clearCacheButton",a.textContent="Clear Tile Cache",a.title="Clears cached map tiles. Pan/zoom to cache more tiles for offline use.",a.addEventListener("click",async()=>{try{const i=await oe.getCacheSize();await oe.clearCache(),g.handleMessage(`Tile cache cleared successfully (freed ${i.toFixed(2)} MB).`),console.log("Tile cache cleared")}catch(i){g.handleError("Failed to clear tile cache: "+i.message)}}),e.appendChild(a),t.appendChild(e)}function Rc(){const t=document.getElementById("cacheRadiusSelect");t?(t.addEventListener("change",()=>{if(!h.state||!h.state.userSettings){console.error("Settings not properly initialized");return}h.state.userSettings.cacheRadiusKm=parseInt(t.value,10),h.save(),console.log("Updated cacheRadiusKm:",h.state.userSettings.cacheRadiusKm)}),console.log("cacheRadiusSelect listener attached, initial value:",t.value)):console.warn("cacheRadiusSelect not found in DOM");const e=document.getElementById("cacheZoomLevelsSelect");e?(e.addEventListener("change",()=>{const[a,i]=e.value.split("-").map(Number);h.state.userSettings.cacheZoomLevels=Array.from({length:i-a+1},(s,r)=>a+r),h.save(),console.log("Updated cacheZoomLevels:",h.state.userSettings.cacheZoomLevels)}),console.log("cacheZoomLevelsSelect listener attached, initial value:",e.value)):console.warn("cacheZoomLevelsSelect not found in DOM");const n=document.getElementById("recacheNowButton");n?(n.addEventListener("click",a=>{if(a.stopPropagation(),console.log("Recache Now button clicked"),!navigator.onLine){g.handleError("Cannot recache while offline.");return}const{map:i,lastLat:s,lastLng:r,baseMaps:l}=o;if(!i){console.warn("Map not initialized, cannot recache tiles"),g.handleMessage("Map not initialized, cannot recache tiles.");return}Cl({map:i,lastLat:s,lastLng:r,baseMaps:l})}),console.log("recacheNowButton listener attached")):console.warn("recacheNowButton not found in DOM")}function Uc(){console.log("Initializing all UI event listeners..."),Mc(),Sc(),bc(),Tc(),kc(),Ec(),Cc(),Oc(),Ac(),Pc(),Ic(),Dc(),Nc(),Fc(),xc(),$c(),Rc()}const Ye=g.debounce(we,300),Hr=()=>h.getValue("downloadFormat","radio","csv");g.handleMessage=Se;L.Control.Coordinates=L.Control.extend({options:{position:"bottomleft"},onAdd:function(t){var e=L.DomUtil.create("div","leaflet-control-coordinates");return e.style.background="rgba(255, 255, 255, 0.8)",e.style.padding="5px",e.style.borderRadius="4px",e.style.boxShadow="0 2px 5px rgba(0, 0, 0, 0.2)",e.innerHTML="Move mouse over map",this._container=e,e},update:function(t){this._container.innerHTML=t}});let Vn=new Map,Jn=new Map;const Wr=g.debounce(async(t,e,n,a)=>{var u,d,m,p;const i=`${t.toFixed(5)},${e.toFixed(5)}`,s=Oe(),r=`${i}-${s}`;let l,c;if(Vn.has(i))l=Vn.get(i);else try{l=await g.getAltitude(t,e),Vn.set(i,l)}catch(f){console.warn("Failed to fetch elevation:",f),l="N/A"}if(Jn.has(r))c=Jn.get(r);else if(o.weatherData&&o.weatherData.surface_pressure&&s>=0&&s<o.weatherData.surface_pressure.length){const f=o.weatherData.surface_pressure[s],y=((u=o.weatherData.temperature_2m)==null?void 0:u[s])||16.1,v=o.lastAltitude!=="N/A"?o.lastAltitude:339;c=g.calculateQFE(f,l,v,y),Jn.set(r,c),console.log("Calculated QFE:",{lat:t,lng:e,surfacePressure:f,elevation:l,referenceElevation:v,temperature:y,qfe:c})}else console.warn("Surface pressure not available for QFE:",{hasWeatherData:!!o.weatherData,hasSurfacePressure:!!((d=o.weatherData)!=null&&d.surface_pressure),sliderIndexValid:s>=0&&s<(((p=(m=o.weatherData)==null?void 0:m.surface_pressure)==null?void 0:p.length)||0)}),c="N/A";a({elevation:l,qfe:c},n)},500);function zt(){var k;console.log("Calculating mean wind with model:",document.getElementById("modelSelect").value,"weatherData:",o.weatherData);const t=document.getElementById("timeSlider").value||0,e=ut(t);let n=parseFloat(document.getElementById("lowerLimit").value)||0,a=parseFloat(document.getElementById("upperLimit").value);const i=((k=document.querySelector('input[name="refLevel"]:checked'))==null?void 0:k.value)||"AGL",s=h.getValue("heightUnit","radio","m"),r=h.getValue("windUnit","radio","kt"),l=Math.round(o.lastAltitude);if(!o.weatherData||o.lastAltitude==="N/A"){handleError("Cannot calculate mean wind: missing data or altitude");return}n=s==="ft"?n/3.28084:n,a=s==="ft"?a/3.28084:a,i==="AMSL"&&n<l&&(g.handleError(`Lower limit adjusted to terrain altitude (${l} m ${i}) as it cannot be below ground level in ${i} mode.`),n=l,document.getElementById("lowerLimit").value=g.convertHeight(n,s));const c=i==="AGL"?n+l:n,u=i==="AGL"?a+l:a;if(isNaN(n)||isNaN(a)||n>=a){g.handleError("Invalid layer limits. Ensure Lower < Upper and both are numbers.");return}if(!e||e.length===0){g.handleError("No valid weather data available to calculate mean wind.");return}const d=e.map(C=>C.height),m=e.map(C=>parseFloat(C.dir)||0),p=e.map(C=>g.convertWind(parseFloat(C.spd)||0,r,"km/h")),f=p.map((C,N)=>-C*Math.sin(m[N]*Math.PI/180)),y=p.map((C,N)=>-C*Math.cos(m[N]*Math.PI/180)),v=g.calculateMeanWind(d,f,y,c,u),[w,_]=v,M=g.roundToTens(w)===0&&w>=0&&w<5?360:g.roundToTens(w),b=Math.round(g.convertHeight(n,s)),S=Math.round(g.convertHeight(a,s));g.convertWind(_,r,"kt");const T=Number.isFinite(_)?r==="bft"?Math.round(_):_.toFixed(1):"N/A",E=`Mean wind (${b}-${S} ${s} ${i}): ${M}° ${T} ${r}`;document.getElementById("meanWindResult").innerHTML=E,console.log("Calculated Mean Wind:",E,"u:",v[2],"v:",v[3])}function Hc(t){var de,J,fe,Ce,Be,Y;if(!o.weatherData||!o.weatherData.time){g.handleError("No weather data available to download.");return}const e=document.getElementById("timeSlider").value||0,n=document.getElementById("modelSelect").value.toUpperCase(),a=g.formatTime(o.weatherData.time[e]).replace(" ","_"),i=`${a}_${n}_${t}.txt`,s={ATAK:{interpStep:1e3,heightUnit:"ft",refLevel:"AGL",windUnit:"kt"},Windwatch:{interpStep:100,heightUnit:"ft",refLevel:"AGL",windUnit:"km/h"},HEIDIS:{interpStep:100,heightUnit:"m",refLevel:"AGL",temperatureUnit:"C",windUnit:"m/s"},Customized:{}},r={interpStep:wi(),heightUnit:h.getValue("heightUnit","radio","m"),refLevel:((de=document.querySelector('input[name="refLevel"]:checked'))==null?void 0:de.value)||"AGL",windUnit:h.getValue("windUnit","radio","kt"),temperatureUnit:h.getValue("temperatureUnit","radio","C")};let l={...r};const c=s[t];if(c&&Object.keys(c).length>0){let B=!1;for(const[X,G]of Object.entries(c))if(l[X]!==G){switch(B=!0,X){case"interpStep":document.getElementById("interpStepSelect").value=G,h.state.userSettings.interpStep=G;break;case"heightUnit":document.querySelector(`input[name="heightUnit"][value="${G}"]`).checked=!0,h.state.userSettings.heightUnit=G;break;case"refLevel":document.querySelector(`input[name="refLevel"][value="${G}"]`).checked=!0,h.state.userSettings.refLevel=G;break;case"windUnit":document.querySelector(`input[name="windUnit"][value="${G}"]`).checked=!0,h.state.userSettings.windUnit=G;break;case"temperatureUnit":document.querySelector(`input[name="temperatureUnit"][value="${G}"]`).checked=!0,h.state.userSettings.temperatureUnit=G;break}l[X]=G}B&&(h.save(),console.log(`Adjusted settings for ${t} compatibility:`,c),h.updateUnitLabels(),h.updateUnitLabels(),h.updateUnitLabels())}let u="",d=" ";const m=h.getValue("heightUnit","radio","m"),p=h.getValue("temperatureUnit","radio","C"),f=h.getValue("windUnit","radio","kt"),y=((J=document.querySelector('input[name="refLevel"]:checked'))==null?void 0:J.value)||"AGL";if(t==="ATAK")u=`Alt Dir Spd
${m}${y}
`;else if(t==="Windwatch"){const B=Math.round(m==="ft"?o.lastAltitude*3.28084:o.lastAltitude);u=`Version 1.0, ID = 9999999999
${a}, Ground Level: ${B} ft
Windsond ${n}
 AGL[ft] Wind[°] Speed[km/h]
`}else if(t==="HEIDIS"){const B=y==="AGL"?`h(${m}AGL)`:`h(${m}AMSL)`,X=p==="C"?"°C":"°F";u=`${B} p(hPa) T(${X}) Dew(${X}) Dir(°) Spd(${f}) RH(%)`}else if(t==="Customized"){const B=y==="AGL"?`h(${m}AGL)`:`h(${m}AMSL)`,X=p==="C"?"°C":"°F";u=`${B} p(hPa) T(${X}) Dew(${X}) Dir(°) Spd(${f}) RH(%)`}const v=Math.round(o.lastAltitude),w=y==="AGL"?0:v,_=(fe=o.weatherData.temperature_2m)==null?void 0:fe[e],M=(Ce=o.weatherData.relative_humidity_2m)==null?void 0:Ce[e],b=(Be=o.weatherData.wind_speed_10m)==null?void 0:Be[e],S=(Y=o.weatherData.wind_direction_10m)==null?void 0:Y[e],T=g.calculateDewpoint(_,M),E=o.weatherData.surface_pressure[e],k=Math.round(g.convertHeight(w,m)),C=g.convertTemperature(_,p),N=g.convertTemperature(T,p),F=g.convertWind(b,f,"km/h"),P=C==="N/A"?"N/A":C.toFixed(1),I=N==="N/A"?"N/A":N.toFixed(1),x=F==="N/A"?"N/A":f==="bft"?Math.round(F):F.toFixed(1),U=S==="N/A"||S===void 0?"N/A":Math.round(S),q=M==="N/A"||M===void 0?"N/A":Math.round(M);t==="ATAK"?u+=`${k}${d}${U}${d}${x}
`:t==="Windwatch"?u+=`${k}${d}${U}${d}${x}
`:t==="HEIDIS"?u+=`
${k}${d}${E==="N/A"?"N/A":E.toFixed(1)}${d}${P}${d}${I}${d}${U}${d}${x}${d}${q}
`:t==="Customized"&&(u+=`
${k}${d}${E==="N/A"?"N/A":E.toFixed(1)}${d}${P}${d}${I}${d}${U}${d}${x}${d}${q}
`);const R=ut(e);if(!R||R.length===0){g.handleError("No interpolated data available to download.");return}R.forEach(B=>{if(B.displayHeight!==w){const X=Math.round(g.convertHeight(B.displayHeight,m)),G=B.pressure==="N/A"?"N/A":B.pressure.toFixed(1),ge=g.convertTemperature(B.temp,p),Ae=g.convertTemperature(B.dew,p),_e=g.convertWind(B.spd,f,h.getValue("windUnit","radio","kt")),tt=ge==="N/A"?"N/A":ge.toFixed(1),$e=Ae==="N/A"?"N/A":Ae.toFixed(1),le=_e==="N/A"?"N/A":f==="bft"?Math.round(_e):_e.toFixed(1),ve=B.dir==="N/A"?"N/A":Math.round(B.dir),Ge=B.rh==="N/A"?"N/A":Math.round(B.rh);t==="ATAK"?u+=`${X}${d}${ve}${d}${le}
`:t==="Windwatch"?u+=`${X}${d}${ve}${d}${le}
`:t==="HEIDIS"?u+=`${X}${d}${G}${d}${tt}${d}${$e}${d}${ve}${d}${le}${d}${Ge}
`:t==="Customized"&&(u+=`${X}${d}${G}${d}${tt}${d}${$e}${d}${ve}${d}${le}${d}${Ge}
`)}});const te=new Blob([u],{type:"text/plain"}),ne=window.URL.createObjectURL(te),K=document.createElement("a");K.href=ne,K.download=i,document.body.appendChild(K),K.click(),document.body.removeChild(K),window.URL.revokeObjectURL(ne),document.getElementById("interpStepSelect").value=r.interpStep,document.querySelector(`input[name="heightUnit"][value="${r.heightUnit}"]`).checked=!0,document.querySelector(`input[name="refLevel"][value="${r.refLevel}"]`).checked=!0,document.querySelector(`input[name="windUnit"][value="${r.windUnit}"]`).checked=!0,document.querySelector(`input[name="temperatureUnit"][value="${r.temperatureUnit}"]`).checked=!0,h.state.userSettings.interpStep=r.interpStep,h.state.userSettings.heightUnit=r.heightUnit,h.state.userSettings.refLevel=r.refLevel,h.state.userSettings.windUnit=r.windUnit,h.state.userSettings.temperatureUnit=r.temperatureUnit,h.save(),h.updateUnitLabels(),h.updateUnitLabels(),h.updateUnitLabels()}async function Wc(){if(!o.lastLat||!o.lastLng){console.warn("No location selected, cannot update weather data"),g.handleError("Please select a location to enable autoupdate."),stopAutoupdate(),document.getElementById("autoupdateCheckbox").checked=!1,h.state.userSettings.autoupdate=!1,h.save();return}if(!navigator.onLine){console.warn("Cannot update weather data: offline"),g.handleError("Cannot update weather data while offline."),stopAutoupdate(),document.getElementById("autoupdateCheckbox").checked=!1,h.state.userSettings.autoupdate=!1,h.save();return}const t=document.getElementById("timeSlider");if(!t){console.warn("Time slider not found, cannot update to current hour");return}const n=new Date().getUTCHours();t.value=n,console.log(`Set slider to current hour: ${n}`);try{await ct(o.lastLat,o.lastLng,null,!1),console.log("Weather data fetched for current hour"),await En(n),o.lastAltitude!=="N/A"&&zt(),h.state.userSettings.calculateJump&&h.state.isCalculateJumpUnlocked&&(Ye(),Ue(),h.state.userSettings.showJumpRunTrack&&ee()),console.log("Updated all displays for current hour")}catch(a){console.error("Error updating to current hour:",a),g.handleError("Failed to update weather data: "+a.message)}}function we(){if(!h.state.isCalculateJumpUnlocked||!h.state.userSettings.calculateJump){un(null),sa(null);return}if(!o.weatherData||!o.lastLat||!o.lastLng){un(null);return}const t=Oe(),e=ut(t),n={exitCircles:[],canopyCircles:[],canopyLabels:[]};if(h.state.userSettings.showExitArea){const i=Li(e);if(i){n.exitCircles.push({center:[i.greenLat,i.greenLng],radius:i.greenRadius,color:"green",fillColor:"green",fillOpacity:.2,weight:2});const s=`
                Exit areas calculated with:<br>
                Throw/Drift: ${Number.isFinite(i.freeFallDirection)?Math.round(i.freeFallDirection):"N/A"}° ${Number.isFinite(i.freeFallDistance)?Math.round(i.freeFallDistance):"N/A"} m<br>
                Free Fall Time: ${i.freeFallTime!=null&&!isNaN(i.freeFallTime)?Math.round(i.freeFallTime):"N/A"} sec
            `;n.exitCircles.push({center:[i.darkGreenLat,i.darkGreenLng],radius:i.darkGreenRadius,color:"darkgreen",fillColor:"darkgreen",fillOpacity:.2,weight:2,tooltip:s})}}if(h.state.userSettings.showCanopyArea){const i=ms(e);if(i){const s=g.calculateNewCenter(i.redLat,i.redLng,i.displacementFull,i.directionFull);n.canopyCircles.push({center:s,radius:i.radiusFull,color:"red",weight:2,opacity:.8,fillOpacity:0}),i.additionalBlueRadii.forEach((r,l)=>{const c=g.calculateNewCenter(i.blueLat,i.blueLng,i.additionalBlueDisplacements[l],i.additionalBlueDirections[l]);n.canopyCircles.push({center:c,radius:r,color:"blue",weight:1,fillColor:"blue",fillOpacity:.1,opacity:1}),n.canopyLabels.push({center:c,radius:r,text:`${Math.round(i.additionalBlueUpperLimits[l])}m`})})}}un(n);let a=null;if(h.state.userSettings.showCutAwayFinder&&o.cutAwayLat!==null){const i=Ue(e);i&&(a={center:i.center,radius:i.radius,tooltipContent:i.tooltipContent})}sa(a)}function zc(){return!h.state.userSettings.showJumpRunTrack||!h.state.userSettings.calculateJump||!o.weatherData||!o.lastLat||!o.lastLng?(console.log("Skipping calculateJumpRunTrack: conditions not met"),null):(console.log("Calculating jump run track..."),ee(),_n())}function Bc(t,e,n){const a=parseInt(t.value)||100,i=parseInt(e.value)||200,s=parseInt(n.value)||300;return i<=a?(g.handleError("Base leg must start higher than final leg."),!1):s<=i?(g.handleError("Downwind leg must start higher than base leg."),!1):!0}function He(t=null){const e=h.state.userSettings.showJumpMasterLine;if(!e){pi(),ec();return}if(!o.liveMarker){pi();return}const n=o.liveMarker.getLatLng();if(!n)return;const a=t||{latitude:n.lat,longitude:n.lng,speedMs:o.lastSmoothedSpeedMs,direction:o.lastDirection,deviceAltitude:o.lastDeviceAltitude,altitudeAccuracy:o.lastAltitudeAccuracy,accuracy:o.lastAccuracy};let i=null,s=null,r="";if(h.state.userSettings.jumpMasterLineTarget==="HARP"&&o.harpMarker?(s=o.harpMarker.getLatLng(),r="HARP"):o.currentMarker&&(s=o.currentMarker.getLatLng(),r="DIP"),s){const c=o.map.distance(n,s),u=Math.round(g.calculateBearing(n.lat,n.lng,s.lat,s.lng)),d=a.speedMs>1?a.speedMs:1,m=Math.round(c/d);i={distance:c,bearing:u,tot:m,target:r},Ql(n,s)}const l={heightUnit:h.getValue("heightUnit","radio","m"),effectiveWindUnit:h.getValue("windUnit","radio","kt")==="bft"?"kt":h.getValue("windUnit","radio","kt"),coordFormat:h.getValue("coordFormat","radio","Decimal"),refLevel:h.getValue("refLevel","radio","AGL")};tc({...a,showJumpMasterLine:e,jumpMasterLineData:i,...l})}function Gc(){if(h.initialize(),h.state.isLandingPatternUnlocked=h.state.unlockedFeatures.landingPattern,h.state.isCalculateJumpUnlocked=h.state.unlockedFeatures.calculateJump,h.state.userSettings.showJumpMasterLine=!1,console.log("Initial unlock status:",{isLandingPatternUnlocked:h.state.isLandingPatternUnlocked,isCalculateJumpUnlocked:h.state.isCalculateJumpUnlocked}),o.isInitialized){console.log("App already initialized, skipping");return}o.isInitialized=!0,console.log("Initializing app")}function Vc(){Jc("modelSelect",h.state.userSettings.model),qe("refLevel",h.state.userSettings.refLevel),qe("heightUnit",h.state.userSettings.heightUnit),qe("temperatureUnit",h.state.userSettings.temperatureUnit),qe("windUnit",h.state.userSettings.windUnit),qe("timeZone",h.state.userSettings.timeZone),qe("coordFormat",h.state.userSettings.coordFormat),qe("downloadFormat",h.state.userSettings.downloadFormat),qe("landingDirection",h.state.userSettings.landingDirection),V("canopySpeed",h.state.userSettings.canopySpeed),V("descentRate",h.state.userSettings.descentRate),V("legHeightDownwind",h.state.userSettings.legHeightDownwind),V("legHeightBase",h.state.userSettings.legHeightBase),V("legHeightFinal",h.state.userSettings.legHeightFinal),V("customLandingDirectionLL",h.state.userSettings.customLandingDirectionLL),V("customLandingDirectionRR",h.state.userSettings.customLandingDirectionRR),V("lowerLimit",h.state.userSettings.lowerLimit),V("upperLimit",h.state.userSettings.upperLimit),V("openingAltitude",h.state.userSettings.openingAltitude),V("exitAltitude",h.state.userSettings.exitAltitude),V("interpStepSelect",h.state.userSettings.interpStep),V("aircraftSpeedKt",h.state.userSettings.aircraftSpeedKt),V("jumpRunTrackOffset",h.state.userSettings.jumpRunTrackOffset),V("numberOfJumpers",h.state.userSettings.numberOfJumpers),gt("showTableCheckbox",h.state.userSettings.showTable),gt("calculateJumpCheckbox",h.state.userSettings.calculateJump),gt("showLandingPattern",h.state.userSettings.showLandingPattern),gt("showJumpRunTrack",h.state.userSettings.showJumpRunTrack),gt("showCanopyAreaCheckbox",h.state.userSettings.showCanopyArea),gt("showExitAreaCheckbox",h.state.userSettings.showExitArea),h.state.userSettings.isCustomJumpRunDirection=h.state.userSettings.isCustomJumpRunDirection||!1;const t=document.getElementById("customLandingDirectionLL"),e=document.getElementById("customLandingDirectionRR");t&&h.state.userSettings.customLandingDirectionLL!==""&&!isNaN(h.state.userSettings.customLandingDirectionLL)&&(t.value=h.state.userSettings.customLandingDirectionLL),e&&h.state.userSettings.customLandingDirectionRR!==""&&!isNaN(h.state.userSettings.customLandingDirectionRR)&&(e.value=h.state.userSettings.customLandingDirectionRR);const n=_i(h.state.userSettings.aircraftSpeedKt);V("jumperSeparation",n),h.state.userSettings.jumperSeparation=n,h.save();const a=document.getElementById("showLandingPattern"),i=document.getElementById("calculateJumpCheckbox");a&&(a.title=h.isFeatureUnlocked("landingPattern")&&h.state.isLandingPatternUnlocked?"":"Feature locked. Click to enter password.",a.style.opacity=h.isFeatureUnlocked("landingPattern")&&h.state.isLandingPatternUnlocked?"1":"0.5",console.log("Initialized showLandingPattern UI:",{checked:a.checked,opacity:a.style.opacity})),i&&(i.title=h.isFeatureUnlocked("calculateJump")&&h.state.isCalculateJumpUnlocked?"":"Feature locked. Click to enter password.",i.style.opacity=h.isFeatureUnlocked("calculateJump")&&h.state.isCalculateJumpUnlocked?"1":"0.5",console.log("Initialized calculateJumpCheckbox UI:",{checked:i.checked,opacity:i.style.opacity}));const s=document.getElementById("showJumpMasterLine");s&&(s.disabled=!h.state.userSettings.trackPosition,s.style.opacity=s.disabled?"0.5":"1",s.title=s.disabled?"Enable Live Tracking to use Jump Master Line":"");const r=document.getElementById("jumpRunTrackDirection");r&&(r.textContent="-"),zr()}function zr(){const t=document.getElementById("info");t&&(t.style.display=h.state.userSettings.showTable?"block":"none");const e=document.getElementById("customLandingDirectionLL"),n=document.getElementById("customLandingDirectionRR"),a=document.getElementById("showJumpRunTrack"),i=document.getElementById("showExitAreaCheckbox");e&&(e.disabled=h.state.userSettings.landingDirection!=="LL"),n&&(n.disabled=h.state.userSettings.landingDirection!=="RR"),a&&(a.disabled=!h.state.userSettings.calculateJump),i&&(i.disabled=!h.state.userSettings.calculateJump),h.updateUnitLabels()}async function Br(t){o.weatherData=t;const e=document.getElementById("timeSlider");if(!e)return;const a=(l=>{const c=l==null?void 0:l.temperature_2m;if(!c||c.length===0)return 0;for(let u=c.length-1;u>=0;u--)if(c[u]!==null&&c[u]!==void 0)return u;return 0})(t);console.log(`Daten sind gültig bis Index: ${a}. Setze Slider-Maximum.`),e.max=a,e.disabled=e.max<=0;const i=new Date().getTime();let s=0,r=1/0;t.time.forEach((l,c)=>{if(c<=a){const u=Math.abs(new Date(l).getTime()-i);u<r&&(r=u,s=c)}}),e.value=s,await pe(),h.updateModelRunInfo(o.lastModelRun,o.lastLat,o.lastLng)}async function pe(){console.log("updateAllDisplays called");try{const t=Oe();o.weatherData&&o.lastLat&&o.lastLng&&(await En(t),await kn(),o.lastAltitude!=="N/A"&&zt(),et(),h.state.userSettings.calculateJump&&we(),h.state.userSettings.showJumpRunTrack&&ee())}catch(t){console.error("Error in updateAllDisplays:",t),Mt(t.message)}}function gt(t,e){const n=document.getElementById(t);n&&(n.checked=e)}function Jc(t,e){const n=document.getElementById(t);n?n.value=e:console.warn(`Element ${t} not found`)}function V(t,e){const n=document.getElementById(t);n&&(n.value=e)}function gi(t,e){const n=document.getElementById(t);if(n){const a=n.value;n.value=e,console.log(`Set ${t} silently:`,{old:a,new:e})}}function qe(t,e){const n=document.querySelector(`input[name="${t}"][value="${e}"]`);n?n.checked=!0:console.warn(`Radio ${t} with value ${e} not found`)}function Zc(){console.log("[App] Setting up application event listeners..."),document.addEventListener("tracking:started",()=>{const t=document.getElementById("showJumpMasterLine");t&&(t.disabled=!1,t.style.opacity="1",t.title="")}),document.addEventListener("tracking:stopped",()=>{const t=document.getElementById("showJumpMasterLine");t&&(t.checked=!1,t.disabled=!0,t.style.opacity="0.5",t.title="Enable Live Tracking to use Jump Master Line"),h.state.userSettings.showJumpMasterLine&&(h.state.userSettings.showJumpMasterLine=!1,h.save()),He()}),document.addEventListener("ui:showJumpMasterLineChanged",()=>{He()}),document.addEventListener("jml:targetChanged",()=>{He()}),document.addEventListener("tracking:positionUpdated",t=>{He(t.detail)})}document.addEventListener("DOMContentLoaded",async()=>{Gc(),Vc(),await Pl(),Zc(),fc(),Uc(),Nr(),document.addEventListener("cutaway:marker_placed",()=>{console.log("App: Event 'cutaway:marker_placed' empfangen. Neuberechnung wird ausgelöst."),o.weatherData&&o.lastLat&&o.lastLng&&we()}),document.addEventListener("track:dragend",t=>{console.log("App: Event 'track:dragend' empfangen. Neuberechnung der Offsets relativ zum DIP.");const{newPosition:e,originalTrackData:n}=t.detail,a=L.latLng(o.lastLat,o.lastLng),i=n.trackLength,s=n.airplane.bearing,r=e,[l,c]=g.calculateNewCenter(r.lat,r.lng,i/2,(s+180)%360),u=L.latLng(l,c),d=o.map.distance(a,u);let p=g.calculateBearing(a.lat,a.lng,u.lat,u.lng)-s;p=(p+180)%360-180;const f=p*(Math.PI/180),y=Math.round(d*Math.cos(f)),v=Math.round(d*Math.sin(f));h.state.userSettings.jumpRunTrackOffset=v,h.state.userSettings.jumpRunTrackForwardOffset=y,h.save(),gi("jumpRunTrackOffset",v),gi("jumpRunTrackForwardOffset",y),ee()}),document.addEventListener("location:selected",async t=>{var s,r;const{lat:e,lng:n,source:a}=t.detail;console.log(`App: Event 'location:selected' empfangen. Quelle: ${a}`);const i=document.getElementById("loading");i&&(i.style.display="block");try{const l=Oe(),c=((r=(s=o.weatherData)==null?void 0:s.time)==null?void 0:r[l])||null,u=await ct(e,n,c);u?await Br(u):o.weatherData=null,await Tn(e,n),await kn(),St(!0),o.isManualPanning=!1,h.state.userSettings.showJumpMasterLine&&He()}catch(l){console.error('Fehler beim Verarbeiten von "location:selected":',l),Mt(l.message)}finally{i&&(i.style.display="none")}}),document.addEventListener("map:zoomend",t=>{console.log("App: Event 'map:zoomend' empfangen.");const e=o.map.getZoom();h.state.userSettings.calculateJump&&o.weatherData&&o.lastLat&&(e>=Te.MIN_ZOOM&&e<=Te.MAX_ZOOM?we():un(null)),h.state.userSettings.showJumpRunTrack&&(e>=Te.MIN_ZOOM&&e<=Te.MAX_ZOOM?ee():dn(null)),h.state.userSettings.showLandingPattern&&et()}),document.addEventListener("autoupdate:tick",async t=>{if(!h.state.userSettings.autoupdate)return;const e=new Date,n=document.getElementById("timeSlider");if(!n)return;const a=e.getUTCHours(),i=parseInt(n.value,10);(a!==i||t.detail.isInitialTick)&&(console.log(`[App] Autoupdate triggered. Current Hour: ${a}, Slider Hour: ${i}`),await Wc())})});
