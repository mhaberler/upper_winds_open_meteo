var lo=Object.defineProperty;var co=(t,e,n)=>e in t?lo(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var An=(t,e,n)=>co(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function n(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(i){if(i.ep)return;i.ep=!0;const r=n(i);fetch(i.href,r)}})();const s={isInitialized:!1,coordsControl:null,lastMouseLatLng:null,landingWindDir:null,cutAwayMarker:null,cutAwayLat:null,cutAwayLng:null,cutAwayCircle:null,isJumperSeparationManual:!1,weatherData:null,lastModelRun:null,gpxLayer:null,gpxPoints:[],isLoadingGpx:!1,isTrackLoaded:!1,liveMarker:null,jumpMasterLine:null,isPlacingHarp:!1,harpMarker:null,watchId:null,prevLat:null,prevLng:null,prevTime:null,livePositionControl:null,lastLatitude:null,lastLongitude:null,lastDeviceAltitude:null,lastAltitudeAccuracy:null,lastAccuracy:null,lastSpeed:"N/A",lastEffectiveWindUnit:"kt",lastDirection:"N/A",lastTerrainAltitude:"N/A",lastSmoothedSpeedMs:0,map:null,baseMaps:{},lastLat:null,lastLng:null,lastAltitude:null,currentMarker:null,isManualPanning:!1,autoupdateInterval:null,accuracyCircle:null,ensembleModelsData:null,selectedEnsembleModels:[],currentEnsembleScenario:"all_models",ensembleLayerGroup:null,ensembleScenarioCircles:{},heatmapLayer:null,favoritesLayerGroup:null,ismapInitialized:!1,hasTileErrorSwitched:!1,isCachingCancelled:!1,jumpVisualizationLayerGroup:null,landingPatternLayerGroup:null,jumpRunTrackLayerGroup:null,labelZoomListener:null};class ot extends Error{}class uo extends ot{constructor(e){super(`Invalid DateTime: ${e.toMessage()}`)}}class ho extends ot{constructor(e){super(`Invalid Interval: ${e.toMessage()}`)}}class mo extends ot{constructor(e){super(`Invalid Duration: ${e.toMessage()}`)}}class yt extends ot{}class vi extends ot{constructor(e){super(`Invalid unit ${e}`)}}class ee extends ot{}class Ue extends ot{constructor(){super("Zone is an abstract class")}}const C="numeric",_e="short",ce="long",hn={year:C,month:C,day:C},Li={year:C,month:_e,day:C},fo={year:C,month:_e,day:C,weekday:_e},Mi={year:C,month:ce,day:C},Si={year:C,month:ce,day:C,weekday:ce},_i={hour:C,minute:C},bi={hour:C,minute:C,second:C},Ei={hour:C,minute:C,second:C,timeZoneName:_e},Ti={hour:C,minute:C,second:C,timeZoneName:ce},ki={hour:C,minute:C,hourCycle:"h23"},Ai={hour:C,minute:C,second:C,hourCycle:"h23"},Ci={hour:C,minute:C,second:C,hourCycle:"h23",timeZoneName:_e},Ii={hour:C,minute:C,second:C,hourCycle:"h23",timeZoneName:ce},Ni={year:C,month:C,day:C,hour:C,minute:C},Fi={year:C,month:C,day:C,hour:C,minute:C,second:C},Di={year:C,month:_e,day:C,hour:C,minute:C},Pi={year:C,month:_e,day:C,hour:C,minute:C,second:C},go={year:C,month:_e,day:C,weekday:_e,hour:C,minute:C},xi={year:C,month:ce,day:C,hour:C,minute:C,timeZoneName:_e},Oi={year:C,month:ce,day:C,hour:C,minute:C,second:C,timeZoneName:_e},$i={year:C,month:ce,day:C,weekday:ce,hour:C,minute:C,timeZoneName:ce},Ri={year:C,month:ce,day:C,weekday:ce,hour:C,minute:C,second:C,timeZoneName:ce};class Gt{get type(){throw new Ue}get name(){throw new Ue}get ianaName(){return this.name}get isUniversal(){throw new Ue}offsetName(e,n){throw new Ue}formatOffset(e,n){throw new Ue}offset(e){throw new Ue}equals(e){throw new Ue}get isValid(){throw new Ue}}let Cn=null;class wn extends Gt{static get instance(){return Cn===null&&(Cn=new wn),Cn}get type(){return"system"}get name(){return new Intl.DateTimeFormat().resolvedOptions().timeZone}get isUniversal(){return!1}offsetName(e,{format:n,locale:a}){return qi(e,n,a)}formatOffset(e,n){return $t(this.offset(e),n)}offset(e){return-new Date(e).getTimezoneOffset()}equals(e){return e.type==="system"}get isValid(){return!0}}const Vn=new Map;function po(t){let e=Vn.get(t);return e===void 0&&(e=new Intl.DateTimeFormat("en-US",{hour12:!1,timeZone:t,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",era:"short"}),Vn.set(t,e)),e}const yo={year:0,month:1,day:2,era:3,hour:4,minute:5,second:6};function wo(t,e){const n=t.format(e).replace(/\u200E/g,""),a=/(\d+)\/(\d+)\/(\d+) (AD|BC),? (\d+):(\d+):(\d+)/.exec(n),[,i,r,o,l,c,u,d]=a;return[o,i,r,l,c,u,d]}function vo(t,e){const n=t.formatToParts(e),a=[];for(let i=0;i<n.length;i++){const{type:r,value:o}=n[i],l=yo[r];r==="era"?a[l]=o:O(l)||(a[l]=parseInt(o,10))}return a}const In=new Map;class Fe extends Gt{static create(e){let n=In.get(e);return n===void 0&&In.set(e,n=new Fe(e)),n}static resetCache(){In.clear(),Vn.clear()}static isValidSpecifier(e){return this.isValidZone(e)}static isValidZone(e){if(!e)return!1;try{return new Intl.DateTimeFormat("en-US",{timeZone:e}).format(),!0}catch{return!1}}constructor(e){super(),this.zoneName=e,this.valid=Fe.isValidZone(e)}get type(){return"iana"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(e,{format:n,locale:a}){return qi(e,n,a,this.name)}formatOffset(e,n){return $t(this.offset(e),n)}offset(e){if(!this.valid)return NaN;const n=new Date(e);if(isNaN(n))return NaN;const a=po(this.name);let[i,r,o,l,c,u,d]=a.formatToParts?vo(a,n):wo(a,n);l==="BC"&&(i=-Math.abs(i)+1);const g=Ln({year:i,month:r,day:o,hour:c===24?0:c,minute:u,second:d,millisecond:0});let f=+n;const w=f%1e3;return f-=w>=0?w:1e3+w,(g-f)/(60*1e3)}equals(e){return e.type==="iana"&&e.name===this.name}get isValid(){return this.valid}}let Da={};function Lo(t,e={}){const n=JSON.stringify([t,e]);let a=Da[n];return a||(a=new Intl.ListFormat(t,e),Da[n]=a),a}const Zn=new Map;function Jn(t,e={}){const n=JSON.stringify([t,e]);let a=Zn.get(n);return a===void 0&&(a=new Intl.DateTimeFormat(t,e),Zn.set(n,a)),a}const jn=new Map;function Mo(t,e={}){const n=JSON.stringify([t,e]);let a=jn.get(n);return a===void 0&&(a=new Intl.NumberFormat(t,e),jn.set(n,a)),a}const qn=new Map;function So(t,e={}){const{base:n,...a}=e,i=JSON.stringify([t,a]);let r=qn.get(i);return r===void 0&&(r=new Intl.RelativeTimeFormat(t,e),qn.set(i,r)),r}let Dt=null;function _o(){return Dt||(Dt=new Intl.DateTimeFormat().resolvedOptions().locale,Dt)}const Kn=new Map;function Ui(t){let e=Kn.get(t);return e===void 0&&(e=new Intl.DateTimeFormat(t).resolvedOptions(),Kn.set(t,e)),e}const Yn=new Map;function bo(t){let e=Yn.get(t);if(!e){const n=new Intl.Locale(t);e="getWeekInfo"in n?n.getWeekInfo():n.weekInfo,"minimalDays"in e||(e={...Wi,...e}),Yn.set(t,e)}return e}function Eo(t){const e=t.indexOf("-x-");e!==-1&&(t=t.substring(0,e));const n=t.indexOf("-u-");if(n===-1)return[t];{let a,i;try{a=Jn(t).resolvedOptions(),i=t}catch{const c=t.substring(0,n);a=Jn(c).resolvedOptions(),i=c}const{numberingSystem:r,calendar:o}=a;return[i,r,o]}}function To(t,e,n){return(n||e)&&(t.includes("-u-")||(t+="-u"),n&&(t+=`-ca-${n}`),e&&(t+=`-nu-${e}`)),t}function ko(t){const e=[];for(let n=1;n<=12;n++){const a=I.utc(2009,n,1);e.push(t(a))}return e}function Ao(t){const e=[];for(let n=1;n<=7;n++){const a=I.utc(2016,11,13+n);e.push(t(a))}return e}function Yt(t,e,n,a){const i=t.listingMode();return i==="error"?null:i==="en"?n(e):a(e)}function Co(t){return t.numberingSystem&&t.numberingSystem!=="latn"?!1:t.numberingSystem==="latn"||!t.locale||t.locale.startsWith("en")||Ui(t.locale).numberingSystem==="latn"}class Io{constructor(e,n,a){this.padTo=a.padTo||0,this.floor=a.floor||!1;const{padTo:i,floor:r,...o}=a;if(!n||Object.keys(o).length>0){const l={useGrouping:!1,...a};a.padTo>0&&(l.minimumIntegerDigits=a.padTo),this.inf=Mo(e,l)}}format(e){if(this.inf){const n=this.floor?Math.floor(e):e;return this.inf.format(n)}else{const n=this.floor?Math.floor(e):ma(e,3);return j(n,this.padTo)}}}class No{constructor(e,n,a){this.opts=a,this.originalZone=void 0;let i;if(this.opts.timeZone)this.dt=e;else if(e.zone.type==="fixed"){const o=-1*(e.offset/60),l=o>=0?`Etc/GMT+${o}`:`Etc/GMT${o}`;e.offset!==0&&Fe.create(l).valid?(i=l,this.dt=e):(i="UTC",this.dt=e.offset===0?e:e.setZone("UTC").plus({minutes:e.offset}),this.originalZone=e.zone)}else e.zone.type==="system"?this.dt=e:e.zone.type==="iana"?(this.dt=e,i=e.zone.name):(i="UTC",this.dt=e.setZone("UTC").plus({minutes:e.offset}),this.originalZone=e.zone);const r={...this.opts};r.timeZone=r.timeZone||i,this.dtf=Jn(n,r)}format(){return this.originalZone?this.formatToParts().map(({value:e})=>e).join(""):this.dtf.format(this.dt.toJSDate())}formatToParts(){const e=this.dtf.formatToParts(this.dt.toJSDate());return this.originalZone?e.map(n=>{if(n.type==="timeZoneName"){const a=this.originalZone.offsetName(this.dt.ts,{locale:this.dt.locale,format:this.opts.timeZoneName});return{...n,value:a}}else return n}):e}resolvedOptions(){return this.dtf.resolvedOptions()}}class Fo{constructor(e,n,a){this.opts={style:"long",...a},!n&&Ji()&&(this.rtf=So(e,a))}format(e,n){return this.rtf?this.rtf.format(e,n):es(n,e,this.opts.numeric,this.opts.style!=="long")}formatToParts(e,n){return this.rtf?this.rtf.formatToParts(e,n):[]}}const Wi={firstDay:1,minimalDays:4,weekend:[6,7]};class z{static fromOpts(e){return z.create(e.locale,e.numberingSystem,e.outputCalendar,e.weekSettings,e.defaultToEN)}static create(e,n,a,i,r=!1){const o=e||J.defaultLocale,l=o||(r?"en-US":_o()),c=n||J.defaultNumberingSystem,u=a||J.defaultOutputCalendar,d=Xn(i)||J.defaultWeekSettings;return new z(l,c,u,d,o)}static resetCache(){Dt=null,Zn.clear(),jn.clear(),qn.clear(),Kn.clear(),Yn.clear()}static fromObject({locale:e,numberingSystem:n,outputCalendar:a,weekSettings:i}={}){return z.create(e,n,a,i)}constructor(e,n,a,i,r){const[o,l,c]=Eo(e);this.locale=o,this.numberingSystem=n||l||null,this.outputCalendar=a||c||null,this.weekSettings=i,this.intl=To(this.locale,this.numberingSystem,this.outputCalendar),this.weekdaysCache={format:{},standalone:{}},this.monthsCache={format:{},standalone:{}},this.meridiemCache=null,this.eraCache={},this.specifiedLocale=r,this.fastNumbersCached=null}get fastNumbers(){return this.fastNumbersCached==null&&(this.fastNumbersCached=Co(this)),this.fastNumbersCached}listingMode(){const e=this.isEnglish(),n=(this.numberingSystem===null||this.numberingSystem==="latn")&&(this.outputCalendar===null||this.outputCalendar==="gregory");return e&&n?"en":"intl"}clone(e){return!e||Object.getOwnPropertyNames(e).length===0?this:z.create(e.locale||this.specifiedLocale,e.numberingSystem||this.numberingSystem,e.outputCalendar||this.outputCalendar,Xn(e.weekSettings)||this.weekSettings,e.defaultToEN||!1)}redefaultToEN(e={}){return this.clone({...e,defaultToEN:!0})}redefaultToSystem(e={}){return this.clone({...e,defaultToEN:!1})}months(e,n=!1){return Yt(this,e,Qi,()=>{const a=n?{month:e,day:"numeric"}:{month:e},i=n?"format":"standalone";return this.monthsCache[i][e]||(this.monthsCache[i][e]=ko(r=>this.extract(r,a,"month"))),this.monthsCache[i][e]})}weekdays(e,n=!1){return Yt(this,e,tr,()=>{const a=n?{weekday:e,year:"numeric",month:"long",day:"numeric"}:{weekday:e},i=n?"format":"standalone";return this.weekdaysCache[i][e]||(this.weekdaysCache[i][e]=Ao(r=>this.extract(r,a,"weekday"))),this.weekdaysCache[i][e]})}meridiems(){return Yt(this,void 0,()=>nr,()=>{if(!this.meridiemCache){const e={hour:"numeric",hourCycle:"h12"};this.meridiemCache=[I.utc(2016,11,13,9),I.utc(2016,11,13,19)].map(n=>this.extract(n,e,"dayperiod"))}return this.meridiemCache})}eras(e){return Yt(this,e,ar,()=>{const n={era:e};return this.eraCache[e]||(this.eraCache[e]=[I.utc(-40,1,1),I.utc(2017,1,1)].map(a=>this.extract(a,n,"era"))),this.eraCache[e]})}extract(e,n,a){const i=this.dtFormatter(e,n),r=i.formatToParts(),o=r.find(l=>l.type.toLowerCase()===a);return o?o.value:null}numberFormatter(e={}){return new Io(this.intl,e.forceSimple||this.fastNumbers,e)}dtFormatter(e,n={}){return new No(e,this.intl,n)}relFormatter(e={}){return new Fo(this.intl,this.isEnglish(),e)}listFormatter(e={}){return Lo(this.intl,e)}isEnglish(){return this.locale==="en"||this.locale.toLowerCase()==="en-us"||Ui(this.intl).locale.startsWith("en-us")}getWeekSettings(){return this.weekSettings?this.weekSettings:ji()?bo(this.locale):Wi}getStartOfWeek(){return this.getWeekSettings().firstDay}getMinDaysInFirstWeek(){return this.getWeekSettings().minimalDays}getWeekendDays(){return this.getWeekSettings().weekend}equals(e){return this.locale===e.locale&&this.numberingSystem===e.numberingSystem&&this.outputCalendar===e.outputCalendar}toString(){return`Locale(${this.locale}, ${this.numberingSystem}, ${this.outputCalendar})`}}let Nn=null;class re extends Gt{static get utcInstance(){return Nn===null&&(Nn=new re(0)),Nn}static instance(e){return e===0?re.utcInstance:new re(e)}static parseSpecifier(e){if(e){const n=e.match(/^utc(?:([+-]\d{1,2})(?::(\d{2}))?)?$/i);if(n)return new re(Mn(n[1],n[2]))}return null}constructor(e){super(),this.fixed=e}get type(){return"fixed"}get name(){return this.fixed===0?"UTC":`UTC${$t(this.fixed,"narrow")}`}get ianaName(){return this.fixed===0?"Etc/UTC":`Etc/GMT${$t(-this.fixed,"narrow")}`}offsetName(){return this.name}formatOffset(e,n){return $t(this.fixed,n)}get isUniversal(){return!0}offset(){return this.fixed}equals(e){return e.type==="fixed"&&e.fixed===this.fixed}get isValid(){return!0}}class Do extends Gt{constructor(e){super(),this.zoneName=e}get type(){return"invalid"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(){return null}formatOffset(){return""}offset(){return NaN}equals(){return!1}get isValid(){return!1}}function Be(t,e){if(O(t)||t===null)return e;if(t instanceof Gt)return t;if(Uo(t)){const n=t.toLowerCase();return n==="default"?e:n==="local"||n==="system"?wn.instance:n==="utc"||n==="gmt"?re.utcInstance:re.parseSpecifier(n)||Fe.create(t)}else return Ve(t)?re.instance(t):typeof t=="object"&&"offset"in t&&typeof t.offset=="function"?t:new Do(t)}const ca={arab:"[٠-٩]",arabext:"[۰-۹]",bali:"[᭐-᭙]",beng:"[০-৯]",deva:"[०-९]",fullwide:"[０-９]",gujr:"[૦-૯]",hanidec:"[〇|一|二|三|四|五|六|七|八|九]",khmr:"[០-៩]",knda:"[೦-೯]",laoo:"[໐-໙]",limb:"[᥆-᥏]",mlym:"[൦-൯]",mong:"[᠐-᠙]",mymr:"[၀-၉]",orya:"[୦-୯]",tamldec:"[௦-௯]",telu:"[౦-౯]",thai:"[๐-๙]",tibt:"[༠-༩]",latn:"\\d"},Pa={arab:[1632,1641],arabext:[1776,1785],bali:[6992,7001],beng:[2534,2543],deva:[2406,2415],fullwide:[65296,65303],gujr:[2790,2799],khmr:[6112,6121],knda:[3302,3311],laoo:[3792,3801],limb:[6470,6479],mlym:[3430,3439],mong:[6160,6169],mymr:[4160,4169],orya:[2918,2927],tamldec:[3046,3055],telu:[3174,3183],thai:[3664,3673],tibt:[3872,3881]},Po=ca.hanidec.replace(/[\[|\]]/g,"").split("");function xo(t){let e=parseInt(t,10);if(isNaN(e)){e="";for(let n=0;n<t.length;n++){const a=t.charCodeAt(n);if(t[n].search(ca.hanidec)!==-1)e+=Po.indexOf(t[n]);else for(const i in Pa){const[r,o]=Pa[i];a>=r&&a<=o&&(e+=a-r)}}return parseInt(e,10)}else return e}const Qn=new Map;function Oo(){Qn.clear()}function we({numberingSystem:t},e=""){const n=t||"latn";let a=Qn.get(n);a===void 0&&(a=new Map,Qn.set(n,a));let i=a.get(e);return i===void 0&&(i=new RegExp(`${ca[n]}${e}`),a.set(e,i)),i}let xa=()=>Date.now(),Oa="system",$a=null,Ra=null,Ua=null,Wa=60,Ha,za=null,J=class{static get now(){return xa}static set now(e){xa=e}static set defaultZone(e){Oa=e}static get defaultZone(){return Be(Oa,wn.instance)}static get defaultLocale(){return $a}static set defaultLocale(e){$a=e}static get defaultNumberingSystem(){return Ra}static set defaultNumberingSystem(e){Ra=e}static get defaultOutputCalendar(){return Ua}static set defaultOutputCalendar(e){Ua=e}static get defaultWeekSettings(){return za}static set defaultWeekSettings(e){za=Xn(e)}static get twoDigitCutoffYear(){return Wa}static set twoDigitCutoffYear(e){Wa=e%100}static get throwOnInvalid(){return Ha}static set throwOnInvalid(e){Ha=e}static resetCaches(){z.resetCache(),Fe.resetCache(),I.resetCache(),Oo()}};class Me{constructor(e,n){this.reason=e,this.explanation=n}toMessage(){return this.explanation?`${this.reason}: ${this.explanation}`:this.reason}}const Hi=[0,31,59,90,120,151,181,212,243,273,304,334],zi=[0,31,60,91,121,152,182,213,244,274,305,335];function ge(t,e){return new Me("unit out of range",`you specified ${e} (of type ${typeof e}) as a ${t}, which is invalid`)}function ua(t,e,n){const a=new Date(Date.UTC(t,e-1,n));t<100&&t>=0&&a.setUTCFullYear(a.getUTCFullYear()-1900);const i=a.getUTCDay();return i===0?7:i}function Bi(t,e,n){return n+(Vt(t)?zi:Hi)[e-1]}function Gi(t,e){const n=Vt(t)?zi:Hi,a=n.findIndex(r=>r<e),i=e-n[a];return{month:a+1,day:i}}function da(t,e){return(t-e+7)%7+1}function mn(t,e=4,n=1){const{year:a,month:i,day:r}=t,o=Bi(a,i,r),l=da(ua(a,i,r),n);let c=Math.floor((o-l+14-e)/7),u;return c<1?(u=a-1,c=Wt(u,e,n)):c>Wt(a,e,n)?(u=a+1,c=1):u=a,{weekYear:u,weekNumber:c,weekday:l,...Sn(t)}}function Ba(t,e=4,n=1){const{weekYear:a,weekNumber:i,weekday:r}=t,o=da(ua(a,1,e),n),l=Mt(a);let c=i*7+r-o-7+e,u;c<1?(u=a-1,c+=Mt(u)):c>l?(u=a+1,c-=Mt(a)):u=a;const{month:d,day:h}=Gi(u,c);return{year:u,month:d,day:h,...Sn(t)}}function Fn(t){const{year:e,month:n,day:a}=t,i=Bi(e,n,a);return{year:e,ordinal:i,...Sn(t)}}function Ga(t){const{year:e,ordinal:n}=t,{month:a,day:i}=Gi(e,n);return{year:e,month:a,day:i,...Sn(t)}}function Va(t,e){if(!O(t.localWeekday)||!O(t.localWeekNumber)||!O(t.localWeekYear)){if(!O(t.weekday)||!O(t.weekNumber)||!O(t.weekYear))throw new yt("Cannot mix locale-based week fields with ISO-based week fields");return O(t.localWeekday)||(t.weekday=t.localWeekday),O(t.localWeekNumber)||(t.weekNumber=t.localWeekNumber),O(t.localWeekYear)||(t.weekYear=t.localWeekYear),delete t.localWeekday,delete t.localWeekNumber,delete t.localWeekYear,{minDaysInFirstWeek:e.getMinDaysInFirstWeek(),startOfWeek:e.getStartOfWeek()}}else return{minDaysInFirstWeek:4,startOfWeek:1}}function $o(t,e=4,n=1){const a=vn(t.weekYear),i=pe(t.weekNumber,1,Wt(t.weekYear,e,n)),r=pe(t.weekday,1,7);return a?i?r?!1:ge("weekday",t.weekday):ge("week",t.weekNumber):ge("weekYear",t.weekYear)}function Ro(t){const e=vn(t.year),n=pe(t.ordinal,1,Mt(t.year));return e?n?!1:ge("ordinal",t.ordinal):ge("year",t.year)}function Vi(t){const e=vn(t.year),n=pe(t.month,1,12),a=pe(t.day,1,fn(t.year,t.month));return e?n?a?!1:ge("day",t.day):ge("month",t.month):ge("year",t.year)}function Zi(t){const{hour:e,minute:n,second:a,millisecond:i}=t,r=pe(e,0,23)||e===24&&n===0&&a===0&&i===0,o=pe(n,0,59),l=pe(a,0,59),c=pe(i,0,999);return r?o?l?c?!1:ge("millisecond",i):ge("second",a):ge("minute",n):ge("hour",e)}function O(t){return typeof t>"u"}function Ve(t){return typeof t=="number"}function vn(t){return typeof t=="number"&&t%1===0}function Uo(t){return typeof t=="string"}function Wo(t){return Object.prototype.toString.call(t)==="[object Date]"}function Ji(){try{return typeof Intl<"u"&&!!Intl.RelativeTimeFormat}catch{return!1}}function ji(){try{return typeof Intl<"u"&&!!Intl.Locale&&("weekInfo"in Intl.Locale.prototype||"getWeekInfo"in Intl.Locale.prototype)}catch{return!1}}function Ho(t){return Array.isArray(t)?t:[t]}function Za(t,e,n){if(t.length!==0)return t.reduce((a,i)=>{const r=[e(i),i];return a&&n(a[0],r[0])===a[0]?a:r},null)[1]}function zo(t,e){return e.reduce((n,a)=>(n[a]=t[a],n),{})}function _t(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function Xn(t){if(t==null)return null;if(typeof t!="object")throw new ee("Week settings must be an object");if(!pe(t.firstDay,1,7)||!pe(t.minimalDays,1,7)||!Array.isArray(t.weekend)||t.weekend.some(e=>!pe(e,1,7)))throw new ee("Invalid week settings");return{firstDay:t.firstDay,minimalDays:t.minimalDays,weekend:Array.from(t.weekend)}}function pe(t,e,n){return vn(t)&&t>=e&&t<=n}function Bo(t,e){return t-e*Math.floor(t/e)}function j(t,e=2){const n=t<0;let a;return n?a="-"+(""+-t).padStart(e,"0"):a=(""+t).padStart(e,"0"),a}function ze(t){if(!(O(t)||t===null||t===""))return parseInt(t,10)}function Qe(t){if(!(O(t)||t===null||t===""))return parseFloat(t)}function ha(t){if(!(O(t)||t===null||t==="")){const e=parseFloat("0."+t)*1e3;return Math.floor(e)}}function ma(t,e,n=!1){const a=10**e;return(n?Math.trunc:Math.round)(t*a)/a}function Vt(t){return t%4===0&&(t%100!==0||t%400===0)}function Mt(t){return Vt(t)?366:365}function fn(t,e){const n=Bo(e-1,12)+1,a=t+(e-n)/12;return n===2?Vt(a)?29:28:[31,null,31,30,31,30,31,31,30,31,30,31][n-1]}function Ln(t){let e=Date.UTC(t.year,t.month-1,t.day,t.hour,t.minute,t.second,t.millisecond);return t.year<100&&t.year>=0&&(e=new Date(e),e.setUTCFullYear(t.year,t.month-1,t.day)),+e}function Ja(t,e,n){return-da(ua(t,1,e),n)+e-1}function Wt(t,e=4,n=1){const a=Ja(t,e,n),i=Ja(t+1,e,n);return(Mt(t)-a+i)/7}function ea(t){return t>99?t:t>J.twoDigitCutoffYear?1900+t:2e3+t}function qi(t,e,n,a=null){const i=new Date(t),r={hourCycle:"h23",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"};a&&(r.timeZone=a);const o={timeZoneName:e,...r},l=new Intl.DateTimeFormat(n,o).formatToParts(i).find(c=>c.type.toLowerCase()==="timezonename");return l?l.value:null}function Mn(t,e){let n=parseInt(t,10);Number.isNaN(n)&&(n=0);const a=parseInt(e,10)||0,i=n<0||Object.is(n,-0)?-a:a;return n*60+i}function Ki(t){const e=Number(t);if(typeof t=="boolean"||t===""||Number.isNaN(e))throw new ee(`Invalid unit value ${t}`);return e}function gn(t,e){const n={};for(const a in t)if(_t(t,a)){const i=t[a];if(i==null)continue;n[e(a)]=Ki(i)}return n}function $t(t,e){const n=Math.trunc(Math.abs(t/60)),a=Math.trunc(Math.abs(t%60)),i=t>=0?"+":"-";switch(e){case"short":return`${i}${j(n,2)}:${j(a,2)}`;case"narrow":return`${i}${n}${a>0?`:${a}`:""}`;case"techie":return`${i}${j(n,2)}${j(a,2)}`;default:throw new RangeError(`Value format ${e} is out of range for property format`)}}function Sn(t){return zo(t,["hour","minute","second","millisecond"])}const Go=["January","February","March","April","May","June","July","August","September","October","November","December"],Yi=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],Vo=["J","F","M","A","M","J","J","A","S","O","N","D"];function Qi(t){switch(t){case"narrow":return[...Vo];case"short":return[...Yi];case"long":return[...Go];case"numeric":return["1","2","3","4","5","6","7","8","9","10","11","12"];case"2-digit":return["01","02","03","04","05","06","07","08","09","10","11","12"];default:return null}}const Xi=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],er=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],Zo=["M","T","W","T","F","S","S"];function tr(t){switch(t){case"narrow":return[...Zo];case"short":return[...er];case"long":return[...Xi];case"numeric":return["1","2","3","4","5","6","7"];default:return null}}const nr=["AM","PM"],Jo=["Before Christ","Anno Domini"],jo=["BC","AD"],qo=["B","A"];function ar(t){switch(t){case"narrow":return[...qo];case"short":return[...jo];case"long":return[...Jo];default:return null}}function Ko(t){return nr[t.hour<12?0:1]}function Yo(t,e){return tr(e)[t.weekday-1]}function Qo(t,e){return Qi(e)[t.month-1]}function Xo(t,e){return ar(e)[t.year<0?0:1]}function es(t,e,n="always",a=!1){const i={years:["year","yr."],quarters:["quarter","qtr."],months:["month","mo."],weeks:["week","wk."],days:["day","day","days"],hours:["hour","hr."],minutes:["minute","min."],seconds:["second","sec."]},r=["hours","minutes","seconds"].indexOf(t)===-1;if(n==="auto"&&r){const h=t==="days";switch(e){case 1:return h?"tomorrow":`next ${i[t][0]}`;case-1:return h?"yesterday":`last ${i[t][0]}`;case 0:return h?"today":`this ${i[t][0]}`}}const o=Object.is(e,-0)||e<0,l=Math.abs(e),c=l===1,u=i[t],d=a?c?u[1]:u[2]||u[1]:c?i[t][0]:t;return o?`${l} ${d} ago`:`in ${l} ${d}`}function ja(t,e){let n="";for(const a of t)a.literal?n+=a.val:n+=e(a.val);return n}const ts={D:hn,DD:Li,DDD:Mi,DDDD:Si,t:_i,tt:bi,ttt:Ei,tttt:Ti,T:ki,TT:Ai,TTT:Ci,TTTT:Ii,f:Ni,ff:Di,fff:xi,ffff:$i,F:Fi,FF:Pi,FFF:Oi,FFFF:Ri};class ne{static create(e,n={}){return new ne(e,n)}static parseFormat(e){let n=null,a="",i=!1;const r=[];for(let o=0;o<e.length;o++){const l=e.charAt(o);l==="'"?(a.length>0&&r.push({literal:i||/^\s+$/.test(a),val:a}),n=null,a="",i=!i):i||l===n?a+=l:(a.length>0&&r.push({literal:/^\s+$/.test(a),val:a}),a=l,n=l)}return a.length>0&&r.push({literal:i||/^\s+$/.test(a),val:a}),r}static macroTokenToFormatOpts(e){return ts[e]}constructor(e,n){this.opts=n,this.loc=e,this.systemLoc=null}formatWithSystemDefault(e,n){return this.systemLoc===null&&(this.systemLoc=this.loc.redefaultToSystem()),this.systemLoc.dtFormatter(e,{...this.opts,...n}).format()}dtFormatter(e,n={}){return this.loc.dtFormatter(e,{...this.opts,...n})}formatDateTime(e,n){return this.dtFormatter(e,n).format()}formatDateTimeParts(e,n){return this.dtFormatter(e,n).formatToParts()}formatInterval(e,n){return this.dtFormatter(e.start,n).dtf.formatRange(e.start.toJSDate(),e.end.toJSDate())}resolvedOptions(e,n){return this.dtFormatter(e,n).resolvedOptions()}num(e,n=0){if(this.opts.forceSimple)return j(e,n);const a={...this.opts};return n>0&&(a.padTo=n),this.loc.numberFormatter(a).format(e)}formatDateTimeFromString(e,n){const a=this.loc.listingMode()==="en",i=this.loc.outputCalendar&&this.loc.outputCalendar!=="gregory",r=(f,w)=>this.loc.extract(e,f,w),o=f=>e.isOffsetFixed&&e.offset===0&&f.allowZ?"Z":e.isValid?e.zone.formatOffset(e.ts,f.format):"",l=()=>a?Ko(e):r({hour:"numeric",hourCycle:"h12"},"dayperiod"),c=(f,w)=>a?Qo(e,f):r(w?{month:f}:{month:f,day:"numeric"},"month"),u=(f,w)=>a?Yo(e,f):r(w?{weekday:f}:{weekday:f,month:"long",day:"numeric"},"weekday"),d=f=>{const w=ne.macroTokenToFormatOpts(f);return w?this.formatWithSystemDefault(e,w):f},h=f=>a?Xo(e,f):r({era:f},"era"),g=f=>{switch(f){case"S":return this.num(e.millisecond);case"u":case"SSS":return this.num(e.millisecond,3);case"s":return this.num(e.second);case"ss":return this.num(e.second,2);case"uu":return this.num(Math.floor(e.millisecond/10),2);case"uuu":return this.num(Math.floor(e.millisecond/100));case"m":return this.num(e.minute);case"mm":return this.num(e.minute,2);case"h":return this.num(e.hour%12===0?12:e.hour%12);case"hh":return this.num(e.hour%12===0?12:e.hour%12,2);case"H":return this.num(e.hour);case"HH":return this.num(e.hour,2);case"Z":return o({format:"narrow",allowZ:this.opts.allowZ});case"ZZ":return o({format:"short",allowZ:this.opts.allowZ});case"ZZZ":return o({format:"techie",allowZ:this.opts.allowZ});case"ZZZZ":return e.zone.offsetName(e.ts,{format:"short",locale:this.loc.locale});case"ZZZZZ":return e.zone.offsetName(e.ts,{format:"long",locale:this.loc.locale});case"z":return e.zoneName;case"a":return l();case"d":return i?r({day:"numeric"},"day"):this.num(e.day);case"dd":return i?r({day:"2-digit"},"day"):this.num(e.day,2);case"c":return this.num(e.weekday);case"ccc":return u("short",!0);case"cccc":return u("long",!0);case"ccccc":return u("narrow",!0);case"E":return this.num(e.weekday);case"EEE":return u("short",!1);case"EEEE":return u("long",!1);case"EEEEE":return u("narrow",!1);case"L":return i?r({month:"numeric",day:"numeric"},"month"):this.num(e.month);case"LL":return i?r({month:"2-digit",day:"numeric"},"month"):this.num(e.month,2);case"LLL":return c("short",!0);case"LLLL":return c("long",!0);case"LLLLL":return c("narrow",!0);case"M":return i?r({month:"numeric"},"month"):this.num(e.month);case"MM":return i?r({month:"2-digit"},"month"):this.num(e.month,2);case"MMM":return c("short",!1);case"MMMM":return c("long",!1);case"MMMMM":return c("narrow",!1);case"y":return i?r({year:"numeric"},"year"):this.num(e.year);case"yy":return i?r({year:"2-digit"},"year"):this.num(e.year.toString().slice(-2),2);case"yyyy":return i?r({year:"numeric"},"year"):this.num(e.year,4);case"yyyyyy":return i?r({year:"numeric"},"year"):this.num(e.year,6);case"G":return h("short");case"GG":return h("long");case"GGGGG":return h("narrow");case"kk":return this.num(e.weekYear.toString().slice(-2),2);case"kkkk":return this.num(e.weekYear,4);case"W":return this.num(e.weekNumber);case"WW":return this.num(e.weekNumber,2);case"n":return this.num(e.localWeekNumber);case"nn":return this.num(e.localWeekNumber,2);case"ii":return this.num(e.localWeekYear.toString().slice(-2),2);case"iiii":return this.num(e.localWeekYear,4);case"o":return this.num(e.ordinal);case"ooo":return this.num(e.ordinal,3);case"q":return this.num(e.quarter);case"qq":return this.num(e.quarter,2);case"X":return this.num(Math.floor(e.ts/1e3));case"x":return this.num(e.ts);default:return d(f)}};return ja(ne.parseFormat(n),g)}formatDurationFromString(e,n){const a=c=>{switch(c[0]){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":return"hour";case"d":return"day";case"w":return"week";case"M":return"month";case"y":return"year";default:return null}},i=c=>u=>{const d=a(u);return d?this.num(c.get(d),u.length):u},r=ne.parseFormat(n),o=r.reduce((c,{literal:u,val:d})=>u?c:c.concat(d),[]),l=e.shiftTo(...o.map(a).filter(c=>c));return ja(r,i(l))}}const ir=/[A-Za-z_+-]{1,256}(?::?\/[A-Za-z0-9_+-]{1,256}(?:\/[A-Za-z0-9_+-]{1,256})?)?/;function bt(...t){const e=t.reduce((n,a)=>n+a.source,"");return RegExp(`^${e}$`)}function Et(...t){return e=>t.reduce(([n,a,i],r)=>{const[o,l,c]=r(e,i);return[{...n,...o},l||a,c]},[{},null,1]).slice(0,2)}function Tt(t,...e){if(t==null)return[null,null];for(const[n,a]of e){const i=n.exec(t);if(i)return a(i)}return[null,null]}function rr(...t){return(e,n)=>{const a={};let i;for(i=0;i<t.length;i++)a[t[i]]=ze(e[n+i]);return[a,null,n+i]}}const or=/(?:(Z)|([+-]\d\d)(?::?(\d\d))?)/,ns=`(?:${or.source}?(?:\\[(${ir.source})\\])?)?`,fa=/(\d\d)(?::?(\d\d)(?::?(\d\d)(?:[.,](\d{1,30}))?)?)?/,sr=RegExp(`${fa.source}${ns}`),ga=RegExp(`(?:T${sr.source})?`),as=/([+-]\d{6}|\d{4})(?:-?(\d\d)(?:-?(\d\d))?)?/,is=/(\d{4})-?W(\d\d)(?:-?(\d))?/,rs=/(\d{4})-?(\d{3})/,os=rr("weekYear","weekNumber","weekDay"),ss=rr("year","ordinal"),ls=/(\d{4})-(\d\d)-(\d\d)/,lr=RegExp(`${fa.source} ?(?:${or.source}|(${ir.source}))?`),cs=RegExp(`(?: ${lr.source})?`);function St(t,e,n){const a=t[e];return O(a)?n:ze(a)}function us(t,e){return[{year:St(t,e),month:St(t,e+1,1),day:St(t,e+2,1)},null,e+3]}function kt(t,e){return[{hours:St(t,e,0),minutes:St(t,e+1,0),seconds:St(t,e+2,0),milliseconds:ha(t[e+3])},null,e+4]}function Zt(t,e){const n=!t[e]&&!t[e+1],a=Mn(t[e+1],t[e+2]),i=n?null:re.instance(a);return[{},i,e+3]}function Jt(t,e){const n=t[e]?Fe.create(t[e]):null;return[{},n,e+1]}const ds=RegExp(`^T?${fa.source}$`),hs=/^-?P(?:(?:(-?\d{1,20}(?:\.\d{1,20})?)Y)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20}(?:\.\d{1,20})?)W)?(?:(-?\d{1,20}(?:\.\d{1,20})?)D)?(?:T(?:(-?\d{1,20}(?:\.\d{1,20})?)H)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20})(?:[.,](-?\d{1,20}))?S)?)?)$/;function ms(t){const[e,n,a,i,r,o,l,c,u]=t,d=e[0]==="-",h=c&&c[0]==="-",g=(f,w=!1)=>f!==void 0&&(w||f&&d)?-f:f;return[{years:g(Qe(n)),months:g(Qe(a)),weeks:g(Qe(i)),days:g(Qe(r)),hours:g(Qe(o)),minutes:g(Qe(l)),seconds:g(Qe(c),c==="-0"),milliseconds:g(ha(u),h)}]}const fs={GMT:0,EDT:-4*60,EST:-5*60,CDT:-5*60,CST:-6*60,MDT:-6*60,MST:-7*60,PDT:-7*60,PST:-8*60};function pa(t,e,n,a,i,r,o){const l={year:e.length===2?ea(ze(e)):ze(e),month:Yi.indexOf(n)+1,day:ze(a),hour:ze(i),minute:ze(r)};return o&&(l.second=ze(o)),t&&(l.weekday=t.length>3?Xi.indexOf(t)+1:er.indexOf(t)+1),l}const gs=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|(?:([+-]\d\d)(\d\d)))$/;function ps(t){const[,e,n,a,i,r,o,l,c,u,d,h]=t,g=pa(e,i,a,n,r,o,l);let f;return c?f=fs[c]:u?f=0:f=Mn(d,h),[g,new re(f)]}function ys(t){return t.replace(/\([^()]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").trim()}const ws=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun), (\d\d) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) (\d{4}) (\d\d):(\d\d):(\d\d) GMT$/,vs=/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday), (\d\d)-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-(\d\d) (\d\d):(\d\d):(\d\d) GMT$/,Ls=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) ( \d|\d\d) (\d\d):(\d\d):(\d\d) (\d{4})$/;function qa(t){const[,e,n,a,i,r,o,l]=t;return[pa(e,i,a,n,r,o,l),re.utcInstance]}function Ms(t){const[,e,n,a,i,r,o,l]=t;return[pa(e,l,n,a,i,r,o),re.utcInstance]}const Ss=bt(as,ga),_s=bt(is,ga),bs=bt(rs,ga),Es=bt(sr),cr=Et(us,kt,Zt,Jt),Ts=Et(os,kt,Zt,Jt),ks=Et(ss,kt,Zt,Jt),As=Et(kt,Zt,Jt);function Cs(t){return Tt(t,[Ss,cr],[_s,Ts],[bs,ks],[Es,As])}function Is(t){return Tt(ys(t),[gs,ps])}function Ns(t){return Tt(t,[ws,qa],[vs,qa],[Ls,Ms])}function Fs(t){return Tt(t,[hs,ms])}const Ds=Et(kt);function Ps(t){return Tt(t,[ds,Ds])}const xs=bt(ls,cs),Os=bt(lr),$s=Et(kt,Zt,Jt);function Rs(t){return Tt(t,[xs,cr],[Os,$s])}const Ka="Invalid Duration",ur={weeks:{days:7,hours:7*24,minutes:7*24*60,seconds:7*24*60*60,milliseconds:7*24*60*60*1e3},days:{hours:24,minutes:24*60,seconds:24*60*60,milliseconds:24*60*60*1e3},hours:{minutes:60,seconds:60*60,milliseconds:60*60*1e3},minutes:{seconds:60,milliseconds:60*1e3},seconds:{milliseconds:1e3}},Us={years:{quarters:4,months:12,weeks:52,days:365,hours:365*24,minutes:365*24*60,seconds:365*24*60*60,milliseconds:365*24*60*60*1e3},quarters:{months:3,weeks:13,days:91,hours:91*24,minutes:91*24*60,seconds:91*24*60*60,milliseconds:91*24*60*60*1e3},months:{weeks:4,days:30,hours:30*24,minutes:30*24*60,seconds:30*24*60*60,milliseconds:30*24*60*60*1e3},...ur},ue=146097/400,ht=146097/4800,Ws={years:{quarters:4,months:12,weeks:ue/7,days:ue,hours:ue*24,minutes:ue*24*60,seconds:ue*24*60*60,milliseconds:ue*24*60*60*1e3},quarters:{months:3,weeks:ue/28,days:ue/4,hours:ue*24/4,minutes:ue*24*60/4,seconds:ue*24*60*60/4,milliseconds:ue*24*60*60*1e3/4},months:{weeks:ht/7,days:ht,hours:ht*24,minutes:ht*24*60,seconds:ht*24*60*60,milliseconds:ht*24*60*60*1e3},...ur},it=["years","quarters","months","weeks","days","hours","minutes","seconds","milliseconds"],Hs=it.slice(0).reverse();function We(t,e,n=!1){const a={values:n?e.values:{...t.values,...e.values||{}},loc:t.loc.clone(e.loc),conversionAccuracy:e.conversionAccuracy||t.conversionAccuracy,matrix:e.matrix||t.matrix};return new W(a)}function dr(t,e){let n=e.milliseconds??0;for(const a of Hs.slice(1))e[a]&&(n+=e[a]*t[a].milliseconds);return n}function Ya(t,e){const n=dr(t,e)<0?-1:1;it.reduceRight((a,i)=>{if(O(e[i]))return a;if(a){const r=e[a]*n,o=t[i][a],l=Math.floor(r/o);e[i]+=l*n,e[a]-=l*o*n}return i},null),it.reduce((a,i)=>{if(O(e[i]))return a;if(a){const r=e[a]%1;e[a]-=r,e[i]+=r*t[a][i]}return i},null)}function zs(t){const e={};for(const[n,a]of Object.entries(t))a!==0&&(e[n]=a);return e}class W{constructor(e){const n=e.conversionAccuracy==="longterm"||!1;let a=n?Ws:Us;e.matrix&&(a=e.matrix),this.values=e.values,this.loc=e.loc||z.create(),this.conversionAccuracy=n?"longterm":"casual",this.invalid=e.invalid||null,this.matrix=a,this.isLuxonDuration=!0}static fromMillis(e,n){return W.fromObject({milliseconds:e},n)}static fromObject(e,n={}){if(e==null||typeof e!="object")throw new ee(`Duration.fromObject: argument expected to be an object, got ${e===null?"null":typeof e}`);return new W({values:gn(e,W.normalizeUnit),loc:z.fromObject(n),conversionAccuracy:n.conversionAccuracy,matrix:n.matrix})}static fromDurationLike(e){if(Ve(e))return W.fromMillis(e);if(W.isDuration(e))return e;if(typeof e=="object")return W.fromObject(e);throw new ee(`Unknown duration argument ${e} of type ${typeof e}`)}static fromISO(e,n){const[a]=Fs(e);return a?W.fromObject(a,n):W.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static fromISOTime(e,n){const[a]=Ps(e);return a?W.fromObject(a,n):W.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static invalid(e,n=null){if(!e)throw new ee("need to specify a reason the Duration is invalid");const a=e instanceof Me?e:new Me(e,n);if(J.throwOnInvalid)throw new mo(a);return new W({invalid:a})}static normalizeUnit(e){const n={year:"years",years:"years",quarter:"quarters",quarters:"quarters",month:"months",months:"months",week:"weeks",weeks:"weeks",day:"days",days:"days",hour:"hours",hours:"hours",minute:"minutes",minutes:"minutes",second:"seconds",seconds:"seconds",millisecond:"milliseconds",milliseconds:"milliseconds"}[e&&e.toLowerCase()];if(!n)throw new vi(e);return n}static isDuration(e){return e&&e.isLuxonDuration||!1}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}toFormat(e,n={}){const a={...n,floor:n.round!==!1&&n.floor!==!1};return this.isValid?ne.create(this.loc,a).formatDurationFromString(this,e):Ka}toHuman(e={}){if(!this.isValid)return Ka;const n=it.map(a=>{const i=this.values[a];return O(i)?null:this.loc.numberFormatter({style:"unit",unitDisplay:"long",...e,unit:a.slice(0,-1)}).format(i)}).filter(a=>a);return this.loc.listFormatter({type:"conjunction",style:e.listStyle||"narrow",...e}).format(n)}toObject(){return this.isValid?{...this.values}:{}}toISO(){if(!this.isValid)return null;let e="P";return this.years!==0&&(e+=this.years+"Y"),(this.months!==0||this.quarters!==0)&&(e+=this.months+this.quarters*3+"M"),this.weeks!==0&&(e+=this.weeks+"W"),this.days!==0&&(e+=this.days+"D"),(this.hours!==0||this.minutes!==0||this.seconds!==0||this.milliseconds!==0)&&(e+="T"),this.hours!==0&&(e+=this.hours+"H"),this.minutes!==0&&(e+=this.minutes+"M"),(this.seconds!==0||this.milliseconds!==0)&&(e+=ma(this.seconds+this.milliseconds/1e3,3)+"S"),e==="P"&&(e+="T0S"),e}toISOTime(e={}){if(!this.isValid)return null;const n=this.toMillis();return n<0||n>=864e5?null:(e={suppressMilliseconds:!1,suppressSeconds:!1,includePrefix:!1,format:"extended",...e,includeOffset:!1},I.fromMillis(n,{zone:"UTC"}).toISOTime(e))}toJSON(){return this.toISO()}toString(){return this.toISO()}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`Duration { values: ${JSON.stringify(this.values)} }`:`Duration { Invalid, reason: ${this.invalidReason} }`}toMillis(){return this.isValid?dr(this.matrix,this.values):NaN}valueOf(){return this.toMillis()}plus(e){if(!this.isValid)return this;const n=W.fromDurationLike(e),a={};for(const i of it)(_t(n.values,i)||_t(this.values,i))&&(a[i]=n.get(i)+this.get(i));return We(this,{values:a},!0)}minus(e){if(!this.isValid)return this;const n=W.fromDurationLike(e);return this.plus(n.negate())}mapUnits(e){if(!this.isValid)return this;const n={};for(const a of Object.keys(this.values))n[a]=Ki(e(this.values[a],a));return We(this,{values:n},!0)}get(e){return this[W.normalizeUnit(e)]}set(e){if(!this.isValid)return this;const n={...this.values,...gn(e,W.normalizeUnit)};return We(this,{values:n})}reconfigure({locale:e,numberingSystem:n,conversionAccuracy:a,matrix:i}={}){const o={loc:this.loc.clone({locale:e,numberingSystem:n}),matrix:i,conversionAccuracy:a};return We(this,o)}as(e){return this.isValid?this.shiftTo(e).get(e):NaN}normalize(){if(!this.isValid)return this;const e=this.toObject();return Ya(this.matrix,e),We(this,{values:e},!0)}rescale(){if(!this.isValid)return this;const e=zs(this.normalize().shiftToAll().toObject());return We(this,{values:e},!0)}shiftTo(...e){if(!this.isValid)return this;if(e.length===0)return this;e=e.map(o=>W.normalizeUnit(o));const n={},a={},i=this.toObject();let r;for(const o of it)if(e.indexOf(o)>=0){r=o;let l=0;for(const u in a)l+=this.matrix[u][o]*a[u],a[u]=0;Ve(i[o])&&(l+=i[o]);const c=Math.trunc(l);n[o]=c,a[o]=(l*1e3-c*1e3)/1e3}else Ve(i[o])&&(a[o]=i[o]);for(const o in a)a[o]!==0&&(n[r]+=o===r?a[o]:a[o]/this.matrix[r][o]);return Ya(this.matrix,n),We(this,{values:n},!0)}shiftToAll(){return this.isValid?this.shiftTo("years","months","weeks","days","hours","minutes","seconds","milliseconds"):this}negate(){if(!this.isValid)return this;const e={};for(const n of Object.keys(this.values))e[n]=this.values[n]===0?0:-this.values[n];return We(this,{values:e},!0)}get years(){return this.isValid?this.values.years||0:NaN}get quarters(){return this.isValid?this.values.quarters||0:NaN}get months(){return this.isValid?this.values.months||0:NaN}get weeks(){return this.isValid?this.values.weeks||0:NaN}get days(){return this.isValid?this.values.days||0:NaN}get hours(){return this.isValid?this.values.hours||0:NaN}get minutes(){return this.isValid?this.values.minutes||0:NaN}get seconds(){return this.isValid?this.values.seconds||0:NaN}get milliseconds(){return this.isValid?this.values.milliseconds||0:NaN}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}equals(e){if(!this.isValid||!e.isValid||!this.loc.equals(e.loc))return!1;function n(a,i){return a===void 0||a===0?i===void 0||i===0:a===i}for(const a of it)if(!n(this.values[a],e.values[a]))return!1;return!0}}const mt="Invalid Interval";function Bs(t,e){return!t||!t.isValid?Z.invalid("missing or invalid start"):!e||!e.isValid?Z.invalid("missing or invalid end"):e<t?Z.invalid("end before start",`The end of an interval must be after its start, but you had start=${t.toISO()} and end=${e.toISO()}`):null}class Z{constructor(e){this.s=e.start,this.e=e.end,this.invalid=e.invalid||null,this.isLuxonInterval=!0}static invalid(e,n=null){if(!e)throw new ee("need to specify a reason the Interval is invalid");const a=e instanceof Me?e:new Me(e,n);if(J.throwOnInvalid)throw new ho(a);return new Z({invalid:a})}static fromDateTimes(e,n){const a=Ft(e),i=Ft(n),r=Bs(a,i);return r??new Z({start:a,end:i})}static after(e,n){const a=W.fromDurationLike(n),i=Ft(e);return Z.fromDateTimes(i,i.plus(a))}static before(e,n){const a=W.fromDurationLike(n),i=Ft(e);return Z.fromDateTimes(i.minus(a),i)}static fromISO(e,n){const[a,i]=(e||"").split("/",2);if(a&&i){let r,o;try{r=I.fromISO(a,n),o=r.isValid}catch{o=!1}let l,c;try{l=I.fromISO(i,n),c=l.isValid}catch{c=!1}if(o&&c)return Z.fromDateTimes(r,l);if(o){const u=W.fromISO(i,n);if(u.isValid)return Z.after(r,u)}else if(c){const u=W.fromISO(a,n);if(u.isValid)return Z.before(l,u)}}return Z.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static isInterval(e){return e&&e.isLuxonInterval||!1}get start(){return this.isValid?this.s:null}get end(){return this.isValid?this.e:null}get lastDateTime(){return this.isValid&&this.e?this.e.minus(1):null}get isValid(){return this.invalidReason===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}length(e="milliseconds"){return this.isValid?this.toDuration(e).get(e):NaN}count(e="milliseconds",n){if(!this.isValid)return NaN;const a=this.start.startOf(e,n);let i;return n!=null&&n.useLocaleWeeks?i=this.end.reconfigure({locale:a.locale}):i=this.end,i=i.startOf(e,n),Math.floor(i.diff(a,e).get(e))+(i.valueOf()!==this.end.valueOf())}hasSame(e){return this.isValid?this.isEmpty()||this.e.minus(1).hasSame(this.s,e):!1}isEmpty(){return this.s.valueOf()===this.e.valueOf()}isAfter(e){return this.isValid?this.s>e:!1}isBefore(e){return this.isValid?this.e<=e:!1}contains(e){return this.isValid?this.s<=e&&this.e>e:!1}set({start:e,end:n}={}){return this.isValid?Z.fromDateTimes(e||this.s,n||this.e):this}splitAt(...e){if(!this.isValid)return[];const n=e.map(Ft).filter(o=>this.contains(o)).sort((o,l)=>o.toMillis()-l.toMillis()),a=[];let{s:i}=this,r=0;for(;i<this.e;){const o=n[r]||this.e,l=+o>+this.e?this.e:o;a.push(Z.fromDateTimes(i,l)),i=l,r+=1}return a}splitBy(e){const n=W.fromDurationLike(e);if(!this.isValid||!n.isValid||n.as("milliseconds")===0)return[];let{s:a}=this,i=1,r;const o=[];for(;a<this.e;){const l=this.start.plus(n.mapUnits(c=>c*i));r=+l>+this.e?this.e:l,o.push(Z.fromDateTimes(a,r)),a=r,i+=1}return o}divideEqually(e){return this.isValid?this.splitBy(this.length()/e).slice(0,e):[]}overlaps(e){return this.e>e.s&&this.s<e.e}abutsStart(e){return this.isValid?+this.e==+e.s:!1}abutsEnd(e){return this.isValid?+e.e==+this.s:!1}engulfs(e){return this.isValid?this.s<=e.s&&this.e>=e.e:!1}equals(e){return!this.isValid||!e.isValid?!1:this.s.equals(e.s)&&this.e.equals(e.e)}intersection(e){if(!this.isValid)return this;const n=this.s>e.s?this.s:e.s,a=this.e<e.e?this.e:e.e;return n>=a?null:Z.fromDateTimes(n,a)}union(e){if(!this.isValid)return this;const n=this.s<e.s?this.s:e.s,a=this.e>e.e?this.e:e.e;return Z.fromDateTimes(n,a)}static merge(e){const[n,a]=e.sort((i,r)=>i.s-r.s).reduce(([i,r],o)=>r?r.overlaps(o)||r.abutsStart(o)?[i,r.union(o)]:[i.concat([r]),o]:[i,o],[[],null]);return a&&n.push(a),n}static xor(e){let n=null,a=0;const i=[],r=e.map(c=>[{time:c.s,type:"s"},{time:c.e,type:"e"}]),o=Array.prototype.concat(...r),l=o.sort((c,u)=>c.time-u.time);for(const c of l)a+=c.type==="s"?1:-1,a===1?n=c.time:(n&&+n!=+c.time&&i.push(Z.fromDateTimes(n,c.time)),n=null);return Z.merge(i)}difference(...e){return Z.xor([this].concat(e)).map(n=>this.intersection(n)).filter(n=>n&&!n.isEmpty())}toString(){return this.isValid?`[${this.s.toISO()} – ${this.e.toISO()})`:mt}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`Interval { start: ${this.s.toISO()}, end: ${this.e.toISO()} }`:`Interval { Invalid, reason: ${this.invalidReason} }`}toLocaleString(e=hn,n={}){return this.isValid?ne.create(this.s.loc.clone(n),e).formatInterval(this):mt}toISO(e){return this.isValid?`${this.s.toISO(e)}/${this.e.toISO(e)}`:mt}toISODate(){return this.isValid?`${this.s.toISODate()}/${this.e.toISODate()}`:mt}toISOTime(e){return this.isValid?`${this.s.toISOTime(e)}/${this.e.toISOTime(e)}`:mt}toFormat(e,{separator:n=" – "}={}){return this.isValid?`${this.s.toFormat(e)}${n}${this.e.toFormat(e)}`:mt}toDuration(e,n){return this.isValid?this.e.diff(this.s,e,n):W.invalid(this.invalidReason)}mapEndpoints(e){return Z.fromDateTimes(e(this.s),e(this.e))}}class Qt{static hasDST(e=J.defaultZone){const n=I.now().setZone(e).set({month:12});return!e.isUniversal&&n.offset!==n.set({month:6}).offset}static isValidIANAZone(e){return Fe.isValidZone(e)}static normalizeZone(e){return Be(e,J.defaultZone)}static getStartOfWeek({locale:e=null,locObj:n=null}={}){return(n||z.create(e)).getStartOfWeek()}static getMinimumDaysInFirstWeek({locale:e=null,locObj:n=null}={}){return(n||z.create(e)).getMinDaysInFirstWeek()}static getWeekendWeekdays({locale:e=null,locObj:n=null}={}){return(n||z.create(e)).getWeekendDays().slice()}static months(e="long",{locale:n=null,numberingSystem:a=null,locObj:i=null,outputCalendar:r="gregory"}={}){return(i||z.create(n,a,r)).months(e)}static monthsFormat(e="long",{locale:n=null,numberingSystem:a=null,locObj:i=null,outputCalendar:r="gregory"}={}){return(i||z.create(n,a,r)).months(e,!0)}static weekdays(e="long",{locale:n=null,numberingSystem:a=null,locObj:i=null}={}){return(i||z.create(n,a,null)).weekdays(e)}static weekdaysFormat(e="long",{locale:n=null,numberingSystem:a=null,locObj:i=null}={}){return(i||z.create(n,a,null)).weekdays(e,!0)}static meridiems({locale:e=null}={}){return z.create(e).meridiems()}static eras(e="short",{locale:n=null}={}){return z.create(n,null,"gregory").eras(e)}static features(){return{relative:Ji(),localeWeek:ji()}}}function Qa(t,e){const n=i=>i.toUTC(0,{keepLocalTime:!0}).startOf("day").valueOf(),a=n(e)-n(t);return Math.floor(W.fromMillis(a).as("days"))}function Gs(t,e,n){const a=[["years",(c,u)=>u.year-c.year],["quarters",(c,u)=>u.quarter-c.quarter+(u.year-c.year)*4],["months",(c,u)=>u.month-c.month+(u.year-c.year)*12],["weeks",(c,u)=>{const d=Qa(c,u);return(d-d%7)/7}],["days",Qa]],i={},r=t;let o,l;for(const[c,u]of a)n.indexOf(c)>=0&&(o=c,i[c]=u(t,e),l=r.plus(i),l>e?(i[c]--,t=r.plus(i),t>e&&(l=t,i[c]--,t=r.plus(i))):t=l);return[t,i,l,o]}function Vs(t,e,n,a){let[i,r,o,l]=Gs(t,e,n);const c=e-i,u=n.filter(h=>["hours","minutes","seconds","milliseconds"].indexOf(h)>=0);u.length===0&&(o<e&&(o=i.plus({[l]:1})),o!==i&&(r[l]=(r[l]||0)+c/(o-i)));const d=W.fromObject(r,a);return u.length>0?W.fromMillis(c,a).shiftTo(...u).plus(d):d}const Zs="missing Intl.DateTimeFormat.formatToParts support";function H(t,e=n=>n){return{regex:t,deser:([n])=>e(xo(n))}}const Js=" ",hr=`[ ${Js}]`,mr=new RegExp(hr,"g");function js(t){return t.replace(/\./g,"\\.?").replace(mr,hr)}function Xa(t){return t.replace(/\./g,"").replace(mr," ").toLowerCase()}function ve(t,e){return t===null?null:{regex:RegExp(t.map(js).join("|")),deser:([n])=>t.findIndex(a=>Xa(n)===Xa(a))+e}}function ei(t,e){return{regex:t,deser:([,n,a])=>Mn(n,a),groups:e}}function Xt(t){return{regex:t,deser:([e])=>e}}function qs(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function Ks(t,e){const n=we(e),a=we(e,"{2}"),i=we(e,"{3}"),r=we(e,"{4}"),o=we(e,"{6}"),l=we(e,"{1,2}"),c=we(e,"{1,3}"),u=we(e,"{1,6}"),d=we(e,"{1,9}"),h=we(e,"{2,4}"),g=we(e,"{4,6}"),f=y=>({regex:RegExp(qs(y.val)),deser:([S])=>S,literal:!0}),v=(y=>{if(t.literal)return f(y);switch(y.val){case"G":return ve(e.eras("short"),0);case"GG":return ve(e.eras("long"),0);case"y":return H(u);case"yy":return H(h,ea);case"yyyy":return H(r);case"yyyyy":return H(g);case"yyyyyy":return H(o);case"M":return H(l);case"MM":return H(a);case"MMM":return ve(e.months("short",!0),1);case"MMMM":return ve(e.months("long",!0),1);case"L":return H(l);case"LL":return H(a);case"LLL":return ve(e.months("short",!1),1);case"LLLL":return ve(e.months("long",!1),1);case"d":return H(l);case"dd":return H(a);case"o":return H(c);case"ooo":return H(i);case"HH":return H(a);case"H":return H(l);case"hh":return H(a);case"h":return H(l);case"mm":return H(a);case"m":return H(l);case"q":return H(l);case"qq":return H(a);case"s":return H(l);case"ss":return H(a);case"S":return H(c);case"SSS":return H(i);case"u":return Xt(d);case"uu":return Xt(l);case"uuu":return H(n);case"a":return ve(e.meridiems(),0);case"kkkk":return H(r);case"kk":return H(h,ea);case"W":return H(l);case"WW":return H(a);case"E":case"c":return H(n);case"EEE":return ve(e.weekdays("short",!1),1);case"EEEE":return ve(e.weekdays("long",!1),1);case"ccc":return ve(e.weekdays("short",!0),1);case"cccc":return ve(e.weekdays("long",!0),1);case"Z":case"ZZ":return ei(new RegExp(`([+-]${l.source})(?::(${a.source}))?`),2);case"ZZZ":return ei(new RegExp(`([+-]${l.source})(${a.source})?`),2);case"z":return Xt(/[a-z_+-/]{1,256}?/i);case" ":return Xt(/[^\S\n\r]/);default:return f(y)}})(t)||{invalidReason:Zs};return v.token=t,v}const Ys={year:{"2-digit":"yy",numeric:"yyyyy"},month:{numeric:"M","2-digit":"MM",short:"MMM",long:"MMMM"},day:{numeric:"d","2-digit":"dd"},weekday:{short:"EEE",long:"EEEE"},dayperiod:"a",dayPeriod:"a",hour12:{numeric:"h","2-digit":"hh"},hour24:{numeric:"H","2-digit":"HH"},minute:{numeric:"m","2-digit":"mm"},second:{numeric:"s","2-digit":"ss"},timeZoneName:{long:"ZZZZZ",short:"ZZZ"}};function Qs(t,e,n){const{type:a,value:i}=t;if(a==="literal"){const c=/^\s+$/.test(i);return{literal:!c,val:c?" ":i}}const r=e[a];let o=a;a==="hour"&&(e.hour12!=null?o=e.hour12?"hour12":"hour24":e.hourCycle!=null?e.hourCycle==="h11"||e.hourCycle==="h12"?o="hour12":o="hour24":o=n.hour12?"hour12":"hour24");let l=Ys[o];if(typeof l=="object"&&(l=l[r]),l)return{literal:!1,val:l}}function Xs(t){return[`^${t.map(n=>n.regex).reduce((n,a)=>`${n}(${a.source})`,"")}$`,t]}function el(t,e,n){const a=t.match(e);if(a){const i={};let r=1;for(const o in n)if(_t(n,o)){const l=n[o],c=l.groups?l.groups+1:1;!l.literal&&l.token&&(i[l.token.val[0]]=l.deser(a.slice(r,r+c))),r+=c}return[a,i]}else return[a,{}]}function tl(t){const e=r=>{switch(r){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":case"H":return"hour";case"d":return"day";case"o":return"ordinal";case"L":case"M":return"month";case"y":return"year";case"E":case"c":return"weekday";case"W":return"weekNumber";case"k":return"weekYear";case"q":return"quarter";default:return null}};let n=null,a;return O(t.z)||(n=Fe.create(t.z)),O(t.Z)||(n||(n=new re(t.Z)),a=t.Z),O(t.q)||(t.M=(t.q-1)*3+1),O(t.h)||(t.h<12&&t.a===1?t.h+=12:t.h===12&&t.a===0&&(t.h=0)),t.G===0&&t.y&&(t.y=-t.y),O(t.u)||(t.S=ha(t.u)),[Object.keys(t).reduce((r,o)=>{const l=e(o);return l&&(r[l]=t[o]),r},{}),n,a]}let Dn=null;function nl(){return Dn||(Dn=I.fromMillis(1555555555555)),Dn}function al(t,e){if(t.literal)return t;const n=ne.macroTokenToFormatOpts(t.val),a=yr(n,e);return a==null||a.includes(void 0)?t:a}function fr(t,e){return Array.prototype.concat(...t.map(n=>al(n,e)))}class gr{constructor(e,n){if(this.locale=e,this.format=n,this.tokens=fr(ne.parseFormat(n),e),this.units=this.tokens.map(a=>Ks(a,e)),this.disqualifyingUnit=this.units.find(a=>a.invalidReason),!this.disqualifyingUnit){const[a,i]=Xs(this.units);this.regex=RegExp(a,"i"),this.handlers=i}}explainFromTokens(e){if(this.isValid){const[n,a]=el(e,this.regex,this.handlers),[i,r,o]=a?tl(a):[null,null,void 0];if(_t(a,"a")&&_t(a,"H"))throw new yt("Can't include meridiem when specifying 24-hour format");return{input:e,tokens:this.tokens,regex:this.regex,rawMatches:n,matches:a,result:i,zone:r,specificOffset:o}}else return{input:e,tokens:this.tokens,invalidReason:this.invalidReason}}get isValid(){return!this.disqualifyingUnit}get invalidReason(){return this.disqualifyingUnit?this.disqualifyingUnit.invalidReason:null}}function pr(t,e,n){return new gr(t,n).explainFromTokens(e)}function il(t,e,n){const{result:a,zone:i,specificOffset:r,invalidReason:o}=pr(t,e,n);return[a,i,r,o]}function yr(t,e){if(!t)return null;const a=ne.create(e,t).dtFormatter(nl()),i=a.formatToParts(),r=a.resolvedOptions();return i.map(o=>Qs(o,t,r))}const Pn="Invalid DateTime",ti=864e13;function Pt(t){return new Me("unsupported zone",`the zone "${t.name}" is not supported`)}function xn(t){return t.weekData===null&&(t.weekData=mn(t.c)),t.weekData}function On(t){return t.localWeekData===null&&(t.localWeekData=mn(t.c,t.loc.getMinDaysInFirstWeek(),t.loc.getStartOfWeek())),t.localWeekData}function Xe(t,e){const n={ts:t.ts,zone:t.zone,c:t.c,o:t.o,loc:t.loc,invalid:t.invalid};return new I({...n,...e,old:n})}function wr(t,e,n){let a=t-e*60*1e3;const i=n.offset(a);if(e===i)return[a,e];a-=(i-e)*60*1e3;const r=n.offset(a);return i===r?[a,i]:[t-Math.min(i,r)*60*1e3,Math.max(i,r)]}function en(t,e){t+=e*60*1e3;const n=new Date(t);return{year:n.getUTCFullYear(),month:n.getUTCMonth()+1,day:n.getUTCDate(),hour:n.getUTCHours(),minute:n.getUTCMinutes(),second:n.getUTCSeconds(),millisecond:n.getUTCMilliseconds()}}function ln(t,e,n){return wr(Ln(t),e,n)}function ni(t,e){const n=t.o,a=t.c.year+Math.trunc(e.years),i=t.c.month+Math.trunc(e.months)+Math.trunc(e.quarters)*3,r={...t.c,year:a,month:i,day:Math.min(t.c.day,fn(a,i))+Math.trunc(e.days)+Math.trunc(e.weeks)*7},o=W.fromObject({years:e.years-Math.trunc(e.years),quarters:e.quarters-Math.trunc(e.quarters),months:e.months-Math.trunc(e.months),weeks:e.weeks-Math.trunc(e.weeks),days:e.days-Math.trunc(e.days),hours:e.hours,minutes:e.minutes,seconds:e.seconds,milliseconds:e.milliseconds}).as("milliseconds"),l=Ln(r);let[c,u]=wr(l,n,t.zone);return o!==0&&(c+=o,u=t.zone.offset(c)),{ts:c,o:u}}function ft(t,e,n,a,i,r){const{setZone:o,zone:l}=n;if(t&&Object.keys(t).length!==0||e){const c=e||l,u=I.fromObject(t,{...n,zone:c,specificOffset:r});return o?u:u.setZone(l)}else return I.invalid(new Me("unparsable",`the input "${i}" can't be parsed as ${a}`))}function tn(t,e,n=!0){return t.isValid?ne.create(z.create("en-US"),{allowZ:n,forceSimple:!0}).formatDateTimeFromString(t,e):null}function $n(t,e){const n=t.c.year>9999||t.c.year<0;let a="";return n&&t.c.year>=0&&(a+="+"),a+=j(t.c.year,n?6:4),e?(a+="-",a+=j(t.c.month),a+="-",a+=j(t.c.day)):(a+=j(t.c.month),a+=j(t.c.day)),a}function ai(t,e,n,a,i,r){let o=j(t.c.hour);return e?(o+=":",o+=j(t.c.minute),(t.c.millisecond!==0||t.c.second!==0||!n)&&(o+=":")):o+=j(t.c.minute),(t.c.millisecond!==0||t.c.second!==0||!n)&&(o+=j(t.c.second),(t.c.millisecond!==0||!a)&&(o+=".",o+=j(t.c.millisecond,3))),i&&(t.isOffsetFixed&&t.offset===0&&!r?o+="Z":t.o<0?(o+="-",o+=j(Math.trunc(-t.o/60)),o+=":",o+=j(Math.trunc(-t.o%60))):(o+="+",o+=j(Math.trunc(t.o/60)),o+=":",o+=j(Math.trunc(t.o%60)))),r&&(o+="["+t.zone.ianaName+"]"),o}const vr={month:1,day:1,hour:0,minute:0,second:0,millisecond:0},rl={weekNumber:1,weekday:1,hour:0,minute:0,second:0,millisecond:0},ol={ordinal:1,hour:0,minute:0,second:0,millisecond:0},Lr=["year","month","day","hour","minute","second","millisecond"],sl=["weekYear","weekNumber","weekday","hour","minute","second","millisecond"],ll=["year","ordinal","hour","minute","second","millisecond"];function cl(t){const e={year:"year",years:"year",month:"month",months:"month",day:"day",days:"day",hour:"hour",hours:"hour",minute:"minute",minutes:"minute",quarter:"quarter",quarters:"quarter",second:"second",seconds:"second",millisecond:"millisecond",milliseconds:"millisecond",weekday:"weekday",weekdays:"weekday",weeknumber:"weekNumber",weeksnumber:"weekNumber",weeknumbers:"weekNumber",weekyear:"weekYear",weekyears:"weekYear",ordinal:"ordinal"}[t.toLowerCase()];if(!e)throw new vi(t);return e}function ii(t){switch(t.toLowerCase()){case"localweekday":case"localweekdays":return"localWeekday";case"localweeknumber":case"localweeknumbers":return"localWeekNumber";case"localweekyear":case"localweekyears":return"localWeekYear";default:return cl(t)}}function ul(t){if(xt===void 0&&(xt=J.now()),t.type!=="iana")return t.offset(xt);const e=t.name;let n=ta.get(e);return n===void 0&&(n=t.offset(xt),ta.set(e,n)),n}function ri(t,e){const n=Be(e.zone,J.defaultZone);if(!n.isValid)return I.invalid(Pt(n));const a=z.fromObject(e);let i,r;if(O(t.year))i=J.now();else{for(const c of Lr)O(t[c])&&(t[c]=vr[c]);const o=Vi(t)||Zi(t);if(o)return I.invalid(o);const l=ul(n);[i,r]=ln(t,l,n)}return new I({ts:i,zone:n,loc:a,o:r})}function oi(t,e,n){const a=O(n.round)?!0:n.round,i=(o,l)=>(o=ma(o,a||n.calendary?0:2,!0),e.loc.clone(n).relFormatter(n).format(o,l)),r=o=>n.calendary?e.hasSame(t,o)?0:e.startOf(o).diff(t.startOf(o),o).get(o):e.diff(t,o).get(o);if(n.unit)return i(r(n.unit),n.unit);for(const o of n.units){const l=r(o);if(Math.abs(l)>=1)return i(l,o)}return i(t>e?-0:0,n.units[n.units.length-1])}function si(t){let e={},n;return t.length>0&&typeof t[t.length-1]=="object"?(e=t[t.length-1],n=Array.from(t).slice(0,t.length-1)):n=Array.from(t),[e,n]}let xt;const ta=new Map;class I{constructor(e){const n=e.zone||J.defaultZone;let a=e.invalid||(Number.isNaN(e.ts)?new Me("invalid input"):null)||(n.isValid?null:Pt(n));this.ts=O(e.ts)?J.now():e.ts;let i=null,r=null;if(!a)if(e.old&&e.old.ts===this.ts&&e.old.zone.equals(n))[i,r]=[e.old.c,e.old.o];else{const l=Ve(e.o)&&!e.old?e.o:n.offset(this.ts);i=en(this.ts,l),a=Number.isNaN(i.year)?new Me("invalid input"):null,i=a?null:i,r=a?null:l}this._zone=n,this.loc=e.loc||z.create(),this.invalid=a,this.weekData=null,this.localWeekData=null,this.c=i,this.o=r,this.isLuxonDateTime=!0}static now(){return new I({})}static local(){const[e,n]=si(arguments),[a,i,r,o,l,c,u]=n;return ri({year:a,month:i,day:r,hour:o,minute:l,second:c,millisecond:u},e)}static utc(){const[e,n]=si(arguments),[a,i,r,o,l,c,u]=n;return e.zone=re.utcInstance,ri({year:a,month:i,day:r,hour:o,minute:l,second:c,millisecond:u},e)}static fromJSDate(e,n={}){const a=Wo(e)?e.valueOf():NaN;if(Number.isNaN(a))return I.invalid("invalid input");const i=Be(n.zone,J.defaultZone);return i.isValid?new I({ts:a,zone:i,loc:z.fromObject(n)}):I.invalid(Pt(i))}static fromMillis(e,n={}){if(Ve(e))return e<-ti||e>ti?I.invalid("Timestamp out of range"):new I({ts:e,zone:Be(n.zone,J.defaultZone),loc:z.fromObject(n)});throw new ee(`fromMillis requires a numerical input, but received a ${typeof e} with value ${e}`)}static fromSeconds(e,n={}){if(Ve(e))return new I({ts:e*1e3,zone:Be(n.zone,J.defaultZone),loc:z.fromObject(n)});throw new ee("fromSeconds requires a numerical input")}static fromObject(e,n={}){e=e||{};const a=Be(n.zone,J.defaultZone);if(!a.isValid)return I.invalid(Pt(a));const i=z.fromObject(n),r=gn(e,ii),{minDaysInFirstWeek:o,startOfWeek:l}=Va(r,i),c=J.now(),u=O(n.specificOffset)?a.offset(c):n.specificOffset,d=!O(r.ordinal),h=!O(r.year),g=!O(r.month)||!O(r.day),f=h||g,w=r.weekYear||r.weekNumber;if((f||d)&&w)throw new yt("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(g&&d)throw new yt("Can't mix ordinal dates with month/day");const v=w||r.weekday&&!f;let y,S,_=en(c,u);v?(y=sl,S=rl,_=mn(_,o,l)):d?(y=ll,S=ol,_=Fn(_)):(y=Lr,S=vr);let E=!1;for(const D of y){const N=r[D];O(N)?E?r[D]=S[D]:r[D]=_[D]:E=!0}const M=v?$o(r,o,l):d?Ro(r):Vi(r),b=M||Zi(r);if(b)return I.invalid(b);const k=v?Ba(r,o,l):d?Ga(r):r,[A,T]=ln(k,u,a),F=new I({ts:A,zone:a,o:T,loc:i});return r.weekday&&f&&e.weekday!==F.weekday?I.invalid("mismatched weekday",`you can't specify both a weekday of ${r.weekday} and a date of ${F.toISO()}`):F.isValid?F:I.invalid(F.invalid)}static fromISO(e,n={}){const[a,i]=Cs(e);return ft(a,i,n,"ISO 8601",e)}static fromRFC2822(e,n={}){const[a,i]=Is(e);return ft(a,i,n,"RFC 2822",e)}static fromHTTP(e,n={}){const[a,i]=Ns(e);return ft(a,i,n,"HTTP",n)}static fromFormat(e,n,a={}){if(O(e)||O(n))throw new ee("fromFormat requires an input string and a format");const{locale:i=null,numberingSystem:r=null}=a,o=z.fromOpts({locale:i,numberingSystem:r,defaultToEN:!0}),[l,c,u,d]=il(o,e,n);return d?I.invalid(d):ft(l,c,a,`format ${n}`,e,u)}static fromString(e,n,a={}){return I.fromFormat(e,n,a)}static fromSQL(e,n={}){const[a,i]=Rs(e);return ft(a,i,n,"SQL",e)}static invalid(e,n=null){if(!e)throw new ee("need to specify a reason the DateTime is invalid");const a=e instanceof Me?e:new Me(e,n);if(J.throwOnInvalid)throw new uo(a);return new I({invalid:a})}static isDateTime(e){return e&&e.isLuxonDateTime||!1}static parseFormatForOpts(e,n={}){const a=yr(e,z.fromObject(n));return a?a.map(i=>i?i.val:null).join(""):null}static expandFormat(e,n={}){return fr(ne.parseFormat(e),z.fromObject(n)).map(i=>i.val).join("")}static resetCache(){xt=void 0,ta.clear()}get(e){return this[e]}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}get outputCalendar(){return this.isValid?this.loc.outputCalendar:null}get zone(){return this._zone}get zoneName(){return this.isValid?this.zone.name:null}get year(){return this.isValid?this.c.year:NaN}get quarter(){return this.isValid?Math.ceil(this.c.month/3):NaN}get month(){return this.isValid?this.c.month:NaN}get day(){return this.isValid?this.c.day:NaN}get hour(){return this.isValid?this.c.hour:NaN}get minute(){return this.isValid?this.c.minute:NaN}get second(){return this.isValid?this.c.second:NaN}get millisecond(){return this.isValid?this.c.millisecond:NaN}get weekYear(){return this.isValid?xn(this).weekYear:NaN}get weekNumber(){return this.isValid?xn(this).weekNumber:NaN}get weekday(){return this.isValid?xn(this).weekday:NaN}get isWeekend(){return this.isValid&&this.loc.getWeekendDays().includes(this.weekday)}get localWeekday(){return this.isValid?On(this).weekday:NaN}get localWeekNumber(){return this.isValid?On(this).weekNumber:NaN}get localWeekYear(){return this.isValid?On(this).weekYear:NaN}get ordinal(){return this.isValid?Fn(this.c).ordinal:NaN}get monthShort(){return this.isValid?Qt.months("short",{locObj:this.loc})[this.month-1]:null}get monthLong(){return this.isValid?Qt.months("long",{locObj:this.loc})[this.month-1]:null}get weekdayShort(){return this.isValid?Qt.weekdays("short",{locObj:this.loc})[this.weekday-1]:null}get weekdayLong(){return this.isValid?Qt.weekdays("long",{locObj:this.loc})[this.weekday-1]:null}get offset(){return this.isValid?+this.o:NaN}get offsetNameShort(){return this.isValid?this.zone.offsetName(this.ts,{format:"short",locale:this.locale}):null}get offsetNameLong(){return this.isValid?this.zone.offsetName(this.ts,{format:"long",locale:this.locale}):null}get isOffsetFixed(){return this.isValid?this.zone.isUniversal:null}get isInDST(){return this.isOffsetFixed?!1:this.offset>this.set({month:1,day:1}).offset||this.offset>this.set({month:5}).offset}getPossibleOffsets(){if(!this.isValid||this.isOffsetFixed)return[this];const e=864e5,n=6e4,a=Ln(this.c),i=this.zone.offset(a-e),r=this.zone.offset(a+e),o=this.zone.offset(a-i*n),l=this.zone.offset(a-r*n);if(o===l)return[this];const c=a-o*n,u=a-l*n,d=en(c,o),h=en(u,l);return d.hour===h.hour&&d.minute===h.minute&&d.second===h.second&&d.millisecond===h.millisecond?[Xe(this,{ts:c}),Xe(this,{ts:u})]:[this]}get isInLeapYear(){return Vt(this.year)}get daysInMonth(){return fn(this.year,this.month)}get daysInYear(){return this.isValid?Mt(this.year):NaN}get weeksInWeekYear(){return this.isValid?Wt(this.weekYear):NaN}get weeksInLocalWeekYear(){return this.isValid?Wt(this.localWeekYear,this.loc.getMinDaysInFirstWeek(),this.loc.getStartOfWeek()):NaN}resolvedLocaleOptions(e={}){const{locale:n,numberingSystem:a,calendar:i}=ne.create(this.loc.clone(e),e).resolvedOptions(this);return{locale:n,numberingSystem:a,outputCalendar:i}}toUTC(e=0,n={}){return this.setZone(re.instance(e),n)}toLocal(){return this.setZone(J.defaultZone)}setZone(e,{keepLocalTime:n=!1,keepCalendarTime:a=!1}={}){if(e=Be(e,J.defaultZone),e.equals(this.zone))return this;if(e.isValid){let i=this.ts;if(n||a){const r=e.offset(this.ts),o=this.toObject();[i]=ln(o,r,e)}return Xe(this,{ts:i,zone:e})}else return I.invalid(Pt(e))}reconfigure({locale:e,numberingSystem:n,outputCalendar:a}={}){const i=this.loc.clone({locale:e,numberingSystem:n,outputCalendar:a});return Xe(this,{loc:i})}setLocale(e){return this.reconfigure({locale:e})}set(e){if(!this.isValid)return this;const n=gn(e,ii),{minDaysInFirstWeek:a,startOfWeek:i}=Va(n,this.loc),r=!O(n.weekYear)||!O(n.weekNumber)||!O(n.weekday),o=!O(n.ordinal),l=!O(n.year),c=!O(n.month)||!O(n.day),u=l||c,d=n.weekYear||n.weekNumber;if((u||o)&&d)throw new yt("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(c&&o)throw new yt("Can't mix ordinal dates with month/day");let h;r?h=Ba({...mn(this.c,a,i),...n},a,i):O(n.ordinal)?(h={...this.toObject(),...n},O(n.day)&&(h.day=Math.min(fn(h.year,h.month),h.day))):h=Ga({...Fn(this.c),...n});const[g,f]=ln(h,this.o,this.zone);return Xe(this,{ts:g,o:f})}plus(e){if(!this.isValid)return this;const n=W.fromDurationLike(e);return Xe(this,ni(this,n))}minus(e){if(!this.isValid)return this;const n=W.fromDurationLike(e).negate();return Xe(this,ni(this,n))}startOf(e,{useLocaleWeeks:n=!1}={}){if(!this.isValid)return this;const a={},i=W.normalizeUnit(e);switch(i){case"years":a.month=1;case"quarters":case"months":a.day=1;case"weeks":case"days":a.hour=0;case"hours":a.minute=0;case"minutes":a.second=0;case"seconds":a.millisecond=0;break}if(i==="weeks")if(n){const r=this.loc.getStartOfWeek(),{weekday:o}=this;o<r&&(a.weekNumber=this.weekNumber-1),a.weekday=r}else a.weekday=1;if(i==="quarters"){const r=Math.ceil(this.month/3);a.month=(r-1)*3+1}return this.set(a)}endOf(e,n){return this.isValid?this.plus({[e]:1}).startOf(e,n).minus(1):this}toFormat(e,n={}){return this.isValid?ne.create(this.loc.redefaultToEN(n)).formatDateTimeFromString(this,e):Pn}toLocaleString(e=hn,n={}){return this.isValid?ne.create(this.loc.clone(n),e).formatDateTime(this):Pn}toLocaleParts(e={}){return this.isValid?ne.create(this.loc.clone(e),e).formatDateTimeParts(this):[]}toISO({format:e="extended",suppressSeconds:n=!1,suppressMilliseconds:a=!1,includeOffset:i=!0,extendedZone:r=!1}={}){if(!this.isValid)return null;const o=e==="extended";let l=$n(this,o);return l+="T",l+=ai(this,o,n,a,i,r),l}toISODate({format:e="extended"}={}){return this.isValid?$n(this,e==="extended"):null}toISOWeekDate(){return tn(this,"kkkk-'W'WW-c")}toISOTime({suppressMilliseconds:e=!1,suppressSeconds:n=!1,includeOffset:a=!0,includePrefix:i=!1,extendedZone:r=!1,format:o="extended"}={}){return this.isValid?(i?"T":"")+ai(this,o==="extended",n,e,a,r):null}toRFC2822(){return tn(this,"EEE, dd LLL yyyy HH:mm:ss ZZZ",!1)}toHTTP(){return tn(this.toUTC(),"EEE, dd LLL yyyy HH:mm:ss 'GMT'")}toSQLDate(){return this.isValid?$n(this,!0):null}toSQLTime({includeOffset:e=!0,includeZone:n=!1,includeOffsetSpace:a=!0}={}){let i="HH:mm:ss.SSS";return(n||e)&&(a&&(i+=" "),n?i+="z":e&&(i+="ZZ")),tn(this,i,!0)}toSQL(e={}){return this.isValid?`${this.toSQLDate()} ${this.toSQLTime(e)}`:null}toString(){return this.isValid?this.toISO():Pn}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`DateTime { ts: ${this.toISO()}, zone: ${this.zone.name}, locale: ${this.locale} }`:`DateTime { Invalid, reason: ${this.invalidReason} }`}valueOf(){return this.toMillis()}toMillis(){return this.isValid?this.ts:NaN}toSeconds(){return this.isValid?this.ts/1e3:NaN}toUnixInteger(){return this.isValid?Math.floor(this.ts/1e3):NaN}toJSON(){return this.toISO()}toBSON(){return this.toJSDate()}toObject(e={}){if(!this.isValid)return{};const n={...this.c};return e.includeConfig&&(n.outputCalendar=this.outputCalendar,n.numberingSystem=this.loc.numberingSystem,n.locale=this.loc.locale),n}toJSDate(){return new Date(this.isValid?this.ts:NaN)}diff(e,n="milliseconds",a={}){if(!this.isValid||!e.isValid)return W.invalid("created by diffing an invalid DateTime");const i={locale:this.locale,numberingSystem:this.numberingSystem,...a},r=Ho(n).map(W.normalizeUnit),o=e.valueOf()>this.valueOf(),l=o?this:e,c=o?e:this,u=Vs(l,c,r,i);return o?u.negate():u}diffNow(e="milliseconds",n={}){return this.diff(I.now(),e,n)}until(e){return this.isValid?Z.fromDateTimes(this,e):this}hasSame(e,n,a){if(!this.isValid)return!1;const i=e.valueOf(),r=this.setZone(e.zone,{keepLocalTime:!0});return r.startOf(n,a)<=i&&i<=r.endOf(n,a)}equals(e){return this.isValid&&e.isValid&&this.valueOf()===e.valueOf()&&this.zone.equals(e.zone)&&this.loc.equals(e.loc)}toRelative(e={}){if(!this.isValid)return null;const n=e.base||I.fromObject({},{zone:this.zone}),a=e.padding?this<n?-e.padding:e.padding:0;let i=["years","months","days","hours","minutes","seconds"],r=e.unit;return Array.isArray(e.unit)&&(i=e.unit,r=void 0),oi(n,this.plus(a),{...e,numeric:"always",units:i,unit:r})}toRelativeCalendar(e={}){return this.isValid?oi(e.base||I.fromObject({},{zone:this.zone}),this,{...e,numeric:"auto",units:["years","months","days"],calendary:!0}):null}static min(...e){if(!e.every(I.isDateTime))throw new ee("min requires all arguments be DateTimes");return Za(e,n=>n.valueOf(),Math.min)}static max(...e){if(!e.every(I.isDateTime))throw new ee("max requires all arguments be DateTimes");return Za(e,n=>n.valueOf(),Math.max)}static fromFormatExplain(e,n,a={}){const{locale:i=null,numberingSystem:r=null}=a,o=z.fromOpts({locale:i,numberingSystem:r,defaultToEN:!0});return pr(o,e,n)}static fromStringExplain(e,n,a={}){return I.fromFormatExplain(e,n,a)}static buildFormatParser(e,n={}){const{locale:a=null,numberingSystem:i=null}=n,r=z.fromOpts({locale:a,numberingSystem:i,defaultToEN:!0});return new gr(r,e)}static fromFormatParser(e,n,a={}){if(O(e)||O(n))throw new ee("fromFormatParser requires an input string and a format parser");const{locale:i=null,numberingSystem:r=null}=a,o=z.fromOpts({locale:i,numberingSystem:r,defaultToEN:!0});if(!o.equals(n.locale))throw new ee(`fromFormatParser called with a locale of ${o}, but the format parser was created for ${n.locale}`);const{result:l,zone:c,specificOffset:u,invalidReason:d}=n.explainFromTokens(e);return d?I.invalid(d):ft(l,c,a,`format ${n.format}`,e,u)}static get DATE_SHORT(){return hn}static get DATE_MED(){return Li}static get DATE_MED_WITH_WEEKDAY(){return fo}static get DATE_FULL(){return Mi}static get DATE_HUGE(){return Si}static get TIME_SIMPLE(){return _i}static get TIME_WITH_SECONDS(){return bi}static get TIME_WITH_SHORT_OFFSET(){return Ei}static get TIME_WITH_LONG_OFFSET(){return Ti}static get TIME_24_SIMPLE(){return ki}static get TIME_24_WITH_SECONDS(){return Ai}static get TIME_24_WITH_SHORT_OFFSET(){return Ci}static get TIME_24_WITH_LONG_OFFSET(){return Ii}static get DATETIME_SHORT(){return Ni}static get DATETIME_SHORT_WITH_SECONDS(){return Fi}static get DATETIME_MED(){return Di}static get DATETIME_MED_WITH_SECONDS(){return Pi}static get DATETIME_MED_WITH_WEEKDAY(){return go}static get DATETIME_FULL(){return xi}static get DATETIME_FULL_WITH_SECONDS(){return Oi}static get DATETIME_HUGE(){return $i}static get DATETIME_HUGE_WITH_SECONDS(){return Ri}}function Ft(t){if(I.isDateTime(t))return t;if(t&&t.valueOf&&Ve(t.valueOf()))return I.fromJSDate(t);if(t&&typeof t=="object")return I.fromObject(t);throw new ee(`Unknown datetime argument: ${t}, of type ${typeof t}`)}const wt=65,se=73,de=79;function Mr(t,e){if(e=typeof e=="number"?e:5,!Array.isArray(t))throw new TypeError("forward did not receive an array");if(typeof t[0]=="string"||typeof t[1]=="string")throw new TypeError("forward received an array of strings, but it only accepts an array of numbers.");const[n,a]=t;if(n<-180||n>180)throw new TypeError("forward received an invalid longitude of "+n);if(a<-90||a>90)throw new TypeError("forward received an invalid latitude of "+a);if(a<-80||a>84)throw new TypeError(`forward received a latitude of ${a}, but this library does not support conversions of points in polar regions below 80°S and above 84°N`);return function(i,r){const o="00000"+i.easting,l="00000"+i.northing;return i.zoneNumber+i.zoneLetter+function(c,u,d){const h=_r(d),g=Math.floor(c/1e5),f=Math.floor(u/1e5)%20;return function(w,v,y){const S=y-1,_="AJSAJS".charCodeAt(S),E="AFAFAF".charCodeAt(S);let M=_+w-1,b=E+v,k=!1;return M>90&&(M=M-90+wt-1,k=!0),(M===se||_<se&&M>se||(M>se||_<se)&&k)&&M++,(M===de||_<de&&M>de||(M>de||_<de)&&k)&&(M++,M===se&&M++),M>90&&(M=M-90+wt-1),b>86?(b=b-86+wt-1,k=!0):k=!1,(b===se||E<se&&b>se||(b>se||E<se)&&k)&&b++,(b===de||E<de&&b>de||(b>de||E<de)&&k)&&(b++,b===se&&b++),b>86&&(b=b-86+wt-1),String.fromCharCode(M)+String.fromCharCode(b)}(g,f,h)}(i.easting,i.northing,i.zoneNumber)+o.substr(o.length-5,r)+l.substr(l.length-5,r)}(function(i){const r=i.lat,o=i.lon,l=6378137,c=Rn(r),u=Rn(o);let d;d=Math.floor((o+180)/6)+1,o===180&&(d=60),r>=56&&r<64&&o>=3&&o<12&&(d=32),r>=72&&r<84&&(o>=0&&o<9?d=31:o>=9&&o<21?d=33:o>=21&&o<33?d=35:o>=33&&o<42&&(d=37));const h=Rn(6*(d-1)-180+3),g=l/Math.sqrt(1-.00669438*Math.sin(c)*Math.sin(c)),f=Math.tan(c)*Math.tan(c),w=.006739496752268451*Math.cos(c)*Math.cos(c),v=Math.cos(c)*(u-h),y=l*(.9983242984503243*c-.002514607064228144*Math.sin(2*c)+2639046602129982e-21*Math.sin(4*c)-3418046101696858e-24*Math.sin(6*c)),S=.9996*g*(v+(1-f+w)*v*v*v/6+(5-18*f+f*f+72*w-.39089081163157013)*v*v*v*v*v/120)+5e5;let _=.9996*(y+g*Math.tan(c)*(v*v/2+(5-f+9*w+4*w*w)*v*v*v*v/24+(61-58*f+f*f+600*w-2.2240339282485886)*v*v*v*v*v*v/720));return r<0&&(_+=1e7),{northing:Math.trunc(_),easting:Math.trunc(S),zoneNumber:d,zoneLetter:Sr(r)}}({lat:a,lon:n}),e)}function dl(t){const e=wa(br(t.toUpperCase()));return typeof e.lat=="number"&&typeof e.lon=="number"?[e.lon,e.lat,e.lon,e.lat]:[e.left,e.bottom,e.right,e.top]}function ya(t){if(t==="")throw new TypeError("toPoint received a blank string");const e=wa(br(t.toUpperCase()));return typeof e.lat=="number"&&typeof e.lon=="number"?[e.lon,e.lat]:[(e.left+e.right)/2,(e.top+e.bottom)/2]}function Rn(t){return t*(Math.PI/180)}function li(t){return t/Math.PI*180}function wa(t){const e=t.northing,n=t.easting,{zoneLetter:a,zoneNumber:i}=t;if(i<0||i>60)return null;const r=6378137,o=(1-Math.sqrt(.99330562))/(1+Math.sqrt(.99330562)),l=n-5e5;let c=e;a<"N"&&(c-=1e7);const u=6*(i-1)-180+3,d=c/.9996/6367449145945056e-9,h=d+(3*o/2-27*o*o*o/32)*Math.sin(2*d)+(21*o*o/16-55*o*o*o*o/32)*Math.sin(4*d)+151*o*o*o/96*Math.sin(6*d),g=r/Math.sqrt(1-.00669438*Math.sin(h)*Math.sin(h)),f=Math.tan(h)*Math.tan(h),w=.006739496752268451*Math.cos(h)*Math.cos(h),v=.99330562*r/Math.pow(1-.00669438*Math.sin(h)*Math.sin(h),1.5),y=l/(.9996*g);let S=h-g*Math.tan(h)/v*(y*y/2-(5+3*f+10*w-4*w*w-.06065547077041606)*y*y*y*y/24+(61+90*f+298*w+45*f*f-1.6983531815716497-3*w*w)*y*y*y*y*y*y/720);S=li(S);let _,E=(y-(1+2*f+w)*y*y*y/6+(5-2*w+28*f-3*w*w+.05391597401814761+24*f*f)*y*y*y*y*y/120)/Math.cos(h);if(E=u+li(E),typeof t.accuracy=="number"){const M=wa({northing:t.northing+t.accuracy,easting:t.easting+t.accuracy,zoneLetter:t.zoneLetter,zoneNumber:t.zoneNumber});_={top:M.lat,right:M.lon,bottom:S,left:E}}else _={lat:S,lon:E};return _}function Sr(t){return t<=84&&t>=72?"X":t<72&&t>=-80?"CDEFGHJKLMNPQRSTUVWX"[Math.floor((t- -80)/8)]:t>84||t<-80?"Z":void 0}function _r(t){let e=t%6;return e===0&&(e=6),e}function br(t){if(t&&t.length===0)throw new TypeError("MGRSPoint coverting from nothing");t=t.replace(/ /g,"");const{length:e}=t;let n,a=null,i="",r=0;for(;!/[A-Z]/.test(n=t.charAt(r));){if(r>=2)throw new Error("MGRSPoint bad conversion from: "+t);i+=n,r++}const o=parseInt(i,10);if(r===0||r+3>e)throw new Error("MGRSPoint bad conversion from "+t);const l=t.charAt(r++);if(l<="A"||l==="B"||l==="Y"||l>="Z"||l==="I"||l==="O")throw new Error(`MGRSPoint zone letter ${l} not handled: ${t}`);a=t.substring(r,r+=2);const c=_r(o),u=function(_,E){let M="AJSAJS".charCodeAt(E-1),b=1e5,k=!1;for(;M!==_.charCodeAt(0);){if(M++,M===se&&M++,M===de&&M++,M>90){if(k)throw new Error("Bad character: "+_);M=wt,k=!0}b+=1e5}return b}(a.charAt(0),c);let d=function(_,E){if(_>"V")throw new TypeError("MGRSPoint given invalid Northing "+_);let M="AFAFAF".charCodeAt(E-1),b=0,k=!1;for(;M!==_.charCodeAt(0);){if(M++,M===se&&M++,M===de&&M++,M>86){if(k)throw new Error("Bad character: "+_);M=wt,k=!0}b+=1e5}return b}(a.charAt(1),c);for(;d<hl(l);)d+=2e6;const h=e-r;if(h%2!=0)throw new Error(`MGRSPoint has to have an even number
of digits after the zone letter and two 100km letters - front
half for easting meters, second half for
northing meters `+t);const g=h/2;let f,w,v,y=0,S=0;return g>0&&(f=1e5/Math.pow(10,g),w=t.substring(r,r+g),y=parseFloat(w)*f,v=t.substring(r+g),S=parseFloat(v)*f),{easting:y+u,northing:S+d,zoneLetter:l,zoneNumber:o,accuracy:f}}function hl(t){let e;switch(t){case"C":e=11e5;break;case"D":e=2e6;break;case"E":e=28e5;break;case"F":e=37e5;break;case"G":e=46e5;break;case"H":e=55e5;break;case"J":e=64e5;break;case"K":e=73e5;break;case"L":e=82e5;break;case"M":e=91e5;break;case"N":e=0;break;case"P":e=8e5;break;case"Q":e=17e5;break;case"R":e=26e5;break;case"S":e=35e5;break;case"T":e=44e5;break;case"U":e=53e5;break;case"V":e=62e5;break;case"W":e=7e6;break;case"X":e=79e5;break;default:e=-1}if(e>=0)return e;throw new TypeError("Invalid zone letter: "+t)}const ml=Object.freeze(Object.defineProperty({__proto__:null,forward:Mr,getLetterDesignator:Sr,inverse:dl,toPoint:ya},Symbol.toStringTag,{value:"Module"})),fl="/upper_winds_open_meteo/icon-48.png",gl="/upper_winds_open_meteo/schere_purple.png",pl="/upper_winds_open_meteo/airplane_orange.png",yl="skydiver2025",ci={135:5,130:5,125:5,120:5,115:5,110:5,105:5,100:6,95:7,90:7,85:7,80:8,75:8,70:9,65:10,60:10,55:11,50:12,45:14,40:15,35:17,30:20,25:24,20:30,15:40,10:60,5:119},Er={LIST:["icon_seamless","icon_global","icon_eu","icon_d2","ecmwf_ifs025","ecmwf_aifs025_single","gfs_seamless","gfs_global","gfs_hrrr","arome_france","gem_hrdps_continental","gem_regional"],API_MAP:{icon_seamless:"dwd_icon",icon_global:"dwd_icon",icon_eu:"dwd_icon_eu",icon_d2:"dwd_icon_d2",ecmwf_ifs025:"ecmwf_ifs025",ecmwf_aifs025_single:"ecmwf_aifs025_single",gfs_seamless:"ncep_gfs013",gfs_global:"ncep_gfs025",gfs_hrrr:"ncep_hrrr_conus",arome_france:"meteofrance_arome_france0025",gem_hrdps_continental:"cmc_gem_hrdps",gem_regional:"cmc_gem_rdps"}},te={METERS_TO_FEET:3.28084,FEET_TO_METERS:.3048,KNOTS_TO_MPS:.514444,KNOTS_TO_KMH:1.852,CELSIUS_TO_KELVIN:273.15},ui={MOLAR_MASS_AIR:.0289644,UNIVERSAL_GAS_CONSTANT:8.31446261815324},tt={LAPSE_RATE:.0065,SEA_LEVEL_TEMP_KELVIN:288.15,GRAVITY:9.80665,GAS_CONSTANT_AIR:287.05},nn={A_LIQUID:17.27,B_LIQUID:237.7,A_ICE:21.87,B_ICE:265.5},wl=6371e3,di={KNOT_THRESHOLDS:[1,4,7,11,17,22,28,34,41,48,56,64],BEAUFORT_THRESHOLDS:[0,1,3,6,10,16,21,27,33,40,47,55,63]},Ht={FORECAST:"https://api.open-meteo.com/v1/forecast",HISTORICAL:"https://historical-forecast-api.open-meteo.com/v1/forecast"},me={SCENARIO_COLORS:{MIN_WIND:"rgba(0, 0, 255, 0.7)",MEAN_WIND:"rgba(0, 255, 0, 0.7)",MAX_WIND:"rgba(255, 0, 0, 0.7)"},HEATMAP_MIN_RADIUS_PX:5,HEATMAP_MAX_RADIUS_PX:50,HEATMAP_SCALING_BASE:1.42,HEATMAP_BASE_RADIUS:20,HEATMAP_REFERENCE_ZOOM:13},vl=[1e3,950,925,900,850,800,700,600,500,400,300,250,200],Te=200,Un={OPEN:4.1,PARTIALLY:12.8,COLLAPSED:39.2},Ll=150,an={DEFAULT_AREA_VERTICAL:.5,DEFAULT_AREA_HORIZONTAL:.5,DEFAULT_MASS_KG:80,DEFAULT_DRAG_COEFFICIENT:1},gt={MIN_TRACK_LENGTH_M:100,MAX_TRACK_LENGTH_M:1e4,MIN_APPROACH_LENGTH_M:100,MAX_APPROACH_LENGTH_M:2e4,APPROACH_TIME_SECONDS:120},Se={MESSAGE_TIMEOUT_MS:3e3,DEFAULT_MAP_CENTER:[48.0179,11.1923],DEFAULT_MAP_ZOOM:11,GEOLOCATION_TIMEOUT_MS:2e4,GEOLOCATION_ACCURACY_THRESHOLD_M:100,MIN_ZOOM:11,MAX_ZOOM:14,LANDING_PATTERN_MIN_ZOOM:14},rn={MIN_TIME_DIFF_FOR_SPEED_CALC_S:.5,SPEED_SMOOTHING_LOW:.5,SPEED_SMOOTHING_HIGH:.2,SPEED_SMOOTHING_TRESHOLD:25},_n={TILE_MAX_AGE_DAYS:7,FETCH_TIMEOUT_MS:15e3,SIZE_LIMIT_MB_WARNING:500},va={DEFAULT_MARKER:fl,CUTAWAY_MARKER:gl,AIRPLANE_MARKER:pl};let Wn=console.error,Hn=console.log;var x;let p=(x=class{static formatTime(e){return I.fromISO(e,{zone:"UTC"}).toFormat("yyyy-MM-dd HHmm")+"Z"}static roundToTens(e){return Math.round(e/10)*10}static convertTemperature(e,n){const a=parseFloat(e);return isNaN(a)?"N/A":n==="°F"?a*9/5+32:a}static convertHeight(e,n){const a=parseFloat(e);return isNaN(a)?"N/A":n==="ft"?parseFloat((e*te.METERS_TO_FEET).toFixed(0)):e}static convertWind(e,n,a="km/h"){if(e==null||isNaN(e))return"N/A";let i;switch(a){case"km/h":i=e;break;case"m/s":i=e*3.6;break;case"kt":i=e*te.KNOTS_TO_KMH;break;case"mph":i=e*1.60934;break;case"bft":i=x.beaufortToKnots(e)*te.KNOTS_TO_KMH;break;default:i=e;break}switch(n){case"km/h":return i;case"m/s":return i/3.6;case"kt":return i/te.KNOTS_TO_KMH;case"mph":return i/1.60934;case"bft":return x.knotsToBeaufort(i/te.KNOTS_TO_KMH);default:return i/te.KNOTS_TO_KMH}}static knotsToBeaufort(e){const n=di.KNOT_THRESHOLDS.findIndex(a=>e<a);return n===-1?12:n}static beaufortToKnots(e){return di.BEAUFORT_THRESHOLDS[e]||63}static calculateDewpoint(e,n){const a=nn.A_LIQUID,i=nn.B_LIQUID,r=nn.A_ICE,o=nn.B_ICE;let l,c;return e>=0?(l=a*e/(i+e)+Math.log(n/100),c=i*l/(a-l)):(l=r*e/(o+e)+Math.log(n/100),c=o*l/(r-l)),isNaN(c)?null:c}static gaussianInterpolation(e,n,a,i,r){if(a===r)return e;if(i===r)return n;let o=1/Math.abs(a-r),l=1/Math.abs(i-r);return(o*e+l*n)/(o+l)}static interpolateWindAtAltitude(e,n,a,i,r){if(n.length!=a.length||n.length!=i.length||n.length!=r.length)return{u:"Invalid input",v:"Invalid input"};const o=n.map(h=>Math.log(h)),l=x.linearInterpolate(a,o,e);if(typeof l=="string"&&l.includes("error"))return{u:"Interpolation error",v:"Interpolation error"};const c=Math.exp(l),u=x.linearInterpolate(o,i,Math.log(c)),d=x.linearInterpolate(o,r,Math.log(c));return typeof u=="string"&&u.includes("error")||typeof d=="string"&&d.includes("error")?{u:"Interpolation error",v:"Interpolation error"}:{u,v:d}}static interpolatePressure(e,n,a){if(!n||!a||n.length!==a.length||n.length<2||e<a[0]||e>a[a.length-1])return"N/A";for(let i=0;i<a.length-1;i++)if(e>=a[i]&&e<=a[i+1]){const r=a[i],o=a[i+1],l=n[i],c=n[i+1];return l+(c-l)*(e-r)/(o-r)}return"N/A"}static linearInterpolate(e,n,a){if(!(e!=null&&e.length)||!(n!=null&&n.length)||e.length!==n.length)return"invalid input for linearInterpolate";let i=!1;e[1]>e[0]&&(n=[...n].reverse(),e=[...e].reverse(),i=!0);const r=e.length-1;try{if(a>e[0]||a<e[r]){let o,l;return a>e[0]?(o=(n[1]-n[0])/(e[1]-e[0]),l=n[1]-o*e[1]):(o=(n[r]-n[r-1])/(e[r]-e[r-1]),l=n[r]-o*e[r]),o*a+l}else{let o;for(o=1;o<=r&&!(a>=e[o]);o++);const l=(n[o]-n[o-1])/(e[o]-e[o-1]),c=n[o]-l*e[o];return l*a+c}}catch{return"interpolation error"}finally{i&&(n.reverse(),e.reverse())}}static windSpeed(e,n){return Math.sqrt(e*e+n*n)}static windDirection(e,n){return(Math.atan2(-e,-n)*180/Math.PI+360)%360}static calculateMeanWind(e,n,a,i,r){try{if(!e||!n||!a||e.length<2)throw new Error("Invalid input data for calculateMeanWind");const o=new Array(4);let l=[r],c=[Number(x.linearInterpolate(e,n,r))],u=[Number(x.linearInterpolate(e,a,r))];const d=Number(x.linearInterpolate(e,n,i)),h=Number(x.linearInterpolate(e,a,i));for(let S=0;S<e.length;S++)e[S]<r&&e[S]>i&&(l.push(e[S]),c.push(n[S]),u.push(a[S]));l.push(i),c.push(d),u.push(h);const g=l.map((S,_)=>_);g.sort((S,_)=>l[_]-l[S]),l=g.map(S=>l[S]),c=g.map(S=>c[S]),u=g.map(S=>u[S]);let f=0,w=0;for(let S=0;S<l.length-1;S++)f+=.5*(c[S]+c[S+1])*(l[S]-l[S+1]),w+=.5*(u[S]+u[S+1])*(l[S]-l[S+1]);const v=f/(l[0]-l[l.length-1]),y=w/(l[0]-l[l.length-1]);return o[2]=v,o[3]=y,o[1]=x.windSpeed(v,y),o[0]=x.windDirection(v,y),o}catch(o){return console.error("Error in calculateMeanWind:",o,{heights:e,xComponents:n,yComponents:a,lowerLimit:i,upperLimit:r}),x.handleError("Failed to calculate mean wind: "+o.message),null}}static async getLocationData(e,n){const a=`${e.toFixed(4)},${n.toFixed(4)}`;if(x.locationCache.has(a))return x.locationCache.get(a);try{const i=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${e}&longitude=${n}&timezone=auto`);if(!i.ok)throw i.status===429&&console.warn("API rate limit hit while fetching location data."),new Error(`Open-Meteo fetch failed: ${i.status}`);const r=await i.json(),o={timezone:r.timezone||"GMT",timezone_abbreviation:r.timezone_abbreviation||"GMT",elevation:r.elevation!==void 0?r.elevation:"N/A"};return x.locationCache.set(a,o),console.log(`Fetched location data for ${a}:`,o),o}catch(i){return console.error("Error fetching location data:",i.message),{timezone:"UTC",elevation:"N/A"}}}static async formatLocalTime(e,n,a){const{timezone:i,timezone_abbreviation:r}=await x.getLocationData(n,a);return I.fromISO(e,{zone:"UTC"}).setZone(i).toFormat("yyyy-MM-dd HHmm")+` ${r}`}static normalizeAngle(e){return(e%360+360)%360}static calculateWindAngle(e,n){let a=x.normalizeAngle(n-e);return a>180&&(a-=360),a}static calculateWindComponents(e,n){const a=n*(Math.PI/180),i=e*Math.sin(a),r=e*Math.cos(a);return{crosswind:i,headwind:r}}static calculateWCA(e,n){const i=Math.abs(Math.asin(e/n))*(180/Math.PI);return isNaN(i)?0:i}static calculateGroundSpeed(e,n){return e-n}static calculateCourseFromHeading(e,n,a,i){const r=x.calculateWindAngle(e,n),{crosswind:o,headwind:l}=x.calculateWindComponents(a,r),c=i*Math.sin(e*Math.PI/180),u=i*Math.cos(e*Math.PI/180),d=(n+180)%360,h=a*Math.sin(d*Math.PI/180),g=a*Math.cos(d*Math.PI/180),f=c+h,w=u+g,v=Math.atan2(f,w)*(180/Math.PI),y=x.normalizeAngle(v),S=Math.sqrt(f*f+w*w),_=x.calculateWCA(o,i)*(o<0?-1:1);return{trueCourse:Number(y.toFixed(2)),groundSpeed:Number(S.toFixed(2)),wca:Number(_.toFixed(2)),crosswind:Number(o.toFixed(2)),headwind:Number(l.toFixed(2))}}static calculateFlightParameters(e,n,a,i){const r=x.calculateWindAngle(e,n),{crosswind:o,headwind:l}=x.calculateWindComponents(a,r),c=x.calculateWCA(o,i),u=x.calculateGroundSpeed(i,l);return{crosswind:Number(o.toFixed(2)),headwind:Number(l.toFixed(2)),wca:Number(c.toFixed(2)),groundSpeed:Number(u.toFixed(2))}}static handleError(e,n=!0){n&&console.error(e),typeof displayError=="function"?displayError(e):(console.warn("Utils.js: displayError function is not available, logging to console only."),console.error("Error message:",e))}static dmsToDecimal(e,n,a,i){if(isNaN(e)||isNaN(n)||isNaN(a)||!i)throw console.warn("Invalid DMS inputs:",{deg:e,min:n,sec:a,dir:i}),new Error("Invalid DMS values");let r=e+n/60+a/3600;if((i==="S"||i==="W")&&(r=-r),isNaN(r))throw console.warn("DMS to decimal conversion failed:",{deg:e,min:n,sec:a,dir:i}),new Error("Failed to convert DMS to decimal");return r}static decimalToDms(e,n){if(isNaN(e)||e===null||e===void 0)throw console.warn("Invalid decimal value for DMS conversion:",e),new Error("Invalid coordinate for DMS conversion");const a=Math.abs(e),i=Math.floor(a),r=Math.floor((a-i)*60),o=(a-i)*3600-r*60,l=n?e>=0?"N":"S":e>=0?"E":"W";if(isNaN(i)||isNaN(r)||isNaN(o))throw console.warn("DMS calculation resulted in invalid values:",{deg:i,min:r,sec:o}),new Error("Failed to convert to DMS");return{deg:i,min:r,sec:o,dir:l}}static decimalToMgrs(e,n){try{return Mr([n,e])}catch(a){return console.error("Error converting to MGRS:",a),"Invalid MGRS"}}static mgrsToDecimal(e){try{const[n,a]=ya(e);return{lat:a,lng:n}}catch(n){return console.error("Error converting MGRS to decimal:",n),null}}static convertCoords(e,n,a="Decimal"){if(e===null||n===null||e===void 0||n===void 0)return{lat:"N/A",lng:"N/A"};const i={Decimal:{lat:e.toFixed(6),lng:n.toFixed(6)},DMS:{lat:x.decimalToDms(e,!0),lng:x.decimalToDms(n,!1)},MGRS:x.decimalToMgrs(e,n)};switch(a){case"DMS":return i.DMS;case"MGRS":return{lat:i.MGRS,lng:i.MGRS};case"Decimal":default:return i.Decimal}}static calculateTAS(e,n){if(isNaN(e)||isNaN(n)||e<0||n<0)return console.warn("Invalid inputs for calculateTAS:",{ias:e,heightFt:n}),"N/A";const a=tt.LAPSE_RATE,i=tt.SEA_LEVEL_TEMP_KELVIN,r=tt.GRAVITY,o=tt.GAS_CONSTANT_AIR,l=te.FEET_TO_METERS,c=n*l,u=i-a*c,d=u/i,h=1-a*c/i,g=r/(a*o)-1,f=Math.pow(h,g),w=e/Math.sqrt(f);return console.log("calculateTAS debug:",{ias:e,heightFt:n,heightM:c,tempAtAltitude:u,tempRatio:d,base:h,exponent:g,densityRatio:f,tas:w,tasRounded:Number(w.toFixed(2))}),Number(w.toFixed(2))}static calculateTASFromGroundSpeed(e,n,a,i,r){if(isNaN(e)||isNaN(n)||isNaN(a)||isNaN(i))return"N/A";const o=x.convertWind(e,"kt","m/s"),l=x.convertWind(n,"kt","m/s"),c=x.calculateWindAngle(i,a),{crosswind:u,headwind:d}=x.calculateWindComponents(l,c),h=o+d,g=x.calculateTAS(h,r);return Number(g.toFixed(1))}static handleMessage(e){const n=document.getElementById("info");n?(n.textContent=e,n.style.display="block",setTimeout(()=>{n.style.display="none"},3e3),console.log("Displayed message:",e)):(console.warn("Info div not found for handleMessage, using alert"),alert(e))}static calculateQFE(e,n,a,i=15){if(!e||n==="N/A"||a==="N/A"||isNaN(e)||isNaN(n)||isNaN(a))return"N/A";console.log("QFE reference elevation: ",a);const r=tt.GRAVITY,o=ui.MOLAR_MASS_AIR,l=ui.UNIVERSAL_GAS_CONSTANT,c=i+te.CELSIUS_TO_KELVIN,u=tt.LAPSE_RATE,d=e*100,h=n-a,g=r*o/(l*u),f=d*Math.pow(1-u*h/c,g);console.log(e,n,a);const w=Math.round(f/100);return isNaN(w)?"N/A":w}static calculateNewCenter(e,n,a,i){const r=wl,o=e*Math.PI/180,l=n*Math.PI/180,c=i*Math.PI/180,u=a/r,d=Math.asin(Math.sin(o)*Math.cos(u)+Math.cos(o)*Math.sin(u)*Math.cos(c)),h=l+Math.atan2(Math.sin(c)*Math.sin(u)*Math.cos(o),Math.cos(u)-Math.sin(o)*Math.sin(d)),g=d*180/Math.PI,w=(h*180/Math.PI+540)%360-180;return[g,w]}static debounce(e,n){let a;return function(...i){clearTimeout(a),a=setTimeout(()=>e.apply(this,i),n)}}static calculateBearing(e,n,a,i){const r=h=>h*Math.PI/180,o=h=>h*180/Math.PI,l=r(i-n),c=Math.sin(l)*Math.cos(r(a)),u=Math.cos(r(e))*Math.sin(r(a))-Math.sin(r(e))*Math.cos(r(a))*Math.cos(l);let d=o(Math.atan2(c,u));return d=(d+360)%360,d}static async getAltitude(e,n){const{elevation:a}=await x.getLocationData(e,n);return console.log("Fetched elevation from Open-Meteo:",a),a!=="N/A"?a:"N/A"}static getLastFullHourUTC(){const e=new Date,n=e.getUTCFullYear(),a=e.getUTCMonth(),i=e.getUTCDate(),r=e.getUTCHours(),o=new Date(Date.UTC(n,a,i,r,0,0));return console.log("Last full hour UTC:",o.toISOString()),o}static async getDisplayTime(e,n,a,i="Z"){return i.toLowerCase()==="loc"&&n&&a?await x.formatLocalTime(e,n,a):x.formatTime(e)}static calculateDynamicRadius(e=me.HEATMAP_SCALING_BASE,n=me.HEATMAP_REFERENCE_ZOOM){const a=s.map.getZoom(),i=me.HEATMAP_SCALING_BASE,r=Math.pow(i,a-n),o=e*r,l=me.HEATMAP_MIN_RADIUS_PX,c=me.HEATMAP_MAX_RADIUS_PX,u=Math.max(l,Math.min(c,o));return console.log("[calculateDynamicRadius] Calculated dynamic radius:",{currentZoom:a,baseRadius:e,scaleFactor:r,dynamicRadius:o,adjustedRadius:u}),u}static interpolateColor(e,n=0,a=3e3){const i=Math.min(Math.max((e-n)/(a-n),0),1);return e<0||isNaN(e)?"#808080":i<=.5?`rgb(255, ${Math.round(255*(i*2))}, 0)`:`rgb(${Math.round(255*(1-(i-.5)*2))}, 255, 0)`}static generateWindBarb(e,n,a=null){const i=Math.round(n),r=40,o=40,l=r/2,c=o/2,u=20,h=(typeof a=="number"&&!isNaN(a)?a>=0:!0)?-1:1;let g=Math.floor(i/50),f=i%50,w=Math.floor(f/10),v=Math.floor(f%10/5);i<5?(w=0,v=0):i<10&&v>0&&(v=1);let y=`<svg width="${r}" height="${o}" viewBox="0 0 ${r} ${o}">`;const S=e+180;y+=`<g transform="translate(${l}, ${c}) rotate(${S})">`,y+=`<line x1="0" y1="${u/2}" x2="0" y2="${-u/2}" stroke="black" stroke-width="1"/>`;let _=u/2;const E=4;for(let M=0;M<g;M++)y+=`<polygon points="0,${_-5} 0,${_+5} ${10*h},${_}" fill="black"/>`,_-=E+5;for(let M=0;M<w;M++)y+=`<line x1="0" y1="${_}" x2="${10*h}" y2="${_}" stroke="black" stroke-width="1"/>`,_-=E;return v>0&&(y+=`<line x1="0" y1="${_}" x2="${5*h}" y2="${_}" stroke="black" stroke-width="1"/>`),i<5&&(y+='<circle cx="0" cy="0" r="3" fill="none" stroke="black" stroke-width="1"/>'),y+="</g></svg>",y}static setErrorHandler(e){Wn=e}static setMessageHandler(e){Hn=e}static handleError(e,n=!0){n&&console.error(e),typeof Wn=="function"&&Wn(e)}static handleMessage(e){typeof Hn=="function"?Hn(e):console.log(e)}static validateLegHeights(e,n,a){const i=parseInt(e.value)||100,r=parseInt(n.value)||200,o=parseInt(a.value)||300;return r<=i?(x.handleError("Base leg must start higher than final leg."),!1):o<=r?(x.handleError("Downwind leg must start higher than base leg."),!1):!0}static convertFeetToMeters(e){return e==null||isNaN(e)?0:e/3.28084}},An(x,"locationCache",new Map),An(x,"debouncedGetElevationAndQFE",x.debounce(async(e,n,a)=>{`${e.toFixed(5)}${n.toFixed(5)}`;try{const i=await x.getAltitude(e,n);a&&a({elevation:i})}catch(i){console.warn("Failed to fetch elevation in debouncedGetElevationAndQFE:",i),a&&a({elevation:"N/A"})}},500)),x);window.Utils=p;const st=()=>m.getValue("interpStepSelect","select",200);let na=!1;function Ml(t){na=t,console.log(`App context set to: ${na?"Mobile":"Web"}`)}const m={FEATURE_PASSWORD:"skydiver2025",defaultSettings:{model:"icon_global",refLevel:"AGL",heightUnit:"m",temperatureUnit:"C",windUnit:"kt",timeZone:"Z",coordFormat:"Decimal",downloadFormat:"HEIDIS",showTable:!1,canopySpeed:20,descentRate:3.5,showLandingPattern:!1,landingDirection:"LL",customLandingDirectionLL:"",customLandingDirectionRR:"",legHeightDownwind:300,legHeightBase:200,legHeightFinal:100,interpStep:"200",lowerLimit:0,upperLimit:3e3,baseMaps:"Esri Street",calculateJump:!0,openingAltitude:1200,exitAltitude:3e3,showJumpRunTrack:!1,showExitArea:!1,showCanopyArea:!1,jumpRunTrackOffset:0,jumpRunTrackForwardOffset:0,aircraftSpeedKt:90,jumperSeparation:5,numberOfJumpers:5,cutAwayAltitude:1e3,cutAwayState:"Partially",trackPosition:!1,showJumpMasterLine:!1,jumpMasterLineTarget:"DIP",harpLat:null,harpLng:null,cacheRadiusKm:10,cacheZoomLevels:[11,12,13,14],autoupdate:!1,selectedEnsembleModels:[],currentEnsembleScenario:"all_models"},state:{userSettings:null,unlockedFeatures:{landingPattern:!1,calculateJump:!1,planner:!1},isJumperSeparationManual:!1,isLandingPatternUnlocked:!1,isCalculateJumpUnlocked:!1,isPlannerUnlocked:!1},initialize(){let t={},e={landingPattern:!1,calculateJump:!1};try{const a=localStorage.getItem("upperWindsSettings");a?(t=JSON.parse(a),console.log("Loaded settings from localStorage:",t)):console.log("No settings found in localStorage, using defaults")}catch(a){this.handleError(a,"Failed to load settings. Using defaults.")}try{const a=localStorage.getItem("unlockedFeatures");a?(e=JSON.parse(a),console.log("Loaded unlocked features from localStorage:",e)):console.log("No unlocked features found in localStorage, using defaults")}catch(a){this.handleError(a,"Failed to load unlocked features. Using defaults.")}this.state.userSettings={...this.defaultSettings,...t},console.log("Initialized userSettings:",this.state.userSettings),this.state.userSettings.harpLat=null,this.state.userSettings.harpLng=null,console.log("Reset HARP coordinates to null at startup"),this.state.userSettings.jumpMasterLineTarget==="HARP"&&(console.log("Reset jumpMasterLineTarget to DIP due to cleared HARP coordinates"),this.state.userSettings.jumpMasterLineTarget="DIP"),this.state.userSettings.selectedEnsembleModels=[...this.defaultSettings.selectedEnsembleModels],this.state.userSettings.currentEnsembleScenario=this.defaultSettings.currentEnsembleScenario,this.state.unlockedFeatures={landingPattern:e.landingPattern||!1,calculateJump:e.calculateJump||!1,planner:e.planner||!1},["OpenStreetMap","OpenTopoMap","Esri Satellite","Esri Street","Esri Topo","Esri Satellite + OSM"].includes(this.state.userSettings.baseMaps)||(console.warn(`Invalid baseMaps setting: ${this.state.userSettings.baseMaps}, resetting to default`),this.state.userSettings.baseMaps=this.defaultSettings.baseMaps)},save(){const t={...this.state.userSettings};delete t.customJumpRunDirection;try{localStorage.setItem("upperWindsSettings",JSON.stringify(t)),console.log("Settings saved to localStorage:",t)}catch(e){console.error("Failed to save settings to localStorage:",e)}},saveUnlockStatus(t,e){try{t==="landingPattern"?(this.state.unlockedFeatures.landingPattern=e,this.state.isLandingPatternUnlocked=e):t==="calculateJump"?(this.state.unlockedFeatures.calculateJump=e,this.state.isCalculateJumpUnlocked=e):t==="planner"&&(this.state.unlockedFeatures.planner=e,this.state.isPlannerUnlocked=e),this.saveUnlockedFeatures(),console.log("Saved unlock status:",{landingPattern:this.state.isLandingPatternUnlocked,calculateJump:this.state.isCalculateJumpUnlocked,planner:this.state.isPlannerUnlocked})}catch{Utils.handleError("Failed to save unlock status.")}},showPasswordModal(t,e,n){console.log("Entering showPasswordModal for feature:",t);const a=document.getElementById("passwordModal"),i=document.getElementById("passwordInput"),r=document.getElementById("passwordError"),o=document.getElementById("passwordSubmit"),l=document.getElementById("passwordCancel"),c=document.getElementById("modalHeader"),u=document.getElementById("modalMessage");if(!a||!i||!o||!l||!c||!u){console.error("Modal elements not found:",{modal:a,input:i,submitBtn:o,cancelBtn:l,header:c,message:u});return}const d=t.charAt(0).toUpperCase()+t.slice(1);c.textContent=`${d} Access`,u.textContent=`Please enter the password to enable the ${d.toLowerCase()} functionality:`,i.value="",r.style.display="none",a.style.display="flex",console.log("Password modal should now be visible:",{modalDisplay:a.style.display});const h=()=>{if(console.log("Password modal submit clicked, entered value:",i.value),i.value===yl){if(a.style.display="none",this.saveUnlockStatus(t,!0),t==="landingPattern"){const g=document.getElementById("showLandingPattern");g&&(g.style.opacity="1",g.title="")}else if(t==="calculateJump"){const g=document.querySelector('.menu-label[data-label="calculateJump"]');g&&(g.style.opacity="1",g.title="")}console.log("Feature unlocked:",t),e()}else r.textContent="Incorrect password",r.style.display="block",console.log("Incorrect password entered")};o.onclick=h,i.onkeypress=g=>{g.key==="Enter"&&h()},l.onclick=()=>{a.style.display="none",console.log("Password modal cancelled"),n()}},saveUnlockedFeatures(){try{const t=JSON.stringify(this.state.unlockedFeatures);localStorage.setItem("unlockedFeatures",t),console.log("Unlocked features saved:",JSON.parse(t))}catch(t){this.handleError(t,"Failed to save unlocked features to localStorage.")}},getValue(t,e,n){if(n===void 0&&typeof e!="string"&&(n=e,e=null),this.state.userSettings&&typeof this.state.userSettings[t]<"u")return this.state.userSettings[t];const a=document.querySelector(`input[name="${t}"]:checked`);if(a)return a.value;const i=document.getElementById(t);if(i&&i.tagName==="SELECT")return i.value;const r=document.getElementById(t);return r&&r.type==="checkbox"?r.checked:n},updateUnitLabels(){const t=this.getValue("heightUnit","radio","m"),e=this.getValue("windUnit","radio","kt"),n=this.getValue("refLevel","radio","AGL"),a=document.querySelector('#controls-row label[for="interpStepSelect"]');a&&(a.textContent=`Step (${t}):`,console.log(`Updated step label to: Step (${t})`));const i=document.querySelector('label[for="lowerLimit"]'),r=document.querySelector('label[for="upperLimit"]');i&&(i.textContent=`Lower Limit (${t}):`,console.log(`Updated lower limit label to: Lower Limit (${t})`)),r&&(r.textContent=`Upper Limit (${t}):`,console.log(`Updated upper limit label to: Upper Limit (${t})`));const o=document.getElementById("meanWindResult");if(o!=null&&o.innerHTML){let l=o.innerHTML;const c=/\((\d+)-(\d+) m\b[^)]*\)/;if(c.test(l)){const[d,h,g]=l.match(c),f=this.convertHeight(parseFloat(h),t),w=this.convertHeight(parseFloat(g),t);l=l.replace(c,`(${Math.round(f)}-${Math.round(w)} ${t} ${n})`),console.log(`Updated mean wind height: (${Math.round(f)}-${Math.round(w)} ${t} ${n})`)}const u=/: (\d+(?:\.\d+)?)\s*([a-zA-Z\/]+)$/;if(u.test(l)){const[d,h,g]=l.match(u),f=parseFloat(h);if(!isNaN(f)){const w=this.convertWind(f,e,g),v=w==="N/A"?"N/A":e==="bft"?Math.round(w):w.toFixed(1);l=l.replace(u,`: ${v} ${e}`),console.log(`Updated mean wind speed: ${v} ${e}`)}}o.innerHTML=l}},updateModelRunInfo(t,e,n){const a=document.getElementById("modelLabel"),i=document.getElementById("modelSelect");if(!a||!i){console.warn("Model run info elements missing:",{modelLabel:a,modelSelect:i,lastModelRun:t,lastLat:e,lastLng:n});return}if(!t){console.log("lastModelRun is falsy, setting default model run info:",{lastModelRun:t,lastLat:e,lastLng:n}),a.title=`Model: ${i.value.replace("_"," ").toUpperCase()}
Run: Not available`;return}const r=i.value,o=`Model: ${r.replace("_"," ").toUpperCase()}
Run: ${t}`;a.title=o,console.log(`Updated model run info: ${o}`,{lastModelRun:t,model:r,lastLat:e,lastLng:n})},handleError(t,e="An error occurred. Please try again."){console.error("Settings Error:",t),Utils.handleError(e)},convertHeight(t,e){return isNaN(t)?t:e==="ft"?t*3.28084:t},convertWind(t,e,n){var i,r;return isNaN(t)?"N/A":((r=(i={kt:{"m/s":o=>o*.514444,"km/h":o=>o*1.852,mph:o=>o*1.15078,bft:o=>this.ktToBeaufort(o)},"m/s":{kt:o=>o/.514444,"km/h":o=>o*3.6,mph:o=>o*2.23694,bft:o=>this.ktToBeaufort(o/.514444)}}[n])==null?void 0:i[e])==null?void 0:r.call(i,t))||t},ktToBeaufort(t){return t<1?0:t<=3?1:t<=6?2:t<=10?3:t<=16?4:t<=21?5:t<=27?6:t<=33?7:t<=40?8:t<=47?9:t<=55?10:t<=63?11:12},isFeatureUnlocked(t){return na&&(t==="landingPattern"||t==="calculateJump")?!0:!!this.state.unlockedFeatures[t]||!1}};function Tr(t){const e=m.state.userSettings.exitAltitude*te.METERS_TO_FEET,n=p.calculateTAS(t,e);if(n==="N/A")return console.warn("TAS calculation failed, using default separation"),m.defaultSettings.jumperSeparation;const a=Object.keys(ci).map(Number).sort((o,l)=>l-o);let i=a[0];for(const o of a)if(n<=o)i=o;else break;return ci[i]||7}function kr(t,e,n,a,i,r,o){if(!t||!t.time||!a||a.length===0||!Number.isFinite(i)||!Number.isFinite(r)||!Number.isFinite(o))return null;const l=o+e,c=o+n-Te,u=bn(a),d=u?u.direction:0,h=m.state.userSettings.aircraftSpeedKt,g=e/.3048,f=p.calculateTAS(h,g);let w=f==="N/A"?h*te.KNOTS_TO_MPS:f*te.KNOTS_TO_MPS;const v=Math.cos(d*Math.PI/180)*w,y=Math.sin(d*Math.PI/180)*w,S=a.map(N=>N.height),_=a.map(N=>Number.isFinite(N.dir)?parseFloat(N.dir):0),E=a.map(N=>p.convertWind(parseFloat(N.spd)||0,"m/s","km/h")),M=a.map(N=>N.temp),b=[{time:0,height:l,vz:0,vxGround:v,vyGround:y,x:0,y:0}],k=t.surface_pressure[0]||1013.25;let A=b[0];for(;A.height>c;){const N=p.linearInterpolate(S,_,A.height),P=p.linearInterpolate(S,E,A.height),U=p.linearInterpolate(S,M,A.height)+te.CELSIUS_TO_KELVIN,G=tt.GAS_CONSTANT_AIR,R=.5,B=k*100*Math.exp(-9.80665*(A.height-o)/(G*U))/(G*U),V=(N+180)%360,Q=P*Math.cos(V*Math.PI/180),ae=P*Math.sin(V*Math.PI/180),q=A.vxGround-Q,Ze=A.vyGround-ae,be=Math.sqrt(q*q+Ze*Ze),De=1,At=an.DEFAULT_AREA_VERTICAL,ut=an.DEFAULT_MASS_KG,X=an.DEFAULT_DRAG_COEFFICIENT,Tn=an.DEFAULT_AREA_HORIZONTAL,dt=.5*De*At*B/ut,Pe=.5*X*Tn*B/ut,ye=-9.80665-dt*A.vz*Math.abs(A.vz),Je=-Pe*be*q,je=-Pe*be*Ze;let qe=A.height+A.vz*R,Ke=A.vz+ye*R,xe=A.time+R;if(qe<=c){const Ct=(A.height-c)/(A.height-qe);xe=A.time+R*Ct,qe=c,Ke=A.vz+ye*R*Ct}const Oe={time:xe,height:qe,vz:Ke,vxGround:v===0?Q:A.vxGround+Je*R,vyGround:y===0?ae:A.vyGround+je*R,x:A.x+(v===0?Q:A.vxGround)*R,y:A.y+(y===0?ae:A.vyGround)*R};if(b.push(Oe),A=Oe,Oe.height===c)break}const T=b[b.length-1],F=Math.sqrt(T.x*T.x+T.y*T.y);let D=Math.atan2(T.y,T.x)*180/Math.PI;return D=(D+360)%360,{time:T.time,distance:F,directionDeg:D,path:b.map(N=>({latLng:p.calculateNewCenter(i,r,Math.sqrt(N.x*N.x+N.y*N.y),Math.atan2(N.y,N.x)*180/Math.PI),height:N.height,time:N.time}))}}function Ar(t){var F,D,N,P,$;if(!m.state.userSettings.showExitArea||!m.state.userSettings.calculateJump||!s.weatherData||!s.lastLat||!s.lastLng||!t||t.length===0)return null;const e=parseInt((F=document.getElementById("exitAltitude"))==null?void 0:F.value)||3e3,n=parseInt((D=document.getElementById("openingAltitude"))==null?void 0:D.value)||1200,a=parseInt((N=document.getElementById("legHeightDownwind"))==null?void 0:N.value)||300,i=parseFloat((P=document.getElementById("descentRate"))==null?void 0:P.value)||3.5,r=(parseFloat(($=document.getElementById("canopySpeed"))==null?void 0:$.value)||20)*te.KNOTS_TO_MPS,o=t.map(U=>U.height),l=t.map(U=>-p.convertWind(U.spd,"m/s","km/h")*Math.sin(U.dir*Math.PI/180)),c=t.map(U=>-p.convertWind(U.spd,"m/s","km/h")*Math.cos(U.dir*Math.PI/180)),u=Math.round(s.lastAltitude),d=(n-Te-a)/i,h=d*r,g=(n-Te)/i,f=g*r,w=p.calculateMeanWind(o,l,c,u+a,u+n-Te),v=p.calculateMeanWind(o,l,c,u,u+n-Te),y=Cr(s.lastLat,s.lastLng,t);let{downwindLat:S,downwindLng:_}=y;Number.isFinite(S)||(S=s.lastLat,_=s.lastLng);const E=p.calculateNewCenter(S,_,w[1]*d,w[0]),M=p.calculateNewCenter(s.lastLat,s.lastLng,v[1]*g,v[0]),b=kr(s.weatherData,e,n,t,s.lastLat,s.lastLng,u);if(!b)return null;const k=(b.directionDeg+180)%360,A=p.calculateNewCenter(M[0],M[1],b.distance,k),T=p.calculateNewCenter(E[0],E[1],b.distance,k);return{greenLat:A[0],greenLng:A[1],darkGreenLat:T[0],darkGreenLng:T[1],greenRadius:f,darkGreenRadius:h,freeFallDirection:b.directionDeg,freeFallDistance:b.distance,freeFallTime:b.time}}function La(t){if(!s.map||s.cutAwayLat===null||s.cutAwayLng===null||!s.weatherData||s.lastAltitude==="N/A"||!t||t.length===0)return null;const e=Math.round(s.lastAltitude),n=m.state.userSettings.cutAwayAltitude,a=e,i=e+n,r=t.map(M=>M.height),o=t.map(M=>-p.convertWind(M.spd,"m/s","km/h")*Math.sin(M.dir*Math.PI/180)),l=t.map(M=>-p.convertWind(M.spd,"m/s","km/h")*Math.cos(M.dir*Math.PI/180)),c=p.calculateMeanWind(r,o,l,a,i);if(!c)return null;const[u,d]=c,h={Open:Un.OPEN,Partially:Un.PARTIALLY,Collapsed:Un.COLLAPSED},g=h[m.state.userSettings.cutAwayState]||h.Partially,f=n/g,w=d*f,v=(u+180)%360,[y,S]=p.calculateNewCenter(s.cutAwayLat,s.cutAwayLng,w,v),E=`<b>Cut-Away (${m.state.userSettings.cutAwayState.replace(/([A-Z])/g," $1").trim()})</b><br>Cut-Away Altitude: ${n} m<br>Displacement: ${u.toFixed(0)}°, ${w.toFixed(0)} m<br>Descent Time/Speed: ${f.toFixed(0)} s at ${g.toFixed(1)} m/s<br>`;return{center:[y,S],radius:Ll,tooltipContent:E}}function Sl(t){var N,P,$,U,G;if(!m.state.userSettings.showCanopyArea||!m.state.userSettings.calculateJump||!s.weatherData||!s.lastLat||!s.lastLng||!t||t.length===0)return null;const e=parseInt((N=document.getElementById("exitAltitude"))==null?void 0:N.value)||3e3,n=parseInt((P=document.getElementById("openingAltitude"))==null?void 0:P.value)||1200,a=parseInt(($=document.getElementById("legHeightDownwind"))==null?void 0:$.value)||300,i=parseFloat((U=document.getElementById("descentRate"))==null?void 0:U.value)||3.5,r=(parseFloat((G=document.getElementById("canopySpeed"))==null?void 0:G.value)||20)*te.KNOTS_TO_MPS,o=t.map(R=>R.height),l=t.map(R=>-p.convertWind(R.spd,"m/s","km/h")*Math.sin(R.dir*Math.PI/180)),c=t.map(R=>-p.convertWind(R.spd,"m/s","km/h")*Math.cos(R.dir*Math.PI/180)),u=Math.round(s.lastAltitude),d=(n-Te-a)/i,h=d*r,g=(n-Te)/i,f=g*r,w=p.calculateMeanWind(o,l,c,u+a,u+n-Te),v=p.calculateMeanWind(o,l,c,u,u+n-Te),y=kr(s.weatherData,e,n,t,s.lastLat,s.lastLng,u);if(!y)return null;const S=Cr(s.lastLat,s.lastLng,t);let{downwindLat:_,downwindLng:E}=S;Number.isFinite(_)||(_=s.lastLat,E=s.lastLng);const M=u+n-Te,b=u+a,k=[],A=[],T=[],F=[];let D=M-b<=1e3?200:500;for(let R=M;R>=b+200;R-=D){const B=(R-b)/i,V=B*r;if(V>0){const Q=p.calculateMeanWind(o,l,c,b,R);k.push(V),A.push(Q[1]*B),T.push(Q[0]),F.push(R-u)}}return{blueLat:_,blueLng:E,redLat:s.lastLat,redLng:s.lastLng,radius:h,radiusFull:f,additionalBlueRadii:k,additionalBlueDisplacements:A,additionalBlueDirections:T,additionalBlueUpperLimits:F,displacement:w[1]*d,direction:w[0],displacementFull:v[1]*g,directionFull:v[0],meanWindForFullCanopyDir:v[0],meanWindForFullCanopySpeedMps:v[1],freeFallDirection:y.directionDeg,freeFallDistance:y.distance,freeFallTime:y.time}}function bn(t){var D,N;if(!s.weatherData||!s.lastLat||!s.lastLng||s.lastAltitude==="N/A"||!t||t.length===0)return null;const e=parseInt((D=document.getElementById("openingAltitude"))==null?void 0:D.value)||1e3,n=Math.round(s.lastAltitude),a=t.map(P=>P.height),i=t.map(P=>-p.convertWind(P.spd,"m/s","km/h")*Math.sin(P.dir*Math.PI/180)),r=t.map(P=>-p.convertWind(P.spd,"m/s","km/h")*Math.cos(P.dir*Math.PI/180)),o=p.calculateMeanWind(a,i,r,n,n+e);if(!o)return null;let l=Math.round(o[0]);const c=parseFloat(m.state.userSettings.customJumpRunDirection);Number.isFinite(c)&&c>=0&&c<=359&&(l=c);const u=parseInt((N=document.getElementById("exitAltitude"))==null?void 0:N.value)||3e3,d=n+u,h=p.calculateTAS(m.state.userSettings.aircraftSpeedKt||90,d/.3048);let g=null,f=2e3,w=2e3,v=null;if(h!=="N/A"&&Number.isFinite(h)){const P=p.linearInterpolate(a.map(q=>q-n),t.map(q=>q.dir),u),$=p.linearInterpolate(a.map(q=>q-n),t.map(q=>p.convertWind(q.spd,"m/s","km/h")),u),U=h*te.KNOTS_TO_MPS,G=(P+180)*Math.PI/180,R=$*Math.sin(G),B=$*Math.cos(G),V=l*Math.PI/180,Q=U*Math.sin(V),ae=U*Math.cos(V);g=Math.sqrt(Math.pow(Q+R,2)+Math.pow(ae+B,2)),f=Math.max(gt.MIN_TRACK_LENGTH_M,Math.min(gt.MAX_TRACK_LENGTH_M,Math.round((m.state.userSettings.numberOfJumpers||10)*(m.state.userSettings.jumperSeparation||5)*g))),w=Math.max(gt.MIN_APPROACH_LENGTH_M,Math.min(gt.MAX_APPROACH_LENGTH_M,Math.round(g*gt.APPROACH_TIME_SECONDS)))}const y=m.state.userSettings.jumpRunTrackOffset||0,S=m.state.userSettings.jumpRunTrackForwardOffset||0,_=(Math.atan2(y,S)*180/Math.PI+360)%360,E=Math.sqrt(y**2+S**2),M=(l+_+360)%360,[b,k]=p.calculateNewCenter(s.lastLat,s.lastLng,E,M),A=f/2,T=p.calculateNewCenter(b,k,A,(l+180)%360),F=p.calculateNewCenter(b,k,A,l);if(g){const P=p.calculateNewCenter(T[0],T[1],w,(l+180)%360);v=[T,P]}return{direction:l,trackLength:f,meanWindDirection:o[0],meanWindSpeed:o[1],latlngs:[T,F],approachLatLngs:v,approachLength:w,approachTime:gt.APPROACH_TIME_SECONDS}}function Cr(t,e,n){var N,P;if(!n||n.length===0)return{downwindLat:t,downwindLng:e};const a=parseInt(document.getElementById("canopySpeed").value)||20,i=parseFloat(document.getElementById("descentRate").value)||3.5,r=parseInt(document.getElementById("legHeightFinal").value)||100,o=parseInt(document.getElementById("legHeightBase").value)||200,l=parseInt(document.getElementById("legHeightDownwind").value)||300,c=Math.round(s.lastAltitude),u=n.map($=>$.height),d=n.map($=>-p.convertWind($.spd,"kt","km/h")*Math.sin($.dir*Math.PI/180)),h=n.map($=>-p.convertWind($.spd,"kt","km/h")*Math.cos($.dir*Math.PI/180)),g=((N=document.querySelector('input[name="landingDirection"]:checked'))==null?void 0:N.value)||"LL",f=parseInt((P=document.getElementById(g==="LL"?"customLandingDirectionLL":"customLandingDirectionRR"))==null?void 0:P.value,10);let w=Number.isFinite(f)?f:Number.isFinite(s.landingWindDir)?s.landingWindDir:n[0].dir;const v=($,U,G,R,B)=>{const Q=R*te.KNOTS_TO_MPS*B,[ae,q]=p.calculateNewCenter($,U,Q,G);return[ae,q]},y=p.calculateMeanWind(u,d,h,c,c+r),S=(w+180)%360,_=p.calculateGroundSpeed(a,p.calculateWindComponents(y[1],p.calculateWindAngle(S,y[0])).headwind),E=v(t,e,S,_,r/i),M=p.calculateMeanWind(u,d,h,c+r,c+o),b=(w+(g==="LL"?90:-90)+360)%360,k=p.calculateCourseFromHeading(b,M[0],M[1],a),A=v(E[0],E[1],(k.trueCourse+180)%360,k.groundSpeed,(o-r)/i),T=p.calculateMeanWind(u,d,h,c+o,c+l),F=p.calculateGroundSpeed(a,p.calculateWindComponents(T[1],p.calculateWindAngle(w,T[0])).headwind),D=v(A[0],A[1],w,F,(l-o)/i);return{downwindLat:D[0],downwindLng:D[1]}}async function nt(t,e,n=null){console.log("[weatherManager] Starting full weather fetch for location:",{lat:t,lng:e});const a=await bl(t,e);return document.dispatchEvent(new CustomEvent("models:available",{detail:{availableModels:a}})),await _l(t,e,n)}async function _l(t,e,n=null){var i,r;const a=document.getElementById("loading");a&&(a.style.display="block");try{const o=((i=document.getElementById("modelSelect"))==null?void 0:i.value)||m.defaultSettings.model;if(!o)throw new Error("No weather model selected.");const c=Er.API_MAP[o]||o;let u=!1,d,h;const g=I.utc().startOf("day");let f=null;if(n){let E=I.fromISO(n,{zone:"utc"});E.isValid&&(f=E.startOf("day"),f<g&&(u=!0))}else{const E=(r=document.getElementById("historicalDatePicker"))==null?void 0:r.value;if(E){let M=I.fromISO(E,{zone:"utc"}).startOf("day");M<g&&(u=!0,f=M)}}let w=Ht.FORECAST;if(u&&f)w=Ht.HISTORICAL,d=h=f.toFormat("yyyy-MM-dd"),s.lastModelRun="N/A (Historical Data)";else{let E;try{const k=`https://api.open-meteo.com/data/${c}/static/meta.json`,T=await(await fetch(k)).json();E=new Date(T.last_run_initialisation_time*1e3),s.lastModelRun=E.toISOString().replace("T"," ").substring(0,16)+"Z"}catch{E=I.utc().toJSDate(),s.lastModelRun="N/A"}let M=I.fromJSDate(E).setZone("utc").plus({hours:6});M>I.utc()&&(M=I.utc()),d=M.toFormat("yyyy-MM-dd");const b=o.includes("_d2")?2:7;h=M.plus({days:b}).toFormat("yyyy-MM-dd")}const y=`${w}?latitude=${t}&longitude=${e}&hourly=surface_pressure,temperature_2m,relative_humidity_2m,wind_speed_10m,wind_direction_10m,wind_gusts_10m,temperature_1000hPa,relative_humidity_1000hPa,wind_speed_1000hPa,wind_direction_1000hPa,geopotential_height_1000hPa,temperature_950hPa,relative_humidity_950hPa,wind_speed_950hPa,wind_direction_950hPa,geopotential_height_950hPa,temperature_925hPa,relative_humidity_925hPa,wind_speed_925hPa,wind_direction_925hPa,geopotential_height_925hPa,temperature_900hPa,relative_humidity_900hPa,wind_speed_900hPa,wind_direction_900hPa,geopotential_height_900hPa,temperature_850hPa,relative_humidity_850hPa,wind_speed_850hPa,wind_direction_850hPa,geopotential_height_850hPa,temperature_800hPa,relative_humidity_800hPa,wind_speed_800hPa,wind_direction_800hPa,geopotential_height_800hPa,temperature_700hPa,relative_humidity_700hPa,wind_speed_700hPa,wind_direction_700hPa,geopotential_height_700hPa,temperature_600hPa,relative_humidity_600hPa,wind_speed_600hPa,wind_direction_600hPa,geopotential_height_600hPa,temperature_500hPa,relative_humidity_500hPa,wind_speed_500hPa,wind_direction_500hPa,geopotential_height_500hPa,temperature_400hPa,relative_humidity_400hPa,wind_speed_400hPa,wind_direction_400hPa,geopotential_height_400hPa,temperature_300hPa,relative_humidity_300hPa,wind_speed_300hPa,wind_direction_300hPa,geopotential_height_300hPa,temperature_250hPa,relative_humidity_250hPa,wind_speed_250hPa,wind_direction_250hPa,geopotential_height_250hPa,temperature_200hPa,relative_humidity_200hPa,wind_speed_200hPa,wind_direction_200hPa,geopotential_height_200hPa&models=${o}&start_date=${d}&end_date=${h}`,S=await fetch(y);if(!S.ok)throw S.status===429?new Error("API-Limit erreicht. Bitte warten Sie einen Moment und versuchen Sie es erneut."):new Error(`HTTP error! Status: ${S.status}`);const _=await S.json();if(!_.hourly||!_.hourly.time||!_.hourly.time.length)throw new Error("No hourly data in API response.");return _.hourly}catch(o){return console.error("[fetchWeather] Error:",o),displayError(`Failed to fetch weather: ${o.message}`),null}finally{a&&(a.style.display="none")}}async function bl(t,e){const n=Er.LIST;let a=[];for(const i of n)try{const r=await fetch(`${Ht.FORECAST}?latitude=${t}&longitude=${e}&hourly=temperature_2m&models=${i}`);if(r.ok){const o=await r.json();o.hourly&&o.hourly.temperature_2m&&o.hourly.temperature_2m.some(l=>l!==null)&&a.push(i)}else r.status===429?console.warn(`API-Limit beim Prüfen von Modell '${i}' erreicht.`):console.warn(`Modell '${i}' ist nicht verfügbar (Server-Antwort: ${r.status})`)}catch(r){console.error(`Netzwerkfehler beim Abruf von Modell '${i}':`,r)}return a}function lt(t,e,n,a,i){if(!t||!t.time||e>=t.time.length)return console.warn("No weather data provided or index out of bounds for interpolation"),[];a=Math.round(s.lastAltitude),i=m.getValue("heightUnit","m");const o=vl.filter(T=>{var D;const F=(D=t[`geopotential_height_${T}hPa`])==null?void 0:D[e];return F!=null});if(o.length<2)return console.warn("Insufficient valid pressure level data for interpolation:",o),[];let l=o.map(T=>t[`geopotential_height_${T}hPa`][e]),c=o.map(T=>t[`temperature_${T}hPa`][e]),u=o.map(T=>t[`relative_humidity_${T}hPa`][e]),d=o.map(T=>t[`wind_speed_${T}hPa`][e]),h=o.map(T=>t[`wind_direction_${T}hPa`][e]);const g=t.surface_pressure[e];if(g==null)return console.warn("Surface pressure missing"),[];let f=d.map((T,F)=>-T*Math.sin(h[F]*Math.PI/180)),w=d.map((T,F)=>-T*Math.cos(h[F]*Math.PI/180));const v=Math.max(...o),y=t[`geopotential_height_${v}hPa`][e];if(g>v&&Number.isFinite(y)&&y>a){const T=Math.floor((y-a)/n),F=-t.wind_speed_10m[e]*Math.sin(t.wind_direction_10m[e]*Math.PI/180),D=-t.wind_speed_10m[e]*Math.cos(t.wind_direction_10m[e]*Math.PI/180),N=f[o.indexOf(v)],P=w[o.indexOf(v)];for(let $=T-1;$>=1;$--){const U=a+$*n;if(U>=y)continue;const G=(U-a)/(y-a),R=Math.log(g),B=Math.log(v),V=R+G*(B-R),Q=Math.exp(V),ae=Math.log(U-a+1),q=Math.log(1),Ze=Math.log(y-a),be=p.linearInterpolate([q,Ze],[F,N],ae),De=p.linearInterpolate([q,Ze],[D,P],ae),At=p.windSpeed(be,De),ut=p.windDirection(be,De);l.unshift(U),o.unshift(Q),c.unshift(p.linearInterpolate([a,y],[t.temperature_2m[e],t[`temperature_${v}hPa`][e]],U)),u.unshift(p.linearInterpolate([a,y],[t.relative_humidity_2m[e],t[`relative_humidity_${v}hPa`][e]],U)),d.unshift(At),h.unshift(ut),f.unshift(be),w.unshift(De)}l.unshift(a),o.unshift(g),c.unshift(t.temperature_2m[e]),u.unshift(t.relative_humidity_2m[e]),d.unshift(t.wind_speed_10m[e]),h.unshift(t.wind_direction_10m[e]),f.unshift(F),w.unshift(D)}const S=o.indexOf(Math.min(...o)),_=l[S],E=_-a;if(E<=0||isNaN(E))return console.warn("Invalid max height at lowest pressure level:",{maxHeightASL:_,baseHeight:a,minPressure:o[S]}),[];const M=i==="ft"?E*3.28084:E,b=Math.floor(M/n),k=Array.from({length:b+1},(T,F)=>F*n);console.log("Interpolating up to lowest pressure level:",{maxHeightAGL:E,minPressure:o[S],interpStep:n});const A=[];return k.forEach(T=>{const F=i==="ft"?T/3.28084:T,D=a+F;let N;if(F===0)N={height:D,pressure:g,temp:t.temperature_2m[e],rh:t.relative_humidity_2m[e],spd:t.wind_speed_10m[e],dir:t.wind_direction_10m[e],dew:p.calculateDewpoint(t.temperature_2m[e],t.relative_humidity_2m[e])};else{const P=p.interpolatePressure(D,o,l),$=p.interpolateWindAtAltitude(D,o,l,f,w),U=p.windSpeed($.u,$.v),G=p.windDirection($.u,$.v),R=p.linearInterpolate(l,c,D),B=p.linearInterpolate(l,u,D),V=p.calculateDewpoint(R,B);N={height:D,pressure:P==="N/A"?"N/A":Number(P.toFixed(1)),temp:Number(R.toFixed(1)),rh:Number(B.toFixed(0)),spd:Number(U.toFixed(1)),dir:Number(G.toFixed(0)),dew:Number(V.toFixed(1))}}N.displayHeight=T,A.push(N)}),console.log("Interpolated data length:",A.length,"Max height:",A[A.length-1].displayHeight),A}p.debounce(async(t,e)=>{try{const n=await p.getElevationAndQFE(t,e,s.apiKey);if(n){const a=document.getElementById("elevation"),i=document.getElementById("qfe");a&&(a.value=n.elevation.toFixed(1)),i&&(i.value=n.qfe.toFixed(2)),s.currentElevation=n.elevation,m.state.userSettings.qfe=n.qfe}}catch(n){console.error("Error fetching elevation and QFE:",n)}},500);async function Ir(){if(!s.lastLat||!s.lastLng)return p.handleMessage("Please select a location first."),!1;if(!m.state.userSettings.selectedEnsembleModels||m.state.userSettings.selectedEnsembleModels.length===0)return s.ensembleModelsData=null,Ma(),!0;const t=document.getElementById("loading");t&&(t.style.display="block");try{const e=s.lastLat,n=s.lastLng,a=m.state.userSettings.selectedEnsembleModels,i=a.join(","),r=["surface_pressure","temperature_2m","relative_humidity_2m","wind_speed_10m","wind_direction_10m","geopotential_height_1000hPa","temperature_1000hPa","relative_humidity_1000hPa","wind_speed_1000hPa","wind_direction_1000hPa","geopotential_height_950hPa","temperature_950hPa","relative_humidity_950hPa","wind_speed_950hPa","wind_direction_950hPa","geopotential_height_925hPa","temperature_925hPa","relative_humidity_925hPa","wind_speed_925hPa","wind_direction_925hPa","geopotential_height_900hPa","temperature_900hPa","relative_humidity_900hPa","wind_speed_900hPa","wind_direction_900hPa","geopotential_height_850hPa","temperature_850hPa","relative_humidity_850hPa","wind_speed_850hPa","wind_direction_850hPa","geopotential_height_800hPa","temperature_800hPa","relative_humidity_800hPa","wind_speed_800hPa","wind_direction_800hPa","geopotential_height_700hPa","temperature_700hPa","relative_humidity_700hPa","wind_speed_700hPa","wind_direction_700hPa","geopotential_height_600hPa","temperature_600hPa","relative_humidity_600hPa","wind_speed_600hPa","wind_direction_600hPa","geopotential_height_500hPa","temperature_500hPa","relative_humidity_500hPa","wind_speed_500hPa","wind_direction_500hPa","geopotential_height_400hPa","temperature_400hPa","relative_humidity_400hPa","wind_speed_400hPa","wind_direction_400hPa","geopotential_height_300hPa","temperature_300hPa","relative_humidity_300hPa","wind_speed_300hPa","wind_direction_300hPa","geopotential_height_250hPa","temperature_250hPa","relative_humidity_250hPa","wind_speed_250hPa","wind_direction_250hPa","geopotential_height_200hPa","temperature_200hPa","relative_humidity_200hPa","wind_speed_200hPa","wind_direction_200hPa"],o=r.join(","),l=document.getElementById("historicalDatePicker"),c=l?l.value:null,u=c?I.fromISO(c,{zone:"utc"}):null,d=I.utc().startOf("day"),h=u&&u<d;let g,f,w=Ht.FORECAST;if(h)w=Ht.HISTORICAL,g=u.toFormat("yyyy-MM-dd"),f=g;else{const E=I.utc();g=E.toFormat("yyyy-MM-dd"),f=E.plus({days:7}).toFormat("yyyy-MM-dd")}const v=`${w}?latitude=${e}&longitude=${n}&hourly=${o}&models=${i}&start_date=${g}&end_date=${f}`,y=await fetch(v);if(!y.ok)throw y.status===429?new Error("API-Limit für Ensemble-Daten erreicht. Bitte warten Sie einen Moment."):new Error(`API request failed: ${y.status}`);const S=await y.json();s.ensembleModelsData={};const _=S.hourly.time;return a.forEach(E=>{const M={time:[..._]};let b=!1;r.forEach(k=>{const A=`${k}_${E}`;S.hourly[A]?(M[k]=S.hourly[A],b=!0):M[k]=null}),b&&(s.ensembleModelsData[E]=M)}),!0}catch{return!1}finally{t&&(t.style.display="none")}}function Ma(){s.ensembleLayerGroup&&s.map.removeLayer(s.ensembleLayerGroup),s.heatmapLayer&&s.map.removeLayer(s.heatmapLayer),s.heatmapLayer=null,s.ensembleScenarioCircles={},s.ensembleLayerGroup=L.layerGroup().addTo(s.map),console.log("Ensemble visualizations cleared and a new, clean layer group was created.")}function Nr(t,e){if(Ma(),!s.ensembleModelsData||Object.keys(s.ensembleModelsData).length===0)return;const n=m.state.userSettings.currentEnsembleScenario;if(console.log(`Processing ensemble scenario: ${n} for slider index: ${t}`),n==="heatmap")Al(t,e);else if(n==="all_models"){for(const a in s.ensembleModelsData)if(Object.hasOwnProperty.call(s.ensembleModelsData,a)){const i=s.ensembleModelsData[a],r=aa(a,t,{hourly:i});r&&hi(r,El(a),a)}}else{const a=kl(n);if(a){const i=aa(n,t,a);i&&hi(i,Tl(n),n.replace("_"," "))}}}function El(t){let e=0;for(let a=0;a<t.length;a++)e=t.charCodeAt(a)+((e<<5)-e),e=e&e;return`hsl(${e%360}, 70%, 60%)`}function Tl(t){return t==="min_wind"?me.SCENARIO_COLORS.MIN_WIND:t==="mean_wind"?me.SCENARIO_COLORS.MEAN_WIND:t==="max_wind"?me.SCENARIO_COLORS.MAX_WIND:"rgba(128, 128, 128, 0.7)"}function hi(t,e,n){var v,y;if(!s.map||!t||!s.ensembleLayerGroup)return;const a=[t.centerLat,t.centerLng],i=L.circle(a,{radius:t.radius,color:e,fillColor:e,fillOpacity:.15,weight:2,dashArray:"5, 10"}).addTo(s.ensembleLayerGroup),r=m.getValue("windUnit","kt");let o="N/A";if(t.meanWindSpeedMps!=="N/A"&&Number.isFinite(t.meanWindSpeedMps)){const S=p.convertWind(t.meanWindSpeedMps,r,"m/s");S!=="N/A"&&Number.isFinite(S)&&(o=r==="bft"?Math.round(S):S.toFixed(1))}const l=parseInt((v=document.getElementById("openingAltitude"))==null?void 0:v.value)||m.state.userSettings.openingAltitude||1200,c=parseInt((y=document.getElementById("legHeightDownwind"))==null?void 0:y.value)||m.state.userSettings.legHeightDownwind||0,u=l-200,d=m.getValue("heightUnit","m"),h=Math.round(p.convertHeight(c,d)),g=Math.round(p.convertHeight(u,d)),f=t.meanWindDir!=="N/A"&&Number.isFinite(t.meanWindDir)?p.roundToTens(t.meanWindDir):"N/A",w=`<strong>${n}</strong><br>Mean Wind ${h}-${g} ${d} AGL:<br>${f}° ${o} ${r}`;i.bindTooltip(w,{permanent:!1,direction:"top",className:"wind-tooltip",opacity:.9}),s.ensembleScenarioCircles[n]=i,console.log(`Drew ensemble circle for ${n} at [${a.join(", ")}], radius ${t.radius}`)}function kl(t,e){var d;if(!s.ensembleModelsData||Object.keys(s.ensembleModelsData).length===0)return console.warn("No ensemble data available for profile calculation."),null;if(Object.keys(s.ensembleModelsData).length===0)return null;console.log(`Calculating full time-series ensemble profile for: ${t}`);const a={},i=Object.keys(s.ensembleModelsData)[0],r=(d=s.ensembleModelsData[i])==null?void 0:d.time;if(!r||r.length===0)return console.error("Time data missing or empty in the first ensemble model for profile calculation."),null;a.time=[...r];const o=a.time.length,l=["surface_pressure","temperature_2m","relative_humidity_2m","geopotential_height_1000hPa","temperature_1000hPa","relative_humidity_1000hPa","geopotential_height_950hPa","temperature_950hPa","relative_humidity_950hPa","geopotential_height_925hPa","temperature_925hPa","relative_humidity_925hPa","geopotential_height_900hPa","temperature_900hPa","relative_humidity_900hPa","geopotential_height_850hPa","temperature_850hPa","relative_humidity_850hPa","geopotential_height_800hPa","temperature_800hPa","relative_humidity_800hPa","geopotential_height_700hPa","temperature_700hPa","relative_humidity_700hPa","geopotential_height_600hPa","temperature_600hPa","relative_humidity_600hPa","geopotential_height_500hPa","temperature_500hPa","relative_humidity_500hPa","geopotential_height_400hPa","temperature_400hPa","relative_humidity_400hPa","geopotential_height_300hPa","temperature_300hPa","relative_humidity_300hPa","geopotential_height_250hPa","temperature_250hPa","relative_humidity_250hPa","geopotential_height_200hPa","temperature_200hPa","relative_humidity_200hPa"],c=[["wind_speed_10m","wind_direction_10m"]];[1e3,950,925,900,850,800,700,600,500,400,300,250,200].forEach(h=>{c.push([`wind_speed_${h}hPa`,`wind_direction_${h}hPa`])}),l.forEach(h=>{a[h]=new Array(o).fill(null)}),c.forEach(h=>{a[h[0]]=new Array(o).fill(null),a[h[1]]=new Array(o).fill(null)});for(let h=0;h<o;h++)l.forEach(g=>{const f=[];for(const w in s.ensembleModelsData){const v=s.ensembleModelsData[w];if(v&&v[g]){const y=v[g][h];y!=null&&!isNaN(y)&&f.push(y)}}f.length>0&&(t==="min_wind"?a[g][h]=Math.min(...f):t==="max_wind"?a[g][h]=Math.max(...f):a[g][h]=f.reduce((w,v)=>w+v,0)/f.length)}),c.forEach(g=>{const f=g[0],w=g[1];let v=[],y=[],S=[],_=[];for(const E in s.ensembleModelsData){const M=s.ensembleModelsData[E];if(M&&M[f]&&M[w]){const b=M[f][h],k=M[w][h];b!=null&&!isNaN(b)&&k!==null&&k!==void 0&&!isNaN(k)&&(S.push(b),_.push(k),v.push(-b*Math.sin(k*Math.PI/180)),y.push(-b*Math.cos(k*Math.PI/180)))}}if(S.length>0)if(t==="min_wind"){const E=Math.min(...S),M=S.indexOf(E);a[f][h]=E,a[w][h]=_[M]}else if(t==="max_wind"){const E=Math.max(...S),M=S.indexOf(E);a[f][h]=E,a[w][h]=_[M]}else{const E=v.reduce((b,k)=>b+k,0)/v.length,M=y.reduce((b,k)=>b+k,0)/y.length;a[f][h]=p.windSpeed(E,M),a[w][h]=p.windDirection(E,M)}});return{hourly:a}}function aa(t,e,n=null){var u,d;if(console.log(`Calculating exit circle for ensemble profile/model: ${t} at index ${e}`),e==null)return console.error("sliderIndex is undefined in calculateExitCircleForEnsemble. Aborting."),null;let a;if(n)a=n;else if(s.ensembleModelsData&&s.ensembleModelsData[t])a={hourly:s.ensembleModelsData[t]};else return console.warn(`No data for profile/model ${t} in calculateExitCircleForEnsemble found.`),null;if(!a.hourly||!s.lastLat||!s.lastLng||s.lastAltitude==="N/A")return console.warn(`Incomplete data for calculateExitCircleForEnsemble: ${t}`),null;const i=st(),r=m.getValue("heightUnit","m"),o=s.weatherData;s.weatherData=a.hourly;let l=null,c={meanWindDir:"N/A",meanWindSpeedMps:"N/A"};try{const h=m.state.userSettings.calculateJump,g=m.state.userSettings.showExitArea;m.state.userSettings.calculateJump=!0,m.state.userSettings.showExitArea=!0;const f=lt(s.weatherData,e,i,Math.round(s.lastAltitude),r);if(f&&f.length>0){l=Ar(f);const w=f.map(A=>A.height),v=f.map(A=>-p.convertWind(A.spd,"m/s","km/h")*Math.sin(A.dir*Math.PI/180)),y=f.map(A=>-p.convertWind(A.spd,"m/s","km/h")*Math.cos(A.dir*Math.PI/180)),S=parseInt((u=document.getElementById("openingAltitude"))==null?void 0:u.value)||1200,_=parseInt((d=document.getElementById("legHeightDownwind"))==null?void 0:d.value)||0,E=Math.round(s.lastAltitude),M=E+S-200,b=E+_,k=p.calculateMeanWind(w,v,y,b,M);k&&Number.isFinite(k[0])&&Number.isFinite(k[1])&&(c={meanWindDir:k[0],meanWindSpeedMps:k[1]})}m.state.userSettings.calculateJump=h,m.state.userSettings.showExitArea=g}catch(h){console.error(`Error in calculateExitCircle for profile ${t}:`,h),l=null}finally{s.weatherData=o}return l?{centerLat:l.darkGreenLat,centerLng:l.darkGreenLng,radius:l.darkGreenRadius,meanWindDir:c.meanWindDir,meanWindSpeedMps:c.meanWindSpeedMps}:(console.warn(`calculateExitCircle returned null for profile ${t}`),null)}function Al(t,e){if(Ma(),s.heatmapLayer&&(s.map.removeLayer(s.heatmapLayer),s.heatmapLayer=null),!s.ensembleModelsData||Object.keys(s.ensembleModelsData).length<2){p.handleMessage("Please select at least two ensemble models to generate a heatmap.");return}const n=[];for(const h in s.ensembleModelsData)if(Object.hasOwnProperty.call(s.ensembleModelsData,h)){s.ensembleModelsData[h];const g=aa(h,t,e);g&&n.push({centerLat:g.centerLat,centerLng:g.centerLng,radius:g.radius})}if(n.length===0){console.warn("Could not calculate any circles for the heatmap.");return}console.log(`[Heatmap] Calculated ${n.length} model circles.`);let a=90,i=-90,r=180,o=-180;const l=111320;n.forEach(h=>{const g=h.radius/l,f=h.radius/(l*Math.cos(h.centerLat*Math.PI/180));a=Math.min(a,h.centerLat-g),i=Math.max(i,h.centerLat+g),r=Math.min(r,h.centerLng-f),o=Math.max(o,h.centerLng+f)});const c=40,u=c/l,d=[];console.log("[Heatmap] Starting grid calculation...");for(let h=a;h<=i;h+=u){const g=c/(l*Math.cos(h*Math.PI/180));for(let f=r;f<=o;f+=g){let w=0;const v=L.latLng(h,f);n.forEach(y=>{const S=L.latLng(y.centerLat,y.centerLng);s.map.distance(v,S)<=y.radius&&w++}),w>0&&d.push([h,f,w])}}if(console.log(`[Heatmap] Finished grid calculation. Generated ${d.length} heatmap points.`),d.length>0){const h=n.length,g={};if(h===1)g[1]="lime";else for(let w=1;w<=h;w++){const v=w/h;w===1?g[v]="red":w<h?g[v]="yellow":g[v]="lime"}console.log("[Heatmap] Using gradient:",g),s.heatmapLayer&&s.map.removeLayer(s.heatmapLayer);const f=p.calculateDynamicRadius(me.HEATMAP_BASE_RADIUS,me.HEATMAP_REFERENCE_ZOOM);s.heatmapLayer=L.heatLayer(d,{radius:f,blur:10,max:h,minOpacity:.01,gradient:g}).addTo(s.map)}else p.handleMessage("No overlapping landing areas found for the selected models.")}function Fr(){var t;return parseInt((t=document.getElementById("timeSlider"))==null?void 0:t.value)||0}const le={dbName:"SkydivingTileCache",storeName:"tiles",db:null,async init(){return new Promise((t,e)=>{const n=indexedDB.open(this.dbName,1);n.onupgradeneeded=a=>{a.target.result.createObjectStore(this.storeName,{keyPath:"url"})},n.onsuccess=a=>{this.db=a.target.result,t()},n.onerror=a=>{console.error("IndexedDB initialization failed:",a),e(a)}})},async storeTile(t,e){return this.db||await this.init(),new Promise((n,a)=>{const o=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).put({url:t,blob:e,timestamp:Date.now()});o.onsuccess=()=>{console.log(`Stored tile: ${t}`),n(!0)},o.onerror=l=>{console.warn(`Failed to store tile: ${t}`,l),p.handleError("Failed to store some tiles. Try clearing cache."),a(l)}})},async getTile(t){return this.db||await this.init(),new Promise((e,n)=>{const i=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName),r=i.get(t);r.onsuccess=o=>{const l=o.target.result;if(l)e(l.blob);else{const c=[t.replace("https://tile.opentopomap.org","https://a.tile.opentopomap.org"),t.replace("https://tile.opentopomap.org","https://b.tile.opentopomap.org"),t.replace("https://tile.opentopomap.org","https://c.tile.opentopomap.org"),t.replace("https://tile.openstreetmap.org","https://a.tile.openstreetmap.org"),t.replace("https://tile.openstreetmap.org","https://b.tile.openstreetmap.org"),t.replace("https://tile.openstreetmap.org","https://c.tile.openstreetmap.org"),t.replace("https://basemaps.cartocdn.com","https://a.basemaps.cartocdn.com"),t.replace("https://basemaps.cartocdn.com","https://b.basemaps.cartocdn.com"),t.replace("https://basemaps.cartocdn.com","https://c.basemaps.cartocdn.com"),t.replace("https://basemaps.cartocdn.com","https://d.basemaps.cartocdn.com")];let u=null;for(const d of c){if(d===t)continue;const h=i.get(d);h.onsuccess=g=>{const f=g.target.result;f&&(u=f.blob,e(u))},h.onerror=()=>{}}setTimeout(()=>{u||e(null)},100)}},r.onerror=o=>{console.warn(`Failed to retrieve tile: ${t}`,o),n(o)}})},async clearCache(){return this.db||await this.init(),new Promise((t,e)=>{const i=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();i.onsuccess=()=>{console.log("Tile cache cleared"),t()},i.onerror=r=>{console.error("Failed to clear cache:",r),e(r)}})},async clearOldTiles(t=_n.MAX_AGE_DAYS){this.db||await this.init();const e=t*24*60*60*1e3;return new Promise((n,a)=>{const o=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).openCursor();let l=0,c=0;o.onsuccess=u=>{const d=u.target.result;if(d)Date.now()-d.value.timestamp>e&&(c+=d.value.blob.size||0,d.delete(),l++),d.continue();else{const h=c/1048576;console.log(`Cleared ${l} old tiles, freed ${h.toFixed(2)} MB`),n({deletedCount:l,deletedSizeMB:h})}},o.onerror=u=>{console.error("Failed to clear old tiles:",u),a(u)}})},async getCacheSize(){return this.db||await this.init(),new Promise((t,e)=>{const i=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).openCursor();let r=0,o=0;i.onsuccess=l=>{var u;const c=l.target.result;if(c)try{const d=((u=c.value.blob)==null?void 0:u.size)||0;typeof d!="number"||isNaN(d)?console.warn(`Invalid blob size for tile: ${c.value.url}, size: ${d}`):(r+=d,o++),c.continue()}catch(d){console.warn(`Error processing tile during size calculation: ${c.value.url}`,d),c.continue()}else{const d=r/1048576;console.log(`Cache size calculation completed: ${d.toFixed(2)} MB, ${o} tiles`),t(d)}},i.onerror=l=>{console.error("Failed to calculate cache size:",l),e(l)}})},async migrateTiles(){return this.db||await this.init(),new Promise((t,e)=>{const a=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName),i=a.openCursor();let r=0;i.onsuccess=o=>{const l=o.target.result;if(l){const{url:c,blob:u,timestamp:d}=l.value,h=c.replace(/^(https?:\/\/[a-c]\.tile\.openstreetmap\.org)/,"https://tile.openstreetmap.org").replace(/^(https?:\/\/[a-d]\.basemaps\.cartocdn\.com)/,"https://basemaps.cartocdn.com").replace(/^(https?:\/\/[a-c]\.tile\.opentopomap\.org)/,"https://tile.opentopomap.org");c!==h&&(l.delete(),a.put({url:h,blob:u,timestamp:d}),r++),l.continue()}else console.log(`Migrated ${r} tiles to normalized URLs`),t()},i.onerror=o=>{console.error("Failed to migrate tiles:",o),e(o)}})}};L.TileLayer.Cached=L.TileLayer.extend({createTile(t,e){const n=document.createElement("img");L.DomEvent.on(n,"load",()=>{console.log("Tile loaded:",this.getTileUrl(t)),e(null,n)}),L.DomEvent.on(n,"error",()=>{console.warn("Tile error:",this.getTileUrl(t)),e(new Error("Failed to load tile"),n)});const a=this.getTileUrl(t);n.setAttribute("role","presentation");const i=a.replace(/^(https?:\/\/[a-c]\.tile\.openstreetmap\.org)/,"https://tile.openstreetmap.org").replace(/^(https?:\/\/[a-d]\.basemaps\.cartocdn\.com)/,"https://basemaps.cartocdn.com").replace(/^(https?:\/\/[a-c]\.tile\.opentopomap\.org)/,"https://tile.opentopomap.org");return!navigator.onLine&&(t.z<11||t.z>14)?(console.log(`Skipping tile request outside cached zoom levels (11–14): ${a}`),p.handleError("Offline: Zoom restricted to levels 11–14 for cached tiles."),e(new Error("Zoom level not cached"),n),n):(navigator.onLine?(n.src=a,fetch(a,{signal:AbortSignal.timeout(_n.FETCH_TIMEOUT_MS)}).then(r=>{if(!r.ok)throw new Error(`HTTP ${r.status}`);return r.blob()}).then(r=>{le.storeTile(i,r).catch(o=>console.warn("Failed to cache tile during rendering:",i,o))}).catch(r=>{console.warn("Fetch error for tile during rendering:",a,r),le.getTile(i).then(o=>{o?(n.src=URL.createObjectURL(o),console.log(`Tile loaded from cache (fallback): ${i}`)):e(r,n)}).catch(o=>{console.warn("Cache fallback error:",i,o),e(o,n)})})):le.getTile(i).then(r=>{r?(n.src=URL.createObjectURL(r),console.log(`Tile loaded from cache: ${i}`)):(console.warn(`Tile not in cache: ${i}`),p.handleError("This area is not cached. Please cache more tiles while online."),e(new Error("Tile not in cache"),n))}).catch(r=>{console.warn("Cache error for offline tile:",i,r),p.handleError("This area is not cached. Please cache more tiles while online."),e(r,n)}),n)}});L.tileLayer.cached=function(t,e){return new L.TileLayer.Cached(t,e)};function Cl(t,e,n,a,i){if(!i)return console.warn("Map not initialized, cannot calculate tiles"),[];const r=new Set,o=40075016686e-3,l=n*1e3;return a.forEach(c=>{const u=i.project([t,e],c),d=256,h=u.x/d,g=u.y/d,f=t*Math.PI/180,w=o*Math.cos(f)/(d*Math.pow(2,c)),v=Math.ceil(l/(w*d))+1,y=Math.pow(2,c);for(let S=Math.floor(h-v);S<=Math.ceil(h+v);S++)for(let _=Math.floor(g-v);_<=Math.ceil(g+v);_++)S>=0&&S<y&&_>=0&&_<y&&r.add(`${c}/${S}/${_}`)}),Array.from(r).map(c=>{const[u,d,h]=c.split("/").map(Number);return{zoom:u,x:d,y:h}})}async function Il(t,e=3){let n=null;for(let a=1;a<=e;a++){try{const i=new AbortController,r=setTimeout(()=>i.abort(),_n.FETCH_TIMEOUT_MS),o=await fetch(t,{signal:i.signal});if(clearTimeout(r),o.ok)return{success:!0,blob:await o.blob()};console.warn(`Attempt ${a} failed for ${t}: HTTP ${o.status}`),n=new Error(`HTTP ${o.status}`)}catch(i){console.warn(`Attempt ${a} error for ${t}: ${i.message}`),n=i,i.name==="AbortError"&&console.warn(`Fetch timeout after 15s for ${t}`)}a<e&&await new Promise(i=>setTimeout(i,1e3))}return{success:!1,error:n}}async function Dr({map:t,lastLat:e,lastLng:n,baseMaps:a,onProgress:i,onComplete:r,onCancel:o}){if(!t){r&&r("Map not initialized, cannot cache tiles.");return}if(!e||!n){r&&r("Please select a location to cache map tiles.");return}const l=m.state.userSettings.cacheRadiusKm||m.defaultSettings.cacheRadiusKm,c=m.state.userSettings.cacheZoomLevels||m.defaultSettings.cacheZoomLevels,u=Cl(e,n,l,c,t),d=[];if(m.state.userSettings.baseMaps==="Esri Satellite + OSM")d.push({name:"Esri Satellite",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",normalizedUrl:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"},{name:"OSM Overlay",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",subdomains:["a","b","c"],normalizedUrl:"https://tile.openstreetmap.org/{z}/{x}/{y}.png"});else{const y=a[m.state.userSettings.baseMaps];y&&d.push({name:m.state.userSettings.baseMaps,url:y.options.url||y._url,subdomains:y.options.subdomains,normalizedUrl:(y.options.url||y._url).replace(/{s}\./,"")})}const h=u.length*d.length;if(h===0){r&&r("No tiles to cache for this basemap.");return}let g=0,f=0;const w=[];s.isCachingCancelled=!1,console.log("Calling displayProgress with initial values:",{cachedCount:g,failedCount:f,totalTiles:h}),i&&i(0,h,()=>{s.isCachingCancelled=!0,o&&o()});try{for(const y of d){if(console.log("Processing layer:",y.name),s.isCachingCancelled){console.log("Caching cancelled by user");break}const S=u.map(async(_,E)=>{if(s.isCachingCancelled){console.log("Caching cancelled during tile processing");return}const M=y.url.replace("{z}",_.zoom).replace("{x}",_.x).replace("{y}",_.y).replace("{s}",y.subdomains?y.subdomains[Math.floor(Math.random()*y.subdomains.length)]:""),b=y.normalizedUrl.replace("{z}",_.zoom).replace("{x}",_.x).replace("{y}",_.y);if(console.log(`Processing tile ${E+1}/${u.length} for layer ${y.name}:`,{url:M,normalizedUrl:b}),await le.getTile(b).catch(T=>(console.error(`Error retrieving tile from cache: ${b}`,T),null)))g++,console.log(`Tile ${E+1} already in cache`);else{const T=await Il(M);T.success?await le.storeTile(b,T.blob).catch(D=>(console.error(`Error storing tile: ${b}`,D),!1))?(g++,console.log(`Tile ${E+1} cached successfully`)):(f++,w.push(M),console.log(`Tile ${E+1} failed to store`)):(f++,w.push(M),console.log(`Tile ${E+1} failed to fetch:`,T.error.message))}const A=g+f;((E+1)%10===0||E===u.length-1)&&(console.log("Updating progress:",{currentCount:A,totalTiles:h}),i&&i(A,h,()=>{s.isCachingCancelled=!0}))});console.log(`Processing batch of ${u.length} tiles for layer ${y.name}`);for(let _=0;_<S.length;_+=20){if(s.isCachingCancelled){console.log("Caching cancelled during batch processing");break}const E=S.slice(_,_+20);await Promise.all(E).catch(M=>{console.error("Error processing batch of tiles:",M)}),console.log(`Completed batch ${_/20+1} for layer ${y.name}`)}}}catch(y){console.error("Unexpected error in cacheTilesForDIP:",y),p.handleError("Failed to cache map tiles: "+y.message)}finally{if(console.log("Hiding progress bar"),r){let y="";s.isCachingCancelled?y=`Caching cancelled: ${g} tiles cached, ${f} failed.`:f>0?y=`Cached ${g} tiles around DIP (${f} failed).`:y=`Cached ${g} tiles around DIP successfully.`,r(y)}}w.length>0&&console.warn(`Failed to cache ${w.length} tiles:`,w),console.log(`DIP caching complete: ${g} tiles cached, ${f} failed`);let v="";s.isCachingCancelled?v=`Caching cancelled: ${g} tiles cached, ${f} failed.`:f>0?v=`Cached ${g} tiles around DIP (${f} failed).`:v=`Cached ${g} tiles around DIP successfully.`,r&&r(v);try{const y=await le.getCacheSize();console.log(`Cache size after DIP caching: ${y.toFixed(2)} MB`),y>_n.SIZE_LIMIT_MB_WARNING&&p.handleError(`Cache size large (${y.toFixed(2)} MB). Consider clearing cache to free up space.`)}catch(y){console.error("Failed to check cache size after DIP caching:",y),p.handleError("Unable to check cache size. Consider clearing cache to free up space.")}}async function Sa({map:t,baseMaps:e,onProgress:n,onComplete:a,onCancel:i}){if(!t||!navigator.onLine){console.log("Skipping visible tile caching: offline or map not initialized");return}const r=t.getBounds(),o=t.getZoom(),l=m.state.userSettings.cacheZoomLevels||m.defaultSettings.cacheZoomLevels;if(!l.includes(o)){console.log(`Skipping caching: zoom ${o} not in cacheZoomLevels`,l);return}const c=256,u=t.project(r.getSouthWest(),o),d=t.project(r.getNorthEast(),o),h=Math.floor(u.x/c),g=Math.floor(d.x/c),f=Math.floor(d.y/c),w=Math.floor(u.y/c),v=[];for(let M=h;M<=g;M++)for(let b=f;b<=w;b++){const k=2**o;M>=0&&M<k&&b>=0&&b<k&&v.push({zoom:o,x:M,y:b})}console.log(`Caching ${v.length} visible tiles at zoom ${o} for ${m.state.userSettings.baseMaps}`);const y=[];if(!e[m.state.userSettings.baseMaps]){console.warn(`Base map ${m.state.userSettings.baseMaps} not found, skipping caching`),a&&a("Selected base map not available for caching.");return}if(m.state.userSettings.baseMaps==="Esri Satellite + OSM")y.push({name:"Esri Satellite",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",normalizedUrl:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"},{name:"OSM Overlay",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",subdomains:["a","b","c"],normalizedUrl:"https://tile.openstreetmap.org/{z}/{x}/{y}.png"});else{const M=e[m.state.userSettings.baseMaps];y.push({name:m.state.userSettings.baseMaps,url:M.options.url||M._url,subdomains:M.options.subdomains,normalizedUrl:(M.options.url||M._url).replace(/{s}\./,"")})}let S=0,_=0;const E=v.length*y.length;s.isCachingCancelled=!1,n&&n(0,E,()=>{s.isCachingCancelled=!0,i&&i()});for(const M of y){if(s.isCachingCancelled)break;const b=v.map(async(k,A)=>{n&&n(S+_,E,()=>{s.isCachingCancelled=!0,i&&i()})});await Promise.all(b)}a&&a("Visible tiles cached.")}function rt(){const t="ontouchstart"in window||navigator.maxTouchPoints>0,e=window.Capacitor&&window.Capacitor.isNativePlatform();return t||e}function Nl(){rt()&&document.body.classList.add("touch-device")}function Ge(t){console.log("displayMessage called with:",t);let e=document.getElementById("message");e||(e=document.createElement("div"),e.id="message",e.style.position="fixed",e.style.top="5px",e.style.right="5px",e.style.width=rt()?"70%":"30%",e.style.backgroundColor="#ccffcc",e.style.borderRadius="5px 5px 5px 5px",e.style.color="#000000",e.style.padding="6px",e.style.zIndex="9998",e.style.textAlign="center",document.body.appendChild(e),window.addEventListener("resize",()=>{e.style.width=rt()?"70%":"30%"})),e.textContent=t,e.style.display="block",clearTimeout(window.messageTimeout),window.messageTimeout=setTimeout(()=>{e.style.display="none"},Se.MESSAGE_TIMEOUT_MS)}function zt(t,e,n){const a=Math.round(t/e*100);let i=document.getElementById("progress");i||(i=document.createElement("div"),i.id="progress",i.style.position="fixed",i.style.top="5px",i.style.right="5px",i.style.width=rt()?"70%":"30%",i.style.backgroundColor="#ccffcc",i.style.borderRadius="5px 5px 5px 5px",i.style.color="#000000",i.style.padding="6px",i.style.zIndex="9998",i.style.display="flex",i.style.alignItems="center",i.style.gap="10px",document.body.appendChild(i),window.addEventListener("resize",()=>{i.style.width=rt()?"70%":"30%"}));const r=document.createElement("div");r.style.flex="1",r.style.display="flex",r.style.flexDirection="column",r.style.gap="3px";const o=document.createElement("div");o.textContent=`Caching (${t}/${e}, ${a}%)`,o.style.fontSize="12px",o.style.textAlign="center";const l=document.createElement("div");l.style.width="100%",l.style.height="8px",l.style.backgroundColor="#e0e0e0",l.style.borderRadius="3px",l.style.overflow="hidden";const c=document.createElement("div");c.style.width=`${a}%`,c.style.height="100%",c.style.backgroundColor="#4caf50",c.style.transition="width 0.3s ease-in-out",l.appendChild(c),r.appendChild(o),r.appendChild(l);let u=document.getElementById("cancel-caching");u||(u=document.createElement("button"),u.id="cancel-caching",u.textContent="Cancel",u.style.backgroundColor="#ff4444",u.style.color="#ffffff",u.style.border="none",u.style.borderRadius="3px",u.style.padding="5px 3px",u.style.cursor="pointer",u.style.fontSize="12px",u.addEventListener("click",()=>{n(),i.style.display="none",p.handleMessage("Caching cancelled.")})),i.innerHTML="",i.appendChild(r),i.appendChild(u),i.style.display="flex"}function ke(){const t=document.getElementById("progress");t&&(t.style.display="none")}function ia(){console.log("updateOfflineIndicator called, navigator.onLine:",navigator.onLine);let t=document.getElementById("offline-indicator");t||(t=document.createElement("div"),t.id="offline-indicator",document.body.appendChild(t),console.log("Offline indicator created and appended")),t.style.display=navigator.onLine?"none":"block",t.textContent="Offline Mode"}function pn(t){console.log("displayError called with:",t);let e=document.getElementById("error-message");e||(e=document.createElement("div"),e.id="error-message",document.body.appendChild(e),window.addEventListener("resize",()=>{e.style.width=rt()?"70%":"30%"})),e.textContent=t,e.style.display="block",console.log("Error element state:",{display:e.style.display,text:e.textContent,position:e.style.position,zIndex:e.style.zIndex}),clearTimeout(window.errorTimeout),window.errorTimeout=setTimeout(()=>{e.style.display="none",console.log("Error hidden after 3s")},Se.MESSAGE_TIMEOUT_MS)}function Le(){var t;return parseInt((t=document.getElementById("timeSlider"))==null?void 0:t.value)||0}function Fl(t){const e=document.getElementById("modelSelect");if(!e)return;const n=e.value;e.innerHTML="",t.forEach(a=>{const i=document.createElement("option");i.value=a,i.textContent=a.replace(/_/g," ").toUpperCase(),e.appendChild(i)}),t.includes(m.state.userSettings.model)?e.value=m.state.userSettings.model:t.includes(n)?e.value=n:t.length>0&&(e.value=t[0])}function Dl(t){let e=m.state.userSettings.selectedEnsembleModels||[],n=e.filter(a=>t.includes(a));e.length!==n.length&&(m.state.userSettings.selectedEnsembleModels=n,m.save())}let on=0;async function Pl(){return console.log("MapManager: Starte Karteninitialisierung..."),await xl(),console.log("MapManager: Karteninitialisierung abgeschlossen."),s.map}async function xl(){if(s.ismapInitialized||s.map){console.warn("Map already initialized or init in progress.");return}s.ismapInitialized=!0,console.log("initMap started...");const t=Se.DEFAULT_MAP_CENTER,e=Se.DEFAULT_MAP_ZOOM;Ol(t,e),s.jumpVisualizationLayerGroup=L.layerGroup().addTo(s.map),s.landingPatternLayerGroup=L.layerGroup().addTo(s.map),s.jumpRunTrackLayerGroup=L.layerGroup().addTo(s.map),s.favoritesLayerGroup=L.layerGroup().addTo(s.map),console.log("Favorite marker layer added!"),$l(),Rl(),Ul(),Wl(),Hl(t),Zl(),Promise.all([zl(),Gl(t,e)]).then(()=>{console.log("Initial tile caching and geolocation promise resolved.")}).catch(n=>{console.error("Error during parallel initialization of cache/geolocation:",n)}),ia(),console.log("initMap finished.")}function Ol(t,e){s.lastLat=s.lastLat||t[0],s.lastLng=s.lastLng||t[1],s.map=L.map("map",{center:t,zoom:e,zoomControl:!1,doubleClickZoom:!1,maxZoom:19,minZoom:navigator.onLine?6:11}),console.log("Map instance created.")}function $l(){s.baseMaps={OpenStreetMap:L.tileLayer.cached("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:["a","b","c"]}),OpenTopoMap:L.tileLayer.cached("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{maxZoom:17,attribution:'© <a href="https://www.openstreetmap.org/copyright">OSM</a>, <a href="https://opentopomap.org">OpenTopoMap</a> (CC-BY-SA)',subdomains:["a","b","c"]}),"Esri Satellite":L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USDA, USGS"}),"Esri Street":L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USGS"}),"Esri Topo":L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USGS"}),"Esri Satellite + OSM":L.layerGroup([L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USDA, USGS",zIndex:1}),L.tileLayer.cached("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',opacity:.5,zIndex:2,updateWhenIdle:!0,keepBuffer:2,subdomains:["a","b","c"]})],{attribution:'© Esri, USDA, USGS | © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'})},s.map&&s.map.attributionControl&&s.map.attributionControl.addAttribution('Weather data by <a href="https://open-meteo.com">Open-Meteo</a>');const e=m.state.userSettings.baseMaps in s.baseMaps?m.state.userSettings.baseMaps:"Esri Street",n=s.baseMaps[e];n&&typeof n.on=="function"?(n.on("tileerror",()=>{if(!navigator.onLine){s.hasTileErrorSwitched||(console.warn(`${e} tiles unavailable offline. Zoom restricted.`),p.handleMessage("Offline: Zoom restricted to levels 11–14 for cached tiles."),s.hasTileErrorSwitched=!0);return}if(!s.hasTileErrorSwitched&&s.map.hasLayer(n)){const a="OpenStreetMap";console.warn(`${e} tiles unavailable, switching to ${a}`),s.map.removeLayer(n),s.baseMaps[a].addTo(s.map),m.state.userSettings.baseMaps=a,m.save(),p.handleMessage(`${e} tiles unavailable. Switched to ${a}.`),s.hasTileErrorSwitched=!0}else s.hasTileErrorSwitched||console.warn(`Tile error in ${e}, attempting to continue.`)}),n.addTo(s.map)):(console.error(`Default base map "${e}" could not be added.`),s.baseMaps.OpenStreetMap.addTo(s.map)),s.map&&s.map.invalidateSize(),window.addEventListener("online",()=>{s.hasTileErrorSwitched=!1,s.map&&(s.map.options.minZoom=6),ia()}),window.addEventListener("offline",()=>{s.map&&(s.map.options.minZoom=9),ia()}),console.log("Base layers and online/offline handlers set up.")}function Rl(){if(!s.map){console.error("Karte nicht initialisiert, bevor Controls hinzugefügt werden können.");return}L.control.layers(s.baseMaps,null,{position:"topright"}).addTo(s.map),s.map.on("baselayerchange",function(t){console.log(`Base map changed to: ${t.name}`),m&&m.state&&m.state.userSettings?(m.state.userSettings.baseMaps=t.name,m.save(),console.log(`Saved selected base map "${t.name}" to settings.`)):console.error("Settings object not properly available to save base map choice."),s.hasTileErrorSwitched=!1,s.lastLat&&s.lastLng&&typeof cacheTilesForDIP=="function"&&cacheTilesForDIP({map:s.map,lastLat:s.lastLat,lastLng:s.lastLng,baseMaps:s.baseMaps})}),L.control.zoom({position:"topright"}).addTo(s.map),L.control.polylineMeasure({position:"topright",unit:"kilometres",showBearings:!0,clearMeasurementsOnStop:!1,showClearControl:!0,showUnitControl:!0,tooltipTextFinish:"Click to finish the line<br>",tooltipTextDelete:"Shift-click to delete point",tooltipTextMove:"Drag to move point<br>",tooltipTextResume:"Click to resume line<br>",tooltipTextAdd:"Click to add point<br>",measureControlTitleOn:"Start measuring distance and bearing",measureControlTitleOff:"Stop measuring"}).addTo(s.map),L.control.scale({position:"bottomleft",metric:!0,imperial:!1,maxWidth:100}).addTo(s.map),console.log("Standard map controls and baselayerchange handler added.")}function Ul(){s.map.createPane("gpxTrackPane"),s.map.getPane("gpxTrackPane").style.zIndex=650,s.map.getPane("tooltipPane").style.zIndex=700,s.map.getPane("popupPane").style.zIndex=700,console.log("Custom map panes created.")}function Wl(){s.livePositionControl=new ic({position:"bottomright"}).addTo(s.map),console.log("Initialized livePositionControl and hid by default")}async function Hl(t,e){console.log("MapManager: Initialisiere den Standard-Marker..."),await En(t[0],t[1]),s.isManualPanning=!1,console.log("Default marker initialized using the new standard method.")}async function zl(){try{if(await le.init(),await le.migrateTiles(),await le.getCacheSize()>500){const e=await le.clearOldTiles(3);p.handleMessage(`Cleared ${e.deletedCount} old tiles: ${e.deletedSizeMB.toFixed(2)} MB freed.`)}else await le.clearOldTiles()}catch(t){console.error("Failed to initialize or manage tile cache:",t),p.handleError("Tile caching setup failed.")}console.log("Tile cache logic initialized.")}async function Bl(t,e){const{latitude:n,longitude:a}=t.coords;console.log("MapManager: Geolocation erfolgreich. Sende Event."),s.lastLat=n,s.lastLng=a,s.lastAltitude=await p.getAltitude(n,a),s.map.setView([n,a],e);const i=new CustomEvent("location:selected",{detail:{lat:n,lng:a,source:"geolocation"},bubbles:!0,cancelable:!0});s.map.getContainer().dispatchEvent(i)}async function mi(t,e,n){console.warn(`Geolocation error: ${t.message}`),p.handleMessage("Unable to retrieve your location. Using default location."),await En(e[0],e[1]),s.map.setView(e,n),yn(!0),s.isManualPanning=!1;const a=new CustomEvent("location:selected",{detail:{lat:e[0],lng:e[1],source:"geolocation_fallback"},bubbles:!0,cancelable:!0});s.map.getContainer().dispatchEvent(a),console.log("Dispatched 'location:selected' event from geolocation fallback.")}async function Gl(t,e){navigator.geolocation?navigator.geolocation.getCurrentPosition(n=>Bl(n,e),n=>mi(n,t,e),{enableHighAccuracy:!0,timeout:Se.GEOLOCATION_TIMEOUT_MS,maximumAge:0}):(console.warn("Geolocation not supported."),await mi({message:"Geolocation not supported by this browser."},t,e))}function Vl(t){const{lat:e,lng:n}=t.latlng;s.lastMouseLatLng={lat:e,lng:n};const a=m.getValue("coordFormat","radio","Decimal");let i;if(a==="MGRS")i=`MGRS: ${p.decimalToMgrs(e,n)||"N/A"}`;else if(a==="DMS"){const r=o=>`${o.deg}°${o.min}'${o.sec.toFixed(0)}" ${o.dir}`;i=`Lat: ${r(p.decimalToDms(e,!0))}, Lng: ${r(p.decimalToDms(n,!1))}`}else i=`Lat: ${e.toFixed(5)}, Lng: ${n.toFixed(5)}`;s.coordsControl&&s.coordsControl.update(`${i}<br>Elevation: Fetching...<br>QFE: Fetching...`),p.debouncedGetElevationAndQFE(e,n,({elevation:r})=>{var o,l;if(s.lastMouseLatLng&&s.coordsControl&&Math.abs(s.lastMouseLatLng.lat-e)<.05&&Math.abs(s.lastMouseLatLng.lng-n)<.05){const c=m.getValue("heightUnit","radio","m");let u=r==="N/A"?"N/A":Math.round(p.convertHeight(r,c)),d="N/A";if(r!=="N/A"&&s.weatherData&&s.weatherData.surface_pressure){const h=parseInt((o=document.getElementById("timeSlider"))==null?void 0:o.value)||0,g=s.weatherData.surface_pressure[h],f=((l=s.weatherData.temperature_2m)==null?void 0:l[h])||15,w=s.lastAltitude!=="N/A"?s.lastAltitude:0,v=p.calculateQFE(g,r,w,f);d=v!=="N/A"?`${v} hPa`:"N/A"}s.coordsControl.update(`${i}<br>Elevation: ${u} ${u==="N/A"?"":c}<br>QFE: ${d}`)}})}function Zl(){if(!s.map){console.error("Karte nicht initialisiert in _setupCoreMapEventHandlers");return}if(!s.coordsControl){const e={enableUserInput:!1};s.coordsControl=new L.Control.Coordinates(e),s.coordsControl.addTo(s.map)}rt()?Jl(s.map):jl(s.map),s.map.on("dblclick",zn),s.map.on("zoomstart",e=>{if(!navigator.onLine){const n=e.target._zoom||s.map.getZoom();n<11?(e.target._zoom=11,s.map.setZoom(11),p.handleMessage("Offline: Zoom restricted to levels 11–14 for cached tiles.")):n>14&&(e.target._zoom=14,s.map.setZoom(14),p.handleMessage("Offline: Zoom restricted to levels 11–14 for cached tiles."))}}),s.map.on("zoomend",()=>{const e=s.map.getZoom(),n=new CustomEvent("map:zoomend",{detail:{zoom:e},bubbles:!0,cancelable:!0});if(s.map.getContainer().dispatchEvent(n),s.jumpRunTrackLayer&&m.state.userSettings.showJumpRunTrack){const a=s.jumpRunTrackLayer.getLayers().find(i=>{var r;return((r=i.options.icon)==null?void 0:r.options.className)==="jrt-anchor-marker"});if(a){const i=e<=11?10:e<=12?12:e<=13?14:16;a.setIcon(L.divIcon({className:"jrt-anchor-marker",html:`<div style="background-color: orange; width: ${i}px; height: ${i}px; border-radius: 50%; border: 2px solid white; opacity: 0.8;"></div>`,iconSize:[i,i],iconAnchor:[i/2,i/2],tooltipAnchor:[0,-(i/2+5)]}))}}if(s.heatmapLayer){const a=p.calculateDynamicRadius(me.HEATMAP_BASE_RADIUS,me.HEATMAP_REFERENCE_ZOOM);s.heatmapLayer.setOptions({radius:a}),console.log("Heatmap radius updated on zoom:",{currentZoom:s.map.getZoom(),newRadius:a})}}),s.map.on("movestart",e=>{e.target===s.map&&(!e.originalEvent||e.originalEvent.target===s.map.getContainer())&&(s.isManualPanning=!0,console.log("Manual map panning detected."))}),s.map.on("contextmenu",e=>{if(!m.state.userSettings.showCutAwayFinder||!m.state.userSettings.calculateJump)return;const{lat:n,lng:a}=e.latlng;s.cutAwayMarker?s.cutAwayMarker.setLatLng([n,a]):(s.cutAwayMarker=Xl(n,a).addTo(s.map),ec(s.cutAwayMarker)),s.cutAwayLat=n,s.cutAwayLng=a,Pr(s.cutAwayMarker,n,a);const i=new CustomEvent("cutaway:marker_placed",{bubbles:!0});s.map.getContainer().dispatchEvent(i)});const t=s.map.getContainer();t.addEventListener("touchstart",async e=>{if(e.touches.length!==1||e.target.closest(".leaflet-marker-icon"))return;const n=new Date().getTime(),a=n-on;if(a<300&&a>0){e.preventDefault();const r=t.getBoundingClientRect(),o=e.touches[0].clientX-r.left,l=e.touches[0].clientY-r.top,c=s.map.containerPointToLatLng([o,l]);await zn({latlng:c,containerPoint:L.point(o,l),layerPoint:s.map.latLngToLayerPoint(c)})}on=n},{passive:!1}),s.map.on("click",e=>{}),s.map.on("mousedown",e=>{}),t.addEventListener("touchstart",async e=>{if(e.touches.length!==1||e.target.closest(".leaflet-marker-icon"))return;const n=new Date().getTime(),a=n-on;if(a<300&&a>0){e.preventDefault();const r=t.getBoundingClientRect(),o=e.touches[0].clientX-r.left,l=e.touches[0].clientY-r.top,c=s.map.containerPointToLatLng([o,l]);await zn({latlng:c,containerPoint:L.point(o,l),layerPoint:s.map.latLngToLayerPoint(c)})}on=n},{passive:!1}),console.log("All core map event handlers have been set up.")}function Jl(t){const e=()=>{const n=t.getCenter(),a=m.getValue("coordFormat","radio","Decimal"),i=p.convertCoords(n.lat,n.lng,a),r=a==="MGRS"?`MGRS: ${i.lat}`:`${n.lat.toFixed(5)}, ${n.lng.toFixed(5)}`;s.coordsControl.update(`${r}<br>Elevation: ...<br>QFE: ...`),p.debouncedGetElevationAndQFE(n.lat,n.lng,({elevation:o})=>{if(o!=="N/A"){const l=parseFloat(o),c=document.getElementById("crosshair-elevation"),u=document.getElementById("crosshair-qfe");c&&(c.textContent=`${l.toFixed(0)} m`);const d=s.currentQNH||1013,h=p.calculateQFE(d,l,0);u&&(u.textContent=`${h} hPa`)}})};t.on("move",e),setTimeout(()=>t.fire("move"),200),console.log("Crosshair coordinate handler initialized.")}function jl(t){t.on("mousemove",Vl),t.on("mouseout",function(){s.coordsControl&&s.coordsControl.getContainer()&&(s.coordsControl.getContainer().innerHTML="Move mouse over map")}),console.log("Mouse coordinate handler initialized.")}function zn(t){const{lat:e,lng:n}=t.latlng;console.log('MapManager: Doppelklick erkannt. Sende "location:selected"-Event.');const a=new CustomEvent("location:selected",{detail:{lat:e,lng:n,source:"dblclick"},bubbles:!0,cancelable:!0});s.map.getContainer().dispatchEvent(a)}function cn(t){if(ql(),s.labelZoomListener&&s.map&&(s.map.off("zoomend",s.labelZoomListener),s.labelZoomListener=null),!t||!s.jumpVisualizationLayerGroup)return;const e=[];t.exitCircles&&t.exitCircles.forEach(a=>{const i=L.circle(a.center,{radius:a.radius,color:a.color,fillColor:a.fillColor,fillOpacity:a.fillOpacity,weight:a.weight||2}).addTo(s.jumpVisualizationLayerGroup);a.tooltip&&i.bindTooltip(a.tooltip,{direction:"top",offset:[0,0],className:"wind-tooltip"})}),t.canopyCircles&&t.canopyCircles.forEach(a=>{L.circle(a.center,a).addTo(s.jumpVisualizationLayerGroup)});function n(a,i){const r=L.latLng(a[0],a[1]),l=i/6378137*(180/Math.PI),c=L.latLng(a[0]+l,a[1]),u=s.map.latLngToLayerPoint(r),d=s.map.latLngToLayerPoint(c);return[25,u.y-d.y+10]}if(t.canopyLabels){const a=s.map.getZoom();t.canopyLabels.forEach(i=>{const r=a<=11,o=L.marker(i.center,{icon:L.divIcon({className:`isoline-label ${r?"isoline-label-small":"isoline-label-large"}`,html:`<span style="font-size: ${r?"8px":"10px"}">${i.text}</span>`,iconSize:r?[50,12]:[60,14],iconAnchor:n(i.center,i.radius)}),zIndexOffset:2100}).addTo(s.jumpVisualizationLayerGroup);e.push({marker:o,center:i.center,radius:i.radius,text:i.text})})}e.length>0&&(s.labelZoomListener=function(){const i=s.map.getZoom()<=11;e.forEach(r=>{r.marker.setIcon(L.divIcon({className:`isoline-label ${i?"isoline-label-small":"isoline-label-large"}`,html:`<span style="font-size: ${i?"8px":"10px"}">${r.text}</span>`,iconSize:i?[50,12]:[60,14],iconAnchor:n(r.center,r.radius)}))})},s.map.on("zoomend",s.labelZoomListener))}function ql(){s.map&&s.jumpVisualizationLayerGroup&&s.map.removeLayer(s.jumpVisualizationLayerGroup),s.jumpVisualizationLayerGroup=L.layerGroup().addTo(s.map)}function Kl(){s.landingPatternLayerGroup&&s.landingPatternLayerGroup.clearLayers()}function Ot(t){Kl(),t&&(t.legs.forEach(e=>{L.polyline(e.path,{color:"red",weight:3,opacity:.8,dashArray:"5, 10"}).addTo(s.landingPatternLayerGroup)}),t.arrows.forEach(e=>{const n=Yl(e.position[0],e.position[1],e.bearing,e.color);L.marker(e.position,{icon:n}).addTo(s.landingPatternLayerGroup).bindTooltip(e.tooltipText,{offset:[10,0],direction:"right",className:"wind-tooltip"})}))}function Yl(t,e,n,a){const i=(n+360)%360,r=`
        <svg width="40" height="20" viewBox="0 0 40 20" xmlns="http://www.w3.org/2000/svg">
            <line x1="0" y1="10" x2="30" y2="10" stroke="${a}" stroke-width="4" />
            <polygon points="30,5 40,10 30,15" fill="${a}" />
        </svg>
    `;return L.divIcon({html:`<div style="transform: rotate(${i}deg); ...">${r}</div>`,className:"wind-arrow-icon",iconSize:[40,20],iconAnchor:[20,10]})}function Ql(){s.map&&s.jumpRunTrackLayerGroup&&s.map.removeLayer(s.jumpRunTrackLayerGroup),s.jumpRunTrackLayerGroup=L.layerGroup().addTo(s.map)}function Xl(t,e){const n=L.icon({iconUrl:va.CUTAWAY_MARKER,iconSize:[25,25],iconAnchor:[12,12],popupAnchor:[0,-12]});return L.marker([t,e],{icon:n,draggable:!0})}function ec(t){t.on("dragend",e=>{const n=t.getLatLng();s.cutAwayLat=n.lat,s.cutAwayLng=n.lng,console.log("Cut-away marker dragged to:",{lat:s.cutAwayLat,lng:s.cutAwayLng}),Pr(t,s.cutAwayLat,s.cutAwayLng);const a=new CustomEvent("cutaway:marker_placed",{bubbles:!0});s.map.getContainer().dispatchEvent(a)})}function Pr(t,e,n,a=!1){const i=m.getValue("coordFormat","radio","Decimal"),r=p.convertCoords(e,n,i);let o="<b>Cut-Away Start</b><br>";if(i==="MGRS")o+=`MGRS: ${r.lat}`;else{const l=c=>`${c.deg}°${c.min}'${c.sec.toFixed(0)}" ${c.dir}`;i==="DMS"?o+=`Lat: ${l(p.decimalToDms(e,!0))}<br>Lng: ${l(p.decimalToDms(n,!1))}`:o+=`Lat: ${e.toFixed(5)}<br>Lng: ${n.toFixed(5)}`}_a(t,o,a)}function ra(t){s.cutAwayCircle&&(s.map.removeLayer(s.cutAwayCircle),s.cutAwayCircle=null),t&&(s.cutAwayCircle=L.circle(t.center,{radius:t.radius,color:"purple",fillColor:"purple",fillOpacity:.2,weight:2}).addTo(s.map),s.cutAwayCircle.bindTooltip(t.tooltipContent,{permanent:!1,direction:"center",className:"cutaway-tooltip"}))}function tc(){s.cutAwayMarker&&(s.map.removeLayer(s.cutAwayMarker),s.cutAwayMarker=null),ra(null)}function Rt(t){var r,o,l,c;if(Ql(),!t||!s.jumpRunTrackLayerGroup){console.warn("No valid trackData or AppState.jumpRunTrackLayerGroup");return}if(!((o=(r=t.path)==null?void 0:r.latlngs)!=null&&o.length)||!((l=t.airplane)!=null&&l.position)){console.warn("Invalid trackData structure:",t);return}const e=L.polyline(t.path.latlngs,t.path.options).bindTooltip(t.path.tooltipText).addTo(s.jumpRunTrackLayerGroup);let n=null;(c=t.approachPath)!=null&&c.latlngs&&(n=L.polyline(t.approachPath.latlngs,t.approachPath.options).bindTooltip(t.approachPath.tooltipText).addTo(s.jumpRunTrackLayerGroup));const a=L.icon({iconUrl:va.AIRPLANE_MARKER,iconSize:[32,32],iconAnchor:[16,16],shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",shadowSize:[41,41],shadowAnchor:[13,32]}),i=L.marker(t.airplane.position,{icon:a,rotationAngle:t.airplane.bearing,rotationOrigin:"center center",draggable:!0,zIndexOffset:2e3}).bindTooltip("Drag to move Jump Run Track").addTo(s.jumpRunTrackLayerGroup);i.on("mousedown",()=>s.map.dragging.disable()),i.on("mouseup",()=>s.map.dragging.enable()),i.on("drag",u=>{var v;const d=u.target.getLatLng(),h=t.airplane.originalPosition;if(!h||!Number.isFinite(h.lat)||!Number.isFinite(h.lng)){console.warn("Invalid originalPosition:",h);return}const g=d.lat-h.lat,f=d.lng-h.lng;if(!Number.isFinite(g)||!Number.isFinite(f)){console.warn("Invalid delta values:",{deltaLat:g,deltaLng:f});return}const w=t.path.originalLatLngs.map(y=>[Number.isFinite(y[0])?y[0]+g:y[0],Number.isFinite(y[1])?y[1]+f:y[1]]);if(e.setLatLngs(w),n&&((v=t.approachPath)!=null&&v.originalLatLngs)){const y=t.approachPath.originalLatLngs.map(S=>[Number.isFinite(S[0])?S[0]+g:S[0],Number.isFinite(S[1])?S[1]+f:S[1]]);n.setLatLngs(y)}}),i.on("dragend",u=>{const d=u.target.getLatLng();if(!Number.isFinite(d.lat)||!Number.isFinite(d.lng)){console.warn("Invalid new position in dragend:",d);return}const h=new CustomEvent("track:dragend",{detail:{newPosition:d,originalTrackData:t},bubbles:!0});s.map.getContainer().dispatchEvent(h)})}async function En(t,e){if(console.log("MapManager: Befehl erhalten, Marker zu erstellen/bewegen bei",t,e),typeof t!="number"||typeof e!="number"||t<-90||t>90||e<-180||e>180){console.error("MapManager: Ungültige Koordinaten:",{lat:t,lng:e});return}const n=await p.getAltitude(t,e);if(s.currentMarker)console.log("MapManager: Marker existiert, bewege ihn jetzt mit setLatLng."),s.currentMarker.setLatLng([t,e]);else{console.log("MapManager: Kein Marker vorhanden, erstelle einen neuen.");const i=nc(t,e);ac(i),s.currentMarker=i,s.currentMarker.addTo(s.map)}const a=`Lat: ${t.toFixed(5)}<br>Lng: ${e.toFixed(5)}<br>Alt: ${n} m`;_a(s.currentMarker,a),s.lastLat=t,s.lastLng=e,s.lastAltitude=n,s.map.invalidateSize()}function nc(t,e){const n=L.icon({iconUrl:va.DEFAULT_MARKER,iconSize:[32,32],iconAnchor:[16,20],popupAnchor:[0,-32]});return L.marker([t,e],{icon:n,draggable:!0})}function ac(t){t.on("dragend",e=>{const n=t.getLatLng(),a=new CustomEvent("location:selected",{detail:{lat:n.lat,lng:n.lng,source:"marker_drag"},bubbles:!0});s.map.getContainer().dispatchEvent(a)})}function _a(t,e,n=!1){var i;if(!t)return;const a=((i=t.getPopup())==null?void 0:i.isOpen())||n;t.unbindPopup().bindPopup(e),a&&t.openPopup()}function yn(t=!1){s.isManualPanning&&!t||s.map&&s.currentMarker&&s.map.panTo(s.currentMarker.getLatLng())}const ic=L.Control.extend({options:{position:"bottomright"},onAdd:function(t){const e=L.DomUtil.create("div","leaflet-control-live-position");return e.style.display="none",e.style.background="rgba(255, 255, 255, 0.8)",e.style.padding="5px",e.style.borderRadius="4px",this._container=e,e},update:function(t){if(!t||t.latitude===null||t.latitude===void 0){this._container.style.display="none";return}const{latitude:e,longitude:n,deviceAltitude:a,altitudeAccuracy:i,accuracy:r,speedMs:o,direction:l,showJumpMasterLine:c,jumpMasterLineData:u,heightUnit:d,effectiveWindUnit:h,coordFormat:g,refLevel:f}=t,w=p.convertCoords(e,n,g),v=g==="MGRS"?`MGRS: ${w.lat}<br>`:`Lat: ${e.toFixed(5)}<br>Lng: ${n.toFixed(5)}<br>`;let y="Altitude: N/A<br>";if(a!==null){let b=f==="AGL"&&s.lastAltitude?a-parseFloat(s.lastAltitude):a,k=f==="AGL"&&s.lastAltitude?"abv DIP":f;const A=Math.round(p.convertHeight(b,d)),T=Math.round(p.convertHeight(i,d));y=`Altitude: ${A} ${d} ${k} (±${T||"N/A"} ${d})<br>`}const S=`Accuracy: ${Math.round(p.convertHeight(r,d))} ${d}<br>`,_=`Speed: ${p.convertWind(o,h,"m/s").toFixed(1)} ${h}<br>`,E=`Direction: ${l}°`;let M=`<span style="font-weight: bold;">Live Position</span><br>${v}${y}${S}${_}${E}`;if(c&&u){const b=Math.round(p.convertHeight(u.distance,d)),k=u.tot!=="N/A"&&u.tot<1200?`TOT: X - ${u.tot} s`:"TOT: N/A";M+=`<br><br><span style="font-weight: bold;">Jump Master Line to ${u.target}</span><br>`,M+=`Bearing: ${u.bearing}°<br>`,M+=`Distance: ${b} ${d}<br>`,M+=k}this._container.innerHTML=M,this._container.style.display="block"}});function rc(t,e){const n=[[t.lat,t.lng],[e.lat,e.lng]];s.jumpMasterLine?s.jumpMasterLine.setLatLngs(n):s.jumpMasterLine=L.polyline(n,{color:"blue",weight:3,dashArray:"5, 5"}).addTo(s.map)}function fi(){s.jumpMasterLine&&(s.map.removeLayer(s.jumpMasterLine),s.jumpMasterLine=null)}function oc(){s.livePositionControl&&s.livePositionControl.update(null)}function sc(t){s.livePositionControl&&s.livePositionControl.update(t)}function xr(t){if(!s.isPlacingHarp)return;const{lat:e,lng:n}=t.latlng;s.harpMarker?(s.harpMarker.setLatLng([e,n]),console.log("Updated HARP marker position:",{lat:e,lng:n})):(s.harpMarker=lc(e,n).addTo(s.map),console.log("Placed new HARP marker:",{lat:e,lng:n})),m.state.userSettings.harpLat=e,m.state.userSettings.harpLng=n,m.save(),s.isPlacingHarp=!1,s.map.off("click",xr),console.log("HARP placement mode deactivated");const a=document.querySelector('input[name="jumpMasterLineTarget"][value="HARP"]');a&&(a.disabled=!1,console.log("Enabled HARP radio button"))}function lc(t,e){const n=L.marker([t,e],{icon:L.divIcon({className:"harp-marker",html:'<div style="background-color: green; width: 10px; height: 10px; border-radius: 50%;"></div>',iconSize:[10,10],iconAnchor:[5,5]}),pane:"markerPane"});return console.log("Created HARP marker at:",{latitude:t,longitude:e}),n}function cc(){if(!s.map){console.warn("Map not initialized, cannot clear HARP marker"),p.handleMessage("Map not initialized, cannot clear HARP marker.");return}s.harpMarker&&(s.map.removeLayer(s.harpMarker),s.harpMarker=null,console.log("Removed HARP marker")),m.state.userSettings.harpLat=null,m.state.userSettings.harpLng=null,m.save();const t=document.querySelector('input[name="jumpMasterLineTarget"][value="HARP"]');if(t&&(t.disabled=!0,console.log("Disabled HARP radio button")),m.state.userSettings.jumpMasterLineTarget==="HARP"&&m.state.userSettings.showJumpMasterLine){s.jumpMasterLine&&(s.map.removeLayer(s.jumpMasterLine),s.jumpMasterLine=null,console.log("Removed Jump Master Line: HARP marker cleared")),m.state.userSettings.jumpMasterLineTarget="DIP";const e=document.querySelector('input[name="jumpMasterLineTarget"][value="DIP"]');e&&(e.checked=!0,console.log("Switched Jump Master Line to DIP")),m.save(),s.liveMarker&&s.currentMarker&&s.lastLat!==null&&s.lastLng!==null&&debouncedPositionUpdate({coords:{latitude:s.lastLatitude,longitude:s.lastLongitude,accuracy:s.lastAccuracy,altitude:s.lastDeviceAltitude,altitudeAccuracy:s.lastAltitudeAccuracy}})}p.handleMessage("HARP marker cleared")}function Or(t){if(!s.map||!s.favoritesLayerGroup){console.warn("Cannot update favorite markers: map or layer group not ready.");return}if(s.favoritesLayerGroup.clearLayers(),!t||t.length===0)return;const e=L.divIcon({html:"★",className:"favorite-marker-icon",iconSize:[24,24],iconAnchor:[12,12]});t.forEach(n=>{const a=L.marker([n.lat,n.lng],{icon:e}).bindTooltip(n.label,{permanent:!1,direction:"top"}).on("click",()=>{const i=new CustomEvent("location:selected",{detail:{lat:n.lat,lng:n.lng,source:"favorite_marker"},bubbles:!0,cancelable:!0});s.map.getContainer().dispatchEvent(i)});s.favoritesLayerGroup.addLayer(a),console.log("FAVORITE marker added")})}async function vt(){if(!s.currentMarker||s.lastLat===null)return;const t=s.lastLat,e=s.lastLng,n=s.lastAltitude,a=m.getValue("heightUnit","radio","m");let i="N/A",r="";n!=="N/A"&&(a==="ft"?(i=Math.round(p.convertHeight(n,"ft")),r="ft"):(i=n,r="m"));const o=m.getValue("coordFormat","radio","Decimal"),l=Fr(),c=p.convertCoords(t,e,o);let u;if(o==="MGRS")u=`MGRS: ${c.lat}<br>Alt: ${i} ${r}`;else{const d=h=>`${h.deg}°${h.min}'${h.sec.toFixed(0)}" ${h.dir}`;o==="DMS"?u=`Lat: ${d(p.decimalToDms(t,!0))}<br>Lng: ${d(p.decimalToDms(e,!1))}<br>Alt: ${i} ${r}`:u=`Lat: ${t.toFixed(5)}<br>Lng: ${e.toFixed(5)}<br>Alt: ${i} ${r}`}if(s.weatherData&&s.weatherData.surface_pressure){const d=s.weatherData.surface_pressure[l];d?u+=` QFE: ${d.toFixed(0)} hPa`:u+=" QFE: N/A"}else u+=" QFE: N/A";_a(s.currentMarker,u)}async function at(t,e,n,a=null){var E;console.log(`updateWeatherDisplay called for index: ${t} -> into ${e}`);const i=document.getElementById(e),r=document.getElementById(n);if(!i||!r){console.error("Target container(s) for weather display not found!",{tableContainerId:e,timeContainerId:n});return}if(!s.weatherData||!s.weatherData.time||t<0||t>=s.weatherData.time.length){console.error("No weather data available or index out of bounds:",t),i.innerHTML='<p style="padding: 20px; text-align: center;">No weather data available</p>',r.innerHTML="Selected Time: ";const M=document.getElementById("timeSlider");M&&(M.value=0);return}s.landingWindDir=s.weatherData.wind_direction_10m[t]||null,console.log("landingWindDir updated to:",s.landingWindDir);const o=document.getElementById("customLandingDirectionLL"),l=document.getElementById("customLandingDirectionRR");o&&l&&s.landingWindDir!==null&&(o.value=Math.round(s.landingWindDir),l.value=Math.round(s.landingWindDir));const c=((E=document.querySelector('input[name="refLevel"]:checked'))==null?void 0:E.value)||"AGL",u=m.getValue("heightUnit","radio","m"),d=m.getValue("windUnit","radio","kt"),h=m.getValue("temperatureUnit","radio","C"),g=m.getValue("timeZone","radio","Z"),f=await p.getDisplayTime(s.weatherData.time[t],s.lastLat,s.lastLng,g),w=st(),v=lt(s.weatherData,t,w,Math.round(s.lastAltitude),u),y=c==="AMSL"&&s.lastAltitude!=="N/A"?Math.round(s.lastAltitude):0;if(!m.state.userSettings.showTable){i.innerHTML="",r.innerHTML=`Selected Time: ${f}`;return}const S=v.map(M=>{const b=parseFloat(M.spd);let k="";if(d==="bft"){const B=p.convertWind(b,"kt","km/h"),V=p.knotsToBeaufort(B);V<=1?k="wind-low":V<=3?k="wind-moderate":V<=4?k="wind-high":k="wind-very-high"}else{const B=p.convertWind(b,"kt","km/h");B<=3?k="wind-low":B<=10?k="wind-moderate":B<=16?k="wind-high":k="wind-very-high"}const A=M.rh;let T="";A!=="N/A"&&Number.isFinite(A)&&(A<65?T="humidity-low":A>=65&&A<=85?T="humidity-moderate":A>85&&A<100?T="humidity-high":A===100&&(T="humidity-saturated"));const F=c==="AMSL"?M.displayHeight+(u==="ft"?Math.round(y*3.28084):y):M.displayHeight,D=p.convertTemperature(M.temp,h==="C"?"°C":"°F"),N=D==="N/A"?"N/A":D.toFixed(0),P=p.convertWind(b,d,"km/h");let $;const U=c==="AMSL"?u==="ft"?Math.round(y*3.28084):y:0;if(Math.round(F)===U&&s.weatherData.wind_gusts_10m[t]!==void 0&&Number.isFinite(s.weatherData.wind_gusts_10m[t])){const B=s.weatherData.wind_gusts_10m[t],V=p.convertWind(B,d,"km/h"),Q=d==="bft"?Math.round(P):P.toFixed(0),ae=d==="bft"?Math.round(V):V.toFixed(0);$=`${Q} G ${ae}`}else $=P==="N/A"?"N/A":d==="bft"?Math.round(P):P.toFixed(0);const G=Math.round(p.convertWind(b,"kt","km/h")/5)*5,R=M.dir==="N/A"||isNaN(G)?"N/A":p.generateWindBarb(M.dir,G);return`<tr class="${k} ${T}">
                    <td>${Math.round(F)}</td>
                    <td>${p.roundToTens(M.dir)}</td>
                    <td>${$}</td>
                    <td>${R}</td>
                    <td>${N}</td>
                </tr>`}).join(""),_=`
        <table id="weatherTable">
            <thead>
                <tr>
                    <th>Height (${u} ${c})</th>
                    <th>Dir (deg)</th>
                    <th>Spd (${d})</th>
                    <th>Wind</th>
                    <th>T (${h==="C"?"°C":"°F"})</th>
                </tr>
            </thead>
            <tbody>
                ${S}
            </tbody>
        </table>`;i.innerHTML=_,r.innerHTML=`Selected Time: ${f}`}function Ce(){var Ia;if(!s.currentMarker||typeof s.currentMarker.getLatLng!="function"){console.warn("Landing pattern update skipped: AppState.currentMarker is not a valid marker object yet.",s.currentMarker);return}const t=s.currentMarker.getLatLng();if(!t){console.error("Could not get LatLng from the current marker. Aborting landing pattern update.",s.currentMarker);return}if(!m.state.isLandingPatternUnlocked||!m.state.userSettings.showLandingPattern){Ot(null);return}if(!s.weatherData||!s.lastLat){Ot(null);return}const e=s.map.getZoom();if(e<Se.LANDING_PATTERN_MIN_ZOOM){console.log("Landing pattern not displayed - zoom too low:",e),Ot(null);return}const n=parseInt(document.getElementById("timeSlider").value)||0,a=((Ia=document.querySelector('input[name="landingDirection"]:checked'))==null?void 0:Ia.value)||"LL",i=document.getElementById("customLandingDirectionLL"),r=document.getElementById("customLandingDirectionRR"),o=i?parseInt(i.value,10):null,l=r?parseInt(r.value,10):null,c=parseInt(document.getElementById("canopySpeed").value)||20,u=parseFloat(document.getElementById("descentRate").value)||3.5,d=parseInt(document.getElementById("legHeightFinal").value)||100,h=parseInt(document.getElementById("legHeightBase").value)||200,g=parseInt(document.getElementById("legHeightDownwind").value)||300,f=t.lat,w=t.lng,v=Math.round(s.lastAltitude),y=st(),S=m.getValue("heightUnit","radio","m"),_=lt(s.weatherData,n,y,Math.round(s.lastAltitude),S);if(!_||_.length===0)return;const E=_.map(ie=>ie.height),M=_.map(ie=>Number.isFinite(ie.dir)?parseFloat(ie.dir):0),b=_.map(ie=>p.convertWind(parseFloat(ie.spd)||0,"kt","km/h")),k=b.map((ie,Re)=>-ie*Math.sin(M[Re]*Math.PI/180)),A=b.map((ie,Re)=>-ie*Math.cos(M[Re]*Math.PI/180));let T;if(a==="LL"&&Number.isFinite(o)&&o>=0&&o<=359?T=o:a==="RR"&&Number.isFinite(l)&&l>=0&&l<=359?T=l:T=Number.isFinite(s.landingWindDir)?s.landingWindDir:M[0],!Number.isFinite(T)){console.warn("Invalid landing wind direction:",T);return}function F(ie){const Re=m.getValue("windUnit","radio","kt"),Kt=p.convertWind(ie,Re,"kt");return Re==="bft"?Math.round(Kt):Kt.toFixed(1)}const D=(ie,Re,Kt,io,ro)=>{const Na=io*1.852/3.6*ro/111e3,Fa=Kt*Math.PI/180,oo=Na*Math.cos(Fa),so=Na*Math.sin(Fa)/Math.cos(ie*Math.PI/180);return[ie+oo,Re+so]},N=[v,v+d];console.log("Final limits:",N);const P=p.calculateMeanWind(E,k,A,...N),$=P[0],U=P[1];if(!Number.isFinite(U)||!Number.isFinite($)){console.warn("Invalid mean wind for final leg:",P);return}let G=null;U<=3?G="lightblue":U<=10?G="lightgreen":U<=16?G="#f5f34f":G="#ffcccc";const R=T,B=p.calculateWindAngle(R,$),{crosswind:V,headwind:Q}=p.calculateWindComponents(U,B),ae=p.calculateWCA(V,c)*(V>=0?1:-1),q=p.normalizeAngle(R-ae),be=p.calculateCourseFromHeading(q,$,U,c).groundSpeed,De=d/u,At=be*1.852/3.6*De,ut=(T+180)%360,X=D(f,w,ut,be,De);(f+X[0])/2,(w+X[1])/2;const Tn=[v+d,v+h],dt=p.calculateMeanWind(E,k,A,...Tn),Pe=dt[0],ye=dt[1];if(!Number.isFinite(ye)||!Number.isFinite(Pe)){console.warn("Invalid mean wind for base leg:",dt);return}let Je=null;ye<=3?Je="lightblue":ye<=10?Je="lightgreen":ye<=16?Je="#f5f34f":Je="#ffcccc",console.log("********* Landing Direction: ",a,"Effective Landing Wind Dir:",T);let je=0;a==="LL"?(je=(T+90)%360,console.log("Base Heading:",je)):a==="RR"&&(je=(T-90+360)%360,console.log("Base Heading:",je));const qe=p.calculateCourseFromHeading(je,Pe,ye,c),Ke=qe.trueCourse,xe=qe.groundSpeed;let Oe=(Ke+180)%360;xe<0&&(Oe=(Oe+180)%360,console.log("Base ground speed is negative:",xe,"New course:",Oe));const Ct=(h-d)/u,Gr=xe*1.852/3.6*Ct;console.log("Base Course:",Ke);const Vr=p.calculateWindAngle(Ke,Pe),{crosswind:Ta,headwind:Zr}=p.calculateWindComponents(ye,Vr),Jr=p.calculateWCA(Ta,c)*(Ta>=0?1:-1),oe=D(X[0],X[1],Oe,xe,Ct);(X[0]+oe[0])/2,(X[1]+oe[1])/2;const jr=[v+h,v+g],jt=p.calculateMeanWind(E,k,A,...jr),It=jt[0],$e=jt[1];if(!Number.isFinite($e)||!Number.isFinite(It)){console.warn("Invalid mean wind for downwind leg:",jt);return}let Nt=null;$e<=3?Nt="lightblue":$e<=10?Nt="lightgreen":$e<=16?Nt="#f5f34f":Nt="#ffcccc";const qt=T,qr=p.calculateWindAngle(qt,It),{crosswind:ka,headwind:Kr}=p.calculateWindComponents($e,qr),Aa=p.calculateWCA(ka,c)*(ka>=0?1:-1),Yr=p.normalizeAngle((qt-Aa+180)%360),kn=p.calculateCourseFromHeading(Yr,It,$e,c).groundSpeed,Ca=(g-h)/u,Qr=kn*1.852/3.6*Ca,Ye=D(oe[0],oe[1],qt,kn,Ca),Xr=[(f+X[0])/2,(w+X[1])/2],eo=[(X[0]+oe[0])/2,(X[1]+oe[1])/2],to=[(oe[0]+Ye[0])/2,(oe[1]+Ye[1])/2];(oe[0]+Ye[0])/2,(oe[1]+Ye[1])/2,console.log(`Landing Pattern Updated:
        Final Leg: Wind: ${$.toFixed(1)}° @ ${U.toFixed(1)}kt, Course: ${R.toFixed(1)}°, WCA: ${ae.toFixed(1)}°, GS: ${be.toFixed(1)}kt, HW: ${Q.toFixed(1)}kt, Length: ${At.toFixed(1)}m
        Base Leg: Wind: ${Pe.toFixed(1)}° @ ${ye.toFixed(1)}kt, Course: ${Ke.toFixed(1)}°, WCA: ${Jr.toFixed(1)}°, GS: ${xe.toFixed(1)}kt, HW: ${Zr.toFixed(1)}kt, Length: ${Gr.toFixed(1)}m
        Downwind Leg: Wind: ${It.toFixed(1)}° @ ${$e.toFixed(1)}kt, Course: ${qt.toFixed(1)}°, WCA: ${Aa.toFixed(1)}°, GS: ${kn.toFixed(1)}kt, HW: ${Kr.toFixed(1)}kt, Length: ${Qr.toFixed(1)}m`);const no=s.weatherData.time[n];console.log("+++++++++ Koordinaten Pattern:",no),console.log("Coordinates DIP: ",f,w,"Altitude DIP:",v),console.log("Coordinates final end: ",X[0],X[1],"Leg Height:",v+d),console.log("Coordinates base end: ",oe[0],oe[1],"Leg Height:",v+h),console.log("Coordinates downwind end: ",Ye[0],Ye[1],"Leg Height:",v+g);const ao={legs:[{path:[[f,w],X],options:{color:"red",weight:3,opacity:.8,dashArray:"5, 10"}},{path:[X,oe],options:{color:"red",weight:3,opacity:.8,dashArray:"5, 10"}},{path:[oe,Ye],options:{color:"red",weight:3,opacity:.8,dashArray:"5, 10"}}],arrows:[{position:Xr,bearing:($-90+180)%360,color:G,tooltipText:`${Math.round($)}° ${F(U)}${m.getValue("windUnit","radio","kt")}`},{position:eo,bearing:(dt[0]-90+180)%360,color:Je,tooltipText:`${Math.round(Pe)}° ${F(ye)}${m.getValue("windUnit","radio","kt")}`},{position:to,bearing:(jt[0]-90+180)%360,color:Nt,tooltipText:`${Math.round(It)}° ${F($e)}${m.getValue("windUnit","radio","kt")}`}]};Ot(ao)}function fe(){var o,l,c,u,d,h,g,f;if(console.log("updateJumpRunTrackDisplay called"),!s.map){console.warn("Map not initialized, cannot update jump run track display");return}if(!(m.state.userSettings.showJumpRunTrack&&s.weatherData&&s.lastLat&&s.lastLng&&m.state.isCalculateJumpUnlocked&&m.state.userSettings.calculateJump)){console.log("Conditions not met to show JRT, clearing display."),Rt(null),s.lastTrackData=null;return}const e=Fr(),n=st(),a=m.getValue("heightUnit","radio","m"),i=lt(s.weatherData,e,n,Math.round(s.lastAltitude),a),r=bn(i);if(r&&((o=r.latlngs)==null?void 0:o.length)===2&&r.latlngs.every(w=>Number.isFinite(w[0])&&Number.isFinite(w[1]))){console.log("Drawing jump run track with data:",r);const w={path:{latlngs:r.latlngs,options:{color:"orange",weight:5,opacity:.8},tooltipText:`Jump Run Track: ${r.direction}°, Length: ${r.trackLength} m`,originalLatLngs:((c=(l=s.lastTrackData)==null?void 0:l.latlngs)==null?void 0:c.length)===2?s.lastTrackData.latlngs:r.latlngs},approachPath:((u=r.approachLatLngs)==null?void 0:u.length)===2&&r.approachLatLngs.every(v=>Number.isFinite(v[0])&&Number.isFinite(v[1]))?{latlngs:r.approachLatLngs,options:{color:"orange",weight:5,opacity:.8,dashArray:"5, 10"},tooltipText:`Approach Path: ${r.direction}°, Length: ${r.approachLength} m`,originalLatLngs:((h=(d=s.lastTrackData)==null?void 0:d.approachLatLngs)==null?void 0:h.length)===2?s.lastTrackData.approachLatLngs:r.approachLatLngs}:null,trackLength:r.trackLength,airplane:{position:L.latLng(r.latlngs[1][0],r.latlngs[1][1]),bearing:r.direction,originalPosition:(f=(g=s.lastTrackData)==null?void 0:g.latlngs)!=null&&f[1]&&Number.isFinite(s.lastTrackData.latlngs[1][0])?L.latLng(s.lastTrackData.latlngs[1][0],s.lastTrackData.latlngs[1][1]):L.latLng(r.latlngs[1][0],r.latlngs[1][1])}};Rt(w),s.lastTrackData={latlngs:r.latlngs,approachLatLngs:r.approachLatLngs,direction:r.direction,trackLength:r.trackLength,approachLength:r.approachLength},console.log("Updated AppState.lastTrackData:",s.lastTrackData)}else console.warn("No valid track data to display:",r),Rt(null),s.lastTrackData=null}let Ne=!1;function $r(){const t=document.getElementById("locationSearchInputWeb"),e=document.getElementById("locationResultsWeb"),n=document.getElementById("saveCurrentLocationBtn");if(!t||!e||!n){console.error("Einige UI-Elemente für die Ortssuche wurden nicht gefunden.");return}const a=p.debounce(uc,300);t.addEventListener("input",()=>{a(t.value)}),t.addEventListener("focus",()=>{t.value.trim()||Ae(),e.style.display="block"}),t.addEventListener("blur",()=>{setTimeout(()=>{e.style.display="none"},200)}),n._clickHandler&&(n.removeEventListener("click",n._clickHandler),console.log("Entfernte bestehenden click-Listener für saveCurrentLocationBtn")),n._clickHandler=i=>{if(i.stopPropagation(),s.lastLat===null||s.lastLng===null){p.handleError("Please select a location on the map first.");return}if(Ne){console.log("saveFavoriteBtn Klick blockiert: Ein Favorit wird bereits hinzugefügt.");return}const r=`DIP at ${s.lastLat.toFixed(4)}, ${s.lastLng.toFixed(4)}`,o=prompt("Enter a name for this favorite:",r);if(o){Ne=!0;try{Rr(s.lastLat,s.lastLng,o),ba(s.lastLat,s.lastLng,o,!0)}finally{Ne=!1,console.log("saveFavoriteBtn Aktion abgeschlossen, Sperre aufgehoben.")}}},n.addEventListener("click",n._clickHandler),console.log("Neuer click-Listener für saveCurrentLocationBtn hinzugefügt"),document.addEventListener("click",i=>{!t.contains(i.target)&&!e.contains(i.target)&&(e.style.display="none")})}async function uc(t){if(console.log("performSearch: Suche nach:",t),!t.trim()){console.log("performSearch: Leere Eingabe, zeige Favoriten/Verlauf."),Ae();return}let e=[];const n=dc(t);if(n)console.log("performSearch: Koordinaten gefunden:",n),e.push({display_name:`Koordinate: ${n.lat.toFixed(5)}, ${n.lng.toFixed(5)}`,lat:n.lat,lon:n.lng,type:"coordinate"}),Ae(e);else{console.log("performSearch: Keine Koordinaten, starte Nominatim-Suche.");try{const a=`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(t)}&format=json&limit=5&addressdetails=1`,i=await fetch(a,{method:"GET",headers:{"User-Agent":"Skydiving-Weather-App/1.0 (anonymous)"}});if(!i.ok)throw new Error(`Nominatim API Fehler: ${i.statusText}`);const r=await i.json();console.log("performSearch: Nominatim Ergebnisse:",r),e=r,Ae(e)}catch(a){console.error("Fehler bei der Geocoding-Suche:",a),p.handleError("Could not find location."),Ae([])}}}function dc(t){console.log("parseQueryAsCoordinates: Eingabe:",t);const e=t.trim(),a=e.replace(/[,;\t]+/," ").trim().match(/^(-?\d{1,3}(?:\.\d+)?)\s+(-?\d{1,3}(?:\.\d+)?)$/);if(a){const o=parseFloat(a[1]),l=parseFloat(a[3]);if(console.log("parseQueryAsCoordinates: Dezimalgraden erkannt:",{lat:o,lng:l}),o>=-90&&o<=90&&l>=-180&&l<=180)return{lat:o,lng:l};console.warn("parseQueryAsCoordinates: Ungültige Koordinatenbereiche:",{lat:o,lng:l})}const i=e.replace(/\s/g,"").toUpperCase(),r=/^[0-9]{1,2}[C-HJ-NP-X][A-HJ-NP-Z]{2}(\d{2}|\d{4}|\d{6}|\d{8}|\d{10})$/;if(typeof ml>"u")return console.warn("parseQueryAsCoordinates: MGRS-Bibliothek nicht geladen."),null;if(r.test(i))try{const[o,l]=ya(i);if(console.log("parseQueryAsCoordinates: MGRS erkannt:",{lat:l,lng:o}),!isNaN(l)&&!isNaN(o))return{lat:l,lng:o};console.warn("parseQueryAsCoordinates: Ungültige MGRS-Koordinaten:",{lat:l,lng:o})}catch(o){return console.warn("parseQueryAsCoordinates: MGRS-Parsing fehlgeschlagen:",o.message),null}return console.log("parseQueryAsCoordinates: Keine Koordinaten erkannt."),null}function Ae(t=[]){const e=document.getElementById("locationResultsWeb");if(!e){console.error("resultsList nicht gefunden.");return}e.innerHTML="";const n=ct(),a=n.filter(o=>o.isFavorite),i=n.filter(o=>!o.isFavorite);console.log("renderResultsList: Favoriten:",a),console.log("renderResultsList: Verlauf (nicht Favoriten):",i),console.log("renderResultsList: Suchergebnisse:",t);const r=o=>{const l=document.createElement("li"),c=parseFloat(o.lat),u=parseFloat(o.lng||o.lon);if(isNaN(c)||isNaN(u))return console.error("Ungültige Koordinaten in createListItem:",o),null;console.log("createListItem: Verarbeite Eintrag:",{lat:c,lng:u,label:o.display_name||o.label}),l.dataset.lat=c,l.dataset.lon=u;const d=document.createElement("span");d.className="location-name",d.textContent=o.display_name||o.label,l.appendChild(d),d.addEventListener("mousedown",w=>{const v=new CustomEvent("location:selected",{detail:{lat:c,lng:u},bubbles:!0,cancelable:!0});l.dispatchEvent(v),ba(c,u,o.display_name||o.label,o.isFavorite||!1),e.style.display="none"});const h=document.createElement("div");h.className="location-item-buttons";const g=document.createElement("button");g.className="favorite-toggle",g.innerHTML=o.isFavorite?"★":"☆",o.isFavorite&&g.classList.add("is-favorite"),g.title="Als Favorit markieren/entfernen",h.appendChild(g),g.addEventListener("click",w=>{w.stopPropagation(),console.log("favToggle Klick für:",{lat:c,lng:u,label:o.display_name||o.label}),hc(c,u,o.display_name||o.label)});const f=document.createElement("button");return f.className="delete-location-btn",f.textContent="×",f.title="Diesen Eintrag löschen",h.appendChild(f),f.addEventListener("click",w=>{w.stopPropagation(),confirm(`Möchten Sie "${o.display_name||o.label}" wirklich löschen?`)&&mc(c,u)}),l.appendChild(h),l};if(t.length>0){const o=document.createElement("li");o.className="results-heading",o.textContent="Results",o.style.fontWeight="bold",o.style.background="#f0f0f0",e.appendChild(o),t.forEach(l=>{const c=parseFloat(l.lat),u=parseFloat(l.lon),d=a.find(f=>Math.abs(f.lat-c)<.001&&Math.abs(f.lng-u)<.001);l.isFavorite=!!d,d&&(l.display_name=d.label);const h={lat:c,lng:u,display_name:l.display_name,isFavorite:l.isFavorite},g=r(h);g&&e.appendChild(g)})}if(a.length>0){const o=document.createElement("li");o.className="results-heading",o.textContent="Favorites",o.style.fontWeight="bold",o.style.background="#f0f0f0",e.appendChild(o),a.forEach(l=>{const c=r(l);c&&e.appendChild(c)})}if(i.length>0){const o=document.createElement("li");o.className="results-heading",o.textContent="Previous Locations",o.style.fontWeight="bold",o.style.background="#f0f0f0",e.appendChild(o),i.forEach(l=>{const c=r(l);c&&e.appendChild(c)})}console.log("renderResultsList: Liste gerendert.")}function ct(){try{return JSON.parse(localStorage.getItem("coordHistory"))||[]}catch{return[]}}function Bt(t){try{localStorage.setItem("coordHistory",JSON.stringify(t))}catch(e){console.error("Error saving history:",e)}}function ba(t,e,n,a=!1){if(isNaN(t)||isNaN(e))return;let i=ct();const r=parseFloat(t.toFixed(5)),o=parseFloat(e.toFixed(5));i=i.filter(u=>Math.abs(u.lat-r)>1e-4||Math.abs(u.lng-o)>1e-4),i.unshift({lat:r,lng:o,label:n,isFavorite:a,timestamp:Date.now()});const l=i.filter(u=>u.isFavorite),c=i.filter(u=>!u.isFavorite).slice(0,5);Bt([...l,...c]),Ae()}function Rr(t,e,n,a=!1){if(isNaN(t)||isNaN(e)){console.error("Ungültige Koordinaten in addOrUpdateFavorite:",{lat:t,lng:e});return}if(Ne){console.log("addOrUpdateFavorite blockiert.");return}Ne=!0;try{let i=ct();const r=parseFloat(t.toFixed(5)),o=parseFloat(e.toFixed(5));console.log("addOrUpdateFavorite: Verarbeite:",{newLat:r,newLng:o,name:n});const l=i.find(c=>Math.abs(c.lat-r)<1e-4&&Math.abs(c.lng-o)<1e-4);if(l)console.log("addOrUpdateFavorite: Aktualisiere bestehenden Eintrag:",l),l.isFavorite=!0,l.label=n;else{const c={lat:r,lng:o,label:n,isFavorite:!0,timestamp:Date.now()};console.log("addOrUpdateFavorite: Füge neuen Eintrag hinzu:",c),i.unshift(c)}Bt(i),console.log("addOrUpdateFavorite: Verlauf nach Speicherung:",JSON.stringify(i)),a||p.handleMessage(`"${n}" als Favorit gespeichert.`),Ae(),Ea()}catch(i){console.error("Fehler in addOrUpdateFavorite:",i)}finally{Ne=!1,console.log("addOrUpdateFavorite abgeschlossen.")}}function hc(t,e,n){if(isNaN(t)||isNaN(e)){console.error("Ungültige Koordinaten in toggleFavorite:",{lat:t,lng:e});return}if(Ne){console.log("toggleFavorite blockiert: Ein Favorit wird bereits hinzugefügt.");return}let a=ct();const i=parseFloat(t.toFixed(5)),r=parseFloat(e.toFixed(5));console.log("toggleFavorite: Suche nach Eintrag mit:",{newLat:i,newLng:r,label:n});const o=a.find(l=>{const c=parseFloat(l.lat),u=parseFloat(l.lng);return Math.abs(c-i)<1e-4&&Math.abs(u-r)<1e-4});if(o)if(console.log("toggleFavorite: Bestehender Eintrag gefunden:",o),o.isFavorite)o.isFavorite=!1,p.handleMessage(`"${o.label}" ist kein Favorit mehr.`),Bt(a),Ae(),Ea();else{Ne=!0;try{const l=prompt("Please enter a name for this favorite:",o.label||n);if(l)o.isFavorite=!0,o.label=l,p.handleMessage(`"${l}" als Favorit gespeichert.`),Bt(a),Ae();else{o.isFavorite=!1;return}}finally{Ne=!1,console.log("toggleFavorite abgeschlossen, Sperre aufgehoben.")}}else{console.log("toggleFavorite: Kein bestehender Eintrag, füge neuen Favoriten hinzu.");const l=prompt("Please enter a name for this favorite:",n);l&&Rr(i,r,l)}}function mc(t,e){if(isNaN(t)||isNaN(e))return;const a=ct().filter(i=>{const r=parseFloat(i.lat),o=parseFloat(i.lng||i.lon);return Math.abs(r-t)>1e-4||Math.abs(o-e)>1e-4});Bt(a),p.handleMessage("Location deleted."),Ae(),Ea()}function Ea(){const e=ct().filter(a=>a.isFavorite),n=new CustomEvent("favorites:updated",{detail:{favorites:e},bubbles:!0,cancelable:!0});document.dispatchEvent(n)}function fc(t,e,n,a){if(!s.map)return console.warn("Map not initialized for getTooltipContent"),"Map not initialized";const i=m.getValue("coordFormat","Decimal"),r=m.getValue("windUnit","kt"),o=m.getValue("heightUnit","m"),l=p.convertCoords(t.lat,t.lng,i);let c=i==="MGRS"?`MGRS: ${l.lat}`:`Lat: ${l.lat}<br>Lng: ${l.lng}`;const u=t.ele;let d=u!==null&&a!==null?u-a:null;if(d!==null){const f=o||m.state.userSettings.heightUnit||"m";d=p.convertHeight(d,f),d=Math.round(d),c+=`<br>Altitude: ${d} ${f} AGL`}else c+="<br>Altitude: N/A";let h="N/A",g="N/A";if(e>0&&t.time&&n[e-1].time&&t.ele!==null&&n[e-1].ele!==null){const f=(t.time.toMillis()-n[e-1].time.toMillis())/1e3;if(f>0){const v=s.map.distance([n[e-1].lat,n[e-1].lng],[t.lat,t.lng])/f;h=p.convertWind(v,r,"m/s"),h=r==="bft"?Math.round(h):h.toFixed(1),g=((t.ele-n[e-1].ele)/f).toFixed(1)}}return c+=`<br>Speed: ${h} ${r}`,c+=`<br>Descent Rate: ${g} m/s`,c}async function gc(t){if(!s.map)return p.handleError("Map not initialized."),null;s.isLoadingGpx=!0;const e=new FileReader;return new Promise((n,a)=>{e.onload=async function(i){var r,o;try{const l=i.target.result,d=new DOMParser().parseFromString(l,"text/xml").getElementsByTagName("trkpt"),h=[];for(let f=0;f<d.length;f++){const w=parseFloat(d[f].getAttribute("lat")),v=parseFloat(d[f].getAttribute("lon"));if(isNaN(w)||isNaN(v))continue;const y=(r=d[f].getElementsByTagName("ele")[0])==null?void 0:r.textContent,S=(o=d[f].getElementsByTagName("time")[0])==null?void 0:o.textContent;h.push({lat:w,lng:v,ele:y?parseFloat(y):null,time:S?I.fromISO(S,{zone:"utc"}):null})}if(h.length<2)throw new Error("GPX track has insufficient points.");const g=await Ur(h,t.name);n(g)}catch(l){console.error("[trackManager] Error in loadGpxTrack:",l),p.handleError("Error parsing GPX file: "+l.message),n(null)}finally{s.isLoadingGpx=!1}},e.onerror=()=>{p.handleError("Error reading GPX file."),s.isLoadingGpx=!1,a(new Error("Error reading GPX file."))},e.readAsText(t)})}async function pc(t){if(!s.map)return p.handleError("Map not initialized."),null;s.isLoadingGpx=!0;const e=new FileReader;return new Promise((n,a)=>{e.onload=async function(i){try{const r=i.target.result,o=[];Papa.parse(r,{skipEmptyLines:!0,step:function(l){const c=l.data;if(c[0]&&c[0].toUpperCase()==="$GNSS"&&c.length>=5){let u=c[1];const d=parseFloat(c[2]),h=parseFloat(c[3]),g=parseFloat(c[4]);if(isNaN(d)||isNaN(h)||isNaN(g))return;let f=null;try{f=I.fromISO(u,{setZone:!0}).toUTC(),f.isValid||(f=null)}catch{f=null}o.push({lat:d,lng:h,ele:g,time:f})}},complete:async function(){if(o.length<2)throw new Error("CSV track has insufficient points.");const l=await Ur(o,t.name);n(l)},error:function(l){throw new Error("Error parsing CSV: "+l.message)}})}catch(r){console.error("[trackManager] Error in loadCsvTrackUTC:",r),p.handleError("Error parsing CSV file: "+r.message),n(null)}finally{s.isLoadingGpx=!1}},e.onerror=()=>{p.handleError("Error reading CSV file."),s.isLoadingGpx=!1,a(new Error("Error reading CSV file."))},e.readAsText(t)})}async function Ur(t,e){try{if(console.log(`[trackManager] renderTrack called for ${e} with ${t.length} points.`),!s.map)return console.warn("[trackManager] Map object in AppState is not available in renderTrack."),p.handleError("Map not initialized. Cannot render track."),null;s.gpxLayer&&s.map.hasLayer(s.gpxLayer)&&s.map.removeLayer(s.gpxLayer),s.gpxLayer=null,s.gpxPoints=t,s.isTrackLoaded=!1;const n={finalPointData:null,timestampToUseForWeather:null,historicalDateString:null,summaryForInfoElement:"",success:!1};if(t.length>0){const i=t[t.length-1];if(s.lastLat=i.lat,s.lastLng=i.lng,s.lastAltitude=await p.getAltitude(s.lastLat,s.lastLng),n.finalPointData={lat:s.lastLat,lng:s.lastLng,altitude:s.lastAltitude},t[0].time&&t[0].time.isValid){const d=t[0].time,h=I.utc().startOf("day"),g=d.startOf("day");g<h&&(n.historicalDateString=g.toFormat("yyyy-MM-dd"));let f=d.startOf("hour");d.minute>=30&&(f=f.plus({hours:1})),n.timestampToUseForWeather=f.toISO()}const r=(t.reduce((d,h,g)=>{if(g===0||!s.map)return 0;const f=t[g-1];return d+s.map.distance([f.lat,f.lng],[h.lat,h.lng])},0)/1e3).toFixed(2),o=t.map(d=>d.ele).filter(d=>d!==null),l=o.length?Math.min(...o).toFixed(0):"N/A",c=o.length?Math.max(...o).toFixed(0):"N/A",u=new CustomEvent("track:loaded",{detail:{lat:s.lastLat,lng:s.lastLng,altitude:s.lastAltitude,timestamp:n.timestampToUseForWeather,historicalDate:n.historicalDateString,summary:`<br><strong>Track:</strong> Distance: ${r} km, Min Elevation: ${l} m, Max Elevation: ${c} m (Source: ${e})`},bubbles:!0,cancelable:!0});s.map.getContainer().dispatchEvent(u)}s.gpxLayer=L.layerGroup([],{pane:"gpxTrackPane"});const a=s.lastAltitude!=="N/A"&&!isNaN(s.lastAltitude)?parseFloat(s.lastAltitude):null;for(let i=0;i<t.length-1;i++){const r=t[i],o=t[i+1],l=r.ele,c=o.ele;let u="#808080";if(a!==null&&l!==null&&c!==null){const h=l-a,g=c-a,f=(h+g)/2;u=p.interpolateColor(f)}const d=L.polyline([[r.lat,r.lng],[o.lat,o.lng]],{color:u,weight:4,opacity:.75,pane:"gpxTrackPane"}).bindTooltip("",{sticky:!0});d.on("mousemove",function(h){const g=h.latlng;let f=t[0],w=1/0,v=0;t.forEach((y,S)=>{const _=Math.sqrt(Math.pow(y.lat-g.lat,2)+Math.pow(y.lng-g.lng,2));_<w&&(w=_,f=y,v=S)}),d.setTooltipContent(fc(f,v,t,a)).openTooltip(g)}),s.gpxLayer.addLayer(d)}if(s.map&&s.gpxLayer.addTo(s.map),s.isTrackLoaded=!0,t.length>0&&s.map){const i=L.latLngBounds(t.map(r=>[r.lat,r.lng]));i.isValid()?s.map.fitBounds(i,{padding:[50,50],maxZoom:s.map.getMaxZoom()||18}):p.handleError("Unable to display track: invalid coordinates.")}return n.success=!0,console.log("[trackManager] renderTrack finished successfully."),n}catch(n){return console.error("[trackManager] Error in renderTrack:",n),p.handleError("Error rendering track: "+n.message),s.gpxPoints=[],s.gpxLayer&&s.map&&s.map.hasLayer(s.gpxLayer)&&s.map.removeLayer(s.gpxLayer),s.gpxLayer=null,s.isTrackLoaded=!1,{success:!1,error:n.message}}}function gi(t){const n=`
        <div class="live-marker-wrapper" style="transform: rotate(${typeof t=="number"&&isFinite(t)?t:0}deg);">
            <div class="live-marker-dot"></div>
            <div class="live-marker-arrow"></div>
        </div>
    `;return L.divIcon({className:"live-marker-container",html:n,iconSize:[24,24],iconAnchor:[12,12]})}function yc(t,e,n){s.accuracyCircle&&s.map.removeLayer(s.accuracyCircle),s.accuracyCircle=L.circle([t,e],{radius:n,color:"blue",fillOpacity:.1,weight:1,dashArray:"5, 5"}).addTo(s.map)}const wc=p.debounce(async t=>{if(console.log("[LiveTrackingManager] Received position data:",t),!s.map){console.warn("[LiveTrackingManager] Map not initialized, skipping position update.");return}const{latitude:e,longitude:n,accuracy:a,altitude:i,altitudeAccuracy:r}=t.coords;if(console.log("[LiveTrackingManager] Position details:",{latitude:e,longitude:n,accuracy:a,deviceAltitude:i,altitudeAccuracy:r}),a>Se.GEOLOCATION_ACCURACY_THRESHOLD_M){console.log("[LiveTrackingManager] Skipping position update due to low accuracy:",a);return}const o=Date.now();let l=0,c="N/A";if(s.prevLat!==null&&s.prevLng!==null&&s.prevTime!==null){const h=s.map.distance([s.prevLat,s.prevLng],[e,n]),g=(o-s.prevTime)/1e3;g>rn.MIN_TIME_DIFF_FOR_SPEED_CALC_S&&(l=h/g,c=p.calculateBearing(s.prevLat,s.prevLng,e,n))}const u=l<rn.SPEED_SMOOTHING_TRESHOLD?rn.SPEED_SMOOTHING_LOW:rn.SPEED_SMOOTHING_HIGH;s.lastSmoothedSpeedMs=u*l+(1-u)*s.lastSmoothedSpeedMs,s.liveMarker?(s.liveMarker.setLatLng([e,n]),s.liveMarker.setIcon(gi(c))):s.liveMarker=L.marker([e,n],{icon:gi(c),zIndexOffset:1e3}).addTo(s.map),a&&yc(e,n,a),s.prevLat=e,s.prevLng=n,s.prevTime=o;const d=new CustomEvent("tracking:positionUpdated",{detail:{latitude:e,longitude:n,deviceAltitude:i,altitudeAccuracy:r,accuracy:a,speedMs:s.lastSmoothedSpeedMs,direction:typeof c=="number"?c.toFixed(0):"N/A"},bubbles:!0,cancelable:!0});console.log("[LiveTrackingManager] Dispatching tracking:positionUpdated event:",d.detail),document.dispatchEvent(d)},300);function vc(){if(s.watchId===null){if(!navigator.geolocation){p.handleError("Geolocation is not supported by your browser."),document.dispatchEvent(new CustomEvent("tracking:stopped"));return}console.log("[LiveTrackingManager] Starting position tracking..."),s.watchId=navigator.geolocation.watchPosition(wc,t=>{p.handleError(`Geolocation error: ${t.message}`),Wr()},{enableHighAccuracy:!0,maximumAge:0,timeout:1e4}),document.dispatchEvent(new CustomEvent("tracking:started"))}}function Wr(){s.watchId!==null&&(navigator.geolocation.clearWatch(s.watchId),s.watchId=null),s.liveMarker&&s.map.removeLayer(s.liveMarker),s.accuracyCircle&&s.map.removeLayer(s.accuracyCircle),s.liveMarker=null,s.accuracyCircle=null,s.prevLat=null,s.prevLng=null,s.prevTime=null,s.lastSmoothedSpeedMs=0,document.dispatchEvent(new CustomEvent("tracking:stopped")),console.log("[LiveTrackingManager] Stopped position tracking and cleaned up.")}function pi(){if(s.autoupdateInterval){console.log("[AutoupdateManager] Autoupdate is already running.");return}if(!navigator.onLine){p.handleError("Cannot enable autoupdate while offline.");const t=document.getElementById("autoupdateCheckbox");t&&(t.checked=!1),m.state.userSettings.autoupdate=!1,m.save();return}console.log("[AutoupdateManager] Starting autoupdate interval."),document.dispatchEvent(new CustomEvent("autoupdate:tick",{detail:{isInitialTick:!0}})),s.autoupdateInterval=setInterval(()=>{console.log("[AutoupdateManager] Tick..."),document.dispatchEvent(new CustomEvent("autoupdate:tick",{detail:{isInitialTick:!1}}))},60*1e3),p.handleMessage("Autoupdate enabled")}function Hr(){s.autoupdateInterval&&(clearInterval(s.autoupdateInterval),s.autoupdateInterval=null,console.log("[AutoupdateManager] Stopped autoupdate interval."),displayMessage("Autoupdate disabled"))}function Lc(){var e;const t=document.getElementById("autoupdateCheckbox");if(!t){console.warn("[AutoupdateManager] Autoupdate checkbox not found.");return}t.checked=m.state.userSettings.autoupdate,t.addEventListener("change",()=>{m.state.userSettings.autoupdate=t.checked,m.save();const n=document.getElementById("historicalDatePicker");if(t.checked&&(n!=null&&n.value)){t.checked=!1,m.state.userSettings.autoupdate=!1,m.save(),p.handleError("Autoupdate cannot be enabled with a historical date set.");return}t.checked?pi():Hr()}),m.state.userSettings.autoupdate&&!((e=document.getElementById("historicalDatePicker"))!=null&&e.value)&&pi()}var Mc=15e3,oa=1e3,sa=60*oa,un=60*sa,Bn=24*un,Sc="http://www.topografix.com/GPX/gpx_style/0/2",sn=new L.Icon.Default,_c={startIcon:sn,endIcon:sn,wptIcons:{"":sn},wptTypeIcons:{"":sn},pointMatchers:[]},bc={iconSize:[33,45],iconAnchor:[16,45],clickable:!1},Ec={color:"blue"},Tc={parseElements:["track","route","waypoint"],joinTrackSegments:!0};L.GPX=L.FeatureGroup.extend({initialize:function(t,e){e.max_point_interval=e.max_point_interval||Mc,e.markers=this._merge_objs(_c,e.markers||{}),e.marker_options=this._merge_objs(bc,e.marker_options||{}),e.polyline_options=e.polyline_options||[],e.gpx_options=this._merge_objs(Tc,e.gpx_options||{}),L.Util.setOptions(this,e),L.GPXTrackIcon=L.Icon.extend({options:e.marker_options}),this._gpx=t,this._layers={},this._prepare_markers(e.markers),this._init_info(),t&&this._parse(t,e,this.options.async)},get_duration_string:function(t,e){var n="";t>=Bn&&(n+=Math.floor(t/Bn)+"d ",t=t%Bn),t>=un&&(n+=Math.floor(t/un)+":",t=t%un);var a=Math.floor(t/sa);t=t%sa,a<10&&(n+="0"),n+=a+"'";var i=Math.floor(t/oa);return t=t%oa,i<10&&(n+="0"),n+=i,!e&&t>0?n+="."+Math.round(Math.floor(t)*1e3)/1e3:n+='"',n},get_duration_string_iso:function(t,e){var n=this.get_duration_string(t,e);return n.replace("'",":").replace('"',"")},_toFixed_helper:function(t,e=0){return typeof t=="number"?t.toFixed(e):"?"},to_miles:function(t){return t/1.60934},to_ft:function(t){return t*3.28084},m_to_km:function(t){return t/1e3},m_to_mi:function(t){return t/1609.34},ms_to_kmh:function(t){return t*3.6},ms_to_mih:function(t){return t/1609.34*3600},get_name:function(){return this._info.name},get_desc:function(){return this._info.desc},get_author:function(){return this._info.author},get_copyright:function(){return this._info.copyright},get_distance:function(){return this._info.length},get_distance_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))},get_start_time:function(){return this._info.duration.start},get_end_time:function(){return this._info.duration.end},get_moving_time:function(){return this._info.duration.moving},get_total_time:function(){return this._info.duration.total},get_moving_pace:function(){return this.get_moving_time()/this.m_to_km(this.get_distance())},get_moving_pace_imp:function(){return this.get_moving_time()/this.get_distance_imp()},get_moving_speed:function(){return this.m_to_km(this.get_distance())/(this.get_moving_time()/(3600*1e3))},get_moving_speed_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))/(this.get_moving_time()/(3600*1e3))},get_total_speed:function(){return this.m_to_km(this.get_distance())/(this.get_total_time()/(3600*1e3))},get_total_speed_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))/(this.get_total_time()/(3600*1e3))},get_elevation_gain:function(){return this._info.elevation.gain},get_elevation_loss:function(){return this._info.elevation.loss},get_elevation_gain_imp:function(){return this.to_ft(this.get_elevation_gain())},get_elevation_loss_imp:function(){return this.to_ft(this.get_elevation_loss())},get_elevation_data:function(){var t=this;return this._info.elevation._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" m"})})},get_elevation_data_imp:function(){var t=this;return this._info.elevation._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,t.to_ft,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" ft"})})},get_elevation_max:function(){return this._info.elevation.max},get_elevation_min:function(){return this._info.elevation.min},get_elevation_max_imp:function(){return this.to_ft(this.get_elevation_max())},get_elevation_min_imp:function(){return this.to_ft(this.get_elevation_min())},get_speed_data:function(){var t=this;return this._info.speed._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,t.ms_to_kmh,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,2)+" km/h"})})},get_speed_data_imp:function(){var t=this;return this._info.speed._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,t.ms_to_mih,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,2)+" mi/h"})})},get_speed_max:function(){return this.m_to_km(this._info.speed.max)*3600},get_speed_max_imp:function(){return this.to_miles(this.get_speed_max())},get_average_hr:function(){return this._info.hr.avg},get_average_temp:function(){return this._info.atemp.avg},get_average_cadence:function(){return this._info.cad.avg},get_heartrate_data:function(){var t=this;return this._info.hr._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" bpm"})})},get_heartrate_data_imp:function(){var t=this;return this._info.hr._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,null,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" bpm"})})},get_cadence_data:function(){var t=this;return this._info.cad._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" rpm"})})},get_temp_data:function(){var t=this;return this._info.atemp._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" degrees"})})},get_cadence_data_imp:function(){var t=this;return this._info.cad._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,null,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" rpm"})})},get_temp_data_imp:function(){var t=this;return this._info.atemp._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,null,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" degrees"})})},reload:function(){this._init_info(),this.clearLayers(),this._parse(this._gpx,this.options,this.options.async)},_merge_objs:function(t,e){var n={};for(var a in t)n[a]=t[a];for(var a in e)n[a]=e[a];return n},_prepare_data_point:function(t,e,n,a){var i=[e&&e(t[0])||t[0],n&&n(t[1])||t[1]];return i.push(a&&a(i[0],i[1])||i[0]+": "+i[1]),i},_prepare_markers:function(t){function e(n){return new L.GPXTrackIcon({iconUrl:n})}return Object.entries(t).forEach(([n,a])=>{n==="wptIcons"||n==="wptTypeIcons"?t[n]=this._prepare_markers(a):n==="pointMatchers"?t[n]=a.map(i=>(typeof i.icon=="string"&&(i.icon=e(i.icon)),i)):typeof a=="string"?t[n]=e(a):typeof a=="object"&&a!==null&&(t[n]=a)}),t},_init_info:function(){this._info={name:null,length:0,elevation:{gain:0,loss:0,max:0,min:1/0,_points:[]},speed:{max:0,_points:[]},hr:{avg:0,_total:0,_points:[]},duration:{start:null,end:null,moving:0,total:0},atemp:{avg:0,_total:0,_points:[]},cad:{avg:0,_total:0,_points:[]}}},_load_xml:function(t,e,n,a){a==null&&(a=this.options.async),n==null&&(n=this.options);var i=this,r=new window.XMLHttpRequest;r.open("GET",t,a);try{r.overrideMimeType("text/xml")}catch{}r.onloadend=function(){r.status==200?e(r.responseXML,n):i.fire("error",{err:"Error fetching resource: "+t})},r.send(null)},_parse:function(t,e,n){var a=this,i=function(o,l){var c=a._parse_gpx_data(o,l);if(!c){a.fire("error",{err:"No parseable layers of type(s) "+JSON.stringify(l.gpx_options.parseElements)});return}a.addLayer(c),a.fire("loaded",{layers:c,element:o})};if(t.substr(0,1)==="<"){var r=new DOMParser;n?setTimeout(function(){i(r.parseFromString(t,"text/xml"),e)}):i(r.parseFromString(t,"text/xml"),e)}else this._load_xml(t,i,e,n)},_parse_gpx_data:function(t,e){var n,a,i=[],r=t.getElementsByTagName("name");r.length>0&&(this._info.name=r[0].textContent);var o=t.getElementsByTagName("desc");o.length>0&&(this._info.desc=o[0].textContent);var l=t.getElementsByTagName("author");l.length>0&&(this._info.author=l[0].textContent);var c=t.getElementsByTagName("copyright");c.length>0&&(this._info.copyright=c[0].textContent);var u=e.gpx_options.parseElements;if(u.indexOf("route")>-1){var d=t.getElementsByTagName("rte");for(n=0;n<d.length;n++){var h=d[n],g=this._extract_styling(h),f=this._get_polyline_options(e.polyline_options,n);i=i.concat(this._parse_segment(d[n],e,g,f,"rtept"))}}if(u.indexOf("track")>-1){var w=t.getElementsByTagName("trk");for(n=0;n<w.length;n++){var v=w[n],g=this._extract_styling(v),f=this._get_polyline_options(e.polyline_options,n);if(e.gpx_options.joinTrackSegments)i=i.concat(this._parse_segment(v,e,g,f,"trkpt"));else{var y=v.getElementsByTagName("trkseg");for(P=0;P<y.length;P++)i=i.concat(this._parse_segment(y[P],e,g,f,"trkpt"))}}}if(this._info.hr.avg=Math.round(this._info.hr._total/this._info.hr._points.length),this._info.cad.avg=Math.round(this._info.cad._total/this._info.cad._points.length),this._info.atemp.avg=Math.round(this._info.atemp._total/this._info.atemp._points.length),u.indexOf("waypoint")>-1)for(a=t.getElementsByTagName("wpt"),n=0;n<a.length;n++){var S=new L.LatLng(a[n].getAttribute("lat"),a[n].getAttribute("lon")),_=a[n].getElementsByTagName("name"),r=_.length>0?_[0].textContent:"",E=a[n].getElementsByTagName("desc"),o=E.length>0?E[0].textContent:"",M=a[n].getElementsByTagName("sym"),b=M.length>0?M[0].textContent:null,k=a[n].getElementsByTagName("type"),A=k.length>0?k[0].textContent:null,T=e.markers.wptIcons,F=e.markers.wptTypeIcons,D=e.markers.pointMatchers||[],N;if(T&&b&&T[b])N=T[b];else if(F&&A&&F[A])N=F[A];else if(D.length>0){for(var P=0;P<D.length;P++)if(D[P].regex.test(r)){N=D[P].icon;break}}else T&&T[""]&&(N=T[""]);if(!N){console.log("No waypoint icon could be matched for symKey=%s,typeKey=%s,name=%s on waypoint %o",b,A,r,a[n]);continue}var $=new L.Marker(S,{clickable:e.marker_options.clickable,title:r,icon:N,type:"waypoint"});$.bindPopup("<b>"+r+"</b>"+(o.length>0?"<br>"+o:"")).openPopup(),this.fire("addpoint",{point:$,point_type:"waypoint",element:a[n]}),i.push($)}if(i.length>1)return new L.FeatureGroup(i);if(i.length==1)return i[0]},_parse_segment:function(t,e,n,a,i){var r=t.getElementsByTagName(i);if(!r.length)return[];for(var o=[],l=[],c=[],u=null,d=0;d<r.length;d++){var h,g=new L.LatLng(r[d].getAttribute("lat"),r[d].getAttribute("lon"));g.meta={time:null,ele:null,hr:null,cad:null,atemp:null,speed:null},h=r[d].getElementsByTagName("time"),h.length>0?g.meta.time=new Date(Date.parse(h[0].textContent)):g.meta.time=new Date("1970-01-01T00:00:00");var f=u!=null?Math.abs(g.meta.time-u.meta.time):0;h=r[d].getElementsByTagName("ele"),h.length>0?g.meta.ele=parseFloat(h[0].textContent):g.meta.ele=u!=null?u.meta.ele:null;var w=u!=null?g.meta.ele-u.meta.ele:0,v=u!=null?this._dist3d(u,g):0;if(h=r[d].getElementsByTagName("speed"),h.length>0?g.meta.speed=parseFloat(h[0].textContent):g.meta.speed=f>0?1e3*v/f:0,h=r[d].getElementsByTagName("name"),h.length>0){for(var y=h[0].textContent,S=e.markers.pointMatchers||[],_=0;_<S.length;_++)if(S[_].regex.test(y)){l.push({label:y,coords:g,icon:S[_].icon,element:r[d]});break}}this._info.length+=v,h=r[d].getElementsByTagNameNS("*","hr"),h.length>0&&(g.meta.hr=parseInt(h[0].textContent),this._info.hr._points.push([this._info.length,g.meta.hr]),this._info.hr._total+=g.meta.hr),h=r[d].getElementsByTagNameNS("*","cad"),h.length>0&&(g.meta.cad=parseInt(h[0].textContent),this._info.cad._points.push([this._info.length,g.meta.cad]),this._info.cad._total+=g.meta.cad),h=r[d].getElementsByTagNameNS("*","atemp"),h.length>0&&(g.meta.atemp=parseInt(h[0].textContent),this._info.atemp._points.push([this._info.length,g.meta.atemp]),this._info.atemp._total+=g.meta.atemp),g.meta.ele>this._info.elevation.max&&(this._info.elevation.max=g.meta.ele),g.meta.ele<this._info.elevation.min&&(this._info.elevation.min=g.meta.ele),this._info.elevation._points.push([this._info.length,g.meta.ele]),g.meta.speed>this._info.speed.max&&(this._info.speed.max=g.meta.speed),this._info.speed._points.push([this._info.length,g.meta.speed]),u==null&&this._info.duration.start==null&&(this._info.duration.start=g.meta.time),this._info.duration.end=g.meta.time,this._info.duration.total+=f,f<e.max_point_interval&&(this._info.duration.moving+=f),w>0?this._info.elevation.gain+=w:this._info.elevation.loss+=Math.abs(w),u=g,o.push(g)}var E=new L.Polyline(o,this._extract_styling(t,n,a));if(this.fire("addline",{line:E,element:t}),c.push(E),e.markers.startIcon){var M=new L.Marker(o[0],{clickable:e.marker_options.clickable,icon:e.markers.startIcon});this.fire("addpoint",{point:M,point_type:"start",element:r[0],line:t}),c.push(M)}if(e.markers.endIcon){var M=new L.Marker(o[o.length-1],{clickable:e.marker_options.clickable,icon:e.markers.endIcon});this.fire("addpoint",{point:M,point_type:"end",element:r[r.length-1],line:t}),c.push(M)}for(var d=0;d<l.length;d++){var M=new L.Marker(l[d].coords,{clickable:e.marker_options.clickable,title:l[d].label,icon:l[d].icon});this.fire("addpoint",{point:M,point_type:"label",element:l[d].element}),c.push(M)}return c},_get_polyline_options:function(t,e){return Array.isArray(t)?t[e]||{}:t},_extract_styling:function(t,e,n){var a=this._merge_objs(Ec,e),i=t.getElementsByTagNameNS(Sc,"line");if(i.length>0){var r=i[0].getElementsByTagName("color");r.length>0&&(a.color="#"+r[0].textContent);var r=i[0].getElementsByTagName("opacity");r.length>0&&(a.opacity=r[0].textContent);var r=i[0].getElementsByTagName("weight");r.length>0&&(a.weight=r[0].textContent);var r=i[0].getElementsByTagName("linecap");r.length>0&&(a.lineCap=r[0].textContent);var r=i[0].getElementsByTagName("linejoin");r.length>0&&(a.lineJoin=r[0].textContent);var r=i[0].getElementsByTagName("dasharray");r.length>0&&(a.dashArray=r[0].textContent);var r=i[0].getElementsByTagName("dashoffset");r.length>0&&(a.dashOffset=r[0].textContent)}return this._merge_objs(a,n)},_dist2d:function(t,e){var n=6371e3,a=this._deg2rad(e.lat-t.lat),i=this._deg2rad(e.lng-t.lng),r=Math.sin(a/2)*Math.sin(a/2)+Math.cos(this._deg2rad(t.lat))*Math.cos(this._deg2rad(e.lat))*Math.sin(i/2)*Math.sin(i/2),o=2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r)),l=n*o;return l},_dist3d:function(t,e){var n=this._dist2d(t,e),a=Math.abs(e.meta.ele-t.meta.ele);return Math.sqrt(Math.pow(n,2)+Math.pow(a,2))},_deg2rad:function(t){return t*Math.PI/180}});let yi=!1;function kc(t,e={}){console.log(`[EventManager] Dispatching event: ${t}`,e);const n=new CustomEvent(t,{detail:e,bubbles:!0,cancelable:!0});document.dispatchEvent(n)}function et(t,e,n){console.log(`setupCheckbox called for id: ${t}`);const a=document.getElementById(t);a?(a._changeHandler&&(a.removeEventListener("change",a._changeHandler),console.log(`Removed previous change listener for ${t}`)),a._changeHandler=i=>{console.log(`Change event fired for ${t}, checked: ${a.checked}, event:`,i),i.stopPropagation(),n(a)},a.addEventListener("change",a._changeHandler),a.addEventListener("click",i=>{console.log(`Click event on ${t}, checked: ${a.checked}, target:`,i.target)}),console.log(`Attached change and click listeners to ${t}`),t==="showLandingPattern"&&!(m.isFeatureUnlocked("landingPattern")&&m.state.isLandingPatternUnlocked)&&(a.style.opacity="0.5",a.title="Feature locked. Click to enter password.")):console.warn(`Checkbox ${t} not found`)}function Gn(t,e,n){if(console.log(`toggleSubmenu called for ${t.textContent||t.id}: ${n?"show":"hide"}`),e){e.classList.contains("submenu")||e.classList.add("submenu"),e.classList.toggle("hidden",!n),t.setAttribute("aria-expanded",n),console.log(`Submenu toggled for ${t.textContent||t.id}: ${n?"shown":"hidden"}`);let a=0;const i=5,r=()=>{const o={isHidden:e.classList.contains("hidden"),displayStyle:window.getComputedStyle(e).display};n&&(o.isHidden||o.displayStyle==="none")&&(console.warn(`Submenu for ${t.textContent||t.id} was hidden unexpectedly. Forcing it to be visible.`),e.classList.remove("hidden"),e.style.display="block",a++,a<i&&setTimeout(r,100))};setTimeout(r,100)}else console.warn(`Submenu for ${t.textContent||t.id} not found`)}function Ee(t,e){document.querySelectorAll(`input[name="${t}"]`).forEach(a=>{a.addEventListener("change",()=>{const i=document.querySelector(`input[name="${t}"]:checked`);if(!i)return;const r=i.value;if(m.state.userSettings[t]=r,m.save(),console.log(`${t} changed to: ${r} and saved to localStorage`),t==="landingDirection"){const o=document.getElementById("customLandingDirectionLL"),l=document.getElementById("customLandingDirectionRR");o&&(o.disabled=r!=="LL"),l&&(l.disabled=r!=="RR"),r==="LL"&&o&&!o.value&&m.state.userSettings.customLandingDirectionLL===""&&(o.value=Math.round(s.landingWindDir||0),m.state.userSettings.customLandingDirectionLL=parseInt(o.value),m.save(),console.log(`Set customLandingDirectionLL to ${o.value}`)),r==="RR"&&l&&!l.value&&m.state.userSettings.customLandingDirectionRR===""&&(l.value=Math.round(s.landingWindDir||0),m.state.userSettings.customLandingDirectionRR=parseInt(l.value),m.save(),console.log(`Set customLandingDirectionRR to ${l.value}`))}document.dispatchEvent(new CustomEvent("ui:radioGroupChanged",{detail:{name:t,value:r}})),e&&e()})})}function Y(t,e,n,a){const i=document.getElementById(t);i&&i.addEventListener(e,p.debounce(()=>{const r=i.type==="number"?parseFloat(i.value):i.value;a&&a(r)===!1||(m.state.userSettings[t]=r,m.save(),console.log(`${t} changed to: ${r} and saved to localStorage`),document.dispatchEvent(new CustomEvent("ui:inputChanged",{detail:{name:t,value:r}})))},n))}function Ac(){console.log("setupMenuEvents wird aufgerufen für allgemeine Menü-Logik.");const t=document.getElementById("hamburgerBtn"),e=document.getElementById("menu");!t||!e||(t.addEventListener("click",n=>{n.stopPropagation(),e.classList.toggle("hidden")}),document.addEventListener("click",n=>{!e.contains(n.target)&&!t.contains(n.target)&&e.classList.add("hidden")}),e.addEventListener("click",n=>{const a=n.target;if(a.matches("li > span")||a.matches("li > label")){n.preventDefault(),n.stopPropagation();const r=a.closest("li").querySelector("ul.submenu");r&&r.classList.toggle("hidden")}}))}function Cc(){if(!s.map){console.warn("Map not initialized, skipping setupCheckboxEvents");return}et("showTableCheckbox","showTable",i=>{m.state.userSettings.showTable=i.checked,m.save(),document.dispatchEvent(new CustomEvent("ui:showTableChanged",{detail:{checked:i.checked}}))}),et("showExitAreaCheckbox","showExitArea",i=>{m.state.userSettings.showExitArea=i.checked,m.save(),document.dispatchEvent(new CustomEvent("ui:jumpFeatureChanged"))}),et("showCanopyAreaCheckbox","showCanopyArea",i=>{m.state.userSettings.showCanopyArea=i.checked,m.save(),document.dispatchEvent(new CustomEvent("ui:jumpFeatureChanged"))}),et("showJumpRunTrack","showJumpRunTrack",i=>{m.state.userSettings.showJumpRunTrack=i.checked,m.save(),document.dispatchEvent(new CustomEvent("ui:showJumpRunTrackChanged",{detail:{checked:i.checked}}))}),et("showCutAwayFinder","showCutAwayFinder",i=>{m.state.userSettings.showCutAwayFinder=i.checked,m.save(),document.dispatchEvent(new CustomEvent("ui:showCutAwayFinderChanged",{detail:{checked:i.checked}}))}),et("showLandingPattern","showLandingPattern",i=>{const r="landingPattern",o=()=>{var u;m.state.userSettings.showLandingPattern=!0,m.save();const c=(u=i.closest("li"))==null?void 0:u.querySelector("ul");Gn(i,c,!0),document.dispatchEvent(new CustomEvent("ui:landingPatternEnabled"))},l=()=>{var u;m.state.userSettings.showLandingPattern=!1,m.save(),i.checked=!1;const c=(u=i.closest("li"))==null?void 0:u.querySelector("ul");Gn(i,c,!1),document.dispatchEvent(new CustomEvent("ui:landingPatternDisabled"))};i.checked?m.isFeatureUnlocked(r)?o():m.showPasswordModal(r,o,l):l()}),et("trackPositionCheckbox","trackPosition",i=>{m.state.userSettings.trackPosition=i.checked,m.save(),document.dispatchEvent(new CustomEvent("ui:trackPositionToggled",{detail:{checked:i.checked}}))});const t=document.getElementById("showJumpMasterLine");t&&(t.disabled=!m.state.userSettings.trackPosition,t.style.opacity=t.disabled?"0.5":"1",t.addEventListener("change",()=>{var o;const i=t.checked;if(i&&t.disabled){t.checked=!1,p.handleError("Please start Live Tracking first.");return}m.state.userSettings.showJumpMasterLine=i,m.save(),kc("ui:showJumpMasterLineChanged",{isChecked:i});const r=(o=t.closest("li"))==null?void 0:o.querySelector("ul.submenu");r&&Gn(t,r,i)})),Ee("jumpMasterLineTarget",()=>{const i=m.getValue("jumpMasterLineTarget","radio","DIP");m.state.userSettings.jumpMasterLineTarget=i,m.save(),console.log("jumpMasterLineTarget changed:",i),document.dispatchEvent(new CustomEvent("ui:jumpMasterLineTargetChanged"))});const e=document.getElementById("placeHarpButton");e&&e.addEventListener("click",()=>{s.isPlacingHarp=!0,console.log("HARP placement mode activated"),s.map.on("click",xr),p.handleMessage("Click the map to place the HARP marker")});const n=document.getElementById("clearHarpButton");n&&n.addEventListener("click",cc);const a=document.querySelector(".hamburger-menu");a&&a.addEventListener("click",i=>{console.log("Menu click:",i.target,"class:",i.target.className,"id:",i.target.id)})}function Ic(){const t=document.getElementById("timeSlider");t&&(t.addEventListener("input",()=>{document.dispatchEvent(new CustomEvent("ui:sliderChanged",{detail:{sliderValue:t.value},bubbles:!0,cancelable:!0}))}),t.addEventListener("change",async()=>{document.dispatchEvent(new CustomEvent("ui:sliderChangeFinished",{detail:{sliderValue:t.value},bubbles:!0,cancelable:!0}))}))}function Nc(){const t=document.getElementById("modelSelect");t&&(t.addEventListener("change",()=>{const e=t.value;console.log("Model select changed to:",e),m.state.userSettings.model=e,m.save(),document.dispatchEvent(new CustomEvent("ui:modelChanged",{detail:{model:e}}))}),document.addEventListener("models:available",e=>{const{availableModels:n}=e.detail;Fl(n),Vc(n),Dl(n)}))}function Fc(){Ee("refLevel",()=>m.updateUnitLabels()),Ee("heightUnit",()=>{m.updateUnitLabels()}),Ee("temperatureUnit",()=>{}),Ee("windUnit",()=>{m.updateUnitLabels()}),Ee("timeZone",()=>{}),Ee("coordFormat",()=>{}),Ee("downloadFormat",()=>{}),Ee("landingDirection",()=>{}),Ee("jumpMasterLineTarget",()=>{document.dispatchEvent(new CustomEvent("ui:jumpMasterLineTargetChanged"))}),document.querySelectorAll('input[name="ensembleScenario"]').forEach(a=>{a.addEventListener("change",async()=>{if(a.checked){if(m.state.userSettings.currentEnsembleScenario=a.value,s.currentEnsembleScenario=a.value,m.save(),console.log("Ensemble scenario changed to:",a.value),!m.state.userSettings.selectedEnsembleModels.every(o=>s.ensembleModelsData&&s.ensembleModelsData[o])&&a.value!=="all_models"&&!await Ir()){p.handleError("Failed to fetch data for scenario.");return}const r=Le();Nr(r)}})});const e=m.state.userSettings.currentEnsembleScenario||"all_models",n=document.querySelector(`input[name="ensembleScenario"][value="${e}"]`);n&&(n.checked=!0,s.currentEnsembleScenario=e),s.map&&!s.ensembleLayerGroup&&(s.ensembleLayerGroup=L.layerGroup().addTo(s.map))}function Dc(){const t=(e,n)=>{const a=document.getElementById(e);a&&a.addEventListener("blur",()=>{let i=parseInt(a.value)||n;const r=document.getElementById("legHeightFinal"),o=document.getElementById("legHeightBase"),l=document.getElementById("legHeightDownwind");if(!(!isNaN(i)&&i>=50&&i<=1e3&&p.validateLegHeights(r,o,l))){let u=n;const d=parseInt(r.value)||100,h=parseInt(o.value)||200,g=parseInt(l.value)||300;e==="legHeightFinal"&&(u=Math.min(h-1,100)),e==="legHeightBase"&&(u=Math.max(d+1,Math.min(g-1,200))),e==="legHeightDownwind"&&(u=Math.max(h+1,300)),a.value=u,i=u,p.handleError(`Adjusted ${e} to ${u} to maintain valid leg order.`)}m.state.userSettings[e]=i,m.save(),document.dispatchEvent(new CustomEvent("ui:inputChanged",{detail:{name:e,value:i}}))})};t("legHeightFinal",100),t("legHeightBase",200),t("legHeightDownwind",300),Y("lowerLimit","change",300),Y("upperLimit","change",300),Y("openingAltitude","change",300,e=>isNaN(e)||e<500||e>15e3?(p.handleError("Opening altitude must be between 500 and 15000 meters."),document.dispatchEvent(new CustomEvent("ui:invalidInput",{detail:{id:"openingAltitude",defaultValue:1200}})),!1):!0),Y("exitAltitude","change",300,e=>isNaN(e)||e<500||e>15e3?(p.handleError("Exit altitude must be between 500 and 15000 meters."),document.dispatchEvent(new CustomEvent("ui:invalidInput",{detail:{id:"exitAltitude",defaultValue:3e3}})),!1):!0),Y("canopySpeed","change",300),Y("descentRate","change",300),Y("interpStepSelect","change",300),Y("customLandingDirectionLL","input",100),Y("customLandingDirectionRR","input",100),Y("jumpRunTrackDirection","change",0),Y("jumpRunTrackOffset","change",0),Y("jumpRunTrackForwardOffset","change",0),Y("aircraftSpeedKt","change",300),Y("numberOfJumpers","change",300),Y("jumperSeparation","change",300),Y("cutAwayAltitude","change",300),Y("historicalDatePicker","change",300)}function Pc(){const t=document.getElementById("downloadButton");t&&t.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("ui:downloadClicked"))})}function xc(){const t=document.getElementById("clearHistoricalDate");t&&t.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("ui:clearDateClicked"))})}function Oc(){$r(),console.log("Coordinate events setup complete.")}function $c(){const t=document.querySelectorAll('input[name="cutAwayState"]');if(t.length===0)return;const e=m.state.userSettings.cutAwayState||"Partially",n=document.querySelector(`input[name="cutAwayState"][value="${e}"]`);n&&(n.checked=!0),t.forEach(a=>{a.addEventListener("change",()=>{a.checked&&(console.log(`Cut Away State changed to: ${a.value}`),m.state.userSettings.cutAwayState=a.value,m.save(),document.dispatchEvent(new CustomEvent("ui:recalculateJump")))})})}function Rc(){console.log("App: Richte Event-Listener für Track-Einstellungen ein.");const t=(a,i)=>{const r=document.getElementById(a);r&&(r.value=m.state.userSettings[i]||0,console.log(`Set ${a} to initial value:`,r.value),r.addEventListener("input",()=>{const o=parseFloat(r.value);isNaN(o)||(m.state.userSettings[i]=o,m.save(),fe())}))};t("numberOfJumpers","numberOfJumpers"),t("jumperSeparation","jumperSeparation"),t("jumpRunTrackOffset","jumpRunTrackOffset"),t("jumpRunTrackForwardOffset","jumpRunTrackForwardOffset");const e=document.getElementById("jumpRunTrackDirection");e&&(e.value=m.state.userSettings.customJumpRunDirection||"",e.addEventListener("change",()=>{const a=parseFloat(e.value);Number.isFinite(a)&&a>=0&&a<=359?(m.state.userSettings.customJumpRunDirection=a,console.log("Setting 'customJumpRunDirection' on change to:",a)):(m.state.userSettings.customJumpRunDirection=null,e.value="",console.log("Invalid direction, resetting to calculated.")),m.save(),fe()}));const n=document.getElementById("showJumpRunTrack");n&&n.addEventListener("change",a=>{m.state.userSettings.showJumpRunTrack=a.target.checked,m.save(),fe()})}function Uc(){if(console.log("App: Richte Event-Listener für Karten-Events ein."),!s.map){console.error("Karte nicht initialisiert, Event-Listener können nicht gesetzt werden.");return}const t=()=>{document.dispatchEvent(new CustomEvent("map:moved"))},e=p.debounce(()=>{Sa({map:s.map,baseMaps:s.baseMaps,onProgress:zt,onComplete:n=>{ke(),n&&p.handleMessage(n)},onCancel:()=>{ke(),p.handleMessage("Caching cancelled.")}})},1e3);p.debounce(t,500),s.map.on("zoomend",t),s.map.on("moveend",t),s.map.on("moveend",e)}function Wc(){console.log("setupMenuItemEvents wird aufgerufen für 'Calculate Jump'.");const t=Array.from(document.querySelectorAll(".menu-label")).find(a=>a.textContent.trim()==="Calculate Jump");if(!t){console.error("Calculate Jump menu item not found");return}const e=t.closest("li").querySelector("ul.submenu"),n=()=>{m.isFeatureUnlocked("calculateJump")?(t.style.opacity="1",t.title="Click to open/close jump calculation settings"):(t.style.opacity="0.5",t.title="Feature locked. Click to enter password.",e&&e.classList.add("hidden"))};n(),t.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),m.isFeatureUnlocked("calculateJump")?e&&e.classList.toggle("hidden"):m.showPasswordModal("calculateJump",()=>{n(),e&&e.classList.remove("hidden")},()=>{n()})})}function Hc(){const t=document.getElementById("resetCutAwayMarker");t&&t.addEventListener("click",()=>{if(!s.map){console.warn("Map not initialized, cannot reset cut-away marker");return}s.cutAwayMarker&&(s.map.removeLayer(s.cutAwayMarker),s.cutAwayMarker=null,s.cutAwayLat=null,s.cutAwayLng=null,console.log("Cut-away marker reset"),s.cutAwayCircle&&(s.map.removeLayer(s.cutAwayCircle),s.cutAwayCircle=null,console.log("Cleared cut-away circle")),document.getElementById("info").innerHTML="Right-click map to place cut-away marker")})}function zc(){console.log("[app.js] Setting up track events");const t=document.getElementById("trackFileInput"),e=document.getElementById("loading");t&&t.addEventListener("change",async a=>{const i=a.target.files[0];if(e&&(e.style.display="block"),!i){p.handleError("No file selected."),e&&(e.style.display="none");return}const r=i.name.split(".").pop().toLowerCase();let o=null;try{r==="gpx"?o=await gc(i):r==="csv"?o=await pc(i):(p.handleError("Unsupported file type. Please upload a .gpx or .csv file."),e&&(e.style.display="none"))}catch(l){console.error("Error during track file processing:",l),p.handleError("Failed to process track file."),e&&(e.style.display="none")}});const n=document.getElementById("clearTrack");n&&n.addEventListener("click",()=>{if(!s.map){p.handleError("Cannot clear track: map not initialized.");return}if(s.gpxLayer)try{s.map.hasLayer(s.gpxLayer)&&s.map.removeLayer(s.gpxLayer),s.gpxLayer=null,s.gpxPoints=[],s.isTrackLoaded=!1;const a=document.getElementById("info");if(a){const i=/(<br><strong>Available Models:<\/strong><ul>.*?<\/ul>|<br><strong>Available Models:<\/strong> None)/s,o=a.innerHTML.match(i);a.innerHTML="Click on the map to fetch weather data."+(o?o[0]:"")}t&&(t.value="")}catch(a){p.handleError("Failed to clear track: "+a.message)}else p.handleMessage("No track to clear.")})}function Bc(){const t=document.getElementById("bottom-container");if(!t){console.error("Bottom container not found; cannot create settings/cache buttons.");return}const e=document.createElement("div");e.id="settings-cache-buttons",e.className="button-wrapper";const n=document.createElement("button");n.id="resetButton",n.textContent="Reset Settings",n.title="Resets all settings to their default values and locks all features",n.addEventListener("click",()=>{confirm("Are you sure you want to reset all settings and lock all features?")&&(localStorage.removeItem("unlockedFeatures"),localStorage.removeItem("upperWindsSettings"),window.location.reload())}),e.appendChild(n);const a=document.createElement("button");a.id="clearCacheButton",a.textContent="Clear Tile Cache",a.title="Clears cached map tiles. Pan/zoom to cache more tiles for offline use.",a.addEventListener("click",async()=>{try{const i=await le.getCacheSize();await le.clearCache(),p.handleMessage(`Tile cache cleared successfully (freed ${i.toFixed(2)} MB).`),console.log("Tile cache cleared")}catch(i){p.handleError("Failed to clear tile cache: "+i.message)}}),e.appendChild(a),t.appendChild(e)}function Gc(){const t=document.getElementById("cacheRadiusSelect");t?(t.addEventListener("change",()=>{if(!m.state||!m.state.userSettings){console.error("Settings not properly initialized");return}m.state.userSettings.cacheRadiusKm=parseInt(t.value,10),m.save(),console.log("Updated cacheRadiusKm:",m.state.userSettings.cacheRadiusKm)}),console.log("cacheRadiusSelect listener attached, initial value:",t.value)):console.warn("cacheRadiusSelect not found in DOM");const e=document.getElementById("cacheZoomLevelsSelect");e?(e.addEventListener("change",()=>{const[a,i]=e.value.split("-").map(Number);m.state.userSettings.cacheZoomLevels=Array.from({length:i-a+1},(r,o)=>a+o),m.save(),console.log("Updated cacheZoomLevels:",m.state.userSettings.cacheZoomLevels)}),console.log("cacheZoomLevelsSelect listener attached, initial value:",e.value)):console.warn("cacheZoomLevelsSelect not found in DOM");const n=document.getElementById("recacheNowButton");n?(n.addEventListener("click",()=>{Dr({map:s.map,lastLat:s.lastLat,lastLng:s.lastLng,baseMaps:s.baseMaps,onProgress:zt,onComplete:a=>{ke(),a&&Ge(a)},onCancel:()=>{ke(),Ge("Caching cancelled.")}})}),console.log("recacheNowButton listener attached")):console.warn("recacheNowButton not found in DOM")}function Vc(t){const e=document.getElementById("ensembleModelsSubmenu");e&&(e.innerHTML="",t.forEach(n=>{const a=document.createElement("li"),i=document.createElement("label");i.className="radio-label";const r=document.createElement("input");r.type="checkbox",r.name="ensembleModel",r.value=n,r.checked=m.state.userSettings.selectedEnsembleModels.includes(n),r.addEventListener("change",async()=>{const o=Array.from(e.querySelectorAll("input:checked")).map(c=>c.value);if(m.state.userSettings.selectedEnsembleModels=o,m.save(),await Ir()){const c=Le();Nr(c)}}),i.append(r,` ${n.replace(/_/g," ").toUpperCase()}`),a.appendChild(i),e.appendChild(a)}))}function Zc(){yi||(console.log("Initializing all UI event listeners..."),Ac(),Cc(),Ic(),Nc(),Fc(),Dc(),Pc(),zc(),xc(),Oc(),$c(),Rc(),Uc(),Wc(),Hc(),Bc(),Gc(),yi=!0,console.log("Event listeners initialized successfully (first and only time)."))}const dn=()=>m.getValue("heightUnit","radio","m"),Jc=()=>m.getValue("windUnit","radio","kt"),wi=()=>m.getValue("coordFormat","radio","Decimal"),zr=p.debounce(he,300),jc=()=>m.getValue("downloadFormat","radio","csv");p.setErrorHandler(pn);p.setMessageHandler(Ge);p.handleMessage=Ge;L.Control.Coordinates=L.Control.extend({options:{position:"bottomleft"},onAdd:function(t){var e=L.DomUtil.create("div","leaflet-control-coordinates");return e.style.background="rgba(255, 255, 255, 0.8)",e.style.padding="5px",e.style.borderRadius="4px",e.style.boxShadow="0 2px 5px rgba(0, 0, 0, 0.2)",e.innerHTML="Move mouse over map",this._container=e,e},update:function(t){this._container.innerHTML=t}});function Lt(){var A;console.log("Calculating mean wind with model:",document.getElementById("modelSelect").value,"weatherData:",s.weatherData);const t=((A=document.querySelector('input[name="refLevel"]:checked'))==null?void 0:A.value)||"AGL",e=m.getValue("heightUnit","radio","m"),n=m.getValue("windUnit","radio","kt"),a=document.getElementById("timeSlider").value||0,i=lt(s.weatherData,a,st(),Math.round(s.lastAltitude),e);let r=parseFloat(document.getElementById("lowerLimit").value)||0,o=parseFloat(document.getElementById("upperLimit").value);const l=Math.round(s.lastAltitude);if(!s.weatherData||s.lastAltitude==="N/A"){p.handleError("Cannot calculate mean wind: missing data or altitude");return}r=e==="ft"?r/3.28084:r,o=e==="ft"?o/3.28084:o;let c=t==="AGL"?r+l:r,u=t==="AGL"?o+l:o;if(isNaN(r)||isNaN(o)||r>=o){p.handleError("Invalid layer limits. Ensure Lower < Upper and both are numbers.");return}if(t==="AMSL"&&u<l){p.handleError(`The entire selected layer (${Math.round(p.convertHeight(c,e))}-${Math.round(p.convertHeight(u,e))} ${e}) is below the terrain altitude of ${Math.round(p.convertHeight(l,e))} ${e}.`),document.getElementById("meanWindResult").innerHTML="Mean wind: N/A (Layer is below ground)";return}if(t==="AMSL"&&c<l){p.handleMessage(`Note: Lower limit adjusted to terrain altitude (${Math.round(p.convertHeight(l,e))} ${e}) as it cannot be below ground level.`);const T=Math.round(p.convertHeight(l,e));K("lowerLimit",T),m.state.userSettings.lowerLimit=T,m.save(),c=l}if(!i||i.length===0){p.handleError("No valid weather data available to calculate mean wind.");return}const d=i.map(T=>T.height),h=i.map(T=>parseFloat(T.dir)||0),g=i.map(T=>p.convertWind(parseFloat(T.spd)||0,n,"km/h")),f=g.map((T,F)=>-T*Math.sin(h[F]*Math.PI/180)),w=g.map((T,F)=>-T*Math.cos(h[F]*Math.PI/180)),v=p.calculateMeanWind(d,f,w,c,u),[y,S]=v,_=p.roundToTens(y)===0&&y>=0&&y<5?360:p.roundToTens(y),E=Math.round(p.convertHeight(r,e)),M=Math.round(p.convertHeight(o,e));p.convertWind(S,n,"kt");const b=Number.isFinite(S)?n==="bft"?Math.round(S):S.toFixed(1):"N/A",k=`Mean wind (${E}-${M} ${e} ${t}): ${_}° ${b} ${n}`;document.getElementById("meanWindResult").innerHTML=k,console.log("Calculated Mean Wind:",k,"u:",v[2],"v:",v[3])}function qc(t){var w;if(!s.weatherData||!s.weatherData.time){p.handleError("No weather data available to download.");return}const e=document.getElementById("timeSlider").value||0,n=document.getElementById("modelSelect").value.toUpperCase(),a=p.formatTime(s.weatherData.time[e]).replace(" ","_"),i=`${a}_${n}_${t}.txt`,o={ATAK:{interpStep:1e3,heightUnit:"ft",refLevel:"AGL",windUnit:"kt"},Windwatch:{interpStep:100,heightUnit:"ft",refLevel:"AGL",windUnit:"km/h"},HEIDIS:{interpStep:100,heightUnit:"m",refLevel:"AGL",temperatureUnit:"C",windUnit:"m/s"},Customized:{}}[t]||{},l={interpStep:o.interpStep||st(),heightUnit:o.heightUnit||m.getValue("heightUnit","radio","m"),refLevel:o.refLevel||((w=document.querySelector('input[name="refLevel"]:checked'))==null?void 0:w.value)||"AGL",windUnit:o.windUnit||m.getValue("windUnit","radio","kt"),temperatureUnit:o.temperatureUnit||m.getValue("temperatureUnit","radio","C")};console.log(`Generating export for '${t}' with settings:`,l);const c=lt(s.weatherData,e,l.interpStep,Math.round(s.lastAltitude),l.heightUnit);if(!c||c.length===0){p.handleError("No interpolated data available to download.");return}let u="",d="";switch(t){case"ATAK":d=`Alt Dir Spd
${l.heightUnit}${l.refLevel}
`;break;case"Windwatch":const v=Math.round(p.convertHeight(s.lastAltitude,"ft"));d=`Version 1.0, ID = 9999999999
${a}, Ground Level: ${v} ft
Windsond ${n}
AGL[ft] Wind[°] Speed[km/h]
`;break;case"HEIDIS":case"Customized":default:d=`h(${l.heightUnit}${l.refLevel}) p(hPa) T(${l.temperatureUnit}) Dew(${l.temperatureUnit}) Dir(°) Spd(${l.windUnit}) RH(%)
`;break}u+=d,c.forEach(v=>{const y=Math.round(v.displayHeight),S=Math.round(v.dir),_=p.convertWind(v.spd,l.windUnit,"km/h"),E=Number.isFinite(_)?l.windUnit==="bft"?Math.round(_):_.toFixed(1):"N/A";if(t==="ATAK"||t==="Windwatch")u+=`${y} ${S} ${Math.round(_)}
`;else{const M=v.pressure==="N/A"?"N/A":v.pressure.toFixed(1),b=p.convertTemperature(v.temp,l.temperatureUnit),k=b==="N/A"?"N/A":b.toFixed(1),A=p.convertTemperature(v.dew,l.temperatureUnit),T=A==="N/A"?"N/A":A.toFixed(1),F=v.rh==="N/A"?"N/A":Math.round(v.rh);u+=`${y} ${M} ${k} ${T} ${S} ${E} ${F}
`}});const h=new Blob([u],{type:"text/plain"}),g=window.URL.createObjectURL(h),f=document.createElement("a");f.href=g,f.download=i,document.body.appendChild(f),f.click(),document.body.removeChild(f),window.URL.revokeObjectURL(g)}async function Kc(){if(!s.lastLat||!s.lastLng){console.warn("No location selected, cannot update weather data"),p.handleError("Please select a location to enable autoupdate."),stopAutoupdate(),document.getElementById("autoupdateCheckbox").checked=!1,m.state.userSettings.autoupdate=!1,m.save();return}if(!navigator.onLine){console.warn("Cannot update weather data: offline"),p.handleError("Cannot update weather data while offline."),stopAutoupdate(),document.getElementById("autoupdateCheckbox").checked=!1,m.state.userSettings.autoupdate=!1,m.save();return}const t=document.getElementById("timeSlider");if(!t){console.warn("Time slider not found, cannot update to current hour");return}const n=new Date().getUTCHours();t.value=n,console.log(`Set slider to current hour: ${n}`);try{await nt(s.lastLat,s.lastLng,null,!1),console.log("Weather data fetched for current hour"),await at(n,"info","selectedTime"),s.lastAltitude!=="N/A"&&Lt(),m.state.userSettings.calculateJump&&m.state.isCalculateJumpUnlocked&&(zr(),La(),m.state.userSettings.showJumpRunTrack&&fe()),console.log("Updated all displays for current hour")}catch(a){console.error("Error updating to current hour:",a),p.handleError("Failed to update weather data: "+a.message)}}function he(){const t=Le(),e=st(),n=dn();let a=m.state.userSettings.openingAltitude,i=m.state.userSettings.exitAltitude;if(n==="ft"&&(a=p.convertFeetToMeters(a),i=p.convertFeetToMeters(i)),!m.state.isCalculateJumpUnlocked||!m.state.userSettings.calculateJump){cn(null),ra(null);return}if(!s.weatherData||!s.lastLat||!s.lastLng){cn(null);return}Le();const r=lt(s.weatherData,t,e,Math.round(s.lastAltitude),n),o={exitCircles:[],canopyCircles:[],canopyLabels:[]};if(m.state.userSettings.showExitArea){const c=Ar(r);if(c){o.exitCircles.push({center:[c.greenLat,c.greenLng],radius:c.greenRadius,color:"green",fillColor:"green",fillOpacity:.2,weight:2});const u=`
                Exit areas calculated with:<br>
                Throw/Drift: ${Number.isFinite(c.freeFallDirection)?Math.round(c.freeFallDirection):"N/A"}° ${Number.isFinite(c.freeFallDistance)?Math.round(c.freeFallDistance):"N/A"} m<br>
                Free Fall Time: ${c.freeFallTime!=null&&!isNaN(c.freeFallTime)?Math.round(c.freeFallTime):"N/A"} sec
            `;o.exitCircles.push({center:[c.darkGreenLat,c.darkGreenLng],radius:c.darkGreenRadius,color:"darkgreen",fillColor:"darkgreen",fillOpacity:.2,weight:2,tooltip:u})}}if(m.state.userSettings.showCanopyArea){const c=Sl(r);if(c){const u=p.calculateNewCenter(c.redLat,c.redLng,c.displacementFull,c.directionFull);o.canopyCircles.push({center:u,radius:c.radiusFull,color:"red",weight:2,opacity:.8,fillOpacity:0}),c.additionalBlueRadii.forEach((d,h)=>{const g=p.calculateNewCenter(c.blueLat,c.blueLng,c.additionalBlueDisplacements[h],c.additionalBlueDirections[h]);o.canopyCircles.push({center:g,radius:d,color:"blue",weight:1,fillColor:"blue",fillOpacity:.1,opacity:1}),o.canopyLabels.push({center:g,radius:d,text:`${Math.round(c.additionalBlueUpperLimits[h])}m`})})}}cn(o);let l=null;if(m.state.userSettings.showCutAwayFinder&&s.cutAwayLat!==null){const c=La(r);c&&(l={center:c.center,radius:c.radius,tooltipContent:c.tooltipContent})}ra(l)}function Yc(t=!0){s.customJumpRunDirection=null;const e=document.getElementById("jumpRunTrackDirection");e&&(e.value="",console.log("Cleared jumpRunTrackDirection input")),console.log("Reset JRT direction to calculated"),t&&m.state.userSettings.showJumpRunTrack&&s.weatherData&&s.lastLat&&s.lastLng&&(console.log("Triggering JRT update after reset"),fe())}function Qc(){return!m.state.userSettings.showJumpRunTrack||!m.state.userSettings.calculateJump||!s.weatherData||!s.lastLat||!s.lastLng?(console.log("Skipping calculateJumpRunTrack: conditions not met"),null):(console.log("Calculating jump run track..."),fe(),bn())}function Ie(t=null){if(!s.liveMarker){fi(),oc();return}const e=s.liveMarker.getLatLng();if(!e)return;const n=t||{latitude:e.lat,longitude:e.lng,speedMs:s.lastSmoothedSpeedMs,direction:s.lastDirection,deviceAltitude:s.lastDeviceAltitude,altitudeAccuracy:s.lastAltitudeAccuracy,accuracy:s.lastAccuracy},a=m.state.userSettings.showJumpMasterLine;let i=null;if(a){let o=null,l="";if(m.state.userSettings.jumpMasterLineTarget==="HARP"&&s.harpMarker?(o=s.harpMarker.getLatLng(),l="HARP"):s.currentMarker&&(o=s.currentMarker.getLatLng(),l="DIP"),o){const c=s.map.distance(e,o),u=Math.round(p.calculateBearing(e.lat,e.lng,o.lat,o.lng)),d=n.speedMs>1?n.speedMs:1,h=Math.round(c/d);i={distance:c,bearing:u,tot:h,target:l},rc(e,o)}}else fi();const r={heightUnit:m.getValue("heightUnit","radio","m"),effectiveWindUnit:m.getValue("windUnit","radio","kt")==="bft"?"kt":m.getValue("windUnit","radio","kt"),coordFormat:m.getValue("coordFormat","radio","Decimal"),refLevel:m.getValue("refLevel","radio","AGL")};sc({...n,showJumpMasterLine:a,jumpMasterLineData:i,...r})}function Xc(){if(m.initialize(),Ml(!1),m.state.isLandingPatternUnlocked=m.state.unlockedFeatures.landingPattern,m.state.isCalculateJumpUnlocked=m.state.unlockedFeatures.calculateJump,m.state.userSettings.showJumpMasterLine=!1,console.log("Initial unlock status:",{isLandingPatternUnlocked:m.state.isLandingPatternUnlocked,isCalculateJumpUnlocked:m.state.isCalculateJumpUnlocked}),s.isInitialized){console.log("App already initialized, skipping");return}s.isInitialized=!0,console.log("Initializing app")}function eu(){tu("modelSelect",m.state.userSettings.model),He("refLevel",m.state.userSettings.refLevel),He("heightUnit",m.state.userSettings.heightUnit),He("temperatureUnit",m.state.userSettings.temperatureUnit),He("windUnit",m.state.userSettings.windUnit),He("timeZone",m.state.userSettings.timeZone),He("coordFormat",m.state.userSettings.coordFormat),He("downloadFormat",m.state.userSettings.downloadFormat),He("landingDirection",m.state.userSettings.landingDirection),K("canopySpeed",m.state.userSettings.canopySpeed),K("descentRate",m.state.userSettings.descentRate),K("legHeightDownwind",m.state.userSettings.legHeightDownwind),K("legHeightBase",m.state.userSettings.legHeightBase),K("legHeightFinal",m.state.userSettings.legHeightFinal),K("customLandingDirectionLL",m.state.userSettings.customLandingDirectionLL),K("customLandingDirectionRR",m.state.userSettings.customLandingDirectionRR),K("lowerLimit",m.state.userSettings.lowerLimit),K("upperLimit",m.state.userSettings.upperLimit),K("openingAltitude",m.state.userSettings.openingAltitude),K("exitAltitude",m.state.userSettings.exitAltitude),K("interpStepSelect",m.state.userSettings.interpStep),K("aircraftSpeedKt",m.state.userSettings.aircraftSpeedKt),K("jumpRunTrackOffset",m.state.userSettings.jumpRunTrackOffset),K("numberOfJumpers",m.state.userSettings.numberOfJumpers),pt("showTableCheckbox",m.state.userSettings.showTable),pt("calculateJumpCheckbox",m.state.userSettings.calculateJump),pt("showLandingPattern",m.state.userSettings.showLandingPattern),pt("showJumpRunTrack",m.state.userSettings.showJumpRunTrack),pt("showCanopyAreaCheckbox",m.state.userSettings.showCanopyArea),pt("showExitAreaCheckbox",m.state.userSettings.showExitArea),m.state.userSettings.isCustomJumpRunDirection=m.state.userSettings.isCustomJumpRunDirection||!1;const t=document.getElementById("customLandingDirectionLL"),e=document.getElementById("customLandingDirectionRR");t&&m.state.userSettings.customLandingDirectionLL!==""&&!isNaN(m.state.userSettings.customLandingDirectionLL)&&(t.value=m.state.userSettings.customLandingDirectionLL),e&&m.state.userSettings.customLandingDirectionRR!==""&&!isNaN(m.state.userSettings.customLandingDirectionRR)&&(e.value=m.state.userSettings.customLandingDirectionRR);const n=Tr(m.state.userSettings.aircraftSpeedKt);K("jumperSeparation",n),m.state.userSettings.jumperSeparation=n,m.save();const a=document.getElementById("showLandingPattern"),i=document.getElementById("calculateJumpCheckbox");a&&(a.title=m.isFeatureUnlocked("landingPattern")&&m.state.isLandingPatternUnlocked?"":"Feature locked. Click to enter password.",a.style.opacity=m.isFeatureUnlocked("landingPattern")&&m.state.isLandingPatternUnlocked?"1":"0.5",console.log("Initialized showLandingPattern UI:",{checked:a.checked,opacity:a.style.opacity})),i&&(i.title=m.isFeatureUnlocked("calculateJump")&&m.state.isCalculateJumpUnlocked?"":"Feature locked. Click to enter password.",i.style.opacity=m.isFeatureUnlocked("calculateJump")&&m.state.isCalculateJumpUnlocked?"1":"0.5",console.log("Initialized calculateJumpCheckbox UI:",{checked:i.checked,opacity:i.style.opacity}));const r=document.getElementById("showJumpMasterLine");r&&(r.disabled=!m.state.userSettings.trackPosition,r.style.opacity=r.disabled?"0.5":"1",r.title=r.disabled?"Enable Live Tracking to use Jump Master Line":"");const o=document.getElementById("jumpRunTrackDirection");o&&(o.textContent="-"),Br()}function Br(){const t=document.getElementById("info");t&&(t.style.display=m.state.userSettings.showTable?"block":"none");const e=document.getElementById("customLandingDirectionLL"),n=document.getElementById("customLandingDirectionRR"),a=document.getElementById("showJumpRunTrack"),i=document.getElementById("showExitAreaCheckbox");e&&(e.disabled=m.state.userSettings.landingDirection!=="LL"),n&&(n.disabled=m.state.userSettings.landingDirection!=="RR"),a&&(a.disabled=!m.state.userSettings.calculateJump),i&&(i.disabled=!m.state.userSettings.calculateJump),m.updateUnitLabels()}async function Ut(t,e=null){s.weatherData=t;const n=document.getElementById("timeSlider");if(!n)return;const i=(r=>{const o=r==null?void 0:r.temperature_2m;if(!o||o.length===0)return 0;for(let l=o.length-1;l>=0;l--)if(o[l]!==null&&o[l]!==void 0)return l;return 0})(t);if(n.max=i,n.disabled=n.max<=0,e!==null&&e<=i)n.value=e,console.log(`Slider restored to preserved index: ${e}`);else{const r=new Date().getUTCHours();r<=i?n.value=r:n.value=i,console.log(`Slider set to default (current hour or max): ${n.value}`)}await at(n.value,"info","selectedTime"),await vt(),s.lastAltitude!=="N/A"&&Lt(),m.updateModelRunInfo(s.lastModelRun,s.lastLat,s.lastLng)}function pt(t,e){const n=document.getElementById(t);n&&(n.checked=e)}function tu(t,e){const n=document.getElementById(t);n?n.value=e:console.warn(`Element ${t} not found`)}function K(t,e){const n=document.getElementById(t);n&&(n.value=e)}function la(t,e){const n=document.getElementById(t);if(n){const a=n.value;n.value=e,console.log(`Set ${t} silently:`,{old:a,new:e})}}function He(t,e){const n=document.querySelector(`input[name="${t}"][value="${e}"]`);n?n.checked=!0:console.warn(`Radio ${t} with value ${e} not found`)}function nu(){console.log("[App] Setting up application event listeners..."),document.addEventListener("map:moved",()=>{console.log("[main-web] Map has moved or zoomed. Updating visualizations based on new view.");const t=s.map.getZoom();m.state.userSettings.calculateJump&&s.weatherData&&s.lastLat&&(t>=Se.MIN_ZOOM&&t<=Se.MAX_ZOOM?he():cn(null)),m.state.userSettings.showJumpRunTrack&&(t>=Se.MIN_ZOOM&&t<=Se.MAX_ZOOM?fe():Rt(null)),m.state.userSettings.showLandingPattern&&Ce(),Sa({map:s.map,baseMaps:s.baseMaps,onProgress:zt,onComplete:e=>{ke(),e&&p.handleMessage(e)},onCancel:()=>{ke(),p.handleMessage("Caching cancelled.")}})}),document.addEventListener("map:mousemove",t=>{const{lat:e,lng:n}=t.detail;s.lastMouseLatLng={lat:e,lng:n};const a=wi();let i;if(a==="MGRS")i=`MGRS: ${p.decimalToMgrs(e,n)||"N/A"}`;else if(a==="DMS"){const r=o=>`${o.deg}°${o.min}'${o.sec.toFixed(0)}" ${o.dir}`;i=`Lat: ${r(p.decimalToDms(e,!0))}, Lng: ${r(p.decimalToDms(n,!1))}`}else i=`Lat: ${e.toFixed(5)}, Lng: ${n.toFixed(5)}`;s.coordsControl&&s.coordsControl.update(`${i}<br>Elevation: Fetching...<br>QFE: Fetching...`),p.debouncedGetElevationAndQFE(e,n,{lat:e,lng:n},({elevation:r,qfe:o},l)=>{if(s.lastMouseLatLng&&s.coordsControl){const c=Math.abs(s.lastMouseLatLng.lat-l.lat),u=Math.abs(s.lastMouseLatLng.lng-l.lng),d=.05;if(c<d&&u<d){const h=dn();let g=r==="N/A"?"N/A":r;g!=="N/A"&&(g=p.convertHeight(g,h),g=Math.round(g));const f=o==="N/A"?"N/A":`${o} hPa`;s.coordsControl.update(`${i}<br>Elevation: ${g} ${g==="N/A"?"":h}<br>QFE: ${f}`)}}})}),document.addEventListener("map:location_selected",async t=>{const{lat:e,lng:n,source:a}=t.detail;console.log(`App: Event 'map:location_selected' von '${a}' empfangen.`),s.lastLat=e,s.lastLng=n,s.lastAltitude=await p.getAltitude(e,n),ba(e,n),Yc(!0),await nt(e,n),m.state.userSettings.calculateJump&&(he(),La()),yn(!0),s.isManualPanning=!1,fe(),Ce()}),document.addEventListener("favorites:updated",t=>{const{favorites:e}=t.detail;console.log("[App] Favorites updated, redrawing markers on map."),Or(e)}),document.addEventListener("tracking:started",()=>{const t=document.getElementById("showJumpMasterLine");t&&(t.disabled=!1,t.style.opacity="1",t.title="")}),document.addEventListener("tracking:stopped",()=>{const t=document.getElementById("showJumpMasterLine");t&&(t.checked=!1,t.disabled=!0,t.style.opacity="0.5",t.title="Enable Live Tracking to use Jump Master Line"),m.state.userSettings.showJumpMasterLine&&(m.state.userSettings.showJumpMasterLine=!1,m.save()),Ie()}),document.addEventListener("track:loaded",async t=>{const e=document.getElementById("loading");try{const{lat:n,lng:a,timestamp:i,historicalDate:r,summary:o}=t.detail;if(console.log('[main-web] Event "track:loaded" empfangen, starte Aktionen.'),r){console.log("Historischer Track geladen, deaktiviere Autoupdate.");const u=document.getElementById("autoupdateCheckbox");u&&(u.checked=!1),Hr(),m.state.userSettings.autoupdate=!1,m.save(),p.handleMessage("Autoupdate disabled for historical track viewing.")}await En(n,a);const l=await nt(n,a,i);if(l){s.weatherData=l;const u=document.getElementById("timeSlider");if(u&&s.weatherData.time){u.max=s.weatherData.time.length-1,u.disabled=u.max<=0;const d=new Date(i).getTime();let h=0,g=1/0;s.weatherData.time.forEach((f,w)=>{const v=Math.abs(new Date(f).getTime()-d);v<g&&(g=v,h=w)}),u.value=h}}console.log("Performing specific updates after track load..."),await at(Le(),"info","selectedTime"),await vt(),Lt(),he(),Ce(),Ie();const c=document.getElementById("info");if(c&&o){const u=/(<br><strong>Available Models:<\/strong><ul>.*?<\/ul>|<br><strong>Available Models:<\/strong> None)/s,d=c.innerHTML.match(u);c.innerHTML=o+(d?d[0]:"")}if(r){const u=document.getElementById("historicalDatePicker");u&&(u.value=r)}}catch(n){console.error("Fehler bei der Verarbeitung von track:loaded:",n),p.handleError("Konnte Track-Daten nicht vollständig verarbeiten.")}finally{e&&(e.style.display="none")}}),document.addEventListener("tracking:positionUpdated",t=>{Ie(t.detail)}),document.addEventListener("jml:targetChanged",()=>{Ie()}),document.addEventListener("ui:sliderChanged",async t=>{console.log("[main-web] Event 'ui:sliderChanged' empfangen, spezifische Updates werden ausgeführt.");try{const e=Le();s.weatherData&&s.lastLat&&s.lastLng&&(await at(e,"info","selectedTime"),await vt(),s.lastAltitude!=="N/A"&&Lt(),Ce(),m.state.userSettings.calculateJump&&he(),m.state.userSettings.showJumpRunTrack&&fe())}catch(e){console.error("Error during slider update:",e),pn(e.message)}}),document.addEventListener("ui:radioGroupChanged",async t=>{const{name:e}=t.detail;switch(console.log(`[main-web] Radio group '${e}' changed. Performing specific updates.`),["refLevel","heightUnit","temperatureUnit","windUnit","timeZone"].includes(e)&&await at(Le(),"info","selectedTime"),e){case"heightUnit":if(s.lastMouseLatLng){const{lat:n,lng:a}=s.lastMouseLatLng;let r=wi()==="MGRS"?`MGRS: ${p.decimalToMgrs(n,a)}`:`Lat: ${n.toFixed(5)}, Lng: ${a.toFixed(5)}`;p.debouncedGetElevationAndQFE(n,a,{lat:n,lng:a},({elevation:o,qfe:l},c)=>{if(s.lastMouseLatLng&&Math.abs(s.lastMouseLatLng.lat-c.lat)<.05){const u=dn();let d=o!=="N/A"?Math.round(p.convertHeight(o,u)):"N/A";s.coordsControl.update(`${r}<br>Elevation: ${d} ${d==="N/A"?"":u}`)}})}if(s.gpxLayer&&s.gpxPoints.length>0){const n=s.lastAltitude!=="N/A"&&!isNaN(s.lastAltitude)?parseFloat(s.lastAltitude):null,a=Jc(),i=dn();s.gpxLayer.eachLayer(r=>{r instanceof L.Polyline&&r.on("mousemove",function(o){const l=o.latlng;let c=s.gpxPoints[0],u=1/0,d=0;s.gpxPoints.forEach((h,g)=>{const f=Math.sqrt(Math.pow(h.lat-l.lat,2)+Math.pow(h.lng-l.lng,2));f<u&&(u=f,c=h,d=g)}),r.setTooltipContent(getTooltipContent(c,d,s.gpxPoints,n,a,i)).openTooltip(l)})})}case"windUnit":case"refLevel":Lt(),he(),Ce(),Ie(),await vt();break;case"coordFormat":await vt(),Ie();break;case"landingDirection":Br(),Ce();break}}),document.addEventListener("ui:inputChanged",async t=>{const{name:e,value:n}=t.detail;switch(console.log(`[main-web] Input for '${e}' changed to '${n}'.`),e){case"aircraftSpeedKt":const a=Tr(n);la("jumperSeparation",a),m.state.userSettings.jumperSeparation=a,m.save(),s.weatherData&&zr(),fe();break;case"cutAwayAltitude":s.weatherData&&s.cutAwayLat!==null&&he();break;case"openingAltitude":case"exitAltitude":case"numberOfJumpers":case"jumperSeparation":case"canopySpeed":case"descentRate":case"legHeightFinal":case"legHeightBase":case"legHeightDownwind":s.weatherData&&(he(),Ce());break;case"jumpRunTrackDirection":case"jumpRunTrackOffset":case"jumpRunTrackForwardOffset":s.weatherData&&fe();break;case"lowerLimit":case"upperLimit":case"interpStepSelect":s.weatherData&&(await at(Le(),"info","selectedTime"),Lt());break;case"customLandingDirectionLL":case"customLandingDirectionRR":s.weatherData&&Ce();break;case"historicalDatePicker":if(s.lastLat&&s.lastLng){const i=n?`${n}T00:00:00Z`:null,r=await nt(s.lastLat,s.lastLng,i);r&&await Ut(r)}break}}),document.addEventListener("ui:showJumpMasterLineChanged",()=>{Ie()}),document.addEventListener("ui:modelChanged",async t=>{var e,n;if(console.log(`[main-web] Model changed to ${t.detail.model}. Fetching new data.`),s.lastLat&&s.lastLng){const a=Le(),i=((n=(e=s.weatherData)==null?void 0:e.time)==null?void 0:n[a])||null,r=await nt(s.lastLat,s.lastLng,i);r&&await Ut(r,a)}else p.handleError("Please select a position on the map first.")}),document.addEventListener("ui:jumpFeatureChanged",()=>{console.log("[main-web] Jump feature changed, recalculating jump."),s.weatherData&&s.lastLat&&s.lastLng&&m.state.userSettings.calculateJump&&he()}),document.addEventListener("ui:showJumpRunTrackChanged",t=>{const e=t.detail.checked;if(console.log(`[main-web] Jump Run Track toggled: ${e}`),e&&s.weatherData&&s.lastLat&&s.lastLng&&m.state.isCalculateJumpUnlocked&&m.state.userSettings.calculateJump)Qc();else{Rt(null);const n=document.getElementById("jumpRunTrackDirection");if(n){const a=bn();n.value=a?a.direction:""}}}),document.addEventListener("ui:showCutAwayFinderChanged",t=>{var a;const e=t.detail.checked;console.log(`[main-web] Cut Away Finder toggled: ${e}`);const n=(a=document.getElementById("showCutAwayFinder").closest("li"))==null?void 0:a.querySelector("ul.submenu");n&&n.classList.toggle("hidden",!e),e||(tc(),s.cutAwayLat=null,s.cutAwayLng=null),s.weatherData&&s.lastLat&&s.lastLng&&m.state.userSettings.calculateJump&&he()}),document.addEventListener("ui:trackPositionToggled",t=>{const e=t.detail.checked;console.log(`[main-web] Live Tracking toggled: ${e}`),e?vc():Wr()}),document.addEventListener("ui:landingPatternEnabled",()=>{console.log("[main-web] Landing pattern enabled, updating display."),Ce()}),document.addEventListener("ui:landingPatternDisabled",()=>{console.log("[main-web] Landing pattern disabled, clearing display."),Ot(null)}),document.addEventListener("ui:showTableChanged",t=>{const e=t.detail.checked;console.log(`[main-web] Show Table toggled: ${e}`);const n=document.getElementById("info");n&&(n.style.display=e?"block":"none"),e&&s.weatherData&&s.lastLat&&s.lastLng&&at(Le(),"info","selectedTime"),yn()}),document.addEventListener("ui:jumpMasterLineTargetChanged",()=>{console.log("[main-web] Jump Master Line target changed, updating panel and line."),Ie()}),document.addEventListener("ui:downloadClicked",()=>{console.log("[main-web] Download button clicked.");const t=jc();qc(t)}),document.addEventListener("ui:clearDateClicked",async()=>{console.log("[main-web] Clear date button clicked.");const t=document.getElementById("historicalDatePicker");if(t&&(t.value="",s.lastLat&&s.lastLng))try{const e=await nt(s.lastLat,s.lastLng,null);e&&await Ut(e)}catch(e){pn(e.message)}}),document.addEventListener("ui:recalculateJump",()=>{console.log("[main-web] Recalculate jump triggered."),s.weatherData&&s.lastLat&&s.lastLng&&m.state.userSettings.calculateJump&&he()}),document.addEventListener("ui:invalidInput",t=>{const{id:e,defaultValue:n}=t.detail;console.log(`[main-web] Received invalid input for ${e}. Resetting UI to ${n}.`),K(e,n)})}document.addEventListener("DOMContentLoaded",async()=>{Xc(),eu(),Nl(),await Pl(),nu(),Lc(),Zc(),$r();const t=ct().filter(e=>e.isFavorite);t.length>0&&(console.log(`[App] Found ${t.length} favorite(s) on startup, plotting on map.`),Or(t)),document.addEventListener("cutaway:marker_placed",()=>{console.log("App: Event 'cutaway:marker_placed' empfangen. Neuberechnung wird ausgelöst."),s.weatherData&&s.lastLat&&s.lastLng&&he()}),document.addEventListener("track:dragend",e=>{console.log("App: Event 'track:dragend' empfangen. Neuberechnung der Offsets relativ zum DIP.");const{newPosition:n,originalTrackData:a}=e.detail,i=L.latLng(s.lastLat,s.lastLng),r=a.trackLength,o=a.airplane.bearing,l=n,[c,u]=p.calculateNewCenter(l.lat,l.lng,r/2,(o+180)%360),d=L.latLng(c,u),h=s.map.distance(i,d);let f=p.calculateBearing(i.lat,i.lng,d.lat,d.lng)-o;f=(f+180)%360-180;const w=f*(Math.PI/180),v=Math.round(h*Math.cos(w)),y=Math.round(h*Math.sin(w));m.state.userSettings.jumpRunTrackOffset=y,m.state.userSettings.jumpRunTrackForwardOffset=v,m.save(),la("jumpRunTrackOffset",y),la("jumpRunTrackForwardOffset",v),fe()}),document.addEventListener("location:selected",async e=>{var o,l;const{lat:n,lng:a,source:i}=e.detail;console.log(`App: Event 'location:selected' empfangen. Quelle: ${i}`);const r=document.getElementById("loading");r&&(r.style.display="block");try{const c=Le(),u=((l=(o=s.weatherData)==null?void 0:o.time)==null?void 0:l[c])||null,d=await nt(n,a,u);d?i==="geolocation"||i==="geolocation_fallback"?await Ut(d):await Ut(d,c):s.weatherData=null,await En(n,a),await vt(),yn(!0),s.isManualPanning=!1,(i==="geolocation"||i==="geolocation_fallback")&&(console.log("Starte initiales Caching nach Geolocation..."),Sa({map:s.map,baseMaps:s.baseMaps,onProgress:zt,onComplete:h=>{ke(),h&&Ge(h)},onCancel:()=>{ke(),Ge("Caching cancelled.")}})),m.state.userSettings.showJumpMasterLine&&Ie(),(i==="marker_drag"||i==="dblclick"||i==="search")&&(console.log(`Starte Caching für neue Position via ${i}...`),Dr({map:s.map,lastLat:n,lastLng:a,baseMaps:s.baseMaps,onProgress:zt,onComplete:h=>{ke(),h&&Ge(h)},onCancel:()=>{ke(),Ge("Caching cancelled.")}}))}catch(c){console.error('Fehler beim Verarbeiten von "location:selected":',c),pn(c.message)}finally{r&&(r.style.display="none")}}),document.addEventListener("autoupdate:tick",async e=>{if(!m.state.userSettings.autoupdate)return;const n=new Date,a=document.getElementById("timeSlider");if(!a)return;const i=n.getUTCHours(),r=parseInt(a.value,10);(i!==r||e.detail.isInitialTick)&&(console.log(`[App] Autoupdate triggered. Current Hour: ${i}, Slider Hour: ${r}`),await Kc())})});
