(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function n(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(r){if(r.ep)return;r.ep=!0;const i=n(r);fetch(r.href,i)}})();const o={isInitialized:!1,coordsControl:null,lastMouseLatLng:null,landingWindDir:null,cutAwayMarker:null,cutAwayLat:null,cutAwayLng:null,cutAwayCircle:null,isJumperSeparationManual:!1,weatherData:null,lastModelRun:null,gpxLayer:null,gpxPoints:[],isLoadingGpx:!1,isTrackLoaded:!1,liveMarker:null,jumpMasterLine:null,isPlacingHarp:!1,harpMarker:null,watchId:null,prevLat:null,prevLng:null,prevTime:null,livePositionControl:null,lastLatitude:null,lastLongitude:null,lastDeviceAltitude:null,lastAltitudeAccuracy:null,lastAccuracy:null,lastSpeed:"N/A",lastEffectiveWindUnit:"kt",lastDirection:"N/A",lastTerrainAltitude:"N/A",lastSmoothedSpeedMs:0,map:null,baseMaps:{},lastLat:null,lastLng:null,lastAltitude:null,currentMarker:null,isManualPanning:!1,autoupdateInterval:null,accuracyCircle:null,ensembleModelsData:null,selectedEnsembleModels:[],currentEnsembleScenario:"all_models",ensembleLayerGroup:null,ensembleScenarioCircles:{},heatmapLayer:null,favoritesLayerGroup:null,isArmed:!1,isAutoRecording:!1,isManualRecording:!1,recordedTrackPoints:[],autoRecordingStartTime:null,altitudeCorrectionOffset:0,ismapInitialized:!1,hasTileErrorSwitched:!1,isCachingCancelled:!1,jumpVisualizationLayerGroup:null,landingPatternLayerGroup:null,jumpRunTrackLayerGroup:null,labelZoomListener:null};class et extends Error{}class Vi extends et{constructor(e){super(`Invalid DateTime: ${e.toMessage()}`)}}class Zi extends et{constructor(e){super(`Invalid Interval: ${e.toMessage()}`)}}class Ji extends et{constructor(e){super(`Invalid Duration: ${e.toMessage()}`)}}class ct extends et{}class gr extends et{constructor(e){super(`Invalid unit ${e}`)}}class X extends et{}class De extends et{constructor(){super("Zone is an abstract class")}}const C="numeric",Me="short",se="long",sn={year:C,month:C,day:C},pr={year:C,month:Me,day:C},ji={year:C,month:Me,day:C,weekday:Me},yr={year:C,month:se,day:C},wr={year:C,month:se,day:C,weekday:se},vr={hour:C,minute:C},Lr={hour:C,minute:C,second:C},Mr={hour:C,minute:C,second:C,timeZoneName:Me},Sr={hour:C,minute:C,second:C,timeZoneName:se},Er={hour:C,minute:C,hourCycle:"h23"},br={hour:C,minute:C,second:C,hourCycle:"h23"},_r={hour:C,minute:C,second:C,hourCycle:"h23",timeZoneName:Me},kr={hour:C,minute:C,second:C,hourCycle:"h23",timeZoneName:se},Tr={year:C,month:C,day:C,hour:C,minute:C},Ar={year:C,month:C,day:C,hour:C,minute:C,second:C},Cr={year:C,month:Me,day:C,hour:C,minute:C},Ir={year:C,month:Me,day:C,hour:C,minute:C,second:C},qi={year:C,month:Me,day:C,weekday:Me,hour:C,minute:C},Nr={year:C,month:se,day:C,hour:C,minute:C,timeZoneName:Me},Pr={year:C,month:se,day:C,hour:C,minute:C,second:C,timeZoneName:Me},Dr={year:C,month:se,day:C,weekday:se,hour:C,minute:C,timeZoneName:se},xr={year:C,month:se,day:C,weekday:se,hour:C,minute:C,second:C,timeZoneName:se};class Ot{get type(){throw new De}get name(){throw new De}get ianaName(){return this.name}get isUniversal(){throw new De}offsetName(e,n){throw new De}formatOffset(e,n){throw new De}offset(e){throw new De}equals(e){throw new De}get isValid(){throw new De}}let _n=null;class fn extends Ot{static get instance(){return _n===null&&(_n=new fn),_n}get type(){return"system"}get name(){return new Intl.DateTimeFormat().resolvedOptions().timeZone}get isUniversal(){return!1}offsetName(e,{format:n,locale:a}){return Vr(e,n,a)}formatOffset(e,n){return Nt(this.offset(e),n)}offset(e){return-new Date(e).getTimezoneOffset()}equals(e){return e.type==="system"}get isValid(){return!0}}const Wn=new Map;function Ki(t){let e=Wn.get(t);return e===void 0&&(e=new Intl.DateTimeFormat("en-US",{hour12:!1,timeZone:t,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",era:"short"}),Wn.set(t,e)),e}const Yi={year:0,month:1,day:2,era:3,hour:4,minute:5,second:6};function Xi(t,e){const n=t.format(e).replace(/\u200E/g,""),a=/(\d+)\/(\d+)\/(\d+) (AD|BC),? (\d+):(\d+):(\d+)/.exec(n),[,r,i,s,l,c,u,d]=a;return[s,r,i,l,c,u,d]}function Qi(t,e){const n=t.formatToParts(e),a=[];for(let r=0;r<n.length;r++){const{type:i,value:s}=n[r],l=Yi[i];i==="era"?a[l]=s:x(l)||(a[l]=parseInt(s,10))}return a}const kn=new Map;class Ie extends Ot{static create(e){let n=kn.get(e);return n===void 0&&kn.set(e,n=new Ie(e)),n}static resetCache(){kn.clear(),Wn.clear()}static isValidSpecifier(e){return this.isValidZone(e)}static isValidZone(e){if(!e)return!1;try{return new Intl.DateTimeFormat("en-US",{timeZone:e}).format(),!0}catch{return!1}}constructor(e){super(),this.zoneName=e,this.valid=Ie.isValidZone(e)}get type(){return"iana"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(e,{format:n,locale:a}){return Vr(e,n,a,this.name)}formatOffset(e,n){return Nt(this.offset(e),n)}offset(e){if(!this.valid)return NaN;const n=new Date(e);if(isNaN(n))return NaN;const a=Ki(this.name);let[r,i,s,l,c,u,d]=a.formatToParts?Qi(a,n):Xi(a,n);l==="BC"&&(r=-Math.abs(r)+1);const p=pn({year:r,month:i,day:s,hour:c===24?0:c,minute:u,second:d,millisecond:0});let f=+n;const y=f%1e3;return f-=y>=0?y:1e3+y,(p-f)/(60*1e3)}equals(e){return e.type==="iana"&&e.name===this.name}get isValid(){return this.valid}}let ba={};function eo(t,e={}){const n=JSON.stringify([t,e]);let a=ba[n];return a||(a=new Intl.ListFormat(t,e),ba[n]=a),a}const zn=new Map;function Gn(t,e={}){const n=JSON.stringify([t,e]);let a=zn.get(n);return a===void 0&&(a=new Intl.DateTimeFormat(t,e),zn.set(n,a)),a}const Vn=new Map;function to(t,e={}){const n=JSON.stringify([t,e]);let a=Vn.get(n);return a===void 0&&(a=new Intl.NumberFormat(t,e),Vn.set(n,a)),a}const Zn=new Map;function no(t,e={}){const{base:n,...a}=e,r=JSON.stringify([t,a]);let i=Zn.get(r);return i===void 0&&(i=new Intl.RelativeTimeFormat(t,e),Zn.set(r,i)),i}let _t=null;function ao(){return _t||(_t=new Intl.DateTimeFormat().resolvedOptions().locale,_t)}const Jn=new Map;function Fr(t){let e=Jn.get(t);return e===void 0&&(e=new Intl.DateTimeFormat(t).resolvedOptions(),Jn.set(t,e)),e}const jn=new Map;function ro(t){let e=jn.get(t);if(!e){const n=new Intl.Locale(t);e="getWeekInfo"in n?n.getWeekInfo():n.weekInfo,"minimalDays"in e||(e={...$r,...e}),jn.set(t,e)}return e}function io(t){const e=t.indexOf("-x-");e!==-1&&(t=t.substring(0,e));const n=t.indexOf("-u-");if(n===-1)return[t];{let a,r;try{a=Gn(t).resolvedOptions(),r=t}catch{const c=t.substring(0,n);a=Gn(c).resolvedOptions(),r=c}const{numberingSystem:i,calendar:s}=a;return[r,i,s]}}function oo(t,e,n){return(n||e)&&(t.includes("-u-")||(t+="-u"),n&&(t+=`-ca-${n}`),e&&(t+=`-nu-${e}`)),t}function so(t){const e=[];for(let n=1;n<=12;n++){const a=N.utc(2009,n,1);e.push(t(a))}return e}function lo(t){const e=[];for(let n=1;n<=7;n++){const a=N.utc(2016,11,13+n);e.push(t(a))}return e}function Gt(t,e,n,a){const r=t.listingMode();return r==="error"?null:r==="en"?n(e):a(e)}function co(t){return t.numberingSystem&&t.numberingSystem!=="latn"?!1:t.numberingSystem==="latn"||!t.locale||t.locale.startsWith("en")||Fr(t.locale).numberingSystem==="latn"}class uo{constructor(e,n,a){this.padTo=a.padTo||0,this.floor=a.floor||!1;const{padTo:r,floor:i,...s}=a;if(!n||Object.keys(s).length>0){const l={useGrouping:!1,...a};a.padTo>0&&(l.minimumIntegerDigits=a.padTo),this.inf=to(e,l)}}format(e){if(this.inf){const n=this.floor?Math.floor(e):e;return this.inf.format(n)}else{const n=this.floor?Math.floor(e):da(e,3);return Z(n,this.padTo)}}}class mo{constructor(e,n,a){this.opts=a,this.originalZone=void 0;let r;if(this.opts.timeZone)this.dt=e;else if(e.zone.type==="fixed"){const s=-1*(e.offset/60),l=s>=0?`Etc/GMT+${s}`:`Etc/GMT${s}`;e.offset!==0&&Ie.create(l).valid?(r=l,this.dt=e):(r="UTC",this.dt=e.offset===0?e:e.setZone("UTC").plus({minutes:e.offset}),this.originalZone=e.zone)}else e.zone.type==="system"?this.dt=e:e.zone.type==="iana"?(this.dt=e,r=e.zone.name):(r="UTC",this.dt=e.setZone("UTC").plus({minutes:e.offset}),this.originalZone=e.zone);const i={...this.opts};i.timeZone=i.timeZone||r,this.dtf=Gn(n,i)}format(){return this.originalZone?this.formatToParts().map(({value:e})=>e).join(""):this.dtf.format(this.dt.toJSDate())}formatToParts(){const e=this.dtf.formatToParts(this.dt.toJSDate());return this.originalZone?e.map(n=>{if(n.type==="timeZoneName"){const a=this.originalZone.offsetName(this.dt.ts,{locale:this.dt.locale,format:this.opts.timeZoneName});return{...n,value:a}}else return n}):e}resolvedOptions(){return this.dtf.resolvedOptions()}}class ho{constructor(e,n,a){this.opts={style:"long",...a},!n&&zr()&&(this.rtf=no(e,a))}format(e,n){return this.rtf?this.rtf.format(e,n):Fo(n,e,this.opts.numeric,this.opts.style!=="long")}formatToParts(e,n){return this.rtf?this.rtf.formatToParts(e,n):[]}}const $r={firstDay:1,minimalDays:4,weekend:[6,7]};class W{static fromOpts(e){return W.create(e.locale,e.numberingSystem,e.outputCalendar,e.weekSettings,e.defaultToEN)}static create(e,n,a,r,i=!1){const s=e||G.defaultLocale,l=s||(i?"en-US":ao()),c=n||G.defaultNumberingSystem,u=a||G.defaultOutputCalendar,d=Kn(r)||G.defaultWeekSettings;return new W(l,c,u,d,s)}static resetCache(){_t=null,zn.clear(),Vn.clear(),Zn.clear(),Jn.clear(),jn.clear()}static fromObject({locale:e,numberingSystem:n,outputCalendar:a,weekSettings:r}={}){return W.create(e,n,a,r)}constructor(e,n,a,r,i){const[s,l,c]=io(e);this.locale=s,this.numberingSystem=n||l||null,this.outputCalendar=a||c||null,this.weekSettings=r,this.intl=oo(this.locale,this.numberingSystem,this.outputCalendar),this.weekdaysCache={format:{},standalone:{}},this.monthsCache={format:{},standalone:{}},this.meridiemCache=null,this.eraCache={},this.specifiedLocale=i,this.fastNumbersCached=null}get fastNumbers(){return this.fastNumbersCached==null&&(this.fastNumbersCached=co(this)),this.fastNumbersCached}listingMode(){const e=this.isEnglish(),n=(this.numberingSystem===null||this.numberingSystem==="latn")&&(this.outputCalendar===null||this.outputCalendar==="gregory");return e&&n?"en":"intl"}clone(e){return!e||Object.getOwnPropertyNames(e).length===0?this:W.create(e.locale||this.specifiedLocale,e.numberingSystem||this.numberingSystem,e.outputCalendar||this.outputCalendar,Kn(e.weekSettings)||this.weekSettings,e.defaultToEN||!1)}redefaultToEN(e={}){return this.clone({...e,defaultToEN:!0})}redefaultToSystem(e={}){return this.clone({...e,defaultToEN:!1})}months(e,n=!1){return Gt(this,e,jr,()=>{const a=this.intl==="ja"||this.intl.startsWith("ja-");n&=!a;const r=n?{month:e,day:"numeric"}:{month:e},i=n?"format":"standalone";if(!this.monthsCache[i][e]){const s=a?l=>this.dtFormatter(l,r).format():l=>this.extract(l,r,"month");this.monthsCache[i][e]=so(s)}return this.monthsCache[i][e]})}weekdays(e,n=!1){return Gt(this,e,Yr,()=>{const a=n?{weekday:e,year:"numeric",month:"long",day:"numeric"}:{weekday:e},r=n?"format":"standalone";return this.weekdaysCache[r][e]||(this.weekdaysCache[r][e]=lo(i=>this.extract(i,a,"weekday"))),this.weekdaysCache[r][e]})}meridiems(){return Gt(this,void 0,()=>Xr,()=>{if(!this.meridiemCache){const e={hour:"numeric",hourCycle:"h12"};this.meridiemCache=[N.utc(2016,11,13,9),N.utc(2016,11,13,19)].map(n=>this.extract(n,e,"dayperiod"))}return this.meridiemCache})}eras(e){return Gt(this,e,Qr,()=>{const n={era:e};return this.eraCache[e]||(this.eraCache[e]=[N.utc(-40,1,1),N.utc(2017,1,1)].map(a=>this.extract(a,n,"era"))),this.eraCache[e]})}extract(e,n,a){const r=this.dtFormatter(e,n),i=r.formatToParts(),s=i.find(l=>l.type.toLowerCase()===a);return s?s.value:null}numberFormatter(e={}){return new uo(this.intl,e.forceSimple||this.fastNumbers,e)}dtFormatter(e,n={}){return new mo(e,this.intl,n)}relFormatter(e={}){return new ho(this.intl,this.isEnglish(),e)}listFormatter(e={}){return eo(this.intl,e)}isEnglish(){return this.locale==="en"||this.locale.toLowerCase()==="en-us"||Fr(this.intl).locale.startsWith("en-us")}getWeekSettings(){return this.weekSettings?this.weekSettings:Gr()?ro(this.locale):$r}getStartOfWeek(){return this.getWeekSettings().firstDay}getMinDaysInFirstWeek(){return this.getWeekSettings().minimalDays}getWeekendDays(){return this.getWeekSettings().weekend}equals(e){return this.locale===e.locale&&this.numberingSystem===e.numberingSystem&&this.outputCalendar===e.outputCalendar}toString(){return`Locale(${this.locale}, ${this.numberingSystem}, ${this.outputCalendar})`}}let Tn=null;class ne extends Ot{static get utcInstance(){return Tn===null&&(Tn=new ne(0)),Tn}static instance(e){return e===0?ne.utcInstance:new ne(e)}static parseSpecifier(e){if(e){const n=e.match(/^utc(?:([+-]\d{1,2})(?::(\d{2}))?)?$/i);if(n)return new ne(yn(n[1],n[2]))}return null}constructor(e){super(),this.fixed=e}get type(){return"fixed"}get name(){return this.fixed===0?"UTC":`UTC${Nt(this.fixed,"narrow")}`}get ianaName(){return this.fixed===0?"Etc/UTC":`Etc/GMT${Nt(-this.fixed,"narrow")}`}offsetName(){return this.name}formatOffset(e,n){return Nt(this.fixed,n)}get isUniversal(){return!0}offset(){return this.fixed}equals(e){return e.type==="fixed"&&e.fixed===this.fixed}get isValid(){return!0}}class fo extends Ot{constructor(e){super(),this.zoneName=e}get type(){return"invalid"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(){return null}formatOffset(){return""}offset(){return NaN}equals(){return!1}get isValid(){return!1}}function Re(t,e){if(x(t)||t===null)return e;if(t instanceof Ot)return t;if(Lo(t)){const n=t.toLowerCase();return n==="default"?e:n==="local"||n==="system"?fn.instance:n==="utc"||n==="gmt"?ne.utcInstance:ne.parseSpecifier(n)||Ie.create(t)}else return Be(t)?ne.instance(t):typeof t=="object"&&"offset"in t&&typeof t.offset=="function"?t:new fo(t)}const sa={arab:"[٠-٩]",arabext:"[۰-۹]",bali:"[᭐-᭙]",beng:"[০-৯]",deva:"[०-९]",fullwide:"[０-９]",gujr:"[૦-૯]",hanidec:"[〇|一|二|三|四|五|六|七|八|九]",khmr:"[០-៩]",knda:"[೦-೯]",laoo:"[໐-໙]",limb:"[᥆-᥏]",mlym:"[൦-൯]",mong:"[᠐-᠙]",mymr:"[၀-၉]",orya:"[୦-୯]",tamldec:"[௦-௯]",telu:"[౦-౯]",thai:"[๐-๙]",tibt:"[༠-༩]",latn:"\\d"},_a={arab:[1632,1641],arabext:[1776,1785],bali:[6992,7001],beng:[2534,2543],deva:[2406,2415],fullwide:[65296,65303],gujr:[2790,2799],khmr:[6112,6121],knda:[3302,3311],laoo:[3792,3801],limb:[6470,6479],mlym:[3430,3439],mong:[6160,6169],mymr:[4160,4169],orya:[2918,2927],tamldec:[3046,3055],telu:[3174,3183],thai:[3664,3673],tibt:[3872,3881]},go=sa.hanidec.replace(/[\[|\]]/g,"").split("");function po(t){let e=parseInt(t,10);if(isNaN(e)){e="";for(let n=0;n<t.length;n++){const a=t.charCodeAt(n);if(t[n].search(sa.hanidec)!==-1)e+=go.indexOf(t[n]);else for(const r in _a){const[i,s]=_a[r];a>=i&&a<=s&&(e+=a-i)}}return parseInt(e,10)}else return e}const qn=new Map;function yo(){qn.clear()}function fe({numberingSystem:t},e=""){const n=t||"latn";let a=qn.get(n);a===void 0&&(a=new Map,qn.set(n,a));let r=a.get(e);return r===void 0&&(r=new RegExp(`${sa[n]}${e}`),a.set(e,r)),r}let ka=()=>Date.now(),Ta="system",Aa=null,Ca=null,Ia=null,Na=60,Pa,Da=null,G=class{static get now(){return ka}static set now(e){ka=e}static set defaultZone(e){Ta=e}static get defaultZone(){return Re(Ta,fn.instance)}static get defaultLocale(){return Aa}static set defaultLocale(e){Aa=e}static get defaultNumberingSystem(){return Ca}static set defaultNumberingSystem(e){Ca=e}static get defaultOutputCalendar(){return Ia}static set defaultOutputCalendar(e){Ia=e}static get defaultWeekSettings(){return Da}static set defaultWeekSettings(e){Da=Kn(e)}static get twoDigitCutoffYear(){return Na}static set twoDigitCutoffYear(e){Na=e%100}static get throwOnInvalid(){return Pa}static set throwOnInvalid(e){Pa=e}static resetCaches(){W.resetCache(),Ie.resetCache(),N.resetCache(),yo()}};class we{constructor(e,n){this.reason=e,this.explanation=n}toMessage(){return this.explanation?`${this.reason}: ${this.explanation}`:this.reason}}const Or=[0,31,59,90,120,151,181,212,243,273,304,334],Rr=[0,31,60,91,121,152,182,213,244,274,305,335];function de(t,e){return new we("unit out of range",`you specified ${e} (of type ${typeof e}) as a ${t}, which is invalid`)}function la(t,e,n){const a=new Date(Date.UTC(t,e-1,n));t<100&&t>=0&&a.setUTCFullYear(a.getUTCFullYear()-1900);const r=a.getUTCDay();return r===0?7:r}function Ur(t,e,n){return n+(Rt(t)?Rr:Or)[e-1]}function Hr(t,e){const n=Rt(t)?Rr:Or,a=n.findIndex(i=>i<e),r=e-n[a];return{month:a+1,day:r}}function ca(t,e){return(t-e+7)%7+1}function ln(t,e=4,n=1){const{year:a,month:r,day:i}=t,s=Ur(a,r,i),l=ca(la(a,r,i),n);let c=Math.floor((s-l+14-e)/7),u;return c<1?(u=a-1,c=xt(u,e,n)):c>xt(a,e,n)?(u=a+1,c=1):u=a,{weekYear:u,weekNumber:c,weekday:l,...wn(t)}}function xa(t,e=4,n=1){const{weekYear:a,weekNumber:r,weekday:i}=t,s=ca(la(a,1,e),n),l=dt(a);let c=r*7+i-s-7+e,u;c<1?(u=a-1,c+=dt(u)):c>l?(u=a+1,c-=dt(a)):u=a;const{month:d,day:h}=Hr(u,c);return{year:u,month:d,day:h,...wn(t)}}function An(t){const{year:e,month:n,day:a}=t,r=Ur(e,n,a);return{year:e,ordinal:r,...wn(t)}}function Fa(t){const{year:e,ordinal:n}=t,{month:a,day:r}=Hr(e,n);return{year:e,month:a,day:r,...wn(t)}}function $a(t,e){if(!x(t.localWeekday)||!x(t.localWeekNumber)||!x(t.localWeekYear)){if(!x(t.weekday)||!x(t.weekNumber)||!x(t.weekYear))throw new ct("Cannot mix locale-based week fields with ISO-based week fields");return x(t.localWeekday)||(t.weekday=t.localWeekday),x(t.localWeekNumber)||(t.weekNumber=t.localWeekNumber),x(t.localWeekYear)||(t.weekYear=t.localWeekYear),delete t.localWeekday,delete t.localWeekNumber,delete t.localWeekYear,{minDaysInFirstWeek:e.getMinDaysInFirstWeek(),startOfWeek:e.getStartOfWeek()}}else return{minDaysInFirstWeek:4,startOfWeek:1}}function wo(t,e=4,n=1){const a=gn(t.weekYear),r=me(t.weekNumber,1,xt(t.weekYear,e,n)),i=me(t.weekday,1,7);return a?r?i?!1:de("weekday",t.weekday):de("week",t.weekNumber):de("weekYear",t.weekYear)}function vo(t){const e=gn(t.year),n=me(t.ordinal,1,dt(t.year));return e?n?!1:de("ordinal",t.ordinal):de("year",t.year)}function Br(t){const e=gn(t.year),n=me(t.month,1,12),a=me(t.day,1,cn(t.year,t.month));return e?n?a?!1:de("day",t.day):de("month",t.month):de("year",t.year)}function Wr(t){const{hour:e,minute:n,second:a,millisecond:r}=t,i=me(e,0,23)||e===24&&n===0&&a===0&&r===0,s=me(n,0,59),l=me(a,0,59),c=me(r,0,999);return i?s?l?c?!1:de("millisecond",r):de("second",a):de("minute",n):de("hour",e)}function x(t){return typeof t>"u"}function Be(t){return typeof t=="number"}function gn(t){return typeof t=="number"&&t%1===0}function Lo(t){return typeof t=="string"}function Mo(t){return Object.prototype.toString.call(t)==="[object Date]"}function zr(){try{return typeof Intl<"u"&&!!Intl.RelativeTimeFormat}catch{return!1}}function Gr(){try{return typeof Intl<"u"&&!!Intl.Locale&&("weekInfo"in Intl.Locale.prototype||"getWeekInfo"in Intl.Locale.prototype)}catch{return!1}}function So(t){return Array.isArray(t)?t:[t]}function Oa(t,e,n){if(t.length!==0)return t.reduce((a,r)=>{const i=[e(r),r];return a&&n(a[0],i[0])===a[0]?a:i},null)[1]}function Eo(t,e){return e.reduce((n,a)=>(n[a]=t[a],n),{})}function ft(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function Kn(t){if(t==null)return null;if(typeof t!="object")throw new X("Week settings must be an object");if(!me(t.firstDay,1,7)||!me(t.minimalDays,1,7)||!Array.isArray(t.weekend)||t.weekend.some(e=>!me(e,1,7)))throw new X("Invalid week settings");return{firstDay:t.firstDay,minimalDays:t.minimalDays,weekend:Array.from(t.weekend)}}function me(t,e,n){return gn(t)&&t>=e&&t<=n}function bo(t,e){return t-e*Math.floor(t/e)}function Z(t,e=2){const n=t<0;let a;return n?a="-"+(""+-t).padStart(e,"0"):a=(""+t).padStart(e,"0"),a}function Fe(t){if(!(x(t)||t===null||t===""))return parseInt(t,10)}function Ve(t){if(!(x(t)||t===null||t===""))return parseFloat(t)}function ua(t){if(!(x(t)||t===null||t==="")){const e=parseFloat("0."+t)*1e3;return Math.floor(e)}}function da(t,e,n="round"){const a=10**e;switch(n){case"expand":return t>0?Math.ceil(t*a)/a:Math.floor(t*a)/a;case"trunc":return Math.trunc(t*a)/a;case"round":return Math.round(t*a)/a;case"floor":return Math.floor(t*a)/a;case"ceil":return Math.ceil(t*a)/a;default:throw new RangeError(`Value rounding ${n} is out of range`)}}function Rt(t){return t%4===0&&(t%100!==0||t%400===0)}function dt(t){return Rt(t)?366:365}function cn(t,e){const n=bo(e-1,12)+1,a=t+(e-n)/12;return n===2?Rt(a)?29:28:[31,null,31,30,31,30,31,31,30,31,30,31][n-1]}function pn(t){let e=Date.UTC(t.year,t.month-1,t.day,t.hour,t.minute,t.second,t.millisecond);return t.year<100&&t.year>=0&&(e=new Date(e),e.setUTCFullYear(t.year,t.month-1,t.day)),+e}function Ra(t,e,n){return-ca(la(t,1,e),n)+e-1}function xt(t,e=4,n=1){const a=Ra(t,e,n),r=Ra(t+1,e,n);return(dt(t)-a+r)/7}function Yn(t){return t>99?t:t>G.twoDigitCutoffYear?1900+t:2e3+t}function Vr(t,e,n,a=null){const r=new Date(t),i={hourCycle:"h23",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"};a&&(i.timeZone=a);const s={timeZoneName:e,...i},l=new Intl.DateTimeFormat(n,s).formatToParts(r).find(c=>c.type.toLowerCase()==="timezonename");return l?l.value:null}function yn(t,e){let n=parseInt(t,10);Number.isNaN(n)&&(n=0);const a=parseInt(e,10)||0,r=n<0||Object.is(n,-0)?-a:a;return n*60+r}function Zr(t){const e=Number(t);if(typeof t=="boolean"||t===""||!Number.isFinite(e))throw new X(`Invalid unit value ${t}`);return e}function un(t,e){const n={};for(const a in t)if(ft(t,a)){const r=t[a];if(r==null)continue;n[e(a)]=Zr(r)}return n}function Nt(t,e){const n=Math.trunc(Math.abs(t/60)),a=Math.trunc(Math.abs(t%60)),r=t>=0?"+":"-";switch(e){case"short":return`${r}${Z(n,2)}:${Z(a,2)}`;case"narrow":return`${r}${n}${a>0?`:${a}`:""}`;case"techie":return`${r}${Z(n,2)}${Z(a,2)}`;default:throw new RangeError(`Value format ${e} is out of range for property format`)}}function wn(t){return Eo(t,["hour","minute","second","millisecond"])}const _o=["January","February","March","April","May","June","July","August","September","October","November","December"],Jr=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],ko=["J","F","M","A","M","J","J","A","S","O","N","D"];function jr(t){switch(t){case"narrow":return[...ko];case"short":return[...Jr];case"long":return[..._o];case"numeric":return["1","2","3","4","5","6","7","8","9","10","11","12"];case"2-digit":return["01","02","03","04","05","06","07","08","09","10","11","12"];default:return null}}const qr=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],Kr=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],To=["M","T","W","T","F","S","S"];function Yr(t){switch(t){case"narrow":return[...To];case"short":return[...Kr];case"long":return[...qr];case"numeric":return["1","2","3","4","5","6","7"];default:return null}}const Xr=["AM","PM"],Ao=["Before Christ","Anno Domini"],Co=["BC","AD"],Io=["B","A"];function Qr(t){switch(t){case"narrow":return[...Io];case"short":return[...Co];case"long":return[...Ao];default:return null}}function No(t){return Xr[t.hour<12?0:1]}function Po(t,e){return Yr(e)[t.weekday-1]}function Do(t,e){return jr(e)[t.month-1]}function xo(t,e){return Qr(e)[t.year<0?0:1]}function Fo(t,e,n="always",a=!1){const r={years:["year","yr."],quarters:["quarter","qtr."],months:["month","mo."],weeks:["week","wk."],days:["day","day","days"],hours:["hour","hr."],minutes:["minute","min."],seconds:["second","sec."]},i=["hours","minutes","seconds"].indexOf(t)===-1;if(n==="auto"&&i){const h=t==="days";switch(e){case 1:return h?"tomorrow":`next ${r[t][0]}`;case-1:return h?"yesterday":`last ${r[t][0]}`;case 0:return h?"today":`this ${r[t][0]}`}}const s=Object.is(e,-0)||e<0,l=Math.abs(e),c=l===1,u=r[t],d=a?c?u[1]:u[2]||u[1]:c?r[t][0]:t;return s?`${l} ${d} ago`:`in ${l} ${d}`}function Ua(t,e){let n="";for(const a of t)a.literal?n+=a.val:n+=e(a.val);return n}const $o={D:sn,DD:pr,DDD:yr,DDDD:wr,t:vr,tt:Lr,ttt:Mr,tttt:Sr,T:Er,TT:br,TTT:_r,TTTT:kr,f:Tr,ff:Cr,fff:Nr,ffff:Dr,F:Ar,FF:Ir,FFF:Pr,FFFF:xr};class ee{static create(e,n={}){return new ee(e,n)}static parseFormat(e){let n=null,a="",r=!1;const i=[];for(let s=0;s<e.length;s++){const l=e.charAt(s);l==="'"?((a.length>0||r)&&i.push({literal:r||/^\s+$/.test(a),val:a===""?"'":a}),n=null,a="",r=!r):r||l===n?a+=l:(a.length>0&&i.push({literal:/^\s+$/.test(a),val:a}),a=l,n=l)}return a.length>0&&i.push({literal:r||/^\s+$/.test(a),val:a}),i}static macroTokenToFormatOpts(e){return $o[e]}constructor(e,n){this.opts=n,this.loc=e,this.systemLoc=null}formatWithSystemDefault(e,n){return this.systemLoc===null&&(this.systemLoc=this.loc.redefaultToSystem()),this.systemLoc.dtFormatter(e,{...this.opts,...n}).format()}dtFormatter(e,n={}){return this.loc.dtFormatter(e,{...this.opts,...n})}formatDateTime(e,n){return this.dtFormatter(e,n).format()}formatDateTimeParts(e,n){return this.dtFormatter(e,n).formatToParts()}formatInterval(e,n){return this.dtFormatter(e.start,n).dtf.formatRange(e.start.toJSDate(),e.end.toJSDate())}resolvedOptions(e,n){return this.dtFormatter(e,n).resolvedOptions()}num(e,n=0,a=void 0){if(this.opts.forceSimple)return Z(e,n);const r={...this.opts};return n>0&&(r.padTo=n),a&&(r.signDisplay=a),this.loc.numberFormatter(r).format(e)}formatDateTimeFromString(e,n){const a=this.loc.listingMode()==="en",r=this.loc.outputCalendar&&this.loc.outputCalendar!=="gregory",i=(f,y)=>this.loc.extract(e,f,y),s=f=>e.isOffsetFixed&&e.offset===0&&f.allowZ?"Z":e.isValid?e.zone.formatOffset(e.ts,f.format):"",l=()=>a?No(e):i({hour:"numeric",hourCycle:"h12"},"dayperiod"),c=(f,y)=>a?Do(e,f):i(y?{month:f}:{month:f,day:"numeric"},"month"),u=(f,y)=>a?Po(e,f):i(y?{weekday:f}:{weekday:f,month:"long",day:"numeric"},"weekday"),d=f=>{const y=ee.macroTokenToFormatOpts(f);return y?this.formatWithSystemDefault(e,y):f},h=f=>a?xo(e,f):i({era:f},"era"),p=f=>{switch(f){case"S":return this.num(e.millisecond);case"u":case"SSS":return this.num(e.millisecond,3);case"s":return this.num(e.second);case"ss":return this.num(e.second,2);case"uu":return this.num(Math.floor(e.millisecond/10),2);case"uuu":return this.num(Math.floor(e.millisecond/100));case"m":return this.num(e.minute);case"mm":return this.num(e.minute,2);case"h":return this.num(e.hour%12===0?12:e.hour%12);case"hh":return this.num(e.hour%12===0?12:e.hour%12,2);case"H":return this.num(e.hour);case"HH":return this.num(e.hour,2);case"Z":return s({format:"narrow",allowZ:this.opts.allowZ});case"ZZ":return s({format:"short",allowZ:this.opts.allowZ});case"ZZZ":return s({format:"techie",allowZ:this.opts.allowZ});case"ZZZZ":return e.zone.offsetName(e.ts,{format:"short",locale:this.loc.locale});case"ZZZZZ":return e.zone.offsetName(e.ts,{format:"long",locale:this.loc.locale});case"z":return e.zoneName;case"a":return l();case"d":return r?i({day:"numeric"},"day"):this.num(e.day);case"dd":return r?i({day:"2-digit"},"day"):this.num(e.day,2);case"c":return this.num(e.weekday);case"ccc":return u("short",!0);case"cccc":return u("long",!0);case"ccccc":return u("narrow",!0);case"E":return this.num(e.weekday);case"EEE":return u("short",!1);case"EEEE":return u("long",!1);case"EEEEE":return u("narrow",!1);case"L":return r?i({month:"numeric",day:"numeric"},"month"):this.num(e.month);case"LL":return r?i({month:"2-digit",day:"numeric"},"month"):this.num(e.month,2);case"LLL":return c("short",!0);case"LLLL":return c("long",!0);case"LLLLL":return c("narrow",!0);case"M":return r?i({month:"numeric"},"month"):this.num(e.month);case"MM":return r?i({month:"2-digit"},"month"):this.num(e.month,2);case"MMM":return c("short",!1);case"MMMM":return c("long",!1);case"MMMMM":return c("narrow",!1);case"y":return r?i({year:"numeric"},"year"):this.num(e.year);case"yy":return r?i({year:"2-digit"},"year"):this.num(e.year.toString().slice(-2),2);case"yyyy":return r?i({year:"numeric"},"year"):this.num(e.year,4);case"yyyyyy":return r?i({year:"numeric"},"year"):this.num(e.year,6);case"G":return h("short");case"GG":return h("long");case"GGGGG":return h("narrow");case"kk":return this.num(e.weekYear.toString().slice(-2),2);case"kkkk":return this.num(e.weekYear,4);case"W":return this.num(e.weekNumber);case"WW":return this.num(e.weekNumber,2);case"n":return this.num(e.localWeekNumber);case"nn":return this.num(e.localWeekNumber,2);case"ii":return this.num(e.localWeekYear.toString().slice(-2),2);case"iiii":return this.num(e.localWeekYear,4);case"o":return this.num(e.ordinal);case"ooo":return this.num(e.ordinal,3);case"q":return this.num(e.quarter);case"qq":return this.num(e.quarter,2);case"X":return this.num(Math.floor(e.ts/1e3));case"x":return this.num(e.ts);default:return d(f)}};return Ua(ee.parseFormat(n),p)}formatDurationFromString(e,n){const a=this.opts.signMode==="negativeLargestOnly"?-1:1,r=d=>{switch(d[0]){case"S":return"milliseconds";case"s":return"seconds";case"m":return"minutes";case"h":return"hours";case"d":return"days";case"w":return"weeks";case"M":return"months";case"y":return"years";default:return null}},i=(d,h)=>p=>{const f=r(p);if(f){const y=h.isNegativeDuration&&f!==h.largestUnit?a:1;let v;return this.opts.signMode==="negativeLargestOnly"&&f!==h.largestUnit?v="never":this.opts.signMode==="all"?v="always":v="auto",this.num(d.get(f)*y,p.length,v)}else return p},s=ee.parseFormat(n),l=s.reduce((d,{literal:h,val:p})=>h?d:d.concat(p),[]),c=e.shiftTo(...l.map(r).filter(d=>d)),u={isNegativeDuration:c<0,largestUnit:Object.keys(c.values)[0]};return Ua(s,i(c,u))}}const ei=/[A-Za-z_+-]{1,256}(?::?\/[A-Za-z0-9_+-]{1,256}(?:\/[A-Za-z0-9_+-]{1,256})?)?/;function gt(...t){const e=t.reduce((n,a)=>n+a.source,"");return RegExp(`^${e}$`)}function pt(...t){return e=>t.reduce(([n,a,r],i)=>{const[s,l,c]=i(e,r);return[{...n,...s},l||a,c]},[{},null,1]).slice(0,2)}function yt(t,...e){if(t==null)return[null,null];for(const[n,a]of e){const r=n.exec(t);if(r)return a(r)}return[null,null]}function ti(...t){return(e,n)=>{const a={};let r;for(r=0;r<t.length;r++)a[t[r]]=Fe(e[n+r]);return[a,null,n+r]}}const ni=/(?:([Zz])|([+-]\d\d)(?::?(\d\d))?)/,Oo=`(?:${ni.source}?(?:\\[(${ei.source})\\])?)?`,ma=/(\d\d)(?::?(\d\d)(?::?(\d\d)(?:[.,](\d{1,30}))?)?)?/,ai=RegExp(`${ma.source}${Oo}`),ha=RegExp(`(?:[Tt]${ai.source})?`),Ro=/([+-]\d{6}|\d{4})(?:-?(\d\d)(?:-?(\d\d))?)?/,Uo=/(\d{4})-?W(\d\d)(?:-?(\d))?/,Ho=/(\d{4})-?(\d{3})/,Bo=ti("weekYear","weekNumber","weekDay"),Wo=ti("year","ordinal"),zo=/(\d{4})-(\d\d)-(\d\d)/,ri=RegExp(`${ma.source} ?(?:${ni.source}|(${ei.source}))?`),Go=RegExp(`(?: ${ri.source})?`);function mt(t,e,n){const a=t[e];return x(a)?n:Fe(a)}function Vo(t,e){return[{year:mt(t,e),month:mt(t,e+1,1),day:mt(t,e+2,1)},null,e+3]}function wt(t,e){return[{hours:mt(t,e,0),minutes:mt(t,e+1,0),seconds:mt(t,e+2,0),milliseconds:ua(t[e+3])},null,e+4]}function Ut(t,e){const n=!t[e]&&!t[e+1],a=yn(t[e+1],t[e+2]),r=n?null:ne.instance(a);return[{},r,e+3]}function Ht(t,e){const n=t[e]?Ie.create(t[e]):null;return[{},n,e+1]}const Zo=RegExp(`^T?${ma.source}$`),Jo=/^-?P(?:(?:(-?\d{1,20}(?:\.\d{1,20})?)Y)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20}(?:\.\d{1,20})?)W)?(?:(-?\d{1,20}(?:\.\d{1,20})?)D)?(?:T(?:(-?\d{1,20}(?:\.\d{1,20})?)H)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20})(?:[.,](-?\d{1,20}))?S)?)?)$/;function jo(t){const[e,n,a,r,i,s,l,c,u]=t,d=e[0]==="-",h=c&&c[0]==="-",p=(f,y=!1)=>f!==void 0&&(y||f&&d)?-f:f;return[{years:p(Ve(n)),months:p(Ve(a)),weeks:p(Ve(r)),days:p(Ve(i)),hours:p(Ve(s)),minutes:p(Ve(l)),seconds:p(Ve(c),c==="-0"),milliseconds:p(ua(u),h)}]}const qo={GMT:0,EDT:-240,EST:-300,CDT:-300,CST:-360,MDT:-360,MST:-420,PDT:-420,PST:-480};function fa(t,e,n,a,r,i,s){const l={year:e.length===2?Yn(Fe(e)):Fe(e),month:Jr.indexOf(n)+1,day:Fe(a),hour:Fe(r),minute:Fe(i)};return s&&(l.second=Fe(s)),t&&(l.weekday=t.length>3?qr.indexOf(t)+1:Kr.indexOf(t)+1),l}const Ko=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|(?:([+-]\d\d)(\d\d)))$/;function Yo(t){const[,e,n,a,r,i,s,l,c,u,d,h]=t,p=fa(e,r,a,n,i,s,l);let f;return c?f=qo[c]:u?f=0:f=yn(d,h),[p,new ne(f)]}function Xo(t){return t.replace(/\([^()]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").trim()}const Qo=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun), (\d\d) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) (\d{4}) (\d\d):(\d\d):(\d\d) GMT$/,es=/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday), (\d\d)-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-(\d\d) (\d\d):(\d\d):(\d\d) GMT$/,ts=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) ( \d|\d\d) (\d\d):(\d\d):(\d\d) (\d{4})$/;function Ha(t){const[,e,n,a,r,i,s,l]=t;return[fa(e,r,a,n,i,s,l),ne.utcInstance]}function ns(t){const[,e,n,a,r,i,s,l]=t;return[fa(e,l,n,a,r,i,s),ne.utcInstance]}const as=gt(Ro,ha),rs=gt(Uo,ha),is=gt(Ho,ha),os=gt(ai),ii=pt(Vo,wt,Ut,Ht),ss=pt(Bo,wt,Ut,Ht),ls=pt(Wo,wt,Ut,Ht),cs=pt(wt,Ut,Ht);function us(t){return yt(t,[as,ii],[rs,ss],[is,ls],[os,cs])}function ds(t){return yt(Xo(t),[Ko,Yo])}function ms(t){return yt(t,[Qo,Ha],[es,Ha],[ts,ns])}function hs(t){return yt(t,[Jo,jo])}const fs=pt(wt);function gs(t){return yt(t,[Zo,fs])}const ps=gt(zo,Go),ys=gt(ri),ws=pt(wt,Ut,Ht);function vs(t){return yt(t,[ps,ii],[ys,ws])}const Ba="Invalid Duration",oi={weeks:{days:7,hours:168,minutes:10080,seconds:10080*60,milliseconds:10080*60*1e3},days:{hours:24,minutes:1440,seconds:1440*60,milliseconds:1440*60*1e3},hours:{minutes:60,seconds:3600,milliseconds:3600*1e3},minutes:{seconds:60,milliseconds:60*1e3},seconds:{milliseconds:1e3}},Ls={years:{quarters:4,months:12,weeks:52,days:365,hours:365*24,minutes:365*24*60,seconds:365*24*60*60,milliseconds:365*24*60*60*1e3},quarters:{months:3,weeks:13,days:91,hours:2184,minutes:2184*60,seconds:2184*60*60,milliseconds:2184*60*60*1e3},months:{weeks:4,days:30,hours:720,minutes:720*60,seconds:720*60*60,milliseconds:720*60*60*1e3},...oi},ce=146097/400,it=146097/4800,Ms={years:{quarters:4,months:12,weeks:ce/7,days:ce,hours:ce*24,minutes:ce*24*60,seconds:ce*24*60*60,milliseconds:ce*24*60*60*1e3},quarters:{months:3,weeks:ce/28,days:ce/4,hours:ce*24/4,minutes:ce*24*60/4,seconds:ce*24*60*60/4,milliseconds:ce*24*60*60*1e3/4},months:{weeks:it/7,days:it,hours:it*24,minutes:it*24*60,seconds:it*24*60*60,milliseconds:it*24*60*60*1e3},...oi},Xe=["years","quarters","months","weeks","days","hours","minutes","seconds","milliseconds"],Ss=Xe.slice(0).reverse();function Ae(t,e,n=!1){const a={values:n?e.values:{...t.values,...e.values||{}},loc:t.loc.clone(e.loc),conversionAccuracy:e.conversionAccuracy||t.conversionAccuracy,matrix:e.matrix||t.matrix};return new R(a)}function si(t,e){let n=e.milliseconds??0;for(const a of Ss.slice(1))e[a]&&(n+=e[a]*t[a].milliseconds);return n}function Wa(t,e){const n=si(t,e)<0?-1:1;Xe.reduceRight((a,r)=>{if(x(e[r]))return a;if(a){const i=e[a]*n,s=t[r][a],l=Math.floor(i/s);e[r]+=l*n,e[a]-=l*s*n}return r},null),Xe.reduce((a,r)=>{if(x(e[r]))return a;if(a){const i=e[a]%1;e[a]-=i,e[r]+=i*t[a][r]}return r},null)}function za(t){const e={};for(const[n,a]of Object.entries(t))a!==0&&(e[n]=a);return e}class R{constructor(e){const n=e.conversionAccuracy==="longterm"||!1;let a=n?Ms:Ls;e.matrix&&(a=e.matrix),this.values=e.values,this.loc=e.loc||W.create(),this.conversionAccuracy=n?"longterm":"casual",this.invalid=e.invalid||null,this.matrix=a,this.isLuxonDuration=!0}static fromMillis(e,n){return R.fromObject({milliseconds:e},n)}static fromObject(e,n={}){if(e==null||typeof e!="object")throw new X(`Duration.fromObject: argument expected to be an object, got ${e===null?"null":typeof e}`);return new R({values:un(e,R.normalizeUnit),loc:W.fromObject(n),conversionAccuracy:n.conversionAccuracy,matrix:n.matrix})}static fromDurationLike(e){if(Be(e))return R.fromMillis(e);if(R.isDuration(e))return e;if(typeof e=="object")return R.fromObject(e);throw new X(`Unknown duration argument ${e} of type ${typeof e}`)}static fromISO(e,n){const[a]=hs(e);return a?R.fromObject(a,n):R.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static fromISOTime(e,n){const[a]=gs(e);return a?R.fromObject(a,n):R.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static invalid(e,n=null){if(!e)throw new X("need to specify a reason the Duration is invalid");const a=e instanceof we?e:new we(e,n);if(G.throwOnInvalid)throw new Ji(a);return new R({invalid:a})}static normalizeUnit(e){const n={year:"years",years:"years",quarter:"quarters",quarters:"quarters",month:"months",months:"months",week:"weeks",weeks:"weeks",day:"days",days:"days",hour:"hours",hours:"hours",minute:"minutes",minutes:"minutes",second:"seconds",seconds:"seconds",millisecond:"milliseconds",milliseconds:"milliseconds"}[e&&e.toLowerCase()];if(!n)throw new gr(e);return n}static isDuration(e){return e&&e.isLuxonDuration||!1}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}toFormat(e,n={}){const a={...n,floor:n.round!==!1&&n.floor!==!1};return this.isValid?ee.create(this.loc,a).formatDurationFromString(this,e):Ba}toHuman(e={}){if(!this.isValid)return Ba;const n=e.showZeros!==!1,a=Xe.map(r=>{const i=this.values[r];return x(i)||i===0&&!n?null:this.loc.numberFormatter({style:"unit",unitDisplay:"long",...e,unit:r.slice(0,-1)}).format(i)}).filter(r=>r);return this.loc.listFormatter({type:"conjunction",style:e.listStyle||"narrow",...e}).format(a)}toObject(){return this.isValid?{...this.values}:{}}toISO(){if(!this.isValid)return null;let e="P";return this.years!==0&&(e+=this.years+"Y"),(this.months!==0||this.quarters!==0)&&(e+=this.months+this.quarters*3+"M"),this.weeks!==0&&(e+=this.weeks+"W"),this.days!==0&&(e+=this.days+"D"),(this.hours!==0||this.minutes!==0||this.seconds!==0||this.milliseconds!==0)&&(e+="T"),this.hours!==0&&(e+=this.hours+"H"),this.minutes!==0&&(e+=this.minutes+"M"),(this.seconds!==0||this.milliseconds!==0)&&(e+=da(this.seconds+this.milliseconds/1e3,3)+"S"),e==="P"&&(e+="T0S"),e}toISOTime(e={}){if(!this.isValid)return null;const n=this.toMillis();return n<0||n>=864e5?null:(e={suppressMilliseconds:!1,suppressSeconds:!1,includePrefix:!1,format:"extended",...e,includeOffset:!1},N.fromMillis(n,{zone:"UTC"}).toISOTime(e))}toJSON(){return this.toISO()}toString(){return this.toISO()}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`Duration { values: ${JSON.stringify(this.values)} }`:`Duration { Invalid, reason: ${this.invalidReason} }`}toMillis(){return this.isValid?si(this.matrix,this.values):NaN}valueOf(){return this.toMillis()}plus(e){if(!this.isValid)return this;const n=R.fromDurationLike(e),a={};for(const r of Xe)(ft(n.values,r)||ft(this.values,r))&&(a[r]=n.get(r)+this.get(r));return Ae(this,{values:a},!0)}minus(e){if(!this.isValid)return this;const n=R.fromDurationLike(e);return this.plus(n.negate())}mapUnits(e){if(!this.isValid)return this;const n={};for(const a of Object.keys(this.values))n[a]=Zr(e(this.values[a],a));return Ae(this,{values:n},!0)}get(e){return this[R.normalizeUnit(e)]}set(e){if(!this.isValid)return this;const n={...this.values,...un(e,R.normalizeUnit)};return Ae(this,{values:n})}reconfigure({locale:e,numberingSystem:n,conversionAccuracy:a,matrix:r}={}){const s={loc:this.loc.clone({locale:e,numberingSystem:n}),matrix:r,conversionAccuracy:a};return Ae(this,s)}as(e){return this.isValid?this.shiftTo(e).get(e):NaN}normalize(){if(!this.isValid)return this;const e=this.toObject();return Wa(this.matrix,e),Ae(this,{values:e},!0)}rescale(){if(!this.isValid)return this;const e=za(this.normalize().shiftToAll().toObject());return Ae(this,{values:e},!0)}shiftTo(...e){if(!this.isValid)return this;if(e.length===0)return this;e=e.map(s=>R.normalizeUnit(s));const n={},a={},r=this.toObject();let i;for(const s of Xe)if(e.indexOf(s)>=0){i=s;let l=0;for(const u in a)l+=this.matrix[u][s]*a[u],a[u]=0;Be(r[s])&&(l+=r[s]);const c=Math.trunc(l);n[s]=c,a[s]=(l*1e3-c*1e3)/1e3}else Be(r[s])&&(a[s]=r[s]);for(const s in a)a[s]!==0&&(n[i]+=s===i?a[s]:a[s]/this.matrix[i][s]);return Wa(this.matrix,n),Ae(this,{values:n},!0)}shiftToAll(){return this.isValid?this.shiftTo("years","months","weeks","days","hours","minutes","seconds","milliseconds"):this}negate(){if(!this.isValid)return this;const e={};for(const n of Object.keys(this.values))e[n]=this.values[n]===0?0:-this.values[n];return Ae(this,{values:e},!0)}removeZeros(){if(!this.isValid)return this;const e=za(this.values);return Ae(this,{values:e},!0)}get years(){return this.isValid?this.values.years||0:NaN}get quarters(){return this.isValid?this.values.quarters||0:NaN}get months(){return this.isValid?this.values.months||0:NaN}get weeks(){return this.isValid?this.values.weeks||0:NaN}get days(){return this.isValid?this.values.days||0:NaN}get hours(){return this.isValid?this.values.hours||0:NaN}get minutes(){return this.isValid?this.values.minutes||0:NaN}get seconds(){return this.isValid?this.values.seconds||0:NaN}get milliseconds(){return this.isValid?this.values.milliseconds||0:NaN}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}equals(e){if(!this.isValid||!e.isValid||!this.loc.equals(e.loc))return!1;function n(a,r){return a===void 0||a===0?r===void 0||r===0:a===r}for(const a of Xe)if(!n(this.values[a],e.values[a]))return!1;return!0}}const ot="Invalid Interval";function Es(t,e){return!t||!t.isValid?z.invalid("missing or invalid start"):!e||!e.isValid?z.invalid("missing or invalid end"):e<t?z.invalid("end before start",`The end of an interval must be after its start, but you had start=${t.toISO()} and end=${e.toISO()}`):null}class z{constructor(e){this.s=e.start,this.e=e.end,this.invalid=e.invalid||null,this.isLuxonInterval=!0}static invalid(e,n=null){if(!e)throw new X("need to specify a reason the Interval is invalid");const a=e instanceof we?e:new we(e,n);if(G.throwOnInvalid)throw new Zi(a);return new z({invalid:a})}static fromDateTimes(e,n){const a=bt(e),r=bt(n),i=Es(a,r);return i??new z({start:a,end:r})}static after(e,n){const a=R.fromDurationLike(n),r=bt(e);return z.fromDateTimes(r,r.plus(a))}static before(e,n){const a=R.fromDurationLike(n),r=bt(e);return z.fromDateTimes(r.minus(a),r)}static fromISO(e,n){const[a,r]=(e||"").split("/",2);if(a&&r){let i,s;try{i=N.fromISO(a,n),s=i.isValid}catch{s=!1}let l,c;try{l=N.fromISO(r,n),c=l.isValid}catch{c=!1}if(s&&c)return z.fromDateTimes(i,l);if(s){const u=R.fromISO(r,n);if(u.isValid)return z.after(i,u)}else if(c){const u=R.fromISO(a,n);if(u.isValid)return z.before(l,u)}}return z.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static isInterval(e){return e&&e.isLuxonInterval||!1}get start(){return this.isValid?this.s:null}get end(){return this.isValid?this.e:null}get lastDateTime(){return this.isValid&&this.e?this.e.minus(1):null}get isValid(){return this.invalidReason===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}length(e="milliseconds"){return this.isValid?this.toDuration(e).get(e):NaN}count(e="milliseconds",n){if(!this.isValid)return NaN;const a=this.start.startOf(e,n);let r;return n?.useLocaleWeeks?r=this.end.reconfigure({locale:a.locale}):r=this.end,r=r.startOf(e,n),Math.floor(r.diff(a,e).get(e))+(r.valueOf()!==this.end.valueOf())}hasSame(e){return this.isValid?this.isEmpty()||this.e.minus(1).hasSame(this.s,e):!1}isEmpty(){return this.s.valueOf()===this.e.valueOf()}isAfter(e){return this.isValid?this.s>e:!1}isBefore(e){return this.isValid?this.e<=e:!1}contains(e){return this.isValid?this.s<=e&&this.e>e:!1}set({start:e,end:n}={}){return this.isValid?z.fromDateTimes(e||this.s,n||this.e):this}splitAt(...e){if(!this.isValid)return[];const n=e.map(bt).filter(s=>this.contains(s)).sort((s,l)=>s.toMillis()-l.toMillis()),a=[];let{s:r}=this,i=0;for(;r<this.e;){const s=n[i]||this.e,l=+s>+this.e?this.e:s;a.push(z.fromDateTimes(r,l)),r=l,i+=1}return a}splitBy(e){const n=R.fromDurationLike(e);if(!this.isValid||!n.isValid||n.as("milliseconds")===0)return[];let{s:a}=this,r=1,i;const s=[];for(;a<this.e;){const l=this.start.plus(n.mapUnits(c=>c*r));i=+l>+this.e?this.e:l,s.push(z.fromDateTimes(a,i)),a=i,r+=1}return s}divideEqually(e){return this.isValid?this.splitBy(this.length()/e).slice(0,e):[]}overlaps(e){return this.e>e.s&&this.s<e.e}abutsStart(e){return this.isValid?+this.e==+e.s:!1}abutsEnd(e){return this.isValid?+e.e==+this.s:!1}engulfs(e){return this.isValid?this.s<=e.s&&this.e>=e.e:!1}equals(e){return!this.isValid||!e.isValid?!1:this.s.equals(e.s)&&this.e.equals(e.e)}intersection(e){if(!this.isValid)return this;const n=this.s>e.s?this.s:e.s,a=this.e<e.e?this.e:e.e;return n>=a?null:z.fromDateTimes(n,a)}union(e){if(!this.isValid)return this;const n=this.s<e.s?this.s:e.s,a=this.e>e.e?this.e:e.e;return z.fromDateTimes(n,a)}static merge(e){const[n,a]=e.sort((r,i)=>r.s-i.s).reduce(([r,i],s)=>i?i.overlaps(s)||i.abutsStart(s)?[r,i.union(s)]:[r.concat([i]),s]:[r,s],[[],null]);return a&&n.push(a),n}static xor(e){let n=null,a=0;const r=[],i=e.map(c=>[{time:c.s,type:"s"},{time:c.e,type:"e"}]),s=Array.prototype.concat(...i),l=s.sort((c,u)=>c.time-u.time);for(const c of l)a+=c.type==="s"?1:-1,a===1?n=c.time:(n&&+n!=+c.time&&r.push(z.fromDateTimes(n,c.time)),n=null);return z.merge(r)}difference(...e){return z.xor([this].concat(e)).map(n=>this.intersection(n)).filter(n=>n&&!n.isEmpty())}toString(){return this.isValid?`[${this.s.toISO()} – ${this.e.toISO()})`:ot}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`Interval { start: ${this.s.toISO()}, end: ${this.e.toISO()} }`:`Interval { Invalid, reason: ${this.invalidReason} }`}toLocaleString(e=sn,n={}){return this.isValid?ee.create(this.s.loc.clone(n),e).formatInterval(this):ot}toISO(e){return this.isValid?`${this.s.toISO(e)}/${this.e.toISO(e)}`:ot}toISODate(){return this.isValid?`${this.s.toISODate()}/${this.e.toISODate()}`:ot}toISOTime(e){return this.isValid?`${this.s.toISOTime(e)}/${this.e.toISOTime(e)}`:ot}toFormat(e,{separator:n=" – "}={}){return this.isValid?`${this.s.toFormat(e)}${n}${this.e.toFormat(e)}`:ot}toDuration(e,n){return this.isValid?this.e.diff(this.s,e,n):R.invalid(this.invalidReason)}mapEndpoints(e){return z.fromDateTimes(e(this.s),e(this.e))}}class Vt{static hasDST(e=G.defaultZone){const n=N.now().setZone(e).set({month:12});return!e.isUniversal&&n.offset!==n.set({month:6}).offset}static isValidIANAZone(e){return Ie.isValidZone(e)}static normalizeZone(e){return Re(e,G.defaultZone)}static getStartOfWeek({locale:e=null,locObj:n=null}={}){return(n||W.create(e)).getStartOfWeek()}static getMinimumDaysInFirstWeek({locale:e=null,locObj:n=null}={}){return(n||W.create(e)).getMinDaysInFirstWeek()}static getWeekendWeekdays({locale:e=null,locObj:n=null}={}){return(n||W.create(e)).getWeekendDays().slice()}static months(e="long",{locale:n=null,numberingSystem:a=null,locObj:r=null,outputCalendar:i="gregory"}={}){return(r||W.create(n,a,i)).months(e)}static monthsFormat(e="long",{locale:n=null,numberingSystem:a=null,locObj:r=null,outputCalendar:i="gregory"}={}){return(r||W.create(n,a,i)).months(e,!0)}static weekdays(e="long",{locale:n=null,numberingSystem:a=null,locObj:r=null}={}){return(r||W.create(n,a,null)).weekdays(e)}static weekdaysFormat(e="long",{locale:n=null,numberingSystem:a=null,locObj:r=null}={}){return(r||W.create(n,a,null)).weekdays(e,!0)}static meridiems({locale:e=null}={}){return W.create(e).meridiems()}static eras(e="short",{locale:n=null}={}){return W.create(n,null,"gregory").eras(e)}static features(){return{relative:zr(),localeWeek:Gr()}}}function Ga(t,e){const n=r=>r.toUTC(0,{keepLocalTime:!0}).startOf("day").valueOf(),a=n(e)-n(t);return Math.floor(R.fromMillis(a).as("days"))}function bs(t,e,n){const a=[["years",(c,u)=>u.year-c.year],["quarters",(c,u)=>u.quarter-c.quarter+(u.year-c.year)*4],["months",(c,u)=>u.month-c.month+(u.year-c.year)*12],["weeks",(c,u)=>{const d=Ga(c,u);return(d-d%7)/7}],["days",Ga]],r={},i=t;let s,l;for(const[c,u]of a)n.indexOf(c)>=0&&(s=c,r[c]=u(t,e),l=i.plus(r),l>e?(r[c]--,t=i.plus(r),t>e&&(l=t,r[c]--,t=i.plus(r))):t=l);return[t,r,l,s]}function _s(t,e,n,a){let[r,i,s,l]=bs(t,e,n);const c=e-r,u=n.filter(h=>["hours","minutes","seconds","milliseconds"].indexOf(h)>=0);u.length===0&&(s<e&&(s=r.plus({[l]:1})),s!==r&&(i[l]=(i[l]||0)+c/(s-r)));const d=R.fromObject(i,a);return u.length>0?R.fromMillis(c,a).shiftTo(...u).plus(d):d}const ks="missing Intl.DateTimeFormat.formatToParts support";function B(t,e=n=>n){return{regex:t,deser:([n])=>e(po(n))}}const Ts=" ",li=`[ ${Ts}]`,ci=new RegExp(li,"g");function As(t){return t.replace(/\./g,"\\.?").replace(ci,li)}function Va(t){return t.replace(/\./g,"").replace(ci," ").toLowerCase()}function ge(t,e){return t===null?null:{regex:RegExp(t.map(As).join("|")),deser:([n])=>t.findIndex(a=>Va(n)===Va(a))+e}}function Za(t,e){return{regex:t,deser:([,n,a])=>yn(n,a),groups:e}}function Zt(t){return{regex:t,deser:([e])=>e}}function Cs(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function Is(t,e){const n=fe(e),a=fe(e,"{2}"),r=fe(e,"{3}"),i=fe(e,"{4}"),s=fe(e,"{6}"),l=fe(e,"{1,2}"),c=fe(e,"{1,3}"),u=fe(e,"{1,6}"),d=fe(e,"{1,9}"),h=fe(e,"{2,4}"),p=fe(e,"{4,6}"),f=w=>({regex:RegExp(Cs(w.val)),deser:([S])=>S,literal:!0}),v=(w=>{if(t.literal)return f(w);switch(w.val){case"G":return ge(e.eras("short"),0);case"GG":return ge(e.eras("long"),0);case"y":return B(u);case"yy":return B(h,Yn);case"yyyy":return B(i);case"yyyyy":return B(p);case"yyyyyy":return B(s);case"M":return B(l);case"MM":return B(a);case"MMM":return ge(e.months("short",!0),1);case"MMMM":return ge(e.months("long",!0),1);case"L":return B(l);case"LL":return B(a);case"LLL":return ge(e.months("short",!1),1);case"LLLL":return ge(e.months("long",!1),1);case"d":return B(l);case"dd":return B(a);case"o":return B(c);case"ooo":return B(r);case"HH":return B(a);case"H":return B(l);case"hh":return B(a);case"h":return B(l);case"mm":return B(a);case"m":return B(l);case"q":return B(l);case"qq":return B(a);case"s":return B(l);case"ss":return B(a);case"S":return B(c);case"SSS":return B(r);case"u":return Zt(d);case"uu":return Zt(l);case"uuu":return B(n);case"a":return ge(e.meridiems(),0);case"kkkk":return B(i);case"kk":return B(h,Yn);case"W":return B(l);case"WW":return B(a);case"E":case"c":return B(n);case"EEE":return ge(e.weekdays("short",!1),1);case"EEEE":return ge(e.weekdays("long",!1),1);case"ccc":return ge(e.weekdays("short",!0),1);case"cccc":return ge(e.weekdays("long",!0),1);case"Z":case"ZZ":return Za(new RegExp(`([+-]${l.source})(?::(${a.source}))?`),2);case"ZZZ":return Za(new RegExp(`([+-]${l.source})(${a.source})?`),2);case"z":return Zt(/[a-z_+-/]{1,256}?/i);case" ":return Zt(/[^\S\n\r]/);default:return f(w)}})(t)||{invalidReason:ks};return v.token=t,v}const Ns={year:{"2-digit":"yy",numeric:"yyyyy"},month:{numeric:"M","2-digit":"MM",short:"MMM",long:"MMMM"},day:{numeric:"d","2-digit":"dd"},weekday:{short:"EEE",long:"EEEE"},dayperiod:"a",dayPeriod:"a",hour12:{numeric:"h","2-digit":"hh"},hour24:{numeric:"H","2-digit":"HH"},minute:{numeric:"m","2-digit":"mm"},second:{numeric:"s","2-digit":"ss"},timeZoneName:{long:"ZZZZZ",short:"ZZZ"}};function Ps(t,e,n){const{type:a,value:r}=t;if(a==="literal"){const c=/^\s+$/.test(r);return{literal:!c,val:c?" ":r}}const i=e[a];let s=a;a==="hour"&&(e.hour12!=null?s=e.hour12?"hour12":"hour24":e.hourCycle!=null?e.hourCycle==="h11"||e.hourCycle==="h12"?s="hour12":s="hour24":s=n.hour12?"hour12":"hour24");let l=Ns[s];if(typeof l=="object"&&(l=l[i]),l)return{literal:!1,val:l}}function Ds(t){return[`^${t.map(n=>n.regex).reduce((n,a)=>`${n}(${a.source})`,"")}$`,t]}function xs(t,e,n){const a=t.match(e);if(a){const r={};let i=1;for(const s in n)if(ft(n,s)){const l=n[s],c=l.groups?l.groups+1:1;!l.literal&&l.token&&(r[l.token.val[0]]=l.deser(a.slice(i,i+c))),i+=c}return[a,r]}else return[a,{}]}function Fs(t){const e=i=>{switch(i){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":case"H":return"hour";case"d":return"day";case"o":return"ordinal";case"L":case"M":return"month";case"y":return"year";case"E":case"c":return"weekday";case"W":return"weekNumber";case"k":return"weekYear";case"q":return"quarter";default:return null}};let n=null,a;return x(t.z)||(n=Ie.create(t.z)),x(t.Z)||(n||(n=new ne(t.Z)),a=t.Z),x(t.q)||(t.M=(t.q-1)*3+1),x(t.h)||(t.h<12&&t.a===1?t.h+=12:t.h===12&&t.a===0&&(t.h=0)),t.G===0&&t.y&&(t.y=-t.y),x(t.u)||(t.S=ua(t.u)),[Object.keys(t).reduce((i,s)=>{const l=e(s);return l&&(i[l]=t[s]),i},{}),n,a]}let Cn=null;function $s(){return Cn||(Cn=N.fromMillis(1555555555555)),Cn}function Os(t,e){if(t.literal)return t;const n=ee.macroTokenToFormatOpts(t.val),a=hi(n,e);return a==null||a.includes(void 0)?t:a}function ui(t,e){return Array.prototype.concat(...t.map(n=>Os(n,e)))}class di{constructor(e,n){if(this.locale=e,this.format=n,this.tokens=ui(ee.parseFormat(n),e),this.units=this.tokens.map(a=>Is(a,e)),this.disqualifyingUnit=this.units.find(a=>a.invalidReason),!this.disqualifyingUnit){const[a,r]=Ds(this.units);this.regex=RegExp(a,"i"),this.handlers=r}}explainFromTokens(e){if(this.isValid){const[n,a]=xs(e,this.regex,this.handlers),[r,i,s]=a?Fs(a):[null,null,void 0];if(ft(a,"a")&&ft(a,"H"))throw new ct("Can't include meridiem when specifying 24-hour format");return{input:e,tokens:this.tokens,regex:this.regex,rawMatches:n,matches:a,result:r,zone:i,specificOffset:s}}else return{input:e,tokens:this.tokens,invalidReason:this.invalidReason}}get isValid(){return!this.disqualifyingUnit}get invalidReason(){return this.disqualifyingUnit?this.disqualifyingUnit.invalidReason:null}}function mi(t,e,n){return new di(t,n).explainFromTokens(e)}function Rs(t,e,n){const{result:a,zone:r,specificOffset:i,invalidReason:s}=mi(t,e,n);return[a,r,i,s]}function hi(t,e){if(!t)return null;const a=ee.create(e,t).dtFormatter($s()),r=a.formatToParts(),i=a.resolvedOptions();return r.map(s=>Ps(s,t,i))}const In="Invalid DateTime",Ja=864e13;function kt(t){return new we("unsupported zone",`the zone "${t.name}" is not supported`)}function Nn(t){return t.weekData===null&&(t.weekData=ln(t.c)),t.weekData}function Pn(t){return t.localWeekData===null&&(t.localWeekData=ln(t.c,t.loc.getMinDaysInFirstWeek(),t.loc.getStartOfWeek())),t.localWeekData}function Ze(t,e){const n={ts:t.ts,zone:t.zone,c:t.c,o:t.o,loc:t.loc,invalid:t.invalid};return new N({...n,...e,old:n})}function fi(t,e,n){let a=t-e*60*1e3;const r=n.offset(a);if(e===r)return[a,e];a-=(r-e)*60*1e3;const i=n.offset(a);return r===i?[a,r]:[t-Math.min(r,i)*60*1e3,Math.max(r,i)]}function Jt(t,e){t+=e*60*1e3;const n=new Date(t);return{year:n.getUTCFullYear(),month:n.getUTCMonth()+1,day:n.getUTCDate(),hour:n.getUTCHours(),minute:n.getUTCMinutes(),second:n.getUTCSeconds(),millisecond:n.getUTCMilliseconds()}}function tn(t,e,n){return fi(pn(t),e,n)}function ja(t,e){const n=t.o,a=t.c.year+Math.trunc(e.years),r=t.c.month+Math.trunc(e.months)+Math.trunc(e.quarters)*3,i={...t.c,year:a,month:r,day:Math.min(t.c.day,cn(a,r))+Math.trunc(e.days)+Math.trunc(e.weeks)*7},s=R.fromObject({years:e.years-Math.trunc(e.years),quarters:e.quarters-Math.trunc(e.quarters),months:e.months-Math.trunc(e.months),weeks:e.weeks-Math.trunc(e.weeks),days:e.days-Math.trunc(e.days),hours:e.hours,minutes:e.minutes,seconds:e.seconds,milliseconds:e.milliseconds}).as("milliseconds"),l=pn(i);let[c,u]=fi(l,n,t.zone);return s!==0&&(c+=s,u=t.zone.offset(c)),{ts:c,o:u}}function st(t,e,n,a,r,i){const{setZone:s,zone:l}=n;if(t&&Object.keys(t).length!==0||e){const c=e||l,u=N.fromObject(t,{...n,zone:c,specificOffset:i});return s?u:u.setZone(l)}else return N.invalid(new we("unparsable",`the input "${r}" can't be parsed as ${a}`))}function jt(t,e,n=!0){return t.isValid?ee.create(W.create("en-US"),{allowZ:n,forceSimple:!0}).formatDateTimeFromString(t,e):null}function Dn(t,e,n){const a=t.c.year>9999||t.c.year<0;let r="";if(a&&t.c.year>=0&&(r+="+"),r+=Z(t.c.year,a?6:4),n==="year")return r;if(e){if(r+="-",r+=Z(t.c.month),n==="month")return r;r+="-"}else if(r+=Z(t.c.month),n==="month")return r;return r+=Z(t.c.day),r}function qa(t,e,n,a,r,i,s){let l=!n||t.c.millisecond!==0||t.c.second!==0,c="";switch(s){case"day":case"month":case"year":break;default:if(c+=Z(t.c.hour),s==="hour")break;if(e){if(c+=":",c+=Z(t.c.minute),s==="minute")break;l&&(c+=":",c+=Z(t.c.second))}else{if(c+=Z(t.c.minute),s==="minute")break;l&&(c+=Z(t.c.second))}if(s==="second")break;l&&(!a||t.c.millisecond!==0)&&(c+=".",c+=Z(t.c.millisecond,3))}return r&&(t.isOffsetFixed&&t.offset===0&&!i?c+="Z":t.o<0?(c+="-",c+=Z(Math.trunc(-t.o/60)),c+=":",c+=Z(Math.trunc(-t.o%60))):(c+="+",c+=Z(Math.trunc(t.o/60)),c+=":",c+=Z(Math.trunc(t.o%60)))),i&&(c+="["+t.zone.ianaName+"]"),c}const gi={month:1,day:1,hour:0,minute:0,second:0,millisecond:0},Us={weekNumber:1,weekday:1,hour:0,minute:0,second:0,millisecond:0},Hs={ordinal:1,hour:0,minute:0,second:0,millisecond:0},nn=["year","month","day","hour","minute","second","millisecond"],Bs=["weekYear","weekNumber","weekday","hour","minute","second","millisecond"],Ws=["year","ordinal","hour","minute","second","millisecond"];function an(t){const e={year:"year",years:"year",month:"month",months:"month",day:"day",days:"day",hour:"hour",hours:"hour",minute:"minute",minutes:"minute",quarter:"quarter",quarters:"quarter",second:"second",seconds:"second",millisecond:"millisecond",milliseconds:"millisecond",weekday:"weekday",weekdays:"weekday",weeknumber:"weekNumber",weeksnumber:"weekNumber",weeknumbers:"weekNumber",weekyear:"weekYear",weekyears:"weekYear",ordinal:"ordinal"}[t.toLowerCase()];if(!e)throw new gr(t);return e}function Ka(t){switch(t.toLowerCase()){case"localweekday":case"localweekdays":return"localWeekday";case"localweeknumber":case"localweeknumbers":return"localWeekNumber";case"localweekyear":case"localweekyears":return"localWeekYear";default:return an(t)}}function zs(t){if(Tt===void 0&&(Tt=G.now()),t.type!=="iana")return t.offset(Tt);const e=t.name;let n=Xn.get(e);return n===void 0&&(n=t.offset(Tt),Xn.set(e,n)),n}function Ya(t,e){const n=Re(e.zone,G.defaultZone);if(!n.isValid)return N.invalid(kt(n));const a=W.fromObject(e);let r,i;if(x(t.year))r=G.now();else{for(const c of nn)x(t[c])&&(t[c]=gi[c]);const s=Br(t)||Wr(t);if(s)return N.invalid(s);const l=zs(n);[r,i]=tn(t,l,n)}return new N({ts:r,zone:n,loc:a,o:i})}function Xa(t,e,n){const a=x(n.round)?!0:n.round,r=x(n.rounding)?"trunc":n.rounding,i=(l,c)=>(l=da(l,a||n.calendary?0:2,n.calendary?"round":r),e.loc.clone(n).relFormatter(n).format(l,c)),s=l=>n.calendary?e.hasSame(t,l)?0:e.startOf(l).diff(t.startOf(l),l).get(l):e.diff(t,l).get(l);if(n.unit)return i(s(n.unit),n.unit);for(const l of n.units){const c=s(l);if(Math.abs(c)>=1)return i(c,l)}return i(t>e?-0:0,n.units[n.units.length-1])}function Qa(t){let e={},n;return t.length>0&&typeof t[t.length-1]=="object"?(e=t[t.length-1],n=Array.from(t).slice(0,t.length-1)):n=Array.from(t),[e,n]}let Tt;const Xn=new Map;class N{constructor(e){const n=e.zone||G.defaultZone;let a=e.invalid||(Number.isNaN(e.ts)?new we("invalid input"):null)||(n.isValid?null:kt(n));this.ts=x(e.ts)?G.now():e.ts;let r=null,i=null;if(!a)if(e.old&&e.old.ts===this.ts&&e.old.zone.equals(n))[r,i]=[e.old.c,e.old.o];else{const l=Be(e.o)&&!e.old?e.o:n.offset(this.ts);r=Jt(this.ts,l),a=Number.isNaN(r.year)?new we("invalid input"):null,r=a?null:r,i=a?null:l}this._zone=n,this.loc=e.loc||W.create(),this.invalid=a,this.weekData=null,this.localWeekData=null,this.c=r,this.o=i,this.isLuxonDateTime=!0}static now(){return new N({})}static local(){const[e,n]=Qa(arguments),[a,r,i,s,l,c,u]=n;return Ya({year:a,month:r,day:i,hour:s,minute:l,second:c,millisecond:u},e)}static utc(){const[e,n]=Qa(arguments),[a,r,i,s,l,c,u]=n;return e.zone=ne.utcInstance,Ya({year:a,month:r,day:i,hour:s,minute:l,second:c,millisecond:u},e)}static fromJSDate(e,n={}){const a=Mo(e)?e.valueOf():NaN;if(Number.isNaN(a))return N.invalid("invalid input");const r=Re(n.zone,G.defaultZone);return r.isValid?new N({ts:a,zone:r,loc:W.fromObject(n)}):N.invalid(kt(r))}static fromMillis(e,n={}){if(Be(e))return e<-Ja||e>Ja?N.invalid("Timestamp out of range"):new N({ts:e,zone:Re(n.zone,G.defaultZone),loc:W.fromObject(n)});throw new X(`fromMillis requires a numerical input, but received a ${typeof e} with value ${e}`)}static fromSeconds(e,n={}){if(Be(e))return new N({ts:e*1e3,zone:Re(n.zone,G.defaultZone),loc:W.fromObject(n)});throw new X("fromSeconds requires a numerical input")}static fromObject(e,n={}){e=e||{};const a=Re(n.zone,G.defaultZone);if(!a.isValid)return N.invalid(kt(a));const r=W.fromObject(n),i=un(e,Ka),{minDaysInFirstWeek:s,startOfWeek:l}=$a(i,r),c=G.now(),u=x(n.specificOffset)?a.offset(c):n.specificOffset,d=!x(i.ordinal),h=!x(i.year),p=!x(i.month)||!x(i.day),f=h||p,y=i.weekYear||i.weekNumber;if((f||d)&&y)throw new ct("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(p&&d)throw new ct("Can't mix ordinal dates with month/day");const v=y||i.weekday&&!f;let w,S,M=Jt(c,u);v?(w=Bs,S=Us,M=ln(M,s,l)):d?(w=Ws,S=Hs,M=An(M)):(w=nn,S=gi);let _=!1;for(const I of w){const D=i[I];x(D)?_?i[I]=S[I]:i[I]=M[I]:_=!0}const E=v?wo(i,s,l):d?vo(i):Br(i),b=E||Wr(i);if(b)return N.invalid(b);const T=v?xa(i,s,l):d?Fa(i):i,[k,A]=tn(T,u,a),P=new N({ts:k,zone:a,o:A,loc:r});return i.weekday&&f&&e.weekday!==P.weekday?N.invalid("mismatched weekday",`you can't specify both a weekday of ${i.weekday} and a date of ${P.toISO()}`):P.isValid?P:N.invalid(P.invalid)}static fromISO(e,n={}){const[a,r]=us(e);return st(a,r,n,"ISO 8601",e)}static fromRFC2822(e,n={}){const[a,r]=ds(e);return st(a,r,n,"RFC 2822",e)}static fromHTTP(e,n={}){const[a,r]=ms(e);return st(a,r,n,"HTTP",n)}static fromFormat(e,n,a={}){if(x(e)||x(n))throw new X("fromFormat requires an input string and a format");const{locale:r=null,numberingSystem:i=null}=a,s=W.fromOpts({locale:r,numberingSystem:i,defaultToEN:!0}),[l,c,u,d]=Rs(s,e,n);return d?N.invalid(d):st(l,c,a,`format ${n}`,e,u)}static fromString(e,n,a={}){return N.fromFormat(e,n,a)}static fromSQL(e,n={}){const[a,r]=vs(e);return st(a,r,n,"SQL",e)}static invalid(e,n=null){if(!e)throw new X("need to specify a reason the DateTime is invalid");const a=e instanceof we?e:new we(e,n);if(G.throwOnInvalid)throw new Vi(a);return new N({invalid:a})}static isDateTime(e){return e&&e.isLuxonDateTime||!1}static parseFormatForOpts(e,n={}){const a=hi(e,W.fromObject(n));return a?a.map(r=>r?r.val:null).join(""):null}static expandFormat(e,n={}){return ui(ee.parseFormat(e),W.fromObject(n)).map(r=>r.val).join("")}static resetCache(){Tt=void 0,Xn.clear()}get(e){return this[e]}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}get outputCalendar(){return this.isValid?this.loc.outputCalendar:null}get zone(){return this._zone}get zoneName(){return this.isValid?this.zone.name:null}get year(){return this.isValid?this.c.year:NaN}get quarter(){return this.isValid?Math.ceil(this.c.month/3):NaN}get month(){return this.isValid?this.c.month:NaN}get day(){return this.isValid?this.c.day:NaN}get hour(){return this.isValid?this.c.hour:NaN}get minute(){return this.isValid?this.c.minute:NaN}get second(){return this.isValid?this.c.second:NaN}get millisecond(){return this.isValid?this.c.millisecond:NaN}get weekYear(){return this.isValid?Nn(this).weekYear:NaN}get weekNumber(){return this.isValid?Nn(this).weekNumber:NaN}get weekday(){return this.isValid?Nn(this).weekday:NaN}get isWeekend(){return this.isValid&&this.loc.getWeekendDays().includes(this.weekday)}get localWeekday(){return this.isValid?Pn(this).weekday:NaN}get localWeekNumber(){return this.isValid?Pn(this).weekNumber:NaN}get localWeekYear(){return this.isValid?Pn(this).weekYear:NaN}get ordinal(){return this.isValid?An(this.c).ordinal:NaN}get monthShort(){return this.isValid?Vt.months("short",{locObj:this.loc})[this.month-1]:null}get monthLong(){return this.isValid?Vt.months("long",{locObj:this.loc})[this.month-1]:null}get weekdayShort(){return this.isValid?Vt.weekdays("short",{locObj:this.loc})[this.weekday-1]:null}get weekdayLong(){return this.isValid?Vt.weekdays("long",{locObj:this.loc})[this.weekday-1]:null}get offset(){return this.isValid?+this.o:NaN}get offsetNameShort(){return this.isValid?this.zone.offsetName(this.ts,{format:"short",locale:this.locale}):null}get offsetNameLong(){return this.isValid?this.zone.offsetName(this.ts,{format:"long",locale:this.locale}):null}get isOffsetFixed(){return this.isValid?this.zone.isUniversal:null}get isInDST(){return this.isOffsetFixed?!1:this.offset>this.set({month:1,day:1}).offset||this.offset>this.set({month:5}).offset}getPossibleOffsets(){if(!this.isValid||this.isOffsetFixed)return[this];const e=864e5,n=6e4,a=pn(this.c),r=this.zone.offset(a-e),i=this.zone.offset(a+e),s=this.zone.offset(a-r*n),l=this.zone.offset(a-i*n);if(s===l)return[this];const c=a-s*n,u=a-l*n,d=Jt(c,s),h=Jt(u,l);return d.hour===h.hour&&d.minute===h.minute&&d.second===h.second&&d.millisecond===h.millisecond?[Ze(this,{ts:c}),Ze(this,{ts:u})]:[this]}get isInLeapYear(){return Rt(this.year)}get daysInMonth(){return cn(this.year,this.month)}get daysInYear(){return this.isValid?dt(this.year):NaN}get weeksInWeekYear(){return this.isValid?xt(this.weekYear):NaN}get weeksInLocalWeekYear(){return this.isValid?xt(this.localWeekYear,this.loc.getMinDaysInFirstWeek(),this.loc.getStartOfWeek()):NaN}resolvedLocaleOptions(e={}){const{locale:n,numberingSystem:a,calendar:r}=ee.create(this.loc.clone(e),e).resolvedOptions(this);return{locale:n,numberingSystem:a,outputCalendar:r}}toUTC(e=0,n={}){return this.setZone(ne.instance(e),n)}toLocal(){return this.setZone(G.defaultZone)}setZone(e,{keepLocalTime:n=!1,keepCalendarTime:a=!1}={}){if(e=Re(e,G.defaultZone),e.equals(this.zone))return this;if(e.isValid){let r=this.ts;if(n||a){const i=e.offset(this.ts),s=this.toObject();[r]=tn(s,i,e)}return Ze(this,{ts:r,zone:e})}else return N.invalid(kt(e))}reconfigure({locale:e,numberingSystem:n,outputCalendar:a}={}){const r=this.loc.clone({locale:e,numberingSystem:n,outputCalendar:a});return Ze(this,{loc:r})}setLocale(e){return this.reconfigure({locale:e})}set(e){if(!this.isValid)return this;const n=un(e,Ka),{minDaysInFirstWeek:a,startOfWeek:r}=$a(n,this.loc),i=!x(n.weekYear)||!x(n.weekNumber)||!x(n.weekday),s=!x(n.ordinal),l=!x(n.year),c=!x(n.month)||!x(n.day),u=l||c,d=n.weekYear||n.weekNumber;if((u||s)&&d)throw new ct("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(c&&s)throw new ct("Can't mix ordinal dates with month/day");let h;i?h=xa({...ln(this.c,a,r),...n},a,r):x(n.ordinal)?(h={...this.toObject(),...n},x(n.day)&&(h.day=Math.min(cn(h.year,h.month),h.day))):h=Fa({...An(this.c),...n});const[p,f]=tn(h,this.o,this.zone);return Ze(this,{ts:p,o:f})}plus(e){if(!this.isValid)return this;const n=R.fromDurationLike(e);return Ze(this,ja(this,n))}minus(e){if(!this.isValid)return this;const n=R.fromDurationLike(e).negate();return Ze(this,ja(this,n))}startOf(e,{useLocaleWeeks:n=!1}={}){if(!this.isValid)return this;const a={},r=R.normalizeUnit(e);switch(r){case"years":a.month=1;case"quarters":case"months":a.day=1;case"weeks":case"days":a.hour=0;case"hours":a.minute=0;case"minutes":a.second=0;case"seconds":a.millisecond=0;break}if(r==="weeks")if(n){const i=this.loc.getStartOfWeek(),{weekday:s}=this;s<i&&(a.weekNumber=this.weekNumber-1),a.weekday=i}else a.weekday=1;if(r==="quarters"){const i=Math.ceil(this.month/3);a.month=(i-1)*3+1}return this.set(a)}endOf(e,n){return this.isValid?this.plus({[e]:1}).startOf(e,n).minus(1):this}toFormat(e,n={}){return this.isValid?ee.create(this.loc.redefaultToEN(n)).formatDateTimeFromString(this,e):In}toLocaleString(e=sn,n={}){return this.isValid?ee.create(this.loc.clone(n),e).formatDateTime(this):In}toLocaleParts(e={}){return this.isValid?ee.create(this.loc.clone(e),e).formatDateTimeParts(this):[]}toISO({format:e="extended",suppressSeconds:n=!1,suppressMilliseconds:a=!1,includeOffset:r=!0,extendedZone:i=!1,precision:s="milliseconds"}={}){if(!this.isValid)return null;s=an(s);const l=e==="extended";let c=Dn(this,l,s);return nn.indexOf(s)>=3&&(c+="T"),c+=qa(this,l,n,a,r,i,s),c}toISODate({format:e="extended",precision:n="day"}={}){return this.isValid?Dn(this,e==="extended",an(n)):null}toISOWeekDate(){return jt(this,"kkkk-'W'WW-c")}toISOTime({suppressMilliseconds:e=!1,suppressSeconds:n=!1,includeOffset:a=!0,includePrefix:r=!1,extendedZone:i=!1,format:s="extended",precision:l="milliseconds"}={}){return this.isValid?(l=an(l),(r&&nn.indexOf(l)>=3?"T":"")+qa(this,s==="extended",n,e,a,i,l)):null}toRFC2822(){return jt(this,"EEE, dd LLL yyyy HH:mm:ss ZZZ",!1)}toHTTP(){return jt(this.toUTC(),"EEE, dd LLL yyyy HH:mm:ss 'GMT'")}toSQLDate(){return this.isValid?Dn(this,!0):null}toSQLTime({includeOffset:e=!0,includeZone:n=!1,includeOffsetSpace:a=!0}={}){let r="HH:mm:ss.SSS";return(n||e)&&(a&&(r+=" "),n?r+="z":e&&(r+="ZZ")),jt(this,r,!0)}toSQL(e={}){return this.isValid?`${this.toSQLDate()} ${this.toSQLTime(e)}`:null}toString(){return this.isValid?this.toISO():In}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`DateTime { ts: ${this.toISO()}, zone: ${this.zone.name}, locale: ${this.locale} }`:`DateTime { Invalid, reason: ${this.invalidReason} }`}valueOf(){return this.toMillis()}toMillis(){return this.isValid?this.ts:NaN}toSeconds(){return this.isValid?this.ts/1e3:NaN}toUnixInteger(){return this.isValid?Math.floor(this.ts/1e3):NaN}toJSON(){return this.toISO()}toBSON(){return this.toJSDate()}toObject(e={}){if(!this.isValid)return{};const n={...this.c};return e.includeConfig&&(n.outputCalendar=this.outputCalendar,n.numberingSystem=this.loc.numberingSystem,n.locale=this.loc.locale),n}toJSDate(){return new Date(this.isValid?this.ts:NaN)}diff(e,n="milliseconds",a={}){if(!this.isValid||!e.isValid)return R.invalid("created by diffing an invalid DateTime");const r={locale:this.locale,numberingSystem:this.numberingSystem,...a},i=So(n).map(R.normalizeUnit),s=e.valueOf()>this.valueOf(),l=s?this:e,c=s?e:this,u=_s(l,c,i,r);return s?u.negate():u}diffNow(e="milliseconds",n={}){return this.diff(N.now(),e,n)}until(e){return this.isValid?z.fromDateTimes(this,e):this}hasSame(e,n,a){if(!this.isValid)return!1;const r=e.valueOf(),i=this.setZone(e.zone,{keepLocalTime:!0});return i.startOf(n,a)<=r&&r<=i.endOf(n,a)}equals(e){return this.isValid&&e.isValid&&this.valueOf()===e.valueOf()&&this.zone.equals(e.zone)&&this.loc.equals(e.loc)}toRelative(e={}){if(!this.isValid)return null;const n=e.base||N.fromObject({},{zone:this.zone}),a=e.padding?this<n?-e.padding:e.padding:0;let r=["years","months","days","hours","minutes","seconds"],i=e.unit;return Array.isArray(e.unit)&&(r=e.unit,i=void 0),Xa(n,this.plus(a),{...e,numeric:"always",units:r,unit:i})}toRelativeCalendar(e={}){return this.isValid?Xa(e.base||N.fromObject({},{zone:this.zone}),this,{...e,numeric:"auto",units:["years","months","days"],calendary:!0}):null}static min(...e){if(!e.every(N.isDateTime))throw new X("min requires all arguments be DateTimes");return Oa(e,n=>n.valueOf(),Math.min)}static max(...e){if(!e.every(N.isDateTime))throw new X("max requires all arguments be DateTimes");return Oa(e,n=>n.valueOf(),Math.max)}static fromFormatExplain(e,n,a={}){const{locale:r=null,numberingSystem:i=null}=a,s=W.fromOpts({locale:r,numberingSystem:i,defaultToEN:!0});return mi(s,e,n)}static fromStringExplain(e,n,a={}){return N.fromFormatExplain(e,n,a)}static buildFormatParser(e,n={}){const{locale:a=null,numberingSystem:r=null}=n,i=W.fromOpts({locale:a,numberingSystem:r,defaultToEN:!0});return new di(i,e)}static fromFormatParser(e,n,a={}){if(x(e)||x(n))throw new X("fromFormatParser requires an input string and a format parser");const{locale:r=null,numberingSystem:i=null}=a,s=W.fromOpts({locale:r,numberingSystem:i,defaultToEN:!0});if(!s.equals(n.locale))throw new X(`fromFormatParser called with a locale of ${s}, but the format parser was created for ${n.locale}`);const{result:l,zone:c,specificOffset:u,invalidReason:d}=n.explainFromTokens(e);return d?N.invalid(d):st(l,c,a,`format ${n.format}`,e,u)}static get DATE_SHORT(){return sn}static get DATE_MED(){return pr}static get DATE_MED_WITH_WEEKDAY(){return ji}static get DATE_FULL(){return yr}static get DATE_HUGE(){return wr}static get TIME_SIMPLE(){return vr}static get TIME_WITH_SECONDS(){return Lr}static get TIME_WITH_SHORT_OFFSET(){return Mr}static get TIME_WITH_LONG_OFFSET(){return Sr}static get TIME_24_SIMPLE(){return Er}static get TIME_24_WITH_SECONDS(){return br}static get TIME_24_WITH_SHORT_OFFSET(){return _r}static get TIME_24_WITH_LONG_OFFSET(){return kr}static get DATETIME_SHORT(){return Tr}static get DATETIME_SHORT_WITH_SECONDS(){return Ar}static get DATETIME_MED(){return Cr}static get DATETIME_MED_WITH_SECONDS(){return Ir}static get DATETIME_MED_WITH_WEEKDAY(){return qi}static get DATETIME_FULL(){return Nr}static get DATETIME_FULL_WITH_SECONDS(){return Pr}static get DATETIME_HUGE(){return Dr}static get DATETIME_HUGE_WITH_SECONDS(){return xr}}function bt(t){if(N.isDateTime(t))return t;if(t&&t.valueOf&&Be(t.valueOf()))return N.fromJSDate(t);if(t&&typeof t=="object")return N.fromObject(t);throw new X(`Unknown datetime argument: ${t}, of type ${typeof t}`)}const ut=65,ae=73,ue=79;function pi(t,e){if(e=typeof e=="number"?e:5,!Array.isArray(t))throw new TypeError("forward did not receive an array");if(typeof t[0]=="string"||typeof t[1]=="string")throw new TypeError("forward received an array of strings, but it only accepts an array of numbers.");const[n,a]=t;if(n<-180||n>180)throw new TypeError("forward received an invalid longitude of "+n);if(a<-90||a>90)throw new TypeError("forward received an invalid latitude of "+a);if(a<-80||a>84)throw new TypeError(`forward received a latitude of ${a}, but this library does not support conversions of points in polar regions below 80°S and above 84°N`);return function(r,i){const s="00000"+r.easting,l="00000"+r.northing;return r.zoneNumber+r.zoneLetter+function(c,u,d){const h=wi(d),p=Math.floor(c/1e5),f=Math.floor(u/1e5)%20;return function(y,v,w){const S=w-1,M="AJSAJS".charCodeAt(S),_="AFAFAF".charCodeAt(S);let E=M+y-1,b=_+v,T=!1;return E>90&&(E=E-90+ut-1,T=!0),(E===ae||M<ae&&E>ae||(E>ae||M<ae)&&T)&&E++,(E===ue||M<ue&&E>ue||(E>ue||M<ue)&&T)&&(E++,E===ae&&E++),E>90&&(E=E-90+ut-1),b>86?(b=b-86+ut-1,T=!0):T=!1,(b===ae||_<ae&&b>ae||(b>ae||_<ae)&&T)&&b++,(b===ue||_<ue&&b>ue||(b>ue||_<ue)&&T)&&(b++,b===ae&&b++),b>86&&(b=b-86+ut-1),String.fromCharCode(E)+String.fromCharCode(b)}(p,f,h)}(r.easting,r.northing,r.zoneNumber)+s.substr(s.length-5,i)+l.substr(l.length-5,i)}(function(r){const i=r.lat,s=r.lon,l=6378137,c=xn(i),u=xn(s);let d;d=Math.floor((s+180)/6)+1,s===180&&(d=60),i>=56&&i<64&&s>=3&&s<12&&(d=32),i>=72&&i<84&&(s>=0&&s<9?d=31:s>=9&&s<21?d=33:s>=21&&s<33?d=35:s>=33&&s<42&&(d=37));const h=xn(6*(d-1)-180+3),p=l/Math.sqrt(1-.00669438*Math.sin(c)*Math.sin(c)),f=Math.tan(c)*Math.tan(c),y=.006739496752268451*Math.cos(c)*Math.cos(c),v=Math.cos(c)*(u-h),w=l*(.9983242984503243*c-.002514607064228144*Math.sin(2*c)+2639046602129982e-21*Math.sin(4*c)-3418046101696858e-24*Math.sin(6*c)),S=.9996*p*(v+(1-f+y)*v*v*v/6+(5-18*f+f*f+72*y-.39089081163157013)*v*v*v*v*v/120)+5e5;let M=.9996*(w+p*Math.tan(c)*(v*v/2+(5-f+9*y+4*y*y)*v*v*v*v/24+(61-58*f+f*f+600*y-2.2240339282485886)*v*v*v*v*v*v/720));return i<0&&(M+=1e7),{northing:Math.trunc(M),easting:Math.trunc(S),zoneNumber:d,zoneLetter:yi(i)}}({lat:a,lon:n}),e)}function Gs(t){const e=pa(vi(t.toUpperCase()));return typeof e.lat=="number"&&typeof e.lon=="number"?[e.lon,e.lat,e.lon,e.lat]:[e.left,e.bottom,e.right,e.top]}function ga(t){if(t==="")throw new TypeError("toPoint received a blank string");const e=pa(vi(t.toUpperCase()));return typeof e.lat=="number"&&typeof e.lon=="number"?[e.lon,e.lat]:[(e.left+e.right)/2,(e.top+e.bottom)/2]}function xn(t){return t*(Math.PI/180)}function er(t){return t/Math.PI*180}function pa(t){const e=t.northing,n=t.easting,{zoneLetter:a,zoneNumber:r}=t;if(r<0||r>60)return null;const i=6378137,s=(1-Math.sqrt(.99330562))/(1+Math.sqrt(.99330562)),l=n-5e5;let c=e;a<"N"&&(c-=1e7);const u=6*(r-1)-180+3,d=c/.9996/6367449145945056e-9,h=d+(3*s/2-27*s*s*s/32)*Math.sin(2*d)+(21*s*s/16-55*s*s*s*s/32)*Math.sin(4*d)+151*s*s*s/96*Math.sin(6*d),p=i/Math.sqrt(1-.00669438*Math.sin(h)*Math.sin(h)),f=Math.tan(h)*Math.tan(h),y=.006739496752268451*Math.cos(h)*Math.cos(h),v=.99330562*i/Math.pow(1-.00669438*Math.sin(h)*Math.sin(h),1.5),w=l/(.9996*p);let S=h-p*Math.tan(h)/v*(w*w/2-(5+3*f+10*y-4*y*y-.06065547077041606)*w*w*w*w/24+(61+90*f+298*y+45*f*f-1.6983531815716497-3*y*y)*w*w*w*w*w*w/720);S=er(S);let M,_=(w-(1+2*f+y)*w*w*w/6+(5-2*y+28*f-3*y*y+.05391597401814761+24*f*f)*w*w*w*w*w/120)/Math.cos(h);if(_=u+er(_),typeof t.accuracy=="number"){const E=pa({northing:t.northing+t.accuracy,easting:t.easting+t.accuracy,zoneLetter:t.zoneLetter,zoneNumber:t.zoneNumber});M={top:E.lat,right:E.lon,bottom:S,left:_}}else M={lat:S,lon:_};return M}function yi(t){return t<=84&&t>=72?"X":t<72&&t>=-80?"CDEFGHJKLMNPQRSTUVWX"[Math.floor((t- -80)/8)]:t>84||t<-80?"Z":void 0}function wi(t){let e=t%6;return e===0&&(e=6),e}function vi(t){if(t&&t.length===0)throw new TypeError("MGRSPoint coverting from nothing");t=t.replace(/ /g,"");const{length:e}=t;let n,a=null,r="",i=0;for(;!/[A-Z]/.test(n=t.charAt(i));){if(i>=2)throw new Error("MGRSPoint bad conversion from: "+t);r+=n,i++}const s=parseInt(r,10);if(i===0||i+3>e)throw new Error("MGRSPoint bad conversion from "+t);const l=t.charAt(i++);if(l<="A"||l==="B"||l==="Y"||l>="Z"||l==="I"||l==="O")throw new Error(`MGRSPoint zone letter ${l} not handled: ${t}`);a=t.substring(i,i+=2);const c=wi(s),u=function(M,_){let E="AJSAJS".charCodeAt(_-1),b=1e5,T=!1;for(;E!==M.charCodeAt(0);){if(E++,E===ae&&E++,E===ue&&E++,E>90){if(T)throw new Error("Bad character: "+M);E=ut,T=!0}b+=1e5}return b}(a.charAt(0),c);let d=function(M,_){if(M>"V")throw new TypeError("MGRSPoint given invalid Northing "+M);let E="AFAFAF".charCodeAt(_-1),b=0,T=!1;for(;E!==M.charCodeAt(0);){if(E++,E===ae&&E++,E===ue&&E++,E>86){if(T)throw new Error("Bad character: "+M);E=ut,T=!0}b+=1e5}return b}(a.charAt(1),c);for(;d<Vs(l);)d+=2e6;const h=e-i;if(h%2!=0)throw new Error(`MGRSPoint has to have an even number
of digits after the zone letter and two 100km letters - front
half for easting meters, second half for
northing meters `+t);const p=h/2;let f,y,v,w=0,S=0;return p>0&&(f=1e5/Math.pow(10,p),y=t.substring(i,i+p),w=parseFloat(y)*f,v=t.substring(i+p),S=parseFloat(v)*f),{easting:w+u,northing:S+d,zoneLetter:l,zoneNumber:s,accuracy:f}}function Vs(t){let e;switch(t){case"C":e=11e5;break;case"D":e=2e6;break;case"E":e=28e5;break;case"F":e=37e5;break;case"G":e=46e5;break;case"H":e=55e5;break;case"J":e=64e5;break;case"K":e=73e5;break;case"L":e=82e5;break;case"M":e=91e5;break;case"N":e=0;break;case"P":e=8e5;break;case"Q":e=17e5;break;case"R":e=26e5;break;case"S":e=35e5;break;case"T":e=44e5;break;case"U":e=53e5;break;case"V":e=62e5;break;case"W":e=7e6;break;case"X":e=79e5;break;default:e=-1}if(e>=0)return e;throw new TypeError("Invalid zone letter: "+t)}const Zs=Object.freeze(Object.defineProperty({__proto__:null,forward:pi,getLetterDesignator:yi,inverse:Gs,toPoint:ga},Symbol.toStringTag,{value:"Module"})),Js="/icon-48.png",js="/schere_purple.png",qs="/airplane_orange.png",tr={135:5,130:5,125:5,120:5,115:5,110:5,105:5,100:6,95:7,90:7,85:7,80:8,75:8,70:9,65:10,60:10,55:11,50:12,45:14,40:15,35:17,30:20,25:24,20:30,15:40,10:60,5:119},Li={LIST:["icon_seamless","icon_global","icon_eu","icon_d2","ecmwf_ifs025","ecmwf_aifs025_single","gfs_seamless","gfs_global","gfs_hrrr","arome_france","gem_hrdps_continental","gem_regional"],API_MAP:{icon_seamless:"dwd_icon",icon_global:"dwd_icon",icon_eu:"dwd_icon_eu",icon_d2:"dwd_icon_d2",ecmwf_ifs025:"ecmwf_ifs025",ecmwf_aifs025_single:"ecmwf_aifs025_single",gfs_seamless:"ncep_gfs013",gfs_global:"ncep_gfs025",gfs_hrrr:"ncep_hrrr_conus",arome_france:"meteofrance_arome_france0025",gem_hrdps_continental:"cmc_gem_hrdps",gem_regional:"cmc_gem_rdps"}},Q={METERS_TO_FEET:3.28084,FEET_TO_METERS:.3048,KNOTS_TO_MPS:.514444,KNOTS_TO_KMH:1.852,CELSIUS_TO_KELVIN:273.15},nr={MOLAR_MASS_AIR:.0289644,UNIVERSAL_GAS_CONSTANT:8.31446261815324},qe={LAPSE_RATE:.0065,SEA_LEVEL_TEMP_KELVIN:288.15,GRAVITY:9.80665,GAS_CONSTANT_AIR:287.05},qt={A_LIQUID:17.27,B_LIQUID:237.7,A_ICE:21.87,B_ICE:265.5},Ks=6371e3,ar={KNOT_THRESHOLDS:[1,4,7,11,17,22,28,34,41,48,56,64],BEAUFORT_THRESHOLDS:[0,1,3,6,10,16,21,27,33,40,47,55,63]},Ft={FORECAST:"https://api.open-meteo.com/v1/forecast",HISTORICAL:"https://historical-forecast-api.open-meteo.com/v1/forecast"},Ue={SCENARIO_COLORS:{MIN_WIND:"rgba(0, 0, 255, 0.7)",MEAN_WIND:"rgba(0, 255, 0, 0.7)",MAX_WIND:"rgba(255, 0, 0, 0.7)"},HEATMAP_MIN_RADIUS_PX:5,HEATMAP_MAX_RADIUS_PX:50,HEATMAP_SCALING_BASE:1.42,HEATMAP_REFERENCE_ZOOM:13},Ys=[1e3,950,925,900,850,800,700,600,500,400,300,250,200],_e=200,Fn={OPEN:4.1,PARTIALLY:12.8,COLLAPSED:39.2},Xs=150,Kt={DEFAULT_AREA_VERTICAL:.5,DEFAULT_AREA_HORIZONTAL:.5,DEFAULT_MASS_KG:80,DEFAULT_DRAG_COEFFICIENT:1},lt={MIN_TRACK_LENGTH_M:100,MAX_TRACK_LENGTH_M:1e4,MIN_APPROACH_LENGTH_M:100,MAX_APPROACH_LENGTH_M:2e4,APPROACH_TIME_SECONDS:120},ve={MESSAGE_TIMEOUT_MS:3e3,DEFAULT_MAP_CENTER:[48.0179,11.1923],DEFAULT_MAP_ZOOM:11,GEOLOCATION_TIMEOUT_MS:2e4,GEOLOCATION_ACCURACY_THRESHOLD_M:500,MIN_ZOOM:11,MAX_ZOOM:14,LANDING_PATTERN_MIN_ZOOM:14},Yt={MIN_TIME_DIFF_FOR_SPEED_CALC_S:.5,SPEED_SMOOTHING_LOW:.5,SPEED_SMOOTHING_HIGH:.2,SPEED_SMOOTHING_TRESHOLD:25},vn={TILE_MAX_AGE_DAYS:7,FETCH_TIMEOUT_MS:15e3,SIZE_LIMIT_MB_WARNING:500},ya={DEFAULT_MARKER:Js,CUTAWAY_MARKER:js,AIRPLANE_MARKER:qs},Qs="DZMasterTest",ke=()=>{const t=document.getElementById("interpStep");return t?t.value:"200"};let rr=!1;function el(t){rr=t,console.log(`App context set to: ${rr?"Mobile":"Web"}`)}const m={FEATURE_PASSWORD:"skydiver2025",defaultSettings:{model:"icon_global",refLevel:"AGL",heightUnit:"m",temperatureUnit:"C",windUnit:"kt",timeZone:"Z",coordFormat:"Decimal",downloadFormat:"HEIDIS",showTable:!1,canopySpeed:20,descentRate:3.5,showLandingPattern:!1,landingDirection:"LL",customLandingDirectionLL:"",customLandingDirectionRR:"",legHeightDownwind:300,legHeightBase:200,legHeightFinal:100,interpStep:"200",lowerLimit:0,upperLimit:3e3,baseMaps:"Esri Street",calculateJump:!0,openingAltitude:1200,exitAltitude:3e3,showJumpRunTrack:!1,showExitArea:!1,showCanopyArea:!1,showCutAwayFinder:!1,jumpRunTrackOffset:0,jumpRunTrackForwardOffset:0,aircraftSpeedKt:90,jumperSeparation:5,numberOfJumpers:5,cutAwayAltitude:1e3,cutAwayState:"Partially",trackPosition:!1,showJumpMasterLine:!1,jumpMasterLineTarget:"DIP",harpLat:null,harpLng:null,cacheRadiusKm:10,cacheZoomLevels:[11,12,13,14],autoupdate:!1,selectedEnsembleModels:[],currentEnsembleScenario:"all_models"},state:{userSettings:null,unlockedFeatures:{landingPattern:!1,calculateJump:!1,planner:!1},isJumperSeparationManual:!1,isLandingPatternUnlocked:!1,isCalculateJumpUnlocked:!1,isPlannerUnlocked:!1},initialize(){let t={},e={landingPattern:!1,calculateJump:!1};try{const a=localStorage.getItem("upperWindsSettings");a?(t=JSON.parse(a),console.log("Loaded settings from localStorage:",t)):console.log("No settings found in localStorage, using defaults")}catch(a){this.handleError(a,"Failed to load settings. Using defaults.")}try{const a=localStorage.getItem("unlockedFeatures");a?(e=JSON.parse(a),console.log("Loaded unlocked features from localStorage:",e)):console.log("No unlocked features found in localStorage, using defaults")}catch(a){this.handleError(a,"Failed to load unlocked features. Using defaults.")}this.state.userSettings={...this.defaultSettings,...t},console.log("Initialized userSettings:",this.state.userSettings),this.state.userSettings.harpLat=null,this.state.userSettings.harpLng=null,console.log("Reset HARP coordinates to null at startup"),this.state.userSettings.jumpMasterLineTarget==="HARP"&&(console.log("Reset jumpMasterLineTarget to DIP due to cleared HARP coordinates"),this.state.userSettings.jumpMasterLineTarget="DIP"),this.state.userSettings.jumpRunTrackOffset=0,this.state.userSettings.jumpRunTrackForwardOffset=0,console.log("Reset JRT offsets to 0 at startup"),this.state.userSettings.selectedEnsembleModels=[...this.defaultSettings.selectedEnsembleModels],this.state.userSettings.currentEnsembleScenario=this.defaultSettings.currentEnsembleScenario,this.state.userSettings.showCutAwayFinder=!1,console.log('Forced "showCutAwayFinder" to false on startup.'),this.state.unlockedFeatures={landingPattern:e.landingPattern||!0,calculateJump:e.calculateJump||!0,planner:e.planner||!1},["OpenStreetMap","OpenTopoMap","Esri Satellite","Esri Street","Esri Topo","Esri Satellite + OSM"].includes(this.state.userSettings.baseMaps)||(console.warn(`Invalid baseMaps setting: ${this.state.userSettings.baseMaps}, resetting to default`),this.state.userSettings.baseMaps=this.defaultSettings.baseMaps)},save(){const t={...this.state.userSettings};delete t.customJumpRunDirection;try{localStorage.setItem("upperWindsSettings",JSON.stringify(t)),console.log("Settings saved to localStorage:",t)}catch(e){console.error("Failed to save settings to localStorage:",e)}},saveUnlockStatus(t,e){try{t==="landingPattern"?(this.state.unlockedFeatures.landingPattern=e,this.state.isLandingPatternUnlocked=e):t==="calculateJump"?(this.state.unlockedFeatures.calculateJump=e,this.state.isCalculateJumpUnlocked=e):t==="planner"&&(this.state.unlockedFeatures.planner=e,this.state.isPlannerUnlocked=e),this.saveUnlockedFeatures(),console.log("Saved unlock status:",{landingPattern:this.state.isLandingPatternUnlocked,calculateJump:this.state.isCalculateJumpUnlocked,planner:this.state.isPlannerUnlocked})}catch{Utils.handleError("Failed to save unlock status.")}},showPasswordModal(t,e,n){console.log("Entering showPasswordModal for feature:",t);const a=document.getElementById("passwordModal"),r=document.getElementById("passwordInput"),i=document.getElementById("passwordError"),s=document.getElementById("passwordSubmit"),l=document.getElementById("passwordCancel"),c=document.getElementById("modalHeader"),u=document.getElementById("modalMessage");if(!a||!r||!s||!l||!c||!u){console.error("Modal elements not found:",{modal:a,input:r,submitBtn:s,cancelBtn:l,header:c,message:u});return}const d=t.charAt(0).toUpperCase()+t.slice(1);c.textContent=`${d} Access`,u.textContent=`Please enter the password to enable the ${d.toLowerCase()} functionality:`,r.value="",i.style.display="none",a.style.display="flex",console.log("Password modal should now be visible:",{modalDisplay:a.style.display});const h=()=>{if(console.log("Password modal submit clicked, entered value:",r.value),r.value===Qs){if(a.style.display="none",this.saveUnlockStatus(t,!0),t==="landingPattern"){const p=document.getElementById("showLandingPattern");p&&(p.style.opacity="1",p.title="")}else if(t==="calculateJump"){const p=document.querySelector('.menu-label[data-label="calculateJump"]');p&&(p.style.opacity="1",p.title="")}console.log("Feature unlocked:",t),e()}else i.textContent="Incorrect password",i.style.display="block",console.log("Incorrect password entered")};s.onclick=h,r.onkeypress=p=>{p.key==="Enter"&&h()},l.onclick=()=>{a.style.display="none",console.log("Password modal cancelled"),n()}},saveUnlockedFeatures(){try{const t=JSON.stringify(this.state.unlockedFeatures);localStorage.setItem("unlockedFeatures",t),console.log("Unlocked features saved:",JSON.parse(t))}catch(t){this.handleError(t,"Failed to save unlocked features to localStorage.")}},getValue(t,e,n){if(n===void 0&&typeof e!="string"&&(n=e,e=null),this.state.userSettings&&typeof this.state.userSettings[t]<"u")return this.state.userSettings[t];const a=document.querySelector(`input[name="${t}"]:checked`);if(a)return a.value;const r=document.getElementById(t);if(r&&r.tagName==="SELECT")return r.value;const i=document.getElementById(t);return i&&i.type==="checkbox"?i.checked:n},updateUnitLabels(){const t=this.getValue("heightUnit","radio","m"),e=this.getValue("windUnit","radio","kt"),n=this.getValue("refLevel","radio","AGL"),a=document.querySelector('#controls-row label[for="interpStep"]');a&&(a.textContent=`Step (${t}):`,console.log(`Updated step label to: Step (${t})`));const r=document.querySelector('label[for="lowerLimit"]'),i=document.querySelector('label[for="upperLimit"]');r&&(r.textContent=`Lower Limit (${t}):`,console.log(`Updated lower limit label to: Lower Limit (${t})`)),i&&(i.textContent=`Upper Limit (${t}):`,console.log(`Updated upper limit label to: Upper Limit (${t})`));const s=document.getElementById("meanWindResult");if(s?.innerHTML){let l=s.innerHTML;const c=/\((\d+)-(\d+) m\b[^)]*\)/;if(c.test(l)){const[d,h,p]=l.match(c),f=this.convertHeight(parseFloat(h),t),y=this.convertHeight(parseFloat(p),t);l=l.replace(c,`(${Math.round(f)}-${Math.round(y)} ${t} ${n})`),console.log(`Updated mean wind height: (${Math.round(f)}-${Math.round(y)} ${t} ${n})`)}const u=/: (\d+(?:\.\d+)?)\s*([a-zA-Z\/]+)$/;if(u.test(l)){const[d,h,p]=l.match(u),f=parseFloat(h);if(!isNaN(f)){const y=this.convertWind(f,e,p),v=y==="N/A"?"N/A":e==="bft"?Math.round(y):y.toFixed(1);l=l.replace(u,`: ${v} ${e}`),console.log(`Updated mean wind speed: ${v} ${e}`)}}s.innerHTML=l}},updateModelRunInfo(t,e,n){const a=document.getElementById("modelLabel"),r=document.getElementById("modelSelect");if(!a||!r){console.warn("Model run info elements missing:",{modelLabel:a,modelSelect:r,lastModelRun:t,lastLat:e,lastLng:n});return}if(!t){console.log("lastModelRun is falsy, setting default model run info:",{lastModelRun:t,lastLat:e,lastLng:n}),a.title=`Model: ${r.value.replace("_"," ").toUpperCase()}
Run: Not available`;return}const i=r.value,s=`Model: ${i.replace("_"," ").toUpperCase()}
Run: ${t}`;a.title=s,console.log(`Updated model run info: ${s}`,{lastModelRun:t,model:i,lastLat:e,lastLng:n})},handleError(t,e="An error occurred. Please try again."){console.error("Settings Error:",t),Utils.handleError(e)},convertHeight(t,e){return isNaN(t)?t:e==="ft"?t*3.28084:t},convertWind(t,e,n){return isNaN(t)?"N/A":{kt:{"m/s":r=>r*.514444,"km/h":r=>r*1.852,mph:r=>r*1.15078,bft:r=>this.ktToBeaufort(r)},"m/s":{kt:r=>r/.514444,"km/h":r=>r*3.6,mph:r=>r*2.23694,bft:r=>this.ktToBeaufort(r/.514444)}}[n]?.[e]?.(t)||t},ktToBeaufort(t){return t<1?0:t<=3?1:t<=6?2:t<=10?3:t<=16?4:t<=21?5:t<=27?6:t<=33?7:t<=40?8:t<=47?9:t<=55?10:t<=63?11:12},isFeatureUnlocked(t){return t==="landingPattern"||t==="calculateJump"?!0:!!this.state.unlockedFeatures[t]||!1}};let $n=console.error,On=console.log,g=class F{static formatTime(e){return N.fromISO(e,{zone:"UTC"}).toFormat("yyyy-MM-dd HHmm")+"Z"}static roundToTens(e){const n=Math.round(e/10)*10;return(n===0||n===360)&&(e>=355||e<=4)?360:n}static convertTemperature(e,n){const a=parseFloat(e);return isNaN(a)?"N/A":n==="°F"?a*9/5+32:a}static convertHeight(e,n){const a=parseFloat(e);return isNaN(a)?"N/A":n==="ft"?parseFloat((e*Q.METERS_TO_FEET).toFixed(0)):e}static convertWind(e,n,a="km/h"){if(e==null||isNaN(e))return"N/A";let r;switch(a){case"km/h":r=e;break;case"m/s":r=e*3.6;break;case"kt":r=e*Q.KNOTS_TO_KMH;break;case"mph":r=e*1.60934;break;case"bft":r=F.beaufortToKnots(e)*Q.KNOTS_TO_KMH;break;default:r=e;break}switch(n){case"km/h":return r;case"m/s":return r/3.6;case"kt":return r/Q.KNOTS_TO_KMH;case"mph":return r/1.60934;case"bft":return F.knotsToBeaufort(r/Q.KNOTS_TO_KMH);default:return r/Q.KNOTS_TO_KMH}}static knotsToBeaufort(e){const n=ar.KNOT_THRESHOLDS.findIndex(a=>e<a);return n===-1?12:n}static beaufortToKnots(e){return ar.BEAUFORT_THRESHOLDS[e]||63}static calculateDewpoint(e,n){const a=qt.A_LIQUID,r=qt.B_LIQUID,i=qt.A_ICE,s=qt.B_ICE;let l,c;return e>=0?(l=a*e/(r+e)+Math.log(n/100),c=r*l/(a-l)):(l=i*e/(s+e)+Math.log(n/100),c=s*l/(i-l)),isNaN(c)?null:c}static gaussianInterpolation(e,n,a,r,i){if(a===i)return e;if(r===i)return n;let s=1/Math.abs(a-i),l=1/Math.abs(r-i);return(s*e+l*n)/(s+l)}static interpolateWindAtAltitude(e,n,a,r,i){if(n.length!=a.length||n.length!=r.length||n.length!=i.length)return{u:"Invalid input",v:"Invalid input"};const s=n.map(h=>Math.log(h)),l=F.linearInterpolate(a,s,e);if(typeof l=="string"&&l.includes("error"))return{u:"Interpolation error",v:"Interpolation error"};const c=Math.exp(l),u=F.linearInterpolate(s,r,Math.log(c)),d=F.linearInterpolate(s,i,Math.log(c));return typeof u=="string"&&u.includes("error")||typeof d=="string"&&d.includes("error")?{u:"Interpolation error",v:"Interpolation error"}:{u,v:d}}static interpolatePressure(e,n,a){if(!n||!a||n.length!==a.length||n.length<2||e<a[0]||e>a[a.length-1])return"N/A";for(let r=0;r<a.length-1;r++)if(e>=a[r]&&e<=a[r+1]){const i=a[r],s=a[r+1],l=n[r],c=n[r+1];return l+(c-l)*(e-i)/(s-i)}return"N/A"}static linearInterpolate(e,n,a){if(!e?.length||!n?.length||e.length!==n.length)return"invalid input for linearInterpolate";let r=!1;e[1]>e[0]&&(n=[...n].reverse(),e=[...e].reverse(),r=!0);const i=e.length-1;try{if(a>e[0]||a<e[i]){let s,l;return a>e[0]?(s=(n[1]-n[0])/(e[1]-e[0]),l=n[1]-s*e[1]):(s=(n[i]-n[i-1])/(e[i]-e[i-1]),l=n[i]-s*e[i]),s*a+l}else{let s;for(s=1;s<=i&&!(a>=e[s]);s++);const l=(n[s]-n[s-1])/(e[s]-e[s-1]),c=n[s]-l*e[s];return l*a+c}}catch{return"interpolation error"}finally{r&&(n.reverse(),e.reverse())}}static windSpeed(e,n){return Math.sqrt(e*e+n*n)}static windDirection(e,n){return(Math.atan2(-e,-n)*180/Math.PI+360)%360}static calculateMeanWind(e,n,a,r,i){try{if(!e||!n||!a||e.length<2)throw new Error("Invalid input data for calculateMeanWind");const s=new Array(4);let l=[i],c=[Number(F.linearInterpolate(e,n,i))],u=[Number(F.linearInterpolate(e,a,i))];const d=Number(F.linearInterpolate(e,n,r)),h=Number(F.linearInterpolate(e,a,r));for(let S=0;S<e.length;S++)e[S]<i&&e[S]>r&&(l.push(e[S]),c.push(n[S]),u.push(a[S]));l.push(r),c.push(d),u.push(h);const p=l.map((S,M)=>M);p.sort((S,M)=>l[M]-l[S]),l=p.map(S=>l[S]),c=p.map(S=>c[S]),u=p.map(S=>u[S]);let f=0,y=0;for(let S=0;S<l.length-1;S++)f+=.5*(c[S]+c[S+1])*(l[S]-l[S+1]),y+=.5*(u[S]+u[S+1])*(l[S]-l[S+1]);const v=f/(l[0]-l[l.length-1]),w=y/(l[0]-l[l.length-1]);return s[2]=v,s[3]=w,s[1]=F.windSpeed(v,w),s[0]=F.windDirection(v,w),s}catch(s){return console.error("Error in calculateMeanWind:",s,{heights:e,xComponents:n,yComponents:a,lowerLimit:r,upperLimit:i}),F.handleError("Failed to calculate mean wind: "+s.message),null}}static locationCache=new Map;static async getLocationData(e,n){const a=`${e.toFixed(4)},${n.toFixed(4)}`;if(F.locationCache.has(a))return F.locationCache.get(a);try{const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${e}&longitude=${n}&timezone=auto`);if(!r.ok)throw r.status===429&&console.warn("API rate limit hit while fetching location data."),new Error(`Open-Meteo fetch failed: ${r.status}`);const i=await r.json(),s={timezone:i.timezone||"GMT",timezone_abbreviation:i.timezone_abbreviation||"GMT",elevation:i.elevation!==void 0?i.elevation:"N/A"};return F.locationCache.set(a,s),s}catch(r){return console.error("Error fetching location data:",r.message),{timezone:"UTC",elevation:"N/A"}}}static async formatLocalTime(e,n,a){const{timezone:r,timezone_abbreviation:i}=await F.getLocationData(n,a);return N.fromISO(e,{zone:"UTC"}).setZone(r).toFormat("yyyy-MM-dd HHmm")+` ${i}`}static normalizeAngle(e){return(e%360+360)%360}static calculateWindAngle(e,n){let a=F.normalizeAngle(n-e);return a>180&&(a-=360),a}static calculateWindComponents(e,n){const a=n*(Math.PI/180),r=e*Math.sin(a),i=e*Math.cos(a);return{crosswind:r,headwind:i}}static calculateWCA(e,n){const r=Math.abs(Math.asin(e/n))*(180/Math.PI);return isNaN(r)?0:r}static calculateGroundSpeed(e,n){return e-n}static calculateCourseFromHeading(e,n,a,r){const i=F.calculateWindAngle(e,n),{crosswind:s,headwind:l}=F.calculateWindComponents(a,i),c=r*Math.sin(e*Math.PI/180),u=r*Math.cos(e*Math.PI/180),d=(n+180)%360,h=a*Math.sin(d*Math.PI/180),p=a*Math.cos(d*Math.PI/180),f=c+h,y=u+p,v=Math.atan2(f,y)*(180/Math.PI),w=F.normalizeAngle(v),S=Math.sqrt(f*f+y*y),M=F.calculateWCA(s,r)*(s<0?-1:1);return{trueCourse:Number(w.toFixed(2)),groundSpeed:Number(S.toFixed(2)),wca:Number(M.toFixed(2)),crosswind:Number(s.toFixed(2)),headwind:Number(l.toFixed(2))}}static calculateFlightParameters(e,n,a,r){const i=F.calculateWindAngle(e,n),{crosswind:s,headwind:l}=F.calculateWindComponents(a,i),c=F.calculateWCA(s,r),u=F.calculateGroundSpeed(r,l);return{crosswind:Number(s.toFixed(2)),headwind:Number(l.toFixed(2)),wca:Number(c.toFixed(2)),groundSpeed:Number(u.toFixed(2))}}static handleError(e,n=!0){n&&console.error(e),typeof displayError=="function"?displayError(e):(console.warn("Utils.js: displayError function is not available, logging to console only."),console.error("Error message:",e))}static dmsToDecimal(e,n,a,r){if(isNaN(e)||isNaN(n)||isNaN(a)||!r)throw console.warn("Invalid DMS inputs:",{deg:e,min:n,sec:a,dir:r}),new Error("Invalid DMS values");let i=e+n/60+a/3600;if((r==="S"||r==="W")&&(i=-i),isNaN(i))throw console.warn("DMS to decimal conversion failed:",{deg:e,min:n,sec:a,dir:r}),new Error("Failed to convert DMS to decimal");return i}static decimalToDms(e,n){if(isNaN(e)||e===null||e===void 0)throw console.warn("Invalid decimal value for DMS conversion:",e),new Error("Invalid coordinate for DMS conversion");const a=Math.abs(e),r=Math.floor(a),i=Math.floor((a-r)*60),s=(a-r)*3600-i*60,l=n?e>=0?"N":"S":e>=0?"E":"W";if(isNaN(r)||isNaN(i)||isNaN(s))throw console.warn("DMS calculation resulted in invalid values:",{deg:r,min:i,sec:s}),new Error("Failed to convert to DMS");return{deg:r,min:i,sec:s,dir:l}}static decimalToMgrs(e,n){try{return pi([n,e])}catch(a){return console.error("Error converting to MGRS:",a),"Invalid MGRS"}}static mgrsToDecimal(e){try{const[n,a]=ga(e);return{lat:a,lng:n}}catch(n){return console.error("Error converting MGRS to decimal:",n),null}}static convertCoords(e,n,a="Decimal"){if(e===null||n===null||e===void 0||n===void 0)return{lat:"N/A",lng:"N/A"};const r={Decimal:{lat:e.toFixed(6),lng:n.toFixed(6)},DMS:{lat:F.decimalToDms(e,!0),lng:F.decimalToDms(n,!1)},MGRS:F.decimalToMgrs(e,n)};switch(a){case"DMS":return r.DMS;case"MGRS":return{lat:r.MGRS,lng:r.MGRS};case"Decimal":default:return r.Decimal}}static calculateTAS(e,n){if(isNaN(e)||isNaN(n)||e<0||n<0)return console.warn("Invalid inputs for calculateTAS:",{ias:e,heightFt:n}),"N/A";const a=qe.LAPSE_RATE,r=qe.SEA_LEVEL_TEMP_KELVIN,i=qe.GRAVITY,s=qe.GAS_CONSTANT_AIR,l=Q.FEET_TO_METERS,c=n*l,u=r-a*c,d=u/r,h=1-a*c/r,p=i/(a*s)-1,f=Math.pow(h,p),y=e/Math.sqrt(f);return console.log("calculateTAS debug:",{ias:e,heightFt:n,heightM:c,tempAtAltitude:u,tempRatio:d,base:h,exponent:p,densityRatio:f,tas:y,tasRounded:Number(y.toFixed(2))}),Number(y.toFixed(2))}static calculateTASFromGroundSpeed(e,n,a,r,i){if(isNaN(e)||isNaN(n)||isNaN(a)||isNaN(r))return"N/A";const s=F.convertWind(e,"kt","m/s"),l=F.convertWind(n,"kt","m/s"),c=F.calculateWindAngle(r,a),{crosswind:u,headwind:d}=F.calculateWindComponents(l,c),h=s+d,p=F.calculateTAS(h,i);return Number(p.toFixed(1))}static handleMessage(e){const n=document.getElementById("info");n?(n.textContent=e,n.style.display="block",setTimeout(()=>{n.style.display="none"},3e3),console.log("Displayed message:",e)):(console.warn("Info div not found for handleMessage, using alert"),alert(e))}static calculateQFE(e,n,a,r=15){if(!e||n==="N/A"||a==="N/A"||isNaN(e)||isNaN(n)||isNaN(a))return"N/A";const i=qe.GRAVITY,s=nr.MOLAR_MASS_AIR,l=nr.UNIVERSAL_GAS_CONSTANT,c=r+Q.CELSIUS_TO_KELVIN,u=qe.LAPSE_RATE,d=e*100,h=n-a,p=i*s/(l*u),f=d*Math.pow(1-u*h/c,p),y=Math.round(f/100);return isNaN(y)?"N/A":y}static calculateNewCenter(e,n,a,r){const i=Ks,s=e*Math.PI/180,l=n*Math.PI/180,c=r*Math.PI/180,u=a/i,d=Math.asin(Math.sin(s)*Math.cos(u)+Math.cos(s)*Math.sin(u)*Math.cos(c)),h=l+Math.atan2(Math.sin(c)*Math.sin(u)*Math.cos(s),Math.cos(u)-Math.sin(s)*Math.sin(d)),p=d*180/Math.PI,y=(h*180/Math.PI+540)%360-180;return[p,y]}static debounce(e,n){let a;return function(...r){clearTimeout(a),a=setTimeout(()=>e.apply(this,r),n)}}static calculateBearing(e,n,a,r){const i=h=>h*Math.PI/180,s=h=>h*180/Math.PI,l=i(r-n),c=Math.sin(l)*Math.cos(i(a)),u=Math.cos(i(e))*Math.sin(i(a))-Math.sin(i(e))*Math.cos(i(a))*Math.cos(l);let d=s(Math.atan2(c,u));return d=(d+360)%360,d}static debouncedGetElevationAndQFE=F.debounce(async(e,n,a)=>{`${e.toFixed(5)}${n.toFixed(5)}`;try{const r=await F.getAltitude(e,n);a&&a({elevation:r})}catch(r){console.warn("Failed to fetch elevation in debouncedGetElevationAndQFE:",r),a&&a({elevation:"N/A"})}},500);static async getAltitude(e,n){const{elevation:a}=await F.getLocationData(e,n);return a!=="N/A"?a:"N/A"}static getLastFullHourUTC(){const e=new Date,n=e.getUTCFullYear(),a=e.getUTCMonth(),r=e.getUTCDate(),i=e.getUTCHours(),s=new Date(Date.UTC(n,a,r,i,0,0));return console.log("Last full hour UTC:",s.toISOString()),s}static async getDisplayTime(e,n,a,r="Z"){return r.toLowerCase()==="loc"&&n&&a?await F.formatLocalTime(e,n,a):F.formatTime(e)}static calculateDynamicRadius(e=Ue.HEATMAP_SCALING_BASE,n=Ue.HEATMAP_REFERENCE_ZOOM){const a=o.map.getZoom(),r=Ue.HEATMAP_SCALING_BASE,i=Math.pow(r,a-n),s=e*i,l=Ue.HEATMAP_MIN_RADIUS_PX,c=Ue.HEATMAP_MAX_RADIUS_PX,u=Math.max(l,Math.min(c,s));return console.log("[calculateDynamicRadius] Calculated dynamic radius:",{currentZoom:a,baseRadius:e,scaleFactor:i,dynamicRadius:s,adjustedRadius:u}),u}static interpolateColor(e,n=0,a=3e3){const r=Math.min(Math.max((e-n)/(a-n),0),1);return e<0||isNaN(e)?"#808080":r<=.5?`rgb(255, ${Math.round(255*(r*2))}, 0)`:`rgb(${Math.round(255*(1-(r-.5)*2))}, 255, 0)`}static generateWindBarb(e,n,a=null){const r=Math.round(n),i=40,s=40,l=i/2,c=s/2,u=20,h=(typeof a=="number"&&!isNaN(a)?a>=0:!0)?-1:1;let p=Math.floor(r/50),f=r%50,y=Math.floor(f/10),v=Math.floor(f%10/5);r<5?(y=0,v=0):r<10&&v>0&&(v=1);let w=`<svg width="${i}" height="${s}" viewBox="0 0 ${i} ${s}">`;const S=e+180;w+=`<g transform="translate(${l}, ${c}) rotate(${S})">`,w+=`<line x1="0" y1="${u/2}" x2="0" y2="${-u/2}" stroke="black" stroke-width="1"/>`;let M=u/2;const _=4;for(let E=0;E<p;E++)w+=`<polygon points="0,${M-5} 0,${M+5} ${10*h},${M}" fill="black"/>`,M-=_+5;for(let E=0;E<y;E++)w+=`<line x1="0" y1="${M}" x2="${10*h}" y2="${M}" stroke="black" stroke-width="1"/>`,M-=_;return v>0&&(w+=`<line x1="0" y1="${M}" x2="${5*h}" y2="${M}" stroke="black" stroke-width="1"/>`),r<5&&(w+='<circle cx="0" cy="0" r="3" fill="none" stroke="black" stroke-width="1"/>'),w+="</g></svg>",w}static setErrorHandler(e){$n=e}static setMessageHandler(e){On=e}static handleError(e,n=!0){n&&console.error(e),typeof $n=="function"&&$n(e)}static handleMessage(e){typeof On=="function"?On(e):console.log(e)}static validateLegHeights(e,n,a){const r=parseInt(e.value)||100,i=parseInt(n.value)||200,s=parseInt(a.value)||300;return i<=r?(F.handleError("Base leg must start higher than final leg."),!1):s<=i?(F.handleError("Downwind leg must start higher than base leg."),!1):!0}static convertFeetToMeters(e){return e==null||isNaN(e)?0:e/3.28084}static getTooltipContent(e,n,a,r){if(!o.map)return console.warn("Map not initialized for getTooltipContent"),"Map not initialized";const i=m.getValue("coordFormat","Decimal"),s=m.getValue("windUnit","kt"),l=m.getValue("heightUnit","m"),c=F.convertCoords(e.lat,e.lng,i);let u=i==="MGRS"?`MGRS: ${c.lat}`:`Lat: ${c.lat}<br>Lng: ${c.lng}`;const d=e.ele;let h=d!==null&&r!==null?d-r:null;if(h!==null){const y=l||"m";h=F.convertHeight(h,y),h=Math.round(h),u+=`<br>Altitude: ${h} ${y} AGL`}else u+="<br>Altitude: N/A";let p="N/A",f="N/A";if(n>0&&e.time&&a[n-1].time&&e.ele!==null&&a[n-1].ele!==null){const y=(e.time.toMillis()-a[n-1].time.toMillis())/1e3;if(y>0){const w=o.map.distance([a[n-1].lat,a[n-1].lng],[e.lat,e.lng])/y;p=F.convertWind(w,s,"m/s"),p=s==="bft"?Math.round(p):p.toFixed(1),f=((e.ele-a[n-1].ele)/y).toFixed(1)}}return u+=`<br>Speed: ${p} ${s}`,u+=`<br>Descent Rate: ${f} m/s`,u}};window.Utils=g;function Mi(t){const e=m.state.userSettings.exitAltitude*Q.METERS_TO_FEET,n=g.calculateTAS(t,e);if(n==="N/A")return console.warn("TAS calculation failed, using default separation"),m.defaultSettings.jumperSeparation;const a=Object.keys(tr).map(Number).sort((s,l)=>l-s);let r=a[0];for(const s of a)if(n<=s)r=s;else break;return tr[r]||7}function Si(t,e,n,a,r,i,s){if(!t||!t.time||!a||a.length===0||!Number.isFinite(r)||!Number.isFinite(i)||!Number.isFinite(s))return null;const l=s+e,c=s+n-_e,u=va(a),d=u?u.direction:0,h=m.state.userSettings.aircraftSpeedKt,p=e/.3048,f=g.calculateTAS(h,p);let y=f==="N/A"?h*Q.KNOTS_TO_MPS:f*Q.KNOTS_TO_MPS;const v=Math.cos(d*Math.PI/180)*y,w=Math.sin(d*Math.PI/180)*y,S=a.map(D=>D.height),M=a.map(D=>Number.isFinite(D.dir)?parseFloat(D.dir):0),_=a.map(D=>g.convertWind(parseFloat(D.spd)||0,"m/s","km/h")),E=a.map(D=>D.temp),b=[{time:0,height:l,vz:0,vxGround:v,vyGround:w,x:0,y:0}],T=t.surface_pressure[0]||1013.25;let k=b[0];for(;k.height>c;){const D=g.linearInterpolate(S,M,k.height),$=g.linearInterpolate(S,_,k.height),U=g.linearInterpolate(S,E,k.height)+Q.CELSIUS_TO_KELVIN,J=qe.GAS_CONSTANT_AIR,H=.5,V=T*100*Math.exp(-9.80665*(k.height-s)/(J*U))/(J*U),te=(D+180)%360,he=$*Math.cos(te*Math.PI/180),le=$*Math.sin(te*Math.PI/180),Se=k.vxGround-he,Ee=k.vyGround-le,j=Math.sqrt(Se*Se+Ee*Ee),Pe=1,vt=Kt.DEFAULT_AREA_VERTICAL,be=Kt.DEFAULT_MASS_KG,Bt=Kt.DEFAULT_DRAG_COEFFICIENT,Lt=Kt.DEFAULT_AREA_HORIZONTAL,Mt=.5*Pe*vt*V/be,Ge=.5*Bt*Lt*V/be,Wt=-9.80665-Mt*k.vz*Math.abs(k.vz),zt=-Ge*j*Se,bn=-Ge*j*Ee;let nt=k.height+k.vz*H,at=k.vz+Wt*H,St=k.time+H;if(nt<=c){const rt=(k.height-c)/(k.height-nt);St=k.time+H*rt,nt=c,at=k.vz+Wt*H*rt}const Et={time:St,height:nt,vz:at,vxGround:v===0?he:k.vxGround+zt*H,vyGround:w===0?le:k.vyGround+bn*H,x:k.x+(v===0?he:k.vxGround)*H,y:k.y+(w===0?le:k.vyGround)*H};if(b.push(Et),k=Et,Et.height===c)break}const A=b[b.length-1],P=Math.sqrt(A.x*A.x+A.y*A.y);let I=Math.atan2(A.y,A.x)*180/Math.PI;return I=(I+360)%360,{time:A.time,distance:P,directionDeg:I,path:b.map(D=>({latLng:g.calculateNewCenter(r,i,Math.sqrt(D.x*D.x+D.y*D.y),Math.atan2(D.y,D.x)*180/Math.PI),height:D.height,time:D.time}))}}function Ei(t){if(!m.state.userSettings.showExitArea||!m.state.userSettings.calculateJump||!o.weatherData||!o.lastLat||!o.lastLng||!t||t.length===0)return null;const e=parseInt(document.getElementById("exitAltitude")?.value)||3e3,n=parseInt(document.getElementById("openingAltitude")?.value)||1200,a=parseInt(document.getElementById("legHeightDownwind")?.value)||300,r=parseFloat(document.getElementById("descentRate")?.value)||3.5,i=(parseFloat(document.getElementById("canopySpeed")?.value)||20)*Q.KNOTS_TO_MPS,s=m.state.userSettings.safetyHeight||0,l=s/r*i,c=t.map(D=>D.height),u=t.map(D=>-g.convertWind(D.spd,"m/s","km/h")*Math.sin(D.dir*Math.PI/180)),d=t.map(D=>-g.convertWind(D.spd,"m/s","km/h")*Math.cos(D.dir*Math.PI/180)),h=Math.round(o.lastAltitude),p=(n-_e-a)/r,f=p*i,y=(n-_e)/r,v=y*i,w=g.calculateMeanWind(c,u,d,h+s+a,h+n-_e),S=g.calculateMeanWind(c,u,d,h+s,h+n-_e),M=Ln(o.lastLat,o.lastLng,t);let[_,E]=M.downwindStart;Number.isFinite(_)||(_=o.lastLat,E=o.lastLng);const b=g.calculateNewCenter(_,E,w[1]*p,w[0]),T=g.calculateNewCenter(o.lastLat,o.lastLng,S[1]*y,S[0]),k=Si(o.weatherData,e,n,t,o.lastLat,o.lastLng,h);if(!k)return null;const A=(k.directionDeg+180)%360,P=g.calculateNewCenter(T[0],T[1],k.distance,A),I=g.calculateNewCenter(b[0],b[1],k.distance,A);return{greenLat:P[0],greenLng:P[1],darkGreenLat:I[0],darkGreenLng:I[1],greenRadius:Math.max(0,v-l),darkGreenRadius:Math.max(0,f-l),freeFallDirection:k.directionDeg,freeFallDistance:k.distance,freeFallTime:k.time}}function wa(t){if(!o.map||o.cutAwayLat===null||o.cutAwayLng===null||!o.weatherData||o.lastAltitude==="N/A"||!t||t.length===0)return null;const e=Math.round(o.lastAltitude),n=m.state.userSettings.cutAwayAltitude,a=e,r=e+n,i=t.map(E=>E.height),s=t.map(E=>-g.convertWind(E.spd,"m/s","km/h")*Math.sin(E.dir*Math.PI/180)),l=t.map(E=>-g.convertWind(E.spd,"m/s","km/h")*Math.cos(E.dir*Math.PI/180)),c=g.calculateMeanWind(i,s,l,a,r);if(!c)return null;const[u,d]=c,h={Open:Fn.OPEN,Partially:Fn.PARTIALLY,Collapsed:Fn.COLLAPSED},p=h[m.state.userSettings.cutAwayState]||h.Partially,f=n/p,y=d*f,v=(u+180)%360,[w,S]=g.calculateNewCenter(o.cutAwayLat,o.cutAwayLng,y,v),_=`<b>Cut-Away (${m.state.userSettings.cutAwayState.replace(/([A-Z])/g," $1").trim()})</b><br>Cut-Away Altitude: ${n} m<br>Displacement: ${u.toFixed(0)}°, ${y.toFixed(0)} m<br>Descent Time/Speed: ${f.toFixed(0)} s at ${p.toFixed(1)} m/s<br>`;return{center:[w,S],radius:Xs,tooltipContent:_}}function tl(t){if(!m.state.userSettings.showCanopyArea||!m.state.userSettings.calculateJump||!o.weatherData||!o.lastLat||!o.lastLng||!t||t.length===0)return null;const e=parseInt(document.getElementById("exitAltitude")?.value)||3e3,n=parseInt(document.getElementById("openingAltitude")?.value)||1200,a=parseInt(document.getElementById("legHeightDownwind")?.value)||300,r=parseFloat(document.getElementById("descentRate")?.value)||3.5,i=(parseFloat(document.getElementById("canopySpeed")?.value)||20)*Q.KNOTS_TO_MPS,s=m.state.userSettings.safetyHeight||0,l=s/r*i,c=t.map(O=>O.height),u=t.map(O=>-g.convertWind(O.spd,"m/s","km/h")*Math.sin(O.dir*Math.PI/180)),d=t.map(O=>-g.convertWind(O.spd,"m/s","km/h")*Math.cos(O.dir*Math.PI/180)),h=Math.round(o.lastAltitude),p=(n-_e-a)/r,f=p*i,y=(n-_e)/r,v=y*i,w=g.calculateMeanWind(c,u,d,h+a,h+s+n-_e),S=g.calculateMeanWind(c,u,d,h+s,h+n-_e),M=Si(o.weatherData,e,n,t,o.lastLat,o.lastLng,h);if(!M)return null;const _=Ln(o.lastLat,o.lastLng,t);let[E,b]=_.downwindStart;Number.isFinite(E)||(E=o.lastLat,b=o.lastLng);const T=h+n-_e,k=h+a,A=[],P=[],I=[],D=[];let $=T-k<=1e3?200:500;for(let O=T;O>=k+200;O-=$){const U=(O-k)/r,J=U*i;if(J>0){const H=g.calculateMeanWind(c,u,d,k,O);A.push(Math.max(0,J-l)),P.push(H[1]*U),I.push(H[0]),D.push(O-h)}}return{blueLat:E,blueLng:b,redLat:o.lastLat,redLng:o.lastLng,radius:Math.max(0,f-l),radiusFull:Math.max(0,v-l),additionalBlueRadii:A,additionalBlueDisplacements:P,additionalBlueDirections:I,additionalBlueUpperLimits:D,displacement:w[1]*p,direction:w[0],displacementFull:S[1]*y,directionFull:S[0],meanWindForFullCanopyDir:S[0],meanWindForFullCanopySpeedMps:S[1],freeFallDirection:M.directionDeg,freeFallDistance:M.distance,freeFallTime:M.time}}function va(t,e=null){const n=e?e.lat:o.lastLat,a=e?e.lng:o.lastLng;if(!o.weatherData||!n||!a||o.lastAltitude==="N/A"||!t||!t.length)return null;const r=parseInt(document.getElementById("openingAltitude")?.value)||1e3,i=Math.round(o.lastAltitude),s=t.map(U=>U.height),l=t.map(U=>-g.convertWind(U.spd,"m/s","km/h")*Math.sin(U.dir*Math.PI/180)),c=t.map(U=>-g.convertWind(U.spd,"m/s","km/h")*Math.cos(U.dir*Math.PI/180)),u=g.calculateMeanWind(s,l,c,i,i+r);if(!u)return null;let d=Math.round(u[0]);const h=parseFloat(m.state.userSettings.customJumpRunDirection);Number.isFinite(h)&&h>=0&&h<=360&&(d=h);const p=parseInt(document.getElementById("exitAltitude")?.value)||3e3,f=i+p,y=m.state.userSettings.aircraftSpeedKt||90,v=g.calculateTAS(y,f/.3048);let w=y*Q.KNOTS_TO_MPS;if(v!=="N/A"&&Number.isFinite(v)){const U=g.linearInterpolate(s.map(j=>j-i),t.map(j=>j.dir),p),J=g.linearInterpolate(s.map(j=>j-i),t.map(j=>g.convertWind(j.spd,"m/s","km/h")),p),H=v*Q.KNOTS_TO_MPS,V=(U+180)*Math.PI/180,te=J*Math.sin(V),he=J*Math.cos(V),le=d*Math.PI/180,Se=H*Math.sin(le),Ee=H*Math.cos(le);w=Math.sqrt(Math.pow(Se+te,2)+Math.pow(Ee+he,2))}const S=Math.max(lt.MIN_TRACK_LENGTH_M,Math.min(lt.MAX_TRACK_LENGTH_M,Math.round((m.state.userSettings.numberOfJumpers||10)*(m.state.userSettings.jumperSeparation||5)*w))),M=Math.max(lt.MIN_APPROACH_LENGTH_M,Math.min(lt.MAX_APPROACH_LENGTH_M,Math.round(w*lt.APPROACH_TIME_SECONDS))),_=m.state.userSettings.jumpRunTrackOffset||0,E=m.state.userSettings.jumpRunTrackForwardOffset||0,b=[n,a],T=g.calculateNewCenter(b[0],b[1],S,d),k=Math.sqrt(_**2+E**2),A=Math.atan2(_,E)*180/Math.PI,P=(d+A+360)%360,I=g.calculateNewCenter(b[0],b[1],k,P),D=g.calculateNewCenter(T[0],T[1],k,P),$=g.calculateNewCenter(I[0],I[1],M,(d+180)%360),O=[I,$];return{direction:d,trackLength:S,meanWindDirection:u[0],meanWindSpeed:u[1],latlngs:[I,D],approachLatLngs:O,approachLength:M,approachTime:lt.APPROACH_TIME_SECONDS}}function Ln(t,e,n){if(!n||n.length===0||!o.lastAltitude)return null;const a=parseInt(document.getElementById("canopySpeed").value)||20,r=parseFloat(document.getElementById("descentRate").value)||3.5,i=parseInt(document.getElementById("legHeightFinal").value)||100,s=parseInt(document.getElementById("legHeightBase").value)||200,l=parseInt(document.getElementById("legHeightDownwind").value)||300,c=Math.round(o.lastAltitude),u=n.map(Te=>Te.height),d=n.map(Te=>-g.convertWind(Te.spd,"kt","km/h")*Math.sin(Te.dir*Math.PI/180)),h=n.map(Te=>-g.convertWind(Te.spd,"kt","km/h")*Math.cos(Te.dir*Math.PI/180)),p=document.querySelector('input[name="landingDirection"]:checked')?.value||"LL",f=document.getElementById(p==="LL"?"customLandingDirectionLL":"customLandingDirectionRR"),y=f?parseInt(f.value,10):NaN;let v=Number.isFinite(y)?y:Number.isFinite(o.landingWindDir)?o.landingWindDir:n[0]?.dir;if(!Number.isFinite(v))return null;const w=(Te,Hi,Bi,Wi,zi)=>{const Gi=Wi*.5144444444444445*zi;return g.calculateNewCenter(Te,Hi,Gi,Bi)},S=g.calculateMeanWind(u,d,h,c,c+i),M=S[0],_=S[1],E=v,b=g.calculateWindAngle(E,M),{crosswind:T,headwind:k}=g.calculateWindComponents(_,b),A=g.calculateWCA(T,a)*(T>=0?1:-1),{groundSpeed:P}=g.calculateFlightParameters(E,M,_,a),I=i/r,D=P*(1.852/3.6)*I,$=w(t,e,(E+180)%360,P,I),O=g.calculateMeanWind(u,d,h,c+i,c+s),U=O[0],J=O[1],H=(v+(p==="LL"?90:-90)+360)%360,{trueCourse:V,groundSpeed:te}=g.calculateCourseFromHeading(H,U,J,a),he=g.calculateWindAngle(V,U),{crosswind:le,headwind:Se}=g.calculateWindComponents(J,he),Ee=g.calculateWCA(le,a)*(le>=0?1:-1);let j=(V+180)%360;te<0&&(j=(j+180)%360);const Pe=(s-i)/r,vt=te*(1.852/3.6)*Pe,be=w($[0],$[1],j,te,Pe),Bt=g.calculateMeanWind(u,d,h,c+s,c+l),Lt=Bt[0],Mt=Bt[1],Ge=(v+180)%360,Wt=g.calculateWindAngle(Ge,Lt),{crosswind:zt,headwind:bn}=g.calculateWindComponents(Mt,Wt),nt=g.calculateWCA(zt,a)*(zt>=0?1:-1),{groundSpeed:at}=g.calculateFlightParameters(Ge,Lt,Mt,a),St=(l-s)/r,Et=at*(1.852/3.6)*St,rt=w(be[0],be[1],(Ge+180)%360,at,St);return console.log(`Landing Pattern Updated:
        Final Leg: Wind: ${M.toFixed(1)}° @ ${_.toFixed(1)}kt, Course: ${E.toFixed(1)}°, WCA: ${A.toFixed(1)}°, GS: ${P.toFixed(1)}kt, HW: ${k.toFixed(1)}kt, Length: ${D.toFixed(1)}m
        Base Leg: Wind: ${U.toFixed(1)}° @ ${J.toFixed(1)}kt, Course: ${V.toFixed(1)}°, WCA: ${Ee.toFixed(1)}°, GS: ${te.toFixed(1)}kt, HW: ${Se.toFixed(1)}kt, Length: ${vt.toFixed(1)}m
        Downwind Leg: Wind: ${Lt.toFixed(1)}° @ ${Mt.toFixed(1)}kt, Course: ${Ge.toFixed(1)}°, WCA: ${nt.toFixed(1)}°, GS: ${at.toFixed(1)}kt, HW: ${bn.toFixed(1)}kt, Length: ${Et.toFixed(1)}m`),console.log("Coordinates DIP: ",t,e,"Altitude DIP:",c),console.log("Coordinates final end: ",$[0],$[1],"Leg Height:",c+i),console.log("Coordinates base end: ",be[0],be[1],"Leg Height:",c+s),console.log("Coordinates downwind end: ",rt[0],rt[1],"Leg Height:",c+l),{downwindStart:rt,baseStart:be,finalStart:$,landingPoint:[t,e]}}async function Ke(t,e,n=null){console.log("[weatherManager] Starting full weather fetch for location:",{lat:t,lng:e});const a=await al(t,e);return document.dispatchEvent(new CustomEvent("models:available",{detail:{availableModels:a}})),await nl(t,e,n)}async function nl(t,e,n=null){const a=document.getElementById("loading");a&&(a.style.display="block");try{const r=document.getElementById("modelSelect")?.value||m.defaultSettings.model;if(!r)throw new Error("No weather model selected.");const s=Li.API_MAP[r]||r;let l=!1,c,u;const d=N.utc().startOf("day");let h=null;if(n){let S=N.fromISO(n,{zone:"utc"});S.isValid&&(h=S.startOf("day"),h<d&&(l=!0))}else{const S=document.getElementById("historicalDatePicker")?.value;if(S){let M=N.fromISO(S,{zone:"utc"}).startOf("day");M<d&&(l=!0,h=M)}}let p=Ft.FORECAST;if(l&&h)p=Ft.HISTORICAL,c=u=h.toFormat("yyyy-MM-dd"),o.lastModelRun="N/A (Historical Data)";else{let S;try{const E=`https://api.open-meteo.com/data/${s}/static/meta.json`,T=await(await fetch(E)).json();S=new Date(T.last_run_initialisation_time*1e3),o.lastModelRun=S.toISOString().replace("T"," ").substring(0,16)+"Z"}catch{S=N.utc().toJSDate(),o.lastModelRun="N/A"}let M=N.fromJSDate(S).setZone("utc").plus({hours:6});M>N.utc()&&(M=N.utc()),c=M.toFormat("yyyy-MM-dd");const _=r.includes("_d2")?2:7;u=M.plus({days:_}).toFormat("yyyy-MM-dd")}const y=`${p}?latitude=${t}&longitude=${e}&hourly=surface_pressure,temperature_2m,relative_humidity_2m,wind_speed_10m,wind_direction_10m,wind_gusts_10m,temperature_1000hPa,relative_humidity_1000hPa,wind_speed_1000hPa,wind_direction_1000hPa,geopotential_height_1000hPa,temperature_950hPa,relative_humidity_950hPa,wind_speed_950hPa,wind_direction_950hPa,geopotential_height_950hPa,temperature_925hPa,relative_humidity_925hPa,wind_speed_925hPa,wind_direction_925hPa,geopotential_height_925hPa,temperature_900hPa,relative_humidity_900hPa,wind_speed_900hPa,wind_direction_900hPa,geopotential_height_900hPa,temperature_850hPa,relative_humidity_850hPa,wind_speed_850hPa,wind_direction_850hPa,geopotential_height_850hPa,temperature_800hPa,relative_humidity_800hPa,wind_speed_800hPa,wind_direction_800hPa,geopotential_height_800hPa,temperature_700hPa,relative_humidity_700hPa,wind_speed_700hPa,wind_direction_700hPa,geopotential_height_700hPa,temperature_600hPa,relative_humidity_600hPa,wind_speed_600hPa,wind_direction_600hPa,geopotential_height_600hPa,temperature_500hPa,relative_humidity_500hPa,wind_speed_500hPa,wind_direction_500hPa,geopotential_height_500hPa,temperature_400hPa,relative_humidity_400hPa,wind_speed_400hPa,wind_direction_400hPa,geopotential_height_400hPa,temperature_300hPa,relative_humidity_300hPa,wind_speed_300hPa,wind_direction_300hPa,geopotential_height_300hPa,temperature_250hPa,relative_humidity_250hPa,wind_speed_250hPa,wind_direction_250hPa,geopotential_height_250hPa,temperature_200hPa,relative_humidity_200hPa,wind_speed_200hPa,wind_direction_200hPa,geopotential_height_200hPa&models=${r}&start_date=${c}&end_date=${u}`,v=await fetch(y);if(!v.ok)throw v.status===429?new Error("API-Limit reached. Please wait a moment and retry again."):new Error(`HTTP error! Status: ${v.status}`);const w=await v.json();if(!w.hourly||!w.hourly.time||!w.hourly.time.length)throw new Error("No hourly data in API response.");return w.hourly}catch(r){return console.error("[fetchWeather] Error:",r),displayError(`Failed to fetch weather: ${r.message}`),null}finally{a&&(a.style.display="none")}}async function al(t,e){const n=Li.LIST;let a=[];for(const r of n)try{const i=await fetch(`${Ft.FORECAST}?latitude=${t}&longitude=${e}&hourly=temperature_2m&models=${r}`);if(i.ok){const s=await i.json();s.hourly&&s.hourly.temperature_2m&&s.hourly.temperature_2m.some(l=>l!==null)&&a.push(r)}else i.status===429?console.warn(`API-Limit beim Prüfen von Modell '${r}' erreicht.`):console.warn(`Modell '${r}' ist nicht verfügbar (Server-Antwort: ${i.status})`)}catch(i){console.error(`Netzwerkfehler beim Abruf von Modell '${r}':`,i)}return a}function Ne(t,e,n,a,r){if(!t||!t.time||e>=t.time.length)return console.warn("No weather data provided or index out of bounds for interpolation"),[];const s=Ys.filter(A=>{const P=t[`geopotential_height_${A}hPa`]?.[e];return P!=null});if(s.length<2)return console.warn("Insufficient valid pressure level data for interpolation:",s),[];let l=s.map(A=>t[`geopotential_height_${A}hPa`][e]),c=s.map(A=>t[`temperature_${A}hPa`][e]),u=s.map(A=>t[`relative_humidity_${A}hPa`][e]),d=s.map(A=>t[`wind_speed_${A}hPa`][e]),h=s.map(A=>t[`wind_direction_${A}hPa`][e]);const p=t.surface_pressure[e];if(p==null)return console.warn("Surface pressure missing"),[];let f=d.map((A,P)=>-A*Math.sin(h[P]*Math.PI/180)),y=d.map((A,P)=>-A*Math.cos(h[P]*Math.PI/180));const v=Math.max(...s),w=t[`geopotential_height_${v}hPa`][e];if(p>v&&Number.isFinite(w)&&w>a){const A=Math.floor((w-a)/n),P=-t.wind_speed_10m[e]*Math.sin(t.wind_direction_10m[e]*Math.PI/180),I=-t.wind_speed_10m[e]*Math.cos(t.wind_direction_10m[e]*Math.PI/180),D=f[s.indexOf(v)],$=y[s.indexOf(v)];for(let O=A-1;O>=1;O--){const U=a+O*n;if(U>=w)continue;const J=(U-a)/(w-a),H=Math.log(p),V=Math.log(v),te=H+J*(V-H),he=Math.exp(te),le=Math.log(U-a+1),Se=Math.log(1),Ee=Math.log(w-a),j=g.linearInterpolate([Se,Ee],[P,D],le),Pe=g.linearInterpolate([Se,Ee],[I,$],le),vt=g.windSpeed(j,Pe),be=g.windDirection(j,Pe);l.unshift(U),s.unshift(he),c.unshift(g.linearInterpolate([a,w],[t.temperature_2m[e],t[`temperature_${v}hPa`][e]],U)),u.unshift(g.linearInterpolate([a,w],[t.relative_humidity_2m[e],t[`relative_humidity_${v}hPa`][e]],U)),d.unshift(vt),h.unshift(be),f.unshift(j),y.unshift(Pe)}l.unshift(a),s.unshift(p),c.unshift(t.temperature_2m[e]),u.unshift(t.relative_humidity_2m[e]),d.unshift(t.wind_speed_10m[e]),h.unshift(t.wind_direction_10m[e]),f.unshift(P),y.unshift(I)}const S=s.indexOf(Math.min(...s)),M=l[S],_=M-a;if(_<=0||isNaN(_))return console.warn("Invalid max height at lowest pressure level:",{maxHeightASL:M,baseHeight:a,minPressure:s[S]}),[];const E=r==="ft"?_*3.28084:_,b=Math.floor(E/n),T=Array.from({length:b+1},(A,P)=>P*n);console.log("Interpolating up to lowest pressure level:",{maxHeightAGL:_,minPressure:s[S],interpStep:n});const k=[];return T.forEach(A=>{const P=r==="ft"?A/3.28084:A,I=a+P;let D;if(P===0)D={height:I,pressure:p,temp:t.temperature_2m[e],rh:t.relative_humidity_2m[e],spd:t.wind_speed_10m[e],dir:t.wind_direction_10m[e],dew:g.calculateDewpoint(t.temperature_2m[e],t.relative_humidity_2m[e])};else{const $=g.interpolatePressure(I,s,l),O=g.interpolateWindAtAltitude(I,s,l,f,y),U=g.windSpeed(O.u,O.v),J=g.windDirection(O.u,O.v),H=g.linearInterpolate(l,c,I),V=g.linearInterpolate(l,u,I),te=g.calculateDewpoint(H,V);D={height:I,pressure:$==="N/A"?"N/A":Number($.toFixed(1)),temp:Number(H.toFixed(1)),rh:Number(V.toFixed(0)),spd:Number(U.toFixed(1)),dir:Number(J.toFixed(0)),dew:Number(te.toFixed(1))}}D.displayHeight=A,k.push(D)}),console.log("Interpolated data length:",k.length,"Max height:",k[k.length-1].displayHeight),k}g.debounce(async(t,e)=>{try{const n=await g.getElevationAndQFE(t,e,o.apiKey);if(n){const a=document.getElementById("elevation"),r=document.getElementById("qfe");a&&(a.value=n.elevation.toFixed(1)),r&&(r.value=n.qfe.toFixed(2)),o.currentElevation=n.elevation,m.state.userSettings.qfe=n.qfe}}catch(n){console.error("Error fetching elevation and QFE:",n)}},500);async function La(){if(!o.lastLat||!o.lastLng)return g.handleMessage("Please select a location first."),!1;if(!m.state.userSettings.selectedEnsembleModels||m.state.userSettings.selectedEnsembleModels.length===0)return o.ensembleModelsData=null,Mn(),!0;const t=document.getElementById("loading");t&&(t.style.display="block");try{const e=o.lastLat,n=o.lastLng,a=m.state.userSettings.selectedEnsembleModels,r=a.join(","),i=["surface_pressure","temperature_2m","relative_humidity_2m","wind_speed_10m","wind_direction_10m","geopotential_height_1000hPa","temperature_1000hPa","relative_humidity_1000hPa","wind_speed_1000hPa","wind_direction_1000hPa","geopotential_height_950hPa","temperature_950hPa","relative_humidity_950hPa","wind_speed_950hPa","wind_direction_950hPa","geopotential_height_925hPa","temperature_925hPa","relative_humidity_925hPa","wind_speed_925hPa","wind_direction_925hPa","geopotential_height_900hPa","temperature_900hPa","relative_humidity_900hPa","wind_speed_900hPa","wind_direction_900hPa","geopotential_height_850hPa","temperature_850hPa","relative_humidity_850hPa","wind_speed_850hPa","wind_direction_850hPa","geopotential_height_800hPa","temperature_800hPa","relative_humidity_800hPa","wind_speed_800hPa","wind_direction_800hPa","geopotential_height_700hPa","temperature_700hPa","relative_humidity_700hPa","wind_speed_700hPa","wind_direction_700hPa","geopotential_height_600hPa","temperature_600hPa","relative_humidity_600hPa","wind_speed_600hPa","wind_direction_600hPa","geopotential_height_500hPa","temperature_500hPa","relative_humidity_500hPa","wind_speed_500hPa","wind_direction_500hPa","geopotential_height_400hPa","temperature_400hPa","relative_humidity_400hPa","wind_speed_400hPa","wind_direction_400hPa","geopotential_height_300hPa","temperature_300hPa","relative_humidity_300hPa","wind_speed_300hPa","wind_direction_300hPa","geopotential_height_250hPa","temperature_250hPa","relative_humidity_250hPa","wind_speed_250hPa","wind_direction_250hPa","geopotential_height_200hPa","temperature_200hPa","relative_humidity_200hPa","wind_speed_200hPa","wind_direction_200hPa"],s=i.join(","),l=document.getElementById("historicalDatePicker"),c=l?l.value:null,u=c?N.fromISO(c,{zone:"utc"}):null,d=N.utc().startOf("day"),h=u&&u<d;let p,f,y=Ft.FORECAST;if(h)y=Ft.HISTORICAL,p=u.toFormat("yyyy-MM-dd"),f=p;else{const _=N.utc();p=_.toFormat("yyyy-MM-dd"),f=_.plus({days:7}).toFormat("yyyy-MM-dd")}const v=`${y}?latitude=${e}&longitude=${n}&hourly=${s}&models=${r}&start_date=${p}&end_date=${f}`,w=await fetch(v);if(!w.ok)throw w.status===429?new Error("API-Limit for ensemble data reached. Please wait a moment and retry again."):new Error(`API request failed: ${w.status}`);const S=await w.json();o.ensembleModelsData={};const M=S.hourly.time;return a.forEach(_=>{const E={time:[...M]};let b=!1;i.forEach(T=>{const k=`${T}_${_}`;S.hourly[k]?(E[T]=S.hourly[k],b=!0):E[T]=null}),b&&(o.ensembleModelsData[_]=E)}),!0}catch{return!1}finally{t&&(t.style.display="none")}}function Mn(){o.ensembleLayerGroup&&o.map.removeLayer(o.ensembleLayerGroup),o.ensembleScenarioCircles={},o.ensembleLayerGroup=L.layerGroup().addTo(o.map)}function ht(t,e){if(Mn(),!o.ensembleModelsData||Object.keys(o.ensembleModelsData).length===0)return;const n=m.state.userSettings.currentEnsembleScenario;if(console.log(`Processing ensemble scenario: ${n} for slider index: ${t}`),n==="heatmap")sl(t);else if(n==="all_models"){for(const a in o.ensembleModelsData)if(Object.hasOwnProperty.call(o.ensembleModelsData,a)){const r=o.ensembleModelsData[a],i=Qn(a,t,{hourly:r});i&&ir(i,rl(a),a)}}else{const a=ol(n);if(a){const r=Qn(n,t,a);r&&ir(r,il(n),n.replace("_"," "))}}}function rl(t){let e=0;for(let a=0;a<t.length;a++)e=t.charCodeAt(a)+((e<<5)-e),e=e&e;return`hsl(${e%360}, 70%, 60%)`}function il(t){return t==="min_wind"?Ue.SCENARIO_COLORS.MIN_WIND:t==="mean_wind"?Ue.SCENARIO_COLORS.MEAN_WIND:t==="max_wind"?Ue.SCENARIO_COLORS.MAX_WIND:"rgba(128, 128, 128, 0.7)"}function ir(t,e,n){if(!o.map||!t||!o.ensembleLayerGroup)return;const a=[t.centerLat,t.centerLng],r=L.circle(a,{radius:t.radius,color:e,fillColor:e,fillOpacity:.15,weight:2,dashArray:"5, 10",pmIgnore:!0}).addTo(o.ensembleLayerGroup),i=m.getValue("windUnit","kt");let s="N/A";if(t.meanWindSpeedMps!=="N/A"&&Number.isFinite(t.meanWindSpeedMps)){const v=g.convertWind(t.meanWindSpeedMps,i,"m/s");v!=="N/A"&&Number.isFinite(v)&&(s=i==="bft"?Math.round(v):v.toFixed(1))}const l=parseInt(document.getElementById("openingAltitude")?.value)||m.state.userSettings.openingAltitude||1200,c=parseInt(document.getElementById("legHeightDownwind")?.value)||m.state.userSettings.legHeightDownwind||0,u=l-200,d=m.getValue("heightUnit","m"),h=Math.round(g.convertHeight(c,d)),p=Math.round(g.convertHeight(u,d)),f=t.meanWindDir!=="N/A"&&Number.isFinite(t.meanWindDir)?g.roundToTens(t.meanWindDir):"N/A",y=`<strong>${n}</strong><br>Mean Wind ${h}-${p} ${d} AGL:<br>${f}° ${s} ${i}`;r.bindTooltip(y,{permanent:!1,direction:"top",className:"wind-tooltip",opacity:.9}),o.ensembleScenarioCircles[n]=r,console.log(`Drew ensemble circle for ${n} at [${a.join(", ")}], radius ${t.radius}`)}function ol(t,e){if(!o.ensembleModelsData||Object.keys(o.ensembleModelsData).length===0)return console.warn("No ensemble data available for profile calculation."),null;if(Object.keys(o.ensembleModelsData).length===0)return null;console.log(`Calculating full time-series ensemble profile for: ${t}`);const a={},r=Object.keys(o.ensembleModelsData)[0],i=o.ensembleModelsData[r]?.time;if(!i||i.length===0)return console.error("Time data missing or empty in the first ensemble model for profile calculation."),null;a.time=[...i];const s=a.time.length,l=["surface_pressure","temperature_2m","relative_humidity_2m","geopotential_height_1000hPa","temperature_1000hPa","relative_humidity_1000hPa","geopotential_height_950hPa","temperature_950hPa","relative_humidity_950hPa","geopotential_height_925hPa","temperature_925hPa","relative_humidity_925hPa","geopotential_height_900hPa","temperature_900hPa","relative_humidity_900hPa","geopotential_height_850hPa","temperature_850hPa","relative_humidity_850hPa","geopotential_height_800hPa","temperature_800hPa","relative_humidity_800hPa","geopotential_height_700hPa","temperature_700hPa","relative_humidity_700hPa","geopotential_height_600hPa","temperature_600hPa","relative_humidity_600hPa","geopotential_height_500hPa","temperature_500hPa","relative_humidity_500hPa","geopotential_height_400hPa","temperature_400hPa","relative_humidity_400hPa","geopotential_height_300hPa","temperature_300hPa","relative_humidity_300hPa","geopotential_height_250hPa","temperature_250hPa","relative_humidity_250hPa","geopotential_height_200hPa","temperature_200hPa","relative_humidity_200hPa"],c=[["wind_speed_10m","wind_direction_10m"]];[1e3,950,925,900,850,800,700,600,500,400,300,250,200].forEach(d=>{c.push([`wind_speed_${d}hPa`,`wind_direction_${d}hPa`])}),l.forEach(d=>{a[d]=new Array(s).fill(null)}),c.forEach(d=>{a[d[0]]=new Array(s).fill(null),a[d[1]]=new Array(s).fill(null)});for(let d=0;d<s;d++)l.forEach(h=>{const p=[];for(const f in o.ensembleModelsData){const y=o.ensembleModelsData[f];if(y&&y[h]){const v=y[h][d];v!=null&&!isNaN(v)&&p.push(v)}}p.length>0&&(t==="min_wind"?a[h][d]=Math.min(...p):t==="max_wind"?a[h][d]=Math.max(...p):a[h][d]=p.reduce((f,y)=>f+y,0)/p.length)}),c.forEach(h=>{const p=h[0],f=h[1];let y=[],v=[],w=[],S=[];for(const M in o.ensembleModelsData){const _=o.ensembleModelsData[M];if(_&&_[p]&&_[f]){const E=_[p][d],b=_[f][d];E!=null&&!isNaN(E)&&b!==null&&b!==void 0&&!isNaN(b)&&(w.push(E),S.push(b),y.push(-E*Math.sin(b*Math.PI/180)),v.push(-E*Math.cos(b*Math.PI/180)))}}if(w.length>0)if(t==="min_wind"){const M=Math.min(...w),_=w.indexOf(M);a[p][d]=M,a[f][d]=S[_]}else if(t==="max_wind"){const M=Math.max(...w),_=w.indexOf(M);a[p][d]=M,a[f][d]=S[_]}else{const M=y.reduce((E,b)=>E+b,0)/y.length,_=v.reduce((E,b)=>E+b,0)/v.length;a[p][d]=g.windSpeed(M,_),a[f][d]=g.windDirection(M,_)}});return{hourly:a}}function Qn(t,e,n=null){if(console.log(`Calculating exit circle for ensemble profile/model: ${t} at index ${e}`),e==null)return console.error("sliderIndex is undefined in calculateExitCircleForEnsemble. Aborting."),null;let a;if(n)a=n;else if(o.ensembleModelsData&&o.ensembleModelsData[t])a={hourly:o.ensembleModelsData[t]};else return console.warn(`No data for profile/model ${t} in calculateExitCircleForEnsemble found.`),null;if(!a.hourly||!o.lastLat||!o.lastLng||o.lastAltitude==="N/A")return console.warn(`Incomplete data for calculateExitCircleForEnsemble: ${t}`),null;const r=ke(),i=m.getValue("heightUnit","m"),s=o.weatherData;o.weatherData=a.hourly;let l=null,c={meanWindDir:"N/A",meanWindSpeedMps:"N/A"};try{const u=m.state.userSettings.calculateJump,d=m.state.userSettings.showExitArea;m.state.userSettings.calculateJump=!0,m.state.userSettings.showExitArea=!0;const h=Ne(o.weatherData,e,r,Math.round(o.lastAltitude),i);if(h&&h.length>0){l=Ei(h);const p=h.map(b=>b.height),f=h.map(b=>-g.convertWind(b.spd,"m/s","km/h")*Math.sin(b.dir*Math.PI/180)),y=h.map(b=>-g.convertWind(b.spd,"m/s","km/h")*Math.cos(b.dir*Math.PI/180)),v=parseInt(document.getElementById("openingAltitude")?.value)||1200,w=parseInt(document.getElementById("legHeightDownwind")?.value)||0,S=Math.round(o.lastAltitude),M=S+v-200,_=S+w,E=g.calculateMeanWind(p,f,y,_,M);E&&Number.isFinite(E[0])&&Number.isFinite(E[1])&&(c={meanWindDir:E[0],meanWindSpeedMps:E[1]})}m.state.userSettings.calculateJump=u,m.state.userSettings.showExitArea=d}catch(u){console.error(`Error in calculateExitCircle for profile ${t}:`,u),l=null}finally{o.weatherData=s}return l?{centerLat:l.darkGreenLat,centerLng:l.darkGreenLng,radius:l.darkGreenRadius,meanWindDir:c.meanWindDir,meanWindSpeedMps:c.meanWindSpeedMps}:(console.warn(`calculateExitCircle returned null for profile ${t}`),null)}function sl(t,e){if(Mn(),!o.ensembleModelsData||Object.keys(o.ensembleModelsData).length===0)return;const n=[];for(const w in o.ensembleModelsData)if(Object.hasOwnProperty.call(o.ensembleModelsData,w)){const S=o.ensembleModelsData[w],M=Qn(w,t,{hourly:S});M&&n.push({centerLat:M.centerLat,centerLng:M.centerLng,radius:M.radius})}if(n.length===0){console.warn("Could not calculate any circles for the heatmap.");return}const a=n.length,r=Math.ceil(a/2);let i=90,s=-90,l=180,c=-180;n.forEach(w=>{const S=w.radius/111320,M=w.radius/(111320*Math.cos(w.centerLat*Math.PI/180));i=Math.min(i,w.centerLat-S),s=Math.max(s,w.centerLat+S),l=Math.min(l,w.centerLng-M),c=Math.max(c,w.centerLng+M)});const u=25,d=u/111320,h=[],p=[],f=[];for(let w=i;w<=s;w+=d){const S=u/(111320*Math.cos(w*Math.PI/180));for(let M=l;M<=c;M+=S){let _=0;const E=L.latLng(w,M);for(const b of n)o.map.distance(E,L.latLng(b.centerLat,b.centerLng))<=b.radius&&_++;_>=1&&h.push([w,M]),_>=r&&p.push([w,M]),_===a&&f.push([w,M])}}const y=w=>{w.sort((E,b)=>E[0]-b[0]||E[1]-b[1]);const S=(E,b,T)=>(b[0]-E[0])*(T[1]-E[1])-(b[1]-E[1])*(T[0]-E[0]),M=[];for(const E of w){for(;M.length>=2&&S(M[M.length-2],M[M.length-1],E)<=0;)M.pop();M.push(E)}const _=[];for(let E=w.length-1;E>=0;E--){const b=w[E];for(;_.length>=2&&S(_[_.length-2],_[_.length-1],b)<=0;)_.pop();_.push(b)}return M.slice(0,-1).concat(_.slice(0,-1))};o.heatmapContourLayers=[];const v=(w,S)=>{if(w.length>2){const M=y(w),_=L.polygon(M,S).addTo(o.ensembleLayerGroup);o.heatmapContourLayers.push(_)}};v(h,{color:"red",weight:2,fillOpacity:.1,interactive:!1}),v(p,{color:"yellow",weight:2,fillOpacity:.15,interactive:!1}),v(f,{color:"green",weight:3,fillOpacity:.2,interactive:!1})}function bi(){return parseInt(document.getElementById("timeSlider")?.value)||0}const oe={dbName:"SkydivingTileCache",storeName:"tiles",db:null,async init(){return new Promise((t,e)=>{const n=indexedDB.open(this.dbName,1);n.onupgradeneeded=a=>{a.target.result.createObjectStore(this.storeName,{keyPath:"url"})},n.onsuccess=a=>{this.db=a.target.result,t()},n.onerror=a=>{console.error("IndexedDB initialization failed:",a),e(a)}})},async storeTile(t,e){return this.db||await this.init(),new Promise((n,a)=>{const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).put({url:t,blob:e,timestamp:Date.now()});s.onsuccess=()=>{console.log(`Stored tile: ${t}`),n(!0)},s.onerror=l=>{console.warn(`Failed to store tile: ${t}`,l),g.handleError("Failed to store some tiles. Try clearing cache."),a(l)}})},async getTile(t){return this.db||await this.init(),new Promise((e,n)=>{const r=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName),i=r.get(t);i.onsuccess=s=>{const l=s.target.result;if(l)e(l.blob);else{const c=[t.replace("https://tile.opentopomap.org","https://a.tile.opentopomap.org"),t.replace("https://tile.opentopomap.org","https://b.tile.opentopomap.org"),t.replace("https://tile.opentopomap.org","https://c.tile.opentopomap.org"),t.replace("https://tile.openstreetmap.org","https://a.tile.openstreetmap.org"),t.replace("https://tile.openstreetmap.org","https://b.tile.openstreetmap.org"),t.replace("https://tile.openstreetmap.org","https://c.tile.openstreetmap.org"),t.replace("https://basemaps.cartocdn.com","https://a.basemaps.cartocdn.com"),t.replace("https://basemaps.cartocdn.com","https://b.basemaps.cartocdn.com"),t.replace("https://basemaps.cartocdn.com","https://c.basemaps.cartocdn.com"),t.replace("https://basemaps.cartocdn.com","https://d.basemaps.cartocdn.com")];let u=null;for(const d of c){if(d===t)continue;const h=r.get(d);h.onsuccess=p=>{const f=p.target.result;f&&(u=f.blob,e(u))},h.onerror=()=>{}}setTimeout(()=>{u||e(null)},100)}},i.onerror=s=>{console.warn(`Failed to retrieve tile: ${t}`,s),n(s)}})},async clearCache(){return this.db||await this.init(),new Promise((t,e)=>{const r=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();r.onsuccess=()=>{console.log("Tile cache cleared"),t()},r.onerror=i=>{console.error("Failed to clear cache:",i),e(i)}})},async clearOldTiles(t=vn.MAX_AGE_DAYS){this.db||await this.init();const e=t*24*60*60*1e3;return new Promise((n,a)=>{const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).openCursor();let l=0,c=0;s.onsuccess=u=>{const d=u.target.result;if(d)Date.now()-d.value.timestamp>e&&(c+=d.value.blob.size||0,d.delete(),l++),d.continue();else{const h=c/1048576;console.log(`Cleared ${l} old tiles, freed ${h.toFixed(2)} MB`),n({deletedCount:l,deletedSizeMB:h})}},s.onerror=u=>{console.error("Failed to clear old tiles:",u),a(u)}})},async getCacheSize(){return this.db||await this.init(),new Promise((t,e)=>{const r=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).openCursor();let i=0,s=0;r.onsuccess=l=>{const c=l.target.result;if(c)try{const u=c.value.blob?.size||0;typeof u!="number"||isNaN(u)?console.warn(`Invalid blob size for tile: ${c.value.url}, size: ${u}`):(i+=u,s++),c.continue()}catch(u){console.warn(`Error processing tile during size calculation: ${c.value.url}`,u),c.continue()}else{const u=i/1048576;console.log(`Cache size calculation completed: ${u.toFixed(2)} MB, ${s} tiles`),t(u)}},r.onerror=l=>{console.error("Failed to calculate cache size:",l),e(l)}})},async migrateTiles(){return this.db||await this.init(),new Promise((t,e)=>{const a=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName),r=a.openCursor();let i=0;r.onsuccess=s=>{const l=s.target.result;if(l){const{url:c,blob:u,timestamp:d}=l.value,h=c.replace(/^(https?:\/\/[a-c]\.tile\.openstreetmap\.org)/,"https://tile.openstreetmap.org").replace(/^(https?:\/\/[a-d]\.basemaps\.cartocdn\.com)/,"https://basemaps.cartocdn.com").replace(/^(https?:\/\/[a-c]\.tile\.opentopomap\.org)/,"https://tile.opentopomap.org");c!==h&&(l.delete(),a.put({url:h,blob:u,timestamp:d}),i++),l.continue()}else console.log(`Migrated ${i} tiles to normalized URLs`),t()},r.onerror=s=>{console.error("Failed to migrate tiles:",s),e(s)}})}};L.TileLayer.Cached=L.TileLayer.extend({createTile(t,e){const n=document.createElement("img");L.DomEvent.on(n,"load",()=>{console.log("Tile loaded:",this.getTileUrl(t)),e(null,n)}),L.DomEvent.on(n,"error",()=>{console.warn("Tile error:",this.getTileUrl(t)),e(new Error("Failed to load tile"),n)});const a=this.getTileUrl(t);n.setAttribute("role","presentation");const r=a.replace(/^(https?:\/\/[a-c]\.tile\.openstreetmap\.org)/,"https://tile.openstreetmap.org").replace(/^(https?:\/\/[a-d]\.basemaps\.cartocdn\.com)/,"https://basemaps.cartocdn.com").replace(/^(https?:\/\/[a-c]\.tile\.opentopomap\.org)/,"https://tile.opentopomap.org");return!navigator.onLine&&(t.z<11||t.z>14)?(console.log(`Skipping tile request outside cached zoom levels (11–14): ${a}`),g.handleError("Offline: Zoom restricted to levels 11–14 for cached tiles."),e(new Error("Zoom level not cached"),n),n):(navigator.onLine?(n.src=a,fetch(a,{signal:AbortSignal.timeout(vn.FETCH_TIMEOUT_MS)}).then(i=>{if(!i.ok)throw new Error(`HTTP ${i.status}`);return i.blob()}).then(i=>{oe.storeTile(r,i).catch(s=>console.warn("Failed to cache tile during rendering:",r,s))}).catch(i=>{console.warn("Fetch error for tile during rendering:",a,i),oe.getTile(r).then(s=>{s?(n.src=URL.createObjectURL(s),console.log(`Tile loaded from cache (fallback): ${r}`)):e(i,n)}).catch(s=>{console.warn("Cache fallback error:",r,s),e(s,n)})})):oe.getTile(r).then(i=>{i?(n.src=URL.createObjectURL(i),console.log(`Tile loaded from cache: ${r}`)):(console.warn(`Tile not in cache: ${r}`),g.handleError("This area is not cached. Please cache more tiles while online."),e(new Error("Tile not in cache"),n))}).catch(i=>{console.warn("Cache error for offline tile:",r,i),g.handleError("This area is not cached. Please cache more tiles while online."),e(i,n)}),n)}});L.tileLayer.cached=function(t,e){return new L.TileLayer.Cached(t,e)};function ll(t,e,n,a,r){if(!r)return console.warn("Map not initialized, cannot calculate tiles"),[];const i=new Set,s=40075016686e-3,l=n*1e3;return a.forEach(c=>{const u=r.project([t,e],c),d=256,h=u.x/d,p=u.y/d,f=t*Math.PI/180,y=s*Math.cos(f)/(d*Math.pow(2,c)),v=Math.ceil(l/(y*d))+1,w=Math.pow(2,c);for(let S=Math.floor(h-v);S<=Math.ceil(h+v);S++)for(let M=Math.floor(p-v);M<=Math.ceil(p+v);M++)S>=0&&S<w&&M>=0&&M<w&&i.add(`${c}/${S}/${M}`)}),Array.from(i).map(c=>{const[u,d,h]=c.split("/").map(Number);return{zoom:u,x:d,y:h}})}async function cl(t,e=3){let n=null;for(let a=1;a<=e;a++){try{const r=new AbortController,i=setTimeout(()=>r.abort(),vn.FETCH_TIMEOUT_MS),s=await fetch(t,{signal:r.signal});if(clearTimeout(i),s.ok)return{success:!0,blob:await s.blob()};console.warn(`Attempt ${a} failed for ${t}: HTTP ${s.status}`),n=new Error(`HTTP ${s.status}`)}catch(r){console.warn(`Attempt ${a} error for ${t}: ${r.message}`),n=r,r.name==="AbortError"&&console.warn(`Fetch timeout after 15s for ${t}`)}a<e&&await new Promise(r=>setTimeout(r,1e3))}return{success:!1,error:n}}async function _i({map:t,lastLat:e,lastLng:n,baseMaps:a,onProgress:r,onComplete:i,onCancel:s,radiusKm:l=null,silent:c=!1}){if(!t){i&&!c&&i("Map not initialized, cannot cache tiles.");return}if(!e||!n){i&&!c&&i("Please select a location to cache map tiles.");return}const u=l!==null?l:m.state.userSettings.cacheRadiusKm||m.defaultSettings.cacheRadiusKm,d=m.state.userSettings.cacheZoomLevels||m.defaultSettings.cacheZoomLevels,h=ll(e,n,u,d,t),p=[];if(m.state.userSettings.baseMaps==="Esri Satellite + OSM")p.push({name:"Esri Satellite",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",normalizedUrl:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"},{name:"OSM Overlay",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",subdomains:["a","b","c"],normalizedUrl:"https://tile.openstreetmap.org/{z}/{x}/{y}.png"});else{const M=a[m.state.userSettings.baseMaps];M&&p.push({name:m.state.userSettings.baseMaps,url:M.options.url||M._url,subdomains:M.options.subdomains,normalizedUrl:(M.options.url||M._url).replace(/{s}\./,"")})}const f=h.length*p.length;if(f===0){i&&!c&&i("No tiles to cache for this basemap.");return}let y=0,v=0;const w=[];o.isCachingCancelled=!1,r&&!c&&r(0,f,()=>{o.isCachingCancelled=!0,s&&s()});try{for(const M of p){if(console.log("Processing layer:",M.name),o.isCachingCancelled){console.log("Caching cancelled by user");break}const _=h.map(async(E,b)=>{if(o.isCachingCancelled){console.log("Caching cancelled during tile processing");return}const T=M.url.replace("{z}",E.zoom).replace("{x}",E.x).replace("{y}",E.y).replace("{s}",M.subdomains?M.subdomains[Math.floor(Math.random()*M.subdomains.length)]:""),k=M.normalizedUrl.replace("{z}",E.zoom).replace("{x}",E.x).replace("{y}",E.y);if(console.log(`Processing tile ${b+1}/${h.length} for layer ${M.name}:`,{url:T,normalizedUrl:k}),await oe.getTile(k).catch(I=>(console.error(`Error retrieving tile from cache: ${k}`,I),null)))y++,console.log(`Tile ${b+1} already in cache`);else{const I=await cl(T);I.success?await oe.storeTile(k,I.blob).catch($=>(console.error(`Error storing tile: ${k}`,$),!1))?(y++,console.log(`Tile ${b+1} cached successfully`)):(v++,w.push(T),console.log(`Tile ${b+1} failed to store`)):(v++,w.push(T),console.log(`Tile ${b+1} failed to fetch:`,I.error.message))}const P=y+v;((b+1)%10===0||b===h.length-1)&&r&&!c&&r(P,f,()=>{o.isCachingCancelled=!0})});console.log(`Processing batch of ${h.length} tiles for layer ${M.name}`);for(let E=0;E<_.length;E+=20){if(o.isCachingCancelled){console.log("Caching cancelled during batch processing");break}const b=_.slice(E,E+20);await Promise.all(b).catch(T=>{console.error("Error processing batch of tiles:",T)}),console.log(`Completed batch ${E/20+1} for layer ${M.name}`)}}}catch(M){console.error("Unexpected error in cacheTilesForDIP:",M),g.handleError("Failed to cache map tiles: "+M.message)}finally{if(console.log("Hiding progress bar"),i){let M="";o.isCachingCancelled?M=`Caching cancelled: ${y} tiles cached, ${v} failed.`:v>0?M=`Cached ${y} tiles around DIP (${v} failed).`:M=`Cached ${y} tiles around DIP successfully.`,i(M)}}w.length>0&&console.warn(`Failed to cache ${w.length} tiles:`,w),console.log(`DIP caching complete: ${y} tiles cached, ${v} failed`);let S="";o.isCachingCancelled?S=`Caching cancelled: ${y} tiles cached, ${v} failed.`:v>0?S=`Cached ${y} tiles around DIP (${v} failed).`:S=`Cached ${y} tiles around DIP successfully.`,i&&i(S);try{const M=await oe.getCacheSize();console.log(`Cache size after DIP caching: ${M.toFixed(2)} MB`),M>vn.SIZE_LIMIT_MB_WARNING&&g.handleError(`Cache size large (${M.toFixed(2)} MB). Consider clearing cache to free up space.`)}catch(M){console.error("Failed to check cache size after DIP caching:",M),g.handleError("Unable to check cache size. Consider clearing cache to free up space.")}}async function Ma({map:t,baseMaps:e,onProgress:n,onComplete:a,onCancel:r}){if(!t||!navigator.onLine){console.log("Skipping visible tile caching: offline or map not initialized");return}const i=t.getBounds(),s=t.getZoom(),l=m.state.userSettings.cacheZoomLevels||m.defaultSettings.cacheZoomLevels;if(!l.includes(s)){console.log(`Skipping caching: zoom ${s} not in cacheZoomLevels`,l);return}const c=256,u=t.project(i.getSouthWest(),s),d=t.project(i.getNorthEast(),s),h=Math.floor(u.x/c),p=Math.floor(d.x/c),f=Math.floor(d.y/c),y=Math.floor(u.y/c),v=[];for(let E=h;E<=p;E++)for(let b=f;b<=y;b++){const T=2**s;E>=0&&E<T&&b>=0&&b<T&&v.push({zoom:s,x:E,y:b})}console.log(`Caching ${v.length} visible tiles at zoom ${s} for ${m.state.userSettings.baseMaps}`);const w=[];if(!e[m.state.userSettings.baseMaps]){console.warn(`Base map ${m.state.userSettings.baseMaps} not found, skipping caching`),a&&a("Selected base map not available for caching.");return}if(m.state.userSettings.baseMaps==="Esri Satellite + OSM")w.push({name:"Esri Satellite",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",normalizedUrl:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"},{name:"OSM Overlay",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",subdomains:["a","b","c"],normalizedUrl:"https://tile.openstreetmap.org/{z}/{x}/{y}.png"});else{const E=e[m.state.userSettings.baseMaps];w.push({name:m.state.userSettings.baseMaps,url:E.options.url||E._url,subdomains:E.options.subdomains,normalizedUrl:(E.options.url||E._url).replace(/{s}\./,"")})}let S=0,M=0;const _=v.length*w.length;o.isCachingCancelled=!1,n&&n(0,_,()=>{o.isCachingCancelled=!0,r&&r()});for(const E of w){if(o.isCachingCancelled)break;const b=v.map(async(T,k)=>{n&&n(S+M,_,()=>{o.isCachingCancelled=!0,r&&r()})});await Promise.all(b)}a&&a("Visible tiles cached.")}function Le(){const t="ontouchstart"in window||navigator.maxTouchPoints>0,e=window.Capacitor&&window.Capacitor.isNativePlatform();return t||e}function ul(){Le()&&document.body.classList.add("touch-device")}function He(t){console.log("displayMessage called with:",t);let e=document.getElementById("message");e||(e=document.createElement("div"),e.id="message",e.style.position="fixed",e.style.top="5px",e.style.right="5px",e.style.width=Le()?"70%":"30%",e.style.backgroundColor="#ccffcc",e.style.borderRadius="5px 5px 5px 5px",e.style.color="#000000",e.style.padding="6px",e.style.zIndex="9998",e.style.textAlign="center",document.body.appendChild(e),window.addEventListener("resize",()=>{e.style.width=Le()?"70%":"30%"})),e.textContent=t,e.style.display="block",clearTimeout(window.messageTimeout),window.messageTimeout=setTimeout(()=>{e.style.display="none"},ve.MESSAGE_TIMEOUT_MS)}function $t(t,e,n){const a=Math.round(t/e*100);let r=document.getElementById("progress");r||(r=document.createElement("div"),r.id="progress",r.style.position="fixed",r.style.top="5px",r.style.right="5px",r.style.width=Le()?"70%":"30%",r.style.backgroundColor="#ccffcc",r.style.borderRadius="5px 5px 5px 5px",r.style.color="#000000",r.style.padding="6px",r.style.zIndex="9998",r.style.display="flex",r.style.alignItems="center",r.style.gap="10px",document.body.appendChild(r),window.addEventListener("resize",()=>{r.style.width=Le()?"70%":"30%"}));const i=document.createElement("div");i.style.flex="1",i.style.display="flex",i.style.flexDirection="column",i.style.gap="3px";const s=document.createElement("div");s.textContent=`Caching (${t}/${e}, ${a}%)`,s.style.fontSize="12px",s.style.textAlign="center";const l=document.createElement("div");l.style.width="100%",l.style.height="8px",l.style.backgroundColor="#e0e0e0",l.style.borderRadius="3px",l.style.overflow="hidden";const c=document.createElement("div");c.style.width=`${a}%`,c.style.height="100%",c.style.backgroundColor="#4caf50",c.style.transition="width 0.3s ease-in-out",l.appendChild(c),i.appendChild(s),i.appendChild(l);let u=document.getElementById("cancel-caching");u||(u=document.createElement("button"),u.id="cancel-caching",u.textContent="Cancel",u.style.backgroundColor="#ff4444",u.style.color="#ffffff",u.style.border="none",u.style.borderRadius="3px",u.style.padding="5px 3px",u.style.cursor="pointer",u.style.fontSize="12px",u.addEventListener("click",()=>{n(),r.style.display="none",g.handleMessage("Caching cancelled.")})),r.innerHTML="",r.appendChild(i),r.appendChild(u),r.style.display="flex"}function We(){const t=document.getElementById("progress");t&&(t.style.display="none")}function ea(){console.log("updateOfflineIndicator called, navigator.onLine:",navigator.onLine);let t=document.getElementById("offline-indicator");t||(t=document.createElement("div"),t.id="offline-indicator",document.body.appendChild(t),console.log("Offline indicator created and appended")),t.style.display=navigator.onLine?"none":"block",t.textContent="Offline Mode"}function dn(t){console.log("displayError called with:",t);let e=document.getElementById("error-message");e||(e=document.createElement("div"),e.id="error-message",document.body.appendChild(e),window.addEventListener("resize",()=>{e.style.width=Le()?"70%":"30%"})),e.textContent=t,e.style.display="block",console.log("Error element state:",{display:e.style.display,text:e.textContent,position:e.style.position,zIndex:e.style.zIndex}),clearTimeout(window.errorTimeout),window.errorTimeout=setTimeout(()=>{e.style.display="none",console.log("Error hidden after 3s")},ve.MESSAGE_TIMEOUT_MS)}function Y(){return parseInt(document.getElementById("timeSlider")?.value)||0}function dl(t){const e=document.getElementById("modelSelect");if(!e)return;const n=e.value;e.innerHTML="",t.forEach(a=>{const r=document.createElement("option");r.value=a,r.textContent=a.replace(/_/g," ").toUpperCase(),e.appendChild(r)}),t.includes(m.state.userSettings.model)?e.value=m.state.userSettings.model:t.includes(n)?e.value=n:t.length>0&&(e.value=t[0])}function ml(t){let e=m.state.userSettings.selectedEnsembleModels||[],n=e.filter(a=>t.includes(a));e.length!==n.length&&(m.state.userSettings.selectedEnsembleModels=n,m.save())}let Xt=0;async function hl(){return console.log("MapManager: Starte Karteninitialisierung..."),await fl(),console.log("MapManager: Karteninitialisierung abgeschlossen."),o.map}async function fl(){if(o.ismapInitialized||o.map){console.warn("Map already initialized or init in progress.");return}o.ismapInitialized=!0,console.log("initMap started...");const t=ve.DEFAULT_MAP_CENTER,e=ve.DEFAULT_MAP_ZOOM;gl(t,e),o.jumpVisualizationLayerGroup=L.layerGroup().addTo(o.map),o.landingPatternLayerGroup=L.layerGroup().addTo(o.map),o.jumpRunTrackLayerGroup=L.layerGroup().addTo(o.map),o.favoritesLayerGroup=L.layerGroup().addTo(o.map),console.log("Favorite marker layer added!"),pl(),yl(),wl(),vl(t),_l(),Promise.all([Ll(),Sl(t,e)]).then(()=>{console.log("Initial tile caching and geolocation promise resolved.")}).catch(n=>{console.error("Error during parallel initialization of cache/geolocation:",n)}),ea(),console.log("initMap finished.")}function gl(t,e){o.lastLat=o.lastLat||t[0],o.lastLng=o.lastLng||t[1],o.map=L.map("map",{center:t,zoom:e,zoomControl:!1,doubleClickZoom:!1,maxZoom:19,minZoom:navigator.onLine?6:11}),console.log("Map instance created.")}function pl(){o.baseMaps={OpenStreetMap:L.tileLayer.cached("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:["a","b","c"]}),OpenTopoMap:L.tileLayer.cached("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{maxZoom:17,attribution:'© <a href="https://www.openstreetmap.org/copyright">OSM</a>, <a href="https://opentopomap.org">OpenTopoMap</a> (CC-BY-SA)',subdomains:["a","b","c"]}),"Esri Satellite":L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USDA, USGS"}),"Esri Street":L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USGS"}),"Esri Topo":L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USGS"}),"Esri Satellite + OSM":L.layerGroup([L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USDA, USGS",zIndex:1}),L.tileLayer.cached("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',opacity:.5,zIndex:2,updateWhenIdle:!0,keepBuffer:2,subdomains:["a","b","c"]})],{attribution:'© Esri, USDA, USGS | © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'})},o.map&&o.map.attributionControl&&o.map.attributionControl.addAttribution('Weather data by <a href="https://open-meteo.com">Open-Meteo</a>');const e=m.state.userSettings.baseMaps in o.baseMaps?m.state.userSettings.baseMaps:"Esri Street",n=o.baseMaps[e];n&&typeof n.on=="function"?(n.on("tileerror",()=>{if(!navigator.onLine){o.hasTileErrorSwitched||(console.warn(`${e} tiles unavailable offline. Zoom restricted.`),g.handleMessage("Offline: Zoom restricted to levels 11–14 for cached tiles."),o.hasTileErrorSwitched=!0);return}if(!o.hasTileErrorSwitched&&o.map.hasLayer(n)){const a="OpenStreetMap";console.warn(`${e} tiles unavailable, switching to ${a}`),o.map.removeLayer(n),o.baseMaps[a].addTo(o.map),m.state.userSettings.baseMaps=a,m.save(),g.handleMessage(`${e} tiles unavailable. Switched to ${a}.`),o.hasTileErrorSwitched=!0}else o.hasTileErrorSwitched||console.warn(`Tile error in ${e}, attempting to continue.`)}),n.addTo(o.map)):(console.error(`Default base map "${e}" could not be added.`),o.baseMaps.OpenStreetMap.addTo(o.map)),o.map&&o.map.invalidateSize(),window.addEventListener("online",()=>{o.hasTileErrorSwitched=!1,o.map&&(o.map.options.minZoom=6),ea()}),window.addEventListener("offline",()=>{o.map&&(o.map.options.minZoom=9),ea()}),console.log("Base layers and online/offline handlers set up.")}function yl(){if(!o.map){console.error("Karte nicht initialisiert, bevor Controls hinzugefügt werden können.");return}L.control.layers(o.baseMaps,null,{position:"topright"}).addTo(o.map),o.map.on("baselayerchange",function(t){m&&m.state&&m.state.userSettings&&(m.state.userSettings.baseMaps=t.name,m.save()),o.hasTileErrorSwitched=!1,o.lastLat&&o.lastLng&&typeof cacheTilesForDIP=="function"&&cacheTilesForDIP({map:o.map,lastLat:o.lastLat,lastLng:o.lastLng,baseMaps:o.baseMaps})}),L.control.zoom({position:"topright"}).addTo(o.map),L.control.scale({position:"bottomleft",metric:!0,imperial:!1,maxWidth:100}).addTo(o.map),o.map.pm.addControls({position:"topright",drawMarker:!0,drawCircleMarker:!1,drawPolyline:!0,drawPolygon:!1,drawRectangle:!1,drawCircle:!0,cutPolygon:!1,editMode:!0,dragMode:!0,removalMode:!0,rotateMode:!1}),o.map.pm.setLang("en"),console.log("Standard map controls including Geoman have been added.")}function wl(){o.map.createPane("gpxTrackPane"),o.map.getPane("gpxTrackPane").style.zIndex=650,o.map.getPane("tooltipPane").style.zIndex=700,o.map.getPane("popupPane").style.zIndex=700,console.log("Custom map panes created.")}async function vl(t,e){console.log("MapManager: Initialisiere den Standard-Marker..."),await Sn(t[0],t[1]),o.isManualPanning=!1,console.log("Default marker initialized using the new standard method.")}async function Ll(){try{if(await oe.init(),await oe.migrateTiles(),await oe.getCacheSize()>500){const e=await oe.clearOldTiles(3);g.handleMessage(`Cleared ${e.deletedCount} old tiles: ${e.deletedSizeMB.toFixed(2)} MB freed.`)}else await oe.clearOldTiles()}catch(t){console.error("Failed to initialize or manage tile cache:",t),g.handleError("Tile caching setup failed.")}console.log("Tile cache logic initialized.")}async function Ml(t,e){const{latitude:n,longitude:a}=t.coords;console.log("MapManager: Geolocation erfolgreich. Sende Event."),o.lastLat=n,o.lastLng=a,o.lastAltitude=await g.getAltitude(n,a),o.map.setView([n,a],e);const r=new CustomEvent("location:selected",{detail:{lat:n,lng:a,source:"geolocation"},bubbles:!0,cancelable:!0});o.map.getContainer().dispatchEvent(r)}async function or(t,e,n){console.warn(`Geolocation error: ${t.message}`),g.handleMessage("Unable to retrieve your location. Using default location."),await Sn(e[0],e[1]),o.map.setView(e,n),mn(!0),o.isManualPanning=!1;const a=new CustomEvent("location:selected",{detail:{lat:e[0],lng:e[1],source:"geolocation_fallback"},bubbles:!0,cancelable:!0});o.map.getContainer().dispatchEvent(a),console.log("Dispatched 'location:selected' event from geolocation fallback.")}async function Sl(t,e){navigator.geolocation?navigator.geolocation.getCurrentPosition(n=>Ml(n,e),n=>or(n,t,e),{enableHighAccuracy:!0,timeout:ve.GEOLOCATION_TIMEOUT_MS,maximumAge:0}):(console.warn("Geolocation not supported."),await or({message:"Geolocation not supported by this browser."},t,e))}function El(){const t=o.map;if(!t){console.log("No map available");return}console.log("Leaflet-Geoman Version:",L.PM.version);const e=document.querySelector(".leaflet-pm-toolbar");e&&e.addEventListener("mousedown",f=>{L.DomEvent.stopPropagation(f)});const n=L.DomUtil.create("div","leaflet-measure-label",t.getContainer()),a=L.layerGroup().addTo(t);let r=null,i=null,s=null,l=!1;function c(f,y){const v=f[y],w=y>0?f[y-1]:null;if(!w)return;const S=y<f.length-1?f[y+1]:null,M=g.calculateBearing(w.lat,w.lng,v.lat,v.lng),_=w.distanceTo(v),E=_<1e3?`${_.toFixed(0)} m`:`${(_/1e3).toFixed(2)} km`;let b=0;for(let I=1;I<=y;I++)b+=f[I-1].distanceTo(f[I]);const T=b<1e3?`${b.toFixed(0)} m`:`${(b/1e3).toFixed(2)} km`,k=S?`${g.calculateBearing(v.lat,v.lng,S.lat,S.lng).toFixed(0)}°`:"---",A=`
            <div class="geoman-permanent-label">
                <div>In: ${M.toFixed(0)}°</div>
                <div>Out: ${k}</div>
                <div>+: ${E}</div>
                <div>∑: ${T}</div>
            </div>
        `;L.marker(v,{icon:L.divIcon({className:"geoman-label-container",html:A,iconAnchor:[-5,-5]}),pmIgnore:!0}).addTo(a)}function u(f){const y=f.getLatLng(),v=f.getRadius(),S=`<div class="geoman-permanent-label">Radius:<br> ${v<1e3?`${v.toFixed(0)} m`:`${(v/1e3).toFixed(2)} km`}</div>`,M=L.marker(y,{icon:L.divIcon({className:"geoman-label-container",html:S,iconAnchor:[0,0]}),pmIgnore:!0});M.addTo(a),f.permanentLabel=M}function d(f){if(!f||!(f instanceof L.Polyline))return;a.clearLayers();const y=f.getLatLngs();Array.isArray(y[0])?y.forEach(v=>{v.forEach((w,S)=>c(v,S))}):y.forEach((v,w)=>c(y,w)),r=JSON.stringify(y),s=f}function h(f){!f||!(f instanceof L.Circle)||(f.permanentLabel&&a.removeLayer(f.permanentLabel),u(f))}function p(){setInterval(()=>{if(s){if(s instanceof L.Polyline)JSON.stringify(s.getLatLngs())!==r&&d(s);else if(s instanceof L.Circle){const f=JSON.stringify({center:s.getLatLng(),radius:s.getRadius()});f!==i&&(h(s),i=f)}}},500)}p(),t.on("pm:drawstart",f=>{l=!1;const y=f.workingLayer;a.clearLayers(),n.style.display="block";let v,w,S,M,_;if(f.shape==="Line")if(Le()){n.innerHTML="Tap to set first point.";let b=null,T=null;M=()=>{const k=y.getLatLngs();if(k.length>0){b=k[k.length-1];const A=t.getCenter();T&&t.removeLayer(T),T=L.polyline([b,A],{color:" #3388ff",dashArray:"5, 5",weight:3,interactive:!1}).addTo(t);const P=b.distanceTo(A),I=g.calculateBearing(b.lat,b.lng,A.lat,A.lng),D=P<1e3?`${P.toFixed(0)} m`:`${(P/1e3).toFixed(2)} km`;n.innerHTML=`In: ${I.toFixed(0)}°<br>Out: ---°<br>+: ${D}`;const $=t.getSize(),O=L.point($.x/2+20,$.y/2-40);L.DomUtil.setPosition(n,O)}else T&&(t.removeLayer(T),T=null),n.innerHTML="Tap to set first point."},w=()=>{T&&(t.removeLayer(T),T=null),setTimeout(()=>{d(y),t.fire("move")},50)},S=()=>{setTimeout(()=>{d(y),t.fire("move")},50)},t.on("move",M),y.on("pm:vertexadded",w),y.on("pm:vertexremoved",S),_=()=>{t.off("move",M),y.off("pm:vertexadded",w),y.off("pm:vertexremoved",S),T&&(t.removeLayer(T),T=null)}}else n.innerHTML="Click to set the first point.",v=b=>{const T=y.getLatLngs();if(T.length>0){const k=T[T.length-1],A=k.distanceTo(b.latlng),P=g.calculateBearing(k.lat,k.lng,b.latlng.lat,b.latlng.lng),I=A<1e3?`${A.toFixed(0)} m`:`${(A/1e3).toFixed(2)} km`;n.innerHTML=`In: ${P.toFixed(0)}°<br>Out: ---°<br>+: ${I}`,L.DomUtil.setPosition(n,b.containerPoint.add([15,-15]))}},w=()=>{setTimeout(()=>d(y),50)},S=()=>{setTimeout(()=>{d(y)},50)},t.on("mousemove",v),y.on("pm:vertexadded",w),y.on("pm:vertexremoved",S),_=()=>{t.off("mousemove",v),y.off("pm:vertexadded",w),y.off("pm:vertexremoved",S)};else if(f.shape==="Circle")if(Le()){n.innerHTML="";const b=t.getSize(),T=L.point(b.x/2,b.y/2-40);L.DomUtil.setPosition(n,T);let k=!1;M=()=>{if(k){const A=y.getLatLng();if(A){const P=t.getCenter(),I=A.distanceTo(P);y.setRadius(I);const D=I<1e3?`${I.toFixed(0)} m`:`${(I/1e3).toFixed(2)} km`;n.innerHTML=`Radius: ${D}`;const $=t.getSize(),O=L.point($.x/2,$.y/2-40);L.DomUtil.setPosition(n,O)}}},w=()=>{if(k)E(),h(y),s=y,i=JSON.stringify({center:y.getLatLng(),radius:y.getRadius()});else{k=!0,n.innerHTML="Move map to adjust radius. Tap again to finish.";const A=t.getSize(),P=L.point(A.x/2,A.y/2-40);L.DomUtil.setPosition(n,P),t.on("move",M)}},y.on("pm:vertexadded",w),_=()=>{t.off("move",M),y.off("pm:vertexadded",w),k=!1,n.style.display="none"}}else n.innerHTML="Click and drag to draw a circle.",v=b=>{const T=y.getLatLng();if(T){const k=T.distanceTo(b.latlng),A=k<1e3?`${k.toFixed(0)} m`:`${(k/1e3).toFixed(2)} km`;n.innerHTML=`Radius: ${A}`,L.DomUtil.setPosition(n,b.containerPoint.add([15,-15]))}},t.on("mousemove",v),_=()=>t.off("mousemove",v);const E=()=>{_&&_(),n.style.display="none"};t.once("pm:create",b=>{l=!0,E(),b.shape==="Line"&&b.layer instanceof L.Polyline?d(b.layer):b.shape==="Circle"&&b.layer instanceof L.Circle&&(h(b.layer),s=b.layer,i=JSON.stringify({center:b.layer.getLatLng(),radius:b.layer.getRadius()})),b.layer.pm&&b.layer.pm.enable()}),t.once("pm:drawend",()=>{l||(console.log("Drawing was cancelled, cleaning up visuals."),E(),a.clearLayers())})}),t.on("pm:edit",f=>{if(f.shape==="Line"&&f.layer instanceof L.Polyline)setTimeout(()=>d(f.layer),300);else if(f.shape==="Circle"&&f.layer instanceof L.Circle){if(Le()){n.style.display="block";const y=f.layer.getRadius(),v=y<1e3?`${y.toFixed(0)} m`:`${(y/1e3).toFixed(2)} km`;n.innerHTML=`Radius: ${v}`;const w=t.getSize(),S=L.point(w.x/2,w.y/2-40);L.DomUtil.setPosition(n,S)}setTimeout(()=>{h(f.layer),s=f.layer,i=JSON.stringify({center:f.layer.getLatLng(),radius:f.layer.getRadius()})},300)}}),t.on("pm:editend",()=>{Le()&&(n.style.display="none")}),t.on("pm:remove",f=>{a.clearLayers(),i=null,r=null,s=null,n.style.display="none"})}function bl(t){const{lat:e,lng:n}=t.latlng;o.lastMouseLatLng={lat:e,lng:n};const a=m.getValue("coordFormat","radio","Decimal");let r;if(a==="MGRS")r=`MGRS: ${g.decimalToMgrs(e,n)||"N/A"}`;else if(a==="DMS"){const i=s=>`${s.deg}°${s.min}'${s.sec.toFixed(0)}" ${s.dir}`;r=`Lat: ${i(g.decimalToDms(e,!0))}, Lng: ${i(g.decimalToDms(n,!1))}`}else r=`Lat: ${e.toFixed(5)}, Lng: ${n.toFixed(5)}`;o.coordsControl&&o.coordsControl.update(`${r}<br>Elevation: Fetching...<br>QFE: Fetching...`),g.debouncedGetElevationAndQFE(e,n,({elevation:i})=>{if(o.lastMouseLatLng&&o.coordsControl&&Math.abs(o.lastMouseLatLng.lat-e)<.05&&Math.abs(o.lastMouseLatLng.lng-n)<.05){const s=m.getValue("heightUnit","radio","m");let l=i==="N/A"?"N/A":Math.round(g.convertHeight(i,s)),c="N/A";if(i!=="N/A"&&o.weatherData&&o.weatherData.surface_pressure){const u=parseInt(document.getElementById("timeSlider")?.value)||0,d=o.weatherData.surface_pressure[u],h=o.weatherData.temperature_2m?.[u]||15,p=o.lastAltitude!=="N/A"?o.lastAltitude:0,f=g.calculateQFE(d,i,p,h);c=f!=="N/A"?`${f} hPa`:"N/A"}o.coordsControl.update(`${r}<br>Elevation: ${l} ${l==="N/A"?"":s}<br>QFE: ${c}`)}})}function _l(){if(!o.map){console.error("Karte nicht initialisiert in _setupCoreMapEventHandlers");return}if(!o.coordsControl){const e={enableUserInput:!1};o.coordsControl=new L.Control.Coordinates(e),o.coordsControl.addTo(o.map)}Le()?kl(o.map):Tl(o.map),o.map.on("dblclick",Rn),o.map.on("zoomstart",e=>{if(!navigator.onLine){const n=e.target._zoom||o.map.getZoom();n<11?(e.target._zoom=11,o.map.setZoom(11),g.handleMessage("Offline: Zoom restricted to levels 11–14 for cached tiles.")):n>14&&(e.target._zoom=14,o.map.setZoom(14),g.handleMessage("Offline: Zoom restricted to levels 11–14 for cached tiles."))}}),o.map.on("zoomend",()=>{const e=o.map.getZoom(),n=new CustomEvent("map:zoomend",{detail:{zoom:e},bubbles:!0,cancelable:!0});if(o.map.getContainer().dispatchEvent(n),o.jumpRunTrackLayer&&m.state.userSettings.showJumpRunTrack){const a=o.jumpRunTrackLayer.getLayers().find(r=>r.options.icon?.options.className==="jrt-anchor-marker");if(a){const r=e<=11?10:e<=12?12:e<=13?14:16;a.setIcon(L.divIcon({className:"jrt-anchor-marker",html:`<div style="background-color: orange; width: ${r}px; height: ${r}px; border-radius: 50%; border: 2px solid white; opacity: 0.8;"></div>`,iconSize:[r,r],iconAnchor:[r/2,r/2],tooltipAnchor:[0,-(r/2+5)]}))}}}),o.map.on("movestart",e=>{e.target===o.map&&(!e.originalEvent||e.originalEvent.target===o.map.getContainer())&&(o.isManualPanning=!0,console.log("Manual map panning detected."))}),o.map.on("contextmenu",e=>{const{lat:n,lng:a}=e.latlng;console.log('MapManager: Rechtsklick/Langes Drücken erkannt. Sende "location:selected"-Event.');const r=new CustomEvent("location:selected",{detail:{lat:n,lng:a,source:"contextmenu"},bubbles:!0,cancelable:!0});o.map.getContainer().dispatchEvent(r)});const t=o.map.getContainer();t.addEventListener("touchstart",async e=>{if(e.touches.length!==1||e.target.closest(".leaflet-marker-icon"))return;const n=new Date().getTime(),a=n-Xt;if(a<300&&a>0){e.preventDefault();const i=t.getBoundingClientRect(),s=e.touches[0].clientX-i.left,l=e.touches[0].clientY-i.top,c=o.map.containerPointToLatLng([s,l]);await Rn({latlng:c,containerPoint:L.point(s,l),layerPoint:o.map.latLngToLayerPoint(c)})}Xt=n},{passive:!1}),o.map.on("click",e=>{}),o.map.on("mousedown",e=>{}),t.addEventListener("touchstart",async e=>{if(e.touches.length!==1||e.target.closest(".leaflet-marker-icon"))return;const n=new Date().getTime(),a=n-Xt;if(a<300&&a>0){e.preventDefault();const i=t.getBoundingClientRect(),s=e.touches[0].clientX-i.left,l=e.touches[0].clientY-i.top,c=o.map.containerPointToLatLng([s,l]);await Rn({latlng:c,containerPoint:L.point(s,l),layerPoint:o.map.latLngToLayerPoint(c)})}Xt=n},{passive:!1}),El(),console.log("All core map event handlers have been set up.")}function kl(t){const e=({elevation:a},r)=>{const i=t.getCenter();if(Math.abs(i.lat-r.lat)>1e-4||Math.abs(i.lng-r.lng)>1e-4)return;const l=o.coordsControl._container.innerHTML.split("<br>")[0],c=m.getValue("heightUnit","radio","m");let u="N/A";if(a!=="N/A"){const f=g.convertHeight(a,c);u=Math.round(f)}const d=u==="N/A"?"N/A":`${u}${c}`;let h="N/A";if(a!=="N/A"&&o.weatherData&&o.weatherData.surface_pressure){const f=parseInt(document.getElementById("timeSlider")?.value)||0,y=o.weatherData.surface_pressure[f],v=o.weatherData.temperature_2m?.[f]||15,w=o.lastAltitude!=="N/A"?o.lastAltitude:0,S=g.calculateQFE(y,a,w,v);h=S!=="N/A"?`${S} hPa`:"N/A"}const p=`${l}<br>Elevation: ${d}<br>QFE: ${h}`;o.coordsControl.update(p)},n=()=>{const a=t.getCenter(),r=m.getValue("coordFormat","radio","Decimal"),i=g.convertCoords(a.lat,a.lng,r),s=r==="MGRS"?`MGRS: ${i.lat}`:`${a.lat.toFixed(5)}, ${a.lng.toFixed(5)}`;o.coordsControl.update(`${s}<br>Elevation: ...<br>QFE: ...`),g.debouncedGetElevationAndQFE(a.lat,a.lng,l=>{e(l,a)})};t.on("move",n),setTimeout(()=>t.fire("move"),200),console.log("Crosshair coordinate handler initialized.")}function Tl(t){t.on("mousemove",bl),t.on("mouseout",function(){o.coordsControl&&o.coordsControl.getContainer()&&(o.coordsControl.getContainer().innerHTML="Move mouse over map")}),console.log("Mouse coordinate handler initialized.")}function Rn(t){if(!m.state.userSettings.showCutAwayFinder)return;const{lat:e,lng:n}=t.latlng;o.cutAwayMarker?o.cutAwayMarker.setLatLng([e,n]):(o.cutAwayMarker=Pl(e,n).addTo(o.map),Dl(o.cutAwayMarker)),o.cutAwayLat=e,o.cutAwayLng=n,ki(o.cutAwayMarker,e,n);const a=new CustomEvent("cutaway:marker_placed",{bubbles:!0});o.map.getContainer().dispatchEvent(a)}function rn(t){if(Al(),o.labelZoomListener&&o.map&&(o.map.off("zoomend",o.labelZoomListener),o.labelZoomListener=null),!t||!o.jumpVisualizationLayerGroup)return;const e=[];t.exitCircles&&t.exitCircles.forEach(a=>{const r=L.circle(a.center,{radius:a.radius,color:a.color,fillColor:a.fillColor,fillOpacity:a.fillOpacity,weight:a.weight||2,pmIgnore:!0}).addTo(o.jumpVisualizationLayerGroup);a.tooltip&&r.bindTooltip(a.tooltip,{direction:"top",offset:[0,0],className:"wind-tooltip"})}),t.canopyCircles&&t.canopyCircles.forEach(a=>{L.circle(a.center,{...a,pmIgnore:!0}).addTo(o.jumpVisualizationLayerGroup)});function n(a,r){const i=L.latLng(a[0],a[1]),l=r/6378137*(180/Math.PI),c=L.latLng(a[0]+l,a[1]),u=o.map.latLngToLayerPoint(i),d=o.map.latLngToLayerPoint(c);return[25,u.y-d.y+10]}if(t.canopyLabels){const a=o.map.getZoom();t.canopyLabels.forEach(r=>{const i=a<=11,s=L.marker(r.center,{icon:L.divIcon({className:`isoline-label ${i?"isoline-label-small":"isoline-label-large"}`,html:`<span style="font-size: ${i?"8px":"10px"}">${r.text}</span>`,iconSize:i?[50,12]:[60,14],iconAnchor:n(r.center,r.radius),pmIgnore:!0}),zIndexOffset:2100}).addTo(o.jumpVisualizationLayerGroup);e.push({marker:s,center:r.center,radius:r.radius,text:r.text,pmIgnore:!0})})}e.length>0&&(o.labelZoomListener=function(){const r=o.map.getZoom()<=11;e.forEach(i=>{i.marker.setIcon(L.divIcon({className:`isoline-label ${r?"isoline-label-small":"isoline-label-large"}`,html:`<span style="font-size: ${r?"8px":"10px"}">${i.text}</span>`,iconSize:r?[50,12]:[60,14],iconAnchor:n(i.center,i.radius)}))})},o.map.on("zoomend",o.labelZoomListener))}function Al(){o.map&&o.jumpVisualizationLayerGroup&&o.map.removeLayer(o.jumpVisualizationLayerGroup),o.jumpVisualizationLayerGroup=L.layerGroup().addTo(o.map)}function Cl(){o.landingPatternLayerGroup&&o.landingPatternLayerGroup.clearLayers()}function At(t){Cl(),t&&(t.legs.forEach(e=>{L.polyline(e.path,{color:"red",weight:3,opacity:.8,dashArray:"5, 10",pmIgnore:!0}).addTo(o.landingPatternLayerGroup)}),t.arrows.forEach(e=>{const n=Il(e.position[0],e.position[1],e.bearing,e.color);L.marker(e.position,{icon:n,pmIgnore:!0}).addTo(o.landingPatternLayerGroup).bindTooltip(e.tooltipText,{offset:[10,0],direction:"right",className:"wind-tooltip",pmIgnore:!0})}))}function Il(t,e,n,a){const r=(n+360)%360,i=`
        <svg width="40" height="20" viewBox="0 0 40 20" xmlns="http://www.w3.org/2000/svg">
            <line x1="0" y1="10" x2="30" y2="10" stroke="${a}" stroke-width="4" />
            <polygon points="30,5 40,10 30,15" fill="${a}" />
        </svg>
    `;return L.divIcon({html:`<div style="transform: rotate(${r}deg); ...">${i}</div>`,className:"wind-arrow-icon",iconSize:[40,20],iconAnchor:[20,10]})}function Nl(){o.map&&o.jumpRunTrackLayerGroup&&o.map.removeLayer(o.jumpRunTrackLayerGroup),o.jumpRunTrackLayerGroup=L.layerGroup().addTo(o.map)}function Pl(t,e){const n=L.icon({iconUrl:ya.CUTAWAY_MARKER,iconSize:[25,25],iconAnchor:[12,12],popupAnchor:[0,-12],pmIgnore:!0});return L.marker([t,e],{icon:n,draggable:!0,pmIgnore:!0})}function Dl(t){t.on("dragend",e=>{const n=t.getLatLng();o.cutAwayLat=n.lat,o.cutAwayLng=n.lng,console.log("Cut-away marker dragged to:",{lat:o.cutAwayLat,lng:o.cutAwayLng}),ki(t,o.cutAwayLat,o.cutAwayLng);const a=new CustomEvent("cutaway:marker_placed",{bubbles:!0});o.map.getContainer().dispatchEvent(a)})}function ki(t,e,n,a=!1){const r=m.getValue("coordFormat","radio","Decimal"),i=g.convertCoords(e,n,r);let s="<b>Cut-Away Start</b><br>";if(r==="MGRS")s+=`MGRS: ${i.lat}`;else{const l=c=>`${c.deg}°${c.min}'${c.sec.toFixed(0)}" ${c.dir}`;r==="DMS"?s+=`Lat: ${l(g.decimalToDms(e,!0))}<br>Lng: ${l(g.decimalToDms(n,!1))}`:s+=`Lat: ${e.toFixed(5)}<br>Lng: ${n.toFixed(5)}`}Sa(t,s,a)}function ta(t){o.cutAwayCircle&&(o.map.removeLayer(o.cutAwayCircle),o.cutAwayCircle=null),t&&(o.cutAwayCircle=L.circle(t.center,{radius:t.radius,color:"purple",fillColor:"purple",fillOpacity:.2,weight:2,pmIgnore:!0}).addTo(o.map),o.cutAwayCircle.bindTooltip(t.tooltipContent,{permanent:!1,direction:"center",className:"cutaway-tooltip"}))}function xl(){o.cutAwayMarker&&(o.map.removeLayer(o.cutAwayMarker),o.cutAwayMarker=null),ta(null)}function Pt(t){if(Nl(),!o.jumpRunTrackLayerGroup){console.error("drawJumpRunTrack called before jumpRunTrackLayerGroup was initialized.");return}if(!t)return;if(!t.path?.latlngs?.length||!t.airplane?.position){console.warn("Invalid trackData structure:",t);return}const e=L.polyline(t.path.latlngs,t.path.options).bindTooltip(t.path.tooltipText).addTo(o.jumpRunTrackLayerGroup);let n=null;t.approachPath?.latlngs&&(n=L.polyline(t.approachPath.latlngs,t.approachPath.options).bindTooltip(t.approachPath.tooltipText).addTo(o.jumpRunTrackLayerGroup));const a=L.icon({iconUrl:ya.AIRPLANE_MARKER,iconSize:[32,32],iconAnchor:[16,16],shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",shadowSize:[41,41],shadowAnchor:[13,32]}),r=L.marker(t.airplane.position,{icon:a,rotationAngle:t.airplane.bearing,rotationOrigin:"center center",draggable:!0,zIndexOffset:2e3,pmIgnore:!0}).bindTooltip("Drag to move Jump Run Track").addTo(o.jumpRunTrackLayerGroup);r.on("mousedown",()=>o.map.dragging.disable()),r.on("mouseup",()=>o.map.dragging.enable()),r.on("drag",i=>{const s=i.target.getLatLng(),l=t.airplane.originalPosition;if(!l||!Number.isFinite(l.lat)||!Number.isFinite(l.lng)){console.warn("Invalid originalPosition:",l);return}const c=s.lat-l.lat,u=s.lng-l.lng;if(!Number.isFinite(c)||!Number.isFinite(u)){console.warn("Invalid delta values:",{deltaLat:c,deltaLng:u});return}const d=t.path.originalLatLngs.map(h=>[Number.isFinite(h[0])?h[0]+c:h[0],Number.isFinite(h[1])?h[1]+u:h[1]]);if(e.setLatLngs(d),n&&t.approachPath?.originalLatLngs){const h=t.approachPath.originalLatLngs.map(p=>[Number.isFinite(p[0])?p[0]+c:p[0],Number.isFinite(p[1])?p[1]+u:p[1]]);n.setLatLngs(h)}}),r.on("dragend",i=>{const s=i.target.getLatLng();if(!Number.isFinite(s.lat)||!Number.isFinite(s.lng)){console.warn("Invalid new position in dragend:",s);return}const l=new CustomEvent("track:dragend",{detail:{newPosition:s,originalTrackData:t},bubbles:!0});o.map.getContainer().dispatchEvent(l)})}async function Sn(t,e){if(console.log("MapManager: Befehl erhalten, Marker zu erstellen/bewegen bei",t,e),typeof t!="number"||typeof e!="number"||t<-90||t>90||e<-180||e>180){console.error("MapManager: Ungültige Koordinaten:",{lat:t,lng:e});return}const n=await g.getAltitude(t,e);if(o.currentMarker)console.log("MapManager: Marker existiert, bewege ihn jetzt mit setLatLng."),o.currentMarker.setLatLng([t,e]);else{console.log("MapManager: Kein Marker vorhanden, erstelle einen neuen.");const r=Fl(t,e);$l(r),o.currentMarker=r,o.currentMarker.addTo(o.map)}const a=`Lat: ${t.toFixed(5)}<br>Lng: ${e.toFixed(5)}<br>Alt: ${n} m`;Sa(o.currentMarker,a),o.lastLat=t,o.lastLng=e,o.lastAltitude=n,o.map.invalidateSize()}function Fl(t,e){const n=L.icon({iconUrl:ya.DEFAULT_MARKER,iconSize:[32,32],iconAnchor:[16,20],popupAnchor:[0,-32],pmIgnore:!0});return L.marker([t,e],{icon:n,draggable:!0,pmIgnore:!0})}function $l(t){t.on("dragend",e=>{const n=t.getLatLng(),a=new CustomEvent("location:selected",{detail:{lat:n.lat,lng:n.lng,source:"marker_drag"},bubbles:!0});o.map.getContainer().dispatchEvent(a)})}function Sa(t,e,n=!1){if(!t)return;const a=t.getPopup()?.isOpen()||n;t.unbindPopup().bindPopup(e),a&&t.openPopup()}function mn(t=!1){o.isManualPanning&&!t||o.map&&o.currentMarker&&o.map.panTo(o.currentMarker.getLatLng())}function Ol(t,e){const n=[[t.lat,t.lng],[e.lat,e.lng]];o.jumpMasterLine?o.jumpMasterLine.setLatLngs(n):o.jumpMasterLine=L.polyline(n,{color:"blue",weight:3,dashArray:"5, 5"}).addTo(o.map)}function Rl(){o.jumpMasterLine&&(o.map.removeLayer(o.jumpMasterLine),o.jumpMasterLine=null)}function Ti(t){if(!o.isPlacingHarp)return;const{lat:e,lng:n}=t.latlng;o.harpMarker?(o.harpMarker.setLatLng([e,n]),console.log("Updated HARP marker position:",{lat:e,lng:n})):(o.harpMarker=Ai(e,n).addTo(o.map),console.log("Placed new HARP marker:",{lat:e,lng:n})),m.state.userSettings.harpLat=e,m.state.userSettings.harpLng=n,m.save(),o.isPlacingHarp=!1,o.map.off("click",Ti),console.log("HARP placement mode deactivated");const a=document.querySelector('input[name="jumpMasterLineTarget"][value="HARP"]');a&&(a.disabled=!1,console.log("Enabled HARP radio button")),document.dispatchEvent(new CustomEvent("ui:recalculateJump")),document.dispatchEvent(new CustomEvent("harp:updated"))}function Ai(t,e){const n=L.marker([t,e],{icon:L.divIcon({className:"harp-marker",html:'<div style="width: 14px; height: 14px; background-color: green; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 6px rgba(0,0,0,0.6);"></div>',iconSize:[20,20],iconAnchor:[10,10]}),pane:"markerPane",pmIgnore:!0});return console.log("Created HARP marker at:",{latitude:t,longitude:e}),n}function Ul(){if(!o.map){console.warn("Map not initialized, cannot clear HARP marker"),g.handleMessage("Map not initialized, cannot clear HARP marker.");return}o.harpMarker&&(o.map.removeLayer(o.harpMarker),o.harpMarker=null,console.log("Removed HARP marker")),m.state.userSettings.harpLat=null,m.state.userSettings.harpLng=null,m.save();const t=document.querySelector('input[name="jumpMasterLineTarget"][value="HARP"]');if(t&&(t.disabled=!0,console.log("Disabled HARP radio button")),m.state.userSettings.jumpMasterLineTarget==="HARP"&&m.state.userSettings.showJumpMasterLine){o.jumpMasterLine&&(o.map.removeLayer(o.jumpMasterLine),o.jumpMasterLine=null,console.log("Removed Jump Master Line: HARP marker cleared")),m.state.userSettings.jumpMasterLineTarget="DIP";const e=document.querySelector('input[name="jumpMasterLineTarget"][value="DIP"]');e&&(e.checked=!0,console.log("Switched Jump Master Line to DIP")),m.save(),o.liveMarker&&o.currentMarker&&o.lastLat!==null&&o.lastLng!==null&&debouncedPositionUpdate({coords:{latitude:o.lastLatitude,longitude:o.lastLongitude,accuracy:o.lastAccuracy,altitude:o.lastDeviceAltitude,altitudeAccuracy:o.lastAltitudeAccuracy}})}g.handleMessage("HARP marker cleared")}function Ci(t){if(!o.map||!o.favoritesLayerGroup){console.warn("Cannot update favorite markers: map or layer group not ready.");return}if(o.favoritesLayerGroup.clearLayers(),!t||t.length===0)return;const e=L.divIcon({html:"★",className:"favorite-marker-icon",iconSize:[24,24],iconAnchor:[12,12]});t.forEach(n=>{const a=L.marker([n.lat,n.lng],{icon:e,pmIgnore:!0}).bindTooltip(n.label,{permanent:!1,direction:"top"}).on("click",()=>{document.dispatchEvent(new CustomEvent("location:selected",{detail:{lat:n.lat,lng:n.lng,source:"favorite_marker"},bubbles:!0}))});o.favoritesLayerGroup.addLayer(a)})}async function $e(){if(!o.currentMarker||o.lastLat===null)return;const t=o.lastLat,e=o.lastLng,n=o.lastAltitude,a=m.getValue("heightUnit","radio","m");let r="N/A",i="";n!=="N/A"&&(a==="ft"?(r=Math.round(g.convertHeight(n,"ft")),i="ft"):(r=n,i="m"));const s=m.getValue("coordFormat","radio","Decimal"),l=bi(),c=g.convertCoords(t,e,s);let u;if(s==="MGRS")u=`MGRS: ${c.lat}<br>Alt: ${r} ${i}`;else{const d=h=>`${h.deg}°${h.min}'${h.sec.toFixed(0)}" ${h.dir}`;s==="DMS"?u=`Lat: ${d(g.decimalToDms(t,!0))}<br>Lng: ${d(g.decimalToDms(e,!1))}<br>Alt: ${r} ${i}`:u=`Lat: ${t.toFixed(5)}<br>Lng: ${e.toFixed(5)}<br>Alt: ${r} ${i}`}if(o.weatherData&&o.weatherData.surface_pressure){const d=o.weatherData.surface_pressure[l];d?u+=` QFE: ${d.toFixed(0)} hPa`:u+=" QFE: N/A"}else u+=" QFE: N/A";Sa(o.currentMarker,u)}async function Oe(t,e,n,a=null){console.log(`updateWeatherDisplay called for index: ${t} -> into ${e}`);const r=document.getElementById(e),i=document.getElementById(n);if(!r||!i){console.error("Target container(s) for weather display not found!",{tableContainerId:e,timeContainerId:n});return}if(!o.weatherData||!o.weatherData.time||t<0||t>=o.weatherData.time.length){console.error("No weather data available or index out of bounds:",t),r.innerHTML='<p style="padding: 20px; text-align: center;">No weather data available</p>',i.innerHTML="Selected Time: ";const _=document.getElementById("timeSlider");_&&(_.value=0);return}o.landingWindDir=o.weatherData.wind_direction_10m[t]||null,console.log("landingWindDir updated to:",o.landingWindDir);const s=document.getElementById("customLandingDirectionLL"),l=document.getElementById("customLandingDirectionRR");s&&l&&o.landingWindDir!==null&&(s.value=Math.round(o.landingWindDir),l.value=Math.round(o.landingWindDir));const c=document.getElementById("refLevel")?.value||"AGL",u=m.getValue("heightUnit","radio","m"),d=m.getValue("windUnit","radio","kt"),h=m.getValue("temperatureUnit","radio","C"),p=m.getValue("timeZone","radio","Z"),f=await g.getDisplayTime(o.weatherData.time[t],o.lastLat,o.lastLng,p),y=ke(),v=Ne(o.weatherData,t,y,Math.round(o.lastAltitude),u),w=c==="AMSL"&&o.lastAltitude!=="N/A"?Math.round(o.lastAltitude):0,S=v.map(_=>{const E=parseFloat(_.spd);let b="";if(d==="bft"){const H=g.convertWind(E,"kt","km/h"),V=g.knotsToBeaufort(H);V<=1?b="wind-low":V<=3?b="wind-moderate":V<=4?b="wind-high":b="wind-very-high"}else{const H=g.convertWind(E,"kt","km/h");H<=3?b="wind-low":H<=10?b="wind-moderate":H<=16?b="wind-high":b="wind-very-high"}const T=_.rh;let k="";T!=="N/A"&&Number.isFinite(T)&&(T<65?k="humidity-low":T>=65&&T<=85?k="humidity-moderate":T>85&&T<100?k="humidity-high":T===100&&(k="humidity-saturated"));const A=c==="AMSL"?_.displayHeight+(u==="ft"?Math.round(w*3.28084):w):_.displayHeight,P=g.convertTemperature(_.temp,h==="C"?"°C":"°F"),I=P==="N/A"?"N/A":P.toFixed(0),D=g.convertWind(E,d,"km/h");let $;const O=c==="AMSL"?u==="ft"?Math.round(w*3.28084):w:0;if(Math.round(A)===O&&o.weatherData.wind_gusts_10m[t]!==void 0&&Number.isFinite(o.weatherData.wind_gusts_10m[t])){const H=o.weatherData.wind_gusts_10m[t],V=g.convertWind(H,d,"km/h"),te=d==="bft"?Math.round(D):D.toFixed(0),he=d==="bft"?Math.round(V):V.toFixed(0);$=`${te} G ${he}`}else $=D==="N/A"?"N/A":d==="bft"?Math.round(D):D.toFixed(0);const U=Math.round(g.convertWind(E,"kt","km/h")/5)*5,J=_.dir==="N/A"||isNaN(U)?"N/A":g.generateWindBarb(_.dir,U);return`<tr class="${b} ${k}">
                    <td>${Math.round(A)}</td>
                    <td>${g.roundToTens(_.dir)}</td>
                    <td>${$}</td>
                    <td>${J}</td>
                    <td>${I}</td>
                </tr>`}).join(""),M=`
        <table id="weatherTable">
            <thead>
                <tr>
                    <th>Height (${u} ${c})</th>
                    <th>Dir (deg)</th>
                    <th>Spd (${d})</th>
                    <th>Wind</th>
                    <th>T (${h==="C"?"°C":"°F"})</th>
                </tr>
            </thead>
            <tbody>
                ${S}
            </tbody>
        </table>`;r.innerHTML=M,i.innerHTML=`Selected Time: ${f}`}function pe(){if(!o.currentMarker||typeof o.currentMarker.getLatLng!="function")return;const t=o.currentMarker.getLatLng();if(!t)return;if(!m.state.isLandingPatternUnlocked||!m.state.userSettings.showLandingPattern||!o.weatherData||o.map.getZoom()<ve.LANDING_PATTERN_MIN_ZOOM){At(null);return}const e=parseInt(document.getElementById("timeSlider").value)||0,n=ke(),a=m.getValue("heightUnit","m"),r=m.getValue("windUnit","kt"),i=Math.round(o.lastAltitude),s=Ne(o.weatherData,e,n,i,a);if(!s||s.length===0){At(null);return}const l=Ln(t.lat,t.lng,s);if(!l){At(null);return}const{downwindStart:c,baseStart:u,finalStart:d,landingPoint:h}=l,p=s.map(A=>A.height),f=s.map(A=>-g.convertWind(A.spd,"kt","km/h")*Math.sin(A.dir*Math.PI/180)),y=s.map(A=>-g.convertWind(A.spd,"kt","km/h")*Math.cos(A.dir*Math.PI/180)),v=parseInt(document.getElementById("legHeightFinal").value)||100,w=parseInt(document.getElementById("legHeightBase").value)||200,S=parseInt(document.getElementById("legHeightDownwind").value)||300,M=g.calculateMeanWind(p,f,y,i,i+v),_=g.calculateMeanWind(p,f,y,i+v,i+w),E=g.calculateMeanWind(p,f,y,i+w,i+S),b=A=>A<=3?"lightblue":A<=10?"lightgreen":A<=16?"#f5f34f":"#ffcccc",T=A=>{const P=g.convertWind(A,r,"kt");return r==="bft"?Math.round(P):P.toFixed(1)},k={legs:[{path:[h,d]},{path:[d,u]},{path:[u,c]}],arrows:[{position:[(h[0]+d[0])/2,(h[1]+d[1])/2],bearing:(M[0]-90+180)%360,color:b(M[1]),tooltipText:`${Math.round(M[0])}° ${T(M[1])} ${r}`},{position:[(d[0]+u[0])/2,(d[1]+u[1])/2],bearing:(_[0]-90+180)%360,color:b(_[1]),tooltipText:`${Math.round(_[0])}° ${T(_[1])} ${r}`},{position:[(u[0]+c[0])/2,(u[1]+c[1])/2],bearing:(E[0]-90+180)%360,color:b(E[1]),tooltipText:`${Math.round(E[0])}° ${T(E[1])} ${r}`}]};At(k)}function ie(){if(console.log("updateJumpRunTrackDisplay called"),!o.map){console.warn("Map not initialized, cannot update jump run track display");return}if(!(m.state.userSettings.showJumpRunTrack&&o.weatherData&&o.lastLat&&o.lastLng&&m.state.isCalculateJumpUnlocked&&m.state.userSettings.calculateJump)){console.log("Conditions not met to show JRT, clearing display."),Pt(null),o.lastTrackData=null;const c=document.getElementById("jumpRunTrackDirection");c&&!m.state.userSettings.customJumpRunDirection&&(c.value="");return}const e=bi(),n=ke(),a=m.getValue("heightUnit","radio","m"),r=Ne(o.weatherData,e,n,Math.round(o.lastAltitude),a),i=o.harpMarker?o.harpMarker.getLatLng():null,s=va(r,i),l=document.getElementById("jumpRunTrackDirection");if(s&&s.latlngs?.length===2&&s.latlngs.every(c=>Number.isFinite(c[0])&&Number.isFinite(c[1]))){console.log("Drawing jump run track with data:",s),l&&!m.state.userSettings.customJumpRunDirection&&(l.value=s.direction);const c={path:{latlngs:s.latlngs,options:{color:"orange",weight:5,opacity:.8},tooltipText:`Jump Run: ${s.direction}°, ${s.trackLength} m`,originalLatLngs:o.lastTrackData?.latlngs?.length===2?o.lastTrackData.latlngs:s.latlngs},approachPath:s.approachLatLngs?.length===2&&s.approachLatLngs.every(u=>Number.isFinite(u[0])&&Number.isFinite(u[1]))?{latlngs:s.approachLatLngs,options:{color:"orange",weight:5,opacity:.8,dashArray:"5, 10"},tooltipText:`Approach: ${s.direction}°, ${s.approachLength} m`,originalLatLngs:o.lastTrackData?.approachLatLngs?.length===2?o.lastTrackData.approachLatLngs:s.approachLatLngs}:null,trackLength:s.trackLength,airplane:{position:L.latLng(s.latlngs[1][0],s.latlngs[1][1]),bearing:s.direction,originalPosition:o.lastTrackData?.latlngs?.[1]&&Number.isFinite(o.lastTrackData.latlngs[1][0])?L.latLng(o.lastTrackData.latlngs[1][0],o.lastTrackData.latlngs[1][1]):L.latLng(s.latlngs[1][0],s.latlngs[1][1])}};Pt(c),o.lastTrackData={latlngs:s.latlngs,approachLatLngs:s.approachLatLngs,direction:s.direction,trackLength:s.trackLength,approachLength:s.approachLength},console.log("Updated AppState.lastTrackData:",o.lastTrackData)}else console.warn("No valid track data to display:",s),Pt(null),o.lastTrackData=null,l&&!m.state.userSettings.customJumpRunDirection&&(l.value="")}function Hl(){const t=document.getElementById("modelInfoPopup"),e=document.getElementById("modelSelect");if(!t||!e)return;const n=e.value,a=o.lastModelRun||"N/A",r=`Model: ${n.replace(/_/g," ").toUpperCase()}\\nRun: ${a}`;t.innerHTML=r.replace(/\\n/g,"<br>")}let Qt=JSON.parse(localStorage.getItem("searchCache"))||{},Un=!1;function Ii(t){console.log("parseQueryAsCoordinates: Parsing query:",t);const e=t.trim(),a=e.replace(/[,;\t]+/g," ").trim().match(/^(-?\d{1,3}(?:\.\d+)?)\s+(-?\d{1,3}(?:\.\d+)?)$/);if(a){console.log("parseQueryAsCoordinates: Regex match:",a);const s=parseFloat(a[1]),l=parseFloat(a[2]);if(console.log("parseQueryAsCoordinates: Decimal degrees detected:",{lat:s,lng:l}),!isNaN(s)&&!isNaN(l)&&s>=-90&&s<=90&&l>=-180&&l<=180)return{lat:s,lng:l};console.warn("parseQueryAsCoordinates: Invalid coordinate ranges:",{lat:s,lng:l})}const r=e.replace(/\s/g,"").toUpperCase(),i=/^[0-9]{1,2}[C-HJ-NP-X][A-HJ-NP-Z]{2}(\d{2}|\d{4}|\d{6}|\d{8}|\d{10})$/;if(typeof Zs>"u")return console.warn("parseQueryAsCoordinates: MGRS library not loaded"),null;if(i.test(r))try{const[s,l]=ga(r);if(console.log("parseQueryAsCoordinates: MGRS detected:",{lat:l,lng:s}),!isNaN(l)&&!isNaN(s))return{lat:l,lng:s};console.warn("parseQueryAsCoordinates: Invalid MGRS coordinates:",{lat:l,lng:s})}catch(s){return console.warn("parseQueryAsCoordinates: MGRS parsing failed:",s.message),null}return console.log("parseQueryAsCoordinates: No coordinates detected"),null}function ze(){console.log("getCoordHistory: Retrieving history");try{const t=JSON.parse(localStorage.getItem("coordHistory"))||[];return console.log("getCoordHistory: History retrieved:",t),t}catch(t){return console.error("getCoordHistory: Error retrieving history:",t),[]}}function En(t){console.log("saveCoordHistory: Saving history:",t);try{localStorage.setItem("coordHistory",JSON.stringify(t)),console.log("saveCoordHistory: History saved")}catch(e){console.error("saveCoordHistory: Error saving history:",e)}}function Ni(t,e,n,a=!1){if(console.log("addCoordToHistory: Adding:",{lat:t,lng:e,label:n,isFavorite:a}),isNaN(t)||isNaN(e)){console.error("addCoordToHistory: Invalid coordinates");return}let r=ze();const i=parseFloat(t.toFixed(5)),s=parseFloat(e.toFixed(5));r=r.filter(u=>Math.abs(u.lat-i)>.001||Math.abs(u.lng-s)>.001),r.unshift({lat:i,lng:s,label:n,isFavorite:a,timestamp:Date.now()});const l=r.filter(u=>u.isFavorite),c=r.filter(u=>!u.isFavorite).slice(0,5);En([...l,...c])}function Bl(t,e,n,a=!1){if(console.log("addOrUpdateFavorite: Processing:",{lat:t,lng:e,name:n}),isNaN(t)||isNaN(e)){console.error("addOrUpdateFavorite: Invalid coordinates");return}if(Un){console.log("addOrUpdateFavorite: Blocked due to ongoing operation");return}Un=!0;try{let r=ze();const i=parseFloat(t.toFixed(5)),s=parseFloat(e.toFixed(5)),l=r.find(c=>Math.abs(c.lat-i)<.001&&Math.abs(c.lng-s)<.001);if(l)console.log("addOrUpdateFavorite: Updating existing entry:",l),l.isFavorite=!0,l.label=n;else{const c={lat:i,lng:s,label:n,isFavorite:!0,timestamp:Date.now()};console.log("addOrUpdateFavorite: Adding new entry:",c),r.unshift(c)}En(r),a||g.handleMessage(`"${n}" saved as favorite.`),Ea()}catch(r){console.error("addOrUpdateFavorite: Error:",r)}finally{Un=!1,console.log("addOrUpdateFavorite: Completed")}}function Wl(t,e){if(console.log("removeLocationFromHistory: Removing:",{lat:t,lng:e}),isNaN(t)||isNaN(e)){console.error("removeLocationFromHistory: Invalid coordinates");return}const a=ze().filter(r=>{const i=parseFloat(r.lat),s=parseFloat(r.lng||r.lon);return Math.abs(i-t)>.001||Math.abs(s-e)>.001});En(a),g.handleMessage("Location deleted."),Ea()}function Ea(){console.log("_dispatchFavoritesUpdate: Dispatching event");const e=ze().filter(a=>a.isFavorite),n=new CustomEvent("favorites:updated",{detail:{favorites:e},bubbles:!0,cancelable:!0});document.dispatchEvent(n),console.log("_dispatchFavoritesUpdate: Event dispatched")}async function zl(t){if(!t.trim())return[];const e=Ii(t);if(e)return[{display_name:`Coordinate: ${e.lat.toFixed(5)}, ${e.lng.toFixed(5)}`,lat:e.lat,lon:e.lng,type:"coordinate"}];if(Qt[t])return Qt[t];const n=3,a=1500;for(let r=1;r<=n;r++)try{const i=`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(t)}&format=json&limit=5&addressdetails=1`,s=await fetch(i,{headers:{"User-Agent":"DZMaster/1.0"}});if(!s.ok)throw new Error(`Nominatim API Error: ${s.statusText}`);const l=await s.json();return Qt[t]=l,localStorage.setItem("searchCache",JSON.stringify(Qt)),l}catch(i){if(console.error(`Search attempt ${r} failed:`,i),r===n)return g.handleError("Could not find location. Please check network."),[];await new Promise(s=>setTimeout(s,a))}}function sr(t,e,n,a){let r=ze();const i=parseFloat(t.toFixed(5)),s=parseFloat(e.toFixed(5)),l=r.find(c=>Math.abs(c.lat-i)<1e-4&&Math.abs(c.lng-s)<1e-4);l?(l.isFavorite=a,a&&(l.label=n)):a&&r.unshift({lat:i,lng:s,label:n,isFavorite:!0,timestamp:Date.now()}),En(r),Ea(),a?g.handleMessage(`"${n}" saved as favorite.`):g.handleMessage(`"${n}" removed from favorites.`)}let xe=null;function Pi(){const t=document.getElementById("locationSearchInput"),e=document.getElementById("locationResults"),n=document.getElementById("saveFavoriteBtn"),a=document.getElementById("favoriteModal"),r=document.getElementById("favoriteNameInput"),i=document.getElementById("submitFavoriteName"),s=document.getElementById("cancelFavoriteName");if(!t||!e||!n||!a){console.error("Einige UI-Elemente für die Ortssuche wurden nicht gefunden.");return}const l=g.debounce(Vl,300);t.addEventListener("input",()=>l(t.value)),n.addEventListener("click",()=>{if(o.lastLat===null||o.lastLng===null){g.handleError("Please select a location on the map first.");return}xe={lat:o.lastLat,lng:o.lastLng,defaultName:`DIP at ${o.lastLat.toFixed(4)}, ${o.lastLng.toFixed(4)}`},r.value=xe.defaultName,a.style.display="flex"}),i.addEventListener("click",()=>{if(xe){const c=r.value.trim()||xe.defaultName;Bl(xe.lat,xe.lng,c),Qe()}a.style.display="none",xe=null}),s.addEventListener("click",()=>{a.style.display="none",xe=null}),Qe()}function Qe(t=[]){const e=document.getElementById("locationResults");if(!e)return;e.innerHTML="";const n=ze(),a=n.filter(l=>l.isFavorite),r=n.filter(l=>!l.isFavorite),i=(l,c,u=!1)=>{if(c.length===0)return;const d=document.createElement("div");d.className="search-section";const h=document.createElement("h5");h.textContent=l,d.appendChild(h);const p=document.createElement("ul");c.forEach(f=>{const y=s(f);y&&p.appendChild(y)}),d.appendChild(p),e.appendChild(d)},s=l=>{const c=document.createElement("li");c.className="search-item";const u=parseFloat(l.lat),d=parseFloat(l.lng||l.lon);if(isNaN(u)||isNaN(d))return null;c.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("location:selected",{detail:{lat:u,lng:d,source:"search"},bubbles:!0})),Ni(u,d,l.display_name||l.label,l.isFavorite),Qe()});const h=document.createElement("span");h.className="search-item-text",h.innerHTML=`<span class="name">${l.display_name||l.label}</span>`,c.appendChild(h);const p=document.createElement("div");p.className="search-item-actions";const f=document.createElement("button");f.className=`favorite-toggle ${l.isFavorite?"is-favorite":""}`,f.innerHTML="★",f.title="Toggle favorite",f.addEventListener("click",v=>{v.stopPropagation(),Gl(u,d,l.display_name||l.label)}),p.appendChild(f);const y=document.createElement("button");return y.className="delete-btn",y.textContent="×",y.title="Delete this entry",y.addEventListener("click",v=>{v.stopPropagation(),confirm(`Delete "${l.display_name||l.label}"?`)&&(Wl(u,d),Qe())}),p.appendChild(y),c.appendChild(p),c};i("Results",t,!0),i("Favorites",a),i("Recent Searches",r)}function Gl(t,e,n){const r=ze().find(s=>Math.abs(s.lat-t)<1e-4&&Math.abs(s.lng-e)<1e-4);if(r&&r.isFavorite)sr(t,e,n,!1);else{const s=prompt("Enter a name for this favorite:",n);s&&sr(t,e,s,!0)}Qe()}async function Vl(t){if(!t.trim()){Qe();return}const e=await zl(t);Qe(e)}const Zl="modulepreload",Jl=function(t){return"/"+t},lr={},Ct=function(e,n,a){let r=Promise.resolve();if(n&&n.length>0){let u=function(d){return Promise.all(d.map(h=>Promise.resolve(h).then(p=>({status:"fulfilled",value:p}),p=>({status:"rejected",reason:p}))))};var s=u;document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),c=l?.nonce||l?.getAttribute("nonce");r=u(n.map(d=>{if(d=Jl(d),d in lr)return;lr[d]=!0;const h=d.endsWith(".css"),p=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${p}`))return;const f=document.createElement("link");if(f.rel=h?"stylesheet":Zl,h||(f.as="script"),f.crossOrigin="",f.href=d,c&&f.setAttribute("nonce",c),document.head.appendChild(f),h)return new Promise((y,v)=>{f.addEventListener("load",y),f.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${d}`)))})}))}function i(l){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=l,window.dispatchEvent(c),!c.defaultPrevented)throw l}return r.then(l=>{for(const c of l||[])c.status==="rejected"&&i(c.reason);return e().catch(i)})};let Hn=null;async function jl(){if(window.Capacitor&&window.Capacitor.isNativePlatform()){const{Geolocation:t}=await Ct(async()=>{const{Geolocation:a}=await Promise.resolve().then(()=>It);return{Geolocation:a}},void 0),{Filesystem:e}=await Ct(async()=>{const{Filesystem:a}=await Promise.resolve().then(()=>It);return{Filesystem:a}},void 0),{BackgroundGeolocation:n}=await Ct(async()=>{const{BackgroundGeolocation:a}=await Promise.resolve().then(()=>It);return{BackgroundGeolocation:a}},void 0);return{Geolocation:t,Filesystem:e,Directory:e.Directory,BackgroundGeolocation:n,isNative:!0}}else{const{Geolocation:t,Filesystem:e,BackgroundGeolocation:n}=await Ct(async()=>{const{Geolocation:a,Filesystem:r,BackgroundGeolocation:i}=await Promise.resolve().then(()=>It);return{Geolocation:a,Filesystem:r,BackgroundGeolocation:i}},void 0);return{Geolocation:t,Filesystem:e,Directory:e.Directory,BackgroundGeolocation:n,isNative:!1}}}function tt(){return Hn||(Hn=jl()),Hn}const ql={checkPermissions:async()=>({location:"granted"}),requestPermissions:async()=>({location:"granted"}),watchPosition:async(t,e)=>navigator.geolocation.watchPosition(e,n=>e(null,n),t)},Di={appendFile:async()=>{},writeFile:async()=>{},Directory:{Data:"DATA",Documents:"DOCUMENTS"}},Kl={addWatcher:async(t,e)=>navigator.geolocation.watchPosition(n=>e(n,null),n=>e(null,n),{enableHighAccuracy:!0}),checkPermissions:async()=>({hasPermission:!0}),requestPermissions:async()=>({hasPermission:!0})},Yl={requestBatteryOptimizations:async()=>(console.log("[CapacitorMock] requestBatteryOptimizations called (mocked for web)"),{})},It=Object.freeze(Object.defineProperty({__proto__:null,App:Yl,BackgroundGeolocation:Kl,Filesystem:Di,Geolocation:ql},Symbol.toStringTag,{value:"Module"})),{Directory:Kc}=Di;async function xi(t){const{Filesystem:e,isNative:n}=await tt();if(window.Capacitor&&window.Capacitor.isNativePlatform()&&t.path){console.log(`[trackManager] Lese Datei über Capacitor Filesystem API: ${t.path}`);try{const a=await e.readFile({path:t.path});return atob(a.data)}catch(a){throw console.error("[trackManager] Fehler beim Lesen der Datei mit Capacitor:",a),new Error("Could not read file using native API.")}}else return console.log(`[trackManager] Lese Datei über Web FileReader: ${t.name}`),new Promise((a,r)=>{const i=new FileReader;i.onload=s=>a(s.target.result),i.onerror=s=>r(new Error("Error reading file.")),i.readAsText(t)})}async function Xl(t){if(!o.map)return g.handleError("Map not initialized."),null;o.isLoadingGpx=!0;try{const e=await xi(t),r=new DOMParser().parseFromString(e,"text/xml").getElementsByTagName("trkpt"),i=[];for(let l=0;l<r.length;l++){const c=parseFloat(r[l].getAttribute("lat")),u=parseFloat(r[l].getAttribute("lon"));if(isNaN(c)||isNaN(u))continue;const d=r[l].getElementsByTagName("ele")[0]?.textContent,h=r[l].getElementsByTagName("time")[0]?.textContent;i.push({lat:c,lng:u,ele:d?parseFloat(d):null,time:h?N.fromISO(h,{zone:"utc"}):null})}if(i.length<2)throw new Error("GPX track has insufficient points.");return await Fi(i,t.name)}catch(e){return console.error("[trackManager] Error in loadGpxTrack:",e),g.handleError("Error parsing GPX file: "+e.message),null}finally{o.isLoadingGpx=!1}}async function Ql(t){if(!o.map)return g.handleError("Map not initialized."),null;o.isLoadingGpx=!0;try{const e=await xi(t);return new Promise(async(n,a)=>{const r=[];Papa.parse(e,{skipEmptyLines:!0,step:function(i){const s=i.data;if(s[0]&&s[0].toUpperCase()==="$GNSS"&&s.length>=5){let l=s[1];const c=parseFloat(s[2]),u=parseFloat(s[3]),d=parseFloat(s[4]);if(isNaN(c)||isNaN(u)||isNaN(d))return;let h=null;try{h=N.fromISO(l,{setZone:!0}).toUTC(),h.isValid||(h=null)}catch{h=null}r.push({lat:c,lng:u,ele:d,time:h})}},complete:async function(){if(r.length<2){a(new Error("CSV track has insufficient points."));return}const i=await Fi(r,t.name);n(i)},error:function(i){a(new Error("Error parsing CSV: "+i.message))}})})}catch(e){return console.error("[trackManager] Error in loadCsvTrackUTC:",e),g.handleError("Error reading or parsing CSV file: "+e.message),null}finally{o.isLoadingGpx=!1}}async function Fi(t,e){try{if(console.log(`[trackManager] renderTrack called for ${e} with ${t.length} points.`),!o.map)return console.warn("[trackManager] Map object in AppState is not available in renderTrack."),g.handleError("Map not initialized. Cannot render track."),null;o.gpxLayer&&o.map.hasLayer(o.gpxLayer)&&o.map.removeLayer(o.gpxLayer),o.gpxLayer=null,o.gpxPoints=t,o.isTrackLoaded=!1;const n={finalPointData:null,timestampToUseForWeather:null,historicalDateString:null,summaryForInfoElement:"",success:!1};if(t.length>0){const r=t[t.length-1];if(o.lastLat=r.lat,o.lastLng=r.lng,o.lastAltitude=await g.getAltitude(o.lastLat,o.lastLng),n.finalPointData={lat:o.lastLat,lng:o.lastLng,altitude:o.lastAltitude},t[0].time&&t[0].time.isValid){const d=t[0].time,h=N.utc().startOf("day"),p=d.startOf("day");p<h&&(n.historicalDateString=p.toFormat("yyyy-MM-dd"));let f=d.startOf("hour");d.minute>=30&&(f=f.plus({hours:1})),n.timestampToUseForWeather=f.toISO()}const i=(t.reduce((d,h,p)=>{if(p===0||!o.map)return 0;const f=t[p-1];return d+o.map.distance([f.lat,f.lng],[h.lat,h.lng])},0)/1e3).toFixed(2),s=t.map(d=>d.ele).filter(d=>d!==null),l=s.length?Math.min(...s).toFixed(0):"N/A",c=s.length?Math.max(...s).toFixed(0):"N/A",u=new CustomEvent("track:loaded",{detail:{lat:o.lastLat,lng:o.lastLng,altitude:o.lastAltitude,timestamp:n.timestampToUseForWeather,historicalDate:n.historicalDateString,summary:`<br><strong>Track:</strong> Distance: ${i} km, Min Elevation: ${l} m, Max Elevation: ${c} m (Source: ${e})`},bubbles:!0,cancelable:!0});o.map.getContainer().dispatchEvent(u)}o.gpxLayer=L.layerGroup([],{pane:"gpxTrackPane"});const a=o.lastAltitude!=="N/A"&&!isNaN(o.lastAltitude)?parseFloat(o.lastAltitude):null;for(let r=0;r<t.length-1;r++){const i=t[r],s=t[r+1],l=i.ele,c=s.ele;let u="#808080";if(a!==null&&l!==null&&c!==null){const h=l-a,p=c-a,f=(h+p)/2;u=g.interpolateColor(f)}const d=L.polyline([[i.lat,i.lng],[s.lat,s.lng]],{color:u,weight:4,opacity:.75,pane:"gpxTrackPane"}).bindTooltip("",{sticky:!0});d.on("mousemove",function(h){const p=h.latlng;let f=t[0],y=1/0,v=0;t.forEach((w,S)=>{const M=Math.sqrt(Math.pow(w.lat-p.lat,2)+Math.pow(w.lng-p.lng,2));M<y&&(y=M,f=w,v=S)}),d.setTooltipContent(g.getTooltipContent(f,v,t,a)).openTooltip(p)}),o.gpxLayer.addLayer(d)}if(o.map&&o.gpxLayer.addTo(o.map),o.isTrackLoaded=!0,t.length>0&&o.map){const r=L.latLngBounds(t.map(i=>[i.lat,i.lng]));r.isValid()?o.map.fitBounds(r,{padding:[50,50],maxZoom:o.map.getMaxZoom()||18}):g.handleError("Unable to display track: invalid coordinates.")}return n.success=!0,console.log("[trackManager] renderTrack finished successfully."),n}catch(n){return console.error("[trackManager] Error in renderTrack:",n),g.handleError("Error rendering track: "+n.message),o.gpxPoints=[],o.gpxLayer&&o.map&&o.map.hasLayer(o.gpxLayer)&&o.map.removeLayer(o.gpxLayer),o.gpxLayer=null,o.isTrackLoaded=!1,{success:!1,error:n.message}}}async function ec(t,e,n){if(console.log("--- GPX EXPORT DEBUG START ---"),!m.getValue("showJumpRunTrack",!1)){g.handleError("Activate 'Show Jump Run Track' to export the track.");return}if(!o.weatherData||!o.lastLat||!o.lastLng||o.lastAltitude==="N/A"){g.handleError("Wetterdaten oder DIP-Position nicht verfügbar. GPX-Export nicht möglich.");return}const a=o.lastLat,r=o.lastLng,i=Math.round(o.lastAltitude),s=o.harpMarker?o.harpMarker.getLatLng():null;let l=null;s&&(l=await g.getAltitude(s.lat,s.lng),l=l!=="N/A"?Math.round(l):null);const c=Ne(o.weatherData,t,e,i,n);if(!c||c.length===0){g.handleError("Keine Wetterdaten für die GPX-Erstellung verfügbar.");return}const u=va(c,s);if(!u||!u.latlngs||!u.approachLatLngs){g.handleError("Jump Run Track konnte nicht berechnet werden.");return}const[d,h]=u.approachLatLngs[1],[p,f]=u.latlngs[0],[y,v]=u.latlngs[1],w=m.getValue("exitAltitude",3e3),S=i+w;let M=`<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<gpx version="1.1" creator="DZMaster" xmlns="http://www.topografix.com/GPX/1/1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">
  <metadata>
    <name>Jump Run - ${new Date().toLocaleString()}</name>
    <desc>Generated by DZMaster. Jump Run Direction: ${u.direction}°</desc>
  </metadata>
`;M+=`  <wpt lat="${a}" lon="${r}">
    <name>DIP</name>
    <ele>${i}</ele>
    <sym>Flag, Blue</sym>
  </wpt>
`,s&&l!==null&&(M+=`  <wpt lat="${s.lat}" lon="${s.lng}">
    <name>HARP</name>
    <ele>${l}</ele>
    <sym>Flag, Green</sym>
  </wpt>
`),M+=`  <wpt lat="${d}" lon="${h}">
    <name>x-2, ${u.direction}°</name>
    <ele>${S}</ele>
    <sym>Airplane</sym>
  </wpt>
`,M+=`  <wpt lat="${p}" lon="${f}">
    <name>First Out ${w} m AGL</name>
    <ele>${S}</ele>
    <sym>Airplane</sym>
  </wpt>
`,M+=`  <wpt lat="${y}" lon="${v}">
    <name>Last Out</name>
    <ele>${S}</ele>
    <sym>Airplane</sym>
  </wpt>
`,M+=`  <trk>
    <name>Jump Run and Approach</name>
    <trkseg>
`,M+=`      <trkpt lat="${d}" lon="${h}"><ele>${S}</ele></trkpt>
`,M+=`      <trkpt lat="${p}" lon="${f}"><ele>${S}</ele></trkpt>
`,M+=`      <trkpt lat="${y}" lon="${v}"><ele>${S}</ele></trkpt>
`,M+=`    </trkseg>
  </trk>
</gpx>`;const E=`${g.formatTime(o.weatherData.time[t]).replace(/ /g,"_").replace(/:/g,"")}_JumpRun_Track.gpx`;try{const{Filesystem:b,Directory:T,isNative:k}=await tt();if(k&&b)await b.writeFile({path:`DZMaster/${E}`,data:M,directory:T.Documents,encoding:"utf8",recursive:!0}),g.handleMessage("GPX saved in Documents/DZMaster");else{const A=new Blob([M],{type:"application/gpx+xml;charset=utf-8"}),P=window.URL.createObjectURL(A),I=document.createElement("a");I.href=P,I.download=E,document.body.appendChild(I),I.click(),document.body.removeChild(I),window.URL.revokeObjectURL(P)}}catch(b){console.error("Error saving GPX file:",b),g.handleError("Could not save GPX file.")}}async function tc(){console.log("--- GPX Landing Pattern Export gestartet ---");const t=parseInt(document.getElementById("timeSlider")?.value)||0,e=m.getValue("interpStep","select",200),n=m.getValue("heightUnit","m");if(!m.getValue("showLandingPattern",!1)){g.handleError("Activate 'Landing Pattern' before export.");return}if(!o.weatherData||!o.lastLat||!o.lastLng||o.lastAltitude==="N/A"){g.handleError("Wetterdaten oder DIP-Position für GPX-Export nicht verfügbar.");return}console.log("Schritt 1: Vorbedingungen erfüllt. Wetterdaten und Position vorhanden.");const a=Ne(o.weatherData,t,e,Math.round(o.lastAltitude),n);if(!a||a.length===0){g.handleError("Fehler in Schritt 2: Keine interpolierten Wetterdaten für GPX-Erstellung verfügbar.");return}console.log("Schritt 2: Wetterdaten erfolgreich interpoliert.");const r=Ln(o.lastLat,o.lastLng,a);if(console.log("Schritt 3: Ergebnis von calculateLandingPatternCoords:",r),!r){g.handleError("Fehler in Schritt 3: calculateLandingPatternCoords hat keine Daten zurückgegeben. Export abgebrochen.");return}console.log("Schritt 3: Koordinaten des Landemusters erfolgreich berechnet.");const{downwindStart:i,baseStart:s,finalStart:l,landingPoint:c}=r,u=Math.round(o.lastAltitude),d=m.getValue("legHeightDownwind",300),h=m.getValue("legHeightBase",200),p=m.getValue("legHeightFinal",100),f=u+d,y=u+h,v=u+p;let w=`<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<gpx version="1.1" creator="DZMaster" xmlns="http://www.topografix.com/GPX/1/1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">
  <metadata>
    <name>Landing Pattern - ${new Date().toLocaleString()}</name>
    <desc>Generated by DZMaster Application.</desc>
  </metadata>
`;w+=`  <wpt lat="${i[0]}" lon="${i[1]}"><name>Downwind ${d} m AGL</name><ele>${f}</ele></wpt>
`,w+=`  <wpt lat="${s[0]}" lon="${s[1]}"><name>Base ${h} m AGL</name><ele>${y}</ele></wpt>
`,w+=`  <wpt lat="${l[0]}" lon="${l[1]}"><name>Final ${p} m AGL</name><ele>${v}</ele></wpt>
`,w+=`  <wpt lat="${c[0]}" lon="${c[1]}"><name>DIP</name><ele>${u}</ele></wpt>
`,w+=`  <trk>
    <name>Landing Pattern</name>
    <trkseg>
      <trkpt lat="${i[0]}" lon="${i[1]}"><ele>${f}</ele></trkpt>
      <trkpt lat="${s[0]}" lon="${s[1]}"><ele>${y}</ele></trkpt>
      <trkpt lat="${l[0]}" lon="${l[1]}"><ele>${v}</ele></trkpt>
      <trkpt lat="${c[0]}" lon="${c[1]}"><ele>${u}</ele></trkpt>
    </trkseg>
  </trk>
</gpx>`,console.log("Schritt 4: GPX-String wurde erfolgreich erstellt."),console.log(w);const M=`${g.formatTime(o.weatherData.time[t]).replace(/ /g,"_").replace(/:/g,"")}_Landing_Pattern.gpx`;try{const{Filesystem:_,Directory:E,isNative:b}=await tt();if(b&&_)await _.writeFile({path:`DZMaster/${M}`,data:w,directory:E.Documents,encoding:"utf8",recursive:!0}),g.handleMessage("Landing Pattern GPX saved in Documents/DZMaster");else{const T=new Blob([w],{type:"application/gpx+xml;charset=utf-8"}),k=window.URL.createObjectURL(T),A=document.createElement("a");A.href=k,A.download=M,document.body.appendChild(A),A.click(),document.body.removeChild(A),window.URL.revokeObjectURL(k)}}catch(_){console.error("Error saving Landing Pattern GPX file:",_),g.handleError("Could not save Landing Pattern GPX file.")}console.log("--- GPX Landing Pattern Export beendet ---")}var nc=15e3,na=1e3,aa=60*na,on=60*aa,Bn=24*on,ac="http://www.topografix.com/GPX/gpx_style/0/2",en=new L.Icon.Default,rc={startIcon:en,endIcon:en,wptIcons:{"":en},wptTypeIcons:{"":en},pointMatchers:[]},ic={iconSize:[33,45],iconAnchor:[16,45],clickable:!1},oc={color:"blue"},sc={parseElements:["track","route","waypoint"],joinTrackSegments:!0};L.GPX=L.FeatureGroup.extend({initialize:function(t,e){e.max_point_interval=e.max_point_interval||nc,e.markers=this._merge_objs(rc,e.markers||{}),e.marker_options=this._merge_objs(ic,e.marker_options||{}),e.polyline_options=e.polyline_options||[],e.gpx_options=this._merge_objs(sc,e.gpx_options||{}),L.Util.setOptions(this,e),L.GPXTrackIcon=L.Icon.extend({options:e.marker_options}),this._gpx=t,this._layers={},this._prepare_markers(e.markers),this._init_info(),t&&this._parse(t,e,this.options.async)},get_duration_string:function(t,e){var n="";t>=Bn&&(n+=Math.floor(t/Bn)+"d ",t=t%Bn),t>=on&&(n+=Math.floor(t/on)+":",t=t%on);var a=Math.floor(t/aa);t=t%aa,a<10&&(n+="0"),n+=a+"'";var r=Math.floor(t/na);return t=t%na,r<10&&(n+="0"),n+=r,!e&&t>0?n+="."+Math.round(Math.floor(t)*1e3)/1e3:n+='"',n},get_duration_string_iso:function(t,e){var n=this.get_duration_string(t,e);return n.replace("'",":").replace('"',"")},_toFixed_helper:function(t,e=0){return typeof t=="number"?t.toFixed(e):"?"},to_miles:function(t){return t/1.60934},to_ft:function(t){return t*3.28084},m_to_km:function(t){return t/1e3},m_to_mi:function(t){return t/1609.34},ms_to_kmh:function(t){return t*3.6},ms_to_mih:function(t){return t/1609.34*3600},get_name:function(){return this._info.name},get_desc:function(){return this._info.desc},get_author:function(){return this._info.author},get_copyright:function(){return this._info.copyright},get_distance:function(){return this._info.length},get_distance_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))},get_start_time:function(){return this._info.duration.start},get_end_time:function(){return this._info.duration.end},get_moving_time:function(){return this._info.duration.moving},get_total_time:function(){return this._info.duration.total},get_moving_pace:function(){return this.get_moving_time()/this.m_to_km(this.get_distance())},get_moving_pace_imp:function(){return this.get_moving_time()/this.get_distance_imp()},get_moving_speed:function(){return this.m_to_km(this.get_distance())/(this.get_moving_time()/(3600*1e3))},get_moving_speed_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))/(this.get_moving_time()/(3600*1e3))},get_total_speed:function(){return this.m_to_km(this.get_distance())/(this.get_total_time()/(3600*1e3))},get_total_speed_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))/(this.get_total_time()/(3600*1e3))},get_elevation_gain:function(){return this._info.elevation.gain},get_elevation_loss:function(){return this._info.elevation.loss},get_elevation_gain_imp:function(){return this.to_ft(this.get_elevation_gain())},get_elevation_loss_imp:function(){return this.to_ft(this.get_elevation_loss())},get_elevation_data:function(){var t=this;return this._info.elevation._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" m"})})},get_elevation_data_imp:function(){var t=this;return this._info.elevation._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,t.to_ft,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" ft"})})},get_elevation_max:function(){return this._info.elevation.max},get_elevation_min:function(){return this._info.elevation.min},get_elevation_max_imp:function(){return this.to_ft(this.get_elevation_max())},get_elevation_min_imp:function(){return this.to_ft(this.get_elevation_min())},get_speed_data:function(){var t=this;return this._info.speed._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,t.ms_to_kmh,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,2)+" km/h"})})},get_speed_data_imp:function(){var t=this;return this._info.speed._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,t.ms_to_mih,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,2)+" mi/h"})})},get_speed_max:function(){return this.m_to_km(this._info.speed.max)*3600},get_speed_max_imp:function(){return this.to_miles(this.get_speed_max())},get_average_hr:function(){return this._info.hr.avg},get_average_temp:function(){return this._info.atemp.avg},get_average_cadence:function(){return this._info.cad.avg},get_heartrate_data:function(){var t=this;return this._info.hr._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" bpm"})})},get_heartrate_data_imp:function(){var t=this;return this._info.hr._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,null,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" bpm"})})},get_cadence_data:function(){var t=this;return this._info.cad._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" rpm"})})},get_temp_data:function(){var t=this;return this._info.atemp._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" degrees"})})},get_cadence_data_imp:function(){var t=this;return this._info.cad._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,null,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" rpm"})})},get_temp_data_imp:function(){var t=this;return this._info.atemp._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,null,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" degrees"})})},reload:function(){this._init_info(),this.clearLayers(),this._parse(this._gpx,this.options,this.options.async)},_merge_objs:function(t,e){var n={};for(var a in t)n[a]=t[a];for(var a in e)n[a]=e[a];return n},_prepare_data_point:function(t,e,n,a){var r=[e&&e(t[0])||t[0],n&&n(t[1])||t[1]];return r.push(a&&a(r[0],r[1])||r[0]+": "+r[1]),r},_prepare_markers:function(t){function e(n){return new L.GPXTrackIcon({iconUrl:n})}return Object.entries(t).forEach(([n,a])=>{n==="wptIcons"||n==="wptTypeIcons"?t[n]=this._prepare_markers(a):n==="pointMatchers"?t[n]=a.map(r=>(typeof r.icon=="string"&&(r.icon=e(r.icon)),r)):typeof a=="string"?t[n]=e(a):typeof a=="object"&&a!==null&&(t[n]=a)}),t},_init_info:function(){this._info={name:null,length:0,elevation:{gain:0,loss:0,max:0,min:1/0,_points:[]},speed:{max:0,_points:[]},hr:{avg:0,_total:0,_points:[]},duration:{start:null,end:null,moving:0,total:0},atemp:{avg:0,_total:0,_points:[]},cad:{avg:0,_total:0,_points:[]}}},_load_xml:function(t,e,n,a){a==null&&(a=this.options.async),n==null&&(n=this.options);var r=this,i=new window.XMLHttpRequest;i.open("GET",t,a);try{i.overrideMimeType("text/xml")}catch{}i.onloadend=function(){i.status==200?e(i.responseXML,n):r.fire("error",{err:"Error fetching resource: "+t})},i.send(null)},_parse:function(t,e,n){var a=this,r=function(s,l){var c=a._parse_gpx_data(s,l);if(!c){a.fire("error",{err:"No parseable layers of type(s) "+JSON.stringify(l.gpx_options.parseElements)});return}a.addLayer(c),a.fire("loaded",{layers:c,element:s})};if(t.substr(0,1)==="<"){var i=new DOMParser;n?setTimeout(function(){r(i.parseFromString(t,"text/xml"),e)}):r(i.parseFromString(t,"text/xml"),e)}else this._load_xml(t,r,e,n)},_parse_gpx_data:function(t,e){var n,a,r=[],i=t.getElementsByTagName("name");i.length>0&&(this._info.name=i[0].textContent);var s=t.getElementsByTagName("desc");s.length>0&&(this._info.desc=s[0].textContent);var l=t.getElementsByTagName("author");l.length>0&&(this._info.author=l[0].textContent);var c=t.getElementsByTagName("copyright");c.length>0&&(this._info.copyright=c[0].textContent);var u=e.gpx_options.parseElements;if(u.indexOf("route")>-1){var d=t.getElementsByTagName("rte");for(n=0;n<d.length;n++){var h=d[n],p=this._extract_styling(h),f=this._get_polyline_options(e.polyline_options,n);r=r.concat(this._parse_segment(d[n],e,p,f,"rtept"))}}if(u.indexOf("track")>-1){var y=t.getElementsByTagName("trk");for(n=0;n<y.length;n++){var v=y[n],p=this._extract_styling(v),f=this._get_polyline_options(e.polyline_options,n);if(e.gpx_options.joinTrackSegments)r=r.concat(this._parse_segment(v,e,p,f,"trkpt"));else{var w=v.getElementsByTagName("trkseg");for($=0;$<w.length;$++)r=r.concat(this._parse_segment(w[$],e,p,f,"trkpt"))}}}if(this._info.hr.avg=Math.round(this._info.hr._total/this._info.hr._points.length),this._info.cad.avg=Math.round(this._info.cad._total/this._info.cad._points.length),this._info.atemp.avg=Math.round(this._info.atemp._total/this._info.atemp._points.length),u.indexOf("waypoint")>-1)for(a=t.getElementsByTagName("wpt"),n=0;n<a.length;n++){var S=new L.LatLng(a[n].getAttribute("lat"),a[n].getAttribute("lon")),M=a[n].getElementsByTagName("name"),i=M.length>0?M[0].textContent:"",_=a[n].getElementsByTagName("desc"),s=_.length>0?_[0].textContent:"",E=a[n].getElementsByTagName("sym"),b=E.length>0?E[0].textContent:null,T=a[n].getElementsByTagName("type"),k=T.length>0?T[0].textContent:null,A=e.markers.wptIcons,P=e.markers.wptTypeIcons,I=e.markers.pointMatchers||[],D;if(A&&b&&A[b])D=A[b];else if(P&&k&&P[k])D=P[k];else if(I.length>0){for(var $=0;$<I.length;$++)if(I[$].regex.test(i)){D=I[$].icon;break}}else A&&A[""]&&(D=A[""]);if(!D){console.log("No waypoint icon could be matched for symKey=%s,typeKey=%s,name=%s on waypoint %o",b,k,i,a[n]);continue}var O=new L.Marker(S,{clickable:e.marker_options.clickable,title:i,icon:D,type:"waypoint"});O.bindPopup("<b>"+i+"</b>"+(s.length>0?"<br>"+s:"")).openPopup(),this.fire("addpoint",{point:O,point_type:"waypoint",element:a[n]}),r.push(O)}if(r.length>1)return new L.FeatureGroup(r);if(r.length==1)return r[0]},_parse_segment:function(t,e,n,a,r){var i=t.getElementsByTagName(r);if(!i.length)return[];for(var s=[],l=[],c=[],u=null,d=0;d<i.length;d++){var h,p=new L.LatLng(i[d].getAttribute("lat"),i[d].getAttribute("lon"));p.meta={time:null,ele:null,hr:null,cad:null,atemp:null,speed:null},h=i[d].getElementsByTagName("time"),h.length>0?p.meta.time=new Date(Date.parse(h[0].textContent)):p.meta.time=new Date("1970-01-01T00:00:00");var f=u!=null?Math.abs(p.meta.time-u.meta.time):0;h=i[d].getElementsByTagName("ele"),h.length>0?p.meta.ele=parseFloat(h[0].textContent):p.meta.ele=u!=null?u.meta.ele:null;var y=u!=null?p.meta.ele-u.meta.ele:0,v=u!=null?this._dist3d(u,p):0;if(h=i[d].getElementsByTagName("speed"),h.length>0?p.meta.speed=parseFloat(h[0].textContent):p.meta.speed=f>0?1e3*v/f:0,h=i[d].getElementsByTagName("name"),h.length>0){for(var w=h[0].textContent,S=e.markers.pointMatchers||[],M=0;M<S.length;M++)if(S[M].regex.test(w)){l.push({label:w,coords:p,icon:S[M].icon,element:i[d]});break}}this._info.length+=v,h=i[d].getElementsByTagNameNS("*","hr"),h.length>0&&(p.meta.hr=parseInt(h[0].textContent),this._info.hr._points.push([this._info.length,p.meta.hr]),this._info.hr._total+=p.meta.hr),h=i[d].getElementsByTagNameNS("*","cad"),h.length>0&&(p.meta.cad=parseInt(h[0].textContent),this._info.cad._points.push([this._info.length,p.meta.cad]),this._info.cad._total+=p.meta.cad),h=i[d].getElementsByTagNameNS("*","atemp"),h.length>0&&(p.meta.atemp=parseInt(h[0].textContent),this._info.atemp._points.push([this._info.length,p.meta.atemp]),this._info.atemp._total+=p.meta.atemp),p.meta.ele>this._info.elevation.max&&(this._info.elevation.max=p.meta.ele),p.meta.ele<this._info.elevation.min&&(this._info.elevation.min=p.meta.ele),this._info.elevation._points.push([this._info.length,p.meta.ele]),p.meta.speed>this._info.speed.max&&(this._info.speed.max=p.meta.speed),this._info.speed._points.push([this._info.length,p.meta.speed]),u==null&&this._info.duration.start==null&&(this._info.duration.start=p.meta.time),this._info.duration.end=p.meta.time,this._info.duration.total+=f,f<e.max_point_interval&&(this._info.duration.moving+=f),y>0?this._info.elevation.gain+=y:this._info.elevation.loss+=Math.abs(y),u=p,s.push(p)}var _=new L.Polyline(s,this._extract_styling(t,n,a));if(this.fire("addline",{line:_,element:t}),c.push(_),e.markers.startIcon){var E=new L.Marker(s[0],{clickable:e.marker_options.clickable,icon:e.markers.startIcon});this.fire("addpoint",{point:E,point_type:"start",element:i[0],line:t}),c.push(E)}if(e.markers.endIcon){var E=new L.Marker(s[s.length-1],{clickable:e.marker_options.clickable,icon:e.markers.endIcon});this.fire("addpoint",{point:E,point_type:"end",element:i[i.length-1],line:t}),c.push(E)}for(var d=0;d<l.length;d++){var E=new L.Marker(l[d].coords,{clickable:e.marker_options.clickable,title:l[d].label,icon:l[d].icon});this.fire("addpoint",{point:E,point_type:"label",element:l[d].element}),c.push(E)}return c},_get_polyline_options:function(t,e){return Array.isArray(t)?t[e]||{}:t},_extract_styling:function(t,e,n){var a=this._merge_objs(oc,e),r=t.getElementsByTagNameNS(ac,"line");if(r.length>0){var i=r[0].getElementsByTagName("color");i.length>0&&(a.color="#"+i[0].textContent);var i=r[0].getElementsByTagName("opacity");i.length>0&&(a.opacity=i[0].textContent);var i=r[0].getElementsByTagName("weight");i.length>0&&(a.weight=i[0].textContent);var i=r[0].getElementsByTagName("linecap");i.length>0&&(a.lineCap=i[0].textContent);var i=r[0].getElementsByTagName("linejoin");i.length>0&&(a.lineJoin=i[0].textContent);var i=r[0].getElementsByTagName("dasharray");i.length>0&&(a.dashArray=i[0].textContent);var i=r[0].getElementsByTagName("dashoffset");i.length>0&&(a.dashOffset=i[0].textContent)}return this._merge_objs(a,n)},_dist2d:function(t,e){var n=6371e3,a=this._deg2rad(e.lat-t.lat),r=this._deg2rad(e.lng-t.lng),i=Math.sin(a/2)*Math.sin(a/2)+Math.cos(this._deg2rad(t.lat))*Math.cos(this._deg2rad(e.lat))*Math.sin(r/2)*Math.sin(r/2),s=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)),l=n*s;return l},_dist3d:function(t,e){var n=this._dist2d(t,e),a=Math.abs(e.meta.ele-t.meta.ele);return Math.sqrt(Math.pow(n,2)+Math.pow(a,2))},_deg2rad:function(t){return t*Math.PI/180}});let cr=!1;function Je(t,e,n){console.log(`setupCheckbox called for id: ${t}`);const a=document.getElementById(t);a?(a._changeHandler&&(a.removeEventListener("change",a._changeHandler),console.log(`Removed previous change listener for ${t}`)),a._changeHandler=r=>{console.log(`Change event fired for ${t}, checked: ${a.checked}, event:`,r),r.stopPropagation(),n(a)},a.addEventListener("change",a._changeHandler),a.addEventListener("click",r=>{console.log(`Click event on ${t}, checked: ${a.checked}, target:`,r.target)}),console.log(`Attached change and click listeners to ${t}`),t==="showLandingPattern"&&!(m.isFeatureUnlocked("landingPattern")&&m.state.isLandingPatternUnlocked)&&(a.style.opacity="0.5",a.title="Feature locked. Click to enter password.")):console.warn(`Checkbox ${t} not found`)}function ra(t,e){document.querySelectorAll(`input[name="${t}"]`).forEach(a=>{a.addEventListener("change",()=>{const r=document.querySelector(`input[name="${t}"]:checked`);if(!r)return;const i=r.value;if(m.state.userSettings[t]=i,m.save(),console.log(`${t} changed to: ${i} and saved to localStorage`),t==="landingDirection"){const s=document.getElementById("customLandingDirectionLL"),l=document.getElementById("customLandingDirectionRR");s&&(s.disabled=i!=="LL"),l&&(l.disabled=i!=="RR"),i==="LL"&&s&&!s.value&&m.state.userSettings.customLandingDirectionLL===""&&(s.value=Math.round(o.landingWindDir||0),m.state.userSettings.customLandingDirectionLL=parseInt(s.value),m.save(),console.log(`Set customLandingDirectionLL to ${s.value}`)),i==="RR"&&l&&!l.value&&m.state.userSettings.customLandingDirectionRR===""&&(l.value=Math.round(o.landingWindDir||0),m.state.userSettings.customLandingDirectionRR=parseInt(l.value),m.save(),console.log(`Set customLandingDirectionRR to ${l.value}`))}document.dispatchEvent(new CustomEvent("ui:radioGroupChanged",{detail:{name:t,value:i}})),e&&e()})})}function q(t,e,n,a){const r=document.getElementById(t);r&&r.addEventListener(e,g.debounce(()=>{const i=r.type==="number"?parseFloat(r.value):r.value;a&&a(i)===!1||(m.state.userSettings[t]=i,m.save(),console.log(`${t} changed to: ${i} and saved to localStorage`),document.dispatchEvent(new CustomEvent("ui:inputChanged",{detail:{name:t,value:i}})))},n))}function lc(){const t=document.querySelector(".main-layout"),e=document.querySelectorAll(".sidebar-icon"),n=document.querySelectorAll(".panel"),a=document.querySelector('.sidebar-icon[data-panel-id="panel-planner"]');let r=null;if(!t||!a){console.error("Layout-Elemente für Sidebar-Logik nicht gefunden.");return}const i=()=>{m.isFeatureUnlocked("planner")?(a.style.opacity="1",a.title="Planner"):(a.style.opacity="0.5",a.title="Feature locked. Click to enter password.")};i(),e.forEach(s=>{s.addEventListener("click",()=>{const l=s.dataset.panelId;if(l==="panel-planner"&&!m.isFeatureUnlocked("planner")){m.showPasswordModal("planner",()=>{i(),s.click()},()=>{i()});return}const c=t.classList.contains("sidebar-expanded")&&r===l;t.classList.remove("sidebar-expanded","data-panel-visible"),e.forEach(u=>u.classList.remove("active")),c?r=null:(t.classList.add("sidebar-expanded"),s.classList.add("active"),r=l,n.forEach(u=>u.classList.toggle("hidden",u.id!==l)),l==="panel-data"&&t.classList.add("data-panel-visible")),setTimeout(()=>{o.map&&o.map.invalidateSize({animate:!0})},300)})})}function cc(){document.querySelectorAll(".accordion-header").forEach(e=>{e.addEventListener("click",()=>{e.parentElement.classList.toggle("active")})})}function uc(){const t=document.getElementById("timeSlider");t&&(t.addEventListener("input",()=>{document.dispatchEvent(new CustomEvent("ui:sliderChanged",{detail:{sliderValue:t.value},bubbles:!0,cancelable:!0}))}),t.addEventListener("change",async()=>{document.dispatchEvent(new CustomEvent("ui:sliderChangeFinished",{detail:{sliderValue:t.value},bubbles:!0,cancelable:!0}))}))}function dc(){const t=document.getElementById("modelSelect");t&&(t.addEventListener("change",()=>{const e=t.value;console.log("Model select changed to:",e),m.state.userSettings.model=e,m.save(),document.dispatchEvent(new CustomEvent("ui:modelChanged",{detail:{model:e}}))}),document.addEventListener("models:available",e=>{const{availableModels:n}=e.detail;dl(n),Nc(n),ml(n)}))}function mc(){Pi(),console.log("Coordinate events setup complete.")}function hc(){if(console.log("App: Richte Event-Listener für Karten-Events ein."),!o.map){console.error("Karte nicht initialisiert, Event-Listener können nicht gesetzt werden.");return}const t=()=>{document.dispatchEvent(new CustomEvent("map:moved"))},e=g.debounce(()=>{Ma({map:o.map,baseMaps:o.baseMaps,onProgress:$t,onComplete:n=>{We(),n&&g.handleMessage(n)},onCancel:()=>{We(),g.handleMessage("Caching cancelled.")}})},1e3);o.map.on("zoomend",t),o.map.on("moveend",t),o.map.on("moveend",e)}function fc(){const t=document.getElementById("modelInfoButton"),e=document.getElementById("modelInfoPopup");!t||!e||(t.addEventListener("click",n=>{n.stopPropagation();const a=e.style.display==="block";e.style.display=a?"none":"block"}),document.addEventListener("click",n=>{e.style.display==="block"&&!t.contains(n.target)&&(e.style.display="none")}))}function gc(){document.querySelectorAll(".info-icon").forEach(e=>{const n=e.nextElementSibling;if(n&&n.classList.contains("info-popup")){const a=e.dataset.info;a&&(n.textContent=a),e.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),document.querySelectorAll(".info-popup").forEach(s=>{s!==n&&(s.style.display="none")});const i=n.style.display==="block";n.style.display=i?"none":"block"})}}),document.addEventListener("click",e=>{e.target.closest(".info-icon")||document.querySelectorAll(".info-popup").forEach(n=>{n.style.display="none"})})}function pc(){console.log("App: Richte Event-Listener für Track-Einstellungen ein.");const t=(a,r)=>{const i=document.getElementById(a);i&&(i.value=m.state.userSettings[r]||0,console.log(`Set ${a} to initial value:`,i.value),i.addEventListener("input",()=>{const s=parseFloat(i.value);isNaN(s)||(m.state.userSettings[r]=s,m.save(),ie())}))};t("numberOfJumpers","numberOfJumpers"),t("jumperSeparation","jumperSeparation"),t("jumpRunTrackOffset","jumpRunTrackOffset"),t("jumpRunTrackForwardOffset","jumpRunTrackForwardOffset");const e=document.getElementById("jumpRunTrackDirection");e&&(e.value=m.state.userSettings.customJumpRunDirection||"",e.addEventListener("change",()=>{const a=parseFloat(e.value);Number.isFinite(a)&&a>=0&&a<=360?(m.state.userSettings.customJumpRunDirection=a,console.log("Setting 'customJumpRunDirection' on change to:",a)):(m.state.userSettings.customJumpRunDirection=null,e.value="",console.log("Invalid direction, resetting to calculated.")),m.save(),ie()}));const n=document.getElementById("showJumpRunTrack");n&&n.addEventListener("change",a=>{m.state.userSettings.showJumpRunTrack=a.target.checked,m.save(),ie()})}function yc(){const t=document.querySelectorAll('input[name="cutAwayState"]');if(t.length===0)return;const e=m.state.userSettings.cutAwayState||"Partially",n=document.querySelector(`input[name="cutAwayState"][value="${e}"]`);n&&(n.checked=!0),t.forEach(a=>{a.addEventListener("change",()=>{a.checked&&(console.log(`Cut Away State changed to: ${a.value}`),m.state.userSettings.cutAwayState=a.value,m.save(),document.dispatchEvent(new CustomEvent("ui:recalculateJump")))})})}function wc(){const t=document.getElementById("resetCutAwayMarker");t&&t.addEventListener("click",()=>{if(!o.map){console.warn("Map not initialized, cannot reset cut-away marker");return}o.cutAwayMarker&&(o.map.removeLayer(o.cutAwayMarker),o.cutAwayMarker=null,o.cutAwayLat=null,o.cutAwayLng=null,console.log("Cut-away marker reset"),o.cutAwayCircle&&(o.map.removeLayer(o.cutAwayCircle),o.cutAwayCircle=null,console.log("Cleared cut-away circle")),document.getElementById("info").innerHTML="Right-click map to place cut-away marker")})}function vc(){const t=document.getElementById("deselectAllEnsembleButton");t&&t.addEventListener("click",()=>{document.querySelectorAll('#ensembleModelsSubmenu input[type="checkbox"]').forEach(n=>{n.checked=!1}),m.state.userSettings.selectedEnsembleModels=[],m.save(),o.ensembleModelsData=null,Mn(),g.handleMessage("All ensemble models deselected.")})}function Lc(){const t=document.getElementById("uploadTrackButton"),e=document.getElementById("trackFileInput"),n=document.getElementById("fileNameDisplay"),a=document.getElementById("clearTrack");if(!t||!e||!n||!a){console.error("One or more track upload elements are missing from the DOM.");return}t.addEventListener("click",()=>{e.click()}),e.addEventListener("change",async r=>{const i=document.getElementById("loading");if(r.target.files&&r.target.files.length>0){const s=r.target.files[0];n.textContent=s.name,n.style.fontStyle="normal",i&&(i.style.display="block");const l=s.name.split(".").pop().toLowerCase();try{l==="gpx"?await Xl(s):l==="csv"?await Ql(s):g.handleError("Unsupported file type. Please upload a .gpx or .csv file.")}catch(c){console.error("Error during track file processing:",c),g.handleError("Failed to process track file.")}finally{i&&(i.style.display="none")}}}),a.addEventListener("click",r=>{if(r.stopPropagation(),!o.map){g.handleError("Cannot clear track: map not initialized.");return}if(o.gpxLayer)try{o.map.hasLayer(o.gpxLayer)&&o.map.removeLayer(o.gpxLayer),o.gpxLayer=null,o.gpxPoints=[],o.isTrackLoaded=!1,e.value="",n.textContent="No file chosen",n.style.fontStyle="italic"}catch(i){g.handleError("Failed to clear track: "+i.message)}else g.handleMessage("No track to clear.")})}function Mc(){Y(),ke(),m.getValue("heightUnit","m");const t=document.getElementById("exportGpxButton");t&&t.addEventListener("click",async()=>{const n=Y(),a=ke(),r=m.getValue("heightUnit","m");await ec(n,a,r)});const e=document.getElementById("exportLandingPatternGpxButton");e&&e.addEventListener("click",()=>{console.log("DEBUG: Klick auf 'exportLandingPatternGpxButton' registriert."),tc()})}function Sc(){if(!o.map){console.warn("Map not initialized, skipping setupCheckboxEvents");return}Je("showExitAreaCheckbox","showExitArea",a=>{m.state.userSettings.showExitArea=a.checked,m.save(),document.dispatchEvent(new CustomEvent("ui:jumpFeatureChanged"))}),Je("showCanopyAreaCheckbox","showCanopyArea",a=>{m.state.userSettings.showCanopyArea=a.checked,m.save(),document.dispatchEvent(new CustomEvent("ui:jumpFeatureChanged"))}),Je("showJumpRunTrack","showJumpRunTrack",a=>{m.state.userSettings.showJumpRunTrack=a.checked,m.save(),document.dispatchEvent(new CustomEvent("ui:showJumpRunTrackChanged",{detail:{checked:a.checked}}))}),Je("showCutAwayFinder","showCutAwayFinder",a=>{m.state.userSettings.showCutAwayFinder=a.checked,m.save(),document.dispatchEvent(new CustomEvent("ui:showCutAwayFinderChanged",{detail:{checked:a.checked}}))}),Je("showLandingPattern","showLandingPattern",a=>{m.state.userSettings.showLandingPattern=a.checked,m.save();const r=a.closest("li")?.querySelector("ul.submenu");r&&r.classList.toggle("hidden",!a.checked),a.checked?document.dispatchEvent(new CustomEvent("ui:landingPatternEnabled")):document.dispatchEvent(new CustomEvent("ui:landingPatternDisabled"))}),Je("trackPositionCheckbox","trackPosition",a=>{m.state.userSettings.trackPosition=a.checked,m.save(),document.dispatchEvent(new CustomEvent("ui:trackPositionToggled",{detail:{checked:a.checked}}))}),Je("showJumpMasterLine","showJumpMasterLine",a=>{if(a.checked&&!m.state.userSettings.trackPosition){a.checked=!1,g.handleError("Please start Live Tracking first.");return}m.state.userSettings.showJumpMasterLine=a.checked,m.save(),document.dispatchEvent(new CustomEvent("ui:showJumpMasterLineChanged"));const r=a.closest("li")?.querySelector("ul.submenu");r&&r.classList.toggle("hidden",!a.checked)}),ra("jumpMasterLineTarget",()=>{const a=m.getValue("jumpMasterLineTarget","radio","DIP");m.state.userSettings.jumpMasterLineTarget=a,m.save(),console.log("jumpMasterLineTarget changed:",a),document.dispatchEvent(new CustomEvent("ui:jumpMasterLineTargetChanged"))});const t=document.getElementById("placeHarpButton");t&&t.addEventListener("click",()=>{o.isPlacingHarp=!0,console.log("HARP placement mode activated"),o.map.on("click",Ti),g.handleMessage("Click the map to place the HARP marker");const a=document.querySelector(".main-layout");a&&a.classList.remove("sidebar-expanded","data-panel-visible"),document.querySelectorAll(".sidebar-icon.active").forEach(r=>r.classList.remove("active")),setTimeout(()=>{o.map&&o.map.invalidateSize({animate:!0})},300)});const e=document.getElementById("clearHarpButton");e&&e.addEventListener("click",Ul);const n=document.querySelector(".hamburger-menu");n&&n.addEventListener("click",a=>{console.log("Menu click:",a.target,"class:",a.target.className,"id:",a.target.id)})}function Ec(){ra("landingDirection",()=>{}),ra("jumpMasterLineTarget",()=>{document.dispatchEvent(new CustomEvent("ui:jumpMasterLineTargetChanged"))}),document.querySelectorAll('input[name="ensembleScenario"]').forEach(a=>{a.addEventListener("change",async()=>{if(a.checked){if(m.state.userSettings.currentEnsembleScenario=a.value,o.currentEnsembleScenario=a.value,m.save(),console.log("Ensemble scenario changed to:",a.value),!m.state.userSettings.selectedEnsembleModels.every(s=>o.ensembleModelsData&&o.ensembleModelsData[s])&&a.value!=="all_models"&&!await La()){g.handleError("Failed to fetch data for scenario.");return}const i=Y();ht(i)}})});const e=m.state.userSettings.currentEnsembleScenario||"all_models",n=document.querySelector(`input[name="ensembleScenario"][value="${e}"]`);n&&(n.checked=!0,o.currentEnsembleScenario=e),o.map&&!o.ensembleLayerGroup&&(o.ensembleLayerGroup=L.layerGroup().addTo(o.map))}function bc(){["refLevel","heightUnit","temperatureUnit","windUnit","timeZone","coordFormat","downloadFormat"].forEach(e=>{const n=document.getElementById(e);n?n.addEventListener("change",()=>{const a=n.value;m.state.userSettings[e]=a,m.save(),console.log(`Setting '${e}' changed to: ${a} and saved.`),document.dispatchEvent(new CustomEvent("ui:settingChanged",{detail:{name:e,value:a}}))}):console.warn(`Select element with id '${e}' not found.`)})}function _c(){const t=(e,n)=>{const a=document.getElementById(e);a&&a.addEventListener("blur",()=>{let r=parseInt(a.value)||n;const i=document.getElementById("legHeightFinal"),s=document.getElementById("legHeightBase"),l=document.getElementById("legHeightDownwind");if(!(!isNaN(r)&&r>=50&&r<=1e3&&g.validateLegHeights(i,s,l))){let u=n;const d=parseInt(i.value)||100,h=parseInt(s.value)||200,p=parseInt(l.value)||300;e==="legHeightFinal"&&(u=Math.min(h-1,100)),e==="legHeightBase"&&(u=Math.max(d+1,Math.min(p-1,200))),e==="legHeightDownwind"&&(u=Math.max(h+1,300)),a.value=u,r=u,g.handleError(`Adjusted ${e} to ${u} to maintain valid leg order.`)}m.state.userSettings[e]=r,m.save(),document.dispatchEvent(new CustomEvent("ui:inputChanged",{detail:{name:e,value:r}}))})};t("legHeightFinal",100),t("legHeightBase",200),t("legHeightDownwind",300),q("lowerLimit","change",300),q("upperLimit","change",300),q("openingAltitude","change",300,e=>isNaN(e)||e<500||e>15e3?(g.handleError("Opening altitude must be between 500 and 15000 meters."),document.dispatchEvent(new CustomEvent("ui:invalidInput",{detail:{id:"openingAltitude",defaultValue:1200}})),!1):!0),q("exitAltitude","change",300,e=>isNaN(e)||e<500||e>15e3?(g.handleError("Exit altitude must be between 500 and 15000 meters."),document.dispatchEvent(new CustomEvent("ui:invalidInput",{detail:{id:"exitAltitude",defaultValue:3e3}})),!1):!0),q("safetyHeight","change",300),q("canopySpeed","change",300),q("descentRate","change",300),q("interpStep","change",300,null),q("customLandingDirectionLL","input",100),q("customLandingDirectionRR","input",100),q("jumpRunTrackDirection","change",0),q("jumpRunTrackOffset","change",0),q("jumpRunTrackForwardOffset","change",0),q("aircraftSpeedKt","change",300),q("numberOfJumpers","change",300),q("jumperSeparation","change",300),q("cutAwayAltitude","change",300),q("historicalDatePicker","change",300)}function kc(){const t=document.getElementById("downloadButton");t&&t.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("ui:downloadClicked"))})}function Tc(){const t=document.getElementById("clearHistoricalDate");t&&t.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("ui:clearDateClicked"))})}function Ac(){const t=document.getElementById("app-management-settings");if(!t){console.error("Ziel-Container für App-Management-Buttons nicht gefunden.");return}const e=document.createElement("div");e.id="settings-cache-buttons",e.className="settings-grid";const n=document.createElement("button");n.id="resetButton",n.textContent="Reset Settings",n.title="Resets all settings to their default values and locks all features",n.className="btn btn-danger",n.addEventListener("click",()=>{confirm("Are you sure you want to reset all settings and lock all features?")&&(localStorage.removeItem("unlockedFeatures"),localStorage.removeItem("upperWindsSettings"),window.location.reload())}),e.appendChild(document.createElement("label")),e.appendChild(n);const a=document.createElement("button");a.id="clearCacheButton",a.textContent="Clear Tile Cache",a.title="Clears cached map tiles. Pan/zoom to cache more tiles for offline use.",a.className="btn btn-danger",a.addEventListener("click",async()=>{try{const r=await oe.getCacheSize();await oe.clearCache(),g.handleMessage(`Tile cache cleared successfully (freed ${r.toFixed(2)} MB).`)}catch(r){g.handleError("Failed to clear tile cache: "+r.message)}}),e.appendChild(document.createElement("label")),e.appendChild(a),t.appendChild(e)}function Cc(){const t=document.getElementById("cacheRadiusSelect");t?(t.value=m.state.userSettings.cacheRadiusKm||10,t.addEventListener("change",()=>{if(!m.state||!m.state.userSettings){console.error("Settings not properly initialized");return}let r=parseInt(t.value,10);isNaN(r)||r<1?(r=1,g.handleMessage("Cache radius must be at least 1 km.")):r>50&&(r=50,g.handleMessage("Cache radius cannot exceed 50 km.")),t.value=r,m.state.userSettings.cacheRadiusKm=r,m.save(),console.log("Updated cacheRadiusKm:",m.state.userSettings.cacheRadiusKm)}),console.log("cacheRadiusSelect listener attached, initial value:",t.value)):console.warn("cacheRadiusSelect not found in DOM");const e=document.getElementById("cacheZoomMin"),n=document.getElementById("cacheZoomMax");if(e&&n){const r=()=>{let s=parseInt(e.value,10),l=parseInt(n.value,10);(isNaN(s)||s<6)&&(s=6),(isNaN(l)||l>15)&&(l=15),s>l&&(l=s,n.value=l,g.handleMessage("Max zoom cannot be less than min zoom.")),e.value=s,n.value=l;const c=Array.from({length:l-s+1},(u,d)=>s+d);m.state.userSettings.cacheZoomLevels=c,m.save(),console.log("Updated cacheZoomLevels:",m.state.userSettings.cacheZoomLevels)},i=m.state.userSettings.cacheZoomLevels||[11,12,13,14];e.value=Math.min(...i),n.value=Math.max(...i),e.addEventListener("change",r),n.addEventListener("change",r)}else console.warn("Zoom level input fields not found in DOM");const a=document.getElementById("recacheNowButton");a?(a.addEventListener("click",()=>{_i({map:o.map,lastLat:o.lastLat,lastLng:o.lastLng,baseMaps:o.baseMaps,onProgress:$t,onComplete:r=>{We(),r&&He(r)},onCancel:()=>{We(),He("Caching cancelled.")}})}),console.log("recacheNowButton listener attached")):console.warn("recacheNowButton not found in DOM")}function Ic(){const t=document.getElementById("harpCoordInput"),e=document.getElementById("placeHarpCoordButton"),n=document.querySelector('input[name="jumpMasterLineTarget"][value="HARP"]');if(!t||!e||!n){console.warn("HARP coordinate input elements not found. Skipping setup.");return}e.addEventListener("click",async()=>{const a=t.value.trim();if(!a){g.handleError("Please enter coordinates.");return}const r=Ii(a);if(r){o.harpMarker&&o.map.removeLayer(o.harpMarker),o.harpMarker=Ai(r.lat,r.lng).addTo(o.map),o.map.panTo([r.lat,r.lng]),m.state.userSettings.harpLat=r.lat,m.state.userSettings.harpLng=r.lng,m.save(),g.handleMessage("HARP marker placed successfully."),n.disabled=!1,n.checked=!0,document.dispatchEvent(new CustomEvent("ui:jumpMasterLineTargetChanged")),document.dispatchEvent(new CustomEvent("ui:recalculateJump")),document.dispatchEvent(new CustomEvent("harp:updated"));const i=document.querySelector(".main-layout");i&&i.classList.remove("sidebar-expanded","data-panel-visible"),document.querySelectorAll(".sidebar-icon.active").forEach(s=>s.classList.remove("active")),setTimeout(()=>{o.map&&o.map.invalidateSize({animate:!0})},300)}else g.handleError("Invalid coordinates. Please enter a valid MGRS or Decimal Degree format.")})}function Nc(t){const e=document.getElementById("ensembleModelsSubmenu");e&&(e.innerHTML="",t.forEach(n=>{const a=document.createElement("li"),r=document.createElement("label");r.className="radio-label";const i=document.createElement("input");i.type="checkbox",i.name="ensembleModel",i.value=n,i.checked=m.state.userSettings.selectedEnsembleModels.includes(n),i.addEventListener("change",async()=>{const s=Array.from(e.querySelectorAll("input:checked")).map(c=>c.value);if(m.state.userSettings.selectedEnsembleModels=s,m.save(),await La()){const c=Y();ht(c)}}),r.append(i,` ${n.replace(/_/g," ").toUpperCase()}`),a.appendChild(r),e.appendChild(a)}))}function Pc(){cr||(console.log("Initializing all UI event listeners..."),lc(),cc(),uc(),dc(),mc(),fc(),gc(),Sc(),Ec(),bc(),_c(),kc(),Tc(),pc(),yc(),wc(),vc(),Lc(),Mc(),Ac(),Cc(),Ic(),hc(),cr=!0,console.log("Event listeners initialized successfully (first and only time)."))}function ur(){if(o.autoupdateInterval){console.log("[AutoupdateManager] Autoupdate is already running.");return}if(!navigator.onLine){g.handleError("Cannot enable autoupdate while offline.");const t=document.getElementById("autoupdateCheckbox");t&&(t.checked=!1),m.state.userSettings.autoupdate=!1,m.save();return}console.log("[AutoupdateManager] Starting autoupdate interval."),document.dispatchEvent(new CustomEvent("autoupdate:tick",{detail:{isInitialTick:!0}})),o.autoupdateInterval=setInterval(()=>{console.log("[AutoupdateManager] Tick..."),document.dispatchEvent(new CustomEvent("autoupdate:tick",{detail:{isInitialTick:!1}}))},60*1e3),g.handleMessage("Autoupdate enabled")}function $i(){o.autoupdateInterval&&(clearInterval(o.autoupdateInterval),o.autoupdateInterval=null,console.log("[AutoupdateManager] Stopped autoupdate interval."),g.handleMessage("Autoupdate disabled"))}function Dc(){const t=document.getElementById("autoupdateCheckbox");if(!t){console.warn("[AutoupdateManager] Autoupdate checkbox not found.");return}t.checked=m.state.userSettings.autoupdate,t.addEventListener("change",()=>{m.state.userSettings.autoupdate=t.checked,m.save();const e=document.getElementById("historicalDatePicker");if(t.checked&&e?.value){t.checked=!1,m.state.userSettings.autoupdate=!1,m.save(),g.handleError("Autoupdate cannot be enabled with a historical date set.");return}t.checked?ur():$i()}),m.state.userSettings.autoupdate&&!document.getElementById("historicalDatePicker")?.value&&ur()}function dr(t){const n=`
        <div class="live-marker-wrapper" style="transform: rotate(${typeof t=="number"&&isFinite(t)?t:0}deg);">
            <div class="live-marker-dot"></div>
            <div class="live-marker-arrow"></div>
        </div>
    `;return L.divIcon({className:"live-marker-container",html:n,iconSize:[24,24],iconAnchor:[12,12],pmIgnore:!0})}function xc(t,e,n){o.accuracyCircle&&o.map.removeLayer(o.accuracyCircle),o.accuracyCircle=L.circle([t,e],{radius:n,color:"blue",fillOpacity:.1,weight:1,dashArray:"5, 5",pmIgnore:!0}).addTo(o.map)}const mr=g.debounce(async t=>{if(console.log("[LiveTrackingManager] Received position data:",t),!o.map){console.warn("[LiveTrackingManager] Map not initialized, skipping position update.");return}const{latitude:e,longitude:n,accuracy:a,altitude:r,altitudeAccuracy:i}=t.coords;if(o.recordedTrackPoints.length===0&&o.altitudeCorrectionOffset===0&&r!==null&&o.lastAltitude!=="N/A"){const w=Math.abs(r-o.lastAltitude);w<150?(o.altitudeCorrectionOffset=r-o.lastAltitude,console.log(`Bodenstart erkannt. Korrektur-Offset berechnet: ${o.altitudeCorrectionOffset.toFixed(2)}m`)):(o.altitudeCorrectionOffset=0,console.warn(`Start in der Luft erkannt (Höhendifferenz: ${w.toFixed(0)}m). Es wird keine Höhenkorrektur angewendet.`),g.handleMessage("Airborne start: Altitudes are uncorrected (Ellipsoid)."))}const s=r!==null&&o.altitudeCorrectionOffset!==0?r-o.altitudeCorrectionOffset:r,c=!o.liveMarker?500:ve.GEOLOCATION_ACCURACY_THRESHOLD_M;if(a>c){console.log(`[LiveTrackingManager] Skipping position update. Accuracy (${a}m) is lower than threshold (${c}m).`);return}const u=Date.now();let d=0,h="N/A",p=0;if(o.prevLat!==null&&o.prevLng!==null&&o.prevTime!==null&&o.prevAltitude!==null){const w=(u-o.prevTime)/1e3;w>Yt.MIN_TIME_DIFF_FOR_SPEED_CALC_S&&(d=o.map.distance([o.prevLat,o.prevLng],[e,n])/w,h=g.calculateBearing(o.prevLat,o.prevLng,e,n),p=(o.prevAltitude-r)/w)}const f=d<Yt.SPEED_SMOOTHING_TRESHOLD?Yt.SPEED_SMOOTHING_LOW:Yt.SPEED_SMOOTHING_HIGH;o.lastSmoothedSpeedMs=f*d+(1-f)*o.lastSmoothedSpeedMs;const y=.5;o.lastSmoothedDescentRateMps=y*p+(1-y)*(o.lastSmoothedDescentRateMps||0),o.liveMarker?(o.liveMarker.setLatLng([e,n]),o.liveMarker.setIcon(dr(h))):o.liveMarker=L.marker([e,n],{icon:dr(h),zIndexOffset:1e3,pmIgnore:!0}).addTo(o.map),a&&xc(e,n,a),o.prevLat=e,o.prevLng=n,o.prevTime=u,o.prevAltitude=r;const v=new CustomEvent("tracking:positionUpdated",{detail:{latitude:e,longitude:n,deviceAltitude:s,altitudeAccuracy:i,accuracy:a,speedMs:o.lastSmoothedSpeedMs,descentRateMps:o.lastSmoothedDescentRateMps,direction:typeof h=="number"?h.toFixed(0):"N/A"},bubbles:!0,cancelable:!0});document.dispatchEvent(v)},300);async function Fc(){const{Geolocation:t}=await tt();let e=await t.checkPermissions();if(console.log("Initial geolocation permissions state:",e),e.location==="denied")return g.handleError("GPS permission was denied. Please enable it in the app settings."),!1;if(e.location==="prompt"||e.location==="prompt-with-rationale")try{e=await t.requestPermissions(),console.log("New geolocation permissions state:",e)}catch(n){return console.error("Error requesting permissions:",n),g.handleError("Failed to request GPS permissions."),!1}if(e.location!=="granted")return g.handleError("GPS permission is required for live tracking."),!1;if(window.Capacitor.isNativePlatform()&&window.Capacitor.getPlatform()==="android"){const n=await BackgroundGeolocation.checkPermissions();if(console.log("Background geolocation permissions:",n),!n.hasPermission)try{await BackgroundGeolocation.requestPermissions(),console.log("Requested background permissions")}catch(a){return console.error("Error requesting background permissions:",a),g.handleError("Failed to request background location permissions."),!1}}return!0}async function $c(){if(o.watchId!==null){console.log("[LiveTrackingManager] Tracking already active, skipping start.");return}console.log("[LiveTrackingManager] Attempting to start position tracking...");const{Geolocation:t,BackgroundGeolocation:e,isNative:n}=await tt();if(!await Fc()){console.error("[LiveTrackingManager] Permissions denied, cannot start tracking.");return}if(n&&e)try{await Uc();const a={id:"primary-watcher",backgroundMessage:"Tracking your position for DZMaster.",backgroundTitle:"DZMaster is tracking",requestPermissions:!0,stale:!1,distanceFilter:5,foregroundService:!0,notificationTitle:"DZMaster Tracking",notificationText:"Tracking your position in the background."};await e.addWatcher(a,(r,i)=>{if(i){console.error(`[LiveTrackingManager] Background Geolocation error: ${i.message}`),g.handleError(`Background Geolocation error: ${i.message}`),ia();return}r&&(mr(r),Rc(r))}),o.watchId="primary-watcher",document.dispatchEvent(new CustomEvent("tracking:started")),console.log("[LiveTrackingManager] Background Geolocation watcher added."),Oc()}catch(a){console.error(`[LiveTrackingManager] Failed to start background tracking: ${a.message}`),g.handleError(`Failed to start background tracking: ${a.message}`)}else{if(console.log("[LiveTrackingManager] Using navigator.geolocation for tracking (Web)."),!navigator.geolocation){g.handleError("Geolocation is not supported by your browser."),document.dispatchEvent(new CustomEvent("tracking:stopped"));return}o.watchId=navigator.geolocation.watchPosition(a=>mr(a),a=>{console.error(`[LiveTrackingManager] Geolocation error: ${a.message}`),g.handleError(`Geolocation error: ${a.message}`),ia()},{enableHighAccuracy:!0,maximumAge:0,timeout:1e4}),document.dispatchEvent(new CustomEvent("tracking:started"))}}function Oc(){document.addEventListener("resume",async()=>{console.log("[LiveTrackingManager] App resumed, checking watcher status...")},{once:!1})}async function Rc(t){const{Filesystem:e,Directory:n}=await tt();if(!e)return;const{latitude:a,longitude:r,accuracy:i,altitude:s}=t.coords,l=s!==null&&o.altitudeCorrectionOffset!==0?s-o.altitudeCorrectionOffset:s,c={lat:a,lng:r,ele:l,time:N.utc().toISO()};try{const u=`track_${N.utc().toFormat("yyyyMMdd_HHmmss")}.json`;await e.appendFile({path:u,data:JSON.stringify(c)+`
`,directory:n.Data,encoding:"utf8"}),console.log(`[LiveTrackingManager] Saved track point to ${u}`)}catch(u){console.error(`[LiveTrackingManager] Error saving track point: ${u.message}`)}}async function ia(){if(o.watchId!==null){const{BackgroundGeolocation:t,isNative:e}=await tt();e&&t?(await t.removeWatcher({id:o.watchId}),console.log("[LiveTrackingManager] Stopped Capacitor Background Geolocation watcher.")):(navigator.geolocation.clearWatch(o.watchId),console.log("[LiveTrackingManager] Stopped navigator.geolocation watcher.")),o.watchId=null}o.liveMarker&&o.map.removeLayer(o.liveMarker),o.accuracyCircle&&o.map.removeLayer(o.accuracyCircle),o.liveMarker=null,o.accuracyCircle=null,o.prevLat=null,o.prevLng=null,o.altitudeCorrectionOffset=0,document.dispatchEvent(new CustomEvent("tracking:stopped"))}async function Uc(){if(window.Capacitor&&window.Capacitor.isNativePlatform()&&window.Capacitor.getPlatform()==="android")try{const{App:t}=await Ct(async()=>{const{App:e}=await Promise.resolve().then(()=>It);return{App:e}},void 0);await t.requestBatteryOptimizations(),console.log("[LiveTrackingManager] Requested battery optimization exemption.")}catch(t){console.error("[LiveTrackingManager] Error requesting battery optimization exemption:",t)}else console.log("[LiveTrackingManager] Battery optimization exemption not applicable (web or non-Android).")}const Oi=g.debounce(re,300);L.Control.Coordinates=L.Control.extend({options:{position:"bottomleft"},onAdd:function(t){var e=L.DomUtil.create("div","leaflet-control-coordinates");return e.style.background="rgba(255, 255, 255, 0.8)",e.style.padding="5px",e.style.borderRadius="4px",e.style.boxShadow="0 2px 5px rgba(0, 0, 0, 0.2)",e.innerHTML="Move mouse over map",this._container=e,e},update:function(t){this._container.innerHTML=t}});g.setErrorHandler(dn);g.setMessageHandler(He);g.handleMessage=He;const hn=()=>m.getValue("heightUnit","radio","m"),hr=()=>m.getValue("windUnit","radio","kt"),Ri=()=>m.getValue("coordFormat","radio","Decimal"),Hc=()=>m.getValue("downloadFormat","radio","csv");function Bc(){if(m.initialize(),el(!1),m.state.isLandingPatternUnlocked=m.state.unlockedFeatures.landingPattern,m.state.isCalculateJumpUnlocked=m.state.unlockedFeatures.calculateJump,m.state.userSettings.showJumpMasterLine=!1,console.log("Initial unlock status:",{isLandingPatternUnlocked:m.state.isLandingPatternUnlocked,isCalculateJumpUnlocked:m.state.isCalculateJumpUnlocked}),o.isInitialized){console.log("App already initialized, skipping");return}o.isInitialized=!0,console.log("Initializing app")}function Wc(){Ce("modelSelect",m.state.userSettings.model),Ce("refLevel",m.state.userSettings.refLevel),Ce("heightUnit",m.state.userSettings.heightUnit),Ce("temperatureUnit",m.state.userSettings.temperatureUnit),Ce("windUnit",m.state.userSettings.windUnit),Ce("timeZone",m.state.userSettings.timeZone),Ce("coordFormat",m.state.userSettings.coordFormat),Ce("downloadFormat",m.state.userSettings.downloadFormat),Jc("landingDirection",m.state.userSettings.landingDirection),K("canopySpeed",m.state.userSettings.canopySpeed),K("descentRate",m.state.userSettings.descentRate),K("legHeightDownwind",m.state.userSettings.legHeightDownwind),K("legHeightBase",m.state.userSettings.legHeightBase),K("legHeightFinal",m.state.userSettings.legHeightFinal),K("customLandingDirectionLL",m.state.userSettings.customLandingDirectionLL),K("customLandingDirectionRR",m.state.userSettings.customLandingDirectionRR),K("lowerLimit",m.state.userSettings.lowerLimit),K("upperLimit",m.state.userSettings.upperLimit),K("openingAltitude",m.state.userSettings.openingAltitude),K("exitAltitude",m.state.userSettings.exitAltitude),K("safetyHeight",m.state.userSettings.safetyHeight),Ce("interpStep",m.state.userSettings.interpStep),K("aircraftSpeedKt",m.state.userSettings.aircraftSpeedKt),K("jumpRunTrackOffset",m.state.userSettings.jumpRunTrackOffset),K("numberOfJumpers",m.state.userSettings.numberOfJumpers),je("showTableCheckbox",m.state.userSettings.showTable),je("calculateJumpCheckbox",m.state.userSettings.calculateJump),je("showLandingPattern",m.state.userSettings.showLandingPattern),je("showJumpRunTrack",m.state.userSettings.showJumpRunTrack),je("showCanopyAreaCheckbox",m.state.userSettings.showCanopyArea),je("showExitAreaCheckbox",m.state.userSettings.showExitArea),je("showCutAwayFinder",m.state.userSettings.showCutAwayFinder),m.state.userSettings.isCustomJumpRunDirection=m.state.userSettings.isCustomJumpRunDirection||!1;const t=document.getElementById("customLandingDirectionLL"),e=document.getElementById("customLandingDirectionRR");t&&m.state.userSettings.customLandingDirectionLL!==""&&!isNaN(m.state.userSettings.customLandingDirectionLL)&&(t.value=m.state.userSettings.customLandingDirectionLL),e&&m.state.userSettings.customLandingDirectionRR!==""&&!isNaN(m.state.userSettings.customLandingDirectionRR)&&(e.value=m.state.userSettings.customLandingDirectionRR);const n=Mi(m.state.userSettings.aircraftSpeedKt);K("jumperSeparation",n),m.state.userSettings.jumperSeparation=n,m.save();const a=document.getElementById("showLandingPattern"),r=document.getElementById("calculateJumpCheckbox");a&&(a.title=m.isFeatureUnlocked("landingPattern")&&m.state.isLandingPatternUnlocked?"":"Feature locked. Click to enter password.",a.style.opacity=m.isFeatureUnlocked("landingPattern")&&m.state.isLandingPatternUnlocked?"1":"0.5",console.log("Initialized showLandingPattern UI:",{checked:a.checked,opacity:a.style.opacity})),r&&(r.title=m.isFeatureUnlocked("calculateJump")&&m.state.isCalculateJumpUnlocked?"":"Feature locked. Click to enter password.",r.style.opacity=m.isFeatureUnlocked("calculateJump")&&m.state.isCalculateJumpUnlocked?"1":"0.5",console.log("Initialized calculateJumpCheckbox UI:",{checked:r.checked,opacity:r.style.opacity}));const i=document.getElementById("showJumpMasterLine");i&&(i.disabled=!m.state.userSettings.trackPosition,i.style.opacity=i.disabled?"0.5":"1",i.title=i.disabled?"Enable Live Tracking to use Jump Master Line":"");const s=document.getElementById("jumpRunTrackDirection");s&&(s.textContent="-"),Ui()}function re(){const t=Y(),e=ke(),n=hn();let a=m.state.userSettings.openingAltitude,r=m.state.userSettings.exitAltitude;if(n==="ft"&&(a=g.convertFeetToMeters(a),r=g.convertFeetToMeters(r)),!m.state.isCalculateJumpUnlocked||!m.state.userSettings.calculateJump){rn(null),ta(null);return}if(!o.weatherData||!o.lastLat||!o.lastLng){rn(null);return}const i=Ne(o.weatherData,t,e,Math.round(o.lastAltitude),n),s={exitCircles:[],canopyCircles:[],canopyLabels:[]};if(m.state.userSettings.showExitArea){const c=Ei(i);if(c){s.exitCircles.push({center:[c.greenLat,c.greenLng],radius:c.greenRadius,color:"green",fillColor:"green",fillOpacity:.2,weight:2});const u=`
                Exit areas calculated with:<br>
                Throw/Drift: ${Number.isFinite(c.freeFallDirection)?Math.round(c.freeFallDirection):"N/A"}° ${Number.isFinite(c.freeFallDistance)?Math.round(c.freeFallDistance):"N/A"} m<br>
                Free Fall Time: ${c.freeFallTime!=null&&!isNaN(c.freeFallTime)?Math.round(c.freeFallTime):"N/A"} sec
            `;s.exitCircles.push({center:[c.darkGreenLat,c.darkGreenLng],radius:c.darkGreenRadius,color:"darkgreen",fillColor:"darkgreen",fillOpacity:.2,weight:2,tooltip:u})}}if(m.state.userSettings.showCanopyArea){const c=tl(i);if(c){const u=g.calculateNewCenter(c.redLat,c.redLng,c.displacementFull,c.directionFull);s.canopyCircles.push({center:u,radius:c.radiusFull,color:"red",weight:2,opacity:.8,fillOpacity:0}),c.additionalBlueRadii.forEach((d,h)=>{const p=g.calculateNewCenter(c.blueLat,c.blueLng,c.additionalBlueDisplacements[h],c.additionalBlueDirections[h]);s.canopyCircles.push({center:p,radius:d,color:"blue",weight:1,fillColor:"blue",fillOpacity:.1,opacity:1}),s.canopyLabels.push({center:p,radius:d,text:`${Math.round(c.additionalBlueUpperLimits[h])}m`})})}}rn(s);let l=null;if(m.state.userSettings.showCutAwayFinder&&o.cutAwayLat!==null){const c=wa(i);c&&(l={center:c.center,radius:c.radius,tooltipContent:c.tooltipContent})}ta(l)}function Ye(){console.log("Calculating mean wind with model:",document.getElementById("modelSelect").value,"weatherData:",o.weatherData);const t=document.getElementById("refLevel")?.value||"AGL",e=m.getValue("heightUnit","radio","m"),n=m.getValue("windUnit","radio","kt"),a=document.getElementById("timeSlider").value||0,r=Ne(o.weatherData,a,ke(),Math.round(o.lastAltitude),e);let i=parseFloat(document.getElementById("lowerLimit").value)||0,s=parseFloat(document.getElementById("upperLimit").value);const l=Math.round(o.lastAltitude);if(!o.weatherData||o.lastAltitude==="N/A"){g.handleError("Cannot calculate mean wind: missing data or altitude");return}i=e==="ft"?i/3.28084:i,s=e==="ft"?s/3.28084:s;let c=t==="AGL"?i+l:i,u=t==="AGL"?s+l:s;if(isNaN(i)||isNaN(s)||i>=s){g.handleError("Invalid layer limits. Ensure Lower < Upper and both are numbers.");return}if(t==="AMSL"&&u<l){g.handleError(`The entire selected layer (${Math.round(g.convertHeight(c,e))}-${Math.round(g.convertHeight(u,e))} ${e}) is below the terrain altitude of ${Math.round(g.convertHeight(l,e))} ${e}.`),document.getElementById("meanWindResult").innerHTML="Mean wind: N/A (Layer is below ground)";return}if(t==="AMSL"&&c<l){g.handleMessage(`Note: Lower limit adjusted to terrain altitude (${Math.round(g.convertHeight(l,e))} ${e}) as it cannot be below ground level.`);const k=Math.round(g.convertHeight(l,e));K("lowerLimit",k),m.state.userSettings.lowerLimit=k,m.save(),c=l}if(!r||r.length===0){g.handleError("No valid weather data available to calculate mean wind.");return}const d=r.map(k=>k.height),h=r.map(k=>parseFloat(k.dir)||0),p=r.map(k=>g.convertWind(parseFloat(k.spd)||0,n,"km/h")),f=p.map((k,A)=>-k*Math.sin(h[A]*Math.PI/180)),y=p.map((k,A)=>-k*Math.cos(h[A]*Math.PI/180)),v=g.calculateMeanWind(d,f,y,c,u),[w,S]=v,M=g.roundToTens(w)===0&&w>=0&&w<5?360:g.roundToTens(w),_=Math.round(g.convertHeight(i,e)),E=Math.round(g.convertHeight(s,e));g.convertWind(S,n,"kt");const b=Number.isFinite(S)?n==="bft"?Math.round(S):S.toFixed(1):"N/A",T=`Mean wind (${_}-${E} ${e} ${t}): ${M}° ${b} ${n}`;document.getElementById("meanWindResult").innerHTML=T,console.log("Calculated Mean Wind:",T,"u:",v[2],"v:",v[3])}async function zc(){if(!o.lastLat||!o.lastLng){console.warn("No location selected, cannot update weather data"),g.handleError("Please select a location to enable autoupdate."),stopAutoupdate(),document.getElementById("autoupdateCheckbox").checked=!1,m.state.userSettings.autoupdate=!1,m.save();return}if(!navigator.onLine){console.warn("Cannot update weather data: offline"),g.handleError("Cannot update weather data while offline."),stopAutoupdate(),document.getElementById("autoupdateCheckbox").checked=!1,m.state.userSettings.autoupdate=!1,m.save();return}const t=document.getElementById("timeSlider");if(!t){console.warn("Time slider not found, cannot update to current hour");return}const n=new Date().getUTCHours();t.value=n,console.log(`Set slider to current hour: ${n}`);try{await Ke(o.lastLat,o.lastLng,null,!1),console.log("Weather data fetched for current hour"),await Oe(n,"weather-table-container","selectedTime"),o.lastAltitude!=="N/A"&&Ye(),m.state.userSettings.calculateJump&&m.state.isCalculateJumpUnlocked&&(Oi(),wa(),m.state.userSettings.showJumpRunTrack&&ie()),console.log("Updated all displays for current hour")}catch(a){console.error("Error updating to current hour:",a),g.handleError("Failed to update weather data: "+a.message)}}function Gc(t){if(!o.weatherData||!o.weatherData.time){g.handleError("No weather data available to download.");return}const e=document.getElementById("timeSlider").value||0,n=document.getElementById("modelSelect").value.toUpperCase(),a=g.formatTime(o.weatherData.time[e]).replace(" ","_"),r=`${a}_${n}_${t}.txt`,s={ATAK:{interpStep:1e3,heightUnit:"ft",refLevel:"AGL",windUnit:"kt"},Windwatch:{interpStep:100,heightUnit:"ft",refLevel:"AGL",windUnit:"km/h"},HEIDIS:{interpStep:100,heightUnit:"m",refLevel:"AGL",temperatureUnit:"C",windUnit:"m/s"},Customized:{}}[t]||{},l={interpStep:s.interpStep||ke(),heightUnit:s.heightUnit||m.getValue("heightUnit","radio","m"),refLevel:s.refLevel||document.querySelector('input[name="refLevel"]:checked')?.value||"AGL",windUnit:s.windUnit||m.getValue("windUnit","radio","kt"),temperatureUnit:s.temperatureUnit||m.getValue("temperatureUnit","radio","C")},c=Ne(o.weatherData,e,l.interpStep,Math.round(o.lastAltitude),l.heightUnit);if(!c||c.length===0){g.handleError("No interpolated data available to download.");return}let u="",d="";switch(t){case"ATAK":d=`Alt	Dir	Spd
${l.heightUnit}${l.refLevel}	deg	kts
`;break;case"Windwatch":const y=Math.round(g.convertHeight(o.lastAltitude,"ft"));d=`Version 1.0, ID = 9999999999
${a}, Ground Level: ${y} ft
Windsond ${n}
AGL[ft] Wind[°] Speed[km/h]
`;break;case"HEIDIS":case"Customized":default:d=`h(${l.heightUnit}${l.refLevel}) p(hPa) T(${l.temperatureUnit}) Dew(${l.temperatureUnit}) Dir(°) Spd(${l.windUnit}) RH(%)
`;break}u+=d,c.forEach(y=>{const v=Math.round(y.displayHeight),w=Math.round(y.dir),S=g.convertWind(y.spd,l.windUnit,"km/h"),M=Number.isFinite(S)?l.windUnit==="bft"?Math.round(S):S.toFixed(1):"N/A";if(t==="ATAK"||t==="Windwatch")u+=`${v}	${w}	${Math.round(S)}
`;else{const _=y.pressure==="N/A"?"N/A":y.pressure.toFixed(1),E=g.convertTemperature(y.temp,l.temperatureUnit),b=E==="N/A"?"N/A":E.toFixed(1),T=g.convertTemperature(y.dew,l.temperatureUnit),k=T==="N/A"?"N/A":T.toFixed(1),A=y.rh==="N/A"?"N/A":Math.round(y.rh);u+=`${v} ${_} ${b} ${k} ${w} ${M} ${A}
`}});const h=new Blob([u],{type:"text/plain"}),p=window.URL.createObjectURL(h),f=document.createElement("a");f.href=p,f.download=r,document.body.appendChild(f),f.click(),document.body.removeChild(f),window.URL.revokeObjectURL(p)}function fr(t=!0){m.state.userSettings.customJumpRunDirection=null,m.save(),console.log("Persisted custom JRT direction has been reset.");const e=document.getElementById("jumpRunTrackDirection");e&&(e.value=""),t&&m.state.userSettings.showJumpRunTrack&&o.weatherData&&ie()}async function Dt(t,e=null){o.weatherData=t;const n=document.getElementById("timeSlider");if(!n)return;const r=(i=>{const s=i?.temperature_2m;if(!s||s.length===0)return 0;for(let l=s.length-1;l>=0;l--)if(s[l]!==null&&s[l]!==void 0)return l;return 0})(t);if(n.max=r,n.disabled=n.max<=0,e!==null&&e<=r)n.value=e,console.log(`Slider restored to preserved index: ${e}`);else{const i=new Date().getUTCHours();i<=r?n.value=i:n.value=r,console.log(`Slider set to default (current hour or max): ${n.value}`)}await Oe(n.value,"weather-table-container","selectedTime"),await $e(),o.lastAltitude!=="N/A"&&Ye(),m.updateModelRunInfo(o.lastModelRun,o.lastLat,o.lastLng),Hl(),console.log("Model changed. Triggering recalculation of jump parameters."),pe(),m.state.userSettings.calculateJump&&re(),m.state.userSettings.showJumpRunTrack&&ie()}function Ui(){const t=document.getElementById("info");t&&(t.style.display=m.state.userSettings.showTable?"block":"none");const e=document.getElementById("customLandingDirectionLL"),n=document.getElementById("customLandingDirectionRR"),a=document.getElementById("showJumpRunTrack"),r=document.getElementById("showExitAreaCheckbox");e&&(e.disabled=m.state.userSettings.landingDirection!=="LL"),n&&(n.disabled=m.state.userSettings.landingDirection!=="RR"),a&&(a.disabled=!m.state.userSettings.calculateJump),r&&(r.disabled=!m.state.userSettings.calculateJump),m.updateUnitLabels()}function ye(t=null){const e=m.state.userSettings.showJumpMasterLine;let n=null,a=null;if(o.watchId!==null&&(a=o.liveMarker?o.liveMarker.getLatLng():null,n=t||{latitude:a?a.lat:o.lastLatitude,longitude:a?a.lng:o.lastLongitude,speedMs:o.lastSmoothedSpeedMs,direction:o.lastDirection,deviceAltitude:o.lastDeviceAltitude,altitudeAccuracy:o.lastAltitudeAccuracy,accuracy:o.lastAccuracy},n.showJumpMasterLine=e),e&&a){let r=null,i="";if(m.state.userSettings.jumpMasterLineTarget==="HARP"&&o.harpMarker?(r=o.harpMarker.getLatLng(),i="HARP"):o.currentMarker&&(r=o.currentMarker.getLatLng(),i="DIP"),r){const s=o.map.distance(a,r),l=Math.round(g.calculateBearing(a.lat,a.lng,r.lat,r.lng)),c=n.speedMs>1?n.speedMs:1,u=Math.round(s/c);n.jumpMasterLineData={distance:s,bearing:l,tot:u,target:i},Ol(a,r)}}else Rl();Vc(n)}function Vc(t){const e=document.getElementById("jumpmaster-dashboard");if(!e)return;if(!t){e.classList.add("hidden");return}e.classList.remove("hidden");const n=document.getElementById("dashboard-jm-coords"),a=document.getElementById("dashboard-jm-altitude"),r=document.getElementById("dashboard-jm-direction"),i=document.getElementById("dashboard-jm-speed"),s=document.getElementById("dashboard-jm-accuracy"),l={heightUnit:hn(),effectiveWindUnit:hr()==="bft"?"kt":hr(),coordFormat:Ri(),refLevel:m.getValue("refLevel","radio","AGL")},c=g.convertCoords(t.latitude,t.longitude,l.coordFormat);let u;if(l.coordFormat==="MGRS")u=c.lat;else if(l.coordFormat==="DMS"){const v=w=>`${w.deg}°${w.min}'${w.sec.toFixed(0)}" ${w.dir}`;u=`${v(c.lat)}, ${v(c.lng)}`}else u=`${c.lat}, ${c.lng}`;n.textContent=u;let d="N/A";if(t.deviceAltitude!==null){let v=l.refLevel==="AGL"&&o.lastAltitude?t.deviceAltitude-parseFloat(o.lastAltitude):t.deviceAltitude;d=`${Math.round(g.convertHeight(v,l.heightUnit))} ${l.heightUnit}`}a.textContent=d,r.textContent=`${t.direction}°`;const h=g.convertWind(t.speedMs,l.effectiveWindUnit,"m/s"),p=l.effectiveWindUnit==="bft"?Math.round(h):h.toFixed(1);i.textContent=`${p} ${l.effectiveWindUnit}`,s.textContent=`± ${Math.round(g.convertHeight(t.accuracy,l.heightUnit))} ${l.heightUnit}`;const f=document.getElementById("jumpmaster-line-details"),y=t.showJumpMasterLine;if(f.classList.toggle("hidden",!y),y){const v=document.getElementById("dashboard-jm-target-label"),w=document.getElementById("dashboard-jm-bearing"),S=document.getElementById("dashboard-jm-distance"),M=document.getElementById("dashboard-jm-tot");if(t.jumpMasterLineData){const _={heightUnit:hn()};v.textContent=`JML to ${t.jumpMasterLineData.target}`,w.textContent=`${t.jumpMasterLineData.bearing}°`,S.textContent=`${Math.round(g.convertHeight(t.jumpMasterLineData.distance,_.heightUnit))} ${_.heightUnit}`,M.textContent=t.jumpMasterLineData.tot<1200?`X - ${t.jumpMasterLineData.tot} s`:"N/A"}else v.textContent="JML to --",w.textContent="--",S.textContent="--",M.textContent="--"}}function Zc(){console.log("[App] Setting up application event listeners..."),document.addEventListener("map:moved",()=>{console.log("[main-web] Map has moved or zoomed. Updating visualizations based on new view.");const t=o.map.getZoom();m.state.userSettings.calculateJump&&o.weatherData&&o.lastLat&&(t>=ve.MIN_ZOOM&&t<=ve.MAX_ZOOM?re():rn(null)),m.state.userSettings.showJumpRunTrack&&(t>=ve.MIN_ZOOM&&t<=ve.MAX_ZOOM?ie():Pt(null)),m.state.userSettings.showLandingPattern&&pe(),Ma({map:o.map,baseMaps:o.baseMaps,onProgress:$t,onComplete:e=>{We(),e&&g.handleMessage(e)},onCancel:()=>{We(),g.handleMessage("Caching cancelled.")}})}),document.addEventListener("map:mousemove",t=>{const{lat:e,lng:n}=t.detail;o.lastMouseLatLng={lat:e,lng:n};const a=Ri();let r;if(a==="MGRS")r=`MGRS: ${g.decimalToMgrs(e,n)||"N/A"}`;else if(a==="DMS"){const i=s=>`${s.deg}°${s.min}'${s.sec.toFixed(0)}" ${s.dir}`;r=`Lat: ${i(g.decimalToDms(e,!0))}, Lng: ${i(g.decimalToDms(n,!1))}`}else r=`Lat: ${e.toFixed(5)}, Lng: ${n.toFixed(5)}`;o.coordsControl&&o.coordsControl.update(`${r}<br>Elevation: Fetching...<br>QFE: Fetching...`),g.debouncedGetElevationAndQFE(e,n,({elevation:i})=>{if(o.lastMouseLatLng&&o.coordsControl){const s=Math.abs(o.lastMouseLatLng.lat-e),l=Math.abs(o.lastMouseLatLng.lng-n),c=.05;if(s<c&&l<c){const u=hn();let d=i==="N/A"?"N/A":i;d!=="N/A"&&(d=g.convertHeight(d,u),d=Math.round(d));let h="N/A";if(i!=="N/A"&&o.weatherData&&o.weatherData.surface_pressure){const p=parseInt(document.getElementById("timeSlider")?.value)||0,f=o.weatherData.surface_pressure[p],y=o.weatherData.temperature_2m?.[p]||15,v=o.lastAltitude!=="N/A"?o.lastAltitude:0,w=g.calculateQFE(f,i,v,y);h=w!=="N/A"?`${w} hPa`:"N/A"}o.coordsControl.update(`${r}<br>Elevation: ${d} ${d==="N/A"?"":u}<br>QFE: ${h}`)}}})}),document.addEventListener("map:location_selected",async t=>{const{lat:e,lng:n,source:a}=t.detail;console.log(`App: Event 'map:location_selected' von '${a}' empfangen.`),o.lastLat=e,o.lastLng=n,o.lastAltitude=await g.getAltitude(e,n),Ni(e,n),fr(!0),await Ke(e,n),m.state.userSettings.calculateJump&&(re(),wa()),mn(!0),o.isManualPanning=!1,ie(),pe()}),document.addEventListener("favorites:updated",t=>{const{favorites:e}=t.detail;console.log("[App] Favorites updated, redrawing markers on map."),Ci(e)}),document.addEventListener("tracking:started",()=>{const t=document.getElementById("showJumpMasterLine");t&&(t.disabled=!1,t.style.opacity="1",t.title="")}),document.addEventListener("tracking:stopped",()=>{const t=document.getElementById("showJumpMasterLine");t&&(t.checked=!1,t.disabled=!0,t.style.opacity="0.5",t.title="Enable Live Tracking to use Jump Master Line"),m.state.userSettings.showJumpMasterLine&&(m.state.userSettings.showJumpMasterLine=!1,m.save()),ye()}),document.addEventListener("track:loaded",async t=>{const e=document.getElementById("loading");try{const{lat:n,lng:a,timestamp:r,historicalDate:i,summary:s}=t.detail;if(console.log('[main-web] Event "track:loaded" empfangen, starte korrigierte Aktionen.'),i){const u=document.getElementById("autoupdateCheckbox");u&&(u.checked=!1),$i(),m.state.userSettings.autoupdate=!1,m.save(),g.handleMessage("Autoupdate disabled for historical track viewing.")}await Sn(n,a);const l=await Ke(n,a,r);if(l){o.weatherData=l;const u=document.getElementById("timeSlider");if(u&&o.weatherData.time){u.max=o.weatherData.time.length-1,u.disabled=u.max<=0;const d=new Date(r).getTime();let h=0,p=1/0;o.weatherData.time.forEach((f,y)=>{const v=Math.abs(new Date(f).getTime()-d);v<p&&(p=v,h=y)}),u.value=h}}await Oe(Y(),"weather-table-container","selectedTime"),await $e(),Ye(),re(),pe();const c=document.getElementById("info");if(c&&s){const u=/(<br><strong>Available Models:<\/strong><ul>.*?<\/ul>|<br><strong>Available Models:<\/strong> None)/s,d=c.innerHTML.match(u);c.innerHTML=s+(d?d[0]:"")}if(i){const u=document.getElementById("historicalDatePicker");u&&(u.value=i)}}catch(n){console.error("Fehler bei der Verarbeitung von track:loaded:",n),g.handleError("Konnte Track-Daten nicht vollständig verarbeiten.")}finally{e&&(e.style.display="none")}}),document.addEventListener("tracking:positionUpdated",t=>{ye(t.detail)}),document.addEventListener("jml:targetChanged",()=>{ye()}),document.addEventListener("ui:sliderChanged",async t=>{console.log("[main-web] Event 'ui:sliderChanged' empfangen, spezifische Updates werden ausgeführt.");try{const e=Y();o.weatherData&&o.lastLat&&o.lastLng&&(await Oe(e,"weather-table-container","selectedTime"),await $e(),o.lastAltitude!=="N/A"&&Ye(),pe(),m.state.userSettings.calculateJump&&re(),m.state.userSettings.showJumpRunTrack&&ie(),ht(e,ke()))}catch(e){console.error("Error during slider update:",e),dn(e.message)}}),document.addEventListener("ui:settingChanged",async t=>{const{name:e,value:n}=t.detail;switch(console.log(`[main-web] Setting '${e}' changed to '${n}'. Performing updates.`),["refLevel","heightUnit","temperatureUnit","windUnit","timeZone"].includes(e)&&await Oe(Y(),"weather-table-container","selectedTime"),e){case"heightUnit":case"windUnit":case"refLevel":Ye(),m.getValue("calculateJump","checkbox",!1)&&re(),pe(),ye(),await $e();break;case"coordFormat":if(await $e(),ye(),o.map&&o.lastMouseLatLng){const a=new MouseEvent("mousemove",{bubbles:!0,cancelable:!0,clientX:o.lastMouseLatLng.x,clientY:o.lastMouseLatLng.y});o.map.getContainer().dispatchEvent(a)}break}}),document.addEventListener("ui:radioGroupChanged",async t=>{const{name:e,value:n}=t.detail;if(console.log(`[main-web] Radio group '${e}' changed to '${n}'. Performing updates.`),e==="heightUnit"){const a=document.getElementById("lowerLimit"),r=document.getElementById("upperLimit");if(a&&r){let i=parseFloat(a.value),s=parseFloat(r.value);!isNaN(i)&&!isNaN(s)&&(n==="ft"?(a.value=Math.round(i*3.28084),r.value=Math.round(s*3.28084)):(a.value=Math.round(i/3.28084),r.value=Math.round(s/3.28084)),m.state.userSettings.lowerLimit=a.value,m.state.userSettings.upperLimit=r.value,m.save())}}switch(["refLevel","heightUnit","temperatureUnit","windUnit","timeZone"].includes(e)&&await Oe(Y(),"weather-table-container","selectedTime"),e){case"heightUnit":case"windUnit":case"refLevel":Ye(),m.getValue("calculateJump","checkbox",!1)&&re(),pe(),ye(),await $e();break;case"coordFormat":await $e(),ye();break;case"landingDirection":Ui(),pe();break}}),document.addEventListener("ui:inputChanged",async t=>{const{name:e,value:n}=t.detail;switch(console.log(`[main-web] Input for '${e}' changed to '${n}'.`),e){case"aircraftSpeedKt":const a=Mi(n);oa("jumperSeparation",a),m.state.userSettings.jumperSeparation=a,m.save(),o.weatherData&&(Oi(),ht(Y())),ie();break;case"cutAwayAltitude":o.weatherData&&o.cutAwayLat!==null&&re();break;case"openingAltitude":case"exitAltitude":case"safetyHeight":case"numberOfJumpers":case"jumperSeparation":case"canopySpeed":case"descentRate":case"legHeightFinal":case"legHeightBase":case"legHeightDownwind":o.weatherData&&(re(),pe(),ht(Y()));break;case"jumpRunTrackDirection":case"jumpRunTrackOffset":case"jumpRunTrackForwardOffset":o.weatherData&&ie();break;case"lowerLimit":case"upperLimit":case"interpStep":o.weatherData&&(await Oe(Y(),"weather-table-container","selectedTime"),Ye());break;case"customLandingDirectionLL":case"customLandingDirectionRR":o.weatherData&&pe();break;case"historicalDatePicker":if(o.lastLat&&o.lastLng){const r=n?`${n}T00:00:00Z`:null,i=await Ke(o.lastLat,o.lastLng,r);i&&await Dt(i)}break}}),document.addEventListener("ui:showJumpMasterLineChanged",()=>{ye()}),document.addEventListener("ui:modelChanged",async t=>{if(console.log(`[main-web] Model changed to ${t.detail.model}. Fetching new data.`),o.lastLat&&o.lastLng){const e=Y(),n=o.weatherData?.time?.[e]||null,a=await Ke(o.lastLat,o.lastLng,n);a&&await Dt(a,e)}else g.handleError("Please select a position on the map first.")}),document.addEventListener("ui:jumpFeatureChanged",()=>{console.log("[main-web] Jump feature changed, recalculating jump."),o.weatherData&&o.lastLat&&o.lastLng&&m.state.userSettings.calculateJump&&re()}),document.addEventListener("ui:showJumpRunTrackChanged",t=>{t.detail.checked?ie():(Pt(null),fr(!1))}),document.addEventListener("ui:showCutAwayFinderChanged",t=>{const e=t.detail.checked;console.log(`[main-web] Cut Away Finder toggled: ${e}`);const n=document.getElementById("showCutAwayFinder").closest("li")?.querySelector("ul.submenu");n&&n.classList.toggle("hidden",!e),e||(xl(),o.cutAwayLat=null,o.cutAwayLng=null),o.weatherData&&o.lastLat&&o.lastLng&&m.state.userSettings.calculateJump&&re()}),document.addEventListener("ui:trackPositionToggled",t=>{const e=t.detail.checked;console.log(`[main-web] Live Tracking toggled: ${e}`),e?$c():ia()}),document.addEventListener("ui:landingPatternEnabled",()=>{console.log("[main-web] Landing pattern enabled, updating display."),pe()}),document.addEventListener("ui:landingPatternDisabled",()=>{console.log("[main-web] Landing pattern disabled, clearing display."),At(null)}),document.addEventListener("ui:showTableChanged",t=>{const e=t.detail.checked;console.log(`[main-web] Show Table toggled: ${e}`);const n=document.getElementById("info");n&&(n.style.display=e?"block":"none"),e&&o.weatherData&&o.lastLat&&o.lastLng&&Oe(Y(),"weather-table-container","selectedTime"),mn()}),document.addEventListener("ui:showJumpMasterLineChanged",()=>{console.log("[main-web] Jump Master Line checkbox changed, forcing dashboard update."),ye()}),document.addEventListener("ui:jumpMasterLineTargetChanged",()=>{console.log("[main-web] Jump Master Line target changed, updating panel and line."),ye()}),document.addEventListener("ui:downloadClicked",()=>{console.log("[main-web] Download button clicked.");const t=Hc();Gc(t)}),document.addEventListener("ui:clearDateClicked",async()=>{console.log("[main-web] Clear date button clicked.");const t=document.getElementById("historicalDatePicker");if(t&&(t.value="",o.lastLat&&o.lastLng))try{const e=await Ke(o.lastLat,o.lastLng,null);e&&await Dt(e)}catch(e){dn(e.message)}}),document.addEventListener("ui:recalculateJump",()=>{console.log("[main-web] Recalculate jump triggered."),o.weatherData&&o.lastLat&&o.lastLng&&m.state.userSettings.calculateJump&&re()}),document.addEventListener("ui:invalidInput",t=>{const{id:e,defaultValue:n}=t.detail;console.log(`[main-web] Received invalid input for ${e}. Resetting UI to ${n}.`),K(e,n)})}document.addEventListener("DOMContentLoaded",async()=>{Bc(),Wc(),ul(),await hl(),Zc(),Dc(),Pc(),Pi();const t=ze().filter(e=>e.isFavorite);t.length>0&&(console.log(`[App] Found ${t.length} favorite(s) on startup, plotting on map.`),Ci(t)),document.addEventListener("cutaway:marker_placed",()=>{console.log("App: Event 'cutaway:marker_placed' empfangen. Neuberechnung wird ausgelöst."),o.weatherData&&o.lastLat&&o.lastLng&&re()}),document.addEventListener("track:dragend",e=>{console.log("App: Event 'track:dragend' empfangen. Neuberechnung der Offsets relativ zum Ankerpunkt (DIP oder HARP).");const{newPosition:n,originalTrackData:a}=e.detail;let r;const i=o.harpMarker?o.harpMarker.getLatLng():null;i?(r=i,console.log("JRT-Ankerpunkt ist HARP.")):(r=L.latLng(o.lastLat,o.lastLng),console.log("JRT-Ankerpunkt ist DIP."));const s=a.trackLength,l=a.airplane.bearing,c=n,[u,d]=g.calculateNewCenter(c.lat,c.lng,s,(l+180)%360),h=L.latLng(u,d),p=o.map.distance(r,h);let y=g.calculateBearing(r.lat,r.lng,h.lat,h.lng)-l;y=(y+180)%360-180;const v=y*(Math.PI/180),w=Math.round(p*Math.cos(v)),S=Math.round(p*Math.sin(v));m.state.userSettings.jumpRunTrackOffset=S,m.state.userSettings.jumpRunTrackForwardOffset=w,m.save(),oa("jumpRunTrackOffset",S),oa("jumpRunTrackForwardOffset",w),ie()}),document.addEventListener("harp:updated",()=>{console.log("[App] HARP has been updated, triggering JRT recalculation."),ie()}),document.addEventListener("location:selected",async e=>{const{lat:n,lng:a,source:r}=e.detail;console.log(`App: Event 'location:selected' empfangen. Quelle: ${r}`);const i=document.getElementById("loading");i&&(i.style.display="block");try{const s=Y(),l=o.weatherData?.time?.[s]||null,c=await Ke(n,a,l);c?r==="geolocation"||r==="geolocation_fallback"?await Dt(c):await Dt(c,s):o.weatherData=null,await Sn(n,a),await $e(),mn(!0),o.isManualPanning=!1,(r==="geolocation"||r==="geolocation_fallback")&&(console.log("Starte initiales Caching nach Geolocation..."),Ma({map:o.map,baseMaps:o.baseMaps,onProgress:$t,onComplete:u=>{We(),u&&He(u)},onCancel:()=>{We(),He("Caching cancelled.")}})),m.state.userSettings.showJumpMasterLine&&ye(),(r==="marker_drag"||r==="dblclick"||r==="search")&&(console.log(`Starte Caching für neue Position via ${r}...`),_i({map:o.map,lastLat:n,lastLng:a,baseMaps:o.baseMaps,onProgress:$t,onComplete:He,onCancel:()=>He("Caching cancelled."),radiusKm:5,silent:!0})),m.state.userSettings.selectedEnsembleModels.length>0&&(console.log("DIP moved, triggering ensemble recalculation..."),await La()&&ht(Y()))}catch(s){console.error('Fehler beim Verarbeiten von "location:selected":',s),dn(s.message)}finally{i&&(i.style.display="none")}}),document.addEventListener("autoupdate:tick",async e=>{if(!m.state.userSettings.autoupdate)return;const n=new Date,a=document.getElementById("timeSlider");if(!a)return;const r=n.getUTCHours(),i=parseInt(a.value,10);(r!==i||e.detail.isInitialTick)&&(console.log(`[App] Autoupdate triggered. Current Hour: ${r}, Slider Hour: ${i}`),await zc())})});function je(t,e){const n=document.getElementById(t);n&&(n.checked=e)}function Ce(t,e){const n=document.getElementById(t);n?n.value=e:console.warn(`Element ${t} not found`)}function K(t,e){const n=document.getElementById(t);n&&(n.value=e)}function oa(t,e){const n=document.getElementById(t);if(n){const a=n.value;n.value=e,console.log(`Set ${t} silently:`,{old:a,new:e})}}function Jc(t,e){const n=document.querySelector(`input[name="${t}"][value="${e}"]`);n?n.checked=!0:console.warn(`Radio ${t} with value ${e} not found`)}
