var us=Object.defineProperty;var ds=(t,e,n)=>e in t?us(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var zo=(t,e,n)=>ds(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();const i={isInitialized:!1,coordsControl:null,lastMouseLatLng:null,landingWindDir:null,cutAwayMarker:null,cutAwayLat:null,cutAwayLng:null,cutAwayCircle:null,isJumperSeparationManual:!1,weatherData:null,lastModelRun:null,gpxLayer:null,gpxPoints:[],isLoadingGpx:!1,isTrackLoaded:!1,liveMarker:null,jumpMasterLine:null,isPlacingHarp:!1,harpMarker:null,watchId:null,prevLat:null,prevLng:null,prevTime:null,livePositionControl:null,lastLatitude:null,lastLongitude:null,lastDeviceAltitude:null,lastAltitudeAccuracy:null,lastAccuracy:null,lastSpeed:"N/A",lastEffectiveWindUnit:"kt",lastDirection:"N/A",lastTerrainAltitude:"N/A",lastSmoothedSpeedMs:0,map:null,baseMaps:{},lastLat:null,lastLng:null,lastAltitude:null,currentMarker:null,isManualPanning:!1,autoupdateInterval:null,accuracyCircle:null,ensembleModelsData:null,selectedEnsembleModels:[],currentEnsembleScenario:"all_models",ensembleLayerGroup:null,ensembleScenarioCircles:{},heatmapLayer:null,ismapInitialized:!1,hasTileErrorSwitched:!1,isCachingCancelled:!1,jumpVisualizationLayerGroup:null,landingPatternLayerGroup:null,jumpRunTrackLayerGroup:null,labelZoomListener:null};class It extends Error{}class ms extends It{constructor(e){super(`Invalid DateTime: ${e.toMessage()}`)}}class hs extends It{constructor(e){super(`Invalid Interval: ${e.toMessage()}`)}}class ps extends It{constructor(e){super(`Invalid Duration: ${e.toMessage()}`)}}class Ut extends It{}class xi extends It{constructor(e){super(`Invalid unit ${e}`)}}class ue extends It{}class dt extends It{constructor(){super("Zone is an abstract class")}}const A="numeric",Ve="short",ke="long",Zn={year:A,month:A,day:A},Pi={year:A,month:Ve,day:A},gs={year:A,month:Ve,day:A,weekday:Ve},$i={year:A,month:ke,day:A},Ri={year:A,month:ke,day:A,weekday:ke},Oi={hour:A,minute:A},Ui={hour:A,minute:A,second:A},Hi={hour:A,minute:A,second:A,timeZoneName:Ve},Bi={hour:A,minute:A,second:A,timeZoneName:ke},Wi={hour:A,minute:A,hourCycle:"h23"},zi={hour:A,minute:A,second:A,hourCycle:"h23"},Gi={hour:A,minute:A,second:A,hourCycle:"h23",timeZoneName:Ve},Vi={hour:A,minute:A,second:A,hourCycle:"h23",timeZoneName:ke},Ji={year:A,month:A,day:A,hour:A,minute:A},ji={year:A,month:A,day:A,hour:A,minute:A,second:A},Zi={year:A,month:Ve,day:A,hour:A,minute:A},qi={year:A,month:Ve,day:A,hour:A,minute:A,second:A},fs={year:A,month:Ve,day:A,weekday:Ve,hour:A,minute:A},Ki={year:A,month:ke,day:A,hour:A,minute:A,timeZoneName:Ve},Yi={year:A,month:ke,day:A,hour:A,minute:A,second:A,timeZoneName:Ve},Xi={year:A,month:ke,day:A,weekday:ke,hour:A,minute:A,timeZoneName:ke},Qi={year:A,month:ke,day:A,weekday:ke,hour:A,minute:A,second:A,timeZoneName:ke};class _n{get type(){throw new dt}get name(){throw new dt}get ianaName(){return this.name}get isUniversal(){throw new dt}offsetName(e,n){throw new dt}formatOffset(e,n){throw new dt}offset(e){throw new dt}equals(e){throw new dt}get isValid(){throw new dt}}let Fa=null;class na extends _n{static get instance(){return Fa===null&&(Fa=new na),Fa}get type(){return"system"}get name(){return new Intl.DateTimeFormat().resolvedOptions().timeZone}get isUniversal(){return!1}offsetName(e,{format:n,locale:a}){return ur(e,n,a)}formatOffset(e,n){return yn(this.offset(e),n)}offset(e){return-new Date(e).getTimezoneOffset()}equals(e){return e.type==="system"}get isValid(){return!0}}const to=new Map;function ys(t){let e=to.get(t);return e===void 0&&(e=new Intl.DateTimeFormat("en-US",{hour12:!1,timeZone:t,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",era:"short"}),to.set(t,e)),e}const ws={year:0,month:1,day:2,era:3,hour:4,minute:5,second:6};function Ls(t,e){const n=t.format(e).replace(/\u200E/g,""),a=/(\d+)\/(\d+)\/(\d+) (AD|BC),? (\d+):(\d+):(\d+)/.exec(n),[,o,r,s,l,c,d,m]=a;return[s,o,r,l,c,d,m]}function vs(t,e){const n=t.formatToParts(e),a=[];for(let o=0;o<n.length;o++){const{type:r,value:s}=n[o],l=ws[r];r==="era"?a[l]=s:O(l)||(a[l]=parseInt(s,10))}return a}const xa=new Map;class st extends _n{static create(e){let n=xa.get(e);return n===void 0&&xa.set(e,n=new st(e)),n}static resetCache(){xa.clear(),to.clear()}static isValidSpecifier(e){return this.isValidZone(e)}static isValidZone(e){if(!e)return!1;try{return new Intl.DateTimeFormat("en-US",{timeZone:e}).format(),!0}catch{return!1}}constructor(e){super(),this.zoneName=e,this.valid=st.isValidZone(e)}get type(){return"iana"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(e,{format:n,locale:a}){return ur(e,n,a,this.name)}formatOffset(e,n){return yn(this.offset(e),n)}offset(e){if(!this.valid)return NaN;const n=new Date(e);if(isNaN(n))return NaN;const a=ys(this.name);let[o,r,s,l,c,d,m]=a.formatToParts?vs(a,n):Ls(a,n);l==="BC"&&(o=-Math.abs(o)+1);const f=oa({year:o,month:r,day:s,hour:c===24?0:c,minute:d,second:m,millisecond:0});let g=+n;const w=g%1e3;return g-=w>=0?w:1e3+w,(f-g)/(60*1e3)}equals(e){return e.type==="iana"&&e.name===this.name}get isValid(){return this.valid}}let Go={};function Ms(t,e={}){const n=JSON.stringify([t,e]);let a=Go[n];return a||(a=new Intl.ListFormat(t,e),Go[n]=a),a}const no=new Map;function ao(t,e={}){const n=JSON.stringify([t,e]);let a=no.get(n);return a===void 0&&(a=new Intl.DateTimeFormat(t,e),no.set(n,a)),a}const oo=new Map;function bs(t,e={}){const n=JSON.stringify([t,e]);let a=oo.get(n);return a===void 0&&(a=new Intl.NumberFormat(t,e),oo.set(n,a)),a}const io=new Map;function Ss(t,e={}){const{base:n,...a}=e,o=JSON.stringify([t,a]);let r=io.get(o);return r===void 0&&(r=new Intl.RelativeTimeFormat(t,e),io.set(o,r)),r}let mn=null;function Es(){return mn||(mn=new Intl.DateTimeFormat().resolvedOptions().locale,mn)}const ro=new Map;function er(t){let e=ro.get(t);return e===void 0&&(e=new Intl.DateTimeFormat(t).resolvedOptions(),ro.set(t,e)),e}const so=new Map;function ks(t){let e=so.get(t);if(!e){const n=new Intl.Locale(t);e="getWeekInfo"in n?n.getWeekInfo():n.weekInfo,"minimalDays"in e||(e={...tr,...e}),so.set(t,e)}return e}function Ts(t){const e=t.indexOf("-x-");e!==-1&&(t=t.substring(0,e));const n=t.indexOf("-u-");if(n===-1)return[t];{let a,o;try{a=ao(t).resolvedOptions(),o=t}catch{const c=t.substring(0,n);a=ao(c).resolvedOptions(),o=c}const{numberingSystem:r,calendar:s}=a;return[o,r,s]}}function _s(t,e,n){return(n||e)&&(t.includes("-u-")||(t+="-u"),n&&(t+=`-ca-${n}`),e&&(t+=`-nu-${e}`)),t}function Cs(t){const e=[];for(let n=1;n<=12;n++){const a=N.utc(2009,n,1);e.push(t(a))}return e}function As(t){const e=[];for(let n=1;n<=7;n++){const a=N.utc(2016,11,13+n);e.push(t(a))}return e}function Nn(t,e,n,a){const o=t.listingMode();return o==="error"?null:o==="en"?n(e):a(e)}function Is(t){return t.numberingSystem&&t.numberingSystem!=="latn"?!1:t.numberingSystem==="latn"||!t.locale||t.locale.startsWith("en")||er(t.locale).numberingSystem==="latn"}class Ds{constructor(e,n,a){this.padTo=a.padTo||0,this.floor=a.floor||!1;const{padTo:o,floor:r,...s}=a;if(!n||Object.keys(s).length>0){const l={useGrouping:!1,...a};a.padTo>0&&(l.minimumIntegerDigits=a.padTo),this.inf=bs(e,l)}}format(e){if(this.inf){const n=this.floor?Math.floor(e):e;return this.inf.format(n)}else{const n=this.floor?Math.floor(e):_o(e,3);return te(n,this.padTo)}}}class Ns{constructor(e,n,a){this.opts=a,this.originalZone=void 0;let o;if(this.opts.timeZone)this.dt=e;else if(e.zone.type==="fixed"){const s=-1*(e.offset/60),l=s>=0?`Etc/GMT+${s}`:`Etc/GMT${s}`;e.offset!==0&&st.create(l).valid?(o=l,this.dt=e):(o="UTC",this.dt=e.offset===0?e:e.setZone("UTC").plus({minutes:e.offset}),this.originalZone=e.zone)}else e.zone.type==="system"?this.dt=e:e.zone.type==="iana"?(this.dt=e,o=e.zone.name):(o="UTC",this.dt=e.setZone("UTC").plus({minutes:e.offset}),this.originalZone=e.zone);const r={...this.opts};r.timeZone=r.timeZone||o,this.dtf=ao(n,r)}format(){return this.originalZone?this.formatToParts().map(({value:e})=>e).join(""):this.dtf.format(this.dt.toJSDate())}formatToParts(){const e=this.dtf.formatToParts(this.dt.toJSDate());return this.originalZone?e.map(n=>{if(n.type==="timeZoneName"){const a=this.originalZone.offsetName(this.dt.ts,{locale:this.dt.locale,format:this.opts.timeZoneName});return{...n,value:a}}else return n}):e}resolvedOptions(){return this.dtf.resolvedOptions()}}class Fs{constructor(e,n,a){this.opts={style:"long",...a},!n&&lr()&&(this.rtf=Ss(e,a))}format(e,n){return this.rtf?this.rtf.format(e,n):tl(n,e,this.opts.numeric,this.opts.style!=="long")}formatToParts(e,n){return this.rtf?this.rtf.formatToParts(e,n):[]}}const tr={firstDay:1,minimalDays:4,weekend:[6,7]};class J{static fromOpts(e){return J.create(e.locale,e.numberingSystem,e.outputCalendar,e.weekSettings,e.defaultToEN)}static create(e,n,a,o,r=!1){const s=e||K.defaultLocale,l=s||(r?"en-US":Es()),c=n||K.defaultNumberingSystem,d=a||K.defaultOutputCalendar,m=co(o)||K.defaultWeekSettings;return new J(l,c,d,m,s)}static resetCache(){mn=null,no.clear(),oo.clear(),io.clear(),ro.clear(),so.clear()}static fromObject({locale:e,numberingSystem:n,outputCalendar:a,weekSettings:o}={}){return J.create(e,n,a,o)}constructor(e,n,a,o,r){const[s,l,c]=Ts(e);this.locale=s,this.numberingSystem=n||l||null,this.outputCalendar=a||c||null,this.weekSettings=o,this.intl=_s(this.locale,this.numberingSystem,this.outputCalendar),this.weekdaysCache={format:{},standalone:{}},this.monthsCache={format:{},standalone:{}},this.meridiemCache=null,this.eraCache={},this.specifiedLocale=r,this.fastNumbersCached=null}get fastNumbers(){return this.fastNumbersCached==null&&(this.fastNumbersCached=Is(this)),this.fastNumbersCached}listingMode(){const e=this.isEnglish(),n=(this.numberingSystem===null||this.numberingSystem==="latn")&&(this.outputCalendar===null||this.outputCalendar==="gregory");return e&&n?"en":"intl"}clone(e){return!e||Object.getOwnPropertyNames(e).length===0?this:J.create(e.locale||this.specifiedLocale,e.numberingSystem||this.numberingSystem,e.outputCalendar||this.outputCalendar,co(e.weekSettings)||this.weekSettings,e.defaultToEN||!1)}redefaultToEN(e={}){return this.clone({...e,defaultToEN:!0})}redefaultToSystem(e={}){return this.clone({...e,defaultToEN:!1})}months(e,n=!1){return Nn(this,e,hr,()=>{const a=n?{month:e,day:"numeric"}:{month:e},o=n?"format":"standalone";return this.monthsCache[o][e]||(this.monthsCache[o][e]=Cs(r=>this.extract(r,a,"month"))),this.monthsCache[o][e]})}weekdays(e,n=!1){return Nn(this,e,fr,()=>{const a=n?{weekday:e,year:"numeric",month:"long",day:"numeric"}:{weekday:e},o=n?"format":"standalone";return this.weekdaysCache[o][e]||(this.weekdaysCache[o][e]=As(r=>this.extract(r,a,"weekday"))),this.weekdaysCache[o][e]})}meridiems(){return Nn(this,void 0,()=>yr,()=>{if(!this.meridiemCache){const e={hour:"numeric",hourCycle:"h12"};this.meridiemCache=[N.utc(2016,11,13,9),N.utc(2016,11,13,19)].map(n=>this.extract(n,e,"dayperiod"))}return this.meridiemCache})}eras(e){return Nn(this,e,wr,()=>{const n={era:e};return this.eraCache[e]||(this.eraCache[e]=[N.utc(-40,1,1),N.utc(2017,1,1)].map(a=>this.extract(a,n,"era"))),this.eraCache[e]})}extract(e,n,a){const o=this.dtFormatter(e,n),r=o.formatToParts(),s=r.find(l=>l.type.toLowerCase()===a);return s?s.value:null}numberFormatter(e={}){return new Ds(this.intl,e.forceSimple||this.fastNumbers,e)}dtFormatter(e,n={}){return new Ns(e,this.intl,n)}relFormatter(e={}){return new Fs(this.intl,this.isEnglish(),e)}listFormatter(e={}){return Ms(this.intl,e)}isEnglish(){return this.locale==="en"||this.locale.toLowerCase()==="en-us"||er(this.intl).locale.startsWith("en-us")}getWeekSettings(){return this.weekSettings?this.weekSettings:cr()?ks(this.locale):tr}getStartOfWeek(){return this.getWeekSettings().firstDay}getMinDaysInFirstWeek(){return this.getWeekSettings().minimalDays}getWeekendDays(){return this.getWeekSettings().weekend}equals(e){return this.locale===e.locale&&this.numberingSystem===e.numberingSystem&&this.outputCalendar===e.outputCalendar}toString(){return`Locale(${this.locale}, ${this.numberingSystem}, ${this.outputCalendar})`}}let Pa=null;class ge extends _n{static get utcInstance(){return Pa===null&&(Pa=new ge(0)),Pa}static instance(e){return e===0?ge.utcInstance:new ge(e)}static parseSpecifier(e){if(e){const n=e.match(/^utc(?:([+-]\d{1,2})(?::(\d{2}))?)?$/i);if(n)return new ge(ia(n[1],n[2]))}return null}constructor(e){super(),this.fixed=e}get type(){return"fixed"}get name(){return this.fixed===0?"UTC":`UTC${yn(this.fixed,"narrow")}`}get ianaName(){return this.fixed===0?"Etc/UTC":`Etc/GMT${yn(-this.fixed,"narrow")}`}offsetName(){return this.name}formatOffset(e,n){return yn(this.fixed,n)}get isUniversal(){return!0}offset(){return this.fixed}equals(e){return e.type==="fixed"&&e.fixed===this.fixed}get isValid(){return!0}}class xs extends _n{constructor(e){super(),this.zoneName=e}get type(){return"invalid"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(){return null}formatOffset(){return""}offset(){return NaN}equals(){return!1}get isValid(){return!1}}function gt(t,e){if(O(t)||t===null)return e;if(t instanceof _n)return t;if(Hs(t)){const n=t.toLowerCase();return n==="default"?e:n==="local"||n==="system"?na.instance:n==="utc"||n==="gmt"?ge.utcInstance:ge.parseSpecifier(n)||st.create(t)}else return wt(t)?ge.instance(t):typeof t=="object"&&"offset"in t&&typeof t.offset=="function"?t:new xs(t)}const So={arab:"[٠-٩]",arabext:"[۰-۹]",bali:"[᭐-᭙]",beng:"[০-৯]",deva:"[०-९]",fullwide:"[０-９]",gujr:"[૦-૯]",hanidec:"[〇|一|二|三|四|五|六|七|八|九]",khmr:"[០-៩]",knda:"[೦-೯]",laoo:"[໐-໙]",limb:"[᥆-᥏]",mlym:"[൦-൯]",mong:"[᠐-᠙]",mymr:"[၀-၉]",orya:"[୦-୯]",tamldec:"[௦-௯]",telu:"[౦-౯]",thai:"[๐-๙]",tibt:"[༠-༩]",latn:"\\d"},Vo={arab:[1632,1641],arabext:[1776,1785],bali:[6992,7001],beng:[2534,2543],deva:[2406,2415],fullwide:[65296,65303],gujr:[2790,2799],khmr:[6112,6121],knda:[3302,3311],laoo:[3792,3801],limb:[6470,6479],mlym:[3430,3439],mong:[6160,6169],mymr:[4160,4169],orya:[2918,2927],tamldec:[3046,3055],telu:[3174,3183],thai:[3664,3673],tibt:[3872,3881]},Ps=So.hanidec.replace(/[\[|\]]/g,"").split("");function $s(t){let e=parseInt(t,10);if(isNaN(e)){e="";for(let n=0;n<t.length;n++){const a=t.charCodeAt(n);if(t[n].search(So.hanidec)!==-1)e+=Ps.indexOf(t[n]);else for(const o in Vo){const[r,s]=Vo[o];a>=r&&a<=s&&(e+=a-r)}}return parseInt(e,10)}else return e}const lo=new Map;function Rs(){lo.clear()}function We({numberingSystem:t},e=""){const n=t||"latn";let a=lo.get(n);a===void 0&&(a=new Map,lo.set(n,a));let o=a.get(e);return o===void 0&&(o=new RegExp(`${So[n]}${e}`),a.set(e,o)),o}let Jo=()=>Date.now(),jo="system",Zo=null,qo=null,Ko=null,Yo=60,Xo,Qo=null,K=class{static get now(){return Jo}static set now(e){Jo=e}static set defaultZone(e){jo=e}static get defaultZone(){return gt(jo,na.instance)}static get defaultLocale(){return Zo}static set defaultLocale(e){Zo=e}static get defaultNumberingSystem(){return qo}static set defaultNumberingSystem(e){qo=e}static get defaultOutputCalendar(){return Ko}static set defaultOutputCalendar(e){Ko=e}static get defaultWeekSettings(){return Qo}static set defaultWeekSettings(e){Qo=co(e)}static get twoDigitCutoffYear(){return Yo}static set twoDigitCutoffYear(e){Yo=e%100}static get throwOnInvalid(){return Xo}static set throwOnInvalid(e){Xo=e}static resetCaches(){J.resetCache(),st.resetCache(),N.resetCache(),Rs()}};class Ge{constructor(e,n){this.reason=e,this.explanation=n}toMessage(){return this.explanation?`${this.reason}: ${this.explanation}`:this.reason}}const nr=[0,31,59,90,120,151,181,212,243,273,304,334],ar=[0,31,60,91,121,152,182,213,244,274,305,335];function $e(t,e){return new Ge("unit out of range",`you specified ${e} (of type ${typeof e}) as a ${t}, which is invalid`)}function Eo(t,e,n){const a=new Date(Date.UTC(t,e-1,n));t<100&&t>=0&&a.setUTCFullYear(a.getUTCFullYear()-1900);const o=a.getUTCDay();return o===0?7:o}function or(t,e,n){return n+(Cn(t)?ar:nr)[e-1]}function ir(t,e){const n=Cn(t)?ar:nr,a=n.findIndex(r=>r<e),o=e-n[a];return{month:a+1,day:o}}function ko(t,e){return(t-e+7)%7+1}function qn(t,e=4,n=1){const{year:a,month:o,day:r}=t,s=or(a,o,r),l=ko(Eo(a,o,r),n);let c=Math.floor((s-l+14-e)/7),d;return c<1?(d=a-1,c=bn(d,e,n)):c>bn(a,e,n)?(d=a+1,c=1):d=a,{weekYear:d,weekNumber:c,weekday:l,...ra(t)}}function ei(t,e=4,n=1){const{weekYear:a,weekNumber:o,weekday:r}=t,s=ko(Eo(a,1,e),n),l=Vt(a);let c=o*7+r-s-7+e,d;c<1?(d=a-1,c+=Vt(d)):c>l?(d=a+1,c-=Vt(a)):d=a;const{month:m,day:h}=ir(d,c);return{year:d,month:m,day:h,...ra(t)}}function $a(t){const{year:e,month:n,day:a}=t,o=or(e,n,a);return{year:e,ordinal:o,...ra(t)}}function ti(t){const{year:e,ordinal:n}=t,{month:a,day:o}=ir(e,n);return{year:e,month:a,day:o,...ra(t)}}function ni(t,e){if(!O(t.localWeekday)||!O(t.localWeekNumber)||!O(t.localWeekYear)){if(!O(t.weekday)||!O(t.weekNumber)||!O(t.weekYear))throw new Ut("Cannot mix locale-based week fields with ISO-based week fields");return O(t.localWeekday)||(t.weekday=t.localWeekday),O(t.localWeekNumber)||(t.weekNumber=t.localWeekNumber),O(t.localWeekYear)||(t.weekYear=t.localWeekYear),delete t.localWeekday,delete t.localWeekNumber,delete t.localWeekYear,{minDaysInFirstWeek:e.getMinDaysInFirstWeek(),startOfWeek:e.getStartOfWeek()}}else return{minDaysInFirstWeek:4,startOfWeek:1}}function Os(t,e=4,n=1){const a=aa(t.weekYear),o=Re(t.weekNumber,1,bn(t.weekYear,e,n)),r=Re(t.weekday,1,7);return a?o?r?!1:$e("weekday",t.weekday):$e("week",t.weekNumber):$e("weekYear",t.weekYear)}function Us(t){const e=aa(t.year),n=Re(t.ordinal,1,Vt(t.year));return e?n?!1:$e("ordinal",t.ordinal):$e("year",t.year)}function rr(t){const e=aa(t.year),n=Re(t.month,1,12),a=Re(t.day,1,Kn(t.year,t.month));return e?n?a?!1:$e("day",t.day):$e("month",t.month):$e("year",t.year)}function sr(t){const{hour:e,minute:n,second:a,millisecond:o}=t,r=Re(e,0,23)||e===24&&n===0&&a===0&&o===0,s=Re(n,0,59),l=Re(a,0,59),c=Re(o,0,999);return r?s?l?c?!1:$e("millisecond",o):$e("second",a):$e("minute",n):$e("hour",e)}function O(t){return typeof t>"u"}function wt(t){return typeof t=="number"}function aa(t){return typeof t=="number"&&t%1===0}function Hs(t){return typeof t=="string"}function Bs(t){return Object.prototype.toString.call(t)==="[object Date]"}function lr(){try{return typeof Intl<"u"&&!!Intl.RelativeTimeFormat}catch{return!1}}function cr(){try{return typeof Intl<"u"&&!!Intl.Locale&&("weekInfo"in Intl.Locale.prototype||"getWeekInfo"in Intl.Locale.prototype)}catch{return!1}}function Ws(t){return Array.isArray(t)?t:[t]}function ai(t,e,n){if(t.length!==0)return t.reduce((a,o)=>{const r=[e(o),o];return a&&n(a[0],r[0])===a[0]?a:r},null)[1]}function zs(t,e){return e.reduce((n,a)=>(n[a]=t[a],n),{})}function jt(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function co(t){if(t==null)return null;if(typeof t!="object")throw new ue("Week settings must be an object");if(!Re(t.firstDay,1,7)||!Re(t.minimalDays,1,7)||!Array.isArray(t.weekend)||t.weekend.some(e=>!Re(e,1,7)))throw new ue("Invalid week settings");return{firstDay:t.firstDay,minimalDays:t.minimalDays,weekend:Array.from(t.weekend)}}function Re(t,e,n){return aa(t)&&t>=e&&t<=n}function Gs(t,e){return t-e*Math.floor(t/e)}function te(t,e=2){const n=t<0;let a;return n?a="-"+(""+-t).padStart(e,"0"):a=(""+t).padStart(e,"0"),a}function pt(t){if(!(O(t)||t===null||t===""))return parseInt(t,10)}function Mt(t){if(!(O(t)||t===null||t===""))return parseFloat(t)}function To(t){if(!(O(t)||t===null||t==="")){const e=parseFloat("0."+t)*1e3;return Math.floor(e)}}function _o(t,e,n=!1){const a=10**e;return(n?Math.trunc:Math.round)(t*a)/a}function Cn(t){return t%4===0&&(t%100!==0||t%400===0)}function Vt(t){return Cn(t)?366:365}function Kn(t,e){const n=Gs(e-1,12)+1,a=t+(e-n)/12;return n===2?Cn(a)?29:28:[31,null,31,30,31,30,31,31,30,31,30,31][n-1]}function oa(t){let e=Date.UTC(t.year,t.month-1,t.day,t.hour,t.minute,t.second,t.millisecond);return t.year<100&&t.year>=0&&(e=new Date(e),e.setUTCFullYear(t.year,t.month-1,t.day)),+e}function oi(t,e,n){return-ko(Eo(t,1,e),n)+e-1}function bn(t,e=4,n=1){const a=oi(t,e,n),o=oi(t+1,e,n);return(Vt(t)-a+o)/7}function uo(t){return t>99?t:t>K.twoDigitCutoffYear?1900+t:2e3+t}function ur(t,e,n,a=null){const o=new Date(t),r={hourCycle:"h23",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"};a&&(r.timeZone=a);const s={timeZoneName:e,...r},l=new Intl.DateTimeFormat(n,s).formatToParts(o).find(c=>c.type.toLowerCase()==="timezonename");return l?l.value:null}function ia(t,e){let n=parseInt(t,10);Number.isNaN(n)&&(n=0);const a=parseInt(e,10)||0,o=n<0||Object.is(n,-0)?-a:a;return n*60+o}function dr(t){const e=Number(t);if(typeof t=="boolean"||t===""||Number.isNaN(e))throw new ue(`Invalid unit value ${t}`);return e}function Yn(t,e){const n={};for(const a in t)if(jt(t,a)){const o=t[a];if(o==null)continue;n[e(a)]=dr(o)}return n}function yn(t,e){const n=Math.trunc(Math.abs(t/60)),a=Math.trunc(Math.abs(t%60)),o=t>=0?"+":"-";switch(e){case"short":return`${o}${te(n,2)}:${te(a,2)}`;case"narrow":return`${o}${n}${a>0?`:${a}`:""}`;case"techie":return`${o}${te(n,2)}${te(a,2)}`;default:throw new RangeError(`Value format ${e} is out of range for property format`)}}function ra(t){return zs(t,["hour","minute","second","millisecond"])}const Vs=["January","February","March","April","May","June","July","August","September","October","November","December"],mr=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],Js=["J","F","M","A","M","J","J","A","S","O","N","D"];function hr(t){switch(t){case"narrow":return[...Js];case"short":return[...mr];case"long":return[...Vs];case"numeric":return["1","2","3","4","5","6","7","8","9","10","11","12"];case"2-digit":return["01","02","03","04","05","06","07","08","09","10","11","12"];default:return null}}const pr=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],gr=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],js=["M","T","W","T","F","S","S"];function fr(t){switch(t){case"narrow":return[...js];case"short":return[...gr];case"long":return[...pr];case"numeric":return["1","2","3","4","5","6","7"];default:return null}}const yr=["AM","PM"],Zs=["Before Christ","Anno Domini"],qs=["BC","AD"],Ks=["B","A"];function wr(t){switch(t){case"narrow":return[...Ks];case"short":return[...qs];case"long":return[...Zs];default:return null}}function Ys(t){return yr[t.hour<12?0:1]}function Xs(t,e){return fr(e)[t.weekday-1]}function Qs(t,e){return hr(e)[t.month-1]}function el(t,e){return wr(e)[t.year<0?0:1]}function tl(t,e,n="always",a=!1){const o={years:["year","yr."],quarters:["quarter","qtr."],months:["month","mo."],weeks:["week","wk."],days:["day","day","days"],hours:["hour","hr."],minutes:["minute","min."],seconds:["second","sec."]},r=["hours","minutes","seconds"].indexOf(t)===-1;if(n==="auto"&&r){const h=t==="days";switch(e){case 1:return h?"tomorrow":`next ${o[t][0]}`;case-1:return h?"yesterday":`last ${o[t][0]}`;case 0:return h?"today":`this ${o[t][0]}`}}const s=Object.is(e,-0)||e<0,l=Math.abs(e),c=l===1,d=o[t],m=a?c?d[1]:d[2]||d[1]:c?o[t][0]:t;return s?`${l} ${m} ago`:`in ${l} ${m}`}function ii(t,e){let n="";for(const a of t)a.literal?n+=a.val:n+=e(a.val);return n}const nl={D:Zn,DD:Pi,DDD:$i,DDDD:Ri,t:Oi,tt:Ui,ttt:Hi,tttt:Bi,T:Wi,TT:zi,TTT:Gi,TTTT:Vi,f:Ji,ff:Zi,fff:Ki,ffff:Xi,F:ji,FF:qi,FFF:Yi,FFFF:Qi};class he{static create(e,n={}){return new he(e,n)}static parseFormat(e){let n=null,a="",o=!1;const r=[];for(let s=0;s<e.length;s++){const l=e.charAt(s);l==="'"?(a.length>0&&r.push({literal:o||/^\s+$/.test(a),val:a}),n=null,a="",o=!o):o||l===n?a+=l:(a.length>0&&r.push({literal:/^\s+$/.test(a),val:a}),a=l,n=l)}return a.length>0&&r.push({literal:o||/^\s+$/.test(a),val:a}),r}static macroTokenToFormatOpts(e){return nl[e]}constructor(e,n){this.opts=n,this.loc=e,this.systemLoc=null}formatWithSystemDefault(e,n){return this.systemLoc===null&&(this.systemLoc=this.loc.redefaultToSystem()),this.systemLoc.dtFormatter(e,{...this.opts,...n}).format()}dtFormatter(e,n={}){return this.loc.dtFormatter(e,{...this.opts,...n})}formatDateTime(e,n){return this.dtFormatter(e,n).format()}formatDateTimeParts(e,n){return this.dtFormatter(e,n).formatToParts()}formatInterval(e,n){return this.dtFormatter(e.start,n).dtf.formatRange(e.start.toJSDate(),e.end.toJSDate())}resolvedOptions(e,n){return this.dtFormatter(e,n).resolvedOptions()}num(e,n=0){if(this.opts.forceSimple)return te(e,n);const a={...this.opts};return n>0&&(a.padTo=n),this.loc.numberFormatter(a).format(e)}formatDateTimeFromString(e,n){const a=this.loc.listingMode()==="en",o=this.loc.outputCalendar&&this.loc.outputCalendar!=="gregory",r=(g,w)=>this.loc.extract(e,g,w),s=g=>e.isOffsetFixed&&e.offset===0&&g.allowZ?"Z":e.isValid?e.zone.formatOffset(e.ts,g.format):"",l=()=>a?Ys(e):r({hour:"numeric",hourCycle:"h12"},"dayperiod"),c=(g,w)=>a?Qs(e,g):r(w?{month:g}:{month:g,day:"numeric"},"month"),d=(g,w)=>a?Xs(e,g):r(w?{weekday:g}:{weekday:g,month:"long",day:"numeric"},"weekday"),m=g=>{const w=he.macroTokenToFormatOpts(g);return w?this.formatWithSystemDefault(e,w):g},h=g=>a?el(e,g):r({era:g},"era"),f=g=>{switch(g){case"S":return this.num(e.millisecond);case"u":case"SSS":return this.num(e.millisecond,3);case"s":return this.num(e.second);case"ss":return this.num(e.second,2);case"uu":return this.num(Math.floor(e.millisecond/10),2);case"uuu":return this.num(Math.floor(e.millisecond/100));case"m":return this.num(e.minute);case"mm":return this.num(e.minute,2);case"h":return this.num(e.hour%12===0?12:e.hour%12);case"hh":return this.num(e.hour%12===0?12:e.hour%12,2);case"H":return this.num(e.hour);case"HH":return this.num(e.hour,2);case"Z":return s({format:"narrow",allowZ:this.opts.allowZ});case"ZZ":return s({format:"short",allowZ:this.opts.allowZ});case"ZZZ":return s({format:"techie",allowZ:this.opts.allowZ});case"ZZZZ":return e.zone.offsetName(e.ts,{format:"short",locale:this.loc.locale});case"ZZZZZ":return e.zone.offsetName(e.ts,{format:"long",locale:this.loc.locale});case"z":return e.zoneName;case"a":return l();case"d":return o?r({day:"numeric"},"day"):this.num(e.day);case"dd":return o?r({day:"2-digit"},"day"):this.num(e.day,2);case"c":return this.num(e.weekday);case"ccc":return d("short",!0);case"cccc":return d("long",!0);case"ccccc":return d("narrow",!0);case"E":return this.num(e.weekday);case"EEE":return d("short",!1);case"EEEE":return d("long",!1);case"EEEEE":return d("narrow",!1);case"L":return o?r({month:"numeric",day:"numeric"},"month"):this.num(e.month);case"LL":return o?r({month:"2-digit",day:"numeric"},"month"):this.num(e.month,2);case"LLL":return c("short",!0);case"LLLL":return c("long",!0);case"LLLLL":return c("narrow",!0);case"M":return o?r({month:"numeric"},"month"):this.num(e.month);case"MM":return o?r({month:"2-digit"},"month"):this.num(e.month,2);case"MMM":return c("short",!1);case"MMMM":return c("long",!1);case"MMMMM":return c("narrow",!1);case"y":return o?r({year:"numeric"},"year"):this.num(e.year);case"yy":return o?r({year:"2-digit"},"year"):this.num(e.year.toString().slice(-2),2);case"yyyy":return o?r({year:"numeric"},"year"):this.num(e.year,4);case"yyyyyy":return o?r({year:"numeric"},"year"):this.num(e.year,6);case"G":return h("short");case"GG":return h("long");case"GGGGG":return h("narrow");case"kk":return this.num(e.weekYear.toString().slice(-2),2);case"kkkk":return this.num(e.weekYear,4);case"W":return this.num(e.weekNumber);case"WW":return this.num(e.weekNumber,2);case"n":return this.num(e.localWeekNumber);case"nn":return this.num(e.localWeekNumber,2);case"ii":return this.num(e.localWeekYear.toString().slice(-2),2);case"iiii":return this.num(e.localWeekYear,4);case"o":return this.num(e.ordinal);case"ooo":return this.num(e.ordinal,3);case"q":return this.num(e.quarter);case"qq":return this.num(e.quarter,2);case"X":return this.num(Math.floor(e.ts/1e3));case"x":return this.num(e.ts);default:return m(g)}};return ii(he.parseFormat(n),f)}formatDurationFromString(e,n){const a=c=>{switch(c[0]){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":return"hour";case"d":return"day";case"w":return"week";case"M":return"month";case"y":return"year";default:return null}},o=c=>d=>{const m=a(d);return m?this.num(c.get(m),d.length):d},r=he.parseFormat(n),s=r.reduce((c,{literal:d,val:m})=>d?c:c.concat(m),[]),l=e.shiftTo(...s.map(a).filter(c=>c));return ii(r,o(l))}}const Lr=/[A-Za-z_+-]{1,256}(?::?\/[A-Za-z0-9_+-]{1,256}(?:\/[A-Za-z0-9_+-]{1,256})?)?/;function qt(...t){const e=t.reduce((n,a)=>n+a.source,"");return RegExp(`^${e}$`)}function Kt(...t){return e=>t.reduce(([n,a,o],r)=>{const[s,l,c]=r(e,o);return[{...n,...s},l||a,c]},[{},null,1]).slice(0,2)}function Yt(t,...e){if(t==null)return[null,null];for(const[n,a]of e){const o=n.exec(t);if(o)return a(o)}return[null,null]}function vr(...t){return(e,n)=>{const a={};let o;for(o=0;o<t.length;o++)a[t[o]]=pt(e[n+o]);return[a,null,n+o]}}const Mr=/(?:(Z)|([+-]\d\d)(?::?(\d\d))?)/,al=`(?:${Mr.source}?(?:\\[(${Lr.source})\\])?)?`,Co=/(\d\d)(?::?(\d\d)(?::?(\d\d)(?:[.,](\d{1,30}))?)?)?/,br=RegExp(`${Co.source}${al}`),Ao=RegExp(`(?:T${br.source})?`),ol=/([+-]\d{6}|\d{4})(?:-?(\d\d)(?:-?(\d\d))?)?/,il=/(\d{4})-?W(\d\d)(?:-?(\d))?/,rl=/(\d{4})-?(\d{3})/,sl=vr("weekYear","weekNumber","weekDay"),ll=vr("year","ordinal"),cl=/(\d{4})-(\d\d)-(\d\d)/,Sr=RegExp(`${Co.source} ?(?:${Mr.source}|(${Lr.source}))?`),ul=RegExp(`(?: ${Sr.source})?`);function Jt(t,e,n){const a=t[e];return O(a)?n:pt(a)}function dl(t,e){return[{year:Jt(t,e),month:Jt(t,e+1,1),day:Jt(t,e+2,1)},null,e+3]}function Xt(t,e){return[{hours:Jt(t,e,0),minutes:Jt(t,e+1,0),seconds:Jt(t,e+2,0),milliseconds:To(t[e+3])},null,e+4]}function An(t,e){const n=!t[e]&&!t[e+1],a=ia(t[e+1],t[e+2]),o=n?null:ge.instance(a);return[{},o,e+3]}function In(t,e){const n=t[e]?st.create(t[e]):null;return[{},n,e+1]}const ml=RegExp(`^T?${Co.source}$`),hl=/^-?P(?:(?:(-?\d{1,20}(?:\.\d{1,20})?)Y)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20}(?:\.\d{1,20})?)W)?(?:(-?\d{1,20}(?:\.\d{1,20})?)D)?(?:T(?:(-?\d{1,20}(?:\.\d{1,20})?)H)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20})(?:[.,](-?\d{1,20}))?S)?)?)$/;function pl(t){const[e,n,a,o,r,s,l,c,d]=t,m=e[0]==="-",h=c&&c[0]==="-",f=(g,w=!1)=>g!==void 0&&(w||g&&m)?-g:g;return[{years:f(Mt(n)),months:f(Mt(a)),weeks:f(Mt(o)),days:f(Mt(r)),hours:f(Mt(s)),minutes:f(Mt(l)),seconds:f(Mt(c),c==="-0"),milliseconds:f(To(d),h)}]}const gl={GMT:0,EDT:-4*60,EST:-5*60,CDT:-5*60,CST:-6*60,MDT:-6*60,MST:-7*60,PDT:-7*60,PST:-8*60};function Io(t,e,n,a,o,r,s){const l={year:e.length===2?uo(pt(e)):pt(e),month:mr.indexOf(n)+1,day:pt(a),hour:pt(o),minute:pt(r)};return s&&(l.second=pt(s)),t&&(l.weekday=t.length>3?pr.indexOf(t)+1:gr.indexOf(t)+1),l}const fl=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|(?:([+-]\d\d)(\d\d)))$/;function yl(t){const[,e,n,a,o,r,s,l,c,d,m,h]=t,f=Io(e,o,a,n,r,s,l);let g;return c?g=gl[c]:d?g=0:g=ia(m,h),[f,new ge(g)]}function wl(t){return t.replace(/\([^()]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").trim()}const Ll=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun), (\d\d) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) (\d{4}) (\d\d):(\d\d):(\d\d) GMT$/,vl=/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday), (\d\d)-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-(\d\d) (\d\d):(\d\d):(\d\d) GMT$/,Ml=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) ( \d|\d\d) (\d\d):(\d\d):(\d\d) (\d{4})$/;function ri(t){const[,e,n,a,o,r,s,l]=t;return[Io(e,o,a,n,r,s,l),ge.utcInstance]}function bl(t){const[,e,n,a,o,r,s,l]=t;return[Io(e,l,n,a,o,r,s),ge.utcInstance]}const Sl=qt(ol,Ao),El=qt(il,Ao),kl=qt(rl,Ao),Tl=qt(br),Er=Kt(dl,Xt,An,In),_l=Kt(sl,Xt,An,In),Cl=Kt(ll,Xt,An,In),Al=Kt(Xt,An,In);function Il(t){return Yt(t,[Sl,Er],[El,_l],[kl,Cl],[Tl,Al])}function Dl(t){return Yt(wl(t),[fl,yl])}function Nl(t){return Yt(t,[Ll,ri],[vl,ri],[Ml,bl])}function Fl(t){return Yt(t,[hl,pl])}const xl=Kt(Xt);function Pl(t){return Yt(t,[ml,xl])}const $l=qt(cl,ul),Rl=qt(Sr),Ol=Kt(Xt,An,In);function Ul(t){return Yt(t,[$l,Er],[Rl,Ol])}const si="Invalid Duration",kr={weeks:{days:7,hours:7*24,minutes:7*24*60,seconds:7*24*60*60,milliseconds:7*24*60*60*1e3},days:{hours:24,minutes:24*60,seconds:24*60*60,milliseconds:24*60*60*1e3},hours:{minutes:60,seconds:60*60,milliseconds:60*60*1e3},minutes:{seconds:60,milliseconds:60*1e3},seconds:{milliseconds:1e3}},Hl={years:{quarters:4,months:12,weeks:52,days:365,hours:365*24,minutes:365*24*60,seconds:365*24*60*60,milliseconds:365*24*60*60*1e3},quarters:{months:3,weeks:13,days:91,hours:91*24,minutes:91*24*60,seconds:91*24*60*60,milliseconds:91*24*60*60*1e3},months:{weeks:4,days:30,hours:30*24,minutes:30*24*60,seconds:30*24*60*60,milliseconds:30*24*60*60*1e3},...kr},Ae=146097/400,Nt=146097/4800,Bl={years:{quarters:4,months:12,weeks:Ae/7,days:Ae,hours:Ae*24,minutes:Ae*24*60,seconds:Ae*24*60*60,milliseconds:Ae*24*60*60*1e3},quarters:{months:3,weeks:Ae/28,days:Ae/4,hours:Ae*24/4,minutes:Ae*24*60/4,seconds:Ae*24*60*60/4,milliseconds:Ae*24*60*60*1e3/4},months:{weeks:Nt/7,days:Nt,hours:Nt*24,minutes:Nt*24*60,seconds:Nt*24*60*60,milliseconds:Nt*24*60*60*1e3},...kr},_t=["years","quarters","months","weeks","days","hours","minutes","seconds","milliseconds"],Wl=_t.slice(0).reverse();function mt(t,e,n=!1){const a={values:n?e.values:{...t.values,...e.values||{}},loc:t.loc.clone(e.loc),conversionAccuracy:e.conversionAccuracy||t.conversionAccuracy,matrix:e.matrix||t.matrix};return new H(a)}function Tr(t,e){let n=e.milliseconds??0;for(const a of Wl.slice(1))e[a]&&(n+=e[a]*t[a].milliseconds);return n}function li(t,e){const n=Tr(t,e)<0?-1:1;_t.reduceRight((a,o)=>{if(O(e[o]))return a;if(a){const r=e[a]*n,s=t[o][a],l=Math.floor(r/s);e[o]+=l*n,e[a]-=l*s*n}return o},null),_t.reduce((a,o)=>{if(O(e[o]))return a;if(a){const r=e[a]%1;e[a]-=r,e[o]+=r*t[a][o]}return o},null)}function zl(t){const e={};for(const[n,a]of Object.entries(t))a!==0&&(e[n]=a);return e}class H{constructor(e){const n=e.conversionAccuracy==="longterm"||!1;let a=n?Bl:Hl;e.matrix&&(a=e.matrix),this.values=e.values,this.loc=e.loc||J.create(),this.conversionAccuracy=n?"longterm":"casual",this.invalid=e.invalid||null,this.matrix=a,this.isLuxonDuration=!0}static fromMillis(e,n){return H.fromObject({milliseconds:e},n)}static fromObject(e,n={}){if(e==null||typeof e!="object")throw new ue(`Duration.fromObject: argument expected to be an object, got ${e===null?"null":typeof e}`);return new H({values:Yn(e,H.normalizeUnit),loc:J.fromObject(n),conversionAccuracy:n.conversionAccuracy,matrix:n.matrix})}static fromDurationLike(e){if(wt(e))return H.fromMillis(e);if(H.isDuration(e))return e;if(typeof e=="object")return H.fromObject(e);throw new ue(`Unknown duration argument ${e} of type ${typeof e}`)}static fromISO(e,n){const[a]=Fl(e);return a?H.fromObject(a,n):H.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static fromISOTime(e,n){const[a]=Pl(e);return a?H.fromObject(a,n):H.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static invalid(e,n=null){if(!e)throw new ue("need to specify a reason the Duration is invalid");const a=e instanceof Ge?e:new Ge(e,n);if(K.throwOnInvalid)throw new ps(a);return new H({invalid:a})}static normalizeUnit(e){const n={year:"years",years:"years",quarter:"quarters",quarters:"quarters",month:"months",months:"months",week:"weeks",weeks:"weeks",day:"days",days:"days",hour:"hours",hours:"hours",minute:"minutes",minutes:"minutes",second:"seconds",seconds:"seconds",millisecond:"milliseconds",milliseconds:"milliseconds"}[e&&e.toLowerCase()];if(!n)throw new xi(e);return n}static isDuration(e){return e&&e.isLuxonDuration||!1}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}toFormat(e,n={}){const a={...n,floor:n.round!==!1&&n.floor!==!1};return this.isValid?he.create(this.loc,a).formatDurationFromString(this,e):si}toHuman(e={}){if(!this.isValid)return si;const n=_t.map(a=>{const o=this.values[a];return O(o)?null:this.loc.numberFormatter({style:"unit",unitDisplay:"long",...e,unit:a.slice(0,-1)}).format(o)}).filter(a=>a);return this.loc.listFormatter({type:"conjunction",style:e.listStyle||"narrow",...e}).format(n)}toObject(){return this.isValid?{...this.values}:{}}toISO(){if(!this.isValid)return null;let e="P";return this.years!==0&&(e+=this.years+"Y"),(this.months!==0||this.quarters!==0)&&(e+=this.months+this.quarters*3+"M"),this.weeks!==0&&(e+=this.weeks+"W"),this.days!==0&&(e+=this.days+"D"),(this.hours!==0||this.minutes!==0||this.seconds!==0||this.milliseconds!==0)&&(e+="T"),this.hours!==0&&(e+=this.hours+"H"),this.minutes!==0&&(e+=this.minutes+"M"),(this.seconds!==0||this.milliseconds!==0)&&(e+=_o(this.seconds+this.milliseconds/1e3,3)+"S"),e==="P"&&(e+="T0S"),e}toISOTime(e={}){if(!this.isValid)return null;const n=this.toMillis();return n<0||n>=864e5?null:(e={suppressMilliseconds:!1,suppressSeconds:!1,includePrefix:!1,format:"extended",...e,includeOffset:!1},N.fromMillis(n,{zone:"UTC"}).toISOTime(e))}toJSON(){return this.toISO()}toString(){return this.toISO()}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`Duration { values: ${JSON.stringify(this.values)} }`:`Duration { Invalid, reason: ${this.invalidReason} }`}toMillis(){return this.isValid?Tr(this.matrix,this.values):NaN}valueOf(){return this.toMillis()}plus(e){if(!this.isValid)return this;const n=H.fromDurationLike(e),a={};for(const o of _t)(jt(n.values,o)||jt(this.values,o))&&(a[o]=n.get(o)+this.get(o));return mt(this,{values:a},!0)}minus(e){if(!this.isValid)return this;const n=H.fromDurationLike(e);return this.plus(n.negate())}mapUnits(e){if(!this.isValid)return this;const n={};for(const a of Object.keys(this.values))n[a]=dr(e(this.values[a],a));return mt(this,{values:n},!0)}get(e){return this[H.normalizeUnit(e)]}set(e){if(!this.isValid)return this;const n={...this.values,...Yn(e,H.normalizeUnit)};return mt(this,{values:n})}reconfigure({locale:e,numberingSystem:n,conversionAccuracy:a,matrix:o}={}){const s={loc:this.loc.clone({locale:e,numberingSystem:n}),matrix:o,conversionAccuracy:a};return mt(this,s)}as(e){return this.isValid?this.shiftTo(e).get(e):NaN}normalize(){if(!this.isValid)return this;const e=this.toObject();return li(this.matrix,e),mt(this,{values:e},!0)}rescale(){if(!this.isValid)return this;const e=zl(this.normalize().shiftToAll().toObject());return mt(this,{values:e},!0)}shiftTo(...e){if(!this.isValid)return this;if(e.length===0)return this;e=e.map(s=>H.normalizeUnit(s));const n={},a={},o=this.toObject();let r;for(const s of _t)if(e.indexOf(s)>=0){r=s;let l=0;for(const d in a)l+=this.matrix[d][s]*a[d],a[d]=0;wt(o[s])&&(l+=o[s]);const c=Math.trunc(l);n[s]=c,a[s]=(l*1e3-c*1e3)/1e3}else wt(o[s])&&(a[s]=o[s]);for(const s in a)a[s]!==0&&(n[r]+=s===r?a[s]:a[s]/this.matrix[r][s]);return li(this.matrix,n),mt(this,{values:n},!0)}shiftToAll(){return this.isValid?this.shiftTo("years","months","weeks","days","hours","minutes","seconds","milliseconds"):this}negate(){if(!this.isValid)return this;const e={};for(const n of Object.keys(this.values))e[n]=this.values[n]===0?0:-this.values[n];return mt(this,{values:e},!0)}get years(){return this.isValid?this.values.years||0:NaN}get quarters(){return this.isValid?this.values.quarters||0:NaN}get months(){return this.isValid?this.values.months||0:NaN}get weeks(){return this.isValid?this.values.weeks||0:NaN}get days(){return this.isValid?this.values.days||0:NaN}get hours(){return this.isValid?this.values.hours||0:NaN}get minutes(){return this.isValid?this.values.minutes||0:NaN}get seconds(){return this.isValid?this.values.seconds||0:NaN}get milliseconds(){return this.isValid?this.values.milliseconds||0:NaN}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}equals(e){if(!this.isValid||!e.isValid||!this.loc.equals(e.loc))return!1;function n(a,o){return a===void 0||a===0?o===void 0||o===0:a===o}for(const a of _t)if(!n(this.values[a],e.values[a]))return!1;return!0}}const Ft="Invalid Interval";function Gl(t,e){return!t||!t.isValid?q.invalid("missing or invalid start"):!e||!e.isValid?q.invalid("missing or invalid end"):e<t?q.invalid("end before start",`The end of an interval must be after its start, but you had start=${t.toISO()} and end=${e.toISO()}`):null}class q{constructor(e){this.s=e.start,this.e=e.end,this.invalid=e.invalid||null,this.isLuxonInterval=!0}static invalid(e,n=null){if(!e)throw new ue("need to specify a reason the Interval is invalid");const a=e instanceof Ge?e:new Ge(e,n);if(K.throwOnInvalid)throw new hs(a);return new q({invalid:a})}static fromDateTimes(e,n){const a=dn(e),o=dn(n),r=Gl(a,o);return r??new q({start:a,end:o})}static after(e,n){const a=H.fromDurationLike(n),o=dn(e);return q.fromDateTimes(o,o.plus(a))}static before(e,n){const a=H.fromDurationLike(n),o=dn(e);return q.fromDateTimes(o.minus(a),o)}static fromISO(e,n){const[a,o]=(e||"").split("/",2);if(a&&o){let r,s;try{r=N.fromISO(a,n),s=r.isValid}catch{s=!1}let l,c;try{l=N.fromISO(o,n),c=l.isValid}catch{c=!1}if(s&&c)return q.fromDateTimes(r,l);if(s){const d=H.fromISO(o,n);if(d.isValid)return q.after(r,d)}else if(c){const d=H.fromISO(a,n);if(d.isValid)return q.before(l,d)}}return q.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static isInterval(e){return e&&e.isLuxonInterval||!1}get start(){return this.isValid?this.s:null}get end(){return this.isValid?this.e:null}get lastDateTime(){return this.isValid&&this.e?this.e.minus(1):null}get isValid(){return this.invalidReason===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}length(e="milliseconds"){return this.isValid?this.toDuration(e).get(e):NaN}count(e="milliseconds",n){if(!this.isValid)return NaN;const a=this.start.startOf(e,n);let o;return n!=null&&n.useLocaleWeeks?o=this.end.reconfigure({locale:a.locale}):o=this.end,o=o.startOf(e,n),Math.floor(o.diff(a,e).get(e))+(o.valueOf()!==this.end.valueOf())}hasSame(e){return this.isValid?this.isEmpty()||this.e.minus(1).hasSame(this.s,e):!1}isEmpty(){return this.s.valueOf()===this.e.valueOf()}isAfter(e){return this.isValid?this.s>e:!1}isBefore(e){return this.isValid?this.e<=e:!1}contains(e){return this.isValid?this.s<=e&&this.e>e:!1}set({start:e,end:n}={}){return this.isValid?q.fromDateTimes(e||this.s,n||this.e):this}splitAt(...e){if(!this.isValid)return[];const n=e.map(dn).filter(s=>this.contains(s)).sort((s,l)=>s.toMillis()-l.toMillis()),a=[];let{s:o}=this,r=0;for(;o<this.e;){const s=n[r]||this.e,l=+s>+this.e?this.e:s;a.push(q.fromDateTimes(o,l)),o=l,r+=1}return a}splitBy(e){const n=H.fromDurationLike(e);if(!this.isValid||!n.isValid||n.as("milliseconds")===0)return[];let{s:a}=this,o=1,r;const s=[];for(;a<this.e;){const l=this.start.plus(n.mapUnits(c=>c*o));r=+l>+this.e?this.e:l,s.push(q.fromDateTimes(a,r)),a=r,o+=1}return s}divideEqually(e){return this.isValid?this.splitBy(this.length()/e).slice(0,e):[]}overlaps(e){return this.e>e.s&&this.s<e.e}abutsStart(e){return this.isValid?+this.e==+e.s:!1}abutsEnd(e){return this.isValid?+e.e==+this.s:!1}engulfs(e){return this.isValid?this.s<=e.s&&this.e>=e.e:!1}equals(e){return!this.isValid||!e.isValid?!1:this.s.equals(e.s)&&this.e.equals(e.e)}intersection(e){if(!this.isValid)return this;const n=this.s>e.s?this.s:e.s,a=this.e<e.e?this.e:e.e;return n>=a?null:q.fromDateTimes(n,a)}union(e){if(!this.isValid)return this;const n=this.s<e.s?this.s:e.s,a=this.e>e.e?this.e:e.e;return q.fromDateTimes(n,a)}static merge(e){const[n,a]=e.sort((o,r)=>o.s-r.s).reduce(([o,r],s)=>r?r.overlaps(s)||r.abutsStart(s)?[o,r.union(s)]:[o.concat([r]),s]:[o,s],[[],null]);return a&&n.push(a),n}static xor(e){let n=null,a=0;const o=[],r=e.map(c=>[{time:c.s,type:"s"},{time:c.e,type:"e"}]),s=Array.prototype.concat(...r),l=s.sort((c,d)=>c.time-d.time);for(const c of l)a+=c.type==="s"?1:-1,a===1?n=c.time:(n&&+n!=+c.time&&o.push(q.fromDateTimes(n,c.time)),n=null);return q.merge(o)}difference(...e){return q.xor([this].concat(e)).map(n=>this.intersection(n)).filter(n=>n&&!n.isEmpty())}toString(){return this.isValid?`[${this.s.toISO()} – ${this.e.toISO()})`:Ft}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`Interval { start: ${this.s.toISO()}, end: ${this.e.toISO()} }`:`Interval { Invalid, reason: ${this.invalidReason} }`}toLocaleString(e=Zn,n={}){return this.isValid?he.create(this.s.loc.clone(n),e).formatInterval(this):Ft}toISO(e){return this.isValid?`${this.s.toISO(e)}/${this.e.toISO(e)}`:Ft}toISODate(){return this.isValid?`${this.s.toISODate()}/${this.e.toISODate()}`:Ft}toISOTime(e){return this.isValid?`${this.s.toISOTime(e)}/${this.e.toISOTime(e)}`:Ft}toFormat(e,{separator:n=" – "}={}){return this.isValid?`${this.s.toFormat(e)}${n}${this.e.toFormat(e)}`:Ft}toDuration(e,n){return this.isValid?this.e.diff(this.s,e,n):H.invalid(this.invalidReason)}mapEndpoints(e){return q.fromDateTimes(e(this.s),e(this.e))}}class Fn{static hasDST(e=K.defaultZone){const n=N.now().setZone(e).set({month:12});return!e.isUniversal&&n.offset!==n.set({month:6}).offset}static isValidIANAZone(e){return st.isValidZone(e)}static normalizeZone(e){return gt(e,K.defaultZone)}static getStartOfWeek({locale:e=null,locObj:n=null}={}){return(n||J.create(e)).getStartOfWeek()}static getMinimumDaysInFirstWeek({locale:e=null,locObj:n=null}={}){return(n||J.create(e)).getMinDaysInFirstWeek()}static getWeekendWeekdays({locale:e=null,locObj:n=null}={}){return(n||J.create(e)).getWeekendDays().slice()}static months(e="long",{locale:n=null,numberingSystem:a=null,locObj:o=null,outputCalendar:r="gregory"}={}){return(o||J.create(n,a,r)).months(e)}static monthsFormat(e="long",{locale:n=null,numberingSystem:a=null,locObj:o=null,outputCalendar:r="gregory"}={}){return(o||J.create(n,a,r)).months(e,!0)}static weekdays(e="long",{locale:n=null,numberingSystem:a=null,locObj:o=null}={}){return(o||J.create(n,a,null)).weekdays(e)}static weekdaysFormat(e="long",{locale:n=null,numberingSystem:a=null,locObj:o=null}={}){return(o||J.create(n,a,null)).weekdays(e,!0)}static meridiems({locale:e=null}={}){return J.create(e).meridiems()}static eras(e="short",{locale:n=null}={}){return J.create(n,null,"gregory").eras(e)}static features(){return{relative:lr(),localeWeek:cr()}}}function ci(t,e){const n=o=>o.toUTC(0,{keepLocalTime:!0}).startOf("day").valueOf(),a=n(e)-n(t);return Math.floor(H.fromMillis(a).as("days"))}function Vl(t,e,n){const a=[["years",(c,d)=>d.year-c.year],["quarters",(c,d)=>d.quarter-c.quarter+(d.year-c.year)*4],["months",(c,d)=>d.month-c.month+(d.year-c.year)*12],["weeks",(c,d)=>{const m=ci(c,d);return(m-m%7)/7}],["days",ci]],o={},r=t;let s,l;for(const[c,d]of a)n.indexOf(c)>=0&&(s=c,o[c]=d(t,e),l=r.plus(o),l>e?(o[c]--,t=r.plus(o),t>e&&(l=t,o[c]--,t=r.plus(o))):t=l);return[t,o,l,s]}function Jl(t,e,n,a){let[o,r,s,l]=Vl(t,e,n);const c=e-o,d=n.filter(h=>["hours","minutes","seconds","milliseconds"].indexOf(h)>=0);d.length===0&&(s<e&&(s=o.plus({[l]:1})),s!==o&&(r[l]=(r[l]||0)+c/(s-o)));const m=H.fromObject(r,a);return d.length>0?H.fromMillis(c,a).shiftTo(...d).plus(m):m}const jl="missing Intl.DateTimeFormat.formatToParts support";function G(t,e=n=>n){return{regex:t,deser:([n])=>e($s(n))}}const Zl=" ",_r=`[ ${Zl}]`,Cr=new RegExp(_r,"g");function ql(t){return t.replace(/\./g,"\\.?").replace(Cr,_r)}function ui(t){return t.replace(/\./g,"").replace(Cr," ").toLowerCase()}function ze(t,e){return t===null?null:{regex:RegExp(t.map(ql).join("|")),deser:([n])=>t.findIndex(a=>ui(n)===ui(a))+e}}function di(t,e){return{regex:t,deser:([,n,a])=>ia(n,a),groups:e}}function xn(t){return{regex:t,deser:([e])=>e}}function Kl(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function Yl(t,e){const n=We(e),a=We(e,"{2}"),o=We(e,"{3}"),r=We(e,"{4}"),s=We(e,"{6}"),l=We(e,"{1,2}"),c=We(e,"{1,3}"),d=We(e,"{1,6}"),m=We(e,"{1,9}"),h=We(e,"{2,4}"),f=We(e,"{4,6}"),g=v=>({regex:RegExp(Kl(v.val)),deser:([b])=>b,literal:!0}),y=(v=>{if(t.literal)return g(v);switch(v.val){case"G":return ze(e.eras("short"),0);case"GG":return ze(e.eras("long"),0);case"y":return G(d);case"yy":return G(h,uo);case"yyyy":return G(r);case"yyyyy":return G(f);case"yyyyyy":return G(s);case"M":return G(l);case"MM":return G(a);case"MMM":return ze(e.months("short",!0),1);case"MMMM":return ze(e.months("long",!0),1);case"L":return G(l);case"LL":return G(a);case"LLL":return ze(e.months("short",!1),1);case"LLLL":return ze(e.months("long",!1),1);case"d":return G(l);case"dd":return G(a);case"o":return G(c);case"ooo":return G(o);case"HH":return G(a);case"H":return G(l);case"hh":return G(a);case"h":return G(l);case"mm":return G(a);case"m":return G(l);case"q":return G(l);case"qq":return G(a);case"s":return G(l);case"ss":return G(a);case"S":return G(c);case"SSS":return G(o);case"u":return xn(m);case"uu":return xn(l);case"uuu":return G(n);case"a":return ze(e.meridiems(),0);case"kkkk":return G(r);case"kk":return G(h,uo);case"W":return G(l);case"WW":return G(a);case"E":case"c":return G(n);case"EEE":return ze(e.weekdays("short",!1),1);case"EEEE":return ze(e.weekdays("long",!1),1);case"ccc":return ze(e.weekdays("short",!0),1);case"cccc":return ze(e.weekdays("long",!0),1);case"Z":case"ZZ":return di(new RegExp(`([+-]${l.source})(?::(${a.source}))?`),2);case"ZZZ":return di(new RegExp(`([+-]${l.source})(${a.source})?`),2);case"z":return xn(/[a-z_+-/]{1,256}?/i);case" ":return xn(/[^\S\n\r]/);default:return g(v)}})(t)||{invalidReason:jl};return y.token=t,y}const Xl={year:{"2-digit":"yy",numeric:"yyyyy"},month:{numeric:"M","2-digit":"MM",short:"MMM",long:"MMMM"},day:{numeric:"d","2-digit":"dd"},weekday:{short:"EEE",long:"EEEE"},dayperiod:"a",dayPeriod:"a",hour12:{numeric:"h","2-digit":"hh"},hour24:{numeric:"H","2-digit":"HH"},minute:{numeric:"m","2-digit":"mm"},second:{numeric:"s","2-digit":"ss"},timeZoneName:{long:"ZZZZZ",short:"ZZZ"}};function Ql(t,e,n){const{type:a,value:o}=t;if(a==="literal"){const c=/^\s+$/.test(o);return{literal:!c,val:c?" ":o}}const r=e[a];let s=a;a==="hour"&&(e.hour12!=null?s=e.hour12?"hour12":"hour24":e.hourCycle!=null?e.hourCycle==="h11"||e.hourCycle==="h12"?s="hour12":s="hour24":s=n.hour12?"hour12":"hour24");let l=Xl[s];if(typeof l=="object"&&(l=l[r]),l)return{literal:!1,val:l}}function ec(t){return[`^${t.map(n=>n.regex).reduce((n,a)=>`${n}(${a.source})`,"")}$`,t]}function tc(t,e,n){const a=t.match(e);if(a){const o={};let r=1;for(const s in n)if(jt(n,s)){const l=n[s],c=l.groups?l.groups+1:1;!l.literal&&l.token&&(o[l.token.val[0]]=l.deser(a.slice(r,r+c))),r+=c}return[a,o]}else return[a,{}]}function nc(t){const e=r=>{switch(r){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":case"H":return"hour";case"d":return"day";case"o":return"ordinal";case"L":case"M":return"month";case"y":return"year";case"E":case"c":return"weekday";case"W":return"weekNumber";case"k":return"weekYear";case"q":return"quarter";default:return null}};let n=null,a;return O(t.z)||(n=st.create(t.z)),O(t.Z)||(n||(n=new ge(t.Z)),a=t.Z),O(t.q)||(t.M=(t.q-1)*3+1),O(t.h)||(t.h<12&&t.a===1?t.h+=12:t.h===12&&t.a===0&&(t.h=0)),t.G===0&&t.y&&(t.y=-t.y),O(t.u)||(t.S=To(t.u)),[Object.keys(t).reduce((r,s)=>{const l=e(s);return l&&(r[l]=t[s]),r},{}),n,a]}let Ra=null;function ac(){return Ra||(Ra=N.fromMillis(1555555555555)),Ra}function oc(t,e){if(t.literal)return t;const n=he.macroTokenToFormatOpts(t.val),a=Nr(n,e);return a==null||a.includes(void 0)?t:a}function Ar(t,e){return Array.prototype.concat(...t.map(n=>oc(n,e)))}class Ir{constructor(e,n){if(this.locale=e,this.format=n,this.tokens=Ar(he.parseFormat(n),e),this.units=this.tokens.map(a=>Yl(a,e)),this.disqualifyingUnit=this.units.find(a=>a.invalidReason),!this.disqualifyingUnit){const[a,o]=ec(this.units);this.regex=RegExp(a,"i"),this.handlers=o}}explainFromTokens(e){if(this.isValid){const[n,a]=tc(e,this.regex,this.handlers),[o,r,s]=a?nc(a):[null,null,void 0];if(jt(a,"a")&&jt(a,"H"))throw new Ut("Can't include meridiem when specifying 24-hour format");return{input:e,tokens:this.tokens,regex:this.regex,rawMatches:n,matches:a,result:o,zone:r,specificOffset:s}}else return{input:e,tokens:this.tokens,invalidReason:this.invalidReason}}get isValid(){return!this.disqualifyingUnit}get invalidReason(){return this.disqualifyingUnit?this.disqualifyingUnit.invalidReason:null}}function Dr(t,e,n){return new Ir(t,n).explainFromTokens(e)}function ic(t,e,n){const{result:a,zone:o,specificOffset:r,invalidReason:s}=Dr(t,e,n);return[a,o,r,s]}function Nr(t,e){if(!t)return null;const a=he.create(e,t).dtFormatter(ac()),o=a.formatToParts(),r=a.resolvedOptions();return o.map(s=>Ql(s,t,r))}const Oa="Invalid DateTime",mi=864e13;function hn(t){return new Ge("unsupported zone",`the zone "${t.name}" is not supported`)}function Ua(t){return t.weekData===null&&(t.weekData=qn(t.c)),t.weekData}function Ha(t){return t.localWeekData===null&&(t.localWeekData=qn(t.c,t.loc.getMinDaysInFirstWeek(),t.loc.getStartOfWeek())),t.localWeekData}function bt(t,e){const n={ts:t.ts,zone:t.zone,c:t.c,o:t.o,loc:t.loc,invalid:t.invalid};return new N({...n,...e,old:n})}function Fr(t,e,n){let a=t-e*60*1e3;const o=n.offset(a);if(e===o)return[a,e];a-=(o-e)*60*1e3;const r=n.offset(a);return o===r?[a,o]:[t-Math.min(o,r)*60*1e3,Math.max(o,r)]}function Pn(t,e){t+=e*60*1e3;const n=new Date(t);return{year:n.getUTCFullYear(),month:n.getUTCMonth()+1,day:n.getUTCDate(),hour:n.getUTCHours(),minute:n.getUTCMinutes(),second:n.getUTCSeconds(),millisecond:n.getUTCMilliseconds()}}function zn(t,e,n){return Fr(oa(t),e,n)}function hi(t,e){const n=t.o,a=t.c.year+Math.trunc(e.years),o=t.c.month+Math.trunc(e.months)+Math.trunc(e.quarters)*3,r={...t.c,year:a,month:o,day:Math.min(t.c.day,Kn(a,o))+Math.trunc(e.days)+Math.trunc(e.weeks)*7},s=H.fromObject({years:e.years-Math.trunc(e.years),quarters:e.quarters-Math.trunc(e.quarters),months:e.months-Math.trunc(e.months),weeks:e.weeks-Math.trunc(e.weeks),days:e.days-Math.trunc(e.days),hours:e.hours,minutes:e.minutes,seconds:e.seconds,milliseconds:e.milliseconds}).as("milliseconds"),l=oa(r);let[c,d]=Fr(l,n,t.zone);return s!==0&&(c+=s,d=t.zone.offset(c)),{ts:c,o:d}}function xt(t,e,n,a,o,r){const{setZone:s,zone:l}=n;if(t&&Object.keys(t).length!==0||e){const c=e||l,d=N.fromObject(t,{...n,zone:c,specificOffset:r});return s?d:d.setZone(l)}else return N.invalid(new Ge("unparsable",`the input "${o}" can't be parsed as ${a}`))}function $n(t,e,n=!0){return t.isValid?he.create(J.create("en-US"),{allowZ:n,forceSimple:!0}).formatDateTimeFromString(t,e):null}function Ba(t,e){const n=t.c.year>9999||t.c.year<0;let a="";return n&&t.c.year>=0&&(a+="+"),a+=te(t.c.year,n?6:4),e?(a+="-",a+=te(t.c.month),a+="-",a+=te(t.c.day)):(a+=te(t.c.month),a+=te(t.c.day)),a}function pi(t,e,n,a,o,r){let s=te(t.c.hour);return e?(s+=":",s+=te(t.c.minute),(t.c.millisecond!==0||t.c.second!==0||!n)&&(s+=":")):s+=te(t.c.minute),(t.c.millisecond!==0||t.c.second!==0||!n)&&(s+=te(t.c.second),(t.c.millisecond!==0||!a)&&(s+=".",s+=te(t.c.millisecond,3))),o&&(t.isOffsetFixed&&t.offset===0&&!r?s+="Z":t.o<0?(s+="-",s+=te(Math.trunc(-t.o/60)),s+=":",s+=te(Math.trunc(-t.o%60))):(s+="+",s+=te(Math.trunc(t.o/60)),s+=":",s+=te(Math.trunc(t.o%60)))),r&&(s+="["+t.zone.ianaName+"]"),s}const xr={month:1,day:1,hour:0,minute:0,second:0,millisecond:0},rc={weekNumber:1,weekday:1,hour:0,minute:0,second:0,millisecond:0},sc={ordinal:1,hour:0,minute:0,second:0,millisecond:0},Pr=["year","month","day","hour","minute","second","millisecond"],lc=["weekYear","weekNumber","weekday","hour","minute","second","millisecond"],cc=["year","ordinal","hour","minute","second","millisecond"];function uc(t){const e={year:"year",years:"year",month:"month",months:"month",day:"day",days:"day",hour:"hour",hours:"hour",minute:"minute",minutes:"minute",quarter:"quarter",quarters:"quarter",second:"second",seconds:"second",millisecond:"millisecond",milliseconds:"millisecond",weekday:"weekday",weekdays:"weekday",weeknumber:"weekNumber",weeksnumber:"weekNumber",weeknumbers:"weekNumber",weekyear:"weekYear",weekyears:"weekYear",ordinal:"ordinal"}[t.toLowerCase()];if(!e)throw new xi(t);return e}function gi(t){switch(t.toLowerCase()){case"localweekday":case"localweekdays":return"localWeekday";case"localweeknumber":case"localweeknumbers":return"localWeekNumber";case"localweekyear":case"localweekyears":return"localWeekYear";default:return uc(t)}}function dc(t){if(pn===void 0&&(pn=K.now()),t.type!=="iana")return t.offset(pn);const e=t.name;let n=mo.get(e);return n===void 0&&(n=t.offset(pn),mo.set(e,n)),n}function fi(t,e){const n=gt(e.zone,K.defaultZone);if(!n.isValid)return N.invalid(hn(n));const a=J.fromObject(e);let o,r;if(O(t.year))o=K.now();else{for(const c of Pr)O(t[c])&&(t[c]=xr[c]);const s=rr(t)||sr(t);if(s)return N.invalid(s);const l=dc(n);[o,r]=zn(t,l,n)}return new N({ts:o,zone:n,loc:a,o:r})}function yi(t,e,n){const a=O(n.round)?!0:n.round,o=(s,l)=>(s=_o(s,a||n.calendary?0:2,!0),e.loc.clone(n).relFormatter(n).format(s,l)),r=s=>n.calendary?e.hasSame(t,s)?0:e.startOf(s).diff(t.startOf(s),s).get(s):e.diff(t,s).get(s);if(n.unit)return o(r(n.unit),n.unit);for(const s of n.units){const l=r(s);if(Math.abs(l)>=1)return o(l,s)}return o(t>e?-0:0,n.units[n.units.length-1])}function wi(t){let e={},n;return t.length>0&&typeof t[t.length-1]=="object"?(e=t[t.length-1],n=Array.from(t).slice(0,t.length-1)):n=Array.from(t),[e,n]}let pn;const mo=new Map;class N{constructor(e){const n=e.zone||K.defaultZone;let a=e.invalid||(Number.isNaN(e.ts)?new Ge("invalid input"):null)||(n.isValid?null:hn(n));this.ts=O(e.ts)?K.now():e.ts;let o=null,r=null;if(!a)if(e.old&&e.old.ts===this.ts&&e.old.zone.equals(n))[o,r]=[e.old.c,e.old.o];else{const l=wt(e.o)&&!e.old?e.o:n.offset(this.ts);o=Pn(this.ts,l),a=Number.isNaN(o.year)?new Ge("invalid input"):null,o=a?null:o,r=a?null:l}this._zone=n,this.loc=e.loc||J.create(),this.invalid=a,this.weekData=null,this.localWeekData=null,this.c=o,this.o=r,this.isLuxonDateTime=!0}static now(){return new N({})}static local(){const[e,n]=wi(arguments),[a,o,r,s,l,c,d]=n;return fi({year:a,month:o,day:r,hour:s,minute:l,second:c,millisecond:d},e)}static utc(){const[e,n]=wi(arguments),[a,o,r,s,l,c,d]=n;return e.zone=ge.utcInstance,fi({year:a,month:o,day:r,hour:s,minute:l,second:c,millisecond:d},e)}static fromJSDate(e,n={}){const a=Bs(e)?e.valueOf():NaN;if(Number.isNaN(a))return N.invalid("invalid input");const o=gt(n.zone,K.defaultZone);return o.isValid?new N({ts:a,zone:o,loc:J.fromObject(n)}):N.invalid(hn(o))}static fromMillis(e,n={}){if(wt(e))return e<-mi||e>mi?N.invalid("Timestamp out of range"):new N({ts:e,zone:gt(n.zone,K.defaultZone),loc:J.fromObject(n)});throw new ue(`fromMillis requires a numerical input, but received a ${typeof e} with value ${e}`)}static fromSeconds(e,n={}){if(wt(e))return new N({ts:e*1e3,zone:gt(n.zone,K.defaultZone),loc:J.fromObject(n)});throw new ue("fromSeconds requires a numerical input")}static fromObject(e,n={}){e=e||{};const a=gt(n.zone,K.defaultZone);if(!a.isValid)return N.invalid(hn(a));const o=J.fromObject(n),r=Yn(e,gi),{minDaysInFirstWeek:s,startOfWeek:l}=ni(r,o),c=K.now(),d=O(n.specificOffset)?a.offset(c):n.specificOffset,m=!O(r.ordinal),h=!O(r.year),f=!O(r.month)||!O(r.day),g=h||f,w=r.weekYear||r.weekNumber;if((g||m)&&w)throw new Ut("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(f&&m)throw new Ut("Can't mix ordinal dates with month/day");const y=w||r.weekday&&!g;let v,b,S=Pn(c,d);y?(v=lc,b=rc,S=qn(S,s,l)):m?(v=cc,b=sc,S=$a(S)):(v=Pr,b=xr);let E=!1;for(const P of v){const I=r[P];O(I)?E?r[P]=b[P]:r[P]=S[P]:E=!0}const M=y?Os(r,s,l):m?Us(r):rr(r),k=M||sr(r);if(k)return N.invalid(k);const _=y?ei(r,s,l):m?ti(r):r,[C,T]=zn(_,d,a),D=new N({ts:C,zone:a,o:T,loc:o});return r.weekday&&g&&e.weekday!==D.weekday?N.invalid("mismatched weekday",`you can't specify both a weekday of ${r.weekday} and a date of ${D.toISO()}`):D.isValid?D:N.invalid(D.invalid)}static fromISO(e,n={}){const[a,o]=Il(e);return xt(a,o,n,"ISO 8601",e)}static fromRFC2822(e,n={}){const[a,o]=Dl(e);return xt(a,o,n,"RFC 2822",e)}static fromHTTP(e,n={}){const[a,o]=Nl(e);return xt(a,o,n,"HTTP",n)}static fromFormat(e,n,a={}){if(O(e)||O(n))throw new ue("fromFormat requires an input string and a format");const{locale:o=null,numberingSystem:r=null}=a,s=J.fromOpts({locale:o,numberingSystem:r,defaultToEN:!0}),[l,c,d,m]=ic(s,e,n);return m?N.invalid(m):xt(l,c,a,`format ${n}`,e,d)}static fromString(e,n,a={}){return N.fromFormat(e,n,a)}static fromSQL(e,n={}){const[a,o]=Ul(e);return xt(a,o,n,"SQL",e)}static invalid(e,n=null){if(!e)throw new ue("need to specify a reason the DateTime is invalid");const a=e instanceof Ge?e:new Ge(e,n);if(K.throwOnInvalid)throw new ms(a);return new N({invalid:a})}static isDateTime(e){return e&&e.isLuxonDateTime||!1}static parseFormatForOpts(e,n={}){const a=Nr(e,J.fromObject(n));return a?a.map(o=>o?o.val:null).join(""):null}static expandFormat(e,n={}){return Ar(he.parseFormat(e),J.fromObject(n)).map(o=>o.val).join("")}static resetCache(){pn=void 0,mo.clear()}get(e){return this[e]}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}get outputCalendar(){return this.isValid?this.loc.outputCalendar:null}get zone(){return this._zone}get zoneName(){return this.isValid?this.zone.name:null}get year(){return this.isValid?this.c.year:NaN}get quarter(){return this.isValid?Math.ceil(this.c.month/3):NaN}get month(){return this.isValid?this.c.month:NaN}get day(){return this.isValid?this.c.day:NaN}get hour(){return this.isValid?this.c.hour:NaN}get minute(){return this.isValid?this.c.minute:NaN}get second(){return this.isValid?this.c.second:NaN}get millisecond(){return this.isValid?this.c.millisecond:NaN}get weekYear(){return this.isValid?Ua(this).weekYear:NaN}get weekNumber(){return this.isValid?Ua(this).weekNumber:NaN}get weekday(){return this.isValid?Ua(this).weekday:NaN}get isWeekend(){return this.isValid&&this.loc.getWeekendDays().includes(this.weekday)}get localWeekday(){return this.isValid?Ha(this).weekday:NaN}get localWeekNumber(){return this.isValid?Ha(this).weekNumber:NaN}get localWeekYear(){return this.isValid?Ha(this).weekYear:NaN}get ordinal(){return this.isValid?$a(this.c).ordinal:NaN}get monthShort(){return this.isValid?Fn.months("short",{locObj:this.loc})[this.month-1]:null}get monthLong(){return this.isValid?Fn.months("long",{locObj:this.loc})[this.month-1]:null}get weekdayShort(){return this.isValid?Fn.weekdays("short",{locObj:this.loc})[this.weekday-1]:null}get weekdayLong(){return this.isValid?Fn.weekdays("long",{locObj:this.loc})[this.weekday-1]:null}get offset(){return this.isValid?+this.o:NaN}get offsetNameShort(){return this.isValid?this.zone.offsetName(this.ts,{format:"short",locale:this.locale}):null}get offsetNameLong(){return this.isValid?this.zone.offsetName(this.ts,{format:"long",locale:this.locale}):null}get isOffsetFixed(){return this.isValid?this.zone.isUniversal:null}get isInDST(){return this.isOffsetFixed?!1:this.offset>this.set({month:1,day:1}).offset||this.offset>this.set({month:5}).offset}getPossibleOffsets(){if(!this.isValid||this.isOffsetFixed)return[this];const e=864e5,n=6e4,a=oa(this.c),o=this.zone.offset(a-e),r=this.zone.offset(a+e),s=this.zone.offset(a-o*n),l=this.zone.offset(a-r*n);if(s===l)return[this];const c=a-s*n,d=a-l*n,m=Pn(c,s),h=Pn(d,l);return m.hour===h.hour&&m.minute===h.minute&&m.second===h.second&&m.millisecond===h.millisecond?[bt(this,{ts:c}),bt(this,{ts:d})]:[this]}get isInLeapYear(){return Cn(this.year)}get daysInMonth(){return Kn(this.year,this.month)}get daysInYear(){return this.isValid?Vt(this.year):NaN}get weeksInWeekYear(){return this.isValid?bn(this.weekYear):NaN}get weeksInLocalWeekYear(){return this.isValid?bn(this.localWeekYear,this.loc.getMinDaysInFirstWeek(),this.loc.getStartOfWeek()):NaN}resolvedLocaleOptions(e={}){const{locale:n,numberingSystem:a,calendar:o}=he.create(this.loc.clone(e),e).resolvedOptions(this);return{locale:n,numberingSystem:a,outputCalendar:o}}toUTC(e=0,n={}){return this.setZone(ge.instance(e),n)}toLocal(){return this.setZone(K.defaultZone)}setZone(e,{keepLocalTime:n=!1,keepCalendarTime:a=!1}={}){if(e=gt(e,K.defaultZone),e.equals(this.zone))return this;if(e.isValid){let o=this.ts;if(n||a){const r=e.offset(this.ts),s=this.toObject();[o]=zn(s,r,e)}return bt(this,{ts:o,zone:e})}else return N.invalid(hn(e))}reconfigure({locale:e,numberingSystem:n,outputCalendar:a}={}){const o=this.loc.clone({locale:e,numberingSystem:n,outputCalendar:a});return bt(this,{loc:o})}setLocale(e){return this.reconfigure({locale:e})}set(e){if(!this.isValid)return this;const n=Yn(e,gi),{minDaysInFirstWeek:a,startOfWeek:o}=ni(n,this.loc),r=!O(n.weekYear)||!O(n.weekNumber)||!O(n.weekday),s=!O(n.ordinal),l=!O(n.year),c=!O(n.month)||!O(n.day),d=l||c,m=n.weekYear||n.weekNumber;if((d||s)&&m)throw new Ut("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(c&&s)throw new Ut("Can't mix ordinal dates with month/day");let h;r?h=ei({...qn(this.c,a,o),...n},a,o):O(n.ordinal)?(h={...this.toObject(),...n},O(n.day)&&(h.day=Math.min(Kn(h.year,h.month),h.day))):h=ti({...$a(this.c),...n});const[f,g]=zn(h,this.o,this.zone);return bt(this,{ts:f,o:g})}plus(e){if(!this.isValid)return this;const n=H.fromDurationLike(e);return bt(this,hi(this,n))}minus(e){if(!this.isValid)return this;const n=H.fromDurationLike(e).negate();return bt(this,hi(this,n))}startOf(e,{useLocaleWeeks:n=!1}={}){if(!this.isValid)return this;const a={},o=H.normalizeUnit(e);switch(o){case"years":a.month=1;case"quarters":case"months":a.day=1;case"weeks":case"days":a.hour=0;case"hours":a.minute=0;case"minutes":a.second=0;case"seconds":a.millisecond=0;break}if(o==="weeks")if(n){const r=this.loc.getStartOfWeek(),{weekday:s}=this;s<r&&(a.weekNumber=this.weekNumber-1),a.weekday=r}else a.weekday=1;if(o==="quarters"){const r=Math.ceil(this.month/3);a.month=(r-1)*3+1}return this.set(a)}endOf(e,n){return this.isValid?this.plus({[e]:1}).startOf(e,n).minus(1):this}toFormat(e,n={}){return this.isValid?he.create(this.loc.redefaultToEN(n)).formatDateTimeFromString(this,e):Oa}toLocaleString(e=Zn,n={}){return this.isValid?he.create(this.loc.clone(n),e).formatDateTime(this):Oa}toLocaleParts(e={}){return this.isValid?he.create(this.loc.clone(e),e).formatDateTimeParts(this):[]}toISO({format:e="extended",suppressSeconds:n=!1,suppressMilliseconds:a=!1,includeOffset:o=!0,extendedZone:r=!1}={}){if(!this.isValid)return null;const s=e==="extended";let l=Ba(this,s);return l+="T",l+=pi(this,s,n,a,o,r),l}toISODate({format:e="extended"}={}){return this.isValid?Ba(this,e==="extended"):null}toISOWeekDate(){return $n(this,"kkkk-'W'WW-c")}toISOTime({suppressMilliseconds:e=!1,suppressSeconds:n=!1,includeOffset:a=!0,includePrefix:o=!1,extendedZone:r=!1,format:s="extended"}={}){return this.isValid?(o?"T":"")+pi(this,s==="extended",n,e,a,r):null}toRFC2822(){return $n(this,"EEE, dd LLL yyyy HH:mm:ss ZZZ",!1)}toHTTP(){return $n(this.toUTC(),"EEE, dd LLL yyyy HH:mm:ss 'GMT'")}toSQLDate(){return this.isValid?Ba(this,!0):null}toSQLTime({includeOffset:e=!0,includeZone:n=!1,includeOffsetSpace:a=!0}={}){let o="HH:mm:ss.SSS";return(n||e)&&(a&&(o+=" "),n?o+="z":e&&(o+="ZZ")),$n(this,o,!0)}toSQL(e={}){return this.isValid?`${this.toSQLDate()} ${this.toSQLTime(e)}`:null}toString(){return this.isValid?this.toISO():Oa}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`DateTime { ts: ${this.toISO()}, zone: ${this.zone.name}, locale: ${this.locale} }`:`DateTime { Invalid, reason: ${this.invalidReason} }`}valueOf(){return this.toMillis()}toMillis(){return this.isValid?this.ts:NaN}toSeconds(){return this.isValid?this.ts/1e3:NaN}toUnixInteger(){return this.isValid?Math.floor(this.ts/1e3):NaN}toJSON(){return this.toISO()}toBSON(){return this.toJSDate()}toObject(e={}){if(!this.isValid)return{};const n={...this.c};return e.includeConfig&&(n.outputCalendar=this.outputCalendar,n.numberingSystem=this.loc.numberingSystem,n.locale=this.loc.locale),n}toJSDate(){return new Date(this.isValid?this.ts:NaN)}diff(e,n="milliseconds",a={}){if(!this.isValid||!e.isValid)return H.invalid("created by diffing an invalid DateTime");const o={locale:this.locale,numberingSystem:this.numberingSystem,...a},r=Ws(n).map(H.normalizeUnit),s=e.valueOf()>this.valueOf(),l=s?this:e,c=s?e:this,d=Jl(l,c,r,o);return s?d.negate():d}diffNow(e="milliseconds",n={}){return this.diff(N.now(),e,n)}until(e){return this.isValid?q.fromDateTimes(this,e):this}hasSame(e,n,a){if(!this.isValid)return!1;const o=e.valueOf(),r=this.setZone(e.zone,{keepLocalTime:!0});return r.startOf(n,a)<=o&&o<=r.endOf(n,a)}equals(e){return this.isValid&&e.isValid&&this.valueOf()===e.valueOf()&&this.zone.equals(e.zone)&&this.loc.equals(e.loc)}toRelative(e={}){if(!this.isValid)return null;const n=e.base||N.fromObject({},{zone:this.zone}),a=e.padding?this<n?-e.padding:e.padding:0;let o=["years","months","days","hours","minutes","seconds"],r=e.unit;return Array.isArray(e.unit)&&(o=e.unit,r=void 0),yi(n,this.plus(a),{...e,numeric:"always",units:o,unit:r})}toRelativeCalendar(e={}){return this.isValid?yi(e.base||N.fromObject({},{zone:this.zone}),this,{...e,numeric:"auto",units:["years","months","days"],calendary:!0}):null}static min(...e){if(!e.every(N.isDateTime))throw new ue("min requires all arguments be DateTimes");return ai(e,n=>n.valueOf(),Math.min)}static max(...e){if(!e.every(N.isDateTime))throw new ue("max requires all arguments be DateTimes");return ai(e,n=>n.valueOf(),Math.max)}static fromFormatExplain(e,n,a={}){const{locale:o=null,numberingSystem:r=null}=a,s=J.fromOpts({locale:o,numberingSystem:r,defaultToEN:!0});return Dr(s,e,n)}static fromStringExplain(e,n,a={}){return N.fromFormatExplain(e,n,a)}static buildFormatParser(e,n={}){const{locale:a=null,numberingSystem:o=null}=n,r=J.fromOpts({locale:a,numberingSystem:o,defaultToEN:!0});return new Ir(r,e)}static fromFormatParser(e,n,a={}){if(O(e)||O(n))throw new ue("fromFormatParser requires an input string and a format parser");const{locale:o=null,numberingSystem:r=null}=a,s=J.fromOpts({locale:o,numberingSystem:r,defaultToEN:!0});if(!s.equals(n.locale))throw new ue(`fromFormatParser called with a locale of ${s}, but the format parser was created for ${n.locale}`);const{result:l,zone:c,specificOffset:d,invalidReason:m}=n.explainFromTokens(e);return m?N.invalid(m):xt(l,c,a,`format ${n.format}`,e,d)}static get DATE_SHORT(){return Zn}static get DATE_MED(){return Pi}static get DATE_MED_WITH_WEEKDAY(){return gs}static get DATE_FULL(){return $i}static get DATE_HUGE(){return Ri}static get TIME_SIMPLE(){return Oi}static get TIME_WITH_SECONDS(){return Ui}static get TIME_WITH_SHORT_OFFSET(){return Hi}static get TIME_WITH_LONG_OFFSET(){return Bi}static get TIME_24_SIMPLE(){return Wi}static get TIME_24_WITH_SECONDS(){return zi}static get TIME_24_WITH_SHORT_OFFSET(){return Gi}static get TIME_24_WITH_LONG_OFFSET(){return Vi}static get DATETIME_SHORT(){return Ji}static get DATETIME_SHORT_WITH_SECONDS(){return ji}static get DATETIME_MED(){return Zi}static get DATETIME_MED_WITH_SECONDS(){return qi}static get DATETIME_MED_WITH_WEEKDAY(){return fs}static get DATETIME_FULL(){return Ki}static get DATETIME_FULL_WITH_SECONDS(){return Yi}static get DATETIME_HUGE(){return Xi}static get DATETIME_HUGE_WITH_SECONDS(){return Qi}}function dn(t){if(N.isDateTime(t))return t;if(t&&t.valueOf&&wt(t.valueOf()))return N.fromJSDate(t);if(t&&typeof t=="object")return N.fromObject(t);throw new ue(`Unknown datetime argument: ${t}, of type ${typeof t}`)}const Ht=65,Le=73,Ie=79;function $r(t,e){if(e=typeof e=="number"?e:5,!Array.isArray(t))throw new TypeError("forward did not receive an array");if(typeof t[0]=="string"||typeof t[1]=="string")throw new TypeError("forward received an array of strings, but it only accepts an array of numbers.");const[n,a]=t;if(n<-180||n>180)throw new TypeError("forward received an invalid longitude of "+n);if(a<-90||a>90)throw new TypeError("forward received an invalid latitude of "+a);if(a<-80||a>84)throw new TypeError(`forward received a latitude of ${a}, but this library does not support conversions of points in polar regions below 80°S and above 84°N`);return function(o,r){const s="00000"+o.easting,l="00000"+o.northing;return o.zoneNumber+o.zoneLetter+function(c,d,m){const h=Or(m),f=Math.floor(c/1e5),g=Math.floor(d/1e5)%20;return function(w,y,v){const b=v-1,S="AJSAJS".charCodeAt(b),E="AFAFAF".charCodeAt(b);let M=S+w-1,k=E+y,_=!1;return M>90&&(M=M-90+Ht-1,_=!0),(M===Le||S<Le&&M>Le||(M>Le||S<Le)&&_)&&M++,(M===Ie||S<Ie&&M>Ie||(M>Ie||S<Ie)&&_)&&(M++,M===Le&&M++),M>90&&(M=M-90+Ht-1),k>86?(k=k-86+Ht-1,_=!0):_=!1,(k===Le||E<Le&&k>Le||(k>Le||E<Le)&&_)&&k++,(k===Ie||E<Ie&&k>Ie||(k>Ie||E<Ie)&&_)&&(k++,k===Le&&k++),k>86&&(k=k-86+Ht-1),String.fromCharCode(M)+String.fromCharCode(k)}(f,g,h)}(o.easting,o.northing,o.zoneNumber)+s.substr(s.length-5,r)+l.substr(l.length-5,r)}(function(o){const r=o.lat,s=o.lon,l=6378137,c=Wa(r),d=Wa(s);let m;m=Math.floor((s+180)/6)+1,s===180&&(m=60),r>=56&&r<64&&s>=3&&s<12&&(m=32),r>=72&&r<84&&(s>=0&&s<9?m=31:s>=9&&s<21?m=33:s>=21&&s<33?m=35:s>=33&&s<42&&(m=37));const h=Wa(6*(m-1)-180+3),f=l/Math.sqrt(1-.00669438*Math.sin(c)*Math.sin(c)),g=Math.tan(c)*Math.tan(c),w=.006739496752268451*Math.cos(c)*Math.cos(c),y=Math.cos(c)*(d-h),v=l*(.9983242984503243*c-.002514607064228144*Math.sin(2*c)+2639046602129982e-21*Math.sin(4*c)-3418046101696858e-24*Math.sin(6*c)),b=.9996*f*(y+(1-g+w)*y*y*y/6+(5-18*g+g*g+72*w-.39089081163157013)*y*y*y*y*y/120)+5e5;let S=.9996*(v+f*Math.tan(c)*(y*y/2+(5-g+9*w+4*w*w)*y*y*y*y/24+(61-58*g+g*g+600*w-2.2240339282485886)*y*y*y*y*y*y/720));return r<0&&(S+=1e7),{northing:Math.trunc(S),easting:Math.trunc(b),zoneNumber:m,zoneLetter:Rr(r)}}({lat:a,lon:n}),e)}function mc(t){const e=No(Ur(t.toUpperCase()));return typeof e.lat=="number"&&typeof e.lon=="number"?[e.lon,e.lat,e.lon,e.lat]:[e.left,e.bottom,e.right,e.top]}function Do(t){if(t==="")throw new TypeError("toPoint received a blank string");const e=No(Ur(t.toUpperCase()));return typeof e.lat=="number"&&typeof e.lon=="number"?[e.lon,e.lat]:[(e.left+e.right)/2,(e.top+e.bottom)/2]}function Wa(t){return t*(Math.PI/180)}function Li(t){return t/Math.PI*180}function No(t){const e=t.northing,n=t.easting,{zoneLetter:a,zoneNumber:o}=t;if(o<0||o>60)return null;const r=6378137,s=(1-Math.sqrt(.99330562))/(1+Math.sqrt(.99330562)),l=n-5e5;let c=e;a<"N"&&(c-=1e7);const d=6*(o-1)-180+3,m=c/.9996/6367449145945056e-9,h=m+(3*s/2-27*s*s*s/32)*Math.sin(2*m)+(21*s*s/16-55*s*s*s*s/32)*Math.sin(4*m)+151*s*s*s/96*Math.sin(6*m),f=r/Math.sqrt(1-.00669438*Math.sin(h)*Math.sin(h)),g=Math.tan(h)*Math.tan(h),w=.006739496752268451*Math.cos(h)*Math.cos(h),y=.99330562*r/Math.pow(1-.00669438*Math.sin(h)*Math.sin(h),1.5),v=l/(.9996*f);let b=h-f*Math.tan(h)/y*(v*v/2-(5+3*g+10*w-4*w*w-.06065547077041606)*v*v*v*v/24+(61+90*g+298*w+45*g*g-1.6983531815716497-3*w*w)*v*v*v*v*v*v/720);b=Li(b);let S,E=(v-(1+2*g+w)*v*v*v/6+(5-2*w+28*g-3*w*w+.05391597401814761+24*g*g)*v*v*v*v*v/120)/Math.cos(h);if(E=d+Li(E),typeof t.accuracy=="number"){const M=No({northing:t.northing+t.accuracy,easting:t.easting+t.accuracy,zoneLetter:t.zoneLetter,zoneNumber:t.zoneNumber});S={top:M.lat,right:M.lon,bottom:b,left:E}}else S={lat:b,lon:E};return S}function Rr(t){return t<=84&&t>=72?"X":t<72&&t>=-80?"CDEFGHJKLMNPQRSTUVWX"[Math.floor((t- -80)/8)]:t>84||t<-80?"Z":void 0}function Or(t){let e=t%6;return e===0&&(e=6),e}function Ur(t){if(t&&t.length===0)throw new TypeError("MGRSPoint coverting from nothing");t=t.replace(/ /g,"");const{length:e}=t;let n,a=null,o="",r=0;for(;!/[A-Z]/.test(n=t.charAt(r));){if(r>=2)throw new Error("MGRSPoint bad conversion from: "+t);o+=n,r++}const s=parseInt(o,10);if(r===0||r+3>e)throw new Error("MGRSPoint bad conversion from "+t);const l=t.charAt(r++);if(l<="A"||l==="B"||l==="Y"||l>="Z"||l==="I"||l==="O")throw new Error(`MGRSPoint zone letter ${l} not handled: ${t}`);a=t.substring(r,r+=2);const c=Or(s),d=function(S,E){let M="AJSAJS".charCodeAt(E-1),k=1e5,_=!1;for(;M!==S.charCodeAt(0);){if(M++,M===Le&&M++,M===Ie&&M++,M>90){if(_)throw new Error("Bad character: "+S);M=Ht,_=!0}k+=1e5}return k}(a.charAt(0),c);let m=function(S,E){if(S>"V")throw new TypeError("MGRSPoint given invalid Northing "+S);let M="AFAFAF".charCodeAt(E-1),k=0,_=!1;for(;M!==S.charCodeAt(0);){if(M++,M===Le&&M++,M===Ie&&M++,M>86){if(_)throw new Error("Bad character: "+S);M=Ht,_=!0}k+=1e5}return k}(a.charAt(1),c);for(;m<hc(l);)m+=2e6;const h=e-r;if(h%2!=0)throw new Error(`MGRSPoint has to have an even number
of digits after the zone letter and two 100km letters - front
half for easting meters, second half for
northing meters `+t);const f=h/2;let g,w,y,v=0,b=0;return f>0&&(g=1e5/Math.pow(10,f),w=t.substring(r,r+f),v=parseFloat(w)*g,y=t.substring(r+f),b=parseFloat(y)*g),{easting:v+d,northing:b+m,zoneLetter:l,zoneNumber:s,accuracy:g}}function hc(t){let e;switch(t){case"C":e=11e5;break;case"D":e=2e6;break;case"E":e=28e5;break;case"F":e=37e5;break;case"G":e=46e5;break;case"H":e=55e5;break;case"J":e=64e5;break;case"K":e=73e5;break;case"L":e=82e5;break;case"M":e=91e5;break;case"N":e=0;break;case"P":e=8e5;break;case"Q":e=17e5;break;case"R":e=26e5;break;case"S":e=35e5;break;case"T":e=44e5;break;case"U":e=53e5;break;case"V":e=62e5;break;case"W":e=7e6;break;case"X":e=79e5;break;default:e=-1}if(e>=0)return e;throw new TypeError("Invalid zone letter: "+t)}const pc=Object.freeze(Object.defineProperty({__proto__:null,forward:$r,getLetterDesignator:Rr,inverse:mc,toPoint:Do},Symbol.toStringTag,{value:"Module"})),gc="/upper_winds_open_meteo/icon-48.png",fc="/upper_winds_open_meteo/schere_purple.png",yc="/upper_winds_open_meteo/airplane_orange.png",wc="skydiver2025",vi={135:5,130:5,125:5,120:5,115:5,110:5,105:5,100:6,95:7,90:7,85:7,80:8,75:8,70:9,65:10,60:10,55:11,50:12,45:14,40:15,35:17,30:20,25:24,20:30,15:40,10:60,5:119},Hr={LIST:["icon_seamless","icon_global","icon_eu","icon_d2","ecmwf_ifs025","ecmwf_aifs025_single","gfs_seamless","gfs_global","gfs_hrrr","arome_france","gem_hrdps_continental","gem_regional"],API_MAP:{icon_seamless:"dwd_icon",icon_global:"dwd_icon",icon_eu:"dwd_icon_eu",icon_d2:"dwd_icon_d2",ecmwf_ifs025:"ecmwf_ifs025",ecmwf_aifs025_single:"ecmwf_aifs025_single",gfs_seamless:"ncep_gfs013",gfs_global:"ncep_gfs025",gfs_hrrr:"ncep_hrrr_conus",arome_france:"meteofrance_arome_france0025",gem_hrdps_continental:"cmc_gem_hrdps",gem_regional:"cmc_gem_rdps"}},de={METERS_TO_FEET:3.28084,FEET_TO_METERS:.3048,KNOTS_TO_MPS:.514444,KNOTS_TO_KMH:1.852,CELSIUS_TO_KELVIN:273.15},Mi={MOLAR_MASS_AIR:.0289644,UNIVERSAL_GAS_CONSTANT:8.31446261815324},Et={LAPSE_RATE:.0065,SEA_LEVEL_TEMP_KELVIN:288.15,GRAVITY:9.80665,GAS_CONSTANT_AIR:287.05},Rn={A_LIQUID:17.27,B_LIQUID:237.7,A_ICE:21.87,B_ICE:265.5},Lc=6371e3,bi={KNOT_THRESHOLDS:[1,4,7,11,17,22,28,34,41,48,56,64],BEAUFORT_THRESHOLDS:[0,1,3,6,10,16,21,27,33,40,47,55,63]},Sn={FORECAST:"https://api.open-meteo.com/v1/forecast",HISTORICAL:"https://historical-forecast-api.open-meteo.com/v1/forecast"},ve={SCENARIO_COLORS:{MIN_WIND:"rgba(0, 0, 255, 0.7)",MEAN_WIND:"rgba(0, 255, 0, 0.7)",MAX_WIND:"rgba(255, 0, 0, 0.7)"},HEATMAP_MIN_RADIUS_PX:5,HEATMAP_MAX_RADIUS_PX:50,HEATMAP_SCALING_BASE:1.42,HEATMAP_BASE_RADIUS:20,HEATMAP_REFERENCE_ZOOM:13},vc=[1e3,950,925,900,850,800,700,600,500,400,300,250,200],qe=200,za={OPEN:4.1,PARTIALLY:12.8,COLLAPSED:39.2},Mc=150,On={DEFAULT_AREA_VERTICAL:.5,DEFAULT_AREA_HORIZONTAL:.5,DEFAULT_MASS_KG:80,DEFAULT_DRAG_COEFFICIENT:1},Pt={MIN_TRACK_LENGTH_M:100,MAX_TRACK_LENGTH_M:1e4,MIN_APPROACH_LENGTH_M:100,MAX_APPROACH_LENGTH_M:2e4,APPROACH_TIME_SECONDS:120},Y={MESSAGE_TIMEOUT_MS:3e3,DEFAULT_MAP_CENTER:[48.0179,11.1923],DEFAULT_MAP_ZOOM:11,GEOLOCATION_TIMEOUT_MS:2e4,GEOLOCATION_ACCURACY_THRESHOLD_M:100,MIN_ZOOM:11,MAX_ZOOM:14,LANDING_PATTERN_MIN_ZOOM:14},Un={MIN_TIME_DIFF_FOR_SPEED_CALC_S:.5,SPEED_SMOOTHING_LOW:.5,SPEED_SMOOTHING_HIGH:.2,SPEED_SMOOTHING_TRESHOLD:25},sa={TILE_MAX_AGE_DAYS:7,FETCH_TIMEOUT_MS:15e3,SIZE_LIMIT_MB_WARNING:500},Qt={DEFAULT_MARKER:gc,CUTAWAY_MARKER:fc,AIRPLANE_MARKER:yc};let Ga=console.error,Va=console.log;var U;let p=(U=class{static formatTime(e){return N.fromISO(e,{zone:"UTC"}).toFormat("yyyy-MM-dd HHmm")+"Z"}static roundToTens(e){return Math.round(e/10)*10}static convertTemperature(e,n){const a=parseFloat(e);return isNaN(a)?"N/A":n==="°F"?a*9/5+32:a}static convertHeight(e,n){const a=parseFloat(e);return isNaN(a)?"N/A":n==="ft"?parseFloat((e*de.METERS_TO_FEET).toFixed(0)):e}static convertWind(e,n,a="km/h"){if(e==null||isNaN(e))return"N/A";let o;switch(a){case"km/h":o=e;break;case"m/s":o=e*3.6;break;case"kt":o=e*de.KNOTS_TO_KMH;break;case"mph":o=e*1.60934;break;case"bft":o=U.beaufortToKnots(e)*de.KNOTS_TO_KMH;break;default:o=e;break}switch(n){case"km/h":return o;case"m/s":return o/3.6;case"kt":return o/de.KNOTS_TO_KMH;case"mph":return o/1.60934;case"bft":return U.knotsToBeaufort(o/de.KNOTS_TO_KMH);default:return o/de.KNOTS_TO_KMH}}static knotsToBeaufort(e){const n=bi.KNOT_THRESHOLDS.findIndex(a=>e<a);return n===-1?12:n}static beaufortToKnots(e){return bi.BEAUFORT_THRESHOLDS[e]||63}static calculateDewpoint(e,n){const a=Rn.A_LIQUID,o=Rn.B_LIQUID,r=Rn.A_ICE,s=Rn.B_ICE;let l,c;return e>=0?(l=a*e/(o+e)+Math.log(n/100),c=o*l/(a-l)):(l=r*e/(s+e)+Math.log(n/100),c=s*l/(r-l)),isNaN(c)?null:c}static gaussianInterpolation(e,n,a,o,r){if(a===r)return e;if(o===r)return n;let s=1/Math.abs(a-r),l=1/Math.abs(o-r);return(s*e+l*n)/(s+l)}static interpolateWindAtAltitude(e,n,a,o,r){if(n.length!=a.length||n.length!=o.length||n.length!=r.length)return{u:"Invalid input",v:"Invalid input"};const s=n.map(h=>Math.log(h)),l=U.linearInterpolate(a,s,e);if(typeof l=="string"&&l.includes("error"))return{u:"Interpolation error",v:"Interpolation error"};const c=Math.exp(l),d=U.linearInterpolate(s,o,Math.log(c)),m=U.linearInterpolate(s,r,Math.log(c));return typeof d=="string"&&d.includes("error")||typeof m=="string"&&m.includes("error")?{u:"Interpolation error",v:"Interpolation error"}:{u:d,v:m}}static interpolatePressure(e,n,a){if(!n||!a||n.length!==a.length||n.length<2||e<a[0]||e>a[a.length-1])return"N/A";for(let o=0;o<a.length-1;o++)if(e>=a[o]&&e<=a[o+1]){const r=a[o],s=a[o+1],l=n[o],c=n[o+1];return l+(c-l)*(e-r)/(s-r)}return"N/A"}static linearInterpolate(e,n,a){if(!(e!=null&&e.length)||!(n!=null&&n.length)||e.length!==n.length)return"invalid input for linearInterpolate";let o=!1;e[1]>e[0]&&(n=[...n].reverse(),e=[...e].reverse(),o=!0);const r=e.length-1;try{if(a>e[0]||a<e[r]){let s,l;return a>e[0]?(s=(n[1]-n[0])/(e[1]-e[0]),l=n[1]-s*e[1]):(s=(n[r]-n[r-1])/(e[r]-e[r-1]),l=n[r]-s*e[r]),s*a+l}else{let s;for(s=1;s<=r&&!(a>=e[s]);s++);const l=(n[s]-n[s-1])/(e[s]-e[s-1]),c=n[s]-l*e[s];return l*a+c}}catch{return"interpolation error"}finally{o&&(n.reverse(),e.reverse())}}static windSpeed(e,n){return Math.sqrt(e*e+n*n)}static windDirection(e,n){return(Math.atan2(-e,-n)*180/Math.PI+360)%360}static calculateMeanWind(e,n,a,o,r){try{if(!e||!n||!a||e.length<2)throw new Error("Invalid input data for calculateMeanWind");const s=new Array(4);let l=[r],c=[Number(U.linearInterpolate(e,n,r))],d=[Number(U.linearInterpolate(e,a,r))];const m=Number(U.linearInterpolate(e,n,o)),h=Number(U.linearInterpolate(e,a,o));for(let b=0;b<e.length;b++)e[b]<r&&e[b]>o&&(l.push(e[b]),c.push(n[b]),d.push(a[b]));l.push(o),c.push(m),d.push(h);const f=l.map((b,S)=>S);f.sort((b,S)=>l[S]-l[b]),l=f.map(b=>l[b]),c=f.map(b=>c[b]),d=f.map(b=>d[b]);let g=0,w=0;for(let b=0;b<l.length-1;b++)g+=.5*(c[b]+c[b+1])*(l[b]-l[b+1]),w+=.5*(d[b]+d[b+1])*(l[b]-l[b+1]);const y=g/(l[0]-l[l.length-1]),v=w/(l[0]-l[l.length-1]);return s[2]=y,s[3]=v,s[1]=U.windSpeed(y,v),s[0]=U.windDirection(y,v),s}catch(s){return console.error("Error in calculateMeanWind:",s,{heights:e,xComponents:n,yComponents:a,lowerLimit:o,upperLimit:r}),U.handleError("Failed to calculate mean wind: "+s.message),null}}static async getLocationData(e,n){const a=`${e.toFixed(4)},${n.toFixed(4)}`;if(U.locationCache.has(a))return U.locationCache.get(a);try{const o=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${e}&longitude=${n}&timezone=auto`);if(!o.ok)throw o.status===429&&console.warn("API rate limit hit while fetching location data."),new Error(`Open-Meteo fetch failed: ${o.status}`);const r=await o.json(),s={timezone:r.timezone||"GMT",timezone_abbreviation:r.timezone_abbreviation||"GMT",elevation:r.elevation!==void 0?r.elevation:"N/A"};return U.locationCache.set(a,s),console.log(`Fetched location data for ${a}:`,s),s}catch(o){return console.error("Error fetching location data:",o.message),{timezone:"UTC",elevation:"N/A"}}}static async formatLocalTime(e,n,a){const{timezone:o,timezone_abbreviation:r}=await U.getLocationData(n,a);return N.fromISO(e,{zone:"UTC"}).setZone(o).toFormat("yyyy-MM-dd HHmm")+` ${r}`}static normalizeAngle(e){return(e%360+360)%360}static calculateWindAngle(e,n){let a=U.normalizeAngle(n-e);return a>180&&(a-=360),a}static calculateWindComponents(e,n){const a=n*(Math.PI/180),o=e*Math.sin(a),r=e*Math.cos(a);return{crosswind:o,headwind:r}}static calculateWCA(e,n){const o=Math.abs(Math.asin(e/n))*(180/Math.PI);return isNaN(o)?0:o}static calculateGroundSpeed(e,n){return e-n}static calculateCourseFromHeading(e,n,a,o){const r=U.calculateWindAngle(e,n),{crosswind:s,headwind:l}=U.calculateWindComponents(a,r),c=o*Math.sin(e*Math.PI/180),d=o*Math.cos(e*Math.PI/180),m=(n+180)%360,h=a*Math.sin(m*Math.PI/180),f=a*Math.cos(m*Math.PI/180),g=c+h,w=d+f,y=Math.atan2(g,w)*(180/Math.PI),v=U.normalizeAngle(y),b=Math.sqrt(g*g+w*w),S=U.calculateWCA(s,o)*(s<0?-1:1);return{trueCourse:Number(v.toFixed(2)),groundSpeed:Number(b.toFixed(2)),wca:Number(S.toFixed(2)),crosswind:Number(s.toFixed(2)),headwind:Number(l.toFixed(2))}}static calculateFlightParameters(e,n,a,o){const r=U.calculateWindAngle(e,n),{crosswind:s,headwind:l}=U.calculateWindComponents(a,r),c=U.calculateWCA(s,o),d=U.calculateGroundSpeed(o,l);return{crosswind:Number(s.toFixed(2)),headwind:Number(l.toFixed(2)),wca:Number(c.toFixed(2)),groundSpeed:Number(d.toFixed(2))}}static handleError(e,n=!0){n&&console.error(e),typeof displayError=="function"?displayError(e):(console.warn("Utils.js: displayError function is not available, logging to console only."),console.error("Error message:",e))}static dmsToDecimal(e,n,a,o){if(isNaN(e)||isNaN(n)||isNaN(a)||!o)throw console.warn("Invalid DMS inputs:",{deg:e,min:n,sec:a,dir:o}),new Error("Invalid DMS values");let r=e+n/60+a/3600;if((o==="S"||o==="W")&&(r=-r),isNaN(r))throw console.warn("DMS to decimal conversion failed:",{deg:e,min:n,sec:a,dir:o}),new Error("Failed to convert DMS to decimal");return r}static decimalToDms(e,n){if(isNaN(e)||e===null||e===void 0)throw console.warn("Invalid decimal value for DMS conversion:",e),new Error("Invalid coordinate for DMS conversion");const a=Math.abs(e),o=Math.floor(a),r=Math.floor((a-o)*60),s=(a-o)*3600-r*60,l=n?e>=0?"N":"S":e>=0?"E":"W";if(isNaN(o)||isNaN(r)||isNaN(s))throw console.warn("DMS calculation resulted in invalid values:",{deg:o,min:r,sec:s}),new Error("Failed to convert to DMS");return{deg:o,min:r,sec:s,dir:l}}static decimalToMgrs(e,n){try{return $r([n,e])}catch(a){return console.error("Error converting to MGRS:",a),"Invalid MGRS"}}static mgrsToDecimal(e){try{const[n,a]=Do(e);return{lat:a,lng:n}}catch(n){return console.error("Error converting MGRS to decimal:",n),null}}static convertCoords(e,n,a="Decimal"){if(e===null||n===null||e===void 0||n===void 0)return{lat:"N/A",lng:"N/A"};const o={Decimal:{lat:e.toFixed(6),lng:n.toFixed(6)},DMS:{lat:U.decimalToDms(e,!0),lng:U.decimalToDms(n,!1)},MGRS:U.decimalToMgrs(e,n)};switch(a){case"DMS":return o.DMS;case"MGRS":return{lat:o.MGRS,lng:o.MGRS};case"Decimal":default:return o.Decimal}}static calculateTAS(e,n){if(isNaN(e)||isNaN(n)||e<0||n<0)return console.warn("Invalid inputs for calculateTAS:",{ias:e,heightFt:n}),"N/A";const a=Et.LAPSE_RATE,o=Et.SEA_LEVEL_TEMP_KELVIN,r=Et.GRAVITY,s=Et.GAS_CONSTANT_AIR,l=de.FEET_TO_METERS,c=n*l,d=o-a*c,m=d/o,h=1-a*c/o,f=r/(a*s)-1,g=Math.pow(h,f),w=e/Math.sqrt(g);return console.log("calculateTAS debug:",{ias:e,heightFt:n,heightM:c,tempAtAltitude:d,tempRatio:m,base:h,exponent:f,densityRatio:g,tas:w,tasRounded:Number(w.toFixed(2))}),Number(w.toFixed(2))}static calculateTASFromGroundSpeed(e,n,a,o,r){if(isNaN(e)||isNaN(n)||isNaN(a)||isNaN(o))return"N/A";const s=U.convertWind(e,"kt","m/s"),l=U.convertWind(n,"kt","m/s"),c=U.calculateWindAngle(o,a),{crosswind:d,headwind:m}=U.calculateWindComponents(l,c),h=s+m,f=U.calculateTAS(h,r);return Number(f.toFixed(1))}static handleMessage(e){const n=document.getElementById("info");n?(n.textContent=e,n.style.display="block",setTimeout(()=>{n.style.display="none"},3e3),console.log("Displayed message:",e)):(console.warn("Info div not found for handleMessage, using alert"),alert(e))}static calculateQFE(e,n,a,o=15){if(!e||n==="N/A"||a==="N/A"||isNaN(e)||isNaN(n)||isNaN(a))return"N/A";console.log("QFE reference elevation: ",a);const r=Et.GRAVITY,s=Mi.MOLAR_MASS_AIR,l=Mi.UNIVERSAL_GAS_CONSTANT,c=o+de.CELSIUS_TO_KELVIN,d=Et.LAPSE_RATE,m=e*100,h=n-a,f=r*s/(l*d),g=m*Math.pow(1-d*h/c,f);console.log(e,n,a);const w=Math.round(g/100);return isNaN(w)?"N/A":w}static calculateNewCenter(e,n,a,o){const r=Lc,s=e*Math.PI/180,l=n*Math.PI/180,c=o*Math.PI/180,d=a/r,m=Math.asin(Math.sin(s)*Math.cos(d)+Math.cos(s)*Math.sin(d)*Math.cos(c)),h=l+Math.atan2(Math.sin(c)*Math.sin(d)*Math.cos(s),Math.cos(d)-Math.sin(s)*Math.sin(m)),f=m*180/Math.PI,w=(h*180/Math.PI+540)%360-180;return[f,w]}static debounce(e,n){let a;return function(...o){clearTimeout(a),a=setTimeout(()=>e.apply(this,o),n)}}static calculateBearing(e,n,a,o){const r=h=>h*Math.PI/180,s=h=>h*180/Math.PI,l=r(o-n),c=Math.sin(l)*Math.cos(r(a)),d=Math.cos(r(e))*Math.sin(r(a))-Math.sin(r(e))*Math.cos(r(a))*Math.cos(l);let m=s(Math.atan2(c,d));return m=(m+360)%360,m}static async getAltitude(e,n){const{elevation:a}=await U.getLocationData(e,n);return console.log("Fetched elevation from Open-Meteo:",a),a!=="N/A"?a:"N/A"}static getLastFullHourUTC(){const e=new Date,n=e.getUTCFullYear(),a=e.getUTCMonth(),o=e.getUTCDate(),r=e.getUTCHours(),s=new Date(Date.UTC(n,a,o,r,0,0));return console.log("Last full hour UTC:",s.toISOString()),s}static async getDisplayTime(e,n,a){var r;return(((r=document.querySelector('input[name="timeZone"]:checked'))==null?void 0:r.value)||"Z")==="Z"||!n||!a?U.formatTime(e):await U.formatLocalTime(e,n,a)}static calculateDynamicRadius(e=ve.HEATMAP_SCALING_BASE,n=ve.HEATMAP_REFERENCE_ZOOM){const a=i.map.getZoom(),o=ve.HEATMAP_SCALING_BASE,r=Math.pow(o,a-n),s=e*r,l=ve.HEATMAP_MIN_RADIUS_PX,c=ve.HEATMAP_MAX_RADIUS_PX,d=Math.max(l,Math.min(c,s));return console.log("[calculateDynamicRadius] Calculated dynamic radius:",{currentZoom:a,baseRadius:e,scaleFactor:r,dynamicRadius:s,adjustedRadius:d}),d}static interpolateColor(e,n=0,a=3e3){const o=Math.min(Math.max((e-n)/(a-n),0),1);return e<0||isNaN(e)?"#808080":o<=.5?`rgb(255, ${Math.round(255*(o*2))}, 0)`:`rgb(${Math.round(255*(1-(o-.5)*2))}, 255, 0)`}static generateWindBarb(e,n,a=null){const o=Math.round(n),r=40,s=40,l=r/2,c=s/2,d=20,h=(typeof a=="number"&&!isNaN(a)?a>=0:!0)?-1:1;let f=Math.floor(o/50),g=o%50,w=Math.floor(g/10),y=Math.floor(g%10/5);o<5?(w=0,y=0):o<10&&y>0&&(y=1);let v=`<svg width="${r}" height="${s}" viewBox="0 0 ${r} ${s}">`;const b=e+180;v+=`<g transform="translate(${l}, ${c}) rotate(${b})">`,v+=`<line x1="0" y1="${d/2}" x2="0" y2="${-d/2}" stroke="black" stroke-width="1"/>`;let S=d/2;const E=4;for(let M=0;M<f;M++)v+=`<polygon points="0,${S-5} 0,${S+5} ${10*h},${S}" fill="black"/>`,S-=E+5;for(let M=0;M<w;M++)v+=`<line x1="0" y1="${S}" x2="${10*h}" y2="${S}" stroke="black" stroke-width="1"/>`,S-=E;return y>0&&(v+=`<line x1="0" y1="${S}" x2="${5*h}" y2="${S}" stroke="black" stroke-width="1"/>`),o<5&&(v+='<circle cx="0" cy="0" r="3" fill="none" stroke="black" stroke-width="1"/>'),v+="</g></svg>",v}static setErrorHandler(e){Ga=e}static setMessageHandler(e){Va=e}static handleError(e,n=!0){n&&console.error(e),typeof Ga=="function"&&Ga(e)}static handleMessage(e){typeof Va=="function"?Va(e):console.log(e)}static validateLegHeights(e,n,a){const o=parseInt(e.value)||100,r=parseInt(n.value)||200,s=parseInt(a.value)||300;return r<=o?(U.handleError("Base leg must start higher than final leg."),!1):s<=r?(U.handleError("Downwind leg must start higher than base leg."),!1):!0}static convertFeetToMeters(e){return e==null||isNaN(e)?0:e/3.28084}},zo(U,"locationCache",new Map),U);window.Utils=p;const Te=()=>u.getValue("interpStepSelect","select",200),u={FEATURE_PASSWORD:"skydiver2025",defaultSettings:{model:"icon_global",refLevel:"AGL",heightUnit:"m",temperatureUnit:"C",windUnit:"kt",timeZone:"Z",coordFormat:"Decimal",downloadFormat:"HEIDIS",showTable:!1,canopySpeed:20,descentRate:3.5,showLandingPattern:!1,landingDirection:"LL",customLandingDirectionLL:"",customLandingDirectionRR:"",legHeightDownwind:300,legHeightBase:200,legHeightFinal:100,interpStep:"200",lowerLimit:0,upperLimit:3e3,baseMaps:"Esri Street",calculateJump:!0,openingAltitude:1200,exitAltitude:3e3,showJumpRunTrack:!1,showExitArea:!1,showCanopyArea:!1,jumpRunTrackOffset:0,jumpRunTrackForwardOffset:0,aircraftSpeedKt:90,jumperSeparation:5,numberOfJumpers:5,cutAwayAltitude:1e3,cutAwayState:"Partially",trackPosition:!1,showJumpMasterLine:!1,jumpMasterLineTarget:"DIP",harpLat:null,harpLng:null,cacheRadiusKm:10,cacheZoomLevels:[11,12,13,14],autoupdate:!1,selectedEnsembleModels:[],currentEnsembleScenario:"all_models"},state:{userSettings:null,unlockedFeatures:{landingPattern:!1,calculateJump:!1,planner:!1},isJumperSeparationManual:!1,isLandingPatternUnlocked:!1,isCalculateJumpUnlocked:!1,isPlannerUnlocked:!1},initialize(){let t={},e={landingPattern:!1,calculateJump:!1};try{const a=localStorage.getItem("upperWindsSettings");a?(t=JSON.parse(a),console.log("Loaded settings from localStorage:",t)):console.log("No settings found in localStorage, using defaults")}catch(a){this.handleError(a,"Failed to load settings. Using defaults.")}try{const a=localStorage.getItem("unlockedFeatures");a?(e=JSON.parse(a),console.log("Loaded unlocked features from localStorage:",e)):console.log("No unlocked features found in localStorage, using defaults")}catch(a){this.handleError(a,"Failed to load unlocked features. Using defaults.")}this.state.userSettings={...this.defaultSettings,...t},console.log("Initialized userSettings:",this.state.userSettings),this.state.userSettings.harpLat=null,this.state.userSettings.harpLng=null,console.log("Reset HARP coordinates to null at startup"),this.state.userSettings.jumpMasterLineTarget==="HARP"&&(console.log("Reset jumpMasterLineTarget to DIP due to cleared HARP coordinates"),this.state.userSettings.jumpMasterLineTarget="DIP"),this.state.userSettings.selectedEnsembleModels=[...this.defaultSettings.selectedEnsembleModels],this.state.userSettings.currentEnsembleScenario=this.defaultSettings.currentEnsembleScenario,this.state.unlockedFeatures={landingPattern:e.landingPattern||!1,calculateJump:e.calculateJump||!1},["OpenStreetMap","OpenTopoMap","Esri Satellite","Esri Street","Esri Topo","Esri Satellite + OSM"].includes(this.state.userSettings.baseMaps)||(console.warn(`Invalid baseMaps setting: ${this.state.userSettings.baseMaps}, resetting to default`),this.state.userSettings.baseMaps=this.defaultSettings.baseMaps)},save(){const t={...this.state.userSettings};delete t.customJumpRunDirection;try{localStorage.setItem("upperWindsSettings",JSON.stringify(t)),console.log("Settings saved to localStorage:",t)}catch(e){console.error("Failed to save settings to localStorage:",e)}},saveUnlockStatus(t,e){try{t==="landingPattern"?(this.state.unlockedFeatures.landingPattern=e,this.state.isLandingPatternUnlocked=e):t==="calculateJump"?(this.state.unlockedFeatures.calculateJump=e,this.state.isCalculateJumpUnlocked=e):t==="planner"&&(this.state.unlockedFeatures.planner=e,this.state.isPlannerUnlocked=e),this.saveUnlockedFeatures(),console.log("Saved unlock status:",{landingPattern:this.state.isLandingPatternUnlocked,calculateJump:this.state.isCalculateJumpUnlocked})}catch{Utils.handleError("Failed to save unlock status.")}},showPasswordModal(t,e,n){console.log("Entering showPasswordModal for feature:",t);const a=document.getElementById("passwordModal"),o=document.getElementById("passwordInput"),r=document.getElementById("passwordError"),s=document.getElementById("passwordSubmit"),l=document.getElementById("passwordCancel"),c=document.getElementById("modalHeader"),d=document.getElementById("modalMessage");if(!a||!o||!s||!l||!c||!d){console.error("Modal elements not found:",{modal:a,input:o,submitBtn:s,cancelBtn:l,header:c,message:d});return}const m=t.charAt(0).toUpperCase()+t.slice(1);c.textContent=`${m} Access`,d.textContent=`Please enter the password to enable the ${m.toLowerCase()} functionality:`,o.value="",r.style.display="none",a.style.display="flex",console.log("Password modal should now be visible:",{modalDisplay:a.style.display});const h=()=>{if(console.log("Password modal submit clicked, entered value:",o.value),o.value===wc){if(a.style.display="none",this.saveUnlockStatus(t,!0),t==="landingPattern"){const f=document.getElementById("showLandingPattern");f&&(f.style.opacity="1",f.title="")}else if(t==="calculateJump"){const f=document.querySelector('.menu-label[data-label="calculateJump"]');f&&(f.style.opacity="1",f.title="")}console.log("Feature unlocked:",t),e()}else r.textContent="Incorrect password",r.style.display="block",console.log("Incorrect password entered")};s.onclick=h,o.onkeypress=f=>{f.key==="Enter"&&h()},l.onclick=()=>{a.style.display="none",console.log("Password modal cancelled"),n()}},saveUnlockedFeatures(){try{const t=JSON.stringify(this.state.unlockedFeatures);localStorage.setItem("unlockedFeatures",t),console.log("Unlocked features saved:",JSON.parse(t))}catch(t){this.handleError(t,"Failed to save unlocked features to localStorage.")}},getValue(t,e,n){if(this.state.userSettings&&typeof this.state.userSettings[t]<"u")return this.state.userSettings[t];const a=e==="radio"?`input[name="${t}"]:checked`:`#${t}`,o=document.querySelector(a);if(!o)return console.warn(`Setting element not found in DOM for fallback: ${a}`),n;let r;switch(e){case"checkbox":r=o.checked;break;case"number":r=parseFloat(o.value);break;default:r=o.value}return r},updateUnitLabels(){const t=this.getValue("heightUnit","radio","m"),e=this.getValue("windUnit","radio","kt"),n=this.getValue("refLevel","radio","AGL"),a=document.querySelector('#controls-row label[for="interpStepSelect"]');a&&(a.textContent=`Step (${t}):`,console.log(`Updated step label to: Step (${t})`));const o=document.querySelector('label[for="lowerLimit"]'),r=document.querySelector('label[for="upperLimit"]');o&&(o.textContent=`Lower Limit (${t}):`,console.log(`Updated lower limit label to: Lower Limit (${t})`)),r&&(r.textContent=`Upper Limit (${t}):`,console.log(`Updated upper limit label to: Upper Limit (${t})`));const s=document.getElementById("meanWindResult");if(s!=null&&s.innerHTML){let l=s.innerHTML;const c=/\((\d+)-(\d+) m\b[^)]*\)/;if(c.test(l)){const[m,h,f]=l.match(c),g=this.convertHeight(parseFloat(h),t),w=this.convertHeight(parseFloat(f),t);l=l.replace(c,`(${Math.round(g)}-${Math.round(w)} ${t} ${n})`),console.log(`Updated mean wind height: (${Math.round(g)}-${Math.round(w)} ${t} ${n})`)}const d=/: (\d+(?:\.\d+)?)\s*([a-zA-Z\/]+)$/;if(d.test(l)){const[m,h,f]=l.match(d),g=parseFloat(h);if(!isNaN(g)){const w=this.convertWind(g,e,f),y=w==="N/A"?"N/A":e==="bft"?Math.round(w):w.toFixed(1);l=l.replace(d,`: ${y} ${e}`),console.log(`Updated mean wind speed: ${y} ${e}`)}}s.innerHTML=l}},updateModelRunInfo(t,e,n){const a=document.getElementById("modelLabel"),o=document.getElementById("modelSelect");if(!a||!o){console.warn("Model run info elements missing:",{modelLabel:a,modelSelect:o,lastModelRun:t,lastLat:e,lastLng:n});return}if(!t){console.log("lastModelRun is falsy, setting default model run info:",{lastModelRun:t,lastLat:e,lastLng:n}),a.title=`Model: ${o.value.replace("_"," ").toUpperCase()}
Run: Not available`;return}const r=o.value,s=`Model: ${r.replace("_"," ").toUpperCase()}
Run: ${t}`;a.title=s,console.log(`Updated model run info: ${s}`,{lastModelRun:t,model:r,lastLat:e,lastLng:n})},handleError(t,e="An error occurred. Please try again."){console.error("Settings Error:",t),Utils.handleError(e)},convertHeight(t,e){return isNaN(t)?t:e==="ft"?t*3.28084:t},convertWind(t,e,n){var o,r;return isNaN(t)?"N/A":((r=(o={kt:{"m/s":s=>s*.514444,"km/h":s=>s*1.852,mph:s=>s*1.15078,bft:s=>this.ktToBeaufort(s)},"m/s":{kt:s=>s/.514444,"km/h":s=>s*3.6,mph:s=>s*2.23694,bft:s=>this.ktToBeaufort(s/.514444)}}[n])==null?void 0:o[e])==null?void 0:r.call(o,t))||t},ktToBeaufort(t){return t<1?0:t<=3?1:t<=6?2:t<=10?3:t<=16?4:t<=21?5:t<=27?6:t<=33?7:t<=40?8:t<=47?9:t<=55?10:t<=63?11:12},isFeatureUnlocked(t){return!!this.state.unlockedFeatures[t]}};function la(t){const e=u.state.userSettings.exitAltitude*de.METERS_TO_FEET,n=p.calculateTAS(t,e);if(n==="N/A")return console.warn("TAS calculation failed, using default separation"),u.defaultSettings.jumperSeparation;const a=Object.keys(vi).map(Number).sort((s,l)=>l-s);let o=a[0];for(const s of a)if(n<=s)o=s;else break;return vi[o]||7}function Br(t,e,n,a,o,r,s){if(!t||!t.time||!a||a.length===0||!Number.isFinite(o)||!Number.isFinite(r)||!Number.isFinite(s))return null;const l=s+e,c=s+n-qe,d=Dt(a),m=d?d.direction:0,h=u.state.userSettings.aircraftSpeedKt,f=e/.3048,g=p.calculateTAS(h,f);let w=g==="N/A"?h*de.KNOTS_TO_MPS:g*de.KNOTS_TO_MPS;const y=Math.cos(m*Math.PI/180)*w,v=Math.sin(m*Math.PI/180)*w,b=a.map(I=>I.height),S=a.map(I=>Number.isFinite(I.dir)?parseFloat(I.dir):0),E=a.map(I=>p.convertWind(parseFloat(I.spd)||0,"m/s","km/h")),M=a.map(I=>I.temp),k=[{time:0,height:l,vz:0,vxGround:y,vyGround:v,x:0,y:0}],_=t.surface_pressure[0]||1013.25;let C=k[0];for(;C.height>c;){const I=p.linearInterpolate(b,S,C.height),x=p.linearInterpolate(b,E,C.height),$=p.linearInterpolate(b,M,C.height)+de.CELSIUS_TO_KELVIN,V=Et.GAS_CONSTANT_AIR,F=.5,B=_*100*Math.exp(-9.80665*(C.height-s)/(V*$))/(V*$),Z=(I+180)%360,X=x*Math.cos(Z*Math.PI/180),ce=x*Math.sin(Z*Math.PI/180),Q=C.vxGround-X,lt=C.vyGround-ce,fe=Math.sqrt(Q*Q+lt*lt),Oe=1,Lt=On.DEFAULT_AREA_VERTICAL,ct=On.DEFAULT_MASS_KG,W=On.DEFAULT_DRAG_COEFFICIENT,nn=On.DEFAULT_AREA_HORIZONTAL,Ue=.5*Oe*Lt*B/ct,ye=.5*W*nn*B/ct,ee=-9.80665-Ue*C.vz*Math.abs(C.vz),be=-ye*fe*Q,Se=-ye*fe*lt;let Je=C.height+C.vz*F,Ce=C.vz+ee*F,we=C.time+F;if(Je<=c){const ut=(C.height-c)/(C.height-Je);we=C.time+F*ut,Je=c,Ce=C.vz+ee*F*ut}const Ee={time:we,height:Je,vz:Ce,vxGround:y===0?X:C.vxGround+be*F,vyGround:v===0?ce:C.vyGround+Se*F,x:C.x+(y===0?X:C.vxGround)*F,y:C.y+(v===0?ce:C.vyGround)*F};if(k.push(Ee),C=Ee,Ee.height===c)break}const T=k[k.length-1],D=Math.sqrt(T.x*T.x+T.y*T.y);let P=Math.atan2(T.y,T.x)*180/Math.PI;return P=(P+360)%360,{time:T.time,distance:D,directionDeg:P,path:k.map(I=>({latLng:p.calculateNewCenter(o,r,Math.sqrt(I.x*I.x+I.y*I.y),Math.atan2(I.y,I.x)*180/Math.PI),height:I.height,time:I.time}))}}function Fo(t){var D,P,I,x,R;if(!u.state.userSettings.showExitArea||!u.state.userSettings.calculateJump||!i.weatherData||!i.lastLat||!i.lastLng||!t||t.length===0)return null;const e=parseInt((D=document.getElementById("exitAltitude"))==null?void 0:D.value)||3e3,n=parseInt((P=document.getElementById("openingAltitude"))==null?void 0:P.value)||1200,a=parseInt((I=document.getElementById("legHeightDownwind"))==null?void 0:I.value)||300,o=parseFloat((x=document.getElementById("descentRate"))==null?void 0:x.value)||3.5,r=(parseFloat((R=document.getElementById("canopySpeed"))==null?void 0:R.value)||20)*de.KNOTS_TO_MPS,s=t.map($=>$.height),l=t.map($=>-p.convertWind($.spd,"m/s","km/h")*Math.sin($.dir*Math.PI/180)),c=t.map($=>-p.convertWind($.spd,"m/s","km/h")*Math.cos($.dir*Math.PI/180)),d=Math.round(i.lastAltitude),m=(n-qe-a)/o,h=m*r,f=(n-qe)/o,g=f*r,w=p.calculateMeanWind(s,l,c,d+a,d+n-qe),y=p.calculateMeanWind(s,l,c,d,d+n-qe),v=zr(i.lastLat,i.lastLng,t);let{downwindLat:b,downwindLng:S}=v;Number.isFinite(b)||(b=i.lastLat,S=i.lastLng);const E=p.calculateNewCenter(b,S,w[1]*m,w[0]),M=p.calculateNewCenter(i.lastLat,i.lastLng,y[1]*f,y[0]),k=Br(i.weatherData,e,n,t,i.lastLat,i.lastLng,d);if(!k)return null;const _=(k.directionDeg+180)%360,C=p.calculateNewCenter(M[0],M[1],k.distance,_),T=p.calculateNewCenter(E[0],E[1],k.distance,_);return{greenLat:C[0],greenLng:C[1],darkGreenLat:T[0],darkGreenLng:T[1],greenRadius:g,darkGreenRadius:h,freeFallDirection:k.directionDeg,freeFallDistance:k.distance,freeFallTime:k.time}}function en(t){if(!i.map||i.cutAwayLat===null||i.cutAwayLng===null||!i.weatherData||i.lastAltitude==="N/A"||!t||t.length===0)return null;const e=Math.round(i.lastAltitude),n=u.state.userSettings.cutAwayAltitude,a=e,o=e+n,r=t.map(M=>M.height),s=t.map(M=>-p.convertWind(M.spd,"m/s","km/h")*Math.sin(M.dir*Math.PI/180)),l=t.map(M=>-p.convertWind(M.spd,"m/s","km/h")*Math.cos(M.dir*Math.PI/180)),c=p.calculateMeanWind(r,s,l,a,o);if(!c)return null;const[d,m]=c,h={Open:za.OPEN,Partially:za.PARTIALLY,Collapsed:za.COLLAPSED},f=h[u.state.userSettings.cutAwayState]||h.Partially,g=n/f,w=m*g,y=(d+180)%360,[v,b]=p.calculateNewCenter(i.cutAwayLat,i.cutAwayLng,w,y),E=`<b>Cut-Away (${u.state.userSettings.cutAwayState.replace(/([A-Z])/g," $1").trim()})</b><br>Cut-Away Altitude: ${n} m<br>Displacement: ${d.toFixed(0)}°, ${w.toFixed(0)} m<br>Descent Time/Speed: ${g.toFixed(0)} s at ${f.toFixed(1)} m/s<br>`;return{center:[v,b],radius:Mc,tooltipContent:E}}function Wr(t){var I,x,R,$,V;if(!u.state.userSettings.showCanopyArea||!u.state.userSettings.calculateJump||!i.weatherData||!i.lastLat||!i.lastLng||!t||t.length===0)return null;const e=parseInt((I=document.getElementById("exitAltitude"))==null?void 0:I.value)||3e3,n=parseInt((x=document.getElementById("openingAltitude"))==null?void 0:x.value)||1200,a=parseInt((R=document.getElementById("legHeightDownwind"))==null?void 0:R.value)||300,o=parseFloat(($=document.getElementById("descentRate"))==null?void 0:$.value)||3.5,r=(parseFloat((V=document.getElementById("canopySpeed"))==null?void 0:V.value)||20)*de.KNOTS_TO_MPS,s=t.map(F=>F.height),l=t.map(F=>-p.convertWind(F.spd,"m/s","km/h")*Math.sin(F.dir*Math.PI/180)),c=t.map(F=>-p.convertWind(F.spd,"m/s","km/h")*Math.cos(F.dir*Math.PI/180)),d=Math.round(i.lastAltitude),m=(n-qe-a)/o,h=m*r,f=(n-qe)/o,g=f*r,w=p.calculateMeanWind(s,l,c,d+a,d+n-qe),y=p.calculateMeanWind(s,l,c,d,d+n-qe),v=Br(i.weatherData,e,n,t,i.lastLat,i.lastLng,d);if(!v)return null;const b=zr(i.lastLat,i.lastLng,t);let{downwindLat:S,downwindLng:E}=b;Number.isFinite(S)||(S=i.lastLat,E=i.lastLng);const M=d+n-qe,k=d+a,_=[],C=[],T=[],D=[];let P=M-k<=1e3?200:500;for(let F=M;F>=k+200;F-=P){const B=(F-k)/o,Z=B*r;if(Z>0){const X=p.calculateMeanWind(s,l,c,k,F);_.push(Z),C.push(X[1]*B),T.push(X[0]),D.push(F-d)}}return{blueLat:S,blueLng:E,redLat:i.lastLat,redLng:i.lastLng,radius:h,radiusFull:g,additionalBlueRadii:_,additionalBlueDisplacements:C,additionalBlueDirections:T,additionalBlueUpperLimits:D,displacement:w[1]*m,direction:w[0],displacementFull:y[1]*f,directionFull:y[0],meanWindForFullCanopyDir:y[0],meanWindForFullCanopySpeedMps:y[1],freeFallDirection:v.directionDeg,freeFallDistance:v.distance,freeFallTime:v.time}}function Dt(t){var P,I;if(!i.weatherData||!i.lastLat||!i.lastLng||i.lastAltitude==="N/A"||!t||t.length===0)return null;const e=parseInt((P=document.getElementById("openingAltitude"))==null?void 0:P.value)||1e3,n=Math.round(i.lastAltitude),a=t.map(x=>x.height),o=t.map(x=>-p.convertWind(x.spd,"m/s","km/h")*Math.sin(x.dir*Math.PI/180)),r=t.map(x=>-p.convertWind(x.spd,"m/s","km/h")*Math.cos(x.dir*Math.PI/180)),s=p.calculateMeanWind(a,o,r,n,n+e);if(!s)return null;let l=Math.round(s[0]);const c=parseFloat(u.state.userSettings.customJumpRunDirection);Number.isFinite(c)&&c>=0&&c<=359&&(l=c);const d=parseInt((I=document.getElementById("exitAltitude"))==null?void 0:I.value)||3e3,m=n+d,h=p.calculateTAS(u.state.userSettings.aircraftSpeedKt||90,m/.3048);let f=null,g=2e3,w=2e3,y=null;if(h!=="N/A"&&Number.isFinite(h)){const x=p.linearInterpolate(a.map(Q=>Q-n),t.map(Q=>Q.dir),d),R=p.linearInterpolate(a.map(Q=>Q-n),t.map(Q=>p.convertWind(Q.spd,"m/s","km/h")),d),$=h*de.KNOTS_TO_MPS,V=(x+180)*Math.PI/180,F=R*Math.sin(V),B=R*Math.cos(V),Z=l*Math.PI/180,X=$*Math.sin(Z),ce=$*Math.cos(Z);f=Math.sqrt(Math.pow(X+F,2)+Math.pow(ce+B,2)),g=Math.max(Pt.MIN_TRACK_LENGTH_M,Math.min(Pt.MAX_TRACK_LENGTH_M,Math.round((u.state.userSettings.numberOfJumpers||10)*(u.state.userSettings.jumperSeparation||5)*f))),w=Math.max(Pt.MIN_APPROACH_LENGTH_M,Math.min(Pt.MAX_APPROACH_LENGTH_M,Math.round(f*Pt.APPROACH_TIME_SECONDS)))}const v=u.state.userSettings.jumpRunTrackOffset||0,b=u.state.userSettings.jumpRunTrackForwardOffset||0,S=(Math.atan2(v,b)*180/Math.PI+360)%360,E=Math.sqrt(v**2+b**2),M=(l+S+360)%360,[k,_]=p.calculateNewCenter(i.lastLat,i.lastLng,E,M),C=g/2,T=p.calculateNewCenter(k,_,C,(l+180)%360),D=p.calculateNewCenter(k,_,C,l);if(f){const x=p.calculateNewCenter(T[0],T[1],w,(l+180)%360);y=[T,x]}return{direction:l,trackLength:g,meanWindDirection:s[0],meanWindSpeed:s[1],latlngs:[T,D],approachLatLngs:y,approachLength:w,approachTime:Pt.APPROACH_TIME_SECONDS}}function zr(t,e,n){var I,x;if(!n||n.length===0)return{downwindLat:t,downwindLng:e};const a=parseInt(document.getElementById("canopySpeed").value)||20,o=parseFloat(document.getElementById("descentRate").value)||3.5,r=parseInt(document.getElementById("legHeightFinal").value)||100,s=parseInt(document.getElementById("legHeightBase").value)||200,l=parseInt(document.getElementById("legHeightDownwind").value)||300,c=Math.round(i.lastAltitude),d=n.map(R=>R.height),m=n.map(R=>-p.convertWind(R.spd,"kt","km/h")*Math.sin(R.dir*Math.PI/180)),h=n.map(R=>-p.convertWind(R.spd,"kt","km/h")*Math.cos(R.dir*Math.PI/180)),f=((I=document.querySelector('input[name="landingDirection"]:checked'))==null?void 0:I.value)||"LL",g=parseInt((x=document.getElementById(f==="LL"?"customLandingDirectionLL":"customLandingDirectionRR"))==null?void 0:x.value,10);let w=Number.isFinite(g)?g:Number.isFinite(i.landingWindDir)?i.landingWindDir:n[0].dir;const y=(R,$,V,F,B)=>{const X=F*de.KNOTS_TO_MPS*B,[ce,Q]=p.calculateNewCenter(R,$,X,V);return[ce,Q]},v=p.calculateMeanWind(d,m,h,c,c+r),b=(w+180)%360,S=p.calculateGroundSpeed(a,p.calculateWindComponents(v[1],p.calculateWindAngle(b,v[0])).headwind),E=y(t,e,b,S,r/o),M=p.calculateMeanWind(d,m,h,c+r,c+s),k=(w+(f==="LL"?90:-90)+360)%360,_=p.calculateCourseFromHeading(k,M[0],M[1],a),C=y(E[0],E[1],(_.trueCourse+180)%360,_.groundSpeed,(s-r)/o),T=p.calculateMeanWind(d,m,h,c+s,c+l),D=p.calculateGroundSpeed(a,p.calculateWindComponents(T[1],p.calculateWindAngle(w,T[0])).headwind),P=y(C[0],C[1],w,D,(l-s)/o);return{downwindLat:P[0],downwindLng:P[1]}}async function Me(t,e,n=null){console.log("[weatherManager] Starting full weather fetch for location:",{lat:t,lng:e});const a=await Sc(t,e);return document.dispatchEvent(new CustomEvent("models:available",{detail:{availableModels:a}})),await bc(t,e,n)}async function bc(t,e,n=null){var o,r;const a=document.getElementById("loading");a&&(a.style.display="block");try{const s=((o=document.getElementById("modelSelect"))==null?void 0:o.value)||u.defaultSettings.model;if(!s)throw new Error("No weather model selected.");const c=Hr.API_MAP[s]||s;let d=!1,m,h;const f=N.utc().startOf("day");let g=null;if(n){let E=N.fromISO(n,{zone:"utc"});E.isValid&&(g=E.startOf("day"),g<f&&(d=!0))}else{const E=(r=document.getElementById("historicalDatePicker"))==null?void 0:r.value;if(E){let M=N.fromISO(E,{zone:"utc"}).startOf("day");M<f&&(d=!0,g=M)}}let w=Sn.FORECAST;if(d&&g)w=Sn.HISTORICAL,m=h=g.toFormat("yyyy-MM-dd"),i.lastModelRun="N/A (Historical Data)";else{let E;try{const _=`https://api.open-meteo.com/data/${c}/static/meta.json`,T=await(await fetch(_)).json();E=new Date(T.last_run_initialisation_time*1e3),i.lastModelRun=E.toISOString().replace("T"," ").substring(0,17)+"Z"}catch{E=N.utc().toJSDate(),i.lastModelRun="N/A"}let M=N.fromJSDate(E).setZone("utc").plus({hours:6});M>N.utc()&&(M=N.utc()),m=M.toFormat("yyyy-MM-dd");const k=s.includes("_d2")?2:7;h=M.plus({days:k}).toFormat("yyyy-MM-dd")}const v=`${w}?latitude=${t}&longitude=${e}&hourly=surface_pressure,temperature_2m,relative_humidity_2m,wind_speed_10m,wind_direction_10m,wind_gusts_10m,temperature_1000hPa,relative_humidity_1000hPa,wind_speed_1000hPa,wind_direction_1000hPa,geopotential_height_1000hPa,temperature_950hPa,relative_humidity_950hPa,wind_speed_950hPa,wind_direction_950hPa,geopotential_height_950hPa,temperature_925hPa,relative_humidity_925hPa,wind_speed_925hPa,wind_direction_925hPa,geopotential_height_925hPa,temperature_900hPa,relative_humidity_900hPa,wind_speed_900hPa,wind_direction_900hPa,geopotential_height_900hPa,temperature_850hPa,relative_humidity_850hPa,wind_speed_850hPa,wind_direction_850hPa,geopotential_height_850hPa,temperature_800hPa,relative_humidity_800hPa,wind_speed_800hPa,wind_direction_800hPa,geopotential_height_800hPa,temperature_700hPa,relative_humidity_700hPa,wind_speed_700hPa,wind_direction_700hPa,geopotential_height_700hPa,temperature_600hPa,relative_humidity_600hPa,wind_speed_600hPa,wind_direction_600hPa,geopotential_height_600hPa,temperature_500hPa,relative_humidity_500hPa,wind_speed_500hPa,wind_direction_500hPa,geopotential_height_500hPa,temperature_400hPa,relative_humidity_400hPa,wind_speed_400hPa,wind_direction_400hPa,geopotential_height_400hPa,temperature_300hPa,relative_humidity_300hPa,wind_speed_300hPa,wind_direction_300hPa,geopotential_height_300hPa,temperature_250hPa,relative_humidity_250hPa,wind_speed_250hPa,wind_direction_250hPa,geopotential_height_250hPa,temperature_200hPa,relative_humidity_200hPa,wind_speed_200hPa,wind_direction_200hPa,geopotential_height_200hPa&models=${s}&start_date=${m}&end_date=${h}`,b=await fetch(v);if(!b.ok)throw b.status===429?new Error("API-Limit erreicht. Bitte warten Sie einen Moment und versuchen Sie es erneut."):new Error(`HTTP error! Status: ${b.status}`);const S=await b.json();if(!S.hourly||!S.hourly.time||!S.hourly.time.length)throw new Error("No hourly data in API response.");return S.hourly}catch(s){return console.error("[fetchWeather] Error:",s),displayError(`Failed to fetch weather: ${s.message}`),null}finally{a&&(a.style.display="none")}}async function Sc(t,e){const n=Hr.LIST;let a=[];for(const o of n)try{const r=await fetch(`${Sn.FORECAST}?latitude=${t}&longitude=${e}&hourly=temperature_2m&models=${o}`);if(r.ok){const s=await r.json();s.hourly&&s.hourly.temperature_2m&&s.hourly.temperature_2m.some(l=>l!==null)&&a.push(o)}else r.status===429?console.warn(`API-Limit beim Prüfen von Modell '${o}' erreicht.`):console.warn(`Modell '${o}' ist nicht verfügbar (Server-Antwort: ${r.status})`)}catch(r){console.error(`Netzwerkfehler beim Abruf von Modell '${o}':`,r)}return a}function _e(t,e,n,a,o){if(!t||!t.time||e>=t.time.length)return console.warn("No weather data provided or index out of bounds for interpolation"),[];a=Math.round(i.lastAltitude),o=u.getValue("heightUnit","radio","m");const s=vc.filter(T=>{var P;const D=(P=t[`geopotential_height_${T}hPa`])==null?void 0:P[e];return D!=null});if(s.length<2)return console.warn("Insufficient valid pressure level data for interpolation:",s),[];let l=s.map(T=>t[`geopotential_height_${T}hPa`][e]),c=s.map(T=>t[`temperature_${T}hPa`][e]),d=s.map(T=>t[`relative_humidity_${T}hPa`][e]),m=s.map(T=>t[`wind_speed_${T}hPa`][e]),h=s.map(T=>t[`wind_direction_${T}hPa`][e]);const f=t.surface_pressure[e];if(f==null)return console.warn("Surface pressure missing"),[];let g=m.map((T,D)=>-T*Math.sin(h[D]*Math.PI/180)),w=m.map((T,D)=>-T*Math.cos(h[D]*Math.PI/180));const y=Math.max(...s),v=t[`geopotential_height_${y}hPa`][e];if(f>y&&Number.isFinite(v)&&v>a){const T=Math.floor((v-a)/n),D=-t.wind_speed_10m[e]*Math.sin(t.wind_direction_10m[e]*Math.PI/180),P=-t.wind_speed_10m[e]*Math.cos(t.wind_direction_10m[e]*Math.PI/180),I=g[s.indexOf(y)],x=w[s.indexOf(y)];for(let R=T-1;R>=1;R--){const $=a+R*n;if($>=v)continue;const V=($-a)/(v-a),F=Math.log(f),B=Math.log(y),Z=F+V*(B-F),X=Math.exp(Z),ce=Math.log($-a+1),Q=Math.log(1),lt=Math.log(v-a),fe=p.linearInterpolate([Q,lt],[D,I],ce),Oe=p.linearInterpolate([Q,lt],[P,x],ce),Lt=p.windSpeed(fe,Oe),ct=p.windDirection(fe,Oe);l.unshift($),s.unshift(X),c.unshift(p.linearInterpolate([a,v],[t.temperature_2m[e],t[`temperature_${y}hPa`][e]],$)),d.unshift(p.linearInterpolate([a,v],[t.relative_humidity_2m[e],t[`relative_humidity_${y}hPa`][e]],$)),m.unshift(Lt),h.unshift(ct),g.unshift(fe),w.unshift(Oe)}l.unshift(a),s.unshift(f),c.unshift(t.temperature_2m[e]),d.unshift(t.relative_humidity_2m[e]),m.unshift(t.wind_speed_10m[e]),h.unshift(t.wind_direction_10m[e]),g.unshift(D),w.unshift(P)}const b=s.indexOf(Math.min(...s)),S=l[b],E=S-a;if(E<=0||isNaN(E))return console.warn("Invalid max height at lowest pressure level:",{maxHeightASL:S,baseHeight:a,minPressure:s[b]}),[];const M=o==="ft"?E*3.28084:E,k=Math.floor(M/n),_=Array.from({length:k+1},(T,D)=>D*n);console.log("Interpolating up to lowest pressure level:",{maxHeightAGL:E,minPressure:s[b],interpStep:n});const C=[];return _.forEach(T=>{const D=o==="ft"?T/3.28084:T,P=a+D;let I;if(D===0)I={height:P,pressure:f,temp:t.temperature_2m[e],rh:t.relative_humidity_2m[e],spd:t.wind_speed_10m[e],dir:t.wind_direction_10m[e],dew:p.calculateDewpoint(t.temperature_2m[e],t.relative_humidity_2m[e])};else{const x=p.interpolatePressure(P,s,l),R=p.interpolateWindAtAltitude(P,s,l,g,w),$=p.windSpeed(R.u,R.v),V=p.windDirection(R.u,R.v),F=p.linearInterpolate(l,c,P),B=p.linearInterpolate(l,d,P),Z=p.calculateDewpoint(F,B);I={height:P,pressure:x==="N/A"?"N/A":Number(x.toFixed(1)),temp:Number(F.toFixed(1)),rh:Number(B.toFixed(0)),spd:Number($.toFixed(1)),dir:Number(V.toFixed(0)),dew:Number(Z.toFixed(1))}}I.displayHeight=T,C.push(I)}),console.log("Interpolated data length:",C.length,"Max height:",C[C.length-1].displayHeight),C}async function ca(){if(!i.lastLat||!i.lastLng)return p.handleMessage("Please select a location first."),!1;if(!u.state.userSettings.selectedEnsembleModels||u.state.userSettings.selectedEnsembleModels.length===0)return i.ensembleModelsData=null,xo(),!0;const t=document.getElementById("loading");t&&(t.style.display="block");try{const e=i.lastLat,n=i.lastLng,a=u.state.userSettings.selectedEnsembleModels,o=a.join(","),r=["surface_pressure","temperature_2m","relative_humidity_2m","wind_speed_10m","wind_direction_10m","geopotential_height_1000hPa","temperature_1000hPa","relative_humidity_1000hPa","wind_speed_1000hPa","wind_direction_1000hPa","geopotential_height_950hPa","temperature_950hPa","relative_humidity_950hPa","wind_speed_950hPa","wind_direction_950hPa","geopotential_height_925hPa","temperature_925hPa","relative_humidity_925hPa","wind_speed_925hPa","wind_direction_925hPa","geopotential_height_900hPa","temperature_900hPa","relative_humidity_900hPa","wind_speed_900hPa","wind_direction_900hPa","geopotential_height_850hPa","temperature_850hPa","relative_humidity_850hPa","wind_speed_850hPa","wind_direction_850hPa","geopotential_height_800hPa","temperature_800hPa","relative_humidity_800hPa","wind_speed_800hPa","wind_direction_800hPa","geopotential_height_700hPa","temperature_700hPa","relative_humidity_700hPa","wind_speed_700hPa","wind_direction_700hPa","geopotential_height_600hPa","temperature_600hPa","relative_humidity_600hPa","wind_speed_600hPa","wind_direction_600hPa","geopotential_height_500hPa","temperature_500hPa","relative_humidity_500hPa","wind_speed_500hPa","wind_direction_500hPa","geopotential_height_400hPa","temperature_400hPa","relative_humidity_400hPa","wind_speed_400hPa","wind_direction_400hPa","geopotential_height_300hPa","temperature_300hPa","relative_humidity_300hPa","wind_speed_300hPa","wind_direction_300hPa","geopotential_height_250hPa","temperature_250hPa","relative_humidity_250hPa","wind_speed_250hPa","wind_direction_250hPa","geopotential_height_200hPa","temperature_200hPa","relative_humidity_200hPa","wind_speed_200hPa","wind_direction_200hPa"],s=r.join(","),l=document.getElementById("historicalDatePicker"),c=l?l.value:null,d=c?N.fromISO(c,{zone:"utc"}):null,m=N.utc().startOf("day"),h=d&&d<m;let f,g,w=Sn.FORECAST;if(h)w=Sn.HISTORICAL,f=d.toFormat("yyyy-MM-dd"),g=f;else{const E=N.utc();f=E.toFormat("yyyy-MM-dd"),g=E.plus({days:7}).toFormat("yyyy-MM-dd")}const y=`${w}?latitude=${e}&longitude=${n}&hourly=${s}&models=${o}&start_date=${f}&end_date=${g}`,v=await fetch(y);if(!v.ok)throw v.status===429?new Error("API-Limit für Ensemble-Daten erreicht. Bitte warten Sie einen Moment."):new Error(`API request failed: ${v.status}`);const b=await v.json();i.ensembleModelsData={};const S=b.hourly.time;return a.forEach(E=>{const M={time:[...S]};let k=!1;r.forEach(_=>{const C=`${_}_${E}`;b.hourly[C]?(M[_]=b.hourly[C],k=!0):M[_]=null}),k&&(i.ensembleModelsData[E]=M)}),!0}catch{return!1}finally{t&&(t.style.display="none")}}function xo(){i.ensembleLayerGroup&&i.map.removeLayer(i.ensembleLayerGroup),i.heatmapLayer&&i.map.removeLayer(i.heatmapLayer),i.heatmapLayer=null,i.ensembleScenarioCircles={},i.ensembleLayerGroup=L.layerGroup().addTo(i.map),console.log("Ensemble visualizations cleared and a new, clean layer group was created.")}function ua(t,e){if(xo(),!i.ensembleModelsData||Object.keys(i.ensembleModelsData).length===0)return;const n=u.state.userSettings.currentEnsembleScenario;if(console.log(`Processing ensemble scenario: ${n} for slider index: ${t}`),n==="heatmap")_c(t,e);else if(n==="all_models"){for(const a in i.ensembleModelsData)if(Object.hasOwnProperty.call(i.ensembleModelsData,a)){const o=i.ensembleModelsData[a],r=ho(a,t,{hourly:o});r&&Si(r,Ec(a),a)}}else{const a=Tc(n);if(a){const o=ho(n,t,a);o&&Si(o,kc(n),n.replace("_"," "))}}}function Ec(t){let e=0;for(let a=0;a<t.length;a++)e=t.charCodeAt(a)+((e<<5)-e),e=e&e;return`hsl(${e%360}, 70%, 60%)`}function kc(t){return t==="min_wind"?ve.SCENARIO_COLORS.MIN_WIND:t==="mean_wind"?ve.SCENARIO_COLORS.MEAN_WIND:t==="max_wind"?ve.SCENARIO_COLORS.MAX_WIND:"rgba(128, 128, 128, 0.7)"}function Si(t,e,n){var y,v;if(!i.map||!t||!i.ensembleLayerGroup)return;const a=[t.centerLat,t.centerLng],o=L.circle(a,{radius:t.radius,color:e,fillColor:e,fillOpacity:.15,weight:2,dashArray:"5, 10"}).addTo(i.ensembleLayerGroup),r=u.getValue("windUnit","radio","kt");let s="N/A";if(t.meanWindSpeedMps!=="N/A"&&Number.isFinite(t.meanWindSpeedMps)){const b=p.convertWind(t.meanWindSpeedMps,r,"m/s");b!=="N/A"&&Number.isFinite(b)&&(s=r==="bft"?Math.round(b):b.toFixed(1))}const l=parseInt((y=document.getElementById("openingAltitude"))==null?void 0:y.value)||u.state.userSettings.openingAltitude||1200,c=parseInt((v=document.getElementById("legHeightDownwind"))==null?void 0:v.value)||u.state.userSettings.legHeightDownwind||0,d=l-200,m=u.getValue("heightUnit","radio","m"),h=Math.round(p.convertHeight(c,m)),f=Math.round(p.convertHeight(d,m)),g=t.meanWindDir!=="N/A"&&Number.isFinite(t.meanWindDir)?p.roundToTens(t.meanWindDir):"N/A",w=`<strong>${n}</strong><br>Mean Wind ${h}-${f} ${m} AGL:<br>${g}° ${s} ${r}`;o.bindTooltip(w,{permanent:!1,direction:"top",className:"wind-tooltip",opacity:.9}),i.ensembleScenarioCircles[n]=o,console.log(`Drew ensemble circle for ${n} at [${a.join(", ")}], radius ${t.radius}`)}function Tc(t,e){var m;if(!i.ensembleModelsData||Object.keys(i.ensembleModelsData).length===0)return console.warn("No ensemble data available for profile calculation."),null;if(Object.keys(i.ensembleModelsData).length===0)return null;console.log(`Calculating full time-series ensemble profile for: ${t}`);const a={},o=Object.keys(i.ensembleModelsData)[0],r=(m=i.ensembleModelsData[o])==null?void 0:m.time;if(!r||r.length===0)return console.error("Time data missing or empty in the first ensemble model for profile calculation."),null;a.time=[...r];const s=a.time.length,l=["surface_pressure","temperature_2m","relative_humidity_2m","geopotential_height_1000hPa","temperature_1000hPa","relative_humidity_1000hPa","geopotential_height_950hPa","temperature_950hPa","relative_humidity_950hPa","geopotential_height_925hPa","temperature_925hPa","relative_humidity_925hPa","geopotential_height_900hPa","temperature_900hPa","relative_humidity_900hPa","geopotential_height_850hPa","temperature_850hPa","relative_humidity_850hPa","geopotential_height_800hPa","temperature_800hPa","relative_humidity_800hPa","geopotential_height_700hPa","temperature_700hPa","relative_humidity_700hPa","geopotential_height_600hPa","temperature_600hPa","relative_humidity_600hPa","geopotential_height_500hPa","temperature_500hPa","relative_humidity_500hPa","geopotential_height_400hPa","temperature_400hPa","relative_humidity_400hPa","geopotential_height_300hPa","temperature_300hPa","relative_humidity_300hPa","geopotential_height_250hPa","temperature_250hPa","relative_humidity_250hPa","geopotential_height_200hPa","temperature_200hPa","relative_humidity_200hPa"],c=[["wind_speed_10m","wind_direction_10m"]];[1e3,950,925,900,850,800,700,600,500,400,300,250,200].forEach(h=>{c.push([`wind_speed_${h}hPa`,`wind_direction_${h}hPa`])}),l.forEach(h=>{a[h]=new Array(s).fill(null)}),c.forEach(h=>{a[h[0]]=new Array(s).fill(null),a[h[1]]=new Array(s).fill(null)});for(let h=0;h<s;h++)l.forEach(f=>{const g=[];for(const w in i.ensembleModelsData){const y=i.ensembleModelsData[w];if(y&&y[f]){const v=y[f][h];v!=null&&!isNaN(v)&&g.push(v)}}g.length>0&&(t==="min_wind"?a[f][h]=Math.min(...g):t==="max_wind"?a[f][h]=Math.max(...g):a[f][h]=g.reduce((w,y)=>w+y,0)/g.length)}),c.forEach(f=>{const g=f[0],w=f[1];let y=[],v=[],b=[],S=[];for(const E in i.ensembleModelsData){const M=i.ensembleModelsData[E];if(M&&M[g]&&M[w]){const k=M[g][h],_=M[w][h];k!=null&&!isNaN(k)&&_!==null&&_!==void 0&&!isNaN(_)&&(b.push(k),S.push(_),y.push(-k*Math.sin(_*Math.PI/180)),v.push(-k*Math.cos(_*Math.PI/180)))}}if(b.length>0)if(t==="min_wind"){const E=Math.min(...b),M=b.indexOf(E);a[g][h]=E,a[w][h]=S[M]}else if(t==="max_wind"){const E=Math.max(...b),M=b.indexOf(E);a[g][h]=E,a[w][h]=S[M]}else{const E=y.reduce((k,_)=>k+_,0)/y.length,M=v.reduce((k,_)=>k+_,0)/v.length;a[g][h]=p.windSpeed(E,M),a[w][h]=p.windDirection(E,M)}});return{hourly:a}}function ho(t,e,n=null){var d,m;if(console.log(`Calculating exit circle for ensemble profile/model: ${t} at index ${e}`),e==null)return console.error("sliderIndex is undefined in calculateExitCircleForEnsemble. Aborting."),null;let a;if(n)a=n;else if(i.ensembleModelsData&&i.ensembleModelsData[t])a={hourly:i.ensembleModelsData[t]};else return console.warn(`No data for profile/model ${t} in calculateExitCircleForEnsemble found.`),null;if(!a.hourly||!i.lastLat||!i.lastLng||i.lastAltitude==="N/A")return console.warn(`Incomplete data for calculateExitCircleForEnsemble: ${t}`),null;const o=Te(),r=u.getValue("heightUnit","radio","m"),s=i.weatherData;i.weatherData=a.hourly;let l=null,c={meanWindDir:"N/A",meanWindSpeedMps:"N/A"};try{const h=u.state.userSettings.calculateJump,f=u.state.userSettings.showExitArea;u.state.userSettings.calculateJump=!0,u.state.userSettings.showExitArea=!0;const g=_e(i.weatherData,e,o,Math.round(i.lastAltitude),r);if(g&&g.length>0){l=Fo(g);const w=g.map(C=>C.height),y=g.map(C=>-p.convertWind(C.spd,"m/s","km/h")*Math.sin(C.dir*Math.PI/180)),v=g.map(C=>-p.convertWind(C.spd,"m/s","km/h")*Math.cos(C.dir*Math.PI/180)),b=parseInt((d=document.getElementById("openingAltitude"))==null?void 0:d.value)||1200,S=parseInt((m=document.getElementById("legHeightDownwind"))==null?void 0:m.value)||0,E=Math.round(i.lastAltitude),M=E+b-200,k=E+S,_=p.calculateMeanWind(w,y,v,k,M);_&&Number.isFinite(_[0])&&Number.isFinite(_[1])&&(c={meanWindDir:_[0],meanWindSpeedMps:_[1]})}u.state.userSettings.calculateJump=h,u.state.userSettings.showExitArea=f}catch(h){console.error(`Error in calculateExitCircle for profile ${t}:`,h),l=null}finally{i.weatherData=s}return l?{centerLat:l.darkGreenLat,centerLng:l.darkGreenLng,radius:l.darkGreenRadius,meanWindDir:c.meanWindDir,meanWindSpeedMps:c.meanWindSpeedMps}:(console.warn(`calculateExitCircle returned null for profile ${t}`),null)}function _c(t,e){if(xo(),i.heatmapLayer&&(i.map.removeLayer(i.heatmapLayer),i.heatmapLayer=null),!i.ensembleModelsData||Object.keys(i.ensembleModelsData).length<2){p.handleMessage("Please select at least two ensemble models to generate a heatmap.");return}const n=[];for(const h in i.ensembleModelsData)if(Object.hasOwnProperty.call(i.ensembleModelsData,h)){i.ensembleModelsData[h];const f=ho(h,t,e);f&&n.push({centerLat:f.centerLat,centerLng:f.centerLng,radius:f.radius})}if(n.length===0){console.warn("Could not calculate any circles for the heatmap.");return}console.log(`[Heatmap] Calculated ${n.length} model circles.`);let a=90,o=-90,r=180,s=-180;const l=111320;n.forEach(h=>{const f=h.radius/l,g=h.radius/(l*Math.cos(h.centerLat*Math.PI/180));a=Math.min(a,h.centerLat-f),o=Math.max(o,h.centerLat+f),r=Math.min(r,h.centerLng-g),s=Math.max(s,h.centerLng+g)});const c=40,d=c/l,m=[];console.log("[Heatmap] Starting grid calculation...");for(let h=a;h<=o;h+=d){const f=c/(l*Math.cos(h*Math.PI/180));for(let g=r;g<=s;g+=f){let w=0;const y=L.latLng(h,g);n.forEach(v=>{const b=L.latLng(v.centerLat,v.centerLng);i.map.distance(y,b)<=v.radius&&w++}),w>0&&m.push([h,g,w])}}if(console.log(`[Heatmap] Finished grid calculation. Generated ${m.length} heatmap points.`),m.length>0){const h=n.length,f={};if(h===1)f[1]="lime";else for(let w=1;w<=h;w++){const y=w/h;w===1?f[y]="red":w<h?f[y]="yellow":f[y]="lime"}console.log("[Heatmap] Using gradient:",f),i.heatmapLayer&&i.map.removeLayer(i.heatmapLayer);const g=p.calculateDynamicRadius(ve.HEATMAP_BASE_RADIUS,ve.HEATMAP_REFERENCE_ZOOM);i.heatmapLayer=L.heatLayer(m,{radius:g,blur:10,max:h,minOpacity:.01,gradient:f}).addTo(i.map)}else p.handleMessage("No overlapping landing areas found for the selected models.")}function Ct(){const t="ontouchstart"in window||navigator.maxTouchPoints>0,e=window.Capacitor&&window.Capacitor.isNativePlatform();return t||e}function Cc(){Ct()&&document.body.classList.add("touch-device")}function ft(t){console.log("displayMessage called with:",t);let e=document.getElementById("message");e||(e=document.createElement("div"),e.id="message",e.style.position="fixed",e.style.top="5px",e.style.right="5px",e.style.width=Ct()?"70%":"30%",e.style.backgroundColor="#ccffcc",e.style.borderRadius="5px 5px 5px 5px",e.style.color="#000000",e.style.padding="6px",e.style.zIndex="9998",e.style.textAlign="center",document.body.appendChild(e),window.addEventListener("resize",()=>{e.style.width=Ct()?"70%":"30%"})),e.textContent=t,e.style.display="block",clearTimeout(window.messageTimeout),window.messageTimeout=setTimeout(()=>{e.style.display="none"},Y.MESSAGE_TIMEOUT_MS)}function En(t,e,n){const a=Math.round(t/e*100);let o=document.getElementById("progress");o||(o=document.createElement("div"),o.id="progress",o.style.position="fixed",o.style.top="5px",o.style.right="5px",o.style.width=Ct()?"70%":"30%",o.style.backgroundColor="#ccffcc",o.style.borderRadius="5px 5px 5px 5px",o.style.color="#000000",o.style.padding="6px",o.style.zIndex="9998",o.style.display="flex",o.style.alignItems="center",o.style.gap="10px",document.body.appendChild(o),window.addEventListener("resize",()=>{o.style.width=Ct()?"70%":"30%"}));const r=document.createElement("div");r.style.flex="1",r.style.display="flex",r.style.flexDirection="column",r.style.gap="3px";const s=document.createElement("div");s.textContent=`Caching (${t}/${e}, ${a}%)`,s.style.fontSize="12px",s.style.textAlign="center";const l=document.createElement("div");l.style.width="100%",l.style.height="8px",l.style.backgroundColor="#e0e0e0",l.style.borderRadius="3px",l.style.overflow="hidden";const c=document.createElement("div");c.style.width=`${a}%`,c.style.height="100%",c.style.backgroundColor="#4caf50",c.style.transition="width 0.3s ease-in-out",l.appendChild(c),r.appendChild(s),r.appendChild(l);let d=document.getElementById("cancel-caching");d||(d=document.createElement("button"),d.id="cancel-caching",d.textContent="Cancel",d.style.backgroundColor="#ff4444",d.style.color="#ffffff",d.style.border="none",d.style.borderRadius="3px",d.style.padding="5px 3px",d.style.cursor="pointer",d.style.fontSize="12px",d.addEventListener("click",()=>{n(),o.style.display="none",p.handleMessage("Caching cancelled.")})),o.innerHTML="",o.appendChild(r),o.appendChild(d),o.style.display="flex"}function Ke(){const t=document.getElementById("progress");t&&(t.style.display="none")}function po(){console.log("updateOfflineIndicator called, navigator.onLine:",navigator.onLine);let t=document.getElementById("offline-indicator");t||(t=document.createElement("div"),t.id="offline-indicator",document.body.appendChild(t),console.log("Offline indicator created and appended")),t.style.display=navigator.onLine?"none":"block",t.textContent="Offline Mode"}function Xn(t){console.log("displayError called with:",t);let e=document.getElementById("error-message");e||(e=document.createElement("div"),e.id="error-message",document.body.appendChild(e),window.addEventListener("resize",()=>{e.style.width=Ct()?"70%":"30%"})),e.textContent=t,e.style.display="block",console.log("Error element state:",{display:e.style.display,text:e.textContent,position:e.style.position,zIndex:e.style.zIndex}),clearTimeout(window.errorTimeout),window.errorTimeout=setTimeout(()=>{e.style.display="none",console.log("Error hidden after 3s")},Y.MESSAGE_TIMEOUT_MS)}function me(){var t;return parseInt((t=document.getElementById("timeSlider"))==null?void 0:t.value)||0}function Ac(t){const e=document.getElementById("modelSelect");if(!e)return;const n=e.value;e.innerHTML="",t.forEach(a=>{const o=document.createElement("option");o.value=a,o.textContent=a.replace(/_/g," ").toUpperCase(),e.appendChild(o)}),t.includes(u.state.userSettings.model)?e.value=u.state.userSettings.model:t.includes(n)?e.value=n:t.length>0&&(e.value=t[0])}function Ic(t){let e=u.state.userSettings.selectedEnsembleModels||[],n=e.filter(a=>t.includes(a));e.length!==n.length&&(u.state.userSettings.selectedEnsembleModels=n,u.save())}const oe={dbName:"SkydivingTileCache",storeName:"tiles",db:null,async init(){return new Promise((t,e)=>{const n=indexedDB.open(this.dbName,1);n.onupgradeneeded=a=>{a.target.result.createObjectStore(this.storeName,{keyPath:"url"})},n.onsuccess=a=>{this.db=a.target.result,t()},n.onerror=a=>{console.error("IndexedDB initialization failed:",a),e(a)}})},async storeTile(t,e){return this.db||await this.init(),new Promise((n,a)=>{const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).put({url:t,blob:e,timestamp:Date.now()});s.onsuccess=()=>{console.log(`Stored tile: ${t}`),n(!0)},s.onerror=l=>{console.warn(`Failed to store tile: ${t}`,l),p.handleError("Failed to store some tiles. Try clearing cache."),a(l)}})},async getTile(t){return this.db||await this.init(),new Promise((e,n)=>{const o=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName),r=o.get(t);r.onsuccess=s=>{const l=s.target.result;if(l)e(l.blob);else{const c=[t.replace("https://tile.opentopomap.org","https://a.tile.opentopomap.org"),t.replace("https://tile.opentopomap.org","https://b.tile.opentopomap.org"),t.replace("https://tile.opentopomap.org","https://c.tile.opentopomap.org"),t.replace("https://tile.openstreetmap.org","https://a.tile.openstreetmap.org"),t.replace("https://tile.openstreetmap.org","https://b.tile.openstreetmap.org"),t.replace("https://tile.openstreetmap.org","https://c.tile.openstreetmap.org"),t.replace("https://basemaps.cartocdn.com","https://a.basemaps.cartocdn.com"),t.replace("https://basemaps.cartocdn.com","https://b.basemaps.cartocdn.com"),t.replace("https://basemaps.cartocdn.com","https://c.basemaps.cartocdn.com"),t.replace("https://basemaps.cartocdn.com","https://d.basemaps.cartocdn.com")];let d=null;for(const m of c){if(m===t)continue;const h=o.get(m);h.onsuccess=f=>{const g=f.target.result;g&&(d=g.blob,e(d))},h.onerror=()=>{}}setTimeout(()=>{d||e(null)},100)}},r.onerror=s=>{console.warn(`Failed to retrieve tile: ${t}`,s),n(s)}})},async clearCache(){return this.db||await this.init(),new Promise((t,e)=>{const o=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();o.onsuccess=()=>{console.log("Tile cache cleared"),t()},o.onerror=r=>{console.error("Failed to clear cache:",r),e(r)}})},async clearOldTiles(t=sa.MAX_AGE_DAYS){this.db||await this.init();const e=t*24*60*60*1e3;return new Promise((n,a)=>{const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).openCursor();let l=0,c=0;s.onsuccess=d=>{const m=d.target.result;if(m)Date.now()-m.value.timestamp>e&&(c+=m.value.blob.size||0,m.delete(),l++),m.continue();else{const h=c/1048576;console.log(`Cleared ${l} old tiles, freed ${h.toFixed(2)} MB`),n({deletedCount:l,deletedSizeMB:h})}},s.onerror=d=>{console.error("Failed to clear old tiles:",d),a(d)}})},async getCacheSize(){return this.db||await this.init(),new Promise((t,e)=>{const o=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).openCursor();let r=0,s=0;o.onsuccess=l=>{var d;const c=l.target.result;if(c)try{const m=((d=c.value.blob)==null?void 0:d.size)||0;typeof m!="number"||isNaN(m)?console.warn(`Invalid blob size for tile: ${c.value.url}, size: ${m}`):(r+=m,s++),c.continue()}catch(m){console.warn(`Error processing tile during size calculation: ${c.value.url}`,m),c.continue()}else{const m=r/1048576;console.log(`Cache size calculation completed: ${m.toFixed(2)} MB, ${s} tiles`),t(m)}},o.onerror=l=>{console.error("Failed to calculate cache size:",l),e(l)}})},async migrateTiles(){return this.db||await this.init(),new Promise((t,e)=>{const a=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName),o=a.openCursor();let r=0;o.onsuccess=s=>{const l=s.target.result;if(l){const{url:c,blob:d,timestamp:m}=l.value,h=c.replace(/^(https?:\/\/[a-c]\.tile\.openstreetmap\.org)/,"https://tile.openstreetmap.org").replace(/^(https?:\/\/[a-d]\.basemaps\.cartocdn\.com)/,"https://basemaps.cartocdn.com").replace(/^(https?:\/\/[a-c]\.tile\.opentopomap\.org)/,"https://tile.opentopomap.org");c!==h&&(l.delete(),a.put({url:h,blob:d,timestamp:m}),r++),l.continue()}else console.log(`Migrated ${r} tiles to normalized URLs`),t()},o.onerror=s=>{console.error("Failed to migrate tiles:",s),e(s)}})}};L.TileLayer.Cached=L.TileLayer.extend({createTile(t,e){const n=document.createElement("img");L.DomEvent.on(n,"load",()=>{console.log("Tile loaded:",this.getTileUrl(t)),e(null,n)}),L.DomEvent.on(n,"error",()=>{console.warn("Tile error:",this.getTileUrl(t)),e(new Error("Failed to load tile"),n)});const a=this.getTileUrl(t);n.setAttribute("role","presentation");const o=a.replace(/^(https?:\/\/[a-c]\.tile\.openstreetmap\.org)/,"https://tile.openstreetmap.org").replace(/^(https?:\/\/[a-d]\.basemaps\.cartocdn\.com)/,"https://basemaps.cartocdn.com").replace(/^(https?:\/\/[a-c]\.tile\.opentopomap\.org)/,"https://tile.opentopomap.org");return!navigator.onLine&&(t.z<11||t.z>14)?(console.log(`Skipping tile request outside cached zoom levels (11–14): ${a}`),p.handleError("Offline: Zoom restricted to levels 11–14 for cached tiles."),e(new Error("Zoom level not cached"),n),n):(navigator.onLine?(n.src=a,fetch(a,{signal:AbortSignal.timeout(sa.FETCH_TIMEOUT_MS)}).then(r=>{if(!r.ok)throw new Error(`HTTP ${r.status}`);return r.blob()}).then(r=>{oe.storeTile(o,r).catch(s=>console.warn("Failed to cache tile during rendering:",o,s))}).catch(r=>{console.warn("Fetch error for tile during rendering:",a,r),oe.getTile(o).then(s=>{s?(n.src=URL.createObjectURL(s),console.log(`Tile loaded from cache (fallback): ${o}`)):e(r,n)}).catch(s=>{console.warn("Cache fallback error:",o,s),e(s,n)})})):oe.getTile(o).then(r=>{r?(n.src=URL.createObjectURL(r),console.log(`Tile loaded from cache: ${o}`)):(console.warn(`Tile not in cache: ${o}`),p.handleError("This area is not cached. Please cache more tiles while online."),e(new Error("Tile not in cache"),n))}).catch(r=>{console.warn("Cache error for offline tile:",o,r),p.handleError("This area is not cached. Please cache more tiles while online."),e(r,n)}),n)}});L.tileLayer.cached=function(t,e){return new L.TileLayer.Cached(t,e)};function Dc(t,e,n,a,o){if(!o)return console.warn("Map not initialized, cannot calculate tiles"),[];const r=new Set,s=40075016686e-3,l=n*1e3;return a.forEach(c=>{const d=o.project([t,e],c),m=256,h=d.x/m,f=d.y/m,g=t*Math.PI/180,w=s*Math.cos(g)/(m*Math.pow(2,c)),y=Math.ceil(l/(w*m))+1,v=Math.pow(2,c);for(let b=Math.floor(h-y);b<=Math.ceil(h+y);b++)for(let S=Math.floor(f-y);S<=Math.ceil(f+y);S++)b>=0&&b<v&&S>=0&&S<v&&r.add(`${c}/${b}/${S}`)}),Array.from(r).map(c=>{const[d,m,h]=c.split("/").map(Number);return{zoom:d,x:m,y:h}})}async function Nc(t,e=3){let n=null;for(let a=1;a<=e;a++){try{const o=new AbortController,r=setTimeout(()=>o.abort(),sa.FETCH_TIMEOUT_MS),s=await fetch(t,{signal:o.signal});if(clearTimeout(r),s.ok)return{success:!0,blob:await s.blob()};console.warn(`Attempt ${a} failed for ${t}: HTTP ${s.status}`),n=new Error(`HTTP ${s.status}`)}catch(o){console.warn(`Attempt ${a} error for ${t}: ${o.message}`),n=o,o.name==="AbortError"&&console.warn(`Fetch timeout after 15s for ${t}`)}a<e&&await new Promise(o=>setTimeout(o,1e3))}return{success:!1,error:n}}async function da({map:t,lastLat:e,lastLng:n,baseMaps:a,onProgress:o,onComplete:r,onCancel:s}){if(!t){r&&r("Map not initialized, cannot cache tiles.");return}if(!e||!n){r&&r("Please select a location to cache map tiles.");return}const l=u.state.userSettings.cacheRadiusKm||u.defaultSettings.cacheRadiusKm,c=u.state.userSettings.cacheZoomLevels||u.defaultSettings.cacheZoomLevels,d=Dc(e,n,l,c,t),m=[];if(u.state.userSettings.baseMaps==="Esri Satellite + OSM")m.push({name:"Esri Satellite",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",normalizedUrl:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"},{name:"OSM Overlay",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",subdomains:["a","b","c"],normalizedUrl:"https://tile.openstreetmap.org/{z}/{x}/{y}.png"});else{const v=a[u.state.userSettings.baseMaps];v&&m.push({name:u.state.userSettings.baseMaps,url:v.options.url||v._url,subdomains:v.options.subdomains,normalizedUrl:(v.options.url||v._url).replace(/{s}\./,"")})}const h=d.length*m.length;if(h===0){r&&r("No tiles to cache for this basemap.");return}let f=0,g=0;const w=[];i.isCachingCancelled=!1,console.log("Calling displayProgress with initial values:",{cachedCount:f,failedCount:g,totalTiles:h}),o&&o(0,h,()=>{i.isCachingCancelled=!0,s&&s()});try{for(const v of m){if(console.log("Processing layer:",v.name),i.isCachingCancelled){console.log("Caching cancelled by user");break}const b=d.map(async(S,E)=>{if(i.isCachingCancelled){console.log("Caching cancelled during tile processing");return}const M=v.url.replace("{z}",S.zoom).replace("{x}",S.x).replace("{y}",S.y).replace("{s}",v.subdomains?v.subdomains[Math.floor(Math.random()*v.subdomains.length)]:""),k=v.normalizedUrl.replace("{z}",S.zoom).replace("{x}",S.x).replace("{y}",S.y);if(console.log(`Processing tile ${E+1}/${d.length} for layer ${v.name}:`,{url:M,normalizedUrl:k}),await oe.getTile(k).catch(T=>(console.error(`Error retrieving tile from cache: ${k}`,T),null)))f++,console.log(`Tile ${E+1} already in cache`);else{const T=await Nc(M);T.success?await oe.storeTile(k,T.blob).catch(P=>(console.error(`Error storing tile: ${k}`,P),!1))?(f++,console.log(`Tile ${E+1} cached successfully`)):(g++,w.push(M),console.log(`Tile ${E+1} failed to store`)):(g++,w.push(M),console.log(`Tile ${E+1} failed to fetch:`,T.error.message))}const C=f+g;((E+1)%10===0||E===d.length-1)&&(console.log("Updating progress:",{currentCount:C,totalTiles:h}),o&&o(C,h,()=>{i.isCachingCancelled=!0}))});console.log(`Processing batch of ${d.length} tiles for layer ${v.name}`);for(let S=0;S<b.length;S+=20){if(i.isCachingCancelled){console.log("Caching cancelled during batch processing");break}const E=b.slice(S,S+20);await Promise.all(E).catch(M=>{console.error("Error processing batch of tiles:",M)}),console.log(`Completed batch ${S/20+1} for layer ${v.name}`)}}}catch(v){console.error("Unexpected error in cacheTilesForDIP:",v),p.handleError("Failed to cache map tiles: "+v.message)}finally{if(console.log("Hiding progress bar"),r){let v="";i.isCachingCancelled?v=`Caching cancelled: ${f} tiles cached, ${g} failed.`:g>0?v=`Cached ${f} tiles around DIP (${g} failed).`:v=`Cached ${f} tiles around DIP successfully.`,r(v)}}w.length>0&&console.warn(`Failed to cache ${w.length} tiles:`,w),console.log(`DIP caching complete: ${f} tiles cached, ${g} failed`);let y="";i.isCachingCancelled?y=`Caching cancelled: ${f} tiles cached, ${g} failed.`:g>0?y=`Cached ${f} tiles around DIP (${g} failed).`:y=`Cached ${f} tiles around DIP successfully.`,r&&r(y);try{const v=await oe.getCacheSize();console.log(`Cache size after DIP caching: ${v.toFixed(2)} MB`),v>sa.SIZE_LIMIT_MB_WARNING&&p.handleError(`Cache size large (${v.toFixed(2)} MB). Consider clearing cache to free up space.`)}catch(v){console.error("Failed to check cache size after DIP caching:",v),p.handleError("Unable to check cache size. Consider clearing cache to free up space.")}}async function tn({map:t,baseMaps:e,onProgress:n,onComplete:a,onCancel:o}){if(!t||!navigator.onLine){console.log("Skipping visible tile caching: offline or map not initialized");return}const r=t.getBounds(),s=t.getZoom(),l=u.state.userSettings.cacheZoomLevels||u.defaultSettings.cacheZoomLevels;if(!l.includes(s)){console.log(`Skipping caching: zoom ${s} not in cacheZoomLevels`,l);return}const c=256,d=t.project(r.getSouthWest(),s),m=t.project(r.getNorthEast(),s),h=Math.floor(d.x/c),f=Math.floor(m.x/c),g=Math.floor(m.y/c),w=Math.floor(d.y/c),y=[];for(let M=h;M<=f;M++)for(let k=g;k<=w;k++){const _=2**s;M>=0&&M<_&&k>=0&&k<_&&y.push({zoom:s,x:M,y:k})}console.log(`Caching ${y.length} visible tiles at zoom ${s} for ${u.state.userSettings.baseMaps}`);const v=[];if(!e[u.state.userSettings.baseMaps]){console.warn(`Base map ${u.state.userSettings.baseMaps} not found, skipping caching`),a&&a("Selected base map not available for caching.");return}if(u.state.userSettings.baseMaps==="Esri Satellite + OSM")v.push({name:"Esri Satellite",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",normalizedUrl:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"},{name:"OSM Overlay",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",subdomains:["a","b","c"],normalizedUrl:"https://tile.openstreetmap.org/{z}/{x}/{y}.png"});else{const M=e[u.state.userSettings.baseMaps];v.push({name:u.state.userSettings.baseMaps,url:M.options.url||M._url,subdomains:M.options.subdomains,normalizedUrl:(M.options.url||M._url).replace(/{s}\./,"")})}let b=0,S=0;const E=y.length*v.length;i.isCachingCancelled=!1,n&&n(0,E,()=>{i.isCachingCancelled=!0,o&&o()});for(const M of v){if(i.isCachingCancelled)break;const k=y.map(async(_,C)=>{n&&n(b+S,E,()=>{i.isCachingCancelled=!0,o&&o()})});await Promise.all(k)}a&&a("Visible tiles cached.")}function At(){const t="ontouchstart"in window||navigator.maxTouchPoints>0,e=window.Capacitor&&window.Capacitor.isNativePlatform();return t||e}function Fc(){At()&&document.body.classList.add("touch-device")}function yt(t){console.log("displayMessage called with:",t);let e=document.getElementById("message");e||(e=document.createElement("div"),e.id="message",e.style.position="fixed",e.style.top="5px",e.style.right="5px",e.style.width=At()?"70%":"30%",e.style.backgroundColor="#ccffcc",e.style.borderRadius="5px 5px 5px 5px",e.style.color="#000000",e.style.padding="6px",e.style.zIndex="9998",e.style.textAlign="center",document.body.appendChild(e),window.addEventListener("resize",()=>{e.style.width=At()?"70%":"30%"})),e.textContent=t,e.style.display="block",clearTimeout(window.messageTimeout),window.messageTimeout=setTimeout(()=>{e.style.display="none"},Y.MESSAGE_TIMEOUT_MS)}function kn(t,e,n){const a=Math.round(t/e*100);let o=document.getElementById("progress");o||(o=document.createElement("div"),o.id="progress",o.style.position="fixed",o.style.top="5px",o.style.right="5px",o.style.width=At()?"70%":"30%",o.style.backgroundColor="#ccffcc",o.style.borderRadius="5px 5px 5px 5px",o.style.color="#000000",o.style.padding="6px",o.style.zIndex="9998",o.style.display="flex",o.style.alignItems="center",o.style.gap="10px",document.body.appendChild(o),window.addEventListener("resize",()=>{o.style.width=At()?"70%":"30%"}));const r=document.createElement("div");r.style.flex="1",r.style.display="flex",r.style.flexDirection="column",r.style.gap="3px";const s=document.createElement("div");s.textContent=`Caching (${t}/${e}, ${a}%)`,s.style.fontSize="12px",s.style.textAlign="center";const l=document.createElement("div");l.style.width="100%",l.style.height="8px",l.style.backgroundColor="#e0e0e0",l.style.borderRadius="3px",l.style.overflow="hidden";const c=document.createElement("div");c.style.width=`${a}%`,c.style.height="100%",c.style.backgroundColor="#4caf50",c.style.transition="width 0.3s ease-in-out",l.appendChild(c),r.appendChild(s),r.appendChild(l);let d=document.getElementById("cancel-caching");d||(d=document.createElement("button"),d.id="cancel-caching",d.textContent="Cancel",d.style.backgroundColor="#ff4444",d.style.color="#ffffff",d.style.border="none",d.style.borderRadius="3px",d.style.padding="5px 3px",d.style.cursor="pointer",d.style.fontSize="12px",d.addEventListener("click",()=>{n(),o.style.display="none",p.handleMessage("Caching cancelled.")})),o.innerHTML="",o.appendChild(r),o.appendChild(d),o.style.display="flex"}function Ye(){const t=document.getElementById("progress");t&&(t.style.display="none")}function go(){console.log("updateOfflineIndicator called, navigator.onLine:",navigator.onLine);let t=document.getElementById("offline-indicator");t||(t=document.createElement("div"),t.id="offline-indicator",document.body.appendChild(t),console.log("Offline indicator created and appended")),t.style.display=navigator.onLine?"none":"block",t.textContent="Offline Mode"}function Qn(t){console.log("displayError called with:",t);let e=document.getElementById("error-message");e||(e=document.createElement("div"),e.id="error-message",document.body.appendChild(e),window.addEventListener("resize",()=>{e.style.width=At()?"70%":"30%"})),e.textContent=t,e.style.display="block",console.log("Error element state:",{display:e.style.display,text:e.textContent,position:e.style.position,zIndex:e.style.zIndex}),clearTimeout(window.errorTimeout),window.errorTimeout=setTimeout(()=>{e.style.display="none",console.log("Error hidden after 3s")},Y.MESSAGE_TIMEOUT_MS)}function Fe(){var t;return parseInt((t=document.getElementById("timeSlider"))==null?void 0:t.value)||0}function xc(t){const e=document.getElementById("modelSelect");if(!e)return;const n=e.value;e.innerHTML="",t.forEach(a=>{const o=document.createElement("option");o.value=a,o.textContent=a.replace(/_/g," ").toUpperCase(),e.appendChild(o)}),t.includes(u.state.userSettings.model)?e.value=u.state.userSettings.model:t.includes(n)?e.value=n:t.length>0&&(e.value=t[0])}function Pc(t){let e=u.state.userSettings.selectedEnsembleModels||[],n=e.filter(a=>t.includes(a));e.length!==n.length&&(u.state.userSettings.selectedEnsembleModels=n,u.save())}let Hn=0;async function $c(){return console.log("MapManager: Starte Karteninitialisierung..."),await Rc(),console.log("MapManager: Karteninitialisierung abgeschlossen."),i.map}async function Rc(){if(i.ismapInitialized||i.map){console.warn("Map already initialized or init in progress.");return}i.ismapInitialized=!0,console.log("initMap started...");const t=Y.DEFAULT_MAP_CENTER,e=Y.DEFAULT_MAP_ZOOM;Oc(t,e),i.jumpVisualizationLayerGroup=L.layerGroup().addTo(i.map),i.landingPatternLayerGroup=L.layerGroup().addTo(i.map),i.jumpRunTrackLayerGroup=L.layerGroup().addTo(i.map),Uc(),Hc(),Bc(),Wc(),zc(t),Zc(),Promise.all([Gc(),Jc(t,e)]).then(()=>{console.log("Initial tile caching and geolocation promise resolved.")}).catch(n=>{console.error("Error during parallel initialization of cache/geolocation:",n)}),po(),console.log("initMap finished.")}function Oc(t,e){i.lastLat=i.lastLat||t[0],i.lastLng=i.lastLng||t[1],i.map=L.map("map",{center:t,zoom:e,zoomControl:!1,doubleClickZoom:!1,maxZoom:19,minZoom:navigator.onLine?6:11}),console.log("Map instance created.")}function Uc(){i.baseMaps={OpenStreetMap:L.tileLayer.cached("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:["a","b","c"]}),OpenTopoMap:L.tileLayer.cached("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{maxZoom:17,attribution:'© <a href="https://www.openstreetmap.org/copyright">OSM</a>, <a href="https://opentopomap.org">OpenTopoMap</a> (CC-BY-SA)',subdomains:["a","b","c"]}),"Esri Satellite":L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USDA, USGS"}),"Esri Street":L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USGS"}),"Esri Topo":L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USGS"}),"Esri Satellite + OSM":L.layerGroup([L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USDA, USGS",zIndex:1}),L.tileLayer.cached("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',opacity:.5,zIndex:2,updateWhenIdle:!0,keepBuffer:2,subdomains:["a","b","c"]})],{attribution:'© Esri, USDA, USGS | © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'})},i.map&&i.map.attributionControl&&i.map.attributionControl.addAttribution('Weather data by <a href="https://open-meteo.com">Open-Meteo</a>');const e=u.state.userSettings.baseMaps in i.baseMaps?u.state.userSettings.baseMaps:"Esri Street",n=i.baseMaps[e];n&&typeof n.on=="function"?(n.on("tileerror",()=>{if(!navigator.onLine){i.hasTileErrorSwitched||(console.warn(`${e} tiles unavailable offline. Zoom restricted.`),p.handleMessage("Offline: Zoom restricted to levels 11–14 for cached tiles."),i.hasTileErrorSwitched=!0);return}if(!i.hasTileErrorSwitched&&i.map.hasLayer(n)){const a="OpenStreetMap";console.warn(`${e} tiles unavailable, switching to ${a}`),i.map.removeLayer(n),i.baseMaps[a].addTo(i.map),u.state.userSettings.baseMaps=a,u.save(),p.handleMessage(`${e} tiles unavailable. Switched to ${a}.`),i.hasTileErrorSwitched=!0}else i.hasTileErrorSwitched||console.warn(`Tile error in ${e}, attempting to continue.`)}),n.addTo(i.map)):(console.error(`Default base map "${e}" could not be added.`),i.baseMaps.OpenStreetMap.addTo(i.map)),i.map&&i.map.invalidateSize(),window.addEventListener("online",()=>{i.hasTileErrorSwitched=!1,i.map&&(i.map.options.minZoom=6),po()}),window.addEventListener("offline",()=>{i.map&&(i.map.options.minZoom=9),po()}),console.log("Base layers and online/offline handlers set up.")}function Hc(){if(!i.map){console.error("Karte nicht initialisiert, bevor Controls hinzugefügt werden können.");return}L.control.layers(i.baseMaps,null,{position:"topright"}).addTo(i.map),i.map.on("baselayerchange",function(t){console.log(`Base map changed to: ${t.name}`),u&&u.state&&u.state.userSettings?(u.state.userSettings.baseMaps=t.name,u.save(),console.log(`Saved selected base map "${t.name}" to settings.`)):console.error("Settings object not properly available to save base map choice."),i.hasTileErrorSwitched=!1,i.lastLat&&i.lastLng&&typeof cacheTilesForDIP=="function"&&cacheTilesForDIP({map:i.map,lastLat:i.lastLat,lastLng:i.lastLng,baseMaps:i.baseMaps})}),L.control.zoom({position:"topright"}).addTo(i.map),L.control.polylineMeasure({position:"topright",unit:"kilometres",showBearings:!0,clearMeasurementsOnStop:!1,showClearControl:!0,showUnitControl:!0,tooltipTextFinish:"Click to finish the line<br>",tooltipTextDelete:"Shift-click to delete point",tooltipTextMove:"Drag to move point<br>",tooltipTextResume:"Click to resume line<br>",tooltipTextAdd:"Click to add point<br>",measureControlTitleOn:"Start measuring distance and bearing",measureControlTitleOff:"Stop measuring"}).addTo(i.map),L.control.scale({position:"bottomleft",metric:!0,imperial:!1,maxWidth:100,background:"rgba(255, 255, 255, 0.8)",padding:"5px",borderRadius:"4px"}).addTo(i.map),console.log("Standard map controls and baselayerchange handler added.")}function Bc(){i.map.createPane("gpxTrackPane"),i.map.getPane("gpxTrackPane").style.zIndex=650,i.map.getPane("tooltipPane").style.zIndex=700,i.map.getPane("popupPane").style.zIndex=700,console.log("Custom map panes created.")}function Wc(){i.livePositionControl=new ru({position:"bottomright"}).addTo(i.map),console.log("Initialized livePositionControl and hid by default")}async function zc(t,e){console.log("MapManager: Initialisiere den Standard-Marker..."),await ma(t[0],t[1]),i.isManualPanning=!1,console.log("Default marker initialized using the new standard method.")}async function Gc(){try{if(await oe.init(),await oe.migrateTiles(),await oe.getCacheSize()>500){const e=await oe.clearOldTiles(3);p.handleMessage(`Cleared ${e.deletedCount} old tiles: ${e.deletedSizeMB.toFixed(2)} MB freed.`)}else await oe.clearOldTiles()}catch(t){console.error("Failed to initialize or manage tile cache:",t),p.handleError("Tile caching setup failed.")}console.log("Tile cache logic initialized.")}async function Vc(t,e){const{latitude:n,longitude:a}=t.coords;console.log("MapManager: Geolocation erfolgreich. Sende Event."),i.lastLat=n,i.lastLng=a,i.lastAltitude=await p.getAltitude(n,a),i.map.setView([n,a],e);const o=new CustomEvent("location:selected",{detail:{lat:n,lng:a,source:"geolocation"},bubbles:!0,cancelable:!0});i.map.getContainer().dispatchEvent(o)}async function Ei(t,e,n){console.warn(`Geolocation error: ${t.message}`),p.handleMessage("Unable to retrieve your location. Using default location."),await ma(e[0],e[1]),i.map.setView(e,n),ea(!0),i.isManualPanning=!1;const a=new CustomEvent("location:selected",{detail:{lat:e[0],lng:e[1],source:"geolocation_fallback"},bubbles:!0,cancelable:!0});i.map.getContainer().dispatchEvent(a),console.log("Dispatched 'location:selected' event from geolocation fallback.")}async function Jc(t,e){navigator.geolocation?navigator.geolocation.getCurrentPosition(n=>Vc(n,e),n=>Ei(n,t,e),{enableHighAccuracy:!0,timeout:Y.GEOLOCATION_TIMEOUT_MS,maximumAge:0}):(console.warn("Geolocation not supported."),await Ei({message:"Geolocation not supported by this browser."},t,e))}function jc(t){const{lat:e,lng:n}=t.latlng,a=new CustomEvent("map:mousemove",{detail:{lat:e,lng:n},bubbles:!0,cancelable:!0});i.map.getContainer().dispatchEvent(a)}function Zc(){if(!i.map){console.error("Karte nicht initialisiert in _setupCoreMapEventHandlers");return}if(!i.coordsControl){const e={enableUserInput:!1};i.coordsControl=new L.Control.Coordinates(e),i.coordsControl.addTo(i.map)}Ct()?qc(i.map):Kc(i.map),i.map.on("dblclick",Ja),i.map.on("zoomstart",e=>{if(!navigator.onLine){const n=e.target._zoom||i.map.getZoom();n<11?(e.target._zoom=11,i.map.setZoom(11),p.handleMessage("Offline: Zoom restricted to levels 11–14 for cached tiles.")):n>14&&(e.target._zoom=14,i.map.setZoom(14),p.handleMessage("Offline: Zoom restricted to levels 11–14 for cached tiles."))}}),i.map.on("zoomend",()=>{const e=i.map.getZoom(),n=new CustomEvent("map:zoomend",{detail:{zoom:e},bubbles:!0,cancelable:!0});if(i.map.getContainer().dispatchEvent(n),i.jumpRunTrackLayer&&u.state.userSettings.showJumpRunTrack){const a=i.jumpRunTrackLayer.getLayers().find(o=>{var r;return((r=o.options.icon)==null?void 0:r.options.className)==="jrt-anchor-marker"});if(a){const o=e<=11?10:e<=12?12:e<=13?14:16;a.setIcon(L.divIcon({className:"jrt-anchor-marker",html:`<div style="background-color: orange; width: ${o}px; height: ${o}px; border-radius: 50%; border: 2px solid white; opacity: 0.8;"></div>`,iconSize:[o,o],iconAnchor:[o/2,o/2],tooltipAnchor:[0,-(o/2+5)]}))}}if(i.heatmapLayer){const a=p.calculateDynamicRadius(ve.HEATMAP_BASE_RADIUS,ve.HEATMAP_REFERENCE_ZOOM);i.heatmapLayer.setOptions({radius:a}),console.log("Heatmap radius updated on zoom:",{currentZoom:i.map.getZoom(),newRadius:a})}}),i.map.on("movestart",e=>{e.target===i.map&&(!e.originalEvent||e.originalEvent.target===i.map.getContainer())&&(i.isManualPanning=!0,console.log("Manual map panning detected."))}),i.map.on("contextmenu",e=>{if(!u.state.userSettings.showCutAwayFinder||!u.state.userSettings.calculateJump)return;const{lat:n,lng:a}=e.latlng;i.cutAwayMarker?i.cutAwayMarker.setLatLng([n,a]):(i.cutAwayMarker=tu(n,a).addTo(i.map),nu(i.cutAwayMarker)),i.cutAwayLat=n,i.cutAwayLng=a,Gr(i.cutAwayMarker,n,a);const o=new CustomEvent("cutaway:marker_placed",{bubbles:!0});i.map.getContainer().dispatchEvent(o)});const t=i.map.getContainer();t.addEventListener("touchstart",async e=>{if(e.touches.length!==1||e.target.closest(".leaflet-marker-icon"))return;const n=new Date().getTime(),a=n-Hn;if(a<300&&a>0){e.preventDefault();const r=t.getBoundingClientRect(),s=e.touches[0].clientX-r.left,l=e.touches[0].clientY-r.top,c=i.map.containerPointToLatLng([s,l]);await Ja({latlng:c,containerPoint:L.point(s,l),layerPoint:i.map.latLngToLayerPoint(c)})}Hn=n},{passive:!1}),i.map.on("click",e=>{}),i.map.on("mousedown",e=>{}),t.addEventListener("touchstart",async e=>{if(e.touches.length!==1||e.target.closest(".leaflet-marker-icon"))return;const n=new Date().getTime(),a=n-Hn;if(a<300&&a>0){e.preventDefault();const r=t.getBoundingClientRect(),s=e.touches[0].clientX-r.left,l=e.touches[0].clientY-r.top,c=i.map.containerPointToLatLng([s,l]);await Ja({latlng:c,containerPoint:L.point(s,l),layerPoint:i.map.latLngToLayerPoint(c)})}Hn=n},{passive:!1}),console.log("All core map event handlers have been set up.")}function qc(t){const e=({elevation:a,qfe:o},r)=>{const s=t.getCenter();if(Math.abs(s.lat-r.lat)>1e-4||Math.abs(s.lng-r.lng)>1e-4)return;const c=i.coordsControl._container.innerHTML.split("<br>")[0],d=u.getValue("heightUnit","radio","m");let m="N/A";if(a!=="N/A"){const w=p.convertHeight(a,d);m=Math.round(w)}const h=m==="N/A"?"N/A":`${m}${d}`,f=o!=="N/A"?`${o.toFixed(0)}hPa`:"N/A",g=`${c}<br>Elevation: ${h}<br>QFE: ${f}`;i.coordsControl.update(g)},n=()=>{const a=t.getCenter(),o=u.getValue("coordFormat","radio","Decimal"),r=p.convertCoords(a.lat,a.lng,o),s=o==="MGRS"?`MGRS: ${r.lat}`:`${a.lat.toFixed(5)}, ${a.lng.toFixed(5)}`;i.coordsControl.update(`${s}<br>Elevation: ...<br>QFE: ...`),Ho(a.lat,a.lng,a,e)};t.on("move",n),setTimeout(()=>t.fire("move"),200),console.log("Crosshair coordinate handler initialized.")}function Kc(t){t.on("mousemove",jc),t.on("mouseout",function(){i.coordsControl&&i.coordsControl.getContainer()&&(i.coordsControl.getContainer().innerHTML="Move mouse over map")}),console.log("Mouse coordinate handler initialized.")}function Ja(t){const{lat:e,lng:n}=t.latlng;console.log('MapManager: Doppelklick erkannt. Sende "location:selected"-Event.');const a=new CustomEvent("location:selected",{detail:{lat:e,lng:n,source:"dblclick"},bubbles:!0,cancelable:!0});i.map.getContainer().dispatchEvent(a)}function Gn(t){if(Yc(),i.labelZoomListener&&i.map&&(i.map.off("zoomend",i.labelZoomListener),i.labelZoomListener=null),!t||!i.jumpVisualizationLayerGroup)return;const e=[];t.exitCircles&&t.exitCircles.forEach(a=>{const o=L.circle(a.center,{radius:a.radius,color:a.color,fillColor:a.fillColor,fillOpacity:a.fillOpacity,weight:a.weight||2}).addTo(i.jumpVisualizationLayerGroup);a.tooltip&&o.bindTooltip(a.tooltip,{direction:"top",offset:[0,0],className:"wind-tooltip"})}),t.canopyCircles&&t.canopyCircles.forEach(a=>{L.circle(a.center,a).addTo(i.jumpVisualizationLayerGroup)});function n(a,o){const r=L.latLng(a[0],a[1]),l=o/6378137*(180/Math.PI),c=L.latLng(a[0]+l,a[1]),d=i.map.latLngToLayerPoint(r),m=i.map.latLngToLayerPoint(c);return[25,d.y-m.y+10]}if(t.canopyLabels){const a=i.map.getZoom();t.canopyLabels.forEach(o=>{const r=a<=11,s=L.marker(o.center,{icon:L.divIcon({className:`isoline-label ${r?"isoline-label-small":"isoline-label-large"}`,html:`<span style="font-size: ${r?"8px":"10px"}">${o.text}</span>`,iconSize:r?[50,12]:[60,14],iconAnchor:n(o.center,o.radius)}),zIndexOffset:2100}).addTo(i.jumpVisualizationLayerGroup);e.push({marker:s,center:o.center,radius:o.radius,text:o.text})})}e.length>0&&(i.labelZoomListener=function(){const o=i.map.getZoom()<=11;e.forEach(r=>{r.marker.setIcon(L.divIcon({className:`isoline-label ${o?"isoline-label-small":"isoline-label-large"}`,html:`<span style="font-size: ${o?"8px":"10px"}">${r.text}</span>`,iconSize:o?[50,12]:[60,14],iconAnchor:n(r.center,r.radius)}))})},i.map.on("zoomend",i.labelZoomListener))}function Yc(){i.map&&i.jumpVisualizationLayerGroup&&i.map.removeLayer(i.jumpVisualizationLayerGroup),i.jumpVisualizationLayerGroup=L.layerGroup().addTo(i.map)}function Xc(){i.landingPatternLayerGroup&&i.landingPatternLayerGroup.clearLayers()}function gn(t){Xc(),t&&(t.legs.forEach(e=>{L.polyline(e.path,{color:"red",weight:3,opacity:.8,dashArray:"5, 10"}).addTo(i.landingPatternLayerGroup)}),t.arrows.forEach(e=>{const n=Qc(e.position[0],e.position[1],e.bearing,e.color);L.marker(e.position,{icon:n}).addTo(i.landingPatternLayerGroup).bindTooltip(e.tooltipText,{offset:[10,0],direction:"right",className:"wind-tooltip"})}))}function Qc(t,e,n,a){const o=(n+360)%360,r=`
        <svg width="40" height="20" viewBox="0 0 40 20" xmlns="http://www.w3.org/2000/svg">
            <line x1="0" y1="10" x2="30" y2="10" stroke="${a}" stroke-width="4" />
            <polygon points="30,5 40,10 30,15" fill="${a}" />
        </svg>
    `;return L.divIcon({html:`<div style="transform: rotate(${o}deg); ...">${r}</div>`,className:"wind-arrow-icon",iconSize:[40,20],iconAnchor:[20,10]})}function eu(){i.map&&i.jumpRunTrackLayerGroup&&i.map.removeLayer(i.jumpRunTrackLayerGroup),i.jumpRunTrackLayerGroup=L.layerGroup().addTo(i.map)}function tu(t,e){const n=L.icon({iconUrl:Qt.CUTAWAY_MARKER,iconSize:[25,25],iconAnchor:[12,12],popupAnchor:[0,-12]});return L.marker([t,e],{icon:n,draggable:!0})}function nu(t){t.on("dragend",e=>{const n=t.getLatLng();i.cutAwayLat=n.lat,i.cutAwayLng=n.lng,console.log("Cut-away marker dragged to:",{lat:i.cutAwayLat,lng:i.cutAwayLng}),Gr(t,i.cutAwayLat,i.cutAwayLng);const a=new CustomEvent("cutaway:marker_placed",{bubbles:!0});i.map.getContainer().dispatchEvent(a)})}function Gr(t,e,n,a=!1){const o=u.getValue("coordFormat","radio","Decimal"),r=p.convertCoords(e,n,o);let s="<b>Cut-Away Start</b><br>";if(o==="MGRS")s+=`MGRS: ${r.lat}`;else{const l=c=>`${c.deg}°${c.min}'${c.sec.toFixed(0)}" ${c.dir}`;o==="DMS"?s+=`Lat: ${l(p.decimalToDms(e,!0))}<br>Lng: ${l(p.decimalToDms(n,!1))}`:s+=`Lat: ${e.toFixed(5)}<br>Lng: ${n.toFixed(5)}`}Po(t,s,a)}function fo(t){i.cutAwayCircle&&(i.map.removeLayer(i.cutAwayCircle),i.cutAwayCircle=null),t&&(i.cutAwayCircle=L.circle(t.center,{radius:t.radius,color:"purple",fillColor:"purple",fillOpacity:.2,weight:2}).addTo(i.map),i.cutAwayCircle.bindTooltip(t.tooltipContent,{permanent:!1,direction:"center",className:"cutaway-tooltip"}))}function au(){i.cutAwayMarker&&(i.map.removeLayer(i.cutAwayMarker),i.cutAwayMarker=null),fo(null)}function wn(t){var r,s,l,c;if(eu(),!t||!i.jumpRunTrackLayerGroup){console.warn("No valid trackData or AppState.jumpRunTrackLayerGroup");return}if(!((s=(r=t.path)==null?void 0:r.latlngs)!=null&&s.length)||!((l=t.airplane)!=null&&l.position)){console.warn("Invalid trackData structure:",t);return}const e=L.polyline(t.path.latlngs,t.path.options).bindTooltip(t.path.tooltipText).addTo(i.jumpRunTrackLayerGroup);let n=null;(c=t.approachPath)!=null&&c.latlngs&&(n=L.polyline(t.approachPath.latlngs,t.approachPath.options).bindTooltip(t.approachPath.tooltipText).addTo(i.jumpRunTrackLayerGroup));const a=L.icon({iconUrl:Qt.AIRPLANE_MARKER,iconSize:[32,32],iconAnchor:[16,16],shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",shadowSize:[41,41],shadowAnchor:[13,32]}),o=L.marker(t.airplane.position,{icon:a,rotationAngle:t.airplane.bearing,rotationOrigin:"center center",draggable:!0,zIndexOffset:2e3}).bindTooltip("Drag to move Jump Run Track").addTo(i.jumpRunTrackLayerGroup);o.on("mousedown",()=>i.map.dragging.disable()),o.on("mouseup",()=>i.map.dragging.enable()),o.on("drag",d=>{var y;const m=d.target.getLatLng(),h=t.airplane.originalPosition;if(!h||!Number.isFinite(h.lat)||!Number.isFinite(h.lng)){console.warn("Invalid originalPosition:",h);return}const f=m.lat-h.lat,g=m.lng-h.lng;if(!Number.isFinite(f)||!Number.isFinite(g)){console.warn("Invalid delta values:",{deltaLat:f,deltaLng:g});return}const w=t.path.originalLatLngs.map(v=>[Number.isFinite(v[0])?v[0]+f:v[0],Number.isFinite(v[1])?v[1]+g:v[1]]);if(e.setLatLngs(w),n&&((y=t.approachPath)!=null&&y.originalLatLngs)){const v=t.approachPath.originalLatLngs.map(b=>[Number.isFinite(b[0])?b[0]+f:b[0],Number.isFinite(b[1])?b[1]+g:b[1]]);n.setLatLngs(v)}}),o.on("dragend",d=>{const m=d.target.getLatLng();if(!Number.isFinite(m.lat)||!Number.isFinite(m.lng)){console.warn("Invalid new position in dragend:",m);return}const h=new CustomEvent("track:dragend",{detail:{newPosition:m,originalTrackData:t},bubbles:!0});i.map.getContainer().dispatchEvent(h)})}async function ma(t,e){if(console.log("MapManager: Befehl erhalten, Marker zu erstellen/bewegen bei",t,e),typeof t!="number"||typeof e!="number"||t<-90||t>90||e<-180||e>180){console.error("MapManager: Ungültige Koordinaten:",{lat:t,lng:e});return}const n=await p.getAltitude(t,e);if(i.currentMarker)console.log("MapManager: Marker existiert, bewege ihn jetzt mit setLatLng."),i.currentMarker.setLatLng([t,e]);else{console.log("MapManager: Kein Marker vorhanden, erstelle einen neuen.");const o=ou(t,e);iu(o),i.currentMarker=o,i.currentMarker.addTo(i.map)}const a=`Lat: ${t.toFixed(5)}<br>Lng: ${e.toFixed(5)}<br>Alt: ${n} m`;Po(i.currentMarker,a),i.lastLat=t,i.lastLng=e,i.lastAltitude=n,i.map.invalidateSize()}function ou(t,e){const n=L.icon({iconUrl:Qt.DEFAULT_MARKER,iconSize:[32,32],iconAnchor:[16,20],popupAnchor:[0,-32]});return L.marker([t,e],{icon:n,draggable:!0})}function iu(t){t.on("dragend",e=>{const n=t.getLatLng(),a=new CustomEvent("location:selected",{detail:{lat:n.lat,lng:n.lng,source:"marker_drag"},bubbles:!0});i.map.getContainer().dispatchEvent(a)})}function Po(t,e,n=!1){var o;if(!t)return;const a=((o=t.getPopup())==null?void 0:o.isOpen())||n;t.unbindPopup().bindPopup(e),a&&t.openPopup()}function ea(t=!1){i.isManualPanning&&!t||i.map&&i.currentMarker&&i.map.panTo(i.currentMarker.getLatLng())}const ru=L.Control.extend({options:{position:"bottomright"},onAdd:function(t){const e=L.DomUtil.create("div","leaflet-control-live-position");return e.style.display="none",e.style.background="rgba(255, 255, 255, 0.8)",e.style.padding="5px",e.style.borderRadius="4px",this._container=e,e},update:function(t){if(!t||t.latitude===null||t.latitude===void 0){this._container.style.display="none";return}const{latitude:e,longitude:n,deviceAltitude:a,altitudeAccuracy:o,accuracy:r,speedMs:s,direction:l,showJumpMasterLine:c,jumpMasterLineData:d,heightUnit:m,effectiveWindUnit:h,coordFormat:f,refLevel:g}=t,w=p.convertCoords(e,n,f),y=f==="MGRS"?`MGRS: ${w.lat}<br>`:`Lat: ${e.toFixed(5)}<br>Lng: ${n.toFixed(5)}<br>`;let v="Altitude: N/A<br>";if(a!==null){let k=g==="AGL"&&i.lastAltitude?a-parseFloat(i.lastAltitude):a,_=g==="AGL"&&i.lastAltitude?"abv DIP":g;const C=Math.round(p.convertHeight(k,m)),T=Math.round(p.convertHeight(o,m));v=`Altitude: ${C} ${m} ${_} (±${T||"N/A"} ${m})<br>`}const b=`Accuracy: ${Math.round(p.convertHeight(r,m))} ${m}<br>`,S=`Speed: ${p.convertWind(s,h,"m/s").toFixed(1)} ${h}<br>`,E=`Direction: ${l}°`;let M=`<span style="font-weight: bold;">Live Position</span><br>${y}${v}${b}${S}${E}`;if(c&&d){const k=Math.round(p.convertHeight(d.distance,m)),_=d.tot!=="N/A"&&d.tot<1200?`TOT: X - ${d.tot} s`:"TOT: N/A";M+=`<br><br><span style="font-weight: bold;">Jump Master Line to ${d.target}</span><br>`,M+=`Bearing: ${d.bearing}°<br>`,M+=`Distance: ${k} ${m}<br>`,M+=_}this._container.innerHTML=M,this._container.style.display="block"}});function su(t,e){const n=[[t.lat,t.lng],[e.lat,e.lng]];i.jumpMasterLine?i.jumpMasterLine.setLatLngs(n):i.jumpMasterLine=L.polyline(n,{color:"blue",weight:3,dashArray:"5, 5"}).addTo(i.map)}function ki(){i.jumpMasterLine&&(i.map.removeLayer(i.jumpMasterLine),i.jumpMasterLine=null)}function lu(){i.livePositionControl&&i.livePositionControl.update(null)}function cu(t){i.livePositionControl&&i.livePositionControl.update(t)}function Vr(t){if(!i.isPlacingHarp)return;const{lat:e,lng:n}=t.latlng;i.harpMarker?(i.harpMarker.setLatLng([e,n]),console.log("Updated HARP marker position:",{lat:e,lng:n})):(i.harpMarker=uu(e,n).addTo(i.map),console.log("Placed new HARP marker:",{lat:e,lng:n})),u.state.userSettings.harpLat=e,u.state.userSettings.harpLng=n,u.save(),i.isPlacingHarp=!1,i.map.off("click",Vr),console.log("HARP placement mode deactivated");const a=document.querySelector('input[name="jumpMasterLineTarget"][value="HARP"]');a&&(a.disabled=!1,console.log("Enabled HARP radio button"))}function uu(t,e){const n=L.marker([t,e],{icon:L.divIcon({className:"harp-marker",html:'<div style="background-color: green; width: 10px; height: 10px; border-radius: 50%;"></div>',iconSize:[10,10],iconAnchor:[5,5]}),pane:"markerPane"});return console.log("Created HARP marker at:",{latitude:t,longitude:e}),n}function du(){if(!i.map){console.warn("Map not initialized, cannot clear HARP marker"),p.handleMessage("Map not initialized, cannot clear HARP marker.");return}i.harpMarker&&(i.map.removeLayer(i.harpMarker),i.harpMarker=null,console.log("Removed HARP marker")),u.state.userSettings.harpLat=null,u.state.userSettings.harpLng=null,u.save();const t=document.querySelector('input[name="jumpMasterLineTarget"][value="HARP"]');if(t&&(t.disabled=!0,console.log("Disabled HARP radio button")),u.state.userSettings.jumpMasterLineTarget==="HARP"&&u.state.userSettings.showJumpMasterLine){i.jumpMasterLine&&(i.map.removeLayer(i.jumpMasterLine),i.jumpMasterLine=null,console.log("Removed Jump Master Line: HARP marker cleared")),u.state.userSettings.jumpMasterLineTarget="DIP";const e=document.querySelector('input[name="jumpMasterLineTarget"][value="DIP"]');e&&(e.checked=!0,console.log("Switched Jump Master Line to DIP")),u.save(),i.liveMarker&&i.currentMarker&&i.lastLat!==null&&i.lastLng!==null&&debouncedPositionUpdate({coords:{latitude:i.lastLatitude,longitude:i.lastLongitude,accuracy:i.lastAccuracy,altitude:i.lastDeviceAltitude,altitudeAccuracy:i.lastAltitudeAccuracy}})}p.handleMessage("HARP marker cleared")}async function Bt(){if(!i.currentMarker||i.lastLat===null)return;const t=i.lastLat,e=i.lastLng,n=i.lastAltitude,a=u.getValue("heightUnit","radio","m");let o="N/A",r="";n!=="N/A"&&(a==="ft"?(o=Math.round(p.convertHeight(n,"ft")),r="ft"):(o=n,r="m"));const s=u.getValue("coordFormat","radio","Decimal"),l=me(),c=p.convertCoords(t,e,s);let d;if(s==="MGRS")d=`MGRS: ${c.lat}<br>Alt: ${o} ${r}`;else{const m=h=>`${h.deg}°${h.min}'${h.sec.toFixed(0)}" ${h.dir}`;s==="DMS"?d=`Lat: ${m(p.decimalToDms(t,!0))}<br>Lng: ${m(p.decimalToDms(e,!1))}<br>Alt: ${o} ${r}`:d=`Lat: ${t.toFixed(5)}<br>Lng: ${e.toFixed(5)}<br>Alt: ${o} ${r}`}if(i.weatherData&&i.weatherData.surface_pressure){const m=i.weatherData.surface_pressure[l];m?d+=` QFE: ${m.toFixed(0)} hPa`:d+=" QFE: N/A"}else d+=" QFE: N/A";Po(i.currentMarker,d)}async function kt(t,e,n,a=null){var S;console.log(`updateWeatherDisplay called for index: ${t} -> into ${e}`);const o=document.getElementById(e),r=document.getElementById(n);if(!o||!r){console.error("Target container(s) for weather display not found!",{tableContainerId:e,timeContainerId:n});return}if(!i.weatherData||!i.weatherData.time||t<0||t>=i.weatherData.time.length){console.error("No weather data available or index out of bounds:",t),o.innerHTML='<p style="padding: 20px; text-align: center;">No weather data available</p>',r.innerHTML="Selected Time: ";const E=document.getElementById("timeSlider");E&&(E.value=0);return}i.landingWindDir=i.weatherData.wind_direction_10m[t]||null,console.log("landingWindDir updated to:",i.landingWindDir);const s=document.getElementById("customLandingDirectionLL"),l=document.getElementById("customLandingDirectionRR");s&&l&&i.landingWindDir!==null&&(s.value=Math.round(i.landingWindDir),l.value=Math.round(i.landingWindDir));const c=((S=document.querySelector('input[name="refLevel"]:checked'))==null?void 0:S.value)||"AGL",d=u.getValue("heightUnit","radio","m"),m=u.getValue("windUnit","radio","kt"),h=u.getValue("temperatureUnit","radio","C"),f=await p.getDisplayTime(i.weatherData.time[t],i.lastLat,i.lastLng),g=Te(),w=_e(i.weatherData,t,g,Math.round(i.lastAltitude),d),y=c==="AMSL"&&i.lastAltitude!=="N/A"?Math.round(i.lastAltitude):0;if(!u.state.userSettings.showTable){o.innerHTML="",r.innerHTML=`Selected Time: ${f}`;return}const v=w.map(E=>{const M=parseFloat(E.spd);let k="";if(m==="bft"){const F=p.convertWind(M,"kt","km/h"),B=p.knotsToBeaufort(F);B<=1?k="wind-low":B<=3?k="wind-moderate":B<=4?k="wind-high":k="wind-very-high"}else{const F=p.convertWind(M,"kt","km/h");F<=3?k="wind-low":F<=10?k="wind-moderate":F<=16?k="wind-high":k="wind-very-high"}const _=E.rh;let C="";_!=="N/A"&&Number.isFinite(_)&&(_<65?C="humidity-low":_>=65&&_<=85?C="humidity-moderate":_>85&&_<100?C="humidity-high":_===100&&(C="humidity-saturated"));const T=c==="AMSL"?E.displayHeight+(d==="ft"?Math.round(y*3.28084):y):E.displayHeight,D=p.convertTemperature(E.temp,h==="C"?"°C":"°F"),P=D==="N/A"?"N/A":D.toFixed(0),I=p.convertWind(M,m,"km/h");let x;const R=c==="AMSL"?d==="ft"?Math.round(y*3.28084):y:0;if(Math.round(T)===R&&i.weatherData.wind_gusts_10m[t]!==void 0&&Number.isFinite(i.weatherData.wind_gusts_10m[t])){const F=i.weatherData.wind_gusts_10m[t],B=p.convertWind(F,m,"km/h"),Z=m==="bft"?Math.round(I):I.toFixed(0),X=m==="bft"?Math.round(B):B.toFixed(0);x=`${Z} G ${X}`}else x=I==="N/A"?"N/A":m==="bft"?Math.round(I):I.toFixed(0);const $=Math.round(p.convertWind(M,"kt","km/h")/5)*5,V=E.dir==="N/A"||isNaN($)?"N/A":p.generateWindBarb(E.dir,$);return`<tr class="${k} ${C}">
                    <td>${Math.round(T)}</td>
                    <td>${p.roundToTens(E.dir)}</td>
                    <td>${x}</td>
                    <td>${V}</td>
                    <td>${P}</td>
                </tr>`}).join(""),b=`
        <table id="weatherTable">
            <thead>
                <tr>
                    <th>Height (${d} ${c})</th>
                    <th>Dir (deg)</th>
                    <th>Spd (${m})</th>
                    <th>Wind</th>
                    <th>T (${h==="C"?"°C":"°F"})</th>
                </tr>
            </thead>
            <tbody>
                ${v}
            </tbody>
        </table>`;o.innerHTML=b,r.innerHTML=`Selected Time: ${f}`}function nt(){var ln;if(!i.currentMarker||typeof i.currentMarker.getLatLng!="function"){console.warn("Landing pattern update skipped: AppState.currentMarker is not a valid marker object yet.",i.currentMarker);return}const t=i.currentMarker.getLatLng();if(!t){console.error("Could not get LatLng from the current marker. Aborting landing pattern update.",i.currentMarker);return}if(!u.state.isLandingPatternUnlocked||!u.state.userSettings.showLandingPattern){gn(null);return}if(!i.weatherData||!i.lastLat){gn(null);return}const e=i.map.getZoom();if(e<Y.LANDING_PATTERN_MIN_ZOOM){console.log("Landing pattern not displayed - zoom too low:",e),gn(null);return}const n=parseInt(document.getElementById("timeSlider").value)||0,a=((ln=document.querySelector('input[name="landingDirection"]:checked'))==null?void 0:ln.value)||"LL",o=document.getElementById("customLandingDirectionLL"),r=document.getElementById("customLandingDirectionRR"),s=o?parseInt(o.value,10):null,l=r?parseInt(r.value,10):null,c=parseInt(document.getElementById("canopySpeed").value)||20,d=parseFloat(document.getElementById("descentRate").value)||3.5,m=parseInt(document.getElementById("legHeightFinal").value)||100,h=parseInt(document.getElementById("legHeightBase").value)||200,f=parseInt(document.getElementById("legHeightDownwind").value)||300,g=t.lat,w=t.lng,y=Math.round(i.lastAltitude),v=Te(),b=u.getValue("heightUnit","radio","m"),S=_e(i.weatherData,n,v,Math.round(i.lastAltitude),b);if(!S||S.length===0)return;const E=S.map(z=>z.height),M=S.map(z=>Number.isFinite(z.dir)?parseFloat(z.dir):0),k=S.map(z=>p.convertWind(parseFloat(z.spd)||0,"kt","km/h")),_=k.map((z,re)=>-z*Math.sin(M[re]*Math.PI/180)),C=k.map((z,re)=>-z*Math.cos(M[re]*Math.PI/180));let T;if(a==="LL"&&Number.isFinite(s)&&s>=0&&s<=359?T=s:a==="RR"&&Number.isFinite(l)&&l>=0&&l<=359?T=l:T=Number.isFinite(i.landingWindDir)?i.landingWindDir:M[0],!Number.isFinite(T)){console.warn("Invalid landing wind direction:",T);return}function D(z){const re=u.getValue("windUnit","radio","kt"),tt=p.convertWind(z,re,"kt");return re==="bft"?Math.round(tt):tt.toFixed(1)}const P=(z,re,tt,Aa,Ia)=>{const cn=Aa*1.852/3.6*Ia/111e3,un=tt*Math.PI/180,Da=cn*Math.cos(un),Na=cn*Math.sin(un)/Math.cos(z*Math.PI/180);return[z+Da,re+Na]},I=[y,y+m];console.log("Final limits:",I);const x=p.calculateMeanWind(E,_,C,...I),R=x[0],$=x[1];if(!Number.isFinite($)||!Number.isFinite(R)){console.warn("Invalid mean wind for final leg:",x);return}let V=null;$<=3?V="lightblue":$<=10?V="lightgreen":$<=16?V="#f5f34f":V="#ffcccc";const F=T,B=p.calculateWindAngle(F,R),{crosswind:Z,headwind:X}=p.calculateWindComponents($,B),ce=p.calculateWCA(Z,c)*(Z>=0?1:-1),Q=p.normalizeAngle(F-ce),fe=p.calculateCourseFromHeading(Q,R,$,c).groundSpeed,Oe=m/d,Lt=fe*1.852/3.6*Oe,ct=(T+180)%360,W=P(g,w,ct,fe,Oe);(g+W[0])/2,(w+W[1])/2;const nn=[y+m,y+h],Ue=p.calculateMeanWind(E,_,C,...nn),ye=Ue[0],ee=Ue[1];if(!Number.isFinite(ee)||!Number.isFinite(ye)){console.warn("Invalid mean wind for base leg:",Ue);return}let be=null;ee<=3?be="lightblue":ee<=10?be="lightgreen":ee<=16?be="#f5f34f":be="#ffcccc",console.log("********* Landing Direction: ",a,"Effective Landing Wind Dir:",T);let Se=0;a==="LL"?(Se=(T+90)%360,console.log("Base Heading:",Se)):a==="RR"&&(Se=(T-90+360)%360,console.log("Base Heading:",Se));const Je=p.calculateCourseFromHeading(Se,ye,ee,c),Ce=Je.trueCourse,we=Je.groundSpeed;let Ee=(Ce+180)%360;we<0&&(Ee=(Ee+180)%360,console.log("Base ground speed is negative:",we,"New course:",Ee));const ut=(h-m)/d,ga=we*1.852/3.6*ut;console.log("Base Course:",Ce);const fa=p.calculateWindAngle(Ce,ye),{crosswind:an,headwind:ya}=p.calculateWindComponents(ee,fa),wa=p.calculateWCA(an,c)*(an>=0?1:-1),j=P(W[0],W[1],Ee,we,ut);(W[0]+j[0])/2,(W[1]+j[1])/2;const La=[y+h,y+f],Qe=p.calculateMeanWind(E,_,C,...La),He=Qe[0],ie=Qe[1];if(!Number.isFinite(ie)||!Number.isFinite(He)){console.warn("Invalid mean wind for downwind leg:",Qe);return}let Be=null;ie<=3?Be="lightblue":ie<=10?Be="lightgreen":ie<=16?Be="#f5f34f":Be="#ffcccc";const et=T,va=p.calculateWindAngle(et,He),{crosswind:on,headwind:Ma}=p.calculateWindComponents(ie,va),rn=p.calculateWCA(on,c)*(on>=0?1:-1),ba=p.normalizeAngle((et-rn+180)%360),vt=p.calculateCourseFromHeading(ba,He,ie,c).groundSpeed,sn=(f-h)/d,Sa=vt*1.852/3.6*sn,pe=P(j[0],j[1],et,vt,sn),Ea=[(g+W[0])/2,(w+W[1])/2],ka=[(W[0]+j[0])/2,(W[1]+j[1])/2],Ta=[(j[0]+pe[0])/2,(j[1]+pe[1])/2];(j[0]+pe[0])/2,(j[1]+pe[1])/2,console.log(`Landing Pattern Updated:
        Final Leg: Wind: ${R.toFixed(1)}° @ ${$.toFixed(1)}kt, Course: ${F.toFixed(1)}°, WCA: ${ce.toFixed(1)}°, GS: ${fe.toFixed(1)}kt, HW: ${X.toFixed(1)}kt, Length: ${Lt.toFixed(1)}m
        Base Leg: Wind: ${ye.toFixed(1)}° @ ${ee.toFixed(1)}kt, Course: ${Ce.toFixed(1)}°, WCA: ${wa.toFixed(1)}°, GS: ${we.toFixed(1)}kt, HW: ${ya.toFixed(1)}kt, Length: ${ga.toFixed(1)}m
        Downwind Leg: Wind: ${He.toFixed(1)}° @ ${ie.toFixed(1)}kt, Course: ${et.toFixed(1)}°, WCA: ${rn.toFixed(1)}°, GS: ${vt.toFixed(1)}kt, HW: ${Ma.toFixed(1)}kt, Length: ${Sa.toFixed(1)}m`);const _a=i.weatherData.time[n];console.log("+++++++++ Koordinaten Pattern:",_a),console.log("Coordinates DIP: ",g,w,"Altitude DIP:",y),console.log("Coordinates final end: ",W[0],W[1],"Leg Height:",y+m),console.log("Coordinates base end: ",j[0],j[1],"Leg Height:",y+h),console.log("Coordinates downwind end: ",pe[0],pe[1],"Leg Height:",y+f);const Ca={legs:[{path:[[g,w],W],options:{color:"red",weight:3,opacity:.8,dashArray:"5, 10"}},{path:[W,j],options:{color:"red",weight:3,opacity:.8,dashArray:"5, 10"}},{path:[j,pe],options:{color:"red",weight:3,opacity:.8,dashArray:"5, 10"}}],arrows:[{position:Ea,bearing:(R-90+180)%360,color:V,tooltipText:`${Math.round(R)}° ${D($)}${u.getValue("windUnit","radio","kt")}`},{position:ka,bearing:(Ue[0]-90+180)%360,color:be,tooltipText:`${Math.round(ye)}° ${D(ee)}${u.getValue("windUnit","radio","kt")}`},{position:Ta,bearing:(Qe[0]-90+180)%360,color:Be,tooltipText:`${Math.round(He)}° ${D(ie)}${u.getValue("windUnit","radio","kt")}`}]};gn(Ca)}function xe(){var s,l,c,d,m,h,f,g;if(console.log("updateJumpRunTrackDisplay called"),!i.map){console.warn("Map not initialized, cannot update jump run track display");return}if(!(u.state.userSettings.showJumpRunTrack&&i.weatherData&&i.lastLat&&i.lastLng&&u.state.isCalculateJumpUnlocked&&u.state.userSettings.calculateJump)){console.log("Conditions not met to show JRT, clearing display."),wn(null),i.lastTrackData=null;return}const e=me(),n=Te(),a=u.getValue("heightUnit","radio","m"),o=_e(i.weatherData,e,n,Math.round(i.lastAltitude),a),r=Dt(o);if(r&&((s=r.latlngs)==null?void 0:s.length)===2&&r.latlngs.every(w=>Number.isFinite(w[0])&&Number.isFinite(w[1]))){console.log("Drawing jump run track with data:",r);const w={path:{latlngs:r.latlngs,options:{color:"orange",weight:5,opacity:.8},tooltipText:`Jump Run Track: ${r.direction}°, Length: ${r.trackLength} m`,originalLatLngs:((c=(l=i.lastTrackData)==null?void 0:l.latlngs)==null?void 0:c.length)===2?i.lastTrackData.latlngs:r.latlngs},approachPath:((d=r.approachLatLngs)==null?void 0:d.length)===2&&r.approachLatLngs.every(y=>Number.isFinite(y[0])&&Number.isFinite(y[1]))?{latlngs:r.approachLatLngs,options:{color:"orange",weight:5,opacity:.8,dashArray:"5, 10"},tooltipText:`Approach Path: ${r.direction}°, Length: ${r.approachLength} m`,originalLatLngs:((h=(m=i.lastTrackData)==null?void 0:m.approachLatLngs)==null?void 0:h.length)===2?i.lastTrackData.approachLatLngs:r.approachLatLngs}:null,trackLength:r.trackLength,airplane:{position:L.latLng(r.latlngs[1][0],r.latlngs[1][1]),bearing:r.direction,originalPosition:(g=(f=i.lastTrackData)==null?void 0:f.latlngs)!=null&&g[1]&&Number.isFinite(i.lastTrackData.latlngs[1][0])?L.latLng(i.lastTrackData.latlngs[1][0],i.lastTrackData.latlngs[1][1]):L.latLng(r.latlngs[1][0],r.latlngs[1][1])}};wn(w),i.lastTrackData={latlngs:r.latlngs,approachLatLngs:r.approachLatLngs,direction:r.direction,trackLength:r.trackLength,approachLength:r.approachLength},console.log("Updated AppState.lastTrackData:",i.lastTrackData)}else console.warn("No valid track data to display:",r),wn(null),i.lastTrackData=null}let mu=[];function Jr(){ha();const t=document.getElementById("locationSearchInput");t&&(t.addEventListener("input",e=>{hu(e.target.value)}),t.addEventListener("location:selected",()=>{t.value="",Zt()}))}async function hu(t){if(!t||t.length<2){Zt();return}const e=`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(t)}&format=json&limit=5&addressdetails=1`;try{const n=await fetch(e,{headers:{"User-Agent":"Wetterheidi-App/1.0 (wetterheidi.app)"}});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const a=await n.json();Zt(a)}catch(n){console.error("Fehler bei der Geocoding-Suche:",n),p.handleError("Could not find location.")}}function Zt(t=[]){const e=document.getElementById("favorites-list"),n=document.getElementById("recents-list"),a=document.getElementById("search-results-list"),o=document.getElementById("favorites-section"),r=document.getElementById("recents-section"),s=document.getElementById("search-results-section");if(!e)return;e.innerHTML="",n.innerHTML="",a.innerHTML="";const l=$o(),c=l.filter(h=>h.isFavorite),d=l.filter(h=>!h.isFavorite),m=(h,f)=>{var _;const g=document.createElement("li");g.className="search-item";const w=parseFloat(h.lat),y=parseFloat(h.lng||h.lon);g.dataset.lat=w,g.dataset.lon=y;const v=document.createElement("span");v.className="search-item-icon",f==="favorite"?(v.innerHTML="★",v.style.color="#f3d131"):f==="recent"?v.innerHTML="🕒":v.innerHTML="📍",g.appendChild(v);const b=document.createElement("div");b.className="search-item-text";const S=document.createElement("span");S.className="name",S.textContent=h.label||h.display_name;const E=document.createElement("span");E.className="details",E.textContent=h.type==="coordinate"?"Coordinate Lookup":((_=h.address)==null?void 0:_.country)||"",b.appendChild(S),b.appendChild(E),g.appendChild(b),g.addEventListener("mousedown",()=>{const C=new CustomEvent("location:selected",{detail:{lat:w,lng:y}});document.getElementById("locationSearchInput").dispatchEvent(C),ha(w,y,h.label||h.display_name,h.isFavorite||!1)});const M=document.createElement("div");if(M.className="search-item-actions",f!=="favorite"){const C=document.createElement("button");C.innerHTML=h.isFavorite?"★":"☆",h.isFavorite&&C.classList.add("is-favorite"),C.addEventListener("click",T=>{T.stopPropagation(),pu(w,y,h.label||h.display_name)}),M.appendChild(C)}const k=document.createElement("button");return k.className="delete-btn",k.innerHTML="×",k.addEventListener("click",C=>{C.stopPropagation(),confirm(`Delete "${h.label||h.display_name}"?`)&&gu(w,y)}),M.appendChild(k),g.appendChild(M),g};s.style.display=t.length>0?"block":"none",t.forEach(h=>{const f=c.find(g=>Math.abs(g.lat-parseFloat(h.lat))<.001&&Math.abs(g.lng-parseFloat(h.lon))<.001);h.isFavorite=!!f,f&&(h.label=f.label),a.appendChild(m(h,"search"))}),o.style.display=c.length>0?"block":"none",c.forEach(h=>e.appendChild(m(h,"favorite"))),r.style.display=d.length>0?"block":"none",d.forEach(h=>n.appendChild(m(h,"recent")))}function $o(){try{return JSON.parse(localStorage.getItem("coordHistory"))||[]}catch{return[]}}function Ro(t){try{localStorage.setItem("coordHistory",JSON.stringify(t))}catch(e){console.error("Error saving history:",e)}}function ha(t,e,n,a=!1){if(isNaN(t)||isNaN(e))return;let o=$o();const r=parseFloat(t.toFixed(5)),s=parseFloat(e.toFixed(5));o=o.filter(d=>Math.abs(d.lat-r)>1e-4||Math.abs(d.lng-s)>1e-4),o.unshift({lat:r,lng:s,label:n,isFavorite:a,timestamp:Date.now()});const l=o.filter(d=>d.isFavorite),c=o.filter(d=>!d.isFavorite).slice(0,5);Ro([...l,...c]),Zt()}function pu(t,e,n){const a=mu.find(o=>o.lat===t&&o.lng===e);a?a.isFavorite=!a.isFavorite:ha(t,e,n,!0),Ro(),Zt()}function gu(t,e){if(isNaN(t)||isNaN(e))return;const a=$o().filter(o=>{const r=parseFloat(o.lat),s=parseFloat(o.lng||o.lon);return Math.abs(r-t)>1e-4||Math.abs(s-e)>1e-4});Ro(a),p.handleMessage("Location deleted."),Zt()}function fu(t,e,n,a){if(!i.map)return console.warn("Map not initialized for getTooltipContent"),"Map not initialized";const o=u.getValue("coordFormat","radio","Decimal"),r=u.getValue("windUnit","radio","kt"),s=u.getValue("heightUnit","radio","m"),l=p.convertCoords(t.lat,t.lng,o);let c=o==="MGRS"?`MGRS: ${l.lat}`:`Lat: ${l.lat}<br>Lng: ${l.lng}`;const d=t.ele;let m=d!==null&&a!==null?d-a:null;if(m!==null){const g=s||u.state.userSettings.heightUnit||"m";m=p.convertHeight(m,g),m=Math.round(m),c+=`<br>Altitude: ${m} ${g} AGL`}else c+="<br>Altitude: N/A";let h="N/A",f="N/A";if(e>0&&t.time&&n[e-1].time&&t.ele!==null&&n[e-1].ele!==null){const g=(t.time.toMillis()-n[e-1].time.toMillis())/1e3;if(g>0){const y=i.map.distance([n[e-1].lat,n[e-1].lng],[t.lat,t.lng])/g;h=p.convertWind(y,r,"m/s"),h=r==="bft"?Math.round(h):h.toFixed(1),f=((t.ele-n[e-1].ele)/g).toFixed(1)}}return c+=`<br>Speed: ${h} ${r}`,c+=`<br>Descent Rate: ${f} m/s`,c}async function jr(t){if(!i.map)return p.handleError("Map not initialized."),null;i.isLoadingGpx=!0;const e=new FileReader;return new Promise((n,a)=>{e.onload=async function(o){var r,s;try{const l=o.target.result,m=new DOMParser().parseFromString(l,"text/xml").getElementsByTagName("trkpt"),h=[];for(let g=0;g<m.length;g++){const w=parseFloat(m[g].getAttribute("lat")),y=parseFloat(m[g].getAttribute("lon"));if(isNaN(w)||isNaN(y))continue;const v=(r=m[g].getElementsByTagName("ele")[0])==null?void 0:r.textContent,b=(s=m[g].getElementsByTagName("time")[0])==null?void 0:s.textContent;h.push({lat:w,lng:y,ele:v?parseFloat(v):null,time:b?N.fromISO(b,{zone:"utc"}):null})}if(h.length<2)throw new Error("GPX track has insufficient points.");const f=await qr(h,t.name);n(f)}catch(l){console.error("[trackManager] Error in loadGpxTrack:",l),p.handleError("Error parsing GPX file: "+l.message),n(null)}finally{i.isLoadingGpx=!1}},e.onerror=()=>{p.handleError("Error reading GPX file."),i.isLoadingGpx=!1,a(new Error("Error reading GPX file."))},e.readAsText(t)})}async function Zr(t){if(!i.map)return p.handleError("Map not initialized."),null;i.isLoadingGpx=!0;const e=new FileReader;return new Promise((n,a)=>{e.onload=async function(o){try{const r=o.target.result,s=[];Papa.parse(r,{skipEmptyLines:!0,step:function(l){const c=l.data;if(c[0]&&c[0].toUpperCase()==="$GNSS"&&c.length>=5){let d=c[1];const m=parseFloat(c[2]),h=parseFloat(c[3]),f=parseFloat(c[4]);if(isNaN(m)||isNaN(h)||isNaN(f))return;let g=null;try{g=N.fromISO(d,{setZone:!0}).toUTC(),g.isValid||(g=null)}catch{g=null}s.push({lat:m,lng:h,ele:f,time:g})}},complete:async function(){if(s.length<2)throw new Error("CSV track has insufficient points.");const l=await qr(s,t.name);n(l)},error:function(l){throw new Error("Error parsing CSV: "+l.message)}})}catch(r){console.error("[trackManager] Error in loadCsvTrackUTC:",r),p.handleError("Error parsing CSV file: "+r.message),n(null)}finally{i.isLoadingGpx=!1}},e.onerror=()=>{p.handleError("Error reading CSV file."),i.isLoadingGpx=!1,a(new Error("Error reading CSV file."))},e.readAsText(t)})}async function qr(t,e){try{if(console.log(`[trackManager] renderTrack called for ${e} with ${t.length} points.`),!i.map)return console.warn("[trackManager] Map object in AppState is not available in renderTrack."),p.handleError("Map not initialized. Cannot render track."),null;i.gpxLayer&&i.map.hasLayer(i.gpxLayer)&&i.map.removeLayer(i.gpxLayer),i.gpxLayer=null,i.gpxPoints=t,i.isTrackLoaded=!1;const n={finalPointData:null,timestampToUseForWeather:null,historicalDateString:null,summaryForInfoElement:"",success:!1};if(t.length>0){const o=t[t.length-1];if(i.lastLat=o.lat,i.lastLng=o.lng,i.lastAltitude=await p.getAltitude(i.lastLat,i.lastLng),n.finalPointData={lat:i.lastLat,lng:i.lastLng,altitude:i.lastAltitude},t[0].time&&t[0].time.isValid){const m=t[0].time,h=N.utc().startOf("day"),f=m.startOf("day");f<h&&(n.historicalDateString=f.toFormat("yyyy-MM-dd"));let g=m.startOf("hour");m.minute>=30&&(g=g.plus({hours:1})),n.timestampToUseForWeather=g.toISO()}const r=(t.reduce((m,h,f)=>{if(f===0||!i.map)return 0;const g=t[f-1];return m+i.map.distance([g.lat,g.lng],[h.lat,h.lng])},0)/1e3).toFixed(2),s=t.map(m=>m.ele).filter(m=>m!==null),l=s.length?Math.min(...s).toFixed(0):"N/A",c=s.length?Math.max(...s).toFixed(0):"N/A",d=new CustomEvent("track:loaded",{detail:{lat:i.lastLat,lng:i.lastLng,altitude:i.lastAltitude,timestamp:n.timestampToUseForWeather,historicalDate:n.historicalDateString,summary:`<br><strong>Track:</strong> Distance: ${r} km, Min Elevation: ${l} m, Max Elevation: ${c} m (Source: ${e})`},bubbles:!0,cancelable:!0});i.map.getContainer().dispatchEvent(d)}i.gpxLayer=L.layerGroup([],{pane:"gpxTrackPane"});const a=i.lastAltitude!=="N/A"&&!isNaN(i.lastAltitude)?parseFloat(i.lastAltitude):null;for(let o=0;o<t.length-1;o++){const r=t[o],s=t[o+1],l=r.ele,c=s.ele;let d="#808080";if(a!==null&&l!==null&&c!==null){const h=l-a,f=c-a,g=(h+f)/2;d=p.interpolateColor(g)}const m=L.polyline([[r.lat,r.lng],[s.lat,s.lng]],{color:d,weight:4,opacity:.75,pane:"gpxTrackPane"}).bindTooltip("",{sticky:!0});m.on("mousemove",function(h){const f=h.latlng;let g=t[0],w=1/0,y=0;t.forEach((v,b)=>{const S=Math.sqrt(Math.pow(v.lat-f.lat,2)+Math.pow(v.lng-f.lng,2));S<w&&(w=S,g=v,y=b)}),m.setTooltipContent(fu(g,y,t,a)).openTooltip(f)}),i.gpxLayer.addLayer(m)}if(i.map&&i.gpxLayer.addTo(i.map),i.isTrackLoaded=!0,t.length>0&&i.map){const o=L.latLngBounds(t.map(r=>[r.lat,r.lng]));o.isValid()?i.map.fitBounds(o,{padding:[50,50],maxZoom:i.map.getMaxZoom()||18}):p.handleError("Unable to display track: invalid coordinates.")}return n.success=!0,console.log("[trackManager] renderTrack finished successfully."),n}catch(n){return console.error("[trackManager] Error in renderTrack:",n),p.handleError("Error rendering track: "+n.message),i.gpxPoints=[],i.gpxLayer&&i.map&&i.map.hasLayer(i.gpxLayer)&&i.map.removeLayer(i.gpxLayer),i.gpxLayer=null,i.isTrackLoaded=!1,{success:!1,error:n.message}}}function Ti(t){const n=`
        <div class="live-marker-wrapper" style="transform: rotate(${typeof t=="number"&&isFinite(t)?t:0}deg);">
            <div class="live-marker-dot"></div>
            <div class="live-marker-arrow"></div>
        </div>
    `;return L.divIcon({className:"live-marker-container",html:n,iconSize:[24,24],iconAnchor:[12,12]})}function yu(t,e,n){i.accuracyCircle&&i.map.removeLayer(i.accuracyCircle),i.accuracyCircle=L.circle([t,e],{radius:n,color:"blue",fillOpacity:.1,weight:1,dashArray:"5, 5"}).addTo(i.map)}const wu=p.debounce(async t=>{if(console.log("[LiveTrackingManager] Received position data:",t),!i.map){console.warn("[LiveTrackingManager] Map not initialized, skipping position update.");return}const{latitude:e,longitude:n,accuracy:a,altitude:o,altitudeAccuracy:r}=t.coords;if(console.log("[LiveTrackingManager] Position details:",{latitude:e,longitude:n,accuracy:a,deviceAltitude:o,altitudeAccuracy:r}),a>Y.GEOLOCATION_ACCURACY_THRESHOLD_M){console.log("[LiveTrackingManager] Skipping position update due to low accuracy:",a);return}const s=Date.now();let l=0,c="N/A";if(i.prevLat!==null&&i.prevLng!==null&&i.prevTime!==null){const h=i.map.distance([i.prevLat,i.prevLng],[e,n]),f=(s-i.prevTime)/1e3;f>Un.MIN_TIME_DIFF_FOR_SPEED_CALC_S&&(l=h/f,c=p.calculateBearing(i.prevLat,i.prevLng,e,n))}const d=l<Un.SPEED_SMOOTHING_TRESHOLD?Un.SPEED_SMOOTHING_LOW:Un.SPEED_SMOOTHING_HIGH;i.lastSmoothedSpeedMs=d*l+(1-d)*i.lastSmoothedSpeedMs,i.liveMarker?(i.liveMarker.setLatLng([e,n]),i.liveMarker.setIcon(Ti(c))):i.liveMarker=L.marker([e,n],{icon:Ti(c),zIndexOffset:1e3}).addTo(i.map),a&&yu(e,n,a),i.prevLat=e,i.prevLng=n,i.prevTime=s;const m=new CustomEvent("tracking:positionUpdated",{detail:{latitude:e,longitude:n,deviceAltitude:o,altitudeAccuracy:r,accuracy:a,speedMs:i.lastSmoothedSpeedMs,direction:typeof c=="number"?c.toFixed(0):"N/A"},bubbles:!0,cancelable:!0});console.log("[LiveTrackingManager] Dispatching tracking:positionUpdated event:",m.detail),document.dispatchEvent(m)},300);function Kr(){if(i.watchId===null){if(!navigator.geolocation){p.handleError("Geolocation is not supported by your browser."),document.dispatchEvent(new CustomEvent("tracking:stopped"));return}console.log("[LiveTrackingManager] Starting position tracking..."),i.watchId=navigator.geolocation.watchPosition(wu,t=>{p.handleError(`Geolocation error: ${t.message}`),Oo()},{enableHighAccuracy:!0,maximumAge:0,timeout:1e4}),document.dispatchEvent(new CustomEvent("tracking:started"))}}function Oo(){i.watchId!==null&&(navigator.geolocation.clearWatch(i.watchId),i.watchId=null),i.liveMarker&&i.map.removeLayer(i.liveMarker),i.accuracyCircle&&i.map.removeLayer(i.accuracyCircle),i.liveMarker=null,i.accuracyCircle=null,i.prevLat=null,i.prevLng=null,i.prevTime=null,i.lastSmoothedSpeedMs=0,document.dispatchEvent(new CustomEvent("tracking:stopped")),console.log("[LiveTrackingManager] Stopped position tracking and cleaned up.")}function _i(){if(i.autoupdateInterval){console.log("[AutoupdateManager] Autoupdate is already running.");return}if(!navigator.onLine){p.handleError("Cannot enable autoupdate while offline.");const t=document.getElementById("autoupdateCheckbox");t&&(t.checked=!1),u.state.userSettings.autoupdate=!1,u.save();return}console.log("[AutoupdateManager] Starting autoupdate interval."),document.dispatchEvent(new CustomEvent("autoupdate:tick",{detail:{isInitialTick:!0}})),i.autoupdateInterval=setInterval(()=>{console.log("[AutoupdateManager] Tick..."),document.dispatchEvent(new CustomEvent("autoupdate:tick",{detail:{isInitialTick:!1}}))},60*1e3),p.handleMessage("Autoupdate enabled")}function Uo(){i.autoupdateInterval&&(clearInterval(i.autoupdateInterval),i.autoupdateInterval=null,console.log("[AutoupdateManager] Stopped autoupdate interval."),displayMessage("Autoupdate disabled"))}function Yr(){var e;const t=document.getElementById("autoupdateCheckbox");if(!t){console.warn("[AutoupdateManager] Autoupdate checkbox not found.");return}t.checked=u.state.userSettings.autoupdate,t.addEventListener("change",()=>{u.state.userSettings.autoupdate=t.checked,u.save();const n=document.getElementById("historicalDatePicker");if(t.checked&&(n!=null&&n.value)){t.checked=!1,u.state.userSettings.autoupdate=!1,u.save(),p.handleError("Autoupdate cannot be enabled with a historical date set.");return}t.checked?_i():Uo()}),u.state.userSettings.autoupdate&&!((e=document.getElementById("historicalDatePicker"))!=null&&e.value)&&_i()}var Lu=15e3,yo=1e3,wo=60*yo,Vn=60*wo,ja=24*Vn,vu="http://www.topografix.com/GPX/gpx_style/0/2",Bn=new L.Icon.Default,Mu={startIcon:Bn,endIcon:Bn,wptIcons:{"":Bn},wptTypeIcons:{"":Bn},pointMatchers:[]},bu={iconSize:[33,45],iconAnchor:[16,45],clickable:!1},Su={color:"blue"},Eu={parseElements:["track","route","waypoint"],joinTrackSegments:!0};L.GPX=L.FeatureGroup.extend({initialize:function(t,e){e.max_point_interval=e.max_point_interval||Lu,e.markers=this._merge_objs(Mu,e.markers||{}),e.marker_options=this._merge_objs(bu,e.marker_options||{}),e.polyline_options=e.polyline_options||[],e.gpx_options=this._merge_objs(Eu,e.gpx_options||{}),L.Util.setOptions(this,e),L.GPXTrackIcon=L.Icon.extend({options:e.marker_options}),this._gpx=t,this._layers={},this._prepare_markers(e.markers),this._init_info(),t&&this._parse(t,e,this.options.async)},get_duration_string:function(t,e){var n="";t>=ja&&(n+=Math.floor(t/ja)+"d ",t=t%ja),t>=Vn&&(n+=Math.floor(t/Vn)+":",t=t%Vn);var a=Math.floor(t/wo);t=t%wo,a<10&&(n+="0"),n+=a+"'";var o=Math.floor(t/yo);return t=t%yo,o<10&&(n+="0"),n+=o,!e&&t>0?n+="."+Math.round(Math.floor(t)*1e3)/1e3:n+='"',n},get_duration_string_iso:function(t,e){var n=this.get_duration_string(t,e);return n.replace("'",":").replace('"',"")},_toFixed_helper:function(t,e=0){return typeof t=="number"?t.toFixed(e):"?"},to_miles:function(t){return t/1.60934},to_ft:function(t){return t*3.28084},m_to_km:function(t){return t/1e3},m_to_mi:function(t){return t/1609.34},ms_to_kmh:function(t){return t*3.6},ms_to_mih:function(t){return t/1609.34*3600},get_name:function(){return this._info.name},get_desc:function(){return this._info.desc},get_author:function(){return this._info.author},get_copyright:function(){return this._info.copyright},get_distance:function(){return this._info.length},get_distance_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))},get_start_time:function(){return this._info.duration.start},get_end_time:function(){return this._info.duration.end},get_moving_time:function(){return this._info.duration.moving},get_total_time:function(){return this._info.duration.total},get_moving_pace:function(){return this.get_moving_time()/this.m_to_km(this.get_distance())},get_moving_pace_imp:function(){return this.get_moving_time()/this.get_distance_imp()},get_moving_speed:function(){return this.m_to_km(this.get_distance())/(this.get_moving_time()/(3600*1e3))},get_moving_speed_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))/(this.get_moving_time()/(3600*1e3))},get_total_speed:function(){return this.m_to_km(this.get_distance())/(this.get_total_time()/(3600*1e3))},get_total_speed_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))/(this.get_total_time()/(3600*1e3))},get_elevation_gain:function(){return this._info.elevation.gain},get_elevation_loss:function(){return this._info.elevation.loss},get_elevation_gain_imp:function(){return this.to_ft(this.get_elevation_gain())},get_elevation_loss_imp:function(){return this.to_ft(this.get_elevation_loss())},get_elevation_data:function(){var t=this;return this._info.elevation._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" m"})})},get_elevation_data_imp:function(){var t=this;return this._info.elevation._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,t.to_ft,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" ft"})})},get_elevation_max:function(){return this._info.elevation.max},get_elevation_min:function(){return this._info.elevation.min},get_elevation_max_imp:function(){return this.to_ft(this.get_elevation_max())},get_elevation_min_imp:function(){return this.to_ft(this.get_elevation_min())},get_speed_data:function(){var t=this;return this._info.speed._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,t.ms_to_kmh,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,2)+" km/h"})})},get_speed_data_imp:function(){var t=this;return this._info.speed._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,t.ms_to_mih,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,2)+" mi/h"})})},get_speed_max:function(){return this.m_to_km(this._info.speed.max)*3600},get_speed_max_imp:function(){return this.to_miles(this.get_speed_max())},get_average_hr:function(){return this._info.hr.avg},get_average_temp:function(){return this._info.atemp.avg},get_average_cadence:function(){return this._info.cad.avg},get_heartrate_data:function(){var t=this;return this._info.hr._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" bpm"})})},get_heartrate_data_imp:function(){var t=this;return this._info.hr._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,null,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" bpm"})})},get_cadence_data:function(){var t=this;return this._info.cad._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" rpm"})})},get_temp_data:function(){var t=this;return this._info.atemp._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" degrees"})})},get_cadence_data_imp:function(){var t=this;return this._info.cad._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,null,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" rpm"})})},get_temp_data_imp:function(){var t=this;return this._info.atemp._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,null,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" degrees"})})},reload:function(){this._init_info(),this.clearLayers(),this._parse(this._gpx,this.options,this.options.async)},_merge_objs:function(t,e){var n={};for(var a in t)n[a]=t[a];for(var a in e)n[a]=e[a];return n},_prepare_data_point:function(t,e,n,a){var o=[e&&e(t[0])||t[0],n&&n(t[1])||t[1]];return o.push(a&&a(o[0],o[1])||o[0]+": "+o[1]),o},_prepare_markers:function(t){function e(n){return new L.GPXTrackIcon({iconUrl:n})}return Object.entries(t).forEach(([n,a])=>{n==="wptIcons"||n==="wptTypeIcons"?t[n]=this._prepare_markers(a):n==="pointMatchers"?t[n]=a.map(o=>(typeof o.icon=="string"&&(o.icon=e(o.icon)),o)):typeof a=="string"?t[n]=e(a):typeof a=="object"&&a!==null&&(t[n]=a)}),t},_init_info:function(){this._info={name:null,length:0,elevation:{gain:0,loss:0,max:0,min:1/0,_points:[]},speed:{max:0,_points:[]},hr:{avg:0,_total:0,_points:[]},duration:{start:null,end:null,moving:0,total:0},atemp:{avg:0,_total:0,_points:[]},cad:{avg:0,_total:0,_points:[]}}},_load_xml:function(t,e,n,a){a==null&&(a=this.options.async),n==null&&(n=this.options);var o=this,r=new window.XMLHttpRequest;r.open("GET",t,a);try{r.overrideMimeType("text/xml")}catch{}r.onloadend=function(){r.status==200?e(r.responseXML,n):o.fire("error",{err:"Error fetching resource: "+t})},r.send(null)},_parse:function(t,e,n){var a=this,o=function(s,l){var c=a._parse_gpx_data(s,l);if(!c){a.fire("error",{err:"No parseable layers of type(s) "+JSON.stringify(l.gpx_options.parseElements)});return}a.addLayer(c),a.fire("loaded",{layers:c,element:s})};if(t.substr(0,1)==="<"){var r=new DOMParser;n?setTimeout(function(){o(r.parseFromString(t,"text/xml"),e)}):o(r.parseFromString(t,"text/xml"),e)}else this._load_xml(t,o,e,n)},_parse_gpx_data:function(t,e){var n,a,o=[],r=t.getElementsByTagName("name");r.length>0&&(this._info.name=r[0].textContent);var s=t.getElementsByTagName("desc");s.length>0&&(this._info.desc=s[0].textContent);var l=t.getElementsByTagName("author");l.length>0&&(this._info.author=l[0].textContent);var c=t.getElementsByTagName("copyright");c.length>0&&(this._info.copyright=c[0].textContent);var d=e.gpx_options.parseElements;if(d.indexOf("route")>-1){var m=t.getElementsByTagName("rte");for(n=0;n<m.length;n++){var h=m[n],f=this._extract_styling(h),g=this._get_polyline_options(e.polyline_options,n);o=o.concat(this._parse_segment(m[n],e,f,g,"rtept"))}}if(d.indexOf("track")>-1){var w=t.getElementsByTagName("trk");for(n=0;n<w.length;n++){var y=w[n],f=this._extract_styling(y),g=this._get_polyline_options(e.polyline_options,n);if(e.gpx_options.joinTrackSegments)o=o.concat(this._parse_segment(y,e,f,g,"trkpt"));else{var v=y.getElementsByTagName("trkseg");for(x=0;x<v.length;x++)o=o.concat(this._parse_segment(v[x],e,f,g,"trkpt"))}}}if(this._info.hr.avg=Math.round(this._info.hr._total/this._info.hr._points.length),this._info.cad.avg=Math.round(this._info.cad._total/this._info.cad._points.length),this._info.atemp.avg=Math.round(this._info.atemp._total/this._info.atemp._points.length),d.indexOf("waypoint")>-1)for(a=t.getElementsByTagName("wpt"),n=0;n<a.length;n++){var b=new L.LatLng(a[n].getAttribute("lat"),a[n].getAttribute("lon")),S=a[n].getElementsByTagName("name"),r=S.length>0?S[0].textContent:"",E=a[n].getElementsByTagName("desc"),s=E.length>0?E[0].textContent:"",M=a[n].getElementsByTagName("sym"),k=M.length>0?M[0].textContent:null,_=a[n].getElementsByTagName("type"),C=_.length>0?_[0].textContent:null,T=e.markers.wptIcons,D=e.markers.wptTypeIcons,P=e.markers.pointMatchers||[],I;if(T&&k&&T[k])I=T[k];else if(D&&C&&D[C])I=D[C];else if(P.length>0){for(var x=0;x<P.length;x++)if(P[x].regex.test(r)){I=P[x].icon;break}}else T&&T[""]&&(I=T[""]);if(!I){console.log("No waypoint icon could be matched for symKey=%s,typeKey=%s,name=%s on waypoint %o",k,C,r,a[n]);continue}var R=new L.Marker(b,{clickable:e.marker_options.clickable,title:r,icon:I,type:"waypoint"});R.bindPopup("<b>"+r+"</b>"+(s.length>0?"<br>"+s:"")).openPopup(),this.fire("addpoint",{point:R,point_type:"waypoint",element:a[n]}),o.push(R)}if(o.length>1)return new L.FeatureGroup(o);if(o.length==1)return o[0]},_parse_segment:function(t,e,n,a,o){var r=t.getElementsByTagName(o);if(!r.length)return[];for(var s=[],l=[],c=[],d=null,m=0;m<r.length;m++){var h,f=new L.LatLng(r[m].getAttribute("lat"),r[m].getAttribute("lon"));f.meta={time:null,ele:null,hr:null,cad:null,atemp:null,speed:null},h=r[m].getElementsByTagName("time"),h.length>0?f.meta.time=new Date(Date.parse(h[0].textContent)):f.meta.time=new Date("1970-01-01T00:00:00");var g=d!=null?Math.abs(f.meta.time-d.meta.time):0;h=r[m].getElementsByTagName("ele"),h.length>0?f.meta.ele=parseFloat(h[0].textContent):f.meta.ele=d!=null?d.meta.ele:null;var w=d!=null?f.meta.ele-d.meta.ele:0,y=d!=null?this._dist3d(d,f):0;if(h=r[m].getElementsByTagName("speed"),h.length>0?f.meta.speed=parseFloat(h[0].textContent):f.meta.speed=g>0?1e3*y/g:0,h=r[m].getElementsByTagName("name"),h.length>0){for(var v=h[0].textContent,b=e.markers.pointMatchers||[],S=0;S<b.length;S++)if(b[S].regex.test(v)){l.push({label:v,coords:f,icon:b[S].icon,element:r[m]});break}}this._info.length+=y,h=r[m].getElementsByTagNameNS("*","hr"),h.length>0&&(f.meta.hr=parseInt(h[0].textContent),this._info.hr._points.push([this._info.length,f.meta.hr]),this._info.hr._total+=f.meta.hr),h=r[m].getElementsByTagNameNS("*","cad"),h.length>0&&(f.meta.cad=parseInt(h[0].textContent),this._info.cad._points.push([this._info.length,f.meta.cad]),this._info.cad._total+=f.meta.cad),h=r[m].getElementsByTagNameNS("*","atemp"),h.length>0&&(f.meta.atemp=parseInt(h[0].textContent),this._info.atemp._points.push([this._info.length,f.meta.atemp]),this._info.atemp._total+=f.meta.atemp),f.meta.ele>this._info.elevation.max&&(this._info.elevation.max=f.meta.ele),f.meta.ele<this._info.elevation.min&&(this._info.elevation.min=f.meta.ele),this._info.elevation._points.push([this._info.length,f.meta.ele]),f.meta.speed>this._info.speed.max&&(this._info.speed.max=f.meta.speed),this._info.speed._points.push([this._info.length,f.meta.speed]),d==null&&this._info.duration.start==null&&(this._info.duration.start=f.meta.time),this._info.duration.end=f.meta.time,this._info.duration.total+=g,g<e.max_point_interval&&(this._info.duration.moving+=g),w>0?this._info.elevation.gain+=w:this._info.elevation.loss+=Math.abs(w),d=f,s.push(f)}var E=new L.Polyline(s,this._extract_styling(t,n,a));if(this.fire("addline",{line:E,element:t}),c.push(E),e.markers.startIcon){var M=new L.Marker(s[0],{clickable:e.marker_options.clickable,icon:e.markers.startIcon});this.fire("addpoint",{point:M,point_type:"start",element:r[0],line:t}),c.push(M)}if(e.markers.endIcon){var M=new L.Marker(s[s.length-1],{clickable:e.marker_options.clickable,icon:e.markers.endIcon});this.fire("addpoint",{point:M,point_type:"end",element:r[r.length-1],line:t}),c.push(M)}for(var m=0;m<l.length;m++){var M=new L.Marker(l[m].coords,{clickable:e.marker_options.clickable,title:l[m].label,icon:l[m].icon});this.fire("addpoint",{point:M,point_type:"label",element:l[m].element}),c.push(M)}return c},_get_polyline_options:function(t,e){return Array.isArray(t)?t[e]||{}:t},_extract_styling:function(t,e,n){var a=this._merge_objs(Su,e),o=t.getElementsByTagNameNS(vu,"line");if(o.length>0){var r=o[0].getElementsByTagName("color");r.length>0&&(a.color="#"+r[0].textContent);var r=o[0].getElementsByTagName("opacity");r.length>0&&(a.opacity=r[0].textContent);var r=o[0].getElementsByTagName("weight");r.length>0&&(a.weight=r[0].textContent);var r=o[0].getElementsByTagName("linecap");r.length>0&&(a.lineCap=r[0].textContent);var r=o[0].getElementsByTagName("linejoin");r.length>0&&(a.lineJoin=r[0].textContent);var r=o[0].getElementsByTagName("dasharray");r.length>0&&(a.dashArray=r[0].textContent);var r=o[0].getElementsByTagName("dashoffset");r.length>0&&(a.dashOffset=r[0].textContent)}return this._merge_objs(a,n)},_dist2d:function(t,e){var n=6371e3,a=this._deg2rad(e.lat-t.lat),o=this._deg2rad(e.lng-t.lng),r=Math.sin(a/2)*Math.sin(a/2)+Math.cos(this._deg2rad(t.lat))*Math.cos(this._deg2rad(e.lat))*Math.sin(o/2)*Math.sin(o/2),s=2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r)),l=n*s;return l},_dist3d:function(t,e){var n=this._dist2d(t,e),a=Math.abs(e.meta.ele-t.meta.ele);return Math.sqrt(Math.pow(n,2)+Math.pow(a,2))},_deg2rad:function(t){return t*Math.PI/180}});let Ci=!1;function ku(t,e={}){console.log(`[EventManager] Dispatching event: ${t}`,e);const n=new CustomEvent(t,{detail:e,bubbles:!0,cancelable:!0});document.dispatchEvent(n)}function Tu(){const t=document.getElementById("tab-bar");if(!t)return;const e=()=>{const n=document.getElementById("planner-tab-button");n&&(u.isFeatureUnlocked("planner")?(n.style.opacity="1",n.title="Open Planner"):(n.style.opacity="0.5",n.title="Feature locked. Tap to enter password."))};e(),t.addEventListener("click",n=>{const a=n.target.closest(".tab-button");if(!a)return;const o=a.dataset.panel;if(o==="planner"&&!u.isFeatureUnlocked("planner")){u.showPasswordModal("planner",()=>{e(),document.querySelectorAll(".content-panel").forEach(r=>r.classList.add("hidden")),document.getElementById(`panel-${o}`).classList.remove("hidden"),document.querySelectorAll(".tab-button").forEach(r=>r.classList.remove("active")),a.classList.add("active")},()=>{});return}if(o==="map")document.querySelectorAll(".content-panel").forEach(r=>r.classList.add("hidden"));else{document.querySelectorAll(".content-panel").forEach(s=>s.classList.add("hidden"));const r=document.getElementById(`panel-${o}`);r&&r.classList.remove("hidden")}document.querySelectorAll(".tab-button").forEach(r=>r.classList.remove("active")),a.classList.add("active"),i.map&&setTimeout(()=>i.map.invalidateSize(),10)})}function _u(){const t=document.querySelectorAll(".accordion-header"),e=document.querySelectorAll(".accordion-item");t.forEach(n=>{n.addEventListener("click",()=>{const a=n.parentElement,o=a.classList.contains("active");e.forEach(r=>{r.classList.remove("active")}),o||a.classList.add("active")})})}function $t(t,e,n){console.log(`setupCheckbox called for id: ${t}`);const a=document.getElementById(t);a?(a._changeHandler&&(a.removeEventListener("change",a._changeHandler),console.log(`Removed previous change listener for ${t}`)),a._changeHandler=o=>{console.log(`Change event fired for ${t}, checked: ${a.checked}, event:`,o),o.stopPropagation(),n(a)},a.addEventListener("change",a._changeHandler),a.addEventListener("click",o=>{console.log(`Click event on ${t}, checked: ${a.checked}, target:`,o.target)}),console.log(`Attached change and click listeners to ${t}`),t==="showLandingPattern"&&!(u.isFeatureUnlocked("landingPattern")&&u.state.isLandingPatternUnlocked)&&(a.style.opacity="0.5",a.title="Feature locked. Click to enter password.")):console.warn(`Checkbox ${t} not found`)}function Za(t,e,n){if(console.log(`toggleSubmenu called for ${t.textContent||t.id}: ${n?"show":"hide"}`),e){e.classList.contains("submenu")||e.classList.add("submenu"),e.classList.toggle("hidden",!n),t.setAttribute("aria-expanded",n),console.log(`Submenu toggled for ${t.textContent||t.id}: ${n?"shown":"hidden"}`);let a=0;const o=5,r=()=>{const s={isHidden:e.classList.contains("hidden"),displayStyle:window.getComputedStyle(e).display};n&&(s.isHidden||s.displayStyle==="none")&&(console.warn(`Submenu for ${t.textContent||t.id} was hidden unexpectedly. Forcing it to be visible.`),e.classList.remove("hidden"),e.style.display="block",a++,a<o&&setTimeout(r,100))};setTimeout(r,100)}else console.warn(`Submenu for ${t.textContent||t.id} not found`)}function je(t,e){document.querySelectorAll(`input[name="${t}"]`).forEach(a=>{a.addEventListener("change",()=>{const o=u.getValue(t,"radio",u.defaultSettings[t]);if(u.state.userSettings[t]=o,u.save(),console.log(`${t} changed to: ${o} and saved to localStorage`),t==="landingDirection"){const r=document.getElementById("customLandingDirectionLL"),s=document.getElementById("customLandingDirectionRR");r&&(r.disabled=o!=="LL"),s&&(s.disabled=o!=="RR"),o==="LL"&&r&&!r.value&&u.state.userSettings.customLandingDirectionLL===""&&(r.value=Math.round(i.landingWindDir||0),u.state.userSettings.customLandingDirectionLL=parseInt(r.value),u.save(),console.log(`Set customLandingDirectionLL to ${r.value}`)),o==="RR"&&s&&!s.value&&u.state.userSettings.customLandingDirectionRR===""&&(s.value=Math.round(i.landingWindDir||0),u.state.userSettings.customLandingDirectionRR=parseInt(s.value),u.save(),console.log(`Set customLandingDirectionRR to ${s.value}`))}document.dispatchEvent(new CustomEvent("ui:radioGroupChanged",{detail:{name:t,value:o}})),e&&e()})})}function se(t,e,n,a){const o=document.getElementById(t);o&&o.addEventListener(e,p.debounce(()=>{const r=o.type==="number"?parseFloat(o.value):o.value;a&&a(r)===!1||(u.state.userSettings[t]=r,u.save(),console.log(`${t} changed to: ${r} and saved to localStorage`),document.dispatchEvent(new CustomEvent("ui:inputChanged",{detail:{name:t,value:r}})))},n))}function Cu(){console.log("setupMenuEvents wird aufgerufen für allgemeine Menü-Logik.");const t=document.getElementById("hamburgerBtn"),e=document.getElementById("menu");!t||!e||(t.addEventListener("click",n=>{n.stopPropagation(),e.classList.toggle("hidden")}),document.addEventListener("click",n=>{!e.contains(n.target)&&!t.contains(n.target)&&e.classList.add("hidden")}),e.addEventListener("click",n=>{const a=n.target;if(a.matches("li > span")||a.matches("li > label")){n.preventDefault(),n.stopPropagation();const r=a.closest("li").querySelector("ul.submenu");r&&r.classList.toggle("hidden")}}))}function Au(){if(!i.map){console.warn("Map not initialized, skipping setupCheckboxEvents");return}$t("showExitAreaCheckbox","showExitArea",o=>{u.state.userSettings.showExitArea=o.checked,u.save(),document.dispatchEvent(new CustomEvent("ui:jumpFeatureChanged"))}),$t("showCanopyAreaCheckbox","showCanopyArea",o=>{u.state.userSettings.showCanopyArea=o.checked,u.save(),document.dispatchEvent(new CustomEvent("ui:jumpFeatureChanged"))}),$t("showJumpRunTrack","showJumpRunTrack",o=>{u.state.userSettings.showJumpRunTrack=o.checked,u.save(),document.dispatchEvent(new CustomEvent("ui:showJumpRunTrackChanged",{detail:{checked:o.checked}}))}),$t("showCutAwayFinder","showCutAwayFinder",o=>{u.state.userSettings.showCutAwayFinder=o.checked,u.save(),document.dispatchEvent(new CustomEvent("ui:showCutAwayFinderChanged",{detail:{checked:o.checked}}))}),$t("showLandingPattern","showLandingPattern",o=>{const r="landingPattern",s=()=>{var d;u.state.userSettings.showLandingPattern=!0,u.save();const c=(d=o.closest("li"))==null?void 0:d.querySelector("ul");Za(o,c,!0),document.dispatchEvent(new CustomEvent("ui:landingPatternEnabled"))},l=()=>{var d;u.state.userSettings.showLandingPattern=!1,u.save(),o.checked=!1;const c=(d=o.closest("li"))==null?void 0:d.querySelector("ul");Za(o,c,!1),document.dispatchEvent(new CustomEvent("ui:landingPatternDisabled"))};o.checked?u.isFeatureUnlocked(r)?s():u.showPasswordModal(r,s,l):l()}),$t("trackPositionCheckbox","trackPosition",o=>{u.state.userSettings.trackPosition=o.checked,u.save(),document.dispatchEvent(new CustomEvent("ui:trackPositionToggled",{detail:{checked:o.checked}}))});const t=document.getElementById("showJumpMasterLine");t&&(t.disabled=!u.state.userSettings.trackPosition,t.style.opacity=t.disabled?"0.5":"1",t.addEventListener("change",()=>{var s;const o=t.checked;if(o&&t.disabled){t.checked=!1,p.handleError("Please start Live Tracking first.");return}u.state.userSettings.showJumpMasterLine=o,u.save(),ku("ui:showJumpMasterLineChanged",{isChecked:o});const r=(s=t.closest("li"))==null?void 0:s.querySelector("ul.submenu");r&&Za(t,r,o)})),je("jumpMasterLineTarget",()=>{const o=u.getValue("jumpMasterLineTarget","radio","DIP");u.state.userSettings.jumpMasterLineTarget=o,u.save(),console.log("jumpMasterLineTarget changed:",o),document.dispatchEvent(new CustomEvent("ui:jumpMasterLineTargetChanged"))});const e=document.getElementById("placeHarpButton");e&&e.addEventListener("click",()=>{i.isPlacingHarp=!0,console.log("HARP placement mode activated"),i.map.on("click",Vr),p.handleMessage("Click the map to place the HARP marker")});const n=document.getElementById("clearHarpButton");n&&n.addEventListener("click",du);const a=document.querySelector(".hamburger-menu");a&&a.addEventListener("click",o=>{console.log("Menu click:",o.target,"class:",o.target.className,"id:",o.target.id)})}function Iu(){const t=document.getElementById("timeSlider");t&&(t.addEventListener("input",()=>{document.dispatchEvent(new CustomEvent("ui:sliderChanged",{detail:{sliderValue:t.value},bubbles:!0,cancelable:!0}))}),t.addEventListener("change",async()=>{document.dispatchEvent(new CustomEvent("ui:sliderChangeFinished",{detail:{sliderValue:t.value},bubbles:!0,cancelable:!0}))}))}function Du(){const t=document.getElementById("modelSelect");t&&(t.addEventListener("change",()=>{const e=t.value;console.log("Model select changed to:",e),u.state.userSettings.model=e,u.save(),document.dispatchEvent(new CustomEvent("ui:modelChanged",{detail:{model:e}}))}),document.addEventListener("models:available",e=>{const{availableModels:n}=e.detail;Ac(n),Ju(n),Ic(n)}))}function Nu(){je("refLevel",()=>u.updateUnitLabels()),je("heightUnit",()=>{u.updateUnitLabels()}),je("temperatureUnit",()=>{}),je("windUnit",()=>{u.updateUnitLabels()}),je("timeZone",()=>{}),je("coordFormat",()=>{}),je("downloadFormat",()=>{}),je("landingDirection",()=>{}),je("jumpMasterLineTarget",()=>{document.dispatchEvent(new CustomEvent("ui:jumpMasterLineTargetChanged"))}),document.querySelectorAll('input[name="ensembleScenario"]').forEach(a=>{a.addEventListener("change",async()=>{if(a.checked){if(u.state.userSettings.currentEnsembleScenario=a.value,i.currentEnsembleScenario=a.value,u.save(),console.log("Ensemble scenario changed to:",a.value),!u.state.userSettings.selectedEnsembleModels.every(s=>i.ensembleModelsData&&i.ensembleModelsData[s])&&a.value!=="all_models"&&!await ca()){p.handleError("Failed to fetch data for scenario.");return}const r=me();ua(r)}})});const e=u.state.userSettings.currentEnsembleScenario||"all_models",n=document.querySelector(`input[name="ensembleScenario"][value="${e}"]`);n&&(n.checked=!0,i.currentEnsembleScenario=e),i.map&&!i.ensembleLayerGroup&&(i.ensembleLayerGroup=L.layerGroup().addTo(i.map))}function Fu(){const t=(e,n)=>{const a=document.getElementById(e);a&&a.addEventListener("blur",()=>{let o=parseInt(a.value)||n;const r=document.getElementById("legHeightFinal"),s=document.getElementById("legHeightBase"),l=document.getElementById("legHeightDownwind");if(!(!isNaN(o)&&o>=50&&o<=1e3&&p.validateLegHeights(r,s,l))){let d=n;const m=parseInt(r.value)||100,h=parseInt(s.value)||200,f=parseInt(l.value)||300;e==="legHeightFinal"&&(d=Math.min(h-1,100)),e==="legHeightBase"&&(d=Math.max(m+1,Math.min(f-1,200))),e==="legHeightDownwind"&&(d=Math.max(h+1,300)),a.value=d,o=d,p.handleError(`Adjusted ${e} to ${d} to maintain valid leg order.`)}u.state.userSettings[e]=o,u.save(),document.dispatchEvent(new CustomEvent("ui:inputChanged",{detail:{name:e,value:o}}))})};t("legHeightFinal",100),t("legHeightBase",200),t("legHeightDownwind",300),se("lowerLimit","change",300),se("upperLimit","change",300),se("openingAltitude","change",300,e=>isNaN(e)||e<500||e>15e3?(p.handleError("Opening altitude must be between 500 and 15000 meters."),document.dispatchEvent(new CustomEvent("ui:invalidInput",{detail:{id:"openingAltitude",defaultValue:1200}})),!1):!0),se("exitAltitude","change",300,e=>isNaN(e)||e<500||e>15e3?(p.handleError("Exit altitude must be between 500 and 15000 meters."),document.dispatchEvent(new CustomEvent("ui:invalidInput",{detail:{id:"exitAltitude",defaultValue:3e3}})),!1):!0),se("canopySpeed","change",300),se("descentRate","change",300),se("interpStepSelect","change",300),se("customLandingDirectionLL","input",100),se("customLandingDirectionRR","input",100),se("jumpRunTrackDirection","change",0),se("jumpRunTrackOffset","change",0),se("jumpRunTrackForwardOffset","change",0),se("aircraftSpeedKt","change",300),se("numberOfJumpers","change",300),se("jumperSeparation","change",300),se("cutAwayAltitude","change",300),se("historicalDatePicker","change",300)}function xu(){const t=document.getElementById("downloadButton");t&&t.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("ui:downloadClicked"))})}function Pu(){const t=document.getElementById("clearHistoricalDate");t&&t.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("ui:clearDateClicked"))})}function $u(){Jr(),console.log("Coordinate events setup complete.")}function Ru(){const t=document.querySelectorAll('input[name="cutAwayState"]');if(t.length===0)return;const e=u.state.userSettings.cutAwayState||"Partially",n=document.querySelector(`input[name="cutAwayState"][value="${e}"]`);n&&(n.checked=!0),t.forEach(a=>{a.addEventListener("change",()=>{a.checked&&(console.log(`Cut Away State changed to: ${a.value}`),u.state.userSettings.cutAwayState=a.value,u.save(),document.dispatchEvent(new CustomEvent("ui:recalculateJump")))})})}function Ou(){console.log("App: Richte Event-Listener für Track-Einstellungen ein.");const t=(a,o)=>{const r=document.getElementById(a);r&&(r.value=u.state.userSettings[o]||0,console.log(`Set ${a} to initial value:`,r.value),r.addEventListener("input",()=>{const s=parseFloat(r.value);isNaN(s)||(u.state.userSettings[o]=s,u.save(),xe())}))};t("numberOfJumpers","numberOfJumpers"),t("jumperSeparation","jumperSeparation"),t("jumpRunTrackOffset","jumpRunTrackOffset"),t("jumpRunTrackForwardOffset","jumpRunTrackForwardOffset");const e=document.getElementById("jumpRunTrackDirection");e&&(e.value=u.state.userSettings.customJumpRunDirection||"",e.addEventListener("change",()=>{const a=parseFloat(e.value);Number.isFinite(a)&&a>=0&&a<=359?(u.state.userSettings.customJumpRunDirection=a,console.log("Setting 'customJumpRunDirection' on change to:",a)):(u.state.userSettings.customJumpRunDirection=null,e.value="",console.log("Invalid direction, resetting to calculated.")),u.save(),xe()}));const n=document.getElementById("showJumpRunTrack");n&&n.addEventListener("change",a=>{u.state.userSettings.showJumpRunTrack=a.target.checked,u.save(),xe()})}function Uu(){if(console.log("App: Richte Event-Listener für Karten-Events ein."),!i.map){console.error("Karte nicht initialisiert, Event-Listener können nicht gesetzt werden.");return}const t=()=>{document.dispatchEvent(new CustomEvent("map:moved"))},e=p.debounce(()=>{tn({map:i.map,baseMaps:i.baseMaps,onProgress:En,onComplete:n=>{Ke(),n&&p.handleMessage(n)},onCancel:()=>{Ke(),p.handleMessage("Caching cancelled.")}})},1e3);p.debounce(t,500),i.map.on("zoomend",t),i.map.on("moveend",t),i.map.on("moveend",e)}function Hu(){const t=document.getElementById("resetCutAwayMarker");t&&t.addEventListener("click",()=>{if(!i.map){console.warn("Map not initialized, cannot reset cut-away marker");return}i.cutAwayMarker&&(i.map.removeLayer(i.cutAwayMarker),i.cutAwayMarker=null,i.cutAwayLat=null,i.cutAwayLng=null,console.log("Cut-away marker reset"),i.cutAwayCircle&&(i.map.removeLayer(i.cutAwayCircle),i.cutAwayCircle=null,console.log("Cleared cut-away circle")),document.getElementById("info").innerHTML="Right-click map to place cut-away marker")})}function Bu(){console.log("[app.js] Setting up track events");const t=document.getElementById("trackFileInput"),e=document.getElementById("loading");t&&t.addEventListener("change",async a=>{const o=a.target.files[0];if(e&&(e.style.display="block"),!o){p.handleError("No file selected."),e&&(e.style.display="none");return}const r=o.name.split(".").pop().toLowerCase();let s=null;try{r==="gpx"?s=await jr(o):r==="csv"?s=await Zr(o):(p.handleError("Unsupported file type. Please upload a .gpx or .csv file."),e&&(e.style.display="none"))}catch(l){console.error("Error during track file processing:",l),p.handleError("Failed to process track file."),e&&(e.style.display="none")}});const n=document.getElementById("clearTrack");n&&n.addEventListener("click",()=>{if(!i.map){p.handleError("Cannot clear track: map not initialized.");return}if(i.gpxLayer)try{i.map.hasLayer(i.gpxLayer)&&i.map.removeLayer(i.gpxLayer),i.gpxLayer=null,i.gpxPoints=[],i.isTrackLoaded=!1;const a=document.getElementById("info");if(a){const o=/(<br><strong>Available Models:<\/strong><ul>.*?<\/ul>|<br><strong>Available Models:<\/strong> None)/s,s=a.innerHTML.match(o);a.innerHTML="Click on the map to fetch weather data."+(s?s[0]:"")}t&&(t.value="")}catch(a){p.handleError("Failed to clear track: "+a.message)}else p.handleMessage("No track to clear.")})}function Wu(){const t=document.getElementById("bottom-container");if(!t){console.error("Bottom container not found; cannot create settings/cache buttons.");return}const e=document.createElement("div");e.id="settings-cache-buttons",e.className="button-wrapper";const n=document.createElement("button");n.id="resetButton",n.textContent="Reset Settings",n.title="Resets all settings to their default values and locks all features",n.addEventListener("click",()=>{confirm("Are you sure you want to reset all settings and lock all features?")&&(localStorage.removeItem("unlockedFeatures"),localStorage.removeItem("upperWindsSettings"),window.location.reload())}),e.appendChild(n);const a=document.createElement("button");a.id="clearCacheButton",a.textContent="Clear Tile Cache",a.title="Clears cached map tiles. Pan/zoom to cache more tiles for offline use.",a.addEventListener("click",async()=>{try{const o=await oe.getCacheSize();await oe.clearCache(),p.handleMessage(`Tile cache cleared successfully (freed ${o.toFixed(2)} MB).`),console.log("Tile cache cleared")}catch(o){p.handleError("Failed to clear tile cache: "+o.message)}}),e.appendChild(a),t.appendChild(e)}function zu(){const t=document.getElementById("cacheRadiusSelect");t?(t.addEventListener("change",()=>{if(!u.state||!u.state.userSettings){console.error("Settings not properly initialized");return}u.state.userSettings.cacheRadiusKm=parseInt(t.value,10),u.save(),console.log("Updated cacheRadiusKm:",u.state.userSettings.cacheRadiusKm)}),console.log("cacheRadiusSelect listener attached, initial value:",t.value)):console.warn("cacheRadiusSelect not found in DOM");const e=document.getElementById("cacheZoomLevelsSelect");e?(e.addEventListener("change",()=>{const[a,o]=e.value.split("-").map(Number);u.state.userSettings.cacheZoomLevels=Array.from({length:o-a+1},(r,s)=>a+s),u.save(),console.log("Updated cacheZoomLevels:",u.state.userSettings.cacheZoomLevels)}),console.log("cacheZoomLevelsSelect listener attached, initial value:",e.value)):console.warn("cacheZoomLevelsSelect not found in DOM");const n=document.getElementById("recacheNowButton");n?(n.addEventListener("click",()=>{da({map:i.map,lastLat:i.lastLat,lastLng:i.lastLng,baseMaps:i.baseMaps,onProgress:En,onComplete:a=>{Ke(),a&&ft(a)},onCancel:()=>{Ke(),ft("Caching cancelled.")}})}),console.log("recacheNowButton listener attached")):console.warn("recacheNowButton not found in DOM")}function Gu(){console.log("Setting up settings panel interactions...");const t=(e,n)=>{const a=document.getElementById(e);if(!a){console.error(`Settings element not found: #${e}`);return}let o=u.state.userSettings;const r=n.split(".");r.forEach(s=>{o=o?o[s]:void 0}),o!==void 0&&(a.value=o),a.addEventListener("change",s=>{let l=u.state.userSettings;for(let d=0;d<r.length-1;d++){const m=r[d];(l[m]===void 0||typeof l[m]!="object")&&(console.warn(`Creating missing settings path: ${m}`),l[m]={}),l=l[m]}const c=r[r.length-1];l?(l[c]=s.target.value,u.save(),console.log(`Setting '${n}' changed to:`,s.target.value),document.dispatchEvent(new CustomEvent("setting:changed",{detail:{key:n,value:s.target.value}}))):console.error(`Failed to save setting. Parent object for path '${n}' is not valid.`)})};t("refLevel","units.refLevel"),t("heightUnit","units.heightUnit"),t("temperatureUnit","units.temperatureUnit"),t("windUnit","units.windUnit"),t("timeZone","timeZone"),t("coordFormat","coordFormat"),t("downloadFormat","downloadFormat"),t("cacheRadiusSelect","cache.radius"),t("cacheZoomLevelsSelect","cache.zoomLevels")}function Vu(){document.querySelectorAll(".info-icon").forEach(e=>{e.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation();const a=e.dataset.info;a&&alert(a)})})}function Ju(t){const e=document.getElementById("ensembleModelsSubmenu");e&&(e.innerHTML="",t.forEach(n=>{const a=document.createElement("li"),o=document.createElement("label");o.className="radio-label";const r=document.createElement("input");r.type="checkbox",r.name="ensembleModel",r.value=n,r.checked=u.state.userSettings.selectedEnsembleModels.includes(n),r.addEventListener("change",async()=>{const s=Array.from(e.querySelectorAll("input:checked")).map(c=>c.value);if(u.state.userSettings.selectedEnsembleModels=s,u.save(),await ca()){const c=me();ua(c)}}),o.append(r,` ${n.replace(/_/g," ").toUpperCase()}`),a.appendChild(o),e.appendChild(a)}))}function ju(){Ci||(console.log("Initializing all UI event listeners..."),Cu(),Au(),Iu(),Du(),Nu(),Fu(),xu(),Bu(),Pu(),$u(),Ru(),Ou(),Uu(),Hu(),Wu(),zu(),Tu(),_u(),Gu(),Vu(),Ci=!0,console.log("Event listeners initialized successfully (first and only time)."))}const Lo=()=>u.getValue("heightUnit","radio","m"),Zu=()=>u.getValue("windUnit","radio","kt"),qu=()=>u.getValue("coordFormat","radio","Decimal"),Xr=p.debounce(De,300),Ku=()=>u.getValue("downloadFormat","radio","csv");p.setErrorHandler(Xn);p.setMessageHandler(ft);p.handleMessage=ft;L.Control.Coordinates=L.Control.extend({options:{position:"bottomleft"},onAdd:function(t){var e=L.DomUtil.create("div","leaflet-control-coordinates");return e.style.background="rgba(255, 255, 255, 0.8)",e.style.padding="5px",e.style.borderRadius="4px",e.style.boxShadow="0 2px 5px rgba(0, 0, 0, 0.2)",e.innerHTML="Move mouse over map",this._container=e,e},update:function(t){this._container.innerHTML=t}});let qa=new Map,Ka=new Map;const Ho=p.debounce(async(t,e,n,a)=>{var d,m,h,f;const o=`${t.toFixed(5)},${e.toFixed(5)}`,r=me(),s=`${o}-${r}`;let l,c;if(qa.has(o))l=qa.get(o);else try{l=await p.getAltitude(t,e),qa.set(o,l)}catch(g){console.warn("Failed to fetch elevation:",g),l="N/A"}if(Ka.has(s))c=Ka.get(s);else if(i.weatherData&&i.weatherData.surface_pressure&&r>=0&&r<i.weatherData.surface_pressure.length){const g=i.weatherData.surface_pressure[r],w=((d=i.weatherData.temperature_2m)==null?void 0:d[r])||16.1,y=i.lastAltitude!=="N/A"?i.lastAltitude:339;c=p.calculateQFE(g,l,y,w),Ka.set(s,c),console.log("Calculated QFE:",{lat:t,lng:e,surfacePressure:g,elevation:l,referenceElevation:y,temperature:w,qfe:c})}else console.warn("Surface pressure not available for QFE:",{hasWeatherData:!!i.weatherData,hasSurfacePressure:!!((m=i.weatherData)!=null&&m.surface_pressure),sliderIndexValid:r>=0&&r<(((f=(h=i.weatherData)==null?void 0:h.surface_pressure)==null?void 0:f.length)||0)}),c="N/A";a({elevation:l,qfe:c},n)},500);function Wt(){var C;console.log("Calculating mean wind with model:",document.getElementById("modelSelect").value,"weatherData:",i.weatherData);const t=((C=document.querySelector('input[name="refLevel"]:checked'))==null?void 0:C.value)||"AGL",e=u.getValue("heightUnit","radio","m"),n=u.getValue("windUnit","radio","kt"),a=document.getElementById("timeSlider").value||0,o=_e(i.weatherData,a,Te(),Math.round(i.lastAltitude),e);let r=parseFloat(document.getElementById("lowerLimit").value)||0,s=parseFloat(document.getElementById("upperLimit").value);const l=Math.round(i.lastAltitude);if(!i.weatherData||i.lastAltitude==="N/A"){p.handleError("Cannot calculate mean wind: missing data or altitude");return}r=e==="ft"?r/3.28084:r,s=e==="ft"?s/3.28084:s;let c=t==="AGL"?r+l:r,d=t==="AGL"?s+l:s;if(isNaN(r)||isNaN(s)||r>=s){p.handleError("Invalid layer limits. Ensure Lower < Upper and both are numbers.");return}if(t==="AMSL"&&d<l){p.handleError(`The entire selected layer (${Math.round(p.convertHeight(c,e))}-${Math.round(p.convertHeight(d,e))} ${e}) is below the terrain altitude of ${Math.round(p.convertHeight(l,e))} ${e}.`),document.getElementById("meanWindResult").innerHTML="Mean wind: N/A (Layer is below ground)";return}if(t==="AMSL"&&c<l){p.handleMessage(`Note: Lower limit adjusted to terrain altitude (${Math.round(p.convertHeight(l,e))} ${e}) as it cannot be below ground level.`);const T=Math.round(p.convertHeight(l,e));ne("lowerLimit",T),u.state.userSettings.lowerLimit=T,u.save(),c=l}if(!o||o.length===0){p.handleError("No valid weather data available to calculate mean wind.");return}const m=o.map(T=>T.height),h=o.map(T=>parseFloat(T.dir)||0),f=o.map(T=>p.convertWind(parseFloat(T.spd)||0,n,"km/h")),g=f.map((T,D)=>-T*Math.sin(h[D]*Math.PI/180)),w=f.map((T,D)=>-T*Math.cos(h[D]*Math.PI/180)),y=p.calculateMeanWind(m,g,w,c,d),[v,b]=y,S=p.roundToTens(v)===0&&v>=0&&v<5?360:p.roundToTens(v),E=Math.round(p.convertHeight(r,e)),M=Math.round(p.convertHeight(s,e));p.convertWind(b,n,"kt");const k=Number.isFinite(b)?n==="bft"?Math.round(b):b.toFixed(1):"N/A",_=`Mean wind (${E}-${M} ${e} ${t}): ${S}° ${k} ${n}`;document.getElementById("meanWindResult").innerHTML=_,console.log("Calculated Mean Wind:",_,"u:",y[2],"v:",y[3])}function Yu(t){var w;if(!i.weatherData||!i.weatherData.time){p.handleError("No weather data available to download.");return}const e=document.getElementById("timeSlider").value||0,n=document.getElementById("modelSelect").value.toUpperCase(),a=p.formatTime(i.weatherData.time[e]).replace(" ","_"),o=`${a}_${n}_${t}.txt`,s={ATAK:{interpStep:1e3,heightUnit:"ft",refLevel:"AGL",windUnit:"kt"},Windwatch:{interpStep:100,heightUnit:"ft",refLevel:"AGL",windUnit:"km/h"},HEIDIS:{interpStep:100,heightUnit:"m",refLevel:"AGL",temperatureUnit:"C",windUnit:"m/s"},Customized:{}}[t]||{},l={interpStep:s.interpStep||Te(),heightUnit:s.heightUnit||u.getValue("heightUnit","radio","m"),refLevel:s.refLevel||((w=document.querySelector('input[name="refLevel"]:checked'))==null?void 0:w.value)||"AGL",windUnit:s.windUnit||u.getValue("windUnit","radio","kt"),temperatureUnit:s.temperatureUnit||u.getValue("temperatureUnit","radio","C")};console.log(`Generating export for '${t}' with settings:`,l);const c=_e(i.weatherData,e,l.interpStep,Math.round(i.lastAltitude),l.heightUnit);if(!c||c.length===0){p.handleError("No interpolated data available to download.");return}let d="",m="";switch(t){case"ATAK":m=`Alt Dir Spd
${l.heightUnit}${l.refLevel}
`;break;case"Windwatch":const y=Math.round(p.convertHeight(i.lastAltitude,"ft"));m=`Version 1.0, ID = 9999999999
${a}, Ground Level: ${y} ft
Windsond ${n}
AGL[ft] Wind[°] Speed[km/h]
`;break;case"HEIDIS":case"Customized":default:m=`h(${l.heightUnit}${l.refLevel}) p(hPa) T(${l.temperatureUnit}) Dew(${l.temperatureUnit}) Dir(°) Spd(${l.windUnit}) RH(%)
`;break}d+=m,c.forEach(y=>{const v=Math.round(y.displayHeight),b=Math.round(y.dir),S=p.convertWind(y.spd,l.windUnit,"km/h"),E=Number.isFinite(S)?l.windUnit==="bft"?Math.round(S):S.toFixed(1):"N/A";if(t==="ATAK"||t==="Windwatch")d+=`${v} ${b} ${Math.round(S)}
`;else{const M=y.pressure==="N/A"?"N/A":y.pressure.toFixed(1),k=p.convertTemperature(y.temp,l.temperatureUnit),_=k==="N/A"?"N/A":k.toFixed(1),C=p.convertTemperature(y.dew,l.temperatureUnit),T=C==="N/A"?"N/A":C.toFixed(1),D=y.rh==="N/A"?"N/A":Math.round(y.rh);d+=`${v} ${M} ${_} ${T} ${b} ${E} ${D}
`}});const h=new Blob([d],{type:"text/plain"}),f=window.URL.createObjectURL(h),g=document.createElement("a");g.href=f,g.download=o,document.body.appendChild(g),g.click(),document.body.removeChild(g),window.URL.revokeObjectURL(f)}async function Xu(){if(!i.lastLat||!i.lastLng){console.warn("No location selected, cannot update weather data"),p.handleError("Please select a location to enable autoupdate."),stopAutoupdate(),document.getElementById("autoupdateCheckbox").checked=!1,u.state.userSettings.autoupdate=!1,u.save();return}if(!navigator.onLine){console.warn("Cannot update weather data: offline"),p.handleError("Cannot update weather data while offline."),stopAutoupdate(),document.getElementById("autoupdateCheckbox").checked=!1,u.state.userSettings.autoupdate=!1,u.save();return}const t=document.getElementById("timeSlider");if(!t){console.warn("Time slider not found, cannot update to current hour");return}const n=new Date().getUTCHours();t.value=n,console.log(`Set slider to current hour: ${n}`);try{await Me(i.lastLat,i.lastLng,null,!1),console.log("Weather data fetched for current hour"),await kt(n,"weather-table-container","selectedTime"),i.lastAltitude!=="N/A"&&Wt(),u.state.userSettings.calculateJump&&u.state.isCalculateJumpUnlocked&&(Xr(),en(),u.state.userSettings.showJumpRunTrack&&xe()),console.log("Updated all displays for current hour")}catch(a){console.error("Error updating to current hour:",a),p.handleError("Failed to update weather data: "+a.message)}}function De(){const t=me(),e=Te(),n=Lo();let a=u.state.userSettings.openingAltitude,o=u.state.userSettings.exitAltitude;if(n==="ft"&&(a=p.convertFeetToMeters(a),o=p.convertFeetToMeters(o)),!u.state.isCalculateJumpUnlocked||!u.state.userSettings.calculateJump){Gn(null),fo(null);return}if(!i.weatherData||!i.lastLat||!i.lastLng){Gn(null);return}me();const r=_e(i.weatherData,t,e,Math.round(i.lastAltitude),n),s={exitCircles:[],canopyCircles:[],canopyLabels:[]};if(u.state.userSettings.showExitArea){const c=Fo(r);if(c){s.exitCircles.push({center:[c.greenLat,c.greenLng],radius:c.greenRadius,color:"green",fillColor:"green",fillOpacity:.2,weight:2});const d=`
                Exit areas calculated with:<br>
                Throw/Drift: ${Number.isFinite(c.freeFallDirection)?Math.round(c.freeFallDirection):"N/A"}° ${Number.isFinite(c.freeFallDistance)?Math.round(c.freeFallDistance):"N/A"} m<br>
                Free Fall Time: ${c.freeFallTime!=null&&!isNaN(c.freeFallTime)?Math.round(c.freeFallTime):"N/A"} sec
            `;s.exitCircles.push({center:[c.darkGreenLat,c.darkGreenLng],radius:c.darkGreenRadius,color:"darkgreen",fillColor:"darkgreen",fillOpacity:.2,weight:2,tooltip:d})}}if(u.state.userSettings.showCanopyArea){const c=Wr(r);if(c){const d=p.calculateNewCenter(c.redLat,c.redLng,c.displacementFull,c.directionFull);s.canopyCircles.push({center:d,radius:c.radiusFull,color:"red",weight:2,opacity:.8,fillOpacity:0}),c.additionalBlueRadii.forEach((m,h)=>{const f=p.calculateNewCenter(c.blueLat,c.blueLng,c.additionalBlueDisplacements[h],c.additionalBlueDirections[h]);s.canopyCircles.push({center:f,radius:m,color:"blue",weight:1,fillColor:"blue",fillOpacity:.1,opacity:1}),s.canopyLabels.push({center:f,radius:m,text:`${Math.round(c.additionalBlueUpperLimits[h])}m`})})}}Gn(s);let l=null;if(u.state.userSettings.showCutAwayFinder&&i.cutAwayLat!==null){const c=en(r);c&&(l={center:c.center,radius:c.radius,tooltipContent:c.tooltipContent})}fo(l)}function Qu(t=!0){i.customJumpRunDirection=null;const e=document.getElementById("jumpRunTrackDirection");e&&(e.value="",console.log("Cleared jumpRunTrackDirection input")),console.log("Reset JRT direction to calculated"),t&&u.state.userSettings.showJumpRunTrack&&i.weatherData&&i.lastLat&&i.lastLng&&(console.log("Triggering JRT update after reset"),xe())}function ed(){return!u.state.userSettings.showJumpRunTrack||!u.state.userSettings.calculateJump||!i.weatherData||!i.lastLat||!i.lastLng?(console.log("Skipping calculateJumpRunTrack: conditions not met"),null):(console.log("Calculating jump run track..."),xe(),Dt())}function ot(t=null){if(!i.liveMarker){ki(),lu();return}const e=i.liveMarker.getLatLng();if(!e)return;const n=t||{latitude:e.lat,longitude:e.lng,speedMs:i.lastSmoothedSpeedMs,direction:i.lastDirection,deviceAltitude:i.lastDeviceAltitude,altitudeAccuracy:i.lastAltitudeAccuracy,accuracy:i.lastAccuracy},a=u.state.userSettings.showJumpMasterLine;let o=null;if(a){let s=null,l="";if(u.state.userSettings.jumpMasterLineTarget==="HARP"&&i.harpMarker?(s=i.harpMarker.getLatLng(),l="HARP"):i.currentMarker&&(s=i.currentMarker.getLatLng(),l="DIP"),s){const c=i.map.distance(e,s),d=Math.round(p.calculateBearing(e.lat,e.lng,s.lat,s.lng)),m=n.speedMs>1?n.speedMs:1,h=Math.round(c/m);o={distance:c,bearing:d,tot:h,target:l},su(e,s)}}else ki();const r={heightUnit:u.getValue("heightUnit","radio","m"),effectiveWindUnit:u.getValue("windUnit","radio","kt")==="bft"?"kt":u.getValue("windUnit","radio","kt"),coordFormat:u.getValue("coordFormat","radio","Decimal"),refLevel:u.getValue("refLevel","radio","AGL")};cu({...n,showJumpMasterLine:a,jumpMasterLineData:o,...r})}function td(){if(u.initialize(),u.state.isLandingPatternUnlocked=u.state.unlockedFeatures.landingPattern,u.state.isCalculateJumpUnlocked=u.state.unlockedFeatures.calculateJump,u.state.userSettings.showJumpMasterLine=!1,console.log("Initial unlock status:",{isLandingPatternUnlocked:u.state.isLandingPatternUnlocked,isCalculateJumpUnlocked:u.state.isCalculateJumpUnlocked}),i.isInitialized){console.log("App already initialized, skipping");return}i.isInitialized=!0,console.log("Initializing app")}function nd(){ne("canopySpeed",u.state.userSettings.canopySpeed),ne("descentRate",u.state.userSettings.descentRate),ne("legHeightDownwind",u.state.userSettings.legHeightDownwind),ne("legHeightBase",u.state.userSettings.legHeightBase),ne("legHeightFinal",u.state.userSettings.legHeightFinal),ne("customLandingDirectionLL",u.state.userSettings.customLandingDirectionLL),ne("customLandingDirectionRR",u.state.userSettings.customLandingDirectionRR),ne("lowerLimit",u.state.userSettings.lowerLimit),ne("upperLimit",u.state.userSettings.upperLimit),ne("openingAltitude",u.state.userSettings.openingAltitude),ne("exitAltitude",u.state.userSettings.exitAltitude),ne("interpStepSelect",u.state.userSettings.interpStep),ne("aircraftSpeedKt",u.state.userSettings.aircraftSpeedKt),ne("jumpRunTrackOffset",u.state.userSettings.jumpRunTrackOffset),ne("numberOfJumpers",u.state.userSettings.numberOfJumpers),Rt("showTableCheckbox",u.state.userSettings.showTable),Rt("calculateJumpCheckbox",u.state.userSettings.calculateJump),Rt("showLandingPattern",u.state.userSettings.showLandingPattern),Rt("showJumpRunTrack",u.state.userSettings.showJumpRunTrack),Rt("showCanopyAreaCheckbox",u.state.userSettings.showCanopyArea),Rt("showExitAreaCheckbox",u.state.userSettings.showExitArea),u.state.userSettings.isCustomJumpRunDirection=u.state.userSettings.isCustomJumpRunDirection||!1;const t=document.getElementById("customLandingDirectionLL"),e=document.getElementById("customLandingDirectionRR");t&&u.state.userSettings.customLandingDirectionLL!==""&&!isNaN(u.state.userSettings.customLandingDirectionLL)&&(t.value=u.state.userSettings.customLandingDirectionLL),e&&u.state.userSettings.customLandingDirectionRR!==""&&!isNaN(u.state.userSettings.customLandingDirectionRR)&&(e.value=u.state.userSettings.customLandingDirectionRR);const n=la(u.state.userSettings.aircraftSpeedKt);ne("jumperSeparation",n),u.state.userSettings.jumperSeparation=n,u.save();const a=document.getElementById("showLandingPattern"),o=document.getElementById("calculateJumpCheckbox");a&&(a.title=u.isFeatureUnlocked("landingPattern")&&u.state.isLandingPatternUnlocked?"":"Feature locked. Click to enter password.",a.style.opacity=u.isFeatureUnlocked("landingPattern")&&u.state.isLandingPatternUnlocked?"1":"0.5",console.log("Initialized showLandingPattern UI:",{checked:a.checked,opacity:a.style.opacity})),o&&(o.title=u.isFeatureUnlocked("calculateJump")&&u.state.isCalculateJumpUnlocked?"":"Feature locked. Click to enter password.",o.style.opacity=u.isFeatureUnlocked("calculateJump")&&u.state.isCalculateJumpUnlocked?"1":"0.5",console.log("Initialized calculateJumpCheckbox UI:",{checked:o.checked,opacity:o.style.opacity}));const r=document.getElementById("showJumpMasterLine");r&&(r.disabled=!u.state.userSettings.trackPosition,r.style.opacity=r.disabled?"0.5":"1",r.title=r.disabled?"Enable Live Tracking to use Jump Master Line":"");const s=document.getElementById("jumpRunTrackDirection");s&&(s.textContent="-"),Qr()}function Qr(){const t=document.getElementById("info");t&&(t.style.display=u.state.userSettings.showTable?"block":"none");const e=document.getElementById("customLandingDirectionLL"),n=document.getElementById("customLandingDirectionRR"),a=document.getElementById("showJumpRunTrack"),o=document.getElementById("showExitAreaCheckbox");e&&(e.disabled=u.state.userSettings.landingDirection!=="LL"),n&&(n.disabled=u.state.userSettings.landingDirection!=="RR"),a&&(a.disabled=!u.state.userSettings.calculateJump),o&&(o.disabled=!u.state.userSettings.calculateJump),u.updateUnitLabels()}async function Ln(t,e=null){i.weatherData=t;const n=document.getElementById("timeSlider");if(!n)return;const o=(r=>{const s=r==null?void 0:r.temperature_2m;if(!s||s.length===0)return 0;for(let l=s.length-1;l>=0;l--)if(s[l]!==null&&s[l]!==void 0)return l;return 0})(t);if(n.max=o,n.disabled=n.max<=0,e!==null&&e<=o)n.value=e,console.log(`Slider restored to preserved index: ${e}`);else{const r=new Date().getUTCHours();r<=o?n.value=r:n.value=o,console.log(`Slider set to default (current hour or max): ${n.value}`)}await kt(n.value,"weather-table-container","selectedTime"),await Bt(),i.lastAltitude!=="N/A"&&Wt(),u.updateModelRunInfo(i.lastModelRun,i.lastLat,i.lastLng)}function Rt(t,e){const n=document.getElementById(t);n&&(n.checked=e)}function ne(t,e){const n=document.getElementById(t);n&&(n.value=e)}function vo(t,e){const n=document.getElementById(t);if(n){const a=n.value;n.value=e,console.log(`Set ${t} silently:`,{old:a,new:e})}}function ad(){console.log("[App] Setting up application event listeners..."),document.addEventListener("map:moved",()=>{console.log("[main-mobile] Map has moved or zoomed. Updating visualizations based on new view.");const t=i.map.getZoom();u.state.userSettings.calculateJump&&i.weatherData&&i.lastLat&&(t>=Y.MIN_ZOOM&&t<=Y.MAX_ZOOM?De():Gn(null)),u.state.userSettings.showJumpRunTrack&&(t>=Y.MIN_ZOOM&&t<=Y.MAX_ZOOM?xe():wn(null)),u.state.userSettings.showLandingPattern&&nt(),tn({map:i.map,baseMaps:i.baseMaps,onProgress:En,onComplete:e=>{Ke(),e&&p.handleMessage(e)},onCancel:()=>{Ke(),p.handleMessage("Caching cancelled.")}})}),document.addEventListener("map:location_selected",async t=>{const{lat:e,lng:n,source:a}=t.detail;console.log(`App: Event 'map:location_selected' von '${a}' empfangen.`),i.lastLat=e,i.lastLng=n,i.lastAltitude=await p.getAltitude(e,n),ha(e,n),Qu(!0),await Me(e,n),u.state.userSettings.calculateJump&&(De(),en()),ea(!0),i.isManualPanning=!1,xe(),nt()}),document.addEventListener("tracking:started",()=>{const t=document.getElementById("showJumpMasterLine");t&&(t.disabled=!1,t.style.opacity="1",t.title="")}),document.addEventListener("tracking:stopped",()=>{const t=document.getElementById("showJumpMasterLine");t&&(t.checked=!1,t.disabled=!0,t.style.opacity="0.5",t.title="Enable Live Tracking to use Jump Master Line"),u.state.userSettings.showJumpMasterLine&&(u.state.userSettings.showJumpMasterLine=!1,u.save()),ot()}),document.addEventListener("track:loaded",async t=>{const e=document.getElementById("loading");try{const{lat:n,lng:a,timestamp:o,historicalDate:r,summary:s}=t.detail;if(console.log('[main-mobile] Event "track:loaded" empfangen, starte Aktionen.'),r){console.log("Historischer Track geladen, deaktiviere Autoupdate.");const d=document.getElementById("autoupdateCheckbox");d&&(d.checked=!1),Uo(),u.state.userSettings.autoupdate=!1,u.save(),p.handleMessage("Autoupdate disabled for historical track viewing.")}await ma(n,a);const l=await Me(n,a,o);if(l){i.weatherData=l;const d=document.getElementById("timeSlider");if(d&&i.weatherData.time){d.max=i.weatherData.time.length-1,d.disabled=d.max<=0;const m=new Date(o).getTime();let h=0,f=1/0;i.weatherData.time.forEach((g,w)=>{const y=Math.abs(new Date(g).getTime()-m);y<f&&(f=y,h=w)}),d.value=h}}console.log("Performing specific updates after track load..."),await kt(me(),"weather-table-container","selectedTime"),await Bt(),Wt(),De(),nt(),ot();const c=document.getElementById("info");if(c&&s){const d=/(<br><strong>Available Models:<\/strong><ul>.*?<\/ul>|<br><strong>Available Models:<\/strong> None)/s,m=c.innerHTML.match(d);c.innerHTML=s+(m?m[0]:"")}if(r){const d=document.getElementById("historicalDatePicker");d&&(d.value=r)}}catch(n){console.error("Fehler bei der Verarbeitung von track:loaded:",n),p.handleError("Konnte Track-Daten nicht vollständig verarbeiten.")}finally{e&&(e.style.display="none")}}),document.addEventListener("tracking:positionUpdated",t=>{ot(t.detail)}),document.addEventListener("jml:targetChanged",()=>{ot()}),document.addEventListener("ui:sliderChanged",async t=>{console.log("[main-mobile] Event 'ui:sliderChanged' empfangen, spezifische Updates werden ausgeführt.");try{const e=me();i.weatherData&&i.lastLat&&i.lastLng&&(await kt(e,"weather-table-container","selectedTime"),await Bt(),i.lastAltitude!=="N/A"&&Wt(),nt(),u.state.userSettings.calculateJump&&De(),u.state.userSettings.showJumpRunTrack&&xe())}catch(e){console.error("Error during slider update:",e),Xn(e.message)}}),document.addEventListener("ui:radioGroupChanged",async t=>{const{name:e}=t.detail;switch(console.log(`[main-mobile] Radio group '${e}' changed. Performing specific updates.`),await kt(me()),e){case"heightUnit":if(i.lastMouseLatLng){const{lat:n,lng:a}=i.lastMouseLatLng;let r=qu()==="MGRS"?`MGRS: ${p.decimalToMgrs(n,a)}`:`Lat: ${n.toFixed(5)}, Lng: ${a.toFixed(5)}`;Ho(n,a,{lat:n,lng:a},({elevation:s,qfe:l},c)=>{if(i.lastMouseLatLng&&Math.abs(i.lastMouseLatLng.lat-c.lat)<.05){const d=Lo();let m=s!=="N/A"?Math.round(p.convertHeight(s,d)):"N/A";i.coordsControl.update(`${r}<br>Elevation: ${m} ${m==="N/A"?"":d}`)}})}if(i.gpxLayer&&i.gpxPoints.length>0){const n=i.lastAltitude!=="N/A"&&!isNaN(i.lastAltitude)?parseFloat(i.lastAltitude):null,a=Zu(),o=Lo();i.gpxLayer.eachLayer(r=>{r instanceof L.Polyline&&r.on("mousemove",function(s){const l=s.latlng;let c=i.gpxPoints[0],d=1/0,m=0;i.gpxPoints.forEach((h,f)=>{const g=Math.sqrt(Math.pow(h.lat-l.lat,2)+Math.pow(h.lng-l.lng,2));g<d&&(d=g,c=h,m=f)}),r.setTooltipContent(getTooltipContent(c,m,i.gpxPoints,n,a,o)).openTooltip(l)})})}case"windUnit":case"refLevel":Wt(),De(),nt(),ot(),await Bt();break;case"coordFormat":await Bt(),ot();break;case"landingDirection":Qr(),nt();break}}),document.addEventListener("ui:inputChanged",async t=>{const{name:e,value:n}=t.detail;switch(console.log(`[main-mobile] Input for '${e}' changed to '${n}'.`),e){case"aircraftSpeedKt":const a=la(n);vo("jumperSeparation",a),u.state.userSettings.jumperSeparation=a,u.save(),i.weatherData&&Xr(),xe();break;case"cutAwayAltitude":i.weatherData&&i.cutAwayLat!==null&&De();break;case"openingAltitude":case"exitAltitude":case"numberOfJumpers":case"jumperSeparation":case"canopySpeed":case"descentRate":case"legHeightFinal":case"legHeightBase":case"legHeightDownwind":i.weatherData&&(De(),nt());break;case"jumpRunTrackDirection":case"jumpRunTrackOffset":case"jumpRunTrackForwardOffset":i.weatherData&&xe();break;case"lowerLimit":case"upperLimit":case"interpStepSelect":i.weatherData&&(await kt(me()),Wt());break;case"customLandingDirectionLL":case"customLandingDirectionRR":i.weatherData&&nt();break;case"historicalDatePicker":if(i.lastLat&&i.lastLng){const o=n?`${n}T00:00:00Z`:null,r=await Me(i.lastLat,i.lastLng,o);r&&await Ln(r)}break}}),document.addEventListener("ui:showJumpMasterLineChanged",()=>{ot()}),document.addEventListener("ui:modelChanged",async t=>{var e,n;if(console.log(`[main-mobile] Model changed to ${t.detail.model}. Fetching new data.`),i.lastLat&&i.lastLng){const a=me(),o=((n=(e=i.weatherData)==null?void 0:e.time)==null?void 0:n[a])||null,r=await Me(i.lastLat,i.lastLng,o);r&&await Ln(r,a)}else p.handleError("Please select a position on the map first.")}),document.addEventListener("ui:jumpFeatureChanged",()=>{console.log("[main-mobile] Jump feature changed, recalculating jump."),i.weatherData&&i.lastLat&&i.lastLng&&u.state.userSettings.calculateJump&&De()}),document.addEventListener("ui:showJumpRunTrackChanged",t=>{const e=t.detail.checked;if(console.log(`[main-mobile] Jump Run Track toggled: ${e}`),e&&i.weatherData&&i.lastLat&&i.lastLng&&u.state.isCalculateJumpUnlocked&&u.state.userSettings.calculateJump)ed();else{wn(null);const n=document.getElementById("jumpRunTrackDirection");if(n){const a=Dt();n.value=a?a.direction:""}}}),document.addEventListener("ui:showCutAwayFinderChanged",t=>{var a;const e=t.detail.checked;console.log(`[main-mobile] Cut Away Finder toggled: ${e}`);const n=(a=document.getElementById("showCutAwayFinder").closest("li"))==null?void 0:a.querySelector("ul.submenu");n&&n.classList.toggle("hidden",!e),e||(au(),i.cutAwayLat=null,i.cutAwayLng=null),i.weatherData&&i.lastLat&&i.lastLng&&u.state.userSettings.calculateJump&&De()}),document.addEventListener("ui:trackPositionToggled",t=>{const e=t.detail.checked;console.log(`[main-mobile] Live Tracking toggled: ${e}`),e?Kr():Oo()}),document.addEventListener("ui:landingPatternEnabled",()=>{console.log("[main-mobile] Landing pattern enabled, updating display."),nt()}),document.addEventListener("ui:landingPatternDisabled",()=>{console.log("[main-mobile] Landing pattern disabled, clearing display."),gn(null)}),document.addEventListener("ui:showTableChanged",t=>{const e=t.detail.checked;console.log(`[main-mobile] Show Table toggled: ${e}`);const n=document.getElementById("info");n&&(n.style.display=e?"block":"none"),e&&i.weatherData&&i.lastLat&&i.lastLng&&kt(me()),ea()}),document.addEventListener("ui:jumpMasterLineTargetChanged",()=>{console.log("[main-mobile] Jump Master Line target changed, updating panel and line."),ot()}),document.addEventListener("ui:downloadClicked",()=>{console.log("[main-mobile] Download button clicked.");const t=Ku();Yu(t)}),document.addEventListener("ui:clearDateClicked",async()=>{console.log("[main-mobile] Clear date button clicked.");const t=document.getElementById("historicalDatePicker");if(t&&(t.value="",i.lastLat&&i.lastLng))try{const e=await Me(i.lastLat,i.lastLng,null);e&&await Ln(e)}catch(e){Xn(e.message)}}),document.addEventListener("ui:recalculateJump",()=>{console.log("[main-mobile] Recalculate jump triggered."),i.weatherData&&i.lastLat&&i.lastLng&&u.state.userSettings.calculateJump&&De()}),document.addEventListener("ui:invalidInput",t=>{const{id:e,defaultValue:n}=t.detail;console.log(`[main-mobile] Received invalid input for ${e}. Resetting UI to ${n}.`),ne(e,n)})}document.addEventListener("DOMContentLoaded",async()=>{td(),nd(),u.state.userSettings.showTable=!0,Cc(),await $c(),ad(),Yr(),ju(),Jr(),document.addEventListener("cutaway:marker_placed",()=>{console.log("App: Event 'cutaway:marker_placed' empfangen. Neuberechnung wird ausgelöst."),i.weatherData&&i.lastLat&&i.lastLng&&De()}),document.addEventListener("track:dragend",t=>{console.log("App: Event 'track:dragend' empfangen. Neuberechnung der Offsets relativ zum DIP.");const{newPosition:e,originalTrackData:n}=t.detail,a=L.latLng(i.lastLat,i.lastLng),o=n.trackLength,r=n.airplane.bearing,s=e,[l,c]=p.calculateNewCenter(s.lat,s.lng,o/2,(r+180)%360),d=L.latLng(l,c),m=i.map.distance(a,d);let f=p.calculateBearing(a.lat,a.lng,d.lat,d.lng)-r;f=(f+180)%360-180;const g=f*(Math.PI/180),w=Math.round(m*Math.cos(g)),y=Math.round(m*Math.sin(g));u.state.userSettings.jumpRunTrackOffset=y,u.state.userSettings.jumpRunTrackForwardOffset=w,u.save(),vo("jumpRunTrackOffset",y),vo("jumpRunTrackForwardOffset",w),xe()}),document.addEventListener("location:selected",async t=>{var r,s;const{lat:e,lng:n,source:a}=t.detail;console.log(`App: Event 'location:selected' empfangen. Quelle: ${a}`);const o=document.getElementById("loading");o&&(o.style.display="block");try{const l=me(),c=((s=(r=i.weatherData)==null?void 0:r.time)==null?void 0:s[l])||null,d=await Me(e,n,c);d?a==="geolocation"||a==="geolocation_fallback"?await Ln(d):await Ln(d,l):i.weatherData=null,await ma(e,n),await Bt(),ea(!0),i.isManualPanning=!1,(a==="geolocation"||a==="geolocation_fallback")&&(console.log("Starte initiales Caching nach Geolocation..."),tn({map:i.map,baseMaps:i.baseMaps,onProgress:En,onComplete:m=>{Ke(),m&&ft(m)},onCancel:()=>{Ke(),ft("Caching cancelled.")}})),u.state.userSettings.showJumpMasterLine&&ot(),(a==="marker_drag"||a==="dblclick"||a==="search")&&(console.log(`Starte Caching für neue Position via ${a}...`),da({map:i.map,lastLat:e,lastLng:n,baseMaps:i.baseMaps,onProgress:En,onComplete:m=>{Ke(),m&&ft(m)},onCancel:()=>{Ke(),ft("Caching cancelled.")}}))}catch(l){console.error('Fehler beim Verarbeiten von "location:selected":',l),Xn(l.message)}finally{o&&(o.style.display="none")}}),document.addEventListener("autoupdate:tick",async t=>{if(!u.state.userSettings.autoupdate)return;const e=new Date,n=document.getElementById("timeSlider");if(!n)return;const a=e.getUTCHours(),o=parseInt(n.value,10);(a!==o||t.detail.isInitialTick)&&(console.log(`[App] Autoupdate triggered. Current Hour: ${a}, Slider Hour: ${o}`),await Xu())}),setTimeout(()=>{i.map&&i.map.invalidateSize()},100)});let Wn=0;async function od(){return console.log("MapManager: Starte Karteninitialisierung..."),await id(),console.log("MapManager: Karteninitialisierung abgeschlossen."),i.map}async function id(){if(i.ismapInitialized||i.map){console.warn("Map already initialized or init in progress.");return}i.ismapInitialized=!0,console.log("initMap started...");const t=Y.DEFAULT_MAP_CENTER,e=Y.DEFAULT_MAP_ZOOM;rd(t,e),i.jumpVisualizationLayerGroup=L.layerGroup().addTo(i.map),i.landingPatternLayerGroup=L.layerGroup().addTo(i.map),i.jumpRunTrackLayerGroup=L.layerGroup().addTo(i.map),sd(),ld(),cd(),ud(),dd(t),fd(),Promise.all([md(),pd(t,e)]).then(()=>{console.log("Initial tile caching and geolocation promise resolved.")}).catch(n=>{console.error("Error during parallel initialization of cache/geolocation:",n)}),go(),console.log("initMap finished.")}function rd(t,e){i.lastLat=i.lastLat||t[0],i.lastLng=i.lastLng||t[1],i.map=L.map("map",{center:t,zoom:e,zoomControl:!1,doubleClickZoom:!1,maxZoom:19,minZoom:navigator.onLine?6:11}),console.log("Map instance created.")}function sd(){i.baseMaps={OpenStreetMap:L.tileLayer.cached("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:["a","b","c"]}),OpenTopoMap:L.tileLayer.cached("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{maxZoom:17,attribution:'© <a href="https://www.openstreetmap.org/copyright">OSM</a>, <a href="https://opentopomap.org">OpenTopoMap</a> (CC-BY-SA)',subdomains:["a","b","c"]}),"Esri Satellite":L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USDA, USGS"}),"Esri Street":L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USGS"}),"Esri Topo":L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USGS"}),"Esri Satellite + OSM":L.layerGroup([L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USDA, USGS",zIndex:1}),L.tileLayer.cached("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',opacity:.5,zIndex:2,updateWhenIdle:!0,keepBuffer:2,subdomains:["a","b","c"]})],{attribution:'© Esri, USDA, USGS | © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'})},i.map&&i.map.attributionControl&&i.map.attributionControl.addAttribution('Weather data by <a href="https://open-meteo.com">Open-Meteo</a>');const e=u.state.userSettings.baseMaps in i.baseMaps?u.state.userSettings.baseMaps:"Esri Street",n=i.baseMaps[e];n&&typeof n.on=="function"?(n.on("tileerror",()=>{if(!navigator.onLine){i.hasTileErrorSwitched||(console.warn(`${e} tiles unavailable offline. Zoom restricted.`),p.handleMessage("Offline: Zoom restricted to levels 11–14 for cached tiles."),i.hasTileErrorSwitched=!0);return}if(!i.hasTileErrorSwitched&&i.map.hasLayer(n)){const a="OpenStreetMap";console.warn(`${e} tiles unavailable, switching to ${a}`),i.map.removeLayer(n),i.baseMaps[a].addTo(i.map),u.state.userSettings.baseMaps=a,u.save(),p.handleMessage(`${e} tiles unavailable. Switched to ${a}.`),i.hasTileErrorSwitched=!0}else i.hasTileErrorSwitched||console.warn(`Tile error in ${e}, attempting to continue.`)}),n.addTo(i.map)):(console.error(`Default base map "${e}" could not be added.`),i.baseMaps.OpenStreetMap.addTo(i.map)),i.map&&i.map.invalidateSize(),window.addEventListener("online",()=>{i.hasTileErrorSwitched=!1,i.map&&(i.map.options.minZoom=6),go()}),window.addEventListener("offline",()=>{i.map&&(i.map.options.minZoom=9),go()}),console.log("Base layers and online/offline handlers set up.")}function ld(){if(!i.map){console.error("Karte nicht initialisiert, bevor Controls hinzugefügt werden können.");return}L.control.layers(i.baseMaps,null,{position:"topright"}).addTo(i.map),i.map.on("baselayerchange",function(t){console.log(`Base map changed to: ${t.name}`),u&&u.state&&u.state.userSettings?(u.state.userSettings.baseMaps=t.name,u.save(),console.log(`Saved selected base map "${t.name}" to settings.`)):console.error("Settings object not properly available to save base map choice."),i.hasTileErrorSwitched=!1,i.lastLat&&i.lastLng&&typeof cacheTilesForDIP=="function"&&cacheTilesForDIP({map:i.map,lastLat:i.lastLat,lastLng:i.lastLng,baseMaps:i.baseMaps})}),L.control.zoom({position:"topright"}).addTo(i.map),L.control.polylineMeasure({position:"topright",unit:"kilometres",showBearings:!0,clearMeasurementsOnStop:!1,showClearControl:!0,showUnitControl:!0,tooltipTextFinish:"Click to finish the line<br>",tooltipTextDelete:"Shift-click to delete point",tooltipTextMove:"Drag to move point<br>",tooltipTextResume:"Click to resume line<br>",tooltipTextAdd:"Click to add point<br>",measureControlTitleOn:"Start measuring distance and bearing",measureControlTitleOff:"Stop measuring"}).addTo(i.map),L.control.scale({position:"bottomleft",metric:!0,imperial:!1,maxWidth:100}).addTo(i.map),console.log("Standard map controls and baselayerchange handler added.")}function cd(){i.map.createPane("gpxTrackPane"),i.map.getPane("gpxTrackPane").style.zIndex=650,i.map.getPane("tooltipPane").style.zIndex=700,i.map.getPane("popupPane").style.zIndex=700,console.log("Custom map panes created.")}function ud(){i.livePositionControl=new Cd({position:"bottomright"}).addTo(i.map),console.log("Initialized livePositionControl and hid by default")}async function dd(t,e){console.log("MapManager: Initialisiere den Standard-Marker..."),await pa(t[0],t[1]),i.isManualPanning=!1,console.log("Default marker initialized using the new standard method.")}async function md(){try{if(await oe.init(),await oe.migrateTiles(),await oe.getCacheSize()>500){const e=await oe.clearOldTiles(3);p.handleMessage(`Cleared ${e.deletedCount} old tiles: ${e.deletedSizeMB.toFixed(2)} MB freed.`)}else await oe.clearOldTiles()}catch(t){console.error("Failed to initialize or manage tile cache:",t),p.handleError("Tile caching setup failed.")}console.log("Tile cache logic initialized.")}async function hd(t,e){const{latitude:n,longitude:a}=t.coords;console.log("MapManager: Geolocation erfolgreich. Sende Event."),i.lastLat=n,i.lastLng=a,i.lastAltitude=await p.getAltitude(n,a),i.map.setView([n,a],e);const o=new CustomEvent("location:selected",{detail:{lat:n,lng:a,source:"geolocation"},bubbles:!0,cancelable:!0});i.map.getContainer().dispatchEvent(o)}async function Ai(t,e,n){console.warn(`Geolocation error: ${t.message}`),p.handleMessage("Unable to retrieve your location. Using default location."),await pa(e[0],e[1]),i.map.setView(e,n),ta(!0),i.isManualPanning=!1;const a=new CustomEvent("location:selected",{detail:{lat:e[0],lng:e[1],source:"geolocation_fallback"},bubbles:!0,cancelable:!0});i.map.getContainer().dispatchEvent(a),console.log("Dispatched 'location:selected' event from geolocation fallback.")}async function pd(t,e){navigator.geolocation?navigator.geolocation.getCurrentPosition(n=>hd(n,e),n=>Ai(n,t,e),{enableHighAccuracy:!0,timeout:Y.GEOLOCATION_TIMEOUT_MS,maximumAge:0}):(console.warn("Geolocation not supported."),await Ai({message:"Geolocation not supported by this browser."},t,e))}function gd(t){const{lat:e,lng:n}=t.latlng,a=new CustomEvent("map:mousemove",{detail:{lat:e,lng:n},bubbles:!0,cancelable:!0});i.map.getContainer().dispatchEvent(a)}function fd(){if(!i.map){console.error("Karte nicht initialisiert in _setupCoreMapEventHandlers");return}if(!i.coordsControl){const e={enableUserInput:!1};i.coordsControl=new L.Control.Coordinates(e),i.coordsControl.addTo(i.map)}At()?yd(i.map):wd(i.map),i.map.on("dblclick",Ya),i.map.on("zoomstart",e=>{if(!navigator.onLine){const n=e.target._zoom||i.map.getZoom();n<11?(e.target._zoom=11,i.map.setZoom(11),p.handleMessage("Offline: Zoom restricted to levels 11–14 for cached tiles.")):n>14&&(e.target._zoom=14,i.map.setZoom(14),p.handleMessage("Offline: Zoom restricted to levels 11–14 for cached tiles."))}}),i.map.on("zoomend",()=>{const e=i.map.getZoom(),n=new CustomEvent("map:zoomend",{detail:{zoom:e},bubbles:!0,cancelable:!0});if(i.map.getContainer().dispatchEvent(n),i.jumpRunTrackLayer&&u.state.userSettings.showJumpRunTrack){const a=i.jumpRunTrackLayer.getLayers().find(o=>{var r;return((r=o.options.icon)==null?void 0:r.options.className)==="jrt-anchor-marker"});if(a){const o=e<=11?10:e<=12?12:e<=13?14:16;a.setIcon(L.divIcon({className:"jrt-anchor-marker",html:`<div style="background-color: orange; width: ${o}px; height: ${o}px; border-radius: 50%; border: 2px solid white; opacity: 0.8;"></div>`,iconSize:[o,o],iconAnchor:[o/2,o/2],tooltipAnchor:[0,-(o/2+5)]}))}}if(i.heatmapLayer){const a=p.calculateDynamicRadius(ve.HEATMAP_BASE_RADIUS,ve.HEATMAP_REFERENCE_ZOOM);i.heatmapLayer.setOptions({radius:a}),console.log("Heatmap radius updated on zoom:",{currentZoom:i.map.getZoom(),newRadius:a})}}),i.map.on("movestart",e=>{e.target===i.map&&(!e.originalEvent||e.originalEvent.target===i.map.getContainer())&&(i.isManualPanning=!0,console.log("Manual map panning detected."))}),i.map.on("contextmenu",e=>{if(!u.state.userSettings.showCutAwayFinder||!u.state.userSettings.calculateJump)return;const{lat:n,lng:a}=e.latlng;i.cutAwayMarker?i.cutAwayMarker.setLatLng([n,a]):(i.cutAwayMarker=Sd(n,a).addTo(i.map),Ed(i.cutAwayMarker)),i.cutAwayLat=n,i.cutAwayLng=a,es(i.cutAwayMarker,n,a);const o=new CustomEvent("cutaway:marker_placed",{bubbles:!0});i.map.getContainer().dispatchEvent(o)});const t=i.map.getContainer();t.addEventListener("touchstart",async e=>{if(e.touches.length!==1||e.target.closest(".leaflet-marker-icon"))return;const n=new Date().getTime(),a=n-Wn;if(a<300&&a>0){e.preventDefault();const r=t.getBoundingClientRect(),s=e.touches[0].clientX-r.left,l=e.touches[0].clientY-r.top,c=i.map.containerPointToLatLng([s,l]);await Ya({latlng:c,containerPoint:L.point(s,l),layerPoint:i.map.latLngToLayerPoint(c)})}Wn=n},{passive:!1}),i.map.on("click",e=>{}),i.map.on("mousedown",e=>{}),t.addEventListener("touchstart",async e=>{if(e.touches.length!==1||e.target.closest(".leaflet-marker-icon"))return;const n=new Date().getTime(),a=n-Wn;if(a<300&&a>0){e.preventDefault();const r=t.getBoundingClientRect(),s=e.touches[0].clientX-r.left,l=e.touches[0].clientY-r.top,c=i.map.containerPointToLatLng([s,l]);await Ya({latlng:c,containerPoint:L.point(s,l),layerPoint:i.map.latLngToLayerPoint(c)})}Wn=n},{passive:!1}),console.log("All core map event handlers have been set up.")}function yd(t){const e=({elevation:a,qfe:o},r)=>{const s=t.getCenter();if(Math.abs(s.lat-r.lat)>1e-4||Math.abs(s.lng-r.lng)>1e-4)return;const c=i.coordsControl._container.innerHTML.split("<br>")[0],d=u.getValue("heightUnit","radio","m");let m="N/A";if(a!=="N/A"){const w=p.convertHeight(a,d);m=Math.round(w)}const h=m==="N/A"?"N/A":`${m}${d}`,f=o!=="N/A"?`${o.toFixed(0)}hPa`:"N/A",g=`${c}<br>Elevation: ${h}<br>QFE: ${f}`;i.coordsControl.update(g)},n=()=>{const a=t.getCenter(),o=u.getValue("coordFormat","radio","Decimal"),r=p.convertCoords(a.lat,a.lng,o),s=o==="MGRS"?`MGRS: ${r.lat}`:`${a.lat.toFixed(5)}, ${a.lng.toFixed(5)}`;i.coordsControl.update(`${s}<br>Elevation: ...<br>QFE: ...`),Ho(a.lat,a.lng,a,e)};t.on("move",n),setTimeout(()=>t.fire("move"),200),console.log("Crosshair coordinate handler initialized.")}function wd(t){t.on("mousemove",gd),t.on("mouseout",function(){i.coordsControl&&i.coordsControl.getContainer()&&(i.coordsControl.getContainer().innerHTML="Move mouse over map")}),console.log("Mouse coordinate handler initialized.")}function Ya(t){const{lat:e,lng:n}=t.latlng;console.log('MapManager: Doppelklick erkannt. Sende "location:selected"-Event.');const a=new CustomEvent("location:selected",{detail:{lat:e,lng:n,source:"dblclick"},bubbles:!0,cancelable:!0});i.map.getContainer().dispatchEvent(a)}function Jn(t){if(Ld(),i.labelZoomListener&&i.map&&(i.map.off("zoomend",i.labelZoomListener),i.labelZoomListener=null),!t||!i.jumpVisualizationLayerGroup)return;const e=[];t.exitCircles&&t.exitCircles.forEach(a=>{const o=L.circle(a.center,{radius:a.radius,color:a.color,fillColor:a.fillColor,fillOpacity:a.fillOpacity,weight:a.weight||2}).addTo(i.jumpVisualizationLayerGroup);a.tooltip&&o.bindTooltip(a.tooltip,{direction:"top",offset:[0,0],className:"wind-tooltip"})}),t.canopyCircles&&t.canopyCircles.forEach(a=>{L.circle(a.center,a).addTo(i.jumpVisualizationLayerGroup)});function n(a,o){const r=L.latLng(a[0],a[1]),l=o/6378137*(180/Math.PI),c=L.latLng(a[0]+l,a[1]),d=i.map.latLngToLayerPoint(r),m=i.map.latLngToLayerPoint(c);return[25,d.y-m.y+10]}if(t.canopyLabels){const a=i.map.getZoom();t.canopyLabels.forEach(o=>{const r=a<=11,s=L.marker(o.center,{icon:L.divIcon({className:`isoline-label ${r?"isoline-label-small":"isoline-label-large"}`,html:`<span style="font-size: ${r?"8px":"10px"}">${o.text}</span>`,iconSize:r?[50,12]:[60,14],iconAnchor:n(o.center,o.radius)}),zIndexOffset:2100}).addTo(i.jumpVisualizationLayerGroup);e.push({marker:s,center:o.center,radius:o.radius,text:o.text})})}e.length>0&&(i.labelZoomListener=function(){const o=i.map.getZoom()<=11;e.forEach(r=>{r.marker.setIcon(L.divIcon({className:`isoline-label ${o?"isoline-label-small":"isoline-label-large"}`,html:`<span style="font-size: ${o?"8px":"10px"}">${r.text}</span>`,iconSize:o?[50,12]:[60,14],iconAnchor:n(r.center,r.radius)}))})},i.map.on("zoomend",i.labelZoomListener))}function Ld(){i.map&&i.jumpVisualizationLayerGroup&&i.map.removeLayer(i.jumpVisualizationLayerGroup),i.jumpVisualizationLayerGroup=L.layerGroup().addTo(i.map)}function vd(){i.landingPatternLayerGroup&&i.landingPatternLayerGroup.clearLayers()}function fn(t){vd(),t&&(t.legs.forEach(e=>{L.polyline(e.path,{color:"red",weight:3,opacity:.8,dashArray:"5, 10"}).addTo(i.landingPatternLayerGroup)}),t.arrows.forEach(e=>{const n=Md(e.position[0],e.position[1],e.bearing,e.color);L.marker(e.position,{icon:n}).addTo(i.landingPatternLayerGroup).bindTooltip(e.tooltipText,{offset:[10,0],direction:"right",className:"wind-tooltip"})}))}function Md(t,e,n,a){const o=(n+360)%360,r=`
        <svg width="40" height="20" viewBox="0 0 40 20" xmlns="http://www.w3.org/2000/svg">
            <line x1="0" y1="10" x2="30" y2="10" stroke="${a}" stroke-width="4" />
            <polygon points="30,5 40,10 30,15" fill="${a}" />
        </svg>
    `;return L.divIcon({html:`<div style="transform: rotate(${o}deg); ...">${r}</div>`,className:"wind-arrow-icon",iconSize:[40,20],iconAnchor:[20,10]})}function bd(){i.map&&i.jumpRunTrackLayerGroup&&i.map.removeLayer(i.jumpRunTrackLayerGroup),i.jumpRunTrackLayerGroup=L.layerGroup().addTo(i.map)}function Sd(t,e){const n=L.icon({iconUrl:Qt.CUTAWAY_MARKER,iconSize:[25,25],iconAnchor:[12,12],popupAnchor:[0,-12]});return L.marker([t,e],{icon:n,draggable:!0})}function Ed(t){t.on("dragend",e=>{const n=t.getLatLng();i.cutAwayLat=n.lat,i.cutAwayLng=n.lng,console.log("Cut-away marker dragged to:",{lat:i.cutAwayLat,lng:i.cutAwayLng}),es(t,i.cutAwayLat,i.cutAwayLng);const a=new CustomEvent("cutaway:marker_placed",{bubbles:!0});i.map.getContainer().dispatchEvent(a)})}function es(t,e,n,a=!1){const o=u.getValue("coordFormat","radio","Decimal"),r=p.convertCoords(e,n,o);let s="<b>Cut-Away Start</b><br>";if(o==="MGRS")s+=`MGRS: ${r.lat}`;else{const l=c=>`${c.deg}°${c.min}'${c.sec.toFixed(0)}" ${c.dir}`;o==="DMS"?s+=`Lat: ${l(p.decimalToDms(e,!0))}<br>Lng: ${l(p.decimalToDms(n,!1))}`:s+=`Lat: ${e.toFixed(5)}<br>Lng: ${n.toFixed(5)}`}Bo(t,s,a)}function Mo(t){i.cutAwayCircle&&(i.map.removeLayer(i.cutAwayCircle),i.cutAwayCircle=null),t&&(i.cutAwayCircle=L.circle(t.center,{radius:t.radius,color:"purple",fillColor:"purple",fillOpacity:.2,weight:2}).addTo(i.map),i.cutAwayCircle.bindTooltip(t.tooltipContent,{permanent:!1,direction:"center",className:"cutaway-tooltip"}))}function kd(){i.cutAwayMarker&&(i.map.removeLayer(i.cutAwayMarker),i.cutAwayMarker=null),Mo(null)}function vn(t){var r,s,l,c;if(bd(),!t||!i.jumpRunTrackLayerGroup){console.warn("No valid trackData or AppState.jumpRunTrackLayerGroup");return}if(!((s=(r=t.path)==null?void 0:r.latlngs)!=null&&s.length)||!((l=t.airplane)!=null&&l.position)){console.warn("Invalid trackData structure:",t);return}const e=L.polyline(t.path.latlngs,t.path.options).bindTooltip(t.path.tooltipText).addTo(i.jumpRunTrackLayerGroup);let n=null;(c=t.approachPath)!=null&&c.latlngs&&(n=L.polyline(t.approachPath.latlngs,t.approachPath.options).bindTooltip(t.approachPath.tooltipText).addTo(i.jumpRunTrackLayerGroup));const a=L.icon({iconUrl:Qt.AIRPLANE_MARKER,iconSize:[32,32],iconAnchor:[16,16],shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",shadowSize:[41,41],shadowAnchor:[13,32]}),o=L.marker(t.airplane.position,{icon:a,rotationAngle:t.airplane.bearing,rotationOrigin:"center center",draggable:!0,zIndexOffset:2e3}).bindTooltip("Drag to move Jump Run Track").addTo(i.jumpRunTrackLayerGroup);o.on("mousedown",()=>i.map.dragging.disable()),o.on("mouseup",()=>i.map.dragging.enable()),o.on("drag",d=>{var y;const m=d.target.getLatLng(),h=t.airplane.originalPosition;if(!h||!Number.isFinite(h.lat)||!Number.isFinite(h.lng)){console.warn("Invalid originalPosition:",h);return}const f=m.lat-h.lat,g=m.lng-h.lng;if(!Number.isFinite(f)||!Number.isFinite(g)){console.warn("Invalid delta values:",{deltaLat:f,deltaLng:g});return}const w=t.path.originalLatLngs.map(v=>[Number.isFinite(v[0])?v[0]+f:v[0],Number.isFinite(v[1])?v[1]+g:v[1]]);if(e.setLatLngs(w),n&&((y=t.approachPath)!=null&&y.originalLatLngs)){const v=t.approachPath.originalLatLngs.map(b=>[Number.isFinite(b[0])?b[0]+f:b[0],Number.isFinite(b[1])?b[1]+g:b[1]]);n.setLatLngs(v)}}),o.on("dragend",d=>{const m=d.target.getLatLng();if(!Number.isFinite(m.lat)||!Number.isFinite(m.lng)){console.warn("Invalid new position in dragend:",m);return}const h=new CustomEvent("track:dragend",{detail:{newPosition:m,originalTrackData:t},bubbles:!0});i.map.getContainer().dispatchEvent(h)})}async function pa(t,e){if(console.log("MapManager: Befehl erhalten, Marker zu erstellen/bewegen bei",t,e),typeof t!="number"||typeof e!="number"||t<-90||t>90||e<-180||e>180){console.error("MapManager: Ungültige Koordinaten:",{lat:t,lng:e});return}const n=await p.getAltitude(t,e);if(i.currentMarker)console.log("MapManager: Marker existiert, bewege ihn jetzt mit setLatLng."),i.currentMarker.setLatLng([t,e]);else{console.log("MapManager: Kein Marker vorhanden, erstelle einen neuen.");const o=Td(t,e);_d(o),i.currentMarker=o,i.currentMarker.addTo(i.map)}const a=`Lat: ${t.toFixed(5)}<br>Lng: ${e.toFixed(5)}<br>Alt: ${n} m`;Bo(i.currentMarker,a),i.lastLat=t,i.lastLng=e,i.lastAltitude=n,i.map.invalidateSize()}function Td(t,e){const n=L.icon({iconUrl:Qt.DEFAULT_MARKER,iconSize:[32,32],iconAnchor:[16,20],popupAnchor:[0,-32]});return L.marker([t,e],{icon:n,draggable:!0})}function _d(t){t.on("dragend",e=>{const n=t.getLatLng(),a=new CustomEvent("location:selected",{detail:{lat:n.lat,lng:n.lng,source:"marker_drag"},bubbles:!0});i.map.getContainer().dispatchEvent(a)})}function Bo(t,e,n=!1){var o;if(!t)return;const a=((o=t.getPopup())==null?void 0:o.isOpen())||n;t.unbindPopup().bindPopup(e),a&&t.openPopup()}function ta(t=!1){i.isManualPanning&&!t||i.map&&i.currentMarker&&i.map.panTo(i.currentMarker.getLatLng())}const Cd=L.Control.extend({options:{position:"bottomright"},onAdd:function(t){const e=L.DomUtil.create("div","leaflet-control-live-position");return e.style.display="none",e.style.background="rgba(255, 255, 255, 0.8)",e.style.padding="5px",e.style.borderRadius="4px",this._container=e,e},update:function(t){if(!t||t.latitude===null||t.latitude===void 0){this._container.style.display="none";return}const{latitude:e,longitude:n,deviceAltitude:a,altitudeAccuracy:o,accuracy:r,speedMs:s,direction:l,showJumpMasterLine:c,jumpMasterLineData:d,heightUnit:m,effectiveWindUnit:h,coordFormat:f,refLevel:g}=t,w=p.convertCoords(e,n,f),y=f==="MGRS"?`MGRS: ${w.lat}<br>`:`Lat: ${e.toFixed(5)}<br>Lng: ${n.toFixed(5)}<br>`;let v="Altitude: N/A<br>";if(a!==null){let k=g==="AGL"&&i.lastAltitude?a-parseFloat(i.lastAltitude):a,_=g==="AGL"&&i.lastAltitude?"abv DIP":g;const C=Math.round(p.convertHeight(k,m)),T=Math.round(p.convertHeight(o,m));v=`Altitude: ${C} ${m} ${_} (±${T||"N/A"} ${m})<br>`}const b=`Accuracy: ${Math.round(p.convertHeight(r,m))} ${m}<br>`,S=`Speed: ${p.convertWind(s,h,"m/s").toFixed(1)} ${h}<br>`,E=`Direction: ${l}°`;let M=`<span style="font-weight: bold;">Live Position</span><br>${y}${v}${b}${S}${E}`;if(c&&d){const k=Math.round(p.convertHeight(d.distance,m)),_=d.tot!=="N/A"&&d.tot<1200?`TOT: X - ${d.tot} s`:"TOT: N/A";M+=`<br><br><span style="font-weight: bold;">Jump Master Line to ${d.target}</span><br>`,M+=`Bearing: ${d.bearing}°<br>`,M+=`Distance: ${k} ${m}<br>`,M+=_}this._container.innerHTML=M,this._container.style.display="block"}});function Ad(t,e){const n=[[t.lat,t.lng],[e.lat,e.lng]];i.jumpMasterLine?i.jumpMasterLine.setLatLngs(n):i.jumpMasterLine=L.polyline(n,{color:"blue",weight:3,dashArray:"5, 5"}).addTo(i.map)}function Ii(){i.jumpMasterLine&&(i.map.removeLayer(i.jumpMasterLine),i.jumpMasterLine=null)}function Id(){i.livePositionControl&&i.livePositionControl.update(null)}function Dd(t){i.livePositionControl&&i.livePositionControl.update(t)}function ts(t){if(!i.isPlacingHarp)return;const{lat:e,lng:n}=t.latlng;i.harpMarker?(i.harpMarker.setLatLng([e,n]),console.log("Updated HARP marker position:",{lat:e,lng:n})):(i.harpMarker=Nd(e,n).addTo(i.map),console.log("Placed new HARP marker:",{lat:e,lng:n})),u.state.userSettings.harpLat=e,u.state.userSettings.harpLng=n,u.save(),i.isPlacingHarp=!1,i.map.off("click",ts),console.log("HARP placement mode deactivated");const a=document.querySelector('input[name="jumpMasterLineTarget"][value="HARP"]');a&&(a.disabled=!1,console.log("Enabled HARP radio button"))}function Nd(t,e){const n=L.marker([t,e],{icon:L.divIcon({className:"harp-marker",html:'<div style="background-color: green; width: 10px; height: 10px; border-radius: 50%;"></div>',iconSize:[10,10],iconAnchor:[5,5]}),pane:"markerPane"});return console.log("Created HARP marker at:",{latitude:t,longitude:e}),n}function Fd(){if(!i.map){console.warn("Map not initialized, cannot clear HARP marker"),p.handleMessage("Map not initialized, cannot clear HARP marker.");return}i.harpMarker&&(i.map.removeLayer(i.harpMarker),i.harpMarker=null,console.log("Removed HARP marker")),u.state.userSettings.harpLat=null,u.state.userSettings.harpLng=null,u.save();const t=document.querySelector('input[name="jumpMasterLineTarget"][value="HARP"]');if(t&&(t.disabled=!0,console.log("Disabled HARP radio button")),u.state.userSettings.jumpMasterLineTarget==="HARP"&&u.state.userSettings.showJumpMasterLine){i.jumpMasterLine&&(i.map.removeLayer(i.jumpMasterLine),i.jumpMasterLine=null,console.log("Removed Jump Master Line: HARP marker cleared")),u.state.userSettings.jumpMasterLineTarget="DIP";const e=document.querySelector('input[name="jumpMasterLineTarget"][value="DIP"]');e&&(e.checked=!0,console.log("Switched Jump Master Line to DIP")),u.save(),i.liveMarker&&i.currentMarker&&i.lastLat!==null&&i.lastLng!==null&&debouncedPositionUpdate({coords:{latitude:i.lastLatitude,longitude:i.lastLongitude,accuracy:i.lastAccuracy,altitude:i.lastDeviceAltitude,altitudeAccuracy:i.lastAltitudeAccuracy}})}p.handleMessage("HARP marker cleared")}async function zt(){if(!i.currentMarker||i.lastLat===null)return;const t=i.lastLat,e=i.lastLng,n=i.lastAltitude,a=u.getValue("heightUnit","radio","m");let o="N/A",r="";n!=="N/A"&&(a==="ft"?(o=Math.round(p.convertHeight(n,"ft")),r="ft"):(o=n,r="m"));const s=u.getValue("coordFormat","radio","Decimal"),l=me(),c=p.convertCoords(t,e,s);let d;if(s==="MGRS")d=`MGRS: ${c.lat}<br>Alt: ${o} ${r}`;else{const m=h=>`${h.deg}°${h.min}'${h.sec.toFixed(0)}" ${h.dir}`;s==="DMS"?d=`Lat: ${m(p.decimalToDms(t,!0))}<br>Lng: ${m(p.decimalToDms(e,!1))}<br>Alt: ${o} ${r}`:d=`Lat: ${t.toFixed(5)}<br>Lng: ${e.toFixed(5)}<br>Alt: ${o} ${r}`}if(i.weatherData&&i.weatherData.surface_pressure){const m=i.weatherData.surface_pressure[l];m?d+=` QFE: ${m.toFixed(0)} hPa`:d+=" QFE: N/A"}else d+=" QFE: N/A";Bo(i.currentMarker,d)}async function Tt(t,e,n,a=null){var S;console.log(`updateWeatherDisplay called for index: ${t} -> into ${e}`);const o=document.getElementById(e),r=document.getElementById(n);if(!o||!r){console.error("Target container(s) for weather display not found!",{tableContainerId:e,timeContainerId:n});return}if(!i.weatherData||!i.weatherData.time||t<0||t>=i.weatherData.time.length){console.error("No weather data available or index out of bounds:",t),o.innerHTML='<p style="padding: 20px; text-align: center;">No weather data available</p>',r.innerHTML="Selected Time: ";const E=document.getElementById("timeSlider");E&&(E.value=0);return}i.landingWindDir=i.weatherData.wind_direction_10m[t]||null,console.log("landingWindDir updated to:",i.landingWindDir);const s=document.getElementById("customLandingDirectionLL"),l=document.getElementById("customLandingDirectionRR");s&&l&&i.landingWindDir!==null&&(s.value=Math.round(i.landingWindDir),l.value=Math.round(i.landingWindDir));const c=((S=document.querySelector('input[name="refLevel"]:checked'))==null?void 0:S.value)||"AGL",d=u.getValue("heightUnit","radio","m"),m=u.getValue("windUnit","radio","kt"),h=u.getValue("temperatureUnit","radio","C"),f=await p.getDisplayTime(i.weatherData.time[t],i.lastLat,i.lastLng),g=Te(),w=_e(i.weatherData,t,g,Math.round(i.lastAltitude),d),y=c==="AMSL"&&i.lastAltitude!=="N/A"?Math.round(i.lastAltitude):0;if(!u.state.userSettings.showTable){o.innerHTML="",r.innerHTML=`Selected Time: ${f}`;return}const v=w.map(E=>{const M=parseFloat(E.spd);let k="";if(m==="bft"){const F=p.convertWind(M,"kt","km/h"),B=p.knotsToBeaufort(F);B<=1?k="wind-low":B<=3?k="wind-moderate":B<=4?k="wind-high":k="wind-very-high"}else{const F=p.convertWind(M,"kt","km/h");F<=3?k="wind-low":F<=10?k="wind-moderate":F<=16?k="wind-high":k="wind-very-high"}const _=E.rh;let C="";_!=="N/A"&&Number.isFinite(_)&&(_<65?C="humidity-low":_>=65&&_<=85?C="humidity-moderate":_>85&&_<100?C="humidity-high":_===100&&(C="humidity-saturated"));const T=c==="AMSL"?E.displayHeight+(d==="ft"?Math.round(y*3.28084):y):E.displayHeight,D=p.convertTemperature(E.temp,h==="C"?"°C":"°F"),P=D==="N/A"?"N/A":D.toFixed(0),I=p.convertWind(M,m,"km/h");let x;const R=c==="AMSL"?d==="ft"?Math.round(y*3.28084):y:0;if(Math.round(T)===R&&i.weatherData.wind_gusts_10m[t]!==void 0&&Number.isFinite(i.weatherData.wind_gusts_10m[t])){const F=i.weatherData.wind_gusts_10m[t],B=p.convertWind(F,m,"km/h"),Z=m==="bft"?Math.round(I):I.toFixed(0),X=m==="bft"?Math.round(B):B.toFixed(0);x=`${Z} G ${X}`}else x=I==="N/A"?"N/A":m==="bft"?Math.round(I):I.toFixed(0);const $=Math.round(p.convertWind(M,"kt","km/h")/5)*5,V=E.dir==="N/A"||isNaN($)?"N/A":p.generateWindBarb(E.dir,$);return`<tr class="${k} ${C}">
                    <td>${Math.round(T)}</td>
                    <td>${p.roundToTens(E.dir)}</td>
                    <td>${x}</td>
                    <td>${V}</td>
                    <td>${P}</td>
                </tr>`}).join(""),b=`
        <table id="weatherTable">
            <thead>
                <tr>
                    <th>Height (${d} ${c})</th>
                    <th>Dir (deg)</th>
                    <th>Spd (${m})</th>
                    <th>Wind</th>
                    <th>T (${h==="C"?"°C":"°F"})</th>
                </tr>
            </thead>
            <tbody>
                ${v}
            </tbody>
        </table>`;o.innerHTML=b,r.innerHTML=`Selected Time: ${f}`}function at(){var ln;if(!i.currentMarker||typeof i.currentMarker.getLatLng!="function"){console.warn("Landing pattern update skipped: AppState.currentMarker is not a valid marker object yet.",i.currentMarker);return}const t=i.currentMarker.getLatLng();if(!t){console.error("Could not get LatLng from the current marker. Aborting landing pattern update.",i.currentMarker);return}if(!u.state.isLandingPatternUnlocked||!u.state.userSettings.showLandingPattern){fn(null);return}if(!i.weatherData||!i.lastLat){fn(null);return}const e=i.map.getZoom();if(e<Y.LANDING_PATTERN_MIN_ZOOM){console.log("Landing pattern not displayed - zoom too low:",e),fn(null);return}const n=parseInt(document.getElementById("timeSlider").value)||0,a=((ln=document.querySelector('input[name="landingDirection"]:checked'))==null?void 0:ln.value)||"LL",o=document.getElementById("customLandingDirectionLL"),r=document.getElementById("customLandingDirectionRR"),s=o?parseInt(o.value,10):null,l=r?parseInt(r.value,10):null,c=parseInt(document.getElementById("canopySpeed").value)||20,d=parseFloat(document.getElementById("descentRate").value)||3.5,m=parseInt(document.getElementById("legHeightFinal").value)||100,h=parseInt(document.getElementById("legHeightBase").value)||200,f=parseInt(document.getElementById("legHeightDownwind").value)||300,g=t.lat,w=t.lng,y=Math.round(i.lastAltitude),v=Te(),b=u.getValue("heightUnit","radio","m"),S=_e(i.weatherData,n,v,Math.round(i.lastAltitude),b);if(!S||S.length===0)return;const E=S.map(z=>z.height),M=S.map(z=>Number.isFinite(z.dir)?parseFloat(z.dir):0),k=S.map(z=>p.convertWind(parseFloat(z.spd)||0,"kt","km/h")),_=k.map((z,re)=>-z*Math.sin(M[re]*Math.PI/180)),C=k.map((z,re)=>-z*Math.cos(M[re]*Math.PI/180));let T;if(a==="LL"&&Number.isFinite(s)&&s>=0&&s<=359?T=s:a==="RR"&&Number.isFinite(l)&&l>=0&&l<=359?T=l:T=Number.isFinite(i.landingWindDir)?i.landingWindDir:M[0],!Number.isFinite(T)){console.warn("Invalid landing wind direction:",T);return}function D(z){const re=u.getValue("windUnit","radio","kt"),tt=p.convertWind(z,re,"kt");return re==="bft"?Math.round(tt):tt.toFixed(1)}const P=(z,re,tt,Aa,Ia)=>{const cn=Aa*1.852/3.6*Ia/111e3,un=tt*Math.PI/180,Da=cn*Math.cos(un),Na=cn*Math.sin(un)/Math.cos(z*Math.PI/180);return[z+Da,re+Na]},I=[y,y+m];console.log("Final limits:",I);const x=p.calculateMeanWind(E,_,C,...I),R=x[0],$=x[1];if(!Number.isFinite($)||!Number.isFinite(R)){console.warn("Invalid mean wind for final leg:",x);return}let V=null;$<=3?V="lightblue":$<=10?V="lightgreen":$<=16?V="#f5f34f":V="#ffcccc";const F=T,B=p.calculateWindAngle(F,R),{crosswind:Z,headwind:X}=p.calculateWindComponents($,B),ce=p.calculateWCA(Z,c)*(Z>=0?1:-1),Q=p.normalizeAngle(F-ce),fe=p.calculateCourseFromHeading(Q,R,$,c).groundSpeed,Oe=m/d,Lt=fe*1.852/3.6*Oe,ct=(T+180)%360,W=P(g,w,ct,fe,Oe);(g+W[0])/2,(w+W[1])/2;const nn=[y+m,y+h],Ue=p.calculateMeanWind(E,_,C,...nn),ye=Ue[0],ee=Ue[1];if(!Number.isFinite(ee)||!Number.isFinite(ye)){console.warn("Invalid mean wind for base leg:",Ue);return}let be=null;ee<=3?be="lightblue":ee<=10?be="lightgreen":ee<=16?be="#f5f34f":be="#ffcccc",console.log("********* Landing Direction: ",a,"Effective Landing Wind Dir:",T);let Se=0;a==="LL"?(Se=(T+90)%360,console.log("Base Heading:",Se)):a==="RR"&&(Se=(T-90+360)%360,console.log("Base Heading:",Se));const Je=p.calculateCourseFromHeading(Se,ye,ee,c),Ce=Je.trueCourse,we=Je.groundSpeed;let Ee=(Ce+180)%360;we<0&&(Ee=(Ee+180)%360,console.log("Base ground speed is negative:",we,"New course:",Ee));const ut=(h-m)/d,ga=we*1.852/3.6*ut;console.log("Base Course:",Ce);const fa=p.calculateWindAngle(Ce,ye),{crosswind:an,headwind:ya}=p.calculateWindComponents(ee,fa),wa=p.calculateWCA(an,c)*(an>=0?1:-1),j=P(W[0],W[1],Ee,we,ut);(W[0]+j[0])/2,(W[1]+j[1])/2;const La=[y+h,y+f],Qe=p.calculateMeanWind(E,_,C,...La),He=Qe[0],ie=Qe[1];if(!Number.isFinite(ie)||!Number.isFinite(He)){console.warn("Invalid mean wind for downwind leg:",Qe);return}let Be=null;ie<=3?Be="lightblue":ie<=10?Be="lightgreen":ie<=16?Be="#f5f34f":Be="#ffcccc";const et=T,va=p.calculateWindAngle(et,He),{crosswind:on,headwind:Ma}=p.calculateWindComponents(ie,va),rn=p.calculateWCA(on,c)*(on>=0?1:-1),ba=p.normalizeAngle((et-rn+180)%360),vt=p.calculateCourseFromHeading(ba,He,ie,c).groundSpeed,sn=(f-h)/d,Sa=vt*1.852/3.6*sn,pe=P(j[0],j[1],et,vt,sn),Ea=[(g+W[0])/2,(w+W[1])/2],ka=[(W[0]+j[0])/2,(W[1]+j[1])/2],Ta=[(j[0]+pe[0])/2,(j[1]+pe[1])/2];(j[0]+pe[0])/2,(j[1]+pe[1])/2,console.log(`Landing Pattern Updated:
        Final Leg: Wind: ${R.toFixed(1)}° @ ${$.toFixed(1)}kt, Course: ${F.toFixed(1)}°, WCA: ${ce.toFixed(1)}°, GS: ${fe.toFixed(1)}kt, HW: ${X.toFixed(1)}kt, Length: ${Lt.toFixed(1)}m
        Base Leg: Wind: ${ye.toFixed(1)}° @ ${ee.toFixed(1)}kt, Course: ${Ce.toFixed(1)}°, WCA: ${wa.toFixed(1)}°, GS: ${we.toFixed(1)}kt, HW: ${ya.toFixed(1)}kt, Length: ${ga.toFixed(1)}m
        Downwind Leg: Wind: ${He.toFixed(1)}° @ ${ie.toFixed(1)}kt, Course: ${et.toFixed(1)}°, WCA: ${rn.toFixed(1)}°, GS: ${vt.toFixed(1)}kt, HW: ${Ma.toFixed(1)}kt, Length: ${Sa.toFixed(1)}m`);const _a=i.weatherData.time[n];console.log("+++++++++ Koordinaten Pattern:",_a),console.log("Coordinates DIP: ",g,w,"Altitude DIP:",y),console.log("Coordinates final end: ",W[0],W[1],"Leg Height:",y+m),console.log("Coordinates base end: ",j[0],j[1],"Leg Height:",y+h),console.log("Coordinates downwind end: ",pe[0],pe[1],"Leg Height:",y+f);const Ca={legs:[{path:[[g,w],W],options:{color:"red",weight:3,opacity:.8,dashArray:"5, 10"}},{path:[W,j],options:{color:"red",weight:3,opacity:.8,dashArray:"5, 10"}},{path:[j,pe],options:{color:"red",weight:3,opacity:.8,dashArray:"5, 10"}}],arrows:[{position:Ea,bearing:(R-90+180)%360,color:V,tooltipText:`${Math.round(R)}° ${D($)}${u.getValue("windUnit","radio","kt")}`},{position:ka,bearing:(Ue[0]-90+180)%360,color:be,tooltipText:`${Math.round(ye)}° ${D(ee)}${u.getValue("windUnit","radio","kt")}`},{position:Ta,bearing:(Qe[0]-90+180)%360,color:Be,tooltipText:`${Math.round(He)}° ${D(ie)}${u.getValue("windUnit","radio","kt")}`}]};fn(Ca)}function Pe(){var s,l,c,d,m,h,f,g;if(console.log("updateJumpRunTrackDisplay called"),!i.map){console.warn("Map not initialized, cannot update jump run track display");return}if(!(u.state.userSettings.showJumpRunTrack&&i.weatherData&&i.lastLat&&i.lastLng&&u.state.isCalculateJumpUnlocked&&u.state.userSettings.calculateJump)){console.log("Conditions not met to show JRT, clearing display."),vn(null),i.lastTrackData=null;return}const e=me(),n=Te(),a=u.getValue("heightUnit","radio","m"),o=_e(i.weatherData,e,n,Math.round(i.lastAltitude),a),r=Dt(o);if(r&&((s=r.latlngs)==null?void 0:s.length)===2&&r.latlngs.every(w=>Number.isFinite(w[0])&&Number.isFinite(w[1]))){console.log("Drawing jump run track with data:",r);const w={path:{latlngs:r.latlngs,options:{color:"orange",weight:5,opacity:.8},tooltipText:`Jump Run Track: ${r.direction}°, Length: ${r.trackLength} m`,originalLatLngs:((c=(l=i.lastTrackData)==null?void 0:l.latlngs)==null?void 0:c.length)===2?i.lastTrackData.latlngs:r.latlngs},approachPath:((d=r.approachLatLngs)==null?void 0:d.length)===2&&r.approachLatLngs.every(y=>Number.isFinite(y[0])&&Number.isFinite(y[1]))?{latlngs:r.approachLatLngs,options:{color:"orange",weight:5,opacity:.8,dashArray:"5, 10"},tooltipText:`Approach Path: ${r.direction}°, Length: ${r.approachLength} m`,originalLatLngs:((h=(m=i.lastTrackData)==null?void 0:m.approachLatLngs)==null?void 0:h.length)===2?i.lastTrackData.approachLatLngs:r.approachLatLngs}:null,trackLength:r.trackLength,airplane:{position:L.latLng(r.latlngs[1][0],r.latlngs[1][1]),bearing:r.direction,originalPosition:(g=(f=i.lastTrackData)==null?void 0:f.latlngs)!=null&&g[1]&&Number.isFinite(i.lastTrackData.latlngs[1][0])?L.latLng(i.lastTrackData.latlngs[1][0],i.lastTrackData.latlngs[1][1]):L.latLng(r.latlngs[1][0],r.latlngs[1][1])}};vn(w),i.lastTrackData={latlngs:r.latlngs,approachLatLngs:r.approachLatLngs,direction:r.direction,trackLength:r.trackLength,approachLength:r.approachLength},console.log("Updated AppState.lastTrackData:",i.lastTrackData)}else console.warn("No valid track data to display:",r),vn(null),i.lastTrackData=null}let rt=!1;function ns(){const t=document.getElementById("locationSearchInputWeb"),e=document.getElementById("locationResultsWeb"),n=document.getElementById("saveCurrentLocationBtn");if(!t||!e||!n){console.error("Einige UI-Elemente für die Ortssuche wurden nicht gefunden.");return}const a=p.debounce(xd,300);t.addEventListener("input",()=>{a(t.value)}),t.addEventListener("focus",()=>{t.value.trim()||Xe(),e.style.display="block"}),t.addEventListener("blur",()=>{setTimeout(()=>{e.style.display="none"},200)}),n._clickHandler&&(n.removeEventListener("click",n._clickHandler),console.log("Entfernte bestehenden click-Listener für saveCurrentLocationBtn")),n._clickHandler=o=>{if(o.stopPropagation(),i.lastLat===null||i.lastLng===null){p.handleError("Please select a location on the map first.");return}if(rt){console.log("saveFavoriteBtn Klick blockiert: Ein Favorit wird bereits hinzugefügt.");return}const r=`DIP at ${i.lastLat.toFixed(4)}, ${i.lastLng.toFixed(4)}`,s=prompt("Enter a name for this favorite:",r);if(s){rt=!0;try{as(i.lastLat,i.lastLng,s),Wo(i.lastLat,i.lastLng,s,!0)}finally{rt=!1,console.log("saveFavoriteBtn Aktion abgeschlossen, Sperre aufgehoben.")}}},n.addEventListener("click",n._clickHandler),console.log("Neuer click-Listener für saveCurrentLocationBtn hinzugefügt"),document.addEventListener("click",o=>{!t.contains(o.target)&&!e.contains(o.target)&&(e.style.display="none")})}async function xd(t){if(console.log("performSearch: Suche nach:",t),!t.trim()){console.log("performSearch: Leere Eingabe, zeige Favoriten/Verlauf."),Xe();return}let e=[];const n=Pd(t);if(n)console.log("performSearch: Koordinaten gefunden:",n),e.push({display_name:`Koordinate: ${n.lat.toFixed(5)}, ${n.lng.toFixed(5)}`,lat:n.lat,lon:n.lng,type:"coordinate"}),Xe(e);else{console.log("performSearch: Keine Koordinaten, starte Nominatim-Suche.");try{const a=`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(t)}&format=json&limit=5&addressdetails=1`,o=await fetch(a,{method:"GET",headers:{"User-Agent":"Skydiving-Weather-App/1.0 (anonymous)"}});if(!o.ok)throw new Error(`Nominatim API Fehler: ${o.statusText}`);const r=await o.json();console.log("performSearch: Nominatim Ergebnisse:",r),e=r,Xe(e)}catch(a){console.error("Fehler bei der Geocoding-Suche:",a),p.handleError("Could not find location."),Xe([])}}}function Pd(t){console.log("parseQueryAsCoordinates: Eingabe:",t);const e=t.trim(),a=e.replace(/[,;\t]+/," ").trim().match(/^(-?\d{1,3}(?:\.\d+)?)\s+(-?\d{1,3}(?:\.\d+)?)$/);if(a){const s=parseFloat(a[1]),l=parseFloat(a[3]);if(console.log("parseQueryAsCoordinates: Dezimalgraden erkannt:",{lat:s,lng:l}),s>=-90&&s<=90&&l>=-180&&l<=180)return{lat:s,lng:l};console.warn("parseQueryAsCoordinates: Ungültige Koordinatenbereiche:",{lat:s,lng:l})}const o=e.replace(/\s/g,"").toUpperCase(),r=/^[0-9]{1,2}[C-HJ-NP-X][A-HJ-NP-Z]{2}(\d{2}|\d{4}|\d{6}|\d{8}|\d{10})$/;if(typeof pc>"u")return console.warn("parseQueryAsCoordinates: MGRS-Bibliothek nicht geladen."),null;if(r.test(o))try{const[s,l]=Do(o);if(console.log("parseQueryAsCoordinates: MGRS erkannt:",{lat:l,lng:s}),!isNaN(l)&&!isNaN(s))return{lat:l,lng:s};console.warn("parseQueryAsCoordinates: Ungültige MGRS-Koordinaten:",{lat:l,lng:s})}catch(s){return console.warn("parseQueryAsCoordinates: MGRS-Parsing fehlgeschlagen:",s.message),null}return console.log("parseQueryAsCoordinates: Keine Koordinaten erkannt."),null}function Xe(t=[]){const e=document.getElementById("locationResultsWeb");if(!e){console.error("resultsList nicht gefunden.");return}e.innerHTML="";const n=Dn(),a=n.filter(s=>s.isFavorite),o=n.filter(s=>!s.isFavorite);console.log("renderResultsList: Favoriten:",a),console.log("renderResultsList: Verlauf (nicht Favoriten):",o),console.log("renderResultsList: Suchergebnisse:",t);const r=s=>{const l=document.createElement("li"),c=parseFloat(s.lat),d=parseFloat(s.lng||s.lon);if(isNaN(c)||isNaN(d))return console.error("Ungültige Koordinaten in createListItem:",s),null;console.log("createListItem: Verarbeite Eintrag:",{lat:c,lng:d,label:s.display_name||s.label}),l.dataset.lat=c,l.dataset.lon=d;const m=document.createElement("span");m.className="location-name",m.textContent=s.display_name||s.label,l.appendChild(m),m.addEventListener("mousedown",w=>{const y=new CustomEvent("location:selected",{detail:{lat:c,lng:d},bubbles:!0,cancelable:!0});l.dispatchEvent(y),Wo(c,d,s.display_name||s.label,s.isFavorite||!1),e.style.display="none"});const h=document.createElement("div");h.className="location-item-buttons";const f=document.createElement("button");f.className="favorite-toggle",f.innerHTML=s.isFavorite?"★":"☆",s.isFavorite&&f.classList.add("is-favorite"),f.title="Als Favorit markieren/entfernen",h.appendChild(f),f.addEventListener("click",w=>{w.stopPropagation(),console.log("favToggle Klick für:",{lat:c,lng:d,label:s.display_name||s.label}),$d(c,d,s.display_name||s.label)});const g=document.createElement("button");return g.className="delete-location-btn",g.textContent="×",g.title="Diesen Eintrag löschen",h.appendChild(g),g.addEventListener("click",w=>{w.stopPropagation(),confirm(`Möchten Sie "${s.display_name||s.label}" wirklich löschen?`)&&Rd(c,d)}),l.appendChild(h),l};if(t.length>0){const s=document.createElement("li");s.className="results-heading",s.textContent="Results",s.style.fontWeight="bold",s.style.background="#f0f0f0",e.appendChild(s),t.forEach(l=>{const c=parseFloat(l.lat),d=parseFloat(l.lon),m=a.find(g=>Math.abs(g.lat-c)<.001&&Math.abs(g.lng-d)<.001);l.isFavorite=!!m,m&&(l.display_name=m.label);const h={lat:c,lng:d,display_name:l.display_name,isFavorite:l.isFavorite},f=r(h);f&&e.appendChild(f)})}if(a.length>0){const s=document.createElement("li");s.className="results-heading",s.textContent="Favorites",s.style.fontWeight="bold",s.style.background="#f0f0f0",e.appendChild(s),a.forEach(l=>{const c=r(l);c&&e.appendChild(c)})}if(o.length>0){const s=document.createElement("li");s.className="results-heading",s.textContent="Previous Locations",s.style.fontWeight="bold",s.style.background="#f0f0f0",e.appendChild(s),o.forEach(l=>{const c=r(l);c&&e.appendChild(c)})}console.log("renderResultsList: Liste gerendert.")}function Dn(){try{return JSON.parse(localStorage.getItem("coordHistory"))||[]}catch{return[]}}function Tn(t){try{localStorage.setItem("coordHistory",JSON.stringify(t))}catch(e){console.error("Error saving history:",e)}}function Wo(t,e,n,a=!1){if(isNaN(t)||isNaN(e))return;let o=Dn();const r=parseFloat(t.toFixed(5)),s=parseFloat(e.toFixed(5));o=o.filter(d=>Math.abs(d.lat-r)>1e-4||Math.abs(d.lng-s)>1e-4),o.unshift({lat:r,lng:s,label:n,isFavorite:a,timestamp:Date.now()});const l=o.filter(d=>d.isFavorite),c=o.filter(d=>!d.isFavorite).slice(0,5);Tn([...l,...c]),Xe()}function as(t,e,n,a=!1){if(isNaN(t)||isNaN(e)){console.error("Ungültige Koordinaten in addOrUpdateFavorite:",{lat:t,lng:e});return}if(rt){console.log("addOrUpdateFavorite blockiert.");return}rt=!0;try{let o=Dn();const r=parseFloat(t.toFixed(5)),s=parseFloat(e.toFixed(5));console.log("addOrUpdateFavorite: Verarbeite:",{newLat:r,newLng:s,name:n});const l=o.find(c=>Math.abs(c.lat-r)<1e-4&&Math.abs(c.lng-s)<1e-4);if(l)console.log("addOrUpdateFavorite: Aktualisiere bestehenden Eintrag:",l),l.isFavorite=!0,l.label=n;else{const c={lat:r,lng:s,label:n,isFavorite:!0,timestamp:Date.now()};console.log("addOrUpdateFavorite: Füge neuen Eintrag hinzu:",c),o.unshift(c)}Tn(o),console.log("addOrUpdateFavorite: Verlauf nach Speicherung:",JSON.stringify(o)),a||p.handleMessage(`"${n}" als Favorit gespeichert.`),Xe()}catch(o){console.error("Fehler in addOrUpdateFavorite:",o)}finally{rt=!1,console.log("addOrUpdateFavorite abgeschlossen.")}}function $d(t,e,n){if(isNaN(t)||isNaN(e)){console.error("Ungültige Koordinaten in toggleFavorite:",{lat:t,lng:e});return}if(rt){console.log("toggleFavorite blockiert: Ein Favorit wird bereits hinzugefügt.");return}let a=Dn();const o=parseFloat(t.toFixed(5)),r=parseFloat(e.toFixed(5));console.log("toggleFavorite: Suche nach Eintrag mit:",{newLat:o,newLng:r,label:n});const s=a.find(l=>{const c=parseFloat(l.lat),d=parseFloat(l.lng);return Math.abs(c-o)<1e-4&&Math.abs(d-r)<1e-4});if(s)if(console.log("toggleFavorite: Bestehender Eintrag gefunden:",s),s.isFavorite)s.isFavorite=!1,p.handleMessage(`"${s.label}" ist kein Favorit mehr.`),Tn(a),Xe();else{rt=!0;try{const l=prompt("Please enter a name for this favorite:",s.label||n);if(l)s.isFavorite=!0,s.label=l,p.handleMessage(`"${l}" als Favorit gespeichert.`),Tn(a),Xe();else{s.isFavorite=!1;return}}finally{rt=!1,console.log("toggleFavorite abgeschlossen, Sperre aufgehoben.")}}else{console.log("toggleFavorite: Kein bestehender Eintrag, füge neuen Favoriten hinzu.");const l=prompt("Please enter a name for this favorite:",n);l&&as(o,r,l)}}function Rd(t,e){if(isNaN(t)||isNaN(e))return;const a=Dn().filter(o=>{const r=parseFloat(o.lat),s=parseFloat(o.lng||o.lon);return Math.abs(r-t)>1e-4||Math.abs(s-e)>1e-4});Tn(a),p.handleMessage("Location deleted."),Xe()}let Di=!1;function Od(t,e={}){console.log(`[EventManager] Dispatching event: ${t}`,e);const n=new CustomEvent(t,{detail:e,bubbles:!0,cancelable:!0});document.dispatchEvent(n)}function St(t,e,n){console.log(`setupCheckbox called for id: ${t}`);const a=document.getElementById(t);a?(a._changeHandler&&(a.removeEventListener("change",a._changeHandler),console.log(`Removed previous change listener for ${t}`)),a._changeHandler=o=>{console.log(`Change event fired for ${t}, checked: ${a.checked}, event:`,o),o.stopPropagation(),n(a)},a.addEventListener("change",a._changeHandler),a.addEventListener("click",o=>{console.log(`Click event on ${t}, checked: ${a.checked}, target:`,o.target)}),console.log(`Attached change and click listeners to ${t}`),t==="showLandingPattern"&&!(u.isFeatureUnlocked("landingPattern")&&u.state.isLandingPatternUnlocked)&&(a.style.opacity="0.5",a.title="Feature locked. Click to enter password.")):console.warn(`Checkbox ${t} not found`)}function Xa(t,e,n){if(console.log(`toggleSubmenu called for ${t.textContent||t.id}: ${n?"show":"hide"}`),e){e.classList.contains("submenu")||e.classList.add("submenu"),e.classList.toggle("hidden",!n),t.setAttribute("aria-expanded",n),console.log(`Submenu toggled for ${t.textContent||t.id}: ${n?"shown":"hidden"}`);let a=0;const o=5,r=()=>{const s={isHidden:e.classList.contains("hidden"),displayStyle:window.getComputedStyle(e).display};n&&(s.isHidden||s.displayStyle==="none")&&(console.warn(`Submenu for ${t.textContent||t.id} was hidden unexpectedly. Forcing it to be visible.`),e.classList.remove("hidden"),e.style.display="block",a++,a<o&&setTimeout(r,100))};setTimeout(r,100)}else console.warn(`Submenu for ${t.textContent||t.id} not found`)}function Ze(t,e){document.querySelectorAll(`input[name="${t}"]`).forEach(a=>{a.addEventListener("change",()=>{const o=u.getValue(t,"radio",u.defaultSettings[t]);if(u.state.userSettings[t]=o,u.save(),console.log(`${t} changed to: ${o} and saved to localStorage`),t==="landingDirection"){const r=document.getElementById("customLandingDirectionLL"),s=document.getElementById("customLandingDirectionRR");r&&(r.disabled=o!=="LL"),s&&(s.disabled=o!=="RR"),o==="LL"&&r&&!r.value&&u.state.userSettings.customLandingDirectionLL===""&&(r.value=Math.round(i.landingWindDir||0),u.state.userSettings.customLandingDirectionLL=parseInt(r.value),u.save(),console.log(`Set customLandingDirectionLL to ${r.value}`)),o==="RR"&&s&&!s.value&&u.state.userSettings.customLandingDirectionRR===""&&(s.value=Math.round(i.landingWindDir||0),u.state.userSettings.customLandingDirectionRR=parseInt(s.value),u.save(),console.log(`Set customLandingDirectionRR to ${s.value}`))}document.dispatchEvent(new CustomEvent("ui:radioGroupChanged",{detail:{name:t,value:o}})),e&&e()})})}function le(t,e,n,a){const o=document.getElementById(t);o&&o.addEventListener(e,p.debounce(()=>{const r=o.type==="number"?parseFloat(o.value):o.value;a&&a(r)===!1||(u.state.userSettings[t]=r,u.save(),console.log(`${t} changed to: ${r} and saved to localStorage`),document.dispatchEvent(new CustomEvent("ui:inputChanged",{detail:{name:t,value:r}})))},n))}function Ud(){if(!i.map){console.warn("Map not initialized, skipping setupCheckboxEvents");return}St("showTableCheckbox","showTable",o=>{u.state.userSettings.showTable=o.checked,u.save(),document.dispatchEvent(new CustomEvent("ui:showTableChanged",{detail:{checked:o.checked}}))}),St("showExitAreaCheckbox","showExitArea",o=>{u.state.userSettings.showExitArea=o.checked,u.save(),document.dispatchEvent(new CustomEvent("ui:jumpFeatureChanged"))}),St("showCanopyAreaCheckbox","showCanopyArea",o=>{u.state.userSettings.showCanopyArea=o.checked,u.save(),document.dispatchEvent(new CustomEvent("ui:jumpFeatureChanged"))}),St("showJumpRunTrack","showJumpRunTrack",o=>{u.state.userSettings.showJumpRunTrack=o.checked,u.save(),document.dispatchEvent(new CustomEvent("ui:showJumpRunTrackChanged",{detail:{checked:o.checked}}))}),St("showCutAwayFinder","showCutAwayFinder",o=>{u.state.userSettings.showCutAwayFinder=o.checked,u.save(),document.dispatchEvent(new CustomEvent("ui:showCutAwayFinderChanged",{detail:{checked:o.checked}}))}),St("showLandingPattern","showLandingPattern",o=>{const r="landingPattern",s=()=>{var d;u.state.userSettings.showLandingPattern=!0,u.save();const c=(d=o.closest("li"))==null?void 0:d.querySelector("ul");Xa(o,c,!0),document.dispatchEvent(new CustomEvent("ui:landingPatternEnabled"))},l=()=>{var d;u.state.userSettings.showLandingPattern=!1,u.save(),o.checked=!1;const c=(d=o.closest("li"))==null?void 0:d.querySelector("ul");Xa(o,c,!1),document.dispatchEvent(new CustomEvent("ui:landingPatternDisabled"))};o.checked?u.isFeatureUnlocked(r)?s():u.showPasswordModal(r,s,l):l()}),St("trackPositionCheckbox","trackPosition",o=>{u.state.userSettings.trackPosition=o.checked,u.save(),document.dispatchEvent(new CustomEvent("ui:trackPositionToggled",{detail:{checked:o.checked}}))});const t=document.getElementById("showJumpMasterLine");t&&(t.disabled=!u.state.userSettings.trackPosition,t.style.opacity=t.disabled?"0.5":"1",t.addEventListener("change",()=>{var s;const o=t.checked;if(o&&t.disabled){t.checked=!1,p.handleError("Please start Live Tracking first.");return}u.state.userSettings.showJumpMasterLine=o,u.save(),Od("ui:showJumpMasterLineChanged",{isChecked:o});const r=(s=t.closest("li"))==null?void 0:s.querySelector("ul.submenu");r&&Xa(t,r,o)})),Ze("jumpMasterLineTarget",()=>{const o=u.getValue("jumpMasterLineTarget","radio","DIP");u.state.userSettings.jumpMasterLineTarget=o,u.save(),console.log("jumpMasterLineTarget changed:",o),document.dispatchEvent(new CustomEvent("ui:jumpMasterLineTargetChanged"))});const e=document.getElementById("placeHarpButton");e&&e.addEventListener("click",()=>{i.isPlacingHarp=!0,console.log("HARP placement mode activated"),i.map.on("click",ts),p.handleMessage("Click the map to place the HARP marker")});const n=document.getElementById("clearHarpButton");n&&n.addEventListener("click",Fd);const a=document.querySelector(".hamburger-menu");a&&a.addEventListener("click",o=>{console.log("Menu click:",o.target,"class:",o.target.className,"id:",o.target.id)})}function Hd(){const t=document.getElementById("timeSlider");t&&(t.addEventListener("input",()=>{document.dispatchEvent(new CustomEvent("ui:sliderChanged",{detail:{sliderValue:t.value},bubbles:!0,cancelable:!0}))}),t.addEventListener("change",async()=>{document.dispatchEvent(new CustomEvent("ui:sliderChangeFinished",{detail:{sliderValue:t.value},bubbles:!0,cancelable:!0}))}))}function Bd(){const t=document.getElementById("modelSelect");t&&(t.addEventListener("change",()=>{const e=t.value;console.log("Model select changed to:",e),u.state.userSettings.model=e,u.save(),document.dispatchEvent(new CustomEvent("ui:modelChanged",{detail:{model:e}}))}),document.addEventListener("models:available",e=>{const{availableModels:n}=e.detail;xc(n),em(n),Pc(n)}))}function Wd(){Ze("refLevel",()=>u.updateUnitLabels()),Ze("heightUnit",()=>{u.updateUnitLabels()}),Ze("temperatureUnit",()=>{}),Ze("windUnit",()=>{u.updateUnitLabels()}),Ze("timeZone",()=>{}),Ze("coordFormat",()=>{}),Ze("downloadFormat",()=>{}),Ze("landingDirection",()=>{}),Ze("jumpMasterLineTarget",()=>{document.dispatchEvent(new CustomEvent("ui:jumpMasterLineTargetChanged"))}),document.querySelectorAll('input[name="ensembleScenario"]').forEach(a=>{a.addEventListener("change",async()=>{if(a.checked){if(u.state.userSettings.currentEnsembleScenario=a.value,i.currentEnsembleScenario=a.value,u.save(),console.log("Ensemble scenario changed to:",a.value),!u.state.userSettings.selectedEnsembleModels.every(s=>i.ensembleModelsData&&i.ensembleModelsData[s])&&a.value!=="all_models"&&!await ca()){p.handleError("Failed to fetch data for scenario.");return}const r=Fe();ua(r)}})});const e=u.state.userSettings.currentEnsembleScenario||"all_models",n=document.querySelector(`input[name="ensembleScenario"][value="${e}"]`);n&&(n.checked=!0,i.currentEnsembleScenario=e),i.map&&!i.ensembleLayerGroup&&(i.ensembleLayerGroup=L.layerGroup().addTo(i.map))}function zd(){const t=(e,n)=>{const a=document.getElementById(e);a&&a.addEventListener("blur",()=>{let o=parseInt(a.value)||n;const r=document.getElementById("legHeightFinal"),s=document.getElementById("legHeightBase"),l=document.getElementById("legHeightDownwind");if(!(!isNaN(o)&&o>=50&&o<=1e3&&p.validateLegHeights(r,s,l))){let d=n;const m=parseInt(r.value)||100,h=parseInt(s.value)||200,f=parseInt(l.value)||300;e==="legHeightFinal"&&(d=Math.min(h-1,100)),e==="legHeightBase"&&(d=Math.max(m+1,Math.min(f-1,200))),e==="legHeightDownwind"&&(d=Math.max(h+1,300)),a.value=d,o=d,p.handleError(`Adjusted ${e} to ${d} to maintain valid leg order.`)}u.state.userSettings[e]=o,u.save(),document.dispatchEvent(new CustomEvent("ui:inputChanged",{detail:{name:e,value:o}}))})};t("legHeightFinal",100),t("legHeightBase",200),t("legHeightDownwind",300),le("lowerLimit","change",300),le("upperLimit","change",300),le("openingAltitude","change",300,e=>isNaN(e)||e<500||e>15e3?(p.handleError("Opening altitude must be between 500 and 15000 meters."),document.dispatchEvent(new CustomEvent("ui:invalidInput",{detail:{id:"openingAltitude",defaultValue:1200}})),!1):!0),le("exitAltitude","change",300,e=>isNaN(e)||e<500||e>15e3?(p.handleError("Exit altitude must be between 500 and 15000 meters."),document.dispatchEvent(new CustomEvent("ui:invalidInput",{detail:{id:"exitAltitude",defaultValue:3e3}})),!1):!0),le("canopySpeed","change",300),le("descentRate","change",300),le("interpStepSelect","change",300),le("customLandingDirectionLL","input",100),le("customLandingDirectionRR","input",100),le("jumpRunTrackDirection","change",0),le("jumpRunTrackOffset","change",0),le("jumpRunTrackForwardOffset","change",0),le("aircraftSpeedKt","change",300),le("numberOfJumpers","change",300),le("jumperSeparation","change",300),le("cutAwayAltitude","change",300),le("historicalDatePicker","change",300)}function Gd(){const t=document.getElementById("downloadButton");t&&t.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("ui:downloadClicked"))})}function Vd(){const t=document.getElementById("clearHistoricalDate");t&&t.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("ui:clearDateClicked"))})}function Jd(){ns(),console.log("Coordinate events setup complete.")}function jd(){const t=document.querySelectorAll('input[name="cutAwayState"]');if(t.length===0)return;const e=u.state.userSettings.cutAwayState||"Partially",n=document.querySelector(`input[name="cutAwayState"][value="${e}"]`);n&&(n.checked=!0),t.forEach(a=>{a.addEventListener("change",()=>{a.checked&&(console.log(`Cut Away State changed to: ${a.value}`),u.state.userSettings.cutAwayState=a.value,u.save(),document.dispatchEvent(new CustomEvent("ui:recalculateJump")))})})}function Zd(){console.log("App: Richte Event-Listener für Track-Einstellungen ein.");const t=(a,o)=>{const r=document.getElementById(a);r&&(r.value=u.state.userSettings[o]||0,console.log(`Set ${a} to initial value:`,r.value),r.addEventListener("input",()=>{const s=parseFloat(r.value);isNaN(s)||(u.state.userSettings[o]=s,u.save(),Pe())}))};t("numberOfJumpers","numberOfJumpers"),t("jumperSeparation","jumperSeparation"),t("jumpRunTrackOffset","jumpRunTrackOffset"),t("jumpRunTrackForwardOffset","jumpRunTrackForwardOffset");const e=document.getElementById("jumpRunTrackDirection");e&&(e.value=u.state.userSettings.customJumpRunDirection||"",e.addEventListener("change",()=>{const a=parseFloat(e.value);Number.isFinite(a)&&a>=0&&a<=359?(u.state.userSettings.customJumpRunDirection=a,console.log("Setting 'customJumpRunDirection' on change to:",a)):(u.state.userSettings.customJumpRunDirection=null,e.value="",console.log("Invalid direction, resetting to calculated.")),u.save(),Pe()}));const n=document.getElementById("showJumpRunTrack");n&&n.addEventListener("change",a=>{u.state.userSettings.showJumpRunTrack=a.target.checked,u.save(),Pe()})}function qd(){if(console.log("App: Richte Event-Listener für Karten-Events ein."),!i.map){console.error("Karte nicht initialisiert, Event-Listener können nicht gesetzt werden.");return}const t=()=>{document.dispatchEvent(new CustomEvent("map:moved"))},e=p.debounce(()=>{tn({map:i.map,baseMaps:i.baseMaps,onProgress:kn,onComplete:n=>{Ye(),n&&p.handleMessage(n)},onCancel:()=>{Ye(),p.handleMessage("Caching cancelled.")}})},1e3);p.debounce(t,500),i.map.on("zoomend",t),i.map.on("moveend",t),i.map.on("moveend",e)}function Kd(){console.log("setupMenuItemEvents wird aufgerufen für 'Calculate Jump'.");const t=Array.from(document.querySelectorAll(".menu-label")).find(a=>a.textContent.trim()==="Calculate Jump");if(!t){console.error("Calculate Jump menu item not found");return}const e=t.closest("li").querySelector("ul.submenu"),n=()=>{u.isFeatureUnlocked("calculateJump")?(t.style.opacity="1",t.title="Click to open/close jump calculation settings"):(t.style.opacity="0.5",t.title="Feature locked. Click to enter password.",e&&e.classList.add("hidden"))};n(),t.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),u.isFeatureUnlocked("calculateJump")?e&&e.classList.toggle("hidden"):u.showPasswordModal("calculateJump",()=>{n(),e&&e.classList.remove("hidden")},()=>{n()})})}function Yd(){const t=document.getElementById("resetCutAwayMarker");t&&t.addEventListener("click",()=>{if(!i.map){console.warn("Map not initialized, cannot reset cut-away marker");return}i.cutAwayMarker&&(i.map.removeLayer(i.cutAwayMarker),i.cutAwayMarker=null,i.cutAwayLat=null,i.cutAwayLng=null,console.log("Cut-away marker reset"),i.cutAwayCircle&&(i.map.removeLayer(i.cutAwayCircle),i.cutAwayCircle=null,console.log("Cleared cut-away circle")),document.getElementById("info").innerHTML="Right-click map to place cut-away marker")})}function Xd(){console.log("[app.js] Setting up track events");const t=document.getElementById("trackFileInput"),e=document.getElementById("loading");t&&t.addEventListener("change",async a=>{const o=a.target.files[0];if(e&&(e.style.display="block"),!o){p.handleError("No file selected."),e&&(e.style.display="none");return}const r=o.name.split(".").pop().toLowerCase();let s=null;try{r==="gpx"?s=await jr(o):r==="csv"?s=await Zr(o):(p.handleError("Unsupported file type. Please upload a .gpx or .csv file."),e&&(e.style.display="none"))}catch(l){console.error("Error during track file processing:",l),p.handleError("Failed to process track file."),e&&(e.style.display="none")}});const n=document.getElementById("clearTrack");n&&n.addEventListener("click",()=>{if(!i.map){p.handleError("Cannot clear track: map not initialized.");return}if(i.gpxLayer)try{i.map.hasLayer(i.gpxLayer)&&i.map.removeLayer(i.gpxLayer),i.gpxLayer=null,i.gpxPoints=[],i.isTrackLoaded=!1;const a=document.getElementById("info");if(a){const o=/(<br><strong>Available Models:<\/strong><ul>.*?<\/ul>|<br><strong>Available Models:<\/strong> None)/s,s=a.innerHTML.match(o);a.innerHTML="Click on the map to fetch weather data."+(s?s[0]:"")}t&&(t.value="")}catch(a){p.handleError("Failed to clear track: "+a.message)}else p.handleMessage("No track to clear.")})}function Qd(){const t=document.getElementById("cacheRadiusSelect");t?(t.addEventListener("change",()=>{if(!u.state||!u.state.userSettings){console.error("Settings not properly initialized");return}u.state.userSettings.cacheRadiusKm=parseInt(t.value,10),u.save(),console.log("Updated cacheRadiusKm:",u.state.userSettings.cacheRadiusKm)}),console.log("cacheRadiusSelect listener attached, initial value:",t.value)):console.warn("cacheRadiusSelect not found in DOM");const e=document.getElementById("cacheZoomLevelsSelect");e?(e.addEventListener("change",()=>{const[a,o]=e.value.split("-").map(Number);u.state.userSettings.cacheZoomLevels=Array.from({length:o-a+1},(r,s)=>a+s),u.save(),console.log("Updated cacheZoomLevels:",u.state.userSettings.cacheZoomLevels)}),console.log("cacheZoomLevelsSelect listener attached, initial value:",e.value)):console.warn("cacheZoomLevelsSelect not found in DOM");const n=document.getElementById("recacheNowButton");n?(n.addEventListener("click",()=>{da({map:i.map,lastLat:i.lastLat,lastLng:i.lastLng,baseMaps:i.baseMaps,onProgress:kn,onComplete:a=>{Ye(),a&&yt(a)},onCancel:()=>{Ye(),yt("Caching cancelled.")}})}),console.log("recacheNowButton listener attached")):console.warn("recacheNowButton not found in DOM")}function em(t){const e=document.getElementById("ensembleModelsSubmenu");e&&(e.innerHTML="",t.forEach(n=>{const a=document.createElement("li"),o=document.createElement("label");o.className="radio-label";const r=document.createElement("input");r.type="checkbox",r.name="ensembleModel",r.value=n,r.checked=u.state.userSettings.selectedEnsembleModels.includes(n),r.addEventListener("change",async()=>{const s=Array.from(e.querySelectorAll("input:checked")).map(c=>c.value);if(u.state.userSettings.selectedEnsembleModels=s,u.save(),await ca()){const c=Fe();ua(c)}}),o.append(r,` ${n.replace(/_/g," ").toUpperCase()}`),a.appendChild(o),e.appendChild(a)}))}function tm(){Di||(console.log("Initializing all UI event listeners..."),Ud(),Hd(),Bd(),Wd(),zd(),Gd(),Xd(),Vd(),Jd(),jd(),Zd(),qd(),Kd(),Yd(),Qd(),Di=!0,console.log("Event listeners initialized successfully (first and only time)."))}const jn=()=>u.getValue("heightUnit","radio","m"),nm=()=>u.getValue("windUnit","radio","kt"),Ni=()=>u.getValue("coordFormat","radio","Decimal"),os=p.debounce(Ne,300),am=()=>u.getValue("downloadFormat","radio","csv");p.setErrorHandler(Qn);p.setMessageHandler(yt);p.handleMessage=yt;L.Control.Coordinates=L.Control.extend({options:{position:"bottomleft"},onAdd:function(t){var e=L.DomUtil.create("div","leaflet-control-coordinates");return e.style.background="rgba(255, 255, 255, 0.8)",e.style.padding="5px",e.style.borderRadius="4px",e.style.boxShadow="0 2px 5px rgba(0, 0, 0, 0.2)",e.innerHTML="Move mouse over map",this._container=e,e},update:function(t){this._container.innerHTML=t}});let Qa=new Map,eo=new Map;const Fi=p.debounce(async(t,e,n,a)=>{var d,m,h,f;const o=`${t.toFixed(5)},${e.toFixed(5)}`,r=Fe(),s=`${o}-${r}`;let l,c;if(Qa.has(o))l=Qa.get(o);else try{l=await p.getAltitude(t,e),Qa.set(o,l)}catch(g){console.warn("Failed to fetch elevation:",g),l="N/A"}if(eo.has(s))c=eo.get(s);else if(i.weatherData&&i.weatherData.surface_pressure&&r>=0&&r<i.weatherData.surface_pressure.length){const g=i.weatherData.surface_pressure[r],w=((d=i.weatherData.temperature_2m)==null?void 0:d[r])||16.1,y=i.lastAltitude!=="N/A"?i.lastAltitude:339;c=p.calculateQFE(g,l,y,w),eo.set(s,c),console.log("Calculated QFE:",{lat:t,lng:e,surfacePressure:g,elevation:l,referenceElevation:y,temperature:w,qfe:c})}else console.warn("Surface pressure not available for QFE:",{hasWeatherData:!!i.weatherData,hasSurfacePressure:!!((m=i.weatherData)!=null&&m.surface_pressure),sliderIndexValid:r>=0&&r<(((f=(h=i.weatherData)==null?void 0:h.surface_pressure)==null?void 0:f.length)||0)}),c="N/A";a({elevation:l,qfe:c},n)},500);function Gt(){var C;console.log("Calculating mean wind with model:",document.getElementById("modelSelect").value,"weatherData:",i.weatherData);const t=((C=document.querySelector('input[name="refLevel"]:checked'))==null?void 0:C.value)||"AGL",e=u.getValue("heightUnit","radio","m"),n=u.getValue("windUnit","radio","kt"),a=document.getElementById("timeSlider").value||0,o=_e(i.weatherData,a,Te(),Math.round(i.lastAltitude),e);let r=parseFloat(document.getElementById("lowerLimit").value)||0,s=parseFloat(document.getElementById("upperLimit").value);const l=Math.round(i.lastAltitude);if(!i.weatherData||i.lastAltitude==="N/A"){p.handleError("Cannot calculate mean wind: missing data or altitude");return}r=e==="ft"?r/3.28084:r,s=e==="ft"?s/3.28084:s;let c=t==="AGL"?r+l:r,d=t==="AGL"?s+l:s;if(isNaN(r)||isNaN(s)||r>=s){p.handleError("Invalid layer limits. Ensure Lower < Upper and both are numbers.");return}if(t==="AMSL"&&d<l){p.handleError(`The entire selected layer (${Math.round(p.convertHeight(c,e))}-${Math.round(p.convertHeight(d,e))} ${e}) is below the terrain altitude of ${Math.round(p.convertHeight(l,e))} ${e}.`),document.getElementById("meanWindResult").innerHTML="Mean wind: N/A (Layer is below ground)";return}if(t==="AMSL"&&c<l){p.handleMessage(`Note: Lower limit adjusted to terrain altitude (${Math.round(p.convertHeight(l,e))} ${e}) as it cannot be below ground level.`);const T=Math.round(p.convertHeight(l,e));ae("lowerLimit",T),u.state.userSettings.lowerLimit=T,u.save(),c=l}if(!o||o.length===0){p.handleError("No valid weather data available to calculate mean wind.");return}const m=o.map(T=>T.height),h=o.map(T=>parseFloat(T.dir)||0),f=o.map(T=>p.convertWind(parseFloat(T.spd)||0,n,"km/h")),g=f.map((T,D)=>-T*Math.sin(h[D]*Math.PI/180)),w=f.map((T,D)=>-T*Math.cos(h[D]*Math.PI/180)),y=p.calculateMeanWind(m,g,w,c,d),[v,b]=y,S=p.roundToTens(v)===0&&v>=0&&v<5?360:p.roundToTens(v),E=Math.round(p.convertHeight(r,e)),M=Math.round(p.convertHeight(s,e));p.convertWind(b,n,"kt");const k=Number.isFinite(b)?n==="bft"?Math.round(b):b.toFixed(1):"N/A",_=`Mean wind (${E}-${M} ${e} ${t}): ${S}° ${k} ${n}`;document.getElementById("meanWindResult").innerHTML=_,console.log("Calculated Mean Wind:",_,"u:",y[2],"v:",y[3])}function om(t){var w;if(!i.weatherData||!i.weatherData.time){p.handleError("No weather data available to download.");return}const e=document.getElementById("timeSlider").value||0,n=document.getElementById("modelSelect").value.toUpperCase(),a=p.formatTime(i.weatherData.time[e]).replace(" ","_"),o=`${a}_${n}_${t}.txt`,s={ATAK:{interpStep:1e3,heightUnit:"ft",refLevel:"AGL",windUnit:"kt"},Windwatch:{interpStep:100,heightUnit:"ft",refLevel:"AGL",windUnit:"km/h"},HEIDIS:{interpStep:100,heightUnit:"m",refLevel:"AGL",temperatureUnit:"C",windUnit:"m/s"},Customized:{}}[t]||{},l={interpStep:s.interpStep||Te(),heightUnit:s.heightUnit||u.getValue("heightUnit","radio","m"),refLevel:s.refLevel||((w=document.querySelector('input[name="refLevel"]:checked'))==null?void 0:w.value)||"AGL",windUnit:s.windUnit||u.getValue("windUnit","radio","kt"),temperatureUnit:s.temperatureUnit||u.getValue("temperatureUnit","radio","C")};console.log(`Generating export for '${t}' with settings:`,l);const c=_e(i.weatherData,e,l.interpStep,Math.round(i.lastAltitude),l.heightUnit);if(!c||c.length===0){p.handleError("No interpolated data available to download.");return}let d="",m="";switch(t){case"ATAK":m=`Alt Dir Spd
${l.heightUnit}${l.refLevel}
`;break;case"Windwatch":const y=Math.round(p.convertHeight(i.lastAltitude,"ft"));m=`Version 1.0, ID = 9999999999
${a}, Ground Level: ${y} ft
Windsond ${n}
AGL[ft] Wind[°] Speed[km/h]
`;break;case"HEIDIS":case"Customized":default:m=`h(${l.heightUnit}${l.refLevel}) p(hPa) T(${l.temperatureUnit}) Dew(${l.temperatureUnit}) Dir(°) Spd(${l.windUnit}) RH(%)
`;break}d+=m,c.forEach(y=>{const v=Math.round(y.displayHeight),b=Math.round(y.dir),S=p.convertWind(y.spd,l.windUnit,"km/h"),E=Number.isFinite(S)?l.windUnit==="bft"?Math.round(S):S.toFixed(1):"N/A";if(t==="ATAK"||t==="Windwatch")d+=`${v} ${b} ${Math.round(S)}
`;else{const M=y.pressure==="N/A"?"N/A":y.pressure.toFixed(1),k=p.convertTemperature(y.temp,l.temperatureUnit),_=k==="N/A"?"N/A":k.toFixed(1),C=p.convertTemperature(y.dew,l.temperatureUnit),T=C==="N/A"?"N/A":C.toFixed(1),D=y.rh==="N/A"?"N/A":Math.round(y.rh);d+=`${v} ${M} ${_} ${T} ${b} ${E} ${D}
`}});const h=new Blob([d],{type:"text/plain"}),f=window.URL.createObjectURL(h),g=document.createElement("a");g.href=f,g.download=o,document.body.appendChild(g),g.click(),document.body.removeChild(g),window.URL.revokeObjectURL(f)}async function im(){if(!i.lastLat||!i.lastLng){console.warn("No location selected, cannot update weather data"),p.handleError("Please select a location to enable autoupdate."),stopAutoupdate(),document.getElementById("autoupdateCheckbox").checked=!1,u.state.userSettings.autoupdate=!1,u.save();return}if(!navigator.onLine){console.warn("Cannot update weather data: offline"),p.handleError("Cannot update weather data while offline."),stopAutoupdate(),document.getElementById("autoupdateCheckbox").checked=!1,u.state.userSettings.autoupdate=!1,u.save();return}const t=document.getElementById("timeSlider");if(!t){console.warn("Time slider not found, cannot update to current hour");return}const n=new Date().getUTCHours();t.value=n,console.log(`Set slider to current hour: ${n}`);try{await Me(i.lastLat,i.lastLng,null,!1),console.log("Weather data fetched for current hour"),await Tt(n,"info","selectedTime"),i.lastAltitude!=="N/A"&&Gt(),u.state.userSettings.calculateJump&&u.state.isCalculateJumpUnlocked&&(os(),en(),u.state.userSettings.showJumpRunTrack&&Pe()),console.log("Updated all displays for current hour")}catch(a){console.error("Error updating to current hour:",a),p.handleError("Failed to update weather data: "+a.message)}}function Ne(){const t=Fe(),e=Te(),n=jn();let a=u.state.userSettings.openingAltitude,o=u.state.userSettings.exitAltitude;if(n==="ft"&&(a=p.convertFeetToMeters(a),o=p.convertFeetToMeters(o)),!u.state.isCalculateJumpUnlocked||!u.state.userSettings.calculateJump){Jn(null),Mo(null);return}if(!i.weatherData||!i.lastLat||!i.lastLng){Jn(null);return}Fe();const r=_e(i.weatherData,t,e,Math.round(i.lastAltitude),n),s={exitCircles:[],canopyCircles:[],canopyLabels:[]};if(u.state.userSettings.showExitArea){const c=Fo(r);if(c){s.exitCircles.push({center:[c.greenLat,c.greenLng],radius:c.greenRadius,color:"green",fillColor:"green",fillOpacity:.2,weight:2});const d=`
                Exit areas calculated with:<br>
                Throw/Drift: ${Number.isFinite(c.freeFallDirection)?Math.round(c.freeFallDirection):"N/A"}° ${Number.isFinite(c.freeFallDistance)?Math.round(c.freeFallDistance):"N/A"} m<br>
                Free Fall Time: ${c.freeFallTime!=null&&!isNaN(c.freeFallTime)?Math.round(c.freeFallTime):"N/A"} sec
            `;s.exitCircles.push({center:[c.darkGreenLat,c.darkGreenLng],radius:c.darkGreenRadius,color:"darkgreen",fillColor:"darkgreen",fillOpacity:.2,weight:2,tooltip:d})}}if(u.state.userSettings.showCanopyArea){const c=Wr(r);if(c){const d=p.calculateNewCenter(c.redLat,c.redLng,c.displacementFull,c.directionFull);s.canopyCircles.push({center:d,radius:c.radiusFull,color:"red",weight:2,opacity:.8,fillOpacity:0}),c.additionalBlueRadii.forEach((m,h)=>{const f=p.calculateNewCenter(c.blueLat,c.blueLng,c.additionalBlueDisplacements[h],c.additionalBlueDirections[h]);s.canopyCircles.push({center:f,radius:m,color:"blue",weight:1,fillColor:"blue",fillOpacity:.1,opacity:1}),s.canopyLabels.push({center:f,radius:m,text:`${Math.round(c.additionalBlueUpperLimits[h])}m`})})}}Jn(s);let l=null;if(u.state.userSettings.showCutAwayFinder&&i.cutAwayLat!==null){const c=en(r);c&&(l={center:c.center,radius:c.radius,tooltipContent:c.tooltipContent})}Mo(l)}function rm(t=!0){i.customJumpRunDirection=null;const e=document.getElementById("jumpRunTrackDirection");e&&(e.value="",console.log("Cleared jumpRunTrackDirection input")),console.log("Reset JRT direction to calculated"),t&&u.state.userSettings.showJumpRunTrack&&i.weatherData&&i.lastLat&&i.lastLng&&(console.log("Triggering JRT update after reset"),Pe())}function sm(){return!u.state.userSettings.showJumpRunTrack||!u.state.userSettings.calculateJump||!i.weatherData||!i.lastLat||!i.lastLng?(console.log("Skipping calculateJumpRunTrack: conditions not met"),null):(console.log("Calculating jump run track..."),Pe(),Dt())}function it(t=null){if(!i.liveMarker){Ii(),Id();return}const e=i.liveMarker.getLatLng();if(!e)return;const n=t||{latitude:e.lat,longitude:e.lng,speedMs:i.lastSmoothedSpeedMs,direction:i.lastDirection,deviceAltitude:i.lastDeviceAltitude,altitudeAccuracy:i.lastAltitudeAccuracy,accuracy:i.lastAccuracy},a=u.state.userSettings.showJumpMasterLine;let o=null;if(a){let s=null,l="";if(u.state.userSettings.jumpMasterLineTarget==="HARP"&&i.harpMarker?(s=i.harpMarker.getLatLng(),l="HARP"):i.currentMarker&&(s=i.currentMarker.getLatLng(),l="DIP"),s){const c=i.map.distance(e,s),d=Math.round(p.calculateBearing(e.lat,e.lng,s.lat,s.lng)),m=n.speedMs>1?n.speedMs:1,h=Math.round(c/m);o={distance:c,bearing:d,tot:h,target:l},Ad(e,s)}}else Ii();const r={heightUnit:u.getValue("heightUnit","radio","m"),effectiveWindUnit:u.getValue("windUnit","radio","kt")==="bft"?"kt":u.getValue("windUnit","radio","kt"),coordFormat:u.getValue("coordFormat","radio","Decimal"),refLevel:u.getValue("refLevel","radio","AGL")};Dd({...n,showJumpMasterLine:a,jumpMasterLineData:o,...r})}function lm(){if(u.initialize(),u.state.isLandingPatternUnlocked=u.state.unlockedFeatures.landingPattern,u.state.isCalculateJumpUnlocked=u.state.unlockedFeatures.calculateJump,u.state.userSettings.showJumpMasterLine=!1,console.log("Initial unlock status:",{isLandingPatternUnlocked:u.state.isLandingPatternUnlocked,isCalculateJumpUnlocked:u.state.isCalculateJumpUnlocked}),i.isInitialized){console.log("App already initialized, skipping");return}i.isInitialized=!0,console.log("Initializing app")}function cm(){um("modelSelect",u.state.userSettings.model),ht("refLevel",u.state.userSettings.refLevel),ht("heightUnit",u.state.userSettings.heightUnit),ht("temperatureUnit",u.state.userSettings.temperatureUnit),ht("windUnit",u.state.userSettings.windUnit),ht("timeZone",u.state.userSettings.timeZone),ht("coordFormat",u.state.userSettings.coordFormat),ht("downloadFormat",u.state.userSettings.downloadFormat),ht("landingDirection",u.state.userSettings.landingDirection),ae("canopySpeed",u.state.userSettings.canopySpeed),ae("descentRate",u.state.userSettings.descentRate),ae("legHeightDownwind",u.state.userSettings.legHeightDownwind),ae("legHeightBase",u.state.userSettings.legHeightBase),ae("legHeightFinal",u.state.userSettings.legHeightFinal),ae("customLandingDirectionLL",u.state.userSettings.customLandingDirectionLL),ae("customLandingDirectionRR",u.state.userSettings.customLandingDirectionRR),ae("lowerLimit",u.state.userSettings.lowerLimit),ae("upperLimit",u.state.userSettings.upperLimit),ae("openingAltitude",u.state.userSettings.openingAltitude),ae("exitAltitude",u.state.userSettings.exitAltitude),ae("interpStepSelect",u.state.userSettings.interpStep),ae("aircraftSpeedKt",u.state.userSettings.aircraftSpeedKt),ae("jumpRunTrackOffset",u.state.userSettings.jumpRunTrackOffset),ae("numberOfJumpers",u.state.userSettings.numberOfJumpers),Ot("showTableCheckbox",u.state.userSettings.showTable),Ot("calculateJumpCheckbox",u.state.userSettings.calculateJump),Ot("showLandingPattern",u.state.userSettings.showLandingPattern),Ot("showJumpRunTrack",u.state.userSettings.showJumpRunTrack),Ot("showCanopyAreaCheckbox",u.state.userSettings.showCanopyArea),Ot("showExitAreaCheckbox",u.state.userSettings.showExitArea),u.state.userSettings.isCustomJumpRunDirection=u.state.userSettings.isCustomJumpRunDirection||!1;const t=document.getElementById("customLandingDirectionLL"),e=document.getElementById("customLandingDirectionRR");t&&u.state.userSettings.customLandingDirectionLL!==""&&!isNaN(u.state.userSettings.customLandingDirectionLL)&&(t.value=u.state.userSettings.customLandingDirectionLL),e&&u.state.userSettings.customLandingDirectionRR!==""&&!isNaN(u.state.userSettings.customLandingDirectionRR)&&(e.value=u.state.userSettings.customLandingDirectionRR);const n=la(u.state.userSettings.aircraftSpeedKt);ae("jumperSeparation",n),u.state.userSettings.jumperSeparation=n,u.save();const a=document.getElementById("showLandingPattern"),o=document.getElementById("calculateJumpCheckbox");a&&(a.title=u.isFeatureUnlocked("landingPattern")&&u.state.isLandingPatternUnlocked?"":"Feature locked. Click to enter password.",a.style.opacity=u.isFeatureUnlocked("landingPattern")&&u.state.isLandingPatternUnlocked?"1":"0.5",console.log("Initialized showLandingPattern UI:",{checked:a.checked,opacity:a.style.opacity})),o&&(o.title=u.isFeatureUnlocked("calculateJump")&&u.state.isCalculateJumpUnlocked?"":"Feature locked. Click to enter password.",o.style.opacity=u.isFeatureUnlocked("calculateJump")&&u.state.isCalculateJumpUnlocked?"1":"0.5",console.log("Initialized calculateJumpCheckbox UI:",{checked:o.checked,opacity:o.style.opacity}));const r=document.getElementById("showJumpMasterLine");r&&(r.disabled=!u.state.userSettings.trackPosition,r.style.opacity=r.disabled?"0.5":"1",r.title=r.disabled?"Enable Live Tracking to use Jump Master Line":"");const s=document.getElementById("jumpRunTrackDirection");s&&(s.textContent="-"),is()}function is(){const t=document.getElementById("info");t&&(t.style.display=u.state.userSettings.showTable?"block":"none");const e=document.getElementById("customLandingDirectionLL"),n=document.getElementById("customLandingDirectionRR"),a=document.getElementById("showJumpRunTrack"),o=document.getElementById("showExitAreaCheckbox");e&&(e.disabled=u.state.userSettings.landingDirection!=="LL"),n&&(n.disabled=u.state.userSettings.landingDirection!=="RR"),a&&(a.disabled=!u.state.userSettings.calculateJump),o&&(o.disabled=!u.state.userSettings.calculateJump),u.updateUnitLabels()}async function Mn(t,e=null){i.weatherData=t;const n=document.getElementById("timeSlider");if(!n)return;const o=(r=>{const s=r==null?void 0:r.temperature_2m;if(!s||s.length===0)return 0;for(let l=s.length-1;l>=0;l--)if(s[l]!==null&&s[l]!==void 0)return l;return 0})(t);if(n.max=o,n.disabled=n.max<=0,e!==null&&e<=o)n.value=e,console.log(`Slider restored to preserved index: ${e}`);else{const r=new Date().getUTCHours();r<=o?n.value=r:n.value=o,console.log(`Slider set to default (current hour or max): ${n.value}`)}await Tt(n.value,"info","selectedTime"),await zt(),i.lastAltitude!=="N/A"&&Gt(),u.updateModelRunInfo(i.lastModelRun,i.lastLat,i.lastLng)}function Ot(t,e){const n=document.getElementById(t);n&&(n.checked=e)}function um(t,e){const n=document.getElementById(t);n?n.value=e:console.warn(`Element ${t} not found`)}function ae(t,e){const n=document.getElementById(t);n&&(n.value=e)}function bo(t,e){const n=document.getElementById(t);if(n){const a=n.value;n.value=e,console.log(`Set ${t} silently:`,{old:a,new:e})}}function ht(t,e){const n=document.querySelector(`input[name="${t}"][value="${e}"]`);n?n.checked=!0:console.warn(`Radio ${t} with value ${e} not found`)}function dm(){console.log("[App] Setting up application event listeners..."),document.addEventListener("map:moved",()=>{console.log("[main-web] Map has moved or zoomed. Updating visualizations based on new view.");const t=i.map.getZoom();u.state.userSettings.calculateJump&&i.weatherData&&i.lastLat&&(t>=Y.MIN_ZOOM&&t<=Y.MAX_ZOOM?Ne():Jn(null)),u.state.userSettings.showJumpRunTrack&&(t>=Y.MIN_ZOOM&&t<=Y.MAX_ZOOM?Pe():vn(null)),u.state.userSettings.showLandingPattern&&at(),tn({map:i.map,baseMaps:i.baseMaps,onProgress:kn,onComplete:e=>{Ye(),e&&p.handleMessage(e)},onCancel:()=>{Ye(),p.handleMessage("Caching cancelled.")}})}),document.addEventListener("map:mousemove",t=>{const{lat:e,lng:n}=t.detail;i.lastMouseLatLng={lat:e,lng:n};const a=Ni();let o;if(a==="MGRS")o=`MGRS: ${p.decimalToMgrs(e,n)||"N/A"}`;else if(a==="DMS"){const r=s=>`${s.deg}°${s.min}'${s.sec.toFixed(0)}" ${s.dir}`;o=`Lat: ${r(p.decimalToDms(e,!0))}, Lng: ${r(p.decimalToDms(n,!1))}`}else o=`Lat: ${e.toFixed(5)}, Lng: ${n.toFixed(5)}`;i.coordsControl&&i.coordsControl.update(`${o}<br>Elevation: Fetching...<br>QFE: Fetching...`),Fi(e,n,{lat:e,lng:n},({elevation:r,qfe:s},l)=>{if(i.lastMouseLatLng&&i.coordsControl){const c=Math.abs(i.lastMouseLatLng.lat-l.lat),d=Math.abs(i.lastMouseLatLng.lng-l.lng),m=.05;if(c<m&&d<m){const h=jn();let f=r==="N/A"?"N/A":r;f!=="N/A"&&(f=p.convertHeight(f,h),f=Math.round(f));const g=s==="N/A"?"N/A":`${s} hPa`;i.coordsControl.update(`${o}<br>Elevation: ${f} ${f==="N/A"?"":h}<br>QFE: ${g}`)}}})}),document.addEventListener("map:location_selected",async t=>{const{lat:e,lng:n,source:a}=t.detail;console.log(`App: Event 'map:location_selected' von '${a}' empfangen.`),i.lastLat=e,i.lastLng=n,i.lastAltitude=await p.getAltitude(e,n),Wo(e,n),rm(!0),await Me(e,n),u.state.userSettings.calculateJump&&(Ne(),en()),ta(!0),i.isManualPanning=!1,Pe(),at()}),document.addEventListener("tracking:started",()=>{const t=document.getElementById("showJumpMasterLine");t&&(t.disabled=!1,t.style.opacity="1",t.title="")}),document.addEventListener("tracking:stopped",()=>{const t=document.getElementById("showJumpMasterLine");t&&(t.checked=!1,t.disabled=!0,t.style.opacity="0.5",t.title="Enable Live Tracking to use Jump Master Line"),u.state.userSettings.showJumpMasterLine&&(u.state.userSettings.showJumpMasterLine=!1,u.save()),it()}),document.addEventListener("track:loaded",async t=>{const e=document.getElementById("loading");try{const{lat:n,lng:a,timestamp:o,historicalDate:r,summary:s}=t.detail;if(console.log('[main-web] Event "track:loaded" empfangen, starte Aktionen.'),r){console.log("Historischer Track geladen, deaktiviere Autoupdate.");const d=document.getElementById("autoupdateCheckbox");d&&(d.checked=!1),Uo(),u.state.userSettings.autoupdate=!1,u.save(),p.handleMessage("Autoupdate disabled for historical track viewing.")}await pa(n,a);const l=await Me(n,a,o);if(l){i.weatherData=l;const d=document.getElementById("timeSlider");if(d&&i.weatherData.time){d.max=i.weatherData.time.length-1,d.disabled=d.max<=0;const m=new Date(o).getTime();let h=0,f=1/0;i.weatherData.time.forEach((g,w)=>{const y=Math.abs(new Date(g).getTime()-m);y<f&&(f=y,h=w)}),d.value=h}}console.log("Performing specific updates after track load..."),await Tt(Fe(),"info","selectedTime"),await zt(),Gt(),Ne(),at(),it();const c=document.getElementById("info");if(c&&s){const d=/(<br><strong>Available Models:<\/strong><ul>.*?<\/ul>|<br><strong>Available Models:<\/strong> None)/s,m=c.innerHTML.match(d);c.innerHTML=s+(m?m[0]:"")}if(r){const d=document.getElementById("historicalDatePicker");d&&(d.value=r)}}catch(n){console.error("Fehler bei der Verarbeitung von track:loaded:",n),p.handleError("Konnte Track-Daten nicht vollständig verarbeiten.")}finally{e&&(e.style.display="none")}}),document.addEventListener("tracking:positionUpdated",t=>{it(t.detail)}),document.addEventListener("jml:targetChanged",()=>{it()}),document.addEventListener("ui:sliderChanged",async t=>{console.log("[main-web] Event 'ui:sliderChanged' empfangen, spezifische Updates werden ausgeführt.");try{const e=Fe();i.weatherData&&i.lastLat&&i.lastLng&&(await Tt(e,"info","selectedTime"),await zt(),i.lastAltitude!=="N/A"&&Gt(),at(),u.state.userSettings.calculateJump&&Ne(),u.state.userSettings.showJumpRunTrack&&Pe())}catch(e){console.error("Error during slider update:",e),Qn(e.message)}}),document.addEventListener("ui:radioGroupChanged",async t=>{const{name:e}=t.detail;switch(console.log(`[main-web] Radio group '${e}' changed. Performing specific updates.`),await Tt(Fe(),"info","selectedTime"),e){case"heightUnit":if(i.lastMouseLatLng){const{lat:n,lng:a}=i.lastMouseLatLng;let r=Ni()==="MGRS"?`MGRS: ${p.decimalToMgrs(n,a)}`:`Lat: ${n.toFixed(5)}, Lng: ${a.toFixed(5)}`;Fi(n,a,{lat:n,lng:a},({elevation:s,qfe:l},c)=>{if(i.lastMouseLatLng&&Math.abs(i.lastMouseLatLng.lat-c.lat)<.05){const d=jn();let m=s!=="N/A"?Math.round(p.convertHeight(s,d)):"N/A";i.coordsControl.update(`${r}<br>Elevation: ${m} ${m==="N/A"?"":d}`)}})}if(i.gpxLayer&&i.gpxPoints.length>0){const n=i.lastAltitude!=="N/A"&&!isNaN(i.lastAltitude)?parseFloat(i.lastAltitude):null,a=nm(),o=jn();i.gpxLayer.eachLayer(r=>{r instanceof L.Polyline&&r.on("mousemove",function(s){const l=s.latlng;let c=i.gpxPoints[0],d=1/0,m=0;i.gpxPoints.forEach((h,f)=>{const g=Math.sqrt(Math.pow(h.lat-l.lat,2)+Math.pow(h.lng-l.lng,2));g<d&&(d=g,c=h,m=f)}),r.setTooltipContent(getTooltipContent(c,m,i.gpxPoints,n,a,o)).openTooltip(l)})})}case"windUnit":case"refLevel":Gt(),Ne(),at(),it(),await zt();break;case"coordFormat":await zt(),it();break;case"landingDirection":is(),at();break}}),document.addEventListener("ui:inputChanged",async t=>{const{name:e,value:n}=t.detail;switch(console.log(`[main-web] Input for '${e}' changed to '${n}'.`),e){case"aircraftSpeedKt":const a=la(n);bo("jumperSeparation",a),u.state.userSettings.jumperSeparation=a,u.save(),i.weatherData&&os(),Pe();break;case"cutAwayAltitude":i.weatherData&&i.cutAwayLat!==null&&Ne();break;case"openingAltitude":case"exitAltitude":case"numberOfJumpers":case"jumperSeparation":case"canopySpeed":case"descentRate":case"legHeightFinal":case"legHeightBase":case"legHeightDownwind":i.weatherData&&(Ne(),at());break;case"jumpRunTrackDirection":case"jumpRunTrackOffset":case"jumpRunTrackForwardOffset":i.weatherData&&Pe();break;case"lowerLimit":case"upperLimit":case"interpStepSelect":i.weatherData&&(await Tt(Fe(),"info","selectedTime"),Gt());break;case"customLandingDirectionLL":case"customLandingDirectionRR":i.weatherData&&at();break;case"historicalDatePicker":if(i.lastLat&&i.lastLng){const o=n?`${n}T00:00:00Z`:null,r=await Me(i.lastLat,i.lastLng,o);r&&await Mn(r)}break}}),document.addEventListener("ui:showJumpMasterLineChanged",()=>{it()}),document.addEventListener("ui:modelChanged",async t=>{var e,n;if(console.log(`[main-web] Model changed to ${t.detail.model}. Fetching new data.`),i.lastLat&&i.lastLng){const a=Fe(),o=((n=(e=i.weatherData)==null?void 0:e.time)==null?void 0:n[a])||null,r=await Me(i.lastLat,i.lastLng,o);r&&await Mn(r,a)}else p.handleError("Please select a position on the map first.")}),document.addEventListener("ui:jumpFeatureChanged",()=>{console.log("[main-web] Jump feature changed, recalculating jump."),i.weatherData&&i.lastLat&&i.lastLng&&u.state.userSettings.calculateJump&&Ne()}),document.addEventListener("ui:showJumpRunTrackChanged",t=>{const e=t.detail.checked;if(console.log(`[main-web] Jump Run Track toggled: ${e}`),e&&i.weatherData&&i.lastLat&&i.lastLng&&u.state.isCalculateJumpUnlocked&&u.state.userSettings.calculateJump)sm();else{vn(null);const n=document.getElementById("jumpRunTrackDirection");if(n){const a=Dt();n.value=a?a.direction:""}}}),document.addEventListener("ui:showCutAwayFinderChanged",t=>{var a;const e=t.detail.checked;console.log(`[main-web] Cut Away Finder toggled: ${e}`);const n=(a=document.getElementById("showCutAwayFinder").closest("li"))==null?void 0:a.querySelector("ul.submenu");n&&n.classList.toggle("hidden",!e),e||(kd(),i.cutAwayLat=null,i.cutAwayLng=null),i.weatherData&&i.lastLat&&i.lastLng&&u.state.userSettings.calculateJump&&Ne()}),document.addEventListener("ui:trackPositionToggled",t=>{const e=t.detail.checked;console.log(`[main-web] Live Tracking toggled: ${e}`),e?Kr():Oo()}),document.addEventListener("ui:landingPatternEnabled",()=>{console.log("[main-web] Landing pattern enabled, updating display."),at()}),document.addEventListener("ui:landingPatternDisabled",()=>{console.log("[main-web] Landing pattern disabled, clearing display."),fn(null)}),document.addEventListener("ui:showTableChanged",t=>{const e=t.detail.checked;console.log(`[main-web] Show Table toggled: ${e}`);const n=document.getElementById("info");n&&(n.style.display=e?"block":"none"),e&&i.weatherData&&i.lastLat&&i.lastLng&&Tt(Fe(),"info","selectedTime"),ta()}),document.addEventListener("ui:jumpMasterLineTargetChanged",()=>{console.log("[main-web] Jump Master Line target changed, updating panel and line."),it()}),document.addEventListener("ui:downloadClicked",()=>{console.log("[main-web] Download button clicked.");const t=am();om(t)}),document.addEventListener("ui:clearDateClicked",async()=>{console.log("[main-web] Clear date button clicked.");const t=document.getElementById("historicalDatePicker");if(t&&(t.value="",i.lastLat&&i.lastLng))try{const e=await Me(i.lastLat,i.lastLng,null);e&&await Mn(e)}catch(e){Qn(e.message)}}),document.addEventListener("ui:recalculateJump",()=>{console.log("[main-web] Recalculate jump triggered."),i.weatherData&&i.lastLat&&i.lastLng&&u.state.userSettings.calculateJump&&Ne()}),document.addEventListener("ui:invalidInput",t=>{const{id:e,defaultValue:n}=t.detail;console.log(`[main-web] Received invalid input for ${e}. Resetting UI to ${n}.`),ae(e,n)})}document.addEventListener("DOMContentLoaded",async()=>{lm(),cm(),Fc(),await od(),dm(),Yr(),tm(),ns(),document.addEventListener("cutaway:marker_placed",()=>{console.log("App: Event 'cutaway:marker_placed' empfangen. Neuberechnung wird ausgelöst."),i.weatherData&&i.lastLat&&i.lastLng&&Ne()}),document.addEventListener("track:dragend",t=>{console.log("App: Event 'track:dragend' empfangen. Neuberechnung der Offsets relativ zum DIP.");const{newPosition:e,originalTrackData:n}=t.detail,a=L.latLng(i.lastLat,i.lastLng),o=n.trackLength,r=n.airplane.bearing,s=e,[l,c]=p.calculateNewCenter(s.lat,s.lng,o/2,(r+180)%360),d=L.latLng(l,c),m=i.map.distance(a,d);let f=p.calculateBearing(a.lat,a.lng,d.lat,d.lng)-r;f=(f+180)%360-180;const g=f*(Math.PI/180),w=Math.round(m*Math.cos(g)),y=Math.round(m*Math.sin(g));u.state.userSettings.jumpRunTrackOffset=y,u.state.userSettings.jumpRunTrackForwardOffset=w,u.save(),bo("jumpRunTrackOffset",y),bo("jumpRunTrackForwardOffset",w),Pe()}),document.addEventListener("location:selected",async t=>{var r,s;const{lat:e,lng:n,source:a}=t.detail;console.log(`App: Event 'location:selected' empfangen. Quelle: ${a}`);const o=document.getElementById("loading");o&&(o.style.display="block");try{const l=Fe(),c=((s=(r=i.weatherData)==null?void 0:r.time)==null?void 0:s[l])||null,d=await Me(e,n,c);d?a==="geolocation"||a==="geolocation_fallback"?await Mn(d):await Mn(d,l):i.weatherData=null,await pa(e,n),await zt(),ta(!0),i.isManualPanning=!1,(a==="geolocation"||a==="geolocation_fallback")&&(console.log("Starte initiales Caching nach Geolocation..."),tn({map:i.map,baseMaps:i.baseMaps,onProgress:kn,onComplete:m=>{Ye(),m&&yt(m)},onCancel:()=>{Ye(),yt("Caching cancelled.")}})),u.state.userSettings.showJumpMasterLine&&it(),(a==="marker_drag"||a==="dblclick"||a==="search")&&(console.log(`Starte Caching für neue Position via ${a}...`),da({map:i.map,lastLat:e,lastLng:n,baseMaps:i.baseMaps,onProgress:kn,onComplete:m=>{Ye(),m&&yt(m)},onCancel:()=>{Ye(),yt("Caching cancelled.")}}))}catch(l){console.error('Fehler beim Verarbeiten von "location:selected":',l),Qn(l.message)}finally{o&&(o.style.display="none")}}),document.addEventListener("autoupdate:tick",async t=>{if(!u.state.userSettings.autoupdate)return;const e=new Date,n=document.getElementById("timeSlider");if(!n)return;const a=e.getUTCHours(),o=parseInt(n.value,10);(a!==o||t.detail.isInitialTick)&&(console.log(`[App] Autoupdate triggered. Current Hour: ${a}, Slider Hour: ${o}`),await im())})});
